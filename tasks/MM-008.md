# Task MM-008: Stabilize Tests & Acceptance Criteria

**Repo:** ManaMesh
**Status:** Ready
**Created:** 2026-01-20
**Dependencies:** MM-001, MM-002
**Worktree:** `feature/test-stabilization`

---

## Description

Harden unit and integration tests to ensure consistent CI passes. This is an ongoing task that runs parallel to feature development. Focus on deterministic tests and comprehensive coverage of core paths.

## Dependencies

- MM-001: Frontend Skeleton + boardgame.io Core (Complete)
- MM-002: WebRTC + Two-Way Join Codes (for P2P tests)

## User Stories

### US-MM-008.1: Game Logic Coverage

As a developer, I want comprehensive game logic tests so that I can refactor with confidence.

**Acceptance Criteria:**
- [ ] Core moves tested (draw, play, discard)
- [ ] Edge cases covered (empty deck, full hand)
- [ ] Win conditions tested
- [ ] Invalid move handling tested

### US-MM-008.2: P2P Unit Tests

As a developer, I want P2P layer tests so that codec and connection logic is verified.

**Acceptance Criteria:**
- [ ] Codec encode/decode roundtrip tests
- [ ] Invalid code rejection tests
- [ ] Mock WebRTC for connection flow tests
- [ ] State machine transition tests

### US-MM-008.3: Integration Tests

As a developer, I want integration tests so that end-to-end flows are verified.

**Acceptance Criteria:**
- [ ] Two browser tabs complete a game via P2P
- [ ] Deterministic test with logged events
- [ ] Timeout and retry handling
- [ ] CI-compatible (no flaky failures)

## Technical Details

### Unit Test Strategy
- Vitest for fast, Vite-integrated testing
- Mock external dependencies (WebRTC, IPFS)
- Test pure functions directly
- Aim for >80% coverage on critical paths

### Integration Test Strategy
- Use Playwright or Vitest browser mode
- Spawn two browser contexts
- Simulate full connection and game flow
- Log events for debugging failures

### Flaky Test Mitigation
- Use explicit waits, not timers
- Deterministic ordering via event logs
- Retry logic with backoff (max 3 attempts)
- Clear error messages on failure

## Files to Create/Modify

**New Files:**
- `packages/frontend/src/p2p/codec.test.ts` - Codec tests
- `packages/frontend/src/p2p/webrtc.test.ts` - WebRTC mock tests
- `packages/frontend/tests/integration/p2p-game.test.ts` - Integration test

**Modified Files:**
- `packages/frontend/src/game/logic.test.ts` - Expand coverage
- `packages/frontend/vitest.config.ts` - Configure test settings

## Inventory Check

Before starting, verify:
- [ ] Vitest configured and working
- [ ] Existing tests pass
- [ ] CI pipeline exists (or create)

## Completion Criteria

- [ ] All acceptance criteria met
- [ ] `yarn test` passes consistently (10+ runs)
- [ ] No flaky tests in CI
- [ ] Coverage report generated
- [ ] Build succeeds

---

**When complete, output:** `<promise>TASK_COMPLETE</promise>`

**If blocked, output:** `<promise>TASK_BLOCKED: [reason]</promise>`
