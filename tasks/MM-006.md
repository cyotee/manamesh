# Task MM-006: IPFS Asset Loading + Caching

**Repo:** ManaMesh
**Status:** Ready
**Created:** 2026-01-20
**Dependencies:** MM-001
**Worktree:** `feature/ipfs-assets`

---

## Description

Implement IPFS-based asset loading using helia with IndexedDB caching for offline play. Card images and other assets are loaded by CID and cached locally.

## Dependencies

- MM-001: Frontend Skeleton + boardgame.io Core (Complete)

## User Stories

### US-MM-006.1: Load Assets from IPFS

As a player, I want card images to load from IPFS so that assets are decentralized and community-seeded.

**Acceptance Criteria:**
- [ ] Load images by CID using helia
- [ ] Display loading placeholder while fetching
- [ ] Fallback to public IPFS gateway if local node fails
- [ ] Handle missing assets gracefully

### US-MM-006.2: Cache Assets Offline

As a player, I want loaded assets cached locally so that I can play offline with previously loaded cards.

**Acceptance Criteria:**
- [ ] Store fetched assets in IndexedDB
- [ ] Check cache before IPFS fetch
- [ ] Cache invalidation by CID (content-addressed = immutable)
- [ ] ~100MB cache quota management

### US-MM-006.3: Preload Deck Assets

As a player, I want my deck's card images to preload so that I don't wait during gameplay.

**Acceptance Criteria:**
- [ ] Batch preload deck images when game starts
- [ ] Show preload progress indicator
- [ ] Game playable even if preload incomplete

## Technical Details

### IPFS Loader (`assets/ipfs-loader.ts`)
- Initialize helia node in browser
- Fetch content by CID
- Gateway fallback URLs (ipfs.io, dweb.link)
- Timeout handling for slow fetches

### IndexedDB Cache (`assets/cache.ts`)
- Use idb-keyval for simple key-value storage
- Key: CID, Value: Blob
- Cache size management with LRU eviction
- Check cache before network fetch

### Asset Component
- React component for IPFS images
- Loading state with placeholder
- Error state with retry option

## Files to Create/Modify

**New Files:**
- `packages/frontend/src/assets/ipfs-loader.ts` - IPFS loading utilities
- `packages/frontend/src/assets/cache.ts` - IndexedDB caching
- `packages/frontend/src/assets/index.ts` - Public API
- `packages/frontend/src/components/IPFSImage.tsx` - React component

**Modified Files:**
- `packages/frontend/src/components/GameBoard.tsx` - Use IPFSImage for cards

**Tests:**
- `packages/frontend/src/assets/cache.test.ts` - Cache unit tests

## Inventory Check

Before starting, verify:
- [ ] helia dependency installed
- [ ] idb-keyval dependency installed
- [ ] Test CIDs available for sample assets

## Completion Criteria

- [ ] All acceptance criteria met
- [ ] Assets load from IPFS by CID
- [ ] Assets cached in IndexedDB
- [ ] Cached assets load offline
- [ ] Gateway fallback works
- [ ] Tests pass
- [ ] Build succeeds

---

**When complete, output:** `<promise>TASK_COMPLETE</promise>`

**If blocked, output:** `<promise>TASK_BLOCKED: [reason]</promise>`
