# Task MM-006: IPFS Asset Loading + Caching

**Repo:** ManaMesh
**Status:** Complete
**Created:** 2026-01-20
**Dependencies:** MM-001
**Worktree:** `feature/ipfs-assets`

---

## Description

Implement IPFS-based asset loading using helia with IndexedDB caching for offline play. Card images and other assets are loaded by CID and cached locally.

## Dependencies

- MM-001: Frontend Skeleton + boardgame.io Core (Complete)

## User Stories

### US-MM-006.1: Load Assets from IPFS

As a player, I want card images to load from IPFS so that assets are decentralized and community-seeded.

**Acceptance Criteria:**
- [x] Load images by CID using helia
- [x] Display loading placeholder while fetching
- [x] Fallback to public IPFS gateway if local node fails
- [x] Handle missing assets gracefully

### US-MM-006.2: Cache Assets Offline

As a player, I want loaded assets cached locally so that I can play offline with previously loaded cards.

**Acceptance Criteria:**
- [x] Store fetched assets in IndexedDB
- [x] Check cache before IPFS fetch
- [x] Cache invalidation by CID (content-addressed = immutable)
- [x] ~100MB cache quota management

### US-MM-006.3: Preload Deck Assets

As a player, I want my deck's card images to preload so that I don't wait during gameplay.

**Acceptance Criteria:**
- [x] Batch preload deck images when game starts
- [x] Show preload progress indicator
- [x] Game playable even if preload incomplete

## Technical Details

### IPFS Loader (`assets/ipfs-loader.ts`)
- Initialize helia node in browser
- Fetch content by CID
- Gateway fallback URLs (ipfs.io, dweb.link)
- Timeout handling for slow fetches

### IndexedDB Cache (`assets/cache.ts`)
- Use idb-keyval for simple key-value storage
- Key: CID, Value: Blob
- Cache size management with LRU eviction
- Check cache before network fetch

### Asset Component
- React component for IPFS images
- Loading state with placeholder
- Error state with retry option

## Files to Create/Modify

**New Files:**
- `packages/frontend/src/assets/ipfs-loader.ts` - IPFS loading utilities
- `packages/frontend/src/assets/cache.ts` - IndexedDB caching
- `packages/frontend/src/assets/index.ts` - Public API
- `packages/frontend/src/components/IPFSImage.tsx` - React component

**Modified Files:**
- `packages/frontend/src/components/GameBoard.tsx` - Use IPFSImage for cards

**Tests:**
- `packages/frontend/src/assets/cache.test.ts` - Cache unit tests

## Inventory Check

Before starting, verify:
- [x] helia dependency installed
- [x] idb-keyval dependency installed
- [x] Test CIDs available for sample assets

## Completion Criteria

- [x] All acceptance criteria met
- [x] Assets load from IPFS by CID
- [x] Assets cached in IndexedDB
- [x] Cached assets load offline
- [x] Gateway fallback works
- [x] Tests pass
- [x] Build succeeds

---

**When complete, output:** `<promise>TASK_COMPLETE</promise>`

**If blocked, output:** `<promise>TASK_BLOCKED: [reason]</promise>`
