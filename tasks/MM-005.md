# Task MM-005: boardgame.io P2P Transport

**Repo:** ManaMesh
**Status:** Ready
**Created:** 2026-01-20
**Dependencies:** MM-002
**Worktree:** `feature/bgio-p2p-transport`

---

## Description

Create a custom boardgame.io multiplayer transport that uses the P2P data channel instead of a server. This enables true peer-to-peer gameplay with boardgame.io's state synchronization.

## Dependencies

- MM-002: WebRTC + Two-Way Join Codes (must be complete)

## User Stories

### US-MM-005.1: P2P Game State Sync

As a player, I want my game moves to sync with my opponent via P2P so that we can play without a server.

**Acceptance Criteria:**
- [ ] Game state syncs over WebRTC data channel
- [ ] Moves propagate to opponent in real-time
- [ ] Turn transitions work correctly
- [ ] Game end conditions detected on both sides

### US-MM-005.2: Connection Resilience

As a player, I want the game to handle brief disconnections so that a network blip doesn't ruin my game.

**Acceptance Criteria:**
- [ ] Detect connection loss
- [ ] Attempt automatic reconnection
- [ ] Buffer moves during brief outages
- [ ] Show connection status in UI

## Technical Details

### boardgame.io Transport Interface
- Implement `Transport` interface from boardgame.io
- Handle `connect`, `disconnect`, `sendChatMessage`, `updateGameID`, `updatePlayerID`
- Route game actions over P2P data channel

### P2P Transport (`transport.ts`)
- Serialize/deserialize boardgame.io messages
- Handle both host and guest roles
- Implement request/response pattern for state sync
- Buffer mechanism for disconnection resilience

### State Authority
- Host is authoritative for game state
- Guest sends moves, host validates and broadcasts
- Prevents desync and cheating

## Files to Create/Modify

**New Files:**
- `packages/frontend/src/p2p/transport.ts` - boardgame.io P2P transport

**Modified Files:**
- `packages/frontend/src/App.tsx` - Use P2P transport for online games
- `packages/frontend/src/p2p/index.ts` - Export transport

**Tests:**
- `packages/frontend/src/p2p/transport.test.ts` - Transport tests

## Inventory Check

Before starting, verify:
- [ ] MM-002 complete (data channel working)
- [ ] boardgame.io Transport interface documented
- [ ] Understand boardgame.io message protocol

## Completion Criteria

- [ ] All acceptance criteria met
- [ ] Full game playable over P2P with boardgame.io
- [ ] State syncs correctly on both sides
- [ ] Reconnection works for brief outages
- [ ] Tests pass
- [ ] Build succeeds

---

**When complete, output:** `<promise>TASK_COMPLETE</promise>`

**If blocked, output:** `<promise>TASK_BLOCKED: [reason]</promise>`
