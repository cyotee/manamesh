# Task MM-002: WebRTC + Two-Way Join Codes

**Repo:** ManaMesh
**Status:** Complete
**Created:** 2026-01-20
**Dependencies:** MM-001
**Worktree:** `feature/webrtc-join-codes`

---

## Description

Implement the core P2P connection layer using WebRTC with a two-way join code system. This enables fully serverless gameplay where players exchange offer/answer codes out-of-band (via Discord, text, etc.).

## Dependencies

- MM-001: Frontend Skeleton + boardgame.io Core (Complete)

## User Stories

### US-MM-002.1: Create Game (Host)

As a host, I want to create a game and get a shareable code so that I can invite another player without needing a server.

**Acceptance Criteria:**
- [x] "Create Game" button generates WebRTC offer
- [x] Offer encoded as compact, shareable string (base64 + compression)
- [x] Copy button for easy sharing
- [x] UI shows "Waiting for answer code..."

### US-MM-002.2: Join Game (Guest)

As a guest, I want to enter an offer code and get an answer code so that I can connect to the host.

**Acceptance Criteria:**
- [x] Text input for pasting offer code
- [x] Automatic generation of answer code upon valid offer
- [x] Copy button for answer code
- [x] Clear error messages for invalid codes

### US-MM-002.3: Complete Connection (Host)

As a host, I want to enter the answer code so that the P2P connection is established.

**Acceptance Criteria:**
- [x] Text input for answer code
- [x] Connection established upon valid answer
- [x] UI transitions to "Connected" state
- [x] Data channel ready for game messages

## Technical Details

### WebRTC Wrapper (`webrtc.ts`)
- Create/manage RTCPeerConnection
- Handle offer/answer SDP creation
- Manage ICE candidate gathering (with timeout)
- Create reliable data channel for game messages
- Connection state events (connecting, connected, disconnected)

### Codec (`codec.ts`)
- Encode SDP + ICE candidates to compressed base64
- Decode back to usable SDP objects
- Validation for malformed codes
- Target: codes under 500 characters

### Join Code Discovery (`discovery/join-code.ts`)
- High-level API for two-way exchange flow
- State machine: idle → offering → waiting-for-answer → connected
- Event emitters for UI updates

### STUN Configuration
- Use public STUN servers for NAT traversal
- `stun:stun.l.google.com:19302`
- `stun:stun1.l.google.com:19302`

## Files to Create/Modify

**New Files:**
- `packages/frontend/src/p2p/webrtc.ts` - WebRTC wrapper
- `packages/frontend/src/p2p/codec.ts` - SDP encoding/decoding
- `packages/frontend/src/p2p/discovery/join-code.ts` - Join code flow

**Modified Files:**
- `packages/frontend/src/p2p/index.ts` - Export new modules
- `packages/frontend/src/components/P2PLobby.tsx` - Join code UI

**Tests:**
- `packages/frontend/src/p2p/codec.test.ts` - Codec unit tests
- `packages/frontend/src/p2p/webrtc.test.ts` - WebRTC mock tests

## Inventory Check

Before starting, verify:
- [x] RTCPeerConnection available in browser
- [x] STUN servers accessible
- [x] P2PLobby component exists

## Completion Criteria

- [x] All acceptance criteria met
- [x] Two browser tabs on same machine can connect via join codes
- [x] Two users on different networks can connect via join codes
- [x] Codec tests pass
- [x] Build succeeds
- [x] No server required for connection

---

**When complete, output:** `<promise>TASK_COMPLETE</promise>`

**If blocked, output:** `<promise>TASK_BLOCKED: [reason]</promise>`
