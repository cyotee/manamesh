# Task MM-003: libp2p DHT Discovery

**Repo:** ManaMesh
**Status:** Ready
**Created:** 2026-01-20
**Dependencies:** MM-002
**Worktree:** `feature/libp2p-dht`

---

## Description

Integrate libp2p with public bootstrap nodes to enable single-code room discovery via DHT. This improves UX over two-way join codes by allowing hosts to publish offers to a distributed hash table.

## Dependencies

- MM-002: WebRTC + Two-Way Join Codes (must be complete)

## User Stories

### US-MM-003.1: Publish Game Room

As a host, I want to publish my game to the DHT so that players can find it with a single room code.

**Acceptance Criteria:**
- [ ] Generate short, memorable room code
- [ ] Publish WebRTC offer to DHT under room key
- [ ] Show room code with copy button
- [ ] Handle DHT publish failures gracefully

### US-MM-003.2: Join via Room Code

As a guest, I want to enter a room code and connect automatically so that I don't need to exchange two codes.

**Acceptance Criteria:**
- [ ] Single text input for room code
- [ ] Look up offer from DHT
- [ ] Automatically generate and publish answer
- [ ] Connection established without manual answer exchange

### US-MM-003.3: Browse Public Games

As a player, I want to see a list of available public games so that I can join without a code.

**Acceptance Criteria:**
- [ ] List of discoverable games in lobby
- [ ] Show game metadata (host name, game type)
- [ ] One-click join for listed games
- [ ] Auto-refresh game list

## Technical Details

### libp2p Integration
- Connect to Protocol Labs public bootstrap nodes
- Use Kademlia DHT for peer discovery
- WebRTC transport for browser compatibility

### DHT Discovery (`discovery/dht.ts`)
- Publish offer under content-addressed room key
- Subscribe to room key for answers
- Handle DHT latency with loading states
- Timeout and fallback to join codes if DHT unavailable

### Room Code Generation
- 6-character alphanumeric codes
- Collision-resistant via random generation
- Case-insensitive for ease of sharing

## Files to Create/Modify

**New Files:**
- `packages/frontend/src/p2p/discovery/dht.ts` - DHT discovery module
- `packages/frontend/src/p2p/libp2p-config.ts` - libp2p node configuration

**Modified Files:**
- `packages/frontend/src/p2p/index.ts` - Export DHT module
- `packages/frontend/src/components/P2PLobby.tsx` - Add DHT UI options

**Tests:**
- `packages/frontend/src/p2p/discovery/dht.test.ts` - DHT integration tests

## Inventory Check

Before starting, verify:
- [ ] MM-002 complete (WebRTC layer working)
- [ ] libp2p dependencies installed
- [ ] Public bootstrap nodes accessible

## Completion Criteria

- [ ] All acceptance criteria met
- [ ] Single room code connects two peers
- [ ] Public game list populates
- [ ] Fallback to join codes if DHT fails
- [ ] Tests pass
- [ ] Build succeeds

---

**When complete, output:** `<promise>TASK_COMPLETE</promise>`

**If blocked, output:** `<promise>TASK_BLOCKED: [reason]</promise>`
