# Task MM-012: Add Expiry/Republish For DHT Records

**Repo:** ManaMesh
**Status:** Ready
**Created:** 2026-01-21
**Dependencies:** MM-003
**Worktree:** `feature/dht-record-expiry`
**Origin:** Code review suggestion from MM-003

---

## Description

Add an expiry field and republish strategy for room offers/answers and public game advertisements. Currently, DHT values are written without any expiry/republish/cleanup mechanism, which will cause stale record buildup.

(Created from code review of MM-003 - Suggestion 4)

## Dependencies

- MM-003: libp2p DHT Discovery (parent task)

## Problem Details

Current implementation:
- Room offers/answers have no TTL
- Public game advertisements persist indefinitely
- Code attempts to filter by `createdAt` (5 minutes) but list is never populated
- Once public listing works, stale records will degrade UX

## User Stories

### US-MM-012.1: DHT Record Lifecycle

As a player, I want stale game rooms to be automatically cleaned up so that I only see active games.

**Acceptance Criteria:**
- [ ] Room offers include expiry timestamp
- [ ] Room offers are republished periodically while host is active
- [ ] Public game ads include expiry timestamp
- [ ] UI filters out expired records
- [ ] Expired records are not displayed in game list
- [ ] Tests validate expiry logic
- [ ] Tests pass
- [ ] Build succeeds

## Technical Approach

1. Add `expiresAt` field to all DHT records
2. Implement republish timer (e.g., every 2 minutes for 5-minute TTL)
3. Filter expired records on read
4. Consider background cleanup of local expired records

## Files to Create/Modify

**Modified Files:**
- `packages/frontend/src/p2p/discovery/dht.ts`

## Inventory Check

Before starting, verify:
- [ ] MM-003 implementation is available
- [ ] Understand current record structure

## Completion Criteria

- [ ] All acceptance criteria met
- [ ] No stale rooms appear in listings
- [ ] Tests pass
- [ ] Build succeeds

---

**When complete, output:** `<promise>TASK_COMPLETE</promise>`

**If blocked, output:** `<promise>TASK_BLOCKED: [reason]</promise>`
