# Task MM-007: Backend Signaling Fallback

**Repo:** ManaMesh
**Status:** Blocked
**Created:** 2026-01-20
**Dependencies:** MM-002, MM-003, MM-004
**Worktree:** `feature/signaling-server`

---

## Description

Implement a minimal WebSocket signaling server as a fallback for when decentralized P2P discovery methods fail. This is optional and should only be implemented if users report connectivity issues with join codes, DHT, or mDNS.

## Dependencies

- MM-002: WebRTC + Two-Way Join Codes (must be complete)
- MM-003: libp2p DHT Discovery (should try first)
- MM-004: mDNS Local Discovery (should try first)

## Blocked Reason

**DEFERRED** - Only implement if decentralized methods prove insufficient for users. Priority is to validate that P2P-first approach works for most use cases.

## User Stories

### US-MM-007.1: Signaling Fallback

As a player behind a restrictive NAT, I want a signaling server fallback so that I can still connect when P2P discovery fails.

**Acceptance Criteria:**
- [ ] Minimal WebSocket server (~50 lines)
- [ ] Exchange SDP offers/answers via server
- [ ] Server-assisted ICE candidate relay
- [ ] Automatic fallback when P2P fails

### US-MM-007.2: Self-Hostable Server

As a community member, I want to run my own signaling server so that I'm not dependent on the official service.

**Acceptance Criteria:**
- [ ] Deployable to free tiers (Fly.io, Railway)
- [ ] Docker image available
- [ ] Configurable in frontend via environment variable

## Technical Details

### Backend Server (`packages/backend/src/signaling.ts`)
- WebSocket server using ws or socket.io
- Room-based message routing
- No persistent storage needed
- Stateless (rooms exist only while peers connected)

### Frontend Integration
- Detect P2P discovery failure
- Fall back to signaling server
- Show "using server relay" indicator
- Allow manual server URL configuration

## Files to Create/Modify

**New Files:**
- `packages/backend/src/signaling.ts` - WebSocket signaling
- `packages/backend/Dockerfile` - Container image

**Modified Files:**
- `packages/backend/src/index.ts` - Mount signaling endpoint
- `packages/frontend/src/p2p/index.ts` - Add fallback logic

## Inventory Check

Before starting, verify:
- [ ] User reports indicate P2P discovery failures
- [ ] MM-002, MM-003, MM-004 all complete
- [ ] Document specific failure scenarios

## Completion Criteria

- [ ] All acceptance criteria met
- [ ] Signaling server deployable
- [ ] Frontend falls back automatically
- [ ] Self-hosting documented
- [ ] Tests pass
- [ ] Build succeeds

---

**When complete, output:** `<promise>TASK_COMPLETE</promise>`

**If blocked, output:** `<promise>TASK_BLOCKED: [reason]</promise>`
