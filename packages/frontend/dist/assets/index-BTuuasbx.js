var tD=Object.defineProperty;var y8=n=>{throw TypeError(n)};var nD=(n,e,t)=>e in n?tD(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var h=(n,e,t)=>nD(n,typeof e!="symbol"?e+"":e,t),Jp=(n,e,t)=>e.has(n)||y8("Cannot "+t);var I=(n,e,t)=>(Jp(n,e,"read from private field"),t?t.call(n):e.get(n)),le=(n,e,t)=>e.has(n)?y8("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),ye=(n,e,t,r)=>(Jp(n,e,"write to private field"),r?r.call(n,t):e.set(n,t),t),Q=(n,e,t)=>(Jp(n,e,"access private method"),t);var sn=(n,e,t,r)=>({set _(i){ye(n,e,i,t)},get _(){return I(n,e,r)}});(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();var Aa=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ci(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var wb={exports:{}},M2={},vb={exports:{}},Ce={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var $h=Symbol.for("react.element"),rD=Symbol.for("react.portal"),iD=Symbol.for("react.fragment"),sD=Symbol.for("react.strict_mode"),oD=Symbol.for("react.profiler"),aD=Symbol.for("react.provider"),lD=Symbol.for("react.context"),cD=Symbol.for("react.forward_ref"),uD=Symbol.for("react.suspense"),dD=Symbol.for("react.memo"),hD=Symbol.for("react.lazy"),m8=Symbol.iterator;function fD(n){return n===null||typeof n!="object"?null:(n=m8&&n[m8]||n["@@iterator"],typeof n=="function"?n:null)}var Eb={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},bb=Object.assign,_b={};function cu(n,e,t){this.props=n,this.context=e,this.refs=_b,this.updater=t||Eb}cu.prototype.isReactComponent={};cu.prototype.setState=function(n,e){if(typeof n!="object"&&typeof n!="function"&&n!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,n,e,"setState")};cu.prototype.forceUpdate=function(n){this.updater.enqueueForceUpdate(this,n,"forceUpdate")};function Sb(){}Sb.prototype=cu.prototype;function Qy(n,e,t){this.props=n,this.context=e,this.refs=_b,this.updater=t||Eb}var Xy=Qy.prototype=new Sb;Xy.constructor=Qy;bb(Xy,cu.prototype);Xy.isPureReactComponent=!0;var w8=Array.isArray,xb=Object.prototype.hasOwnProperty,Jy={current:null},kb={key:!0,ref:!0,__self:!0,__source:!0};function Rb(n,e,t){var r,i={},s=null,o=null;if(e!=null)for(r in e.ref!==void 0&&(o=e.ref),e.key!==void 0&&(s=""+e.key),e)xb.call(e,r)&&!kb.hasOwnProperty(r)&&(i[r]=e[r]);var a=arguments.length-2;if(a===1)i.children=t;else if(1<a){for(var l=Array(a),c=0;c<a;c++)l[c]=arguments[c+2];i.children=l}if(n&&n.defaultProps)for(r in a=n.defaultProps,a)i[r]===void 0&&(i[r]=a[r]);return{$$typeof:$h,type:n,key:s,ref:o,props:i,_owner:Jy.current}}function pD(n,e){return{$$typeof:$h,type:n.type,key:e,ref:n.ref,props:n.props,_owner:n._owner}}function Zy(n){return typeof n=="object"&&n!==null&&n.$$typeof===$h}function gD(n){var e={"=":"=0",":":"=2"};return"$"+n.replace(/[=:]/g,function(t){return e[t]})}var v8=/\/+/g;function Zp(n,e){return typeof n=="object"&&n!==null&&n.key!=null?gD(""+n.key):e.toString(36)}function d1(n,e,t,r,i){var s=typeof n;(s==="undefined"||s==="boolean")&&(n=null);var o=!1;if(n===null)o=!0;else switch(s){case"string":case"number":o=!0;break;case"object":switch(n.$$typeof){case $h:case rD:o=!0}}if(o)return o=n,i=i(o),n=r===""?"."+Zp(o,0):r,w8(i)?(t="",n!=null&&(t=n.replace(v8,"$&/")+"/"),d1(i,e,t,"",function(c){return c})):i!=null&&(Zy(i)&&(i=pD(i,t+(!i.key||o&&o.key===i.key?"":(""+i.key).replace(v8,"$&/")+"/")+n)),e.push(i)),1;if(o=0,r=r===""?".":r+":",w8(n))for(var a=0;a<n.length;a++){s=n[a];var l=r+Zp(s,a);o+=d1(s,e,t,l,i)}else if(l=fD(n),typeof l=="function")for(n=l.call(n),a=0;!(s=n.next()).done;)s=s.value,l=r+Zp(s,a++),o+=d1(s,e,t,l,i);else if(s==="object")throw e=String(n),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(n).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return o}function pf(n,e,t){if(n==null)return n;var r=[],i=0;return d1(n,r,"","",function(s){return e.call(t,s,i++)}),r}function yD(n){if(n._status===-1){var e=n._result;e=e(),e.then(function(t){(n._status===0||n._status===-1)&&(n._status=1,n._result=t)},function(t){(n._status===0||n._status===-1)&&(n._status=2,n._result=t)}),n._status===-1&&(n._status=0,n._result=e)}if(n._status===1)return n._result.default;throw n._result}var Ln={current:null},h1={transition:null},mD={ReactCurrentDispatcher:Ln,ReactCurrentBatchConfig:h1,ReactCurrentOwner:Jy};function Ab(){throw Error("act(...) is not supported in production builds of React.")}Ce.Children={map:pf,forEach:function(n,e,t){pf(n,function(){e.apply(this,arguments)},t)},count:function(n){var e=0;return pf(n,function(){e++}),e},toArray:function(n){return pf(n,function(e){return e})||[]},only:function(n){if(!Zy(n))throw Error("React.Children.only expected to receive a single React element child.");return n}};Ce.Component=cu;Ce.Fragment=iD;Ce.Profiler=oD;Ce.PureComponent=Qy;Ce.StrictMode=sD;Ce.Suspense=uD;Ce.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mD;Ce.act=Ab;Ce.cloneElement=function(n,e,t){if(n==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+n+".");var r=bb({},n.props),i=n.key,s=n.ref,o=n._owner;if(e!=null){if(e.ref!==void 0&&(s=e.ref,o=Jy.current),e.key!==void 0&&(i=""+e.key),n.type&&n.type.defaultProps)var a=n.type.defaultProps;for(l in e)xb.call(e,l)&&!kb.hasOwnProperty(l)&&(r[l]=e[l]===void 0&&a!==void 0?a[l]:e[l])}var l=arguments.length-2;if(l===1)r.children=t;else if(1<l){a=Array(l);for(var c=0;c<l;c++)a[c]=arguments[c+2];r.children=a}return{$$typeof:$h,type:n.type,key:i,ref:s,props:r,_owner:o}};Ce.createContext=function(n){return n={$$typeof:lD,_currentValue:n,_currentValue2:n,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},n.Provider={$$typeof:aD,_context:n},n.Consumer=n};Ce.createElement=Rb;Ce.createFactory=function(n){var e=Rb.bind(null,n);return e.type=n,e};Ce.createRef=function(){return{current:null}};Ce.forwardRef=function(n){return{$$typeof:cD,render:n}};Ce.isValidElement=Zy;Ce.lazy=function(n){return{$$typeof:hD,_payload:{_status:-1,_result:n},_init:yD}};Ce.memo=function(n,e){return{$$typeof:dD,type:n,compare:e===void 0?null:e}};Ce.startTransition=function(n){var e=h1.transition;h1.transition={};try{n()}finally{h1.transition=e}};Ce.unstable_act=Ab;Ce.useCallback=function(n,e){return Ln.current.useCallback(n,e)};Ce.useContext=function(n){return Ln.current.useContext(n)};Ce.useDebugValue=function(){};Ce.useDeferredValue=function(n){return Ln.current.useDeferredValue(n)};Ce.useEffect=function(n,e){return Ln.current.useEffect(n,e)};Ce.useId=function(){return Ln.current.useId()};Ce.useImperativeHandle=function(n,e,t){return Ln.current.useImperativeHandle(n,e,t)};Ce.useInsertionEffect=function(n,e){return Ln.current.useInsertionEffect(n,e)};Ce.useLayoutEffect=function(n,e){return Ln.current.useLayoutEffect(n,e)};Ce.useMemo=function(n,e){return Ln.current.useMemo(n,e)};Ce.useReducer=function(n,e,t){return Ln.current.useReducer(n,e,t)};Ce.useRef=function(n){return Ln.current.useRef(n)};Ce.useState=function(n){return Ln.current.useState(n)};Ce.useSyncExternalStore=function(n,e,t){return Ln.current.useSyncExternalStore(n,e,t)};Ce.useTransition=function(){return Ln.current.useTransition()};Ce.version="18.3.1";vb.exports=Ce;var _e=vb.exports;const ae=ci(_e);/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var wD=_e,vD=Symbol.for("react.element"),ED=Symbol.for("react.fragment"),bD=Object.prototype.hasOwnProperty,_D=wD.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,SD={key:!0,ref:!0,__self:!0,__source:!0};function Ib(n,e,t){var r,i={},s=null,o=null;t!==void 0&&(s=""+t),e.key!==void 0&&(s=""+e.key),e.ref!==void 0&&(o=e.ref);for(r in e)bD.call(e,r)&&!SD.hasOwnProperty(r)&&(i[r]=e[r]);if(n&&n.defaultProps)for(r in e=n.defaultProps,e)i[r]===void 0&&(i[r]=e[r]);return{$$typeof:vD,type:n,key:s,ref:o,props:i,_owner:_D.current}}M2.Fragment=ED;M2.jsx=Ib;M2.jsxs=Ib;wb.exports=M2;var $=wb.exports,S3={},Cb={exports:{}},fr={},Tb={exports:{}},Nb={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(n){function e(L,O){var H=L.length;L.push(O);e:for(;0<H;){var G=H-1>>>1,j=L[G];if(0<i(j,O))L[G]=O,L[H]=j,H=G;else break e}}function t(L){return L.length===0?null:L[0]}function r(L){if(L.length===0)return null;var O=L[0],H=L.pop();if(H!==O){L[0]=H;e:for(var G=0,j=L.length,be=j>>>1;G<be;){var Ee=2*(G+1)-1,pe=L[Ee],we=Ee+1,Ie=L[we];if(0>i(pe,H))we<j&&0>i(Ie,pe)?(L[G]=Ie,L[we]=H,G=we):(L[G]=pe,L[Ee]=H,G=Ee);else if(we<j&&0>i(Ie,H))L[G]=Ie,L[we]=H,G=we;else break e}}return O}function i(L,O){var H=L.sortIndex-O.sortIndex;return H!==0?H:L.id-O.id}if(typeof performance=="object"&&typeof performance.now=="function"){var s=performance;n.unstable_now=function(){return s.now()}}else{var o=Date,a=o.now();n.unstable_now=function(){return o.now()-a}}var l=[],c=[],u=1,d=null,f=3,p=!1,y=!1,g=!1,w=typeof setTimeout=="function"?setTimeout:null,m=typeof clearTimeout=="function"?clearTimeout:null,E=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function v(L){for(var O=t(c);O!==null;){if(O.callback===null)r(c);else if(O.startTime<=L)r(c),O.sortIndex=O.expirationTime,e(l,O);else break;O=t(c)}}function b(L){if(g=!1,v(L),!y)if(t(l)!==null)y=!0,M(k);else{var O=t(c);O!==null&&K(b,O.startTime-L)}}function k(L,O){y=!1,g&&(g=!1,m(P),P=-1),p=!0;var H=f;try{for(v(O),d=t(l);d!==null&&(!(d.expirationTime>O)||L&&!V());){var G=d.callback;if(typeof G=="function"){d.callback=null,f=d.priorityLevel;var j=G(d.expirationTime<=O);O=n.unstable_now(),typeof j=="function"?d.callback=j:d===t(l)&&r(l),v(O)}else r(l);d=t(l)}if(d!==null)var be=!0;else{var Ee=t(c);Ee!==null&&K(b,Ee.startTime-O),be=!1}return be}finally{d=null,f=H,p=!1}}var A=!1,T=null,P=-1,_=5,N=-1;function V(){return!(n.unstable_now()-N<_)}function z(){if(T!==null){var L=n.unstable_now();N=L;var O=!0;try{O=T(!0,L)}finally{O?R():(A=!1,T=null)}}else A=!1}var R;if(typeof E=="function")R=function(){E(z)};else if(typeof MessageChannel<"u"){var C=new MessageChannel,x=C.port2;C.port1.onmessage=z,R=function(){x.postMessage(null)}}else R=function(){w(z,0)};function M(L){T=L,A||(A=!0,R())}function K(L,O){P=w(function(){L(n.unstable_now())},O)}n.unstable_IdlePriority=5,n.unstable_ImmediatePriority=1,n.unstable_LowPriority=4,n.unstable_NormalPriority=3,n.unstable_Profiling=null,n.unstable_UserBlockingPriority=2,n.unstable_cancelCallback=function(L){L.callback=null},n.unstable_continueExecution=function(){y||p||(y=!0,M(k))},n.unstable_forceFrameRate=function(L){0>L||125<L?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):_=0<L?Math.floor(1e3/L):5},n.unstable_getCurrentPriorityLevel=function(){return f},n.unstable_getFirstCallbackNode=function(){return t(l)},n.unstable_next=function(L){switch(f){case 1:case 2:case 3:var O=3;break;default:O=f}var H=f;f=O;try{return L()}finally{f=H}},n.unstable_pauseExecution=function(){},n.unstable_requestPaint=function(){},n.unstable_runWithPriority=function(L,O){switch(L){case 1:case 2:case 3:case 4:case 5:break;default:L=3}var H=f;f=L;try{return O()}finally{f=H}},n.unstable_scheduleCallback=function(L,O,H){var G=n.unstable_now();switch(typeof H=="object"&&H!==null?(H=H.delay,H=typeof H=="number"&&0<H?G+H:G):H=G,L){case 1:var j=-1;break;case 2:j=250;break;case 5:j=1073741823;break;case 4:j=1e4;break;default:j=5e3}return j=H+j,L={id:u++,callback:O,priorityLevel:L,startTime:H,expirationTime:j,sortIndex:-1},H>G?(L.sortIndex=H,e(c,L),t(l)===null&&L===t(c)&&(g?(m(P),P=-1):g=!0,K(b,H-G))):(L.sortIndex=j,e(l,L),y||p||(y=!0,M(k))),L},n.unstable_shouldYield=V,n.unstable_wrapCallback=function(L){var O=f;return function(){var H=f;f=O;try{return L.apply(this,arguments)}finally{f=H}}}})(Nb);Tb.exports=Nb;var xD=Tb.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var kD=_e,lr=xD;function q(n){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+n,t=1;t<arguments.length;t++)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+n+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var Db=new Set,$d={};function Qa(n,e){Ec(n,e),Ec(n+"Capture",e)}function Ec(n,e){for($d[n]=e,n=0;n<e.length;n++)Db.add(e[n])}var Rs=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),x3=Object.prototype.hasOwnProperty,RD=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,E8={},b8={};function AD(n){return x3.call(b8,n)?!0:x3.call(E8,n)?!1:RD.test(n)?b8[n]=!0:(E8[n]=!0,!1)}function ID(n,e,t,r){if(t!==null&&t.type===0)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return r?!1:t!==null?!t.acceptsBooleans:(n=n.toLowerCase().slice(0,5),n!=="data-"&&n!=="aria-");default:return!1}}function CD(n,e,t,r){if(e===null||typeof e>"u"||ID(n,e,t,r))return!0;if(r)return!1;if(t!==null)switch(t.type){case 3:return!e;case 4:return e===!1;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}function Bn(n,e,t,r,i,s,o){this.acceptsBooleans=e===2||e===3||e===4,this.attributeName=r,this.attributeNamespace=i,this.mustUseProperty=t,this.propertyName=n,this.type=e,this.sanitizeURL=s,this.removeEmptyString=o}var en={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(n){en[n]=new Bn(n,0,!1,n,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(n){var e=n[0];en[e]=new Bn(e,1,!1,n[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(n){en[n]=new Bn(n,2,!1,n.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(n){en[n]=new Bn(n,2,!1,n,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(n){en[n]=new Bn(n,3,!1,n.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(n){en[n]=new Bn(n,3,!0,n,null,!1,!1)});["capture","download"].forEach(function(n){en[n]=new Bn(n,4,!1,n,null,!1,!1)});["cols","rows","size","span"].forEach(function(n){en[n]=new Bn(n,6,!1,n,null,!1,!1)});["rowSpan","start"].forEach(function(n){en[n]=new Bn(n,5,!1,n.toLowerCase(),null,!1,!1)});var em=/[\-:]([a-z])/g;function tm(n){return n[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(n){var e=n.replace(em,tm);en[e]=new Bn(e,1,!1,n,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(n){var e=n.replace(em,tm);en[e]=new Bn(e,1,!1,n,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(n){var e=n.replace(em,tm);en[e]=new Bn(e,1,!1,n,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(n){en[n]=new Bn(n,1,!1,n.toLowerCase(),null,!1,!1)});en.xlinkHref=new Bn("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(n){en[n]=new Bn(n,1,!1,n.toLowerCase(),null,!0,!0)});function nm(n,e,t,r){var i=en.hasOwnProperty(e)?en[e]:null;(i!==null?i.type!==0:r||!(2<e.length)||e[0]!=="o"&&e[0]!=="O"||e[1]!=="n"&&e[1]!=="N")&&(CD(e,t,i,r)&&(t=null),r||i===null?AD(e)&&(t===null?n.removeAttribute(e):n.setAttribute(e,""+t)):i.mustUseProperty?n[i.propertyName]=t===null?i.type===3?!1:"":t:(e=i.attributeName,r=i.attributeNamespace,t===null?n.removeAttribute(e):(i=i.type,t=i===3||i===4&&t===!0?"":""+t,r?n.setAttributeNS(r,e,t):n.setAttribute(e,t))))}var Ps=kD.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,gf=Symbol.for("react.element"),bl=Symbol.for("react.portal"),_l=Symbol.for("react.fragment"),rm=Symbol.for("react.strict_mode"),k3=Symbol.for("react.profiler"),Pb=Symbol.for("react.provider"),Ob=Symbol.for("react.context"),im=Symbol.for("react.forward_ref"),R3=Symbol.for("react.suspense"),A3=Symbol.for("react.suspense_list"),sm=Symbol.for("react.memo"),Zs=Symbol.for("react.lazy"),Lb=Symbol.for("react.offscreen"),_8=Symbol.iterator;function Mu(n){return n===null||typeof n!="object"?null:(n=_8&&n[_8]||n["@@iterator"],typeof n=="function"?n:null)}var mt=Object.assign,eg;function id(n){if(eg===void 0)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);eg=e&&e[1]||""}return`
`+eg+n}var tg=!1;function ng(n,e){if(!n||tg)return"";tg=!0;var t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=function(){throw Error()},Object.defineProperty(e.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(e,[])}catch(c){var r=c}Reflect.construct(n,[],e)}else{try{e.call()}catch(c){r=c}n.call(e.prototype)}else{try{throw Error()}catch(c){r=c}n()}}catch(c){if(c&&r&&typeof c.stack=="string"){for(var i=c.stack.split(`
`),s=r.stack.split(`
`),o=i.length-1,a=s.length-1;1<=o&&0<=a&&i[o]!==s[a];)a--;for(;1<=o&&0<=a;o--,a--)if(i[o]!==s[a]){if(o!==1||a!==1)do if(o--,a--,0>a||i[o]!==s[a]){var l=`
`+i[o].replace(" at new "," at ");return n.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",n.displayName)),l}while(1<=o&&0<=a);break}}}finally{tg=!1,Error.prepareStackTrace=t}return(n=n?n.displayName||n.name:"")?id(n):""}function TD(n){switch(n.tag){case 5:return id(n.type);case 16:return id("Lazy");case 13:return id("Suspense");case 19:return id("SuspenseList");case 0:case 2:case 15:return n=ng(n.type,!1),n;case 11:return n=ng(n.type.render,!1),n;case 1:return n=ng(n.type,!0),n;default:return""}}function I3(n){if(n==null)return null;if(typeof n=="function")return n.displayName||n.name||null;if(typeof n=="string")return n;switch(n){case _l:return"Fragment";case bl:return"Portal";case k3:return"Profiler";case rm:return"StrictMode";case R3:return"Suspense";case A3:return"SuspenseList"}if(typeof n=="object")switch(n.$$typeof){case Ob:return(n.displayName||"Context")+".Consumer";case Pb:return(n._context.displayName||"Context")+".Provider";case im:var e=n.render;return n=n.displayName,n||(n=e.displayName||e.name||"",n=n!==""?"ForwardRef("+n+")":"ForwardRef"),n;case sm:return e=n.displayName||null,e!==null?e:I3(n.type)||"Memo";case Zs:e=n._payload,n=n._init;try{return I3(n(e))}catch{}}return null}function ND(n){var e=n.type;switch(n.tag){case 24:return"Cache";case 9:return(e.displayName||"Context")+".Consumer";case 10:return(e._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return n=e.render,n=n.displayName||n.name||"",e.displayName||(n!==""?"ForwardRef("+n+")":"ForwardRef");case 7:return"Fragment";case 5:return e;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return I3(e);case 8:return e===rm?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e}return null}function Io(n){switch(typeof n){case"boolean":case"number":case"string":case"undefined":return n;case"object":return n;default:return""}}function Bb(n){var e=n.type;return(n=n.nodeName)&&n.toLowerCase()==="input"&&(e==="checkbox"||e==="radio")}function DD(n){var e=Bb(n)?"checked":"value",t=Object.getOwnPropertyDescriptor(n.constructor.prototype,e),r=""+n[e];if(!n.hasOwnProperty(e)&&typeof t<"u"&&typeof t.get=="function"&&typeof t.set=="function"){var i=t.get,s=t.set;return Object.defineProperty(n,e,{configurable:!0,get:function(){return i.call(this)},set:function(o){r=""+o,s.call(this,o)}}),Object.defineProperty(n,e,{enumerable:t.enumerable}),{getValue:function(){return r},setValue:function(o){r=""+o},stopTracking:function(){n._valueTracker=null,delete n[e]}}}}function yf(n){n._valueTracker||(n._valueTracker=DD(n))}function Mb(n){if(!n)return!1;var e=n._valueTracker;if(!e)return!0;var t=e.getValue(),r="";return n&&(r=Bb(n)?n.checked?"true":"false":n.value),n=r,n!==t?(e.setValue(n),!0):!1}function Q1(n){if(n=n||(typeof document<"u"?document:void 0),typeof n>"u")return null;try{return n.activeElement||n.body}catch{return n.body}}function C3(n,e){var t=e.checked;return mt({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:t??n._wrapperState.initialChecked})}function S8(n,e){var t=e.defaultValue==null?"":e.defaultValue,r=e.checked!=null?e.checked:e.defaultChecked;t=Io(e.value!=null?e.value:t),n._wrapperState={initialChecked:r,initialValue:t,controlled:e.type==="checkbox"||e.type==="radio"?e.checked!=null:e.value!=null}}function $b(n,e){e=e.checked,e!=null&&nm(n,"checked",e,!1)}function T3(n,e){$b(n,e);var t=Io(e.value),r=e.type;if(t!=null)r==="number"?(t===0&&n.value===""||n.value!=t)&&(n.value=""+t):n.value!==""+t&&(n.value=""+t);else if(r==="submit"||r==="reset"){n.removeAttribute("value");return}e.hasOwnProperty("value")?N3(n,e.type,t):e.hasOwnProperty("defaultValue")&&N3(n,e.type,Io(e.defaultValue)),e.checked==null&&e.defaultChecked!=null&&(n.defaultChecked=!!e.defaultChecked)}function x8(n,e,t){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var r=e.type;if(!(r!=="submit"&&r!=="reset"||e.value!==void 0&&e.value!==null))return;e=""+n._wrapperState.initialValue,t||e===n.value||(n.value=e),n.defaultValue=e}t=n.name,t!==""&&(n.name=""),n.defaultChecked=!!n._wrapperState.initialChecked,t!==""&&(n.name=t)}function N3(n,e,t){(e!=="number"||Q1(n.ownerDocument)!==n)&&(t==null?n.defaultValue=""+n._wrapperState.initialValue:n.defaultValue!==""+t&&(n.defaultValue=""+t))}var sd=Array.isArray;function jl(n,e,t,r){if(n=n.options,e){e={};for(var i=0;i<t.length;i++)e["$"+t[i]]=!0;for(t=0;t<n.length;t++)i=e.hasOwnProperty("$"+n[t].value),n[t].selected!==i&&(n[t].selected=i),i&&r&&(n[t].defaultSelected=!0)}else{for(t=""+Io(t),e=null,i=0;i<n.length;i++){if(n[i].value===t){n[i].selected=!0,r&&(n[i].defaultSelected=!0);return}e!==null||n[i].disabled||(e=n[i])}e!==null&&(e.selected=!0)}}function D3(n,e){if(e.dangerouslySetInnerHTML!=null)throw Error(q(91));return mt({},e,{value:void 0,defaultValue:void 0,children:""+n._wrapperState.initialValue})}function k8(n,e){var t=e.value;if(t==null){if(t=e.children,e=e.defaultValue,t!=null){if(e!=null)throw Error(q(92));if(sd(t)){if(1<t.length)throw Error(q(93));t=t[0]}e=t}e==null&&(e=""),t=e}n._wrapperState={initialValue:Io(t)}}function Ub(n,e){var t=Io(e.value),r=Io(e.defaultValue);t!=null&&(t=""+t,t!==n.value&&(n.value=t),e.defaultValue==null&&n.defaultValue!==t&&(n.defaultValue=t)),r!=null&&(n.defaultValue=""+r)}function R8(n){var e=n.textContent;e===n._wrapperState.initialValue&&e!==""&&e!==null&&(n.value=e)}function Fb(n){switch(n){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function P3(n,e){return n==null||n==="http://www.w3.org/1999/xhtml"?Fb(e):n==="http://www.w3.org/2000/svg"&&e==="foreignObject"?"http://www.w3.org/1999/xhtml":n}var mf,zb=function(n){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(e,t,r,i){MSApp.execUnsafeLocalFunction(function(){return n(e,t,r,i)})}:n}(function(n,e){if(n.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in n)n.innerHTML=e;else{for(mf=mf||document.createElement("div"),mf.innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=mf.firstChild;n.firstChild;)n.removeChild(n.firstChild);for(;e.firstChild;)n.appendChild(e.firstChild)}});function Ud(n,e){if(e){var t=n.firstChild;if(t&&t===n.lastChild&&t.nodeType===3){t.nodeValue=e;return}}n.textContent=e}var wd={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},PD=["Webkit","ms","Moz","O"];Object.keys(wd).forEach(function(n){PD.forEach(function(e){e=e+n.charAt(0).toUpperCase()+n.substring(1),wd[e]=wd[n]})});function Vb(n,e,t){return e==null||typeof e=="boolean"||e===""?"":t||typeof e!="number"||e===0||wd.hasOwnProperty(n)&&wd[n]?(""+e).trim():e+"px"}function Hb(n,e){n=n.style;for(var t in e)if(e.hasOwnProperty(t)){var r=t.indexOf("--")===0,i=Vb(t,e[t],r);t==="float"&&(t="cssFloat"),r?n.setProperty(t,i):n[t]=i}}var OD=mt({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function O3(n,e){if(e){if(OD[n]&&(e.children!=null||e.dangerouslySetInnerHTML!=null))throw Error(q(137,n));if(e.dangerouslySetInnerHTML!=null){if(e.children!=null)throw Error(q(60));if(typeof e.dangerouslySetInnerHTML!="object"||!("__html"in e.dangerouslySetInnerHTML))throw Error(q(61))}if(e.style!=null&&typeof e.style!="object")throw Error(q(62))}}function L3(n,e){if(n.indexOf("-")===-1)return typeof e.is=="string";switch(n){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var B3=null;function om(n){return n=n.target||n.srcElement||window,n.correspondingUseElement&&(n=n.correspondingUseElement),n.nodeType===3?n.parentNode:n}var M3=null,Yl=null,Ql=null;function A8(n){if(n=zh(n)){if(typeof M3!="function")throw Error(q(280));var e=n.stateNode;e&&(e=V2(e),M3(n.stateNode,n.type,e))}}function Kb(n){Yl?Ql?Ql.push(n):Ql=[n]:Yl=n}function Wb(){if(Yl){var n=Yl,e=Ql;if(Ql=Yl=null,A8(n),e)for(n=0;n<e.length;n++)A8(e[n])}}function Gb(n,e){return n(e)}function qb(){}var rg=!1;function jb(n,e,t){if(rg)return n(e,t);rg=!0;try{return Gb(n,e,t)}finally{rg=!1,(Yl!==null||Ql!==null)&&(qb(),Wb())}}function Fd(n,e){var t=n.stateNode;if(t===null)return null;var r=V2(t);if(r===null)return null;t=r[e];e:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(r=!r.disabled)||(n=n.type,r=!(n==="button"||n==="input"||n==="select"||n==="textarea")),n=!r;break e;default:n=!1}if(n)return null;if(t&&typeof t!="function")throw Error(q(231,e,typeof t));return t}var $3=!1;if(Rs)try{var $u={};Object.defineProperty($u,"passive",{get:function(){$3=!0}}),window.addEventListener("test",$u,$u),window.removeEventListener("test",$u,$u)}catch{$3=!1}function LD(n,e,t,r,i,s,o,a,l){var c=Array.prototype.slice.call(arguments,3);try{e.apply(t,c)}catch(u){this.onError(u)}}var vd=!1,X1=null,J1=!1,U3=null,BD={onError:function(n){vd=!0,X1=n}};function MD(n,e,t,r,i,s,o,a,l){vd=!1,X1=null,LD.apply(BD,arguments)}function $D(n,e,t,r,i,s,o,a,l){if(MD.apply(this,arguments),vd){if(vd){var c=X1;vd=!1,X1=null}else throw Error(q(198));J1||(J1=!0,U3=c)}}function Xa(n){var e=n,t=n;if(n.alternate)for(;e.return;)e=e.return;else{n=e;do e=n,e.flags&4098&&(t=e.return),n=e.return;while(n)}return e.tag===3?t:null}function Yb(n){if(n.tag===13){var e=n.memoizedState;if(e===null&&(n=n.alternate,n!==null&&(e=n.memoizedState)),e!==null)return e.dehydrated}return null}function I8(n){if(Xa(n)!==n)throw Error(q(188))}function UD(n){var e=n.alternate;if(!e){if(e=Xa(n),e===null)throw Error(q(188));return e!==n?null:n}for(var t=n,r=e;;){var i=t.return;if(i===null)break;var s=i.alternate;if(s===null){if(r=i.return,r!==null){t=r;continue}break}if(i.child===s.child){for(s=i.child;s;){if(s===t)return I8(i),n;if(s===r)return I8(i),e;s=s.sibling}throw Error(q(188))}if(t.return!==r.return)t=i,r=s;else{for(var o=!1,a=i.child;a;){if(a===t){o=!0,t=i,r=s;break}if(a===r){o=!0,r=i,t=s;break}a=a.sibling}if(!o){for(a=s.child;a;){if(a===t){o=!0,t=s,r=i;break}if(a===r){o=!0,r=s,t=i;break}a=a.sibling}if(!o)throw Error(q(189))}}if(t.alternate!==r)throw Error(q(190))}if(t.tag!==3)throw Error(q(188));return t.stateNode.current===t?n:e}function Qb(n){return n=UD(n),n!==null?Xb(n):null}function Xb(n){if(n.tag===5||n.tag===6)return n;for(n=n.child;n!==null;){var e=Xb(n);if(e!==null)return e;n=n.sibling}return null}var Jb=lr.unstable_scheduleCallback,C8=lr.unstable_cancelCallback,FD=lr.unstable_shouldYield,zD=lr.unstable_requestPaint,kt=lr.unstable_now,VD=lr.unstable_getCurrentPriorityLevel,am=lr.unstable_ImmediatePriority,Zb=lr.unstable_UserBlockingPriority,Z1=lr.unstable_NormalPriority,HD=lr.unstable_LowPriority,e_=lr.unstable_IdlePriority,$2=null,Mi=null;function KD(n){if(Mi&&typeof Mi.onCommitFiberRoot=="function")try{Mi.onCommitFiberRoot($2,n,void 0,(n.current.flags&128)===128)}catch{}}var ni=Math.clz32?Math.clz32:qD,WD=Math.log,GD=Math.LN2;function qD(n){return n>>>=0,n===0?32:31-(WD(n)/GD|0)|0}var wf=64,vf=4194304;function od(n){switch(n&-n){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return n&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return n&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return n}}function e0(n,e){var t=n.pendingLanes;if(t===0)return 0;var r=0,i=n.suspendedLanes,s=n.pingedLanes,o=t&268435455;if(o!==0){var a=o&~i;a!==0?r=od(a):(s&=o,s!==0&&(r=od(s)))}else o=t&~i,o!==0?r=od(o):s!==0&&(r=od(s));if(r===0)return 0;if(e!==0&&e!==r&&!(e&i)&&(i=r&-r,s=e&-e,i>=s||i===16&&(s&4194240)!==0))return e;if(r&4&&(r|=t&16),e=n.entangledLanes,e!==0)for(n=n.entanglements,e&=r;0<e;)t=31-ni(e),i=1<<t,r|=n[t],e&=~i;return r}function jD(n,e){switch(n){case 1:case 2:case 4:return e+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function YD(n,e){for(var t=n.suspendedLanes,r=n.pingedLanes,i=n.expirationTimes,s=n.pendingLanes;0<s;){var o=31-ni(s),a=1<<o,l=i[o];l===-1?(!(a&t)||a&r)&&(i[o]=jD(a,e)):l<=e&&(n.expiredLanes|=a),s&=~a}}function F3(n){return n=n.pendingLanes&-1073741825,n!==0?n:n&1073741824?1073741824:0}function t_(){var n=wf;return wf<<=1,!(wf&4194240)&&(wf=64),n}function ig(n){for(var e=[],t=0;31>t;t++)e.push(n);return e}function Uh(n,e,t){n.pendingLanes|=e,e!==536870912&&(n.suspendedLanes=0,n.pingedLanes=0),n=n.eventTimes,e=31-ni(e),n[e]=t}function QD(n,e){var t=n.pendingLanes&~e;n.pendingLanes=e,n.suspendedLanes=0,n.pingedLanes=0,n.expiredLanes&=e,n.mutableReadLanes&=e,n.entangledLanes&=e,e=n.entanglements;var r=n.eventTimes;for(n=n.expirationTimes;0<t;){var i=31-ni(t),s=1<<i;e[i]=0,r[i]=-1,n[i]=-1,t&=~s}}function lm(n,e){var t=n.entangledLanes|=e;for(n=n.entanglements;t;){var r=31-ni(t),i=1<<r;i&e|n[r]&e&&(n[r]|=e),t&=~i}}var Ye=0;function n_(n){return n&=-n,1<n?4<n?n&268435455?16:536870912:4:1}var r_,cm,i_,s_,o_,z3=!1,Ef=[],go=null,yo=null,mo=null,zd=new Map,Vd=new Map,io=[],XD="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function T8(n,e){switch(n){case"focusin":case"focusout":go=null;break;case"dragenter":case"dragleave":yo=null;break;case"mouseover":case"mouseout":mo=null;break;case"pointerover":case"pointerout":zd.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":Vd.delete(e.pointerId)}}function Uu(n,e,t,r,i,s){return n===null||n.nativeEvent!==s?(n={blockedOn:e,domEventName:t,eventSystemFlags:r,nativeEvent:s,targetContainers:[i]},e!==null&&(e=zh(e),e!==null&&cm(e)),n):(n.eventSystemFlags|=r,e=n.targetContainers,i!==null&&e.indexOf(i)===-1&&e.push(i),n)}function JD(n,e,t,r,i){switch(e){case"focusin":return go=Uu(go,n,e,t,r,i),!0;case"dragenter":return yo=Uu(yo,n,e,t,r,i),!0;case"mouseover":return mo=Uu(mo,n,e,t,r,i),!0;case"pointerover":var s=i.pointerId;return zd.set(s,Uu(zd.get(s)||null,n,e,t,r,i)),!0;case"gotpointercapture":return s=i.pointerId,Vd.set(s,Uu(Vd.get(s)||null,n,e,t,r,i)),!0}return!1}function a_(n){var e=ua(n.target);if(e!==null){var t=Xa(e);if(t!==null){if(e=t.tag,e===13){if(e=Yb(t),e!==null){n.blockedOn=e,o_(n.priority,function(){i_(t)});return}}else if(e===3&&t.stateNode.current.memoizedState.isDehydrated){n.blockedOn=t.tag===3?t.stateNode.containerInfo:null;return}}}n.blockedOn=null}function f1(n){if(n.blockedOn!==null)return!1;for(var e=n.targetContainers;0<e.length;){var t=V3(n.domEventName,n.eventSystemFlags,e[0],n.nativeEvent);if(t===null){t=n.nativeEvent;var r=new t.constructor(t.type,t);B3=r,t.target.dispatchEvent(r),B3=null}else return e=zh(t),e!==null&&cm(e),n.blockedOn=t,!1;e.shift()}return!0}function N8(n,e,t){f1(n)&&t.delete(e)}function ZD(){z3=!1,go!==null&&f1(go)&&(go=null),yo!==null&&f1(yo)&&(yo=null),mo!==null&&f1(mo)&&(mo=null),zd.forEach(N8),Vd.forEach(N8)}function Fu(n,e){n.blockedOn===e&&(n.blockedOn=null,z3||(z3=!0,lr.unstable_scheduleCallback(lr.unstable_NormalPriority,ZD)))}function Hd(n){function e(i){return Fu(i,n)}if(0<Ef.length){Fu(Ef[0],n);for(var t=1;t<Ef.length;t++){var r=Ef[t];r.blockedOn===n&&(r.blockedOn=null)}}for(go!==null&&Fu(go,n),yo!==null&&Fu(yo,n),mo!==null&&Fu(mo,n),zd.forEach(e),Vd.forEach(e),t=0;t<io.length;t++)r=io[t],r.blockedOn===n&&(r.blockedOn=null);for(;0<io.length&&(t=io[0],t.blockedOn===null);)a_(t),t.blockedOn===null&&io.shift()}var Xl=Ps.ReactCurrentBatchConfig,t0=!0;function eP(n,e,t,r){var i=Ye,s=Xl.transition;Xl.transition=null;try{Ye=1,um(n,e,t,r)}finally{Ye=i,Xl.transition=s}}function tP(n,e,t,r){var i=Ye,s=Xl.transition;Xl.transition=null;try{Ye=4,um(n,e,t,r)}finally{Ye=i,Xl.transition=s}}function um(n,e,t,r){if(t0){var i=V3(n,e,t,r);if(i===null)pg(n,e,r,n0,t),T8(n,r);else if(JD(i,n,e,t,r))r.stopPropagation();else if(T8(n,r),e&4&&-1<XD.indexOf(n)){for(;i!==null;){var s=zh(i);if(s!==null&&r_(s),s=V3(n,e,t,r),s===null&&pg(n,e,r,n0,t),s===i)break;i=s}i!==null&&r.stopPropagation()}else pg(n,e,r,null,t)}}var n0=null;function V3(n,e,t,r){if(n0=null,n=om(r),n=ua(n),n!==null)if(e=Xa(n),e===null)n=null;else if(t=e.tag,t===13){if(n=Yb(e),n!==null)return n;n=null}else if(t===3){if(e.stateNode.current.memoizedState.isDehydrated)return e.tag===3?e.stateNode.containerInfo:null;n=null}else e!==n&&(n=null);return n0=n,null}function l_(n){switch(n){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(VD()){case am:return 1;case Zb:return 4;case Z1:case HD:return 16;case e_:return 536870912;default:return 16}default:return 16}}var co=null,dm=null,p1=null;function c_(){if(p1)return p1;var n,e=dm,t=e.length,r,i="value"in co?co.value:co.textContent,s=i.length;for(n=0;n<t&&e[n]===i[n];n++);var o=t-n;for(r=1;r<=o&&e[t-r]===i[s-r];r++);return p1=i.slice(n,1<r?1-r:void 0)}function g1(n){var e=n.keyCode;return"charCode"in n?(n=n.charCode,n===0&&e===13&&(n=13)):n=e,n===10&&(n=13),32<=n||n===13?n:0}function bf(){return!0}function D8(){return!1}function pr(n){function e(t,r,i,s,o){this._reactName=t,this._targetInst=i,this.type=r,this.nativeEvent=s,this.target=o,this.currentTarget=null;for(var a in n)n.hasOwnProperty(a)&&(t=n[a],this[a]=t?t(s):s[a]);return this.isDefaultPrevented=(s.defaultPrevented!=null?s.defaultPrevented:s.returnValue===!1)?bf:D8,this.isPropagationStopped=D8,this}return mt(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():typeof t.returnValue!="unknown"&&(t.returnValue=!1),this.isDefaultPrevented=bf)},stopPropagation:function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():typeof t.cancelBubble!="unknown"&&(t.cancelBubble=!0),this.isPropagationStopped=bf)},persist:function(){},isPersistent:bf}),e}var uu={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(n){return n.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},hm=pr(uu),Fh=mt({},uu,{view:0,detail:0}),nP=pr(Fh),sg,og,zu,U2=mt({},Fh,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:fm,button:0,buttons:0,relatedTarget:function(n){return n.relatedTarget===void 0?n.fromElement===n.srcElement?n.toElement:n.fromElement:n.relatedTarget},movementX:function(n){return"movementX"in n?n.movementX:(n!==zu&&(zu&&n.type==="mousemove"?(sg=n.screenX-zu.screenX,og=n.screenY-zu.screenY):og=sg=0,zu=n),sg)},movementY:function(n){return"movementY"in n?n.movementY:og}}),P8=pr(U2),rP=mt({},U2,{dataTransfer:0}),iP=pr(rP),sP=mt({},Fh,{relatedTarget:0}),ag=pr(sP),oP=mt({},uu,{animationName:0,elapsedTime:0,pseudoElement:0}),aP=pr(oP),lP=mt({},uu,{clipboardData:function(n){return"clipboardData"in n?n.clipboardData:window.clipboardData}}),cP=pr(lP),uP=mt({},uu,{data:0}),O8=pr(uP),dP={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},hP={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},fP={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function pP(n){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(n):(n=fP[n])?!!e[n]:!1}function fm(){return pP}var gP=mt({},Fh,{key:function(n){if(n.key){var e=dP[n.key]||n.key;if(e!=="Unidentified")return e}return n.type==="keypress"?(n=g1(n),n===13?"Enter":String.fromCharCode(n)):n.type==="keydown"||n.type==="keyup"?hP[n.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:fm,charCode:function(n){return n.type==="keypress"?g1(n):0},keyCode:function(n){return n.type==="keydown"||n.type==="keyup"?n.keyCode:0},which:function(n){return n.type==="keypress"?g1(n):n.type==="keydown"||n.type==="keyup"?n.keyCode:0}}),yP=pr(gP),mP=mt({},U2,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),L8=pr(mP),wP=mt({},Fh,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:fm}),vP=pr(wP),EP=mt({},uu,{propertyName:0,elapsedTime:0,pseudoElement:0}),bP=pr(EP),_P=mt({},U2,{deltaX:function(n){return"deltaX"in n?n.deltaX:"wheelDeltaX"in n?-n.wheelDeltaX:0},deltaY:function(n){return"deltaY"in n?n.deltaY:"wheelDeltaY"in n?-n.wheelDeltaY:"wheelDelta"in n?-n.wheelDelta:0},deltaZ:0,deltaMode:0}),SP=pr(_P),xP=[9,13,27,32],pm=Rs&&"CompositionEvent"in window,Ed=null;Rs&&"documentMode"in document&&(Ed=document.documentMode);var kP=Rs&&"TextEvent"in window&&!Ed,u_=Rs&&(!pm||Ed&&8<Ed&&11>=Ed),B8=" ",M8=!1;function d_(n,e){switch(n){case"keyup":return xP.indexOf(e.keyCode)!==-1;case"keydown":return e.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function h_(n){return n=n.detail,typeof n=="object"&&"data"in n?n.data:null}var Sl=!1;function RP(n,e){switch(n){case"compositionend":return h_(e);case"keypress":return e.which!==32?null:(M8=!0,B8);case"textInput":return n=e.data,n===B8&&M8?null:n;default:return null}}function AP(n,e){if(Sl)return n==="compositionend"||!pm&&d_(n,e)?(n=c_(),p1=dm=co=null,Sl=!1,n):null;switch(n){case"paste":return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return u_&&e.locale!=="ko"?null:e.data;default:return null}}var IP={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function $8(n){var e=n&&n.nodeName&&n.nodeName.toLowerCase();return e==="input"?!!IP[n.type]:e==="textarea"}function f_(n,e,t,r){Kb(r),e=r0(e,"onChange"),0<e.length&&(t=new hm("onChange","change",null,t,r),n.push({event:t,listeners:e}))}var bd=null,Kd=null;function CP(n){x_(n,0)}function F2(n){var e=Rl(n);if(Mb(e))return n}function TP(n,e){if(n==="change")return e}var p_=!1;if(Rs){var lg;if(Rs){var cg="oninput"in document;if(!cg){var U8=document.createElement("div");U8.setAttribute("oninput","return;"),cg=typeof U8.oninput=="function"}lg=cg}else lg=!1;p_=lg&&(!document.documentMode||9<document.documentMode)}function F8(){bd&&(bd.detachEvent("onpropertychange",g_),Kd=bd=null)}function g_(n){if(n.propertyName==="value"&&F2(Kd)){var e=[];f_(e,Kd,n,om(n)),jb(CP,e)}}function NP(n,e,t){n==="focusin"?(F8(),bd=e,Kd=t,bd.attachEvent("onpropertychange",g_)):n==="focusout"&&F8()}function DP(n){if(n==="selectionchange"||n==="keyup"||n==="keydown")return F2(Kd)}function PP(n,e){if(n==="click")return F2(e)}function OP(n,e){if(n==="input"||n==="change")return F2(e)}function LP(n,e){return n===e&&(n!==0||1/n===1/e)||n!==n&&e!==e}var li=typeof Object.is=="function"?Object.is:LP;function Wd(n,e){if(li(n,e))return!0;if(typeof n!="object"||n===null||typeof e!="object"||e===null)return!1;var t=Object.keys(n),r=Object.keys(e);if(t.length!==r.length)return!1;for(r=0;r<t.length;r++){var i=t[r];if(!x3.call(e,i)||!li(n[i],e[i]))return!1}return!0}function z8(n){for(;n&&n.firstChild;)n=n.firstChild;return n}function V8(n,e){var t=z8(n);n=0;for(var r;t;){if(t.nodeType===3){if(r=n+t.textContent.length,n<=e&&r>=e)return{node:t,offset:e-n};n=r}e:{for(;t;){if(t.nextSibling){t=t.nextSibling;break e}t=t.parentNode}t=void 0}t=z8(t)}}function y_(n,e){return n&&e?n===e?!0:n&&n.nodeType===3?!1:e&&e.nodeType===3?y_(n,e.parentNode):"contains"in n?n.contains(e):n.compareDocumentPosition?!!(n.compareDocumentPosition(e)&16):!1:!1}function m_(){for(var n=window,e=Q1();e instanceof n.HTMLIFrameElement;){try{var t=typeof e.contentWindow.location.href=="string"}catch{t=!1}if(t)n=e.contentWindow;else break;e=Q1(n.document)}return e}function gm(n){var e=n&&n.nodeName&&n.nodeName.toLowerCase();return e&&(e==="input"&&(n.type==="text"||n.type==="search"||n.type==="tel"||n.type==="url"||n.type==="password")||e==="textarea"||n.contentEditable==="true")}function BP(n){var e=m_(),t=n.focusedElem,r=n.selectionRange;if(e!==t&&t&&t.ownerDocument&&y_(t.ownerDocument.documentElement,t)){if(r!==null&&gm(t)){if(e=r.start,n=r.end,n===void 0&&(n=e),"selectionStart"in t)t.selectionStart=e,t.selectionEnd=Math.min(n,t.value.length);else if(n=(e=t.ownerDocument||document)&&e.defaultView||window,n.getSelection){n=n.getSelection();var i=t.textContent.length,s=Math.min(r.start,i);r=r.end===void 0?s:Math.min(r.end,i),!n.extend&&s>r&&(i=r,r=s,s=i),i=V8(t,s);var o=V8(t,r);i&&o&&(n.rangeCount!==1||n.anchorNode!==i.node||n.anchorOffset!==i.offset||n.focusNode!==o.node||n.focusOffset!==o.offset)&&(e=e.createRange(),e.setStart(i.node,i.offset),n.removeAllRanges(),s>r?(n.addRange(e),n.extend(o.node,o.offset)):(e.setEnd(o.node,o.offset),n.addRange(e)))}}for(e=[],n=t;n=n.parentNode;)n.nodeType===1&&e.push({element:n,left:n.scrollLeft,top:n.scrollTop});for(typeof t.focus=="function"&&t.focus(),t=0;t<e.length;t++)n=e[t],n.element.scrollLeft=n.left,n.element.scrollTop=n.top}}var MP=Rs&&"documentMode"in document&&11>=document.documentMode,xl=null,H3=null,_d=null,K3=!1;function H8(n,e,t){var r=t.window===t?t.document:t.nodeType===9?t:t.ownerDocument;K3||xl==null||xl!==Q1(r)||(r=xl,"selectionStart"in r&&gm(r)?r={start:r.selectionStart,end:r.selectionEnd}:(r=(r.ownerDocument&&r.ownerDocument.defaultView||window).getSelection(),r={anchorNode:r.anchorNode,anchorOffset:r.anchorOffset,focusNode:r.focusNode,focusOffset:r.focusOffset}),_d&&Wd(_d,r)||(_d=r,r=r0(H3,"onSelect"),0<r.length&&(e=new hm("onSelect","select",null,e,t),n.push({event:e,listeners:r}),e.target=xl)))}function _f(n,e){var t={};return t[n.toLowerCase()]=e.toLowerCase(),t["Webkit"+n]="webkit"+e,t["Moz"+n]="moz"+e,t}var kl={animationend:_f("Animation","AnimationEnd"),animationiteration:_f("Animation","AnimationIteration"),animationstart:_f("Animation","AnimationStart"),transitionend:_f("Transition","TransitionEnd")},ug={},w_={};Rs&&(w_=document.createElement("div").style,"AnimationEvent"in window||(delete kl.animationend.animation,delete kl.animationiteration.animation,delete kl.animationstart.animation),"TransitionEvent"in window||delete kl.transitionend.transition);function z2(n){if(ug[n])return ug[n];if(!kl[n])return n;var e=kl[n],t;for(t in e)if(e.hasOwnProperty(t)&&t in w_)return ug[n]=e[t];return n}var v_=z2("animationend"),E_=z2("animationiteration"),b_=z2("animationstart"),__=z2("transitionend"),S_=new Map,K8="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function zo(n,e){S_.set(n,e),Qa(e,[n])}for(var dg=0;dg<K8.length;dg++){var hg=K8[dg],$P=hg.toLowerCase(),UP=hg[0].toUpperCase()+hg.slice(1);zo($P,"on"+UP)}zo(v_,"onAnimationEnd");zo(E_,"onAnimationIteration");zo(b_,"onAnimationStart");zo("dblclick","onDoubleClick");zo("focusin","onFocus");zo("focusout","onBlur");zo(__,"onTransitionEnd");Ec("onMouseEnter",["mouseout","mouseover"]);Ec("onMouseLeave",["mouseout","mouseover"]);Ec("onPointerEnter",["pointerout","pointerover"]);Ec("onPointerLeave",["pointerout","pointerover"]);Qa("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));Qa("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));Qa("onBeforeInput",["compositionend","keypress","textInput","paste"]);Qa("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));Qa("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));Qa("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var ad="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),FP=new Set("cancel close invalid load scroll toggle".split(" ").concat(ad));function W8(n,e,t){var r=n.type||"unknown-event";n.currentTarget=t,$D(r,e,void 0,n),n.currentTarget=null}function x_(n,e){e=(e&4)!==0;for(var t=0;t<n.length;t++){var r=n[t],i=r.event;r=r.listeners;e:{var s=void 0;if(e)for(var o=r.length-1;0<=o;o--){var a=r[o],l=a.instance,c=a.currentTarget;if(a=a.listener,l!==s&&i.isPropagationStopped())break e;W8(i,a,c),s=l}else for(o=0;o<r.length;o++){if(a=r[o],l=a.instance,c=a.currentTarget,a=a.listener,l!==s&&i.isPropagationStopped())break e;W8(i,a,c),s=l}}}if(J1)throw n=U3,J1=!1,U3=null,n}function st(n,e){var t=e[Y3];t===void 0&&(t=e[Y3]=new Set);var r=n+"__bubble";t.has(r)||(k_(e,n,2,!1),t.add(r))}function fg(n,e,t){var r=0;e&&(r|=4),k_(t,n,r,e)}var Sf="_reactListening"+Math.random().toString(36).slice(2);function Gd(n){if(!n[Sf]){n[Sf]=!0,Db.forEach(function(t){t!=="selectionchange"&&(FP.has(t)||fg(t,!1,n),fg(t,!0,n))});var e=n.nodeType===9?n:n.ownerDocument;e===null||e[Sf]||(e[Sf]=!0,fg("selectionchange",!1,e))}}function k_(n,e,t,r){switch(l_(e)){case 1:var i=eP;break;case 4:i=tP;break;default:i=um}t=i.bind(null,e,t,n),i=void 0,!$3||e!=="touchstart"&&e!=="touchmove"&&e!=="wheel"||(i=!0),r?i!==void 0?n.addEventListener(e,t,{capture:!0,passive:i}):n.addEventListener(e,t,!0):i!==void 0?n.addEventListener(e,t,{passive:i}):n.addEventListener(e,t,!1)}function pg(n,e,t,r,i){var s=r;if(!(e&1)&&!(e&2)&&r!==null)e:for(;;){if(r===null)return;var o=r.tag;if(o===3||o===4){var a=r.stateNode.containerInfo;if(a===i||a.nodeType===8&&a.parentNode===i)break;if(o===4)for(o=r.return;o!==null;){var l=o.tag;if((l===3||l===4)&&(l=o.stateNode.containerInfo,l===i||l.nodeType===8&&l.parentNode===i))return;o=o.return}for(;a!==null;){if(o=ua(a),o===null)return;if(l=o.tag,l===5||l===6){r=s=o;continue e}a=a.parentNode}}r=r.return}jb(function(){var c=s,u=om(t),d=[];e:{var f=S_.get(n);if(f!==void 0){var p=hm,y=n;switch(n){case"keypress":if(g1(t)===0)break e;case"keydown":case"keyup":p=yP;break;case"focusin":y="focus",p=ag;break;case"focusout":y="blur",p=ag;break;case"beforeblur":case"afterblur":p=ag;break;case"click":if(t.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":p=P8;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":p=iP;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":p=vP;break;case v_:case E_:case b_:p=aP;break;case __:p=bP;break;case"scroll":p=nP;break;case"wheel":p=SP;break;case"copy":case"cut":case"paste":p=cP;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":p=L8}var g=(e&4)!==0,w=!g&&n==="scroll",m=g?f!==null?f+"Capture":null:f;g=[];for(var E=c,v;E!==null;){v=E;var b=v.stateNode;if(v.tag===5&&b!==null&&(v=b,m!==null&&(b=Fd(E,m),b!=null&&g.push(qd(E,b,v)))),w)break;E=E.return}0<g.length&&(f=new p(f,y,null,t,u),d.push({event:f,listeners:g}))}}if(!(e&7)){e:{if(f=n==="mouseover"||n==="pointerover",p=n==="mouseout"||n==="pointerout",f&&t!==B3&&(y=t.relatedTarget||t.fromElement)&&(ua(y)||y[As]))break e;if((p||f)&&(f=u.window===u?u:(f=u.ownerDocument)?f.defaultView||f.parentWindow:window,p?(y=t.relatedTarget||t.toElement,p=c,y=y?ua(y):null,y!==null&&(w=Xa(y),y!==w||y.tag!==5&&y.tag!==6)&&(y=null)):(p=null,y=c),p!==y)){if(g=P8,b="onMouseLeave",m="onMouseEnter",E="mouse",(n==="pointerout"||n==="pointerover")&&(g=L8,b="onPointerLeave",m="onPointerEnter",E="pointer"),w=p==null?f:Rl(p),v=y==null?f:Rl(y),f=new g(b,E+"leave",p,t,u),f.target=w,f.relatedTarget=v,b=null,ua(u)===c&&(g=new g(m,E+"enter",y,t,u),g.target=v,g.relatedTarget=w,b=g),w=b,p&&y)t:{for(g=p,m=y,E=0,v=g;v;v=pl(v))E++;for(v=0,b=m;b;b=pl(b))v++;for(;0<E-v;)g=pl(g),E--;for(;0<v-E;)m=pl(m),v--;for(;E--;){if(g===m||m!==null&&g===m.alternate)break t;g=pl(g),m=pl(m)}g=null}else g=null;p!==null&&G8(d,f,p,g,!1),y!==null&&w!==null&&G8(d,w,y,g,!0)}}e:{if(f=c?Rl(c):window,p=f.nodeName&&f.nodeName.toLowerCase(),p==="select"||p==="input"&&f.type==="file")var k=TP;else if($8(f))if(p_)k=OP;else{k=DP;var A=NP}else(p=f.nodeName)&&p.toLowerCase()==="input"&&(f.type==="checkbox"||f.type==="radio")&&(k=PP);if(k&&(k=k(n,c))){f_(d,k,t,u);break e}A&&A(n,f,c),n==="focusout"&&(A=f._wrapperState)&&A.controlled&&f.type==="number"&&N3(f,"number",f.value)}switch(A=c?Rl(c):window,n){case"focusin":($8(A)||A.contentEditable==="true")&&(xl=A,H3=c,_d=null);break;case"focusout":_d=H3=xl=null;break;case"mousedown":K3=!0;break;case"contextmenu":case"mouseup":case"dragend":K3=!1,H8(d,t,u);break;case"selectionchange":if(MP)break;case"keydown":case"keyup":H8(d,t,u)}var T;if(pm)e:{switch(n){case"compositionstart":var P="onCompositionStart";break e;case"compositionend":P="onCompositionEnd";break e;case"compositionupdate":P="onCompositionUpdate";break e}P=void 0}else Sl?d_(n,t)&&(P="onCompositionEnd"):n==="keydown"&&t.keyCode===229&&(P="onCompositionStart");P&&(u_&&t.locale!=="ko"&&(Sl||P!=="onCompositionStart"?P==="onCompositionEnd"&&Sl&&(T=c_()):(co=u,dm="value"in co?co.value:co.textContent,Sl=!0)),A=r0(c,P),0<A.length&&(P=new O8(P,n,null,t,u),d.push({event:P,listeners:A}),T?P.data=T:(T=h_(t),T!==null&&(P.data=T)))),(T=kP?RP(n,t):AP(n,t))&&(c=r0(c,"onBeforeInput"),0<c.length&&(u=new O8("onBeforeInput","beforeinput",null,t,u),d.push({event:u,listeners:c}),u.data=T))}x_(d,e)})}function qd(n,e,t){return{instance:n,listener:e,currentTarget:t}}function r0(n,e){for(var t=e+"Capture",r=[];n!==null;){var i=n,s=i.stateNode;i.tag===5&&s!==null&&(i=s,s=Fd(n,t),s!=null&&r.unshift(qd(n,s,i)),s=Fd(n,e),s!=null&&r.push(qd(n,s,i))),n=n.return}return r}function pl(n){if(n===null)return null;do n=n.return;while(n&&n.tag!==5);return n||null}function G8(n,e,t,r,i){for(var s=e._reactName,o=[];t!==null&&t!==r;){var a=t,l=a.alternate,c=a.stateNode;if(l!==null&&l===r)break;a.tag===5&&c!==null&&(a=c,i?(l=Fd(t,s),l!=null&&o.unshift(qd(t,l,a))):i||(l=Fd(t,s),l!=null&&o.push(qd(t,l,a)))),t=t.return}o.length!==0&&n.push({event:e,listeners:o})}var zP=/\r\n?/g,VP=/\u0000|\uFFFD/g;function q8(n){return(typeof n=="string"?n:""+n).replace(zP,`
`).replace(VP,"")}function xf(n,e,t){if(e=q8(e),q8(n)!==e&&t)throw Error(q(425))}function i0(){}var W3=null,G3=null;function q3(n,e){return n==="textarea"||n==="noscript"||typeof e.children=="string"||typeof e.children=="number"||typeof e.dangerouslySetInnerHTML=="object"&&e.dangerouslySetInnerHTML!==null&&e.dangerouslySetInnerHTML.__html!=null}var j3=typeof setTimeout=="function"?setTimeout:void 0,HP=typeof clearTimeout=="function"?clearTimeout:void 0,j8=typeof Promise=="function"?Promise:void 0,KP=typeof queueMicrotask=="function"?queueMicrotask:typeof j8<"u"?function(n){return j8.resolve(null).then(n).catch(WP)}:j3;function WP(n){setTimeout(function(){throw n})}function gg(n,e){var t=e,r=0;do{var i=t.nextSibling;if(n.removeChild(t),i&&i.nodeType===8)if(t=i.data,t==="/$"){if(r===0){n.removeChild(i),Hd(e);return}r--}else t!=="$"&&t!=="$?"&&t!=="$!"||r++;t=i}while(t);Hd(e)}function wo(n){for(;n!=null;n=n.nextSibling){var e=n.nodeType;if(e===1||e===3)break;if(e===8){if(e=n.data,e==="$"||e==="$!"||e==="$?")break;if(e==="/$")return null}}return n}function Y8(n){n=n.previousSibling;for(var e=0;n;){if(n.nodeType===8){var t=n.data;if(t==="$"||t==="$!"||t==="$?"){if(e===0)return n;e--}else t==="/$"&&e++}n=n.previousSibling}return null}var du=Math.random().toString(36).slice(2),Oi="__reactFiber$"+du,jd="__reactProps$"+du,As="__reactContainer$"+du,Y3="__reactEvents$"+du,GP="__reactListeners$"+du,qP="__reactHandles$"+du;function ua(n){var e=n[Oi];if(e)return e;for(var t=n.parentNode;t;){if(e=t[As]||t[Oi]){if(t=e.alternate,e.child!==null||t!==null&&t.child!==null)for(n=Y8(n);n!==null;){if(t=n[Oi])return t;n=Y8(n)}return e}n=t,t=n.parentNode}return null}function zh(n){return n=n[Oi]||n[As],!n||n.tag!==5&&n.tag!==6&&n.tag!==13&&n.tag!==3?null:n}function Rl(n){if(n.tag===5||n.tag===6)return n.stateNode;throw Error(q(33))}function V2(n){return n[jd]||null}var Q3=[],Al=-1;function Vo(n){return{current:n}}function lt(n){0>Al||(n.current=Q3[Al],Q3[Al]=null,Al--)}function tt(n,e){Al++,Q3[Al]=n.current,n.current=e}var Co={},wn=Vo(Co),Gn=Vo(!1),Oa=Co;function bc(n,e){var t=n.type.contextTypes;if(!t)return Co;var r=n.stateNode;if(r&&r.__reactInternalMemoizedUnmaskedChildContext===e)return r.__reactInternalMemoizedMaskedChildContext;var i={},s;for(s in t)i[s]=e[s];return r&&(n=n.stateNode,n.__reactInternalMemoizedUnmaskedChildContext=e,n.__reactInternalMemoizedMaskedChildContext=i),i}function qn(n){return n=n.childContextTypes,n!=null}function s0(){lt(Gn),lt(wn)}function Q8(n,e,t){if(wn.current!==Co)throw Error(q(168));tt(wn,e),tt(Gn,t)}function R_(n,e,t){var r=n.stateNode;if(e=e.childContextTypes,typeof r.getChildContext!="function")return t;r=r.getChildContext();for(var i in r)if(!(i in e))throw Error(q(108,ND(n)||"Unknown",i));return mt({},t,r)}function o0(n){return n=(n=n.stateNode)&&n.__reactInternalMemoizedMergedChildContext||Co,Oa=wn.current,tt(wn,n),tt(Gn,Gn.current),!0}function X8(n,e,t){var r=n.stateNode;if(!r)throw Error(q(169));t?(n=R_(n,e,Oa),r.__reactInternalMemoizedMergedChildContext=n,lt(Gn),lt(wn),tt(wn,n)):lt(Gn),tt(Gn,t)}var ls=null,H2=!1,yg=!1;function A_(n){ls===null?ls=[n]:ls.push(n)}function jP(n){H2=!0,A_(n)}function Ho(){if(!yg&&ls!==null){yg=!0;var n=0,e=Ye;try{var t=ls;for(Ye=1;n<t.length;n++){var r=t[n];do r=r(!0);while(r!==null)}ls=null,H2=!1}catch(i){throw ls!==null&&(ls=ls.slice(n+1)),Jb(am,Ho),i}finally{Ye=e,yg=!1}}return null}var Il=[],Cl=0,a0=null,l0=0,Rr=[],Ar=0,La=null,ms=1,ws="";function na(n,e){Il[Cl++]=l0,Il[Cl++]=a0,a0=n,l0=e}function I_(n,e,t){Rr[Ar++]=ms,Rr[Ar++]=ws,Rr[Ar++]=La,La=n;var r=ms;n=ws;var i=32-ni(r)-1;r&=~(1<<i),t+=1;var s=32-ni(e)+i;if(30<s){var o=i-i%5;s=(r&(1<<o)-1).toString(32),r>>=o,i-=o,ms=1<<32-ni(e)+i|t<<i|r,ws=s+n}else ms=1<<s|t<<i|r,ws=n}function ym(n){n.return!==null&&(na(n,1),I_(n,1,0))}function mm(n){for(;n===a0;)a0=Il[--Cl],Il[Cl]=null,l0=Il[--Cl],Il[Cl]=null;for(;n===La;)La=Rr[--Ar],Rr[Ar]=null,ws=Rr[--Ar],Rr[Ar]=null,ms=Rr[--Ar],Rr[Ar]=null}var or=null,rr=null,dt=!1,Jr=null;function C_(n,e){var t=Tr(5,null,null,0);t.elementType="DELETED",t.stateNode=e,t.return=n,e=n.deletions,e===null?(n.deletions=[t],n.flags|=16):e.push(t)}function J8(n,e){switch(n.tag){case 5:var t=n.type;return e=e.nodeType!==1||t.toLowerCase()!==e.nodeName.toLowerCase()?null:e,e!==null?(n.stateNode=e,or=n,rr=wo(e.firstChild),!0):!1;case 6:return e=n.pendingProps===""||e.nodeType!==3?null:e,e!==null?(n.stateNode=e,or=n,rr=null,!0):!1;case 13:return e=e.nodeType!==8?null:e,e!==null?(t=La!==null?{id:ms,overflow:ws}:null,n.memoizedState={dehydrated:e,treeContext:t,retryLane:1073741824},t=Tr(18,null,null,0),t.stateNode=e,t.return=n,n.child=t,or=n,rr=null,!0):!1;default:return!1}}function X3(n){return(n.mode&1)!==0&&(n.flags&128)===0}function J3(n){if(dt){var e=rr;if(e){var t=e;if(!J8(n,e)){if(X3(n))throw Error(q(418));e=wo(t.nextSibling);var r=or;e&&J8(n,e)?C_(r,t):(n.flags=n.flags&-4097|2,dt=!1,or=n)}}else{if(X3(n))throw Error(q(418));n.flags=n.flags&-4097|2,dt=!1,or=n}}}function Z8(n){for(n=n.return;n!==null&&n.tag!==5&&n.tag!==3&&n.tag!==13;)n=n.return;or=n}function kf(n){if(n!==or)return!1;if(!dt)return Z8(n),dt=!0,!1;var e;if((e=n.tag!==3)&&!(e=n.tag!==5)&&(e=n.type,e=e!=="head"&&e!=="body"&&!q3(n.type,n.memoizedProps)),e&&(e=rr)){if(X3(n))throw T_(),Error(q(418));for(;e;)C_(n,e),e=wo(e.nextSibling)}if(Z8(n),n.tag===13){if(n=n.memoizedState,n=n!==null?n.dehydrated:null,!n)throw Error(q(317));e:{for(n=n.nextSibling,e=0;n;){if(n.nodeType===8){var t=n.data;if(t==="/$"){if(e===0){rr=wo(n.nextSibling);break e}e--}else t!=="$"&&t!=="$!"&&t!=="$?"||e++}n=n.nextSibling}rr=null}}else rr=or?wo(n.stateNode.nextSibling):null;return!0}function T_(){for(var n=rr;n;)n=wo(n.nextSibling)}function _c(){rr=or=null,dt=!1}function wm(n){Jr===null?Jr=[n]:Jr.push(n)}var YP=Ps.ReactCurrentBatchConfig;function Vu(n,e,t){if(n=t.ref,n!==null&&typeof n!="function"&&typeof n!="object"){if(t._owner){if(t=t._owner,t){if(t.tag!==1)throw Error(q(309));var r=t.stateNode}if(!r)throw Error(q(147,n));var i=r,s=""+n;return e!==null&&e.ref!==null&&typeof e.ref=="function"&&e.ref._stringRef===s?e.ref:(e=function(o){var a=i.refs;o===null?delete a[s]:a[s]=o},e._stringRef=s,e)}if(typeof n!="string")throw Error(q(284));if(!t._owner)throw Error(q(290,n))}return n}function Rf(n,e){throw n=Object.prototype.toString.call(e),Error(q(31,n==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":n))}function e7(n){var e=n._init;return e(n._payload)}function N_(n){function e(m,E){if(n){var v=m.deletions;v===null?(m.deletions=[E],m.flags|=16):v.push(E)}}function t(m,E){if(!n)return null;for(;E!==null;)e(m,E),E=E.sibling;return null}function r(m,E){for(m=new Map;E!==null;)E.key!==null?m.set(E.key,E):m.set(E.index,E),E=E.sibling;return m}function i(m,E){return m=_o(m,E),m.index=0,m.sibling=null,m}function s(m,E,v){return m.index=v,n?(v=m.alternate,v!==null?(v=v.index,v<E?(m.flags|=2,E):v):(m.flags|=2,E)):(m.flags|=1048576,E)}function o(m){return n&&m.alternate===null&&(m.flags|=2),m}function a(m,E,v,b){return E===null||E.tag!==6?(E=Sg(v,m.mode,b),E.return=m,E):(E=i(E,v),E.return=m,E)}function l(m,E,v,b){var k=v.type;return k===_l?u(m,E,v.props.children,b,v.key):E!==null&&(E.elementType===k||typeof k=="object"&&k!==null&&k.$$typeof===Zs&&e7(k)===E.type)?(b=i(E,v.props),b.ref=Vu(m,E,v),b.return=m,b):(b=_1(v.type,v.key,v.props,null,m.mode,b),b.ref=Vu(m,E,v),b.return=m,b)}function c(m,E,v,b){return E===null||E.tag!==4||E.stateNode.containerInfo!==v.containerInfo||E.stateNode.implementation!==v.implementation?(E=xg(v,m.mode,b),E.return=m,E):(E=i(E,v.children||[]),E.return=m,E)}function u(m,E,v,b,k){return E===null||E.tag!==7?(E=Ca(v,m.mode,b,k),E.return=m,E):(E=i(E,v),E.return=m,E)}function d(m,E,v){if(typeof E=="string"&&E!==""||typeof E=="number")return E=Sg(""+E,m.mode,v),E.return=m,E;if(typeof E=="object"&&E!==null){switch(E.$$typeof){case gf:return v=_1(E.type,E.key,E.props,null,m.mode,v),v.ref=Vu(m,null,E),v.return=m,v;case bl:return E=xg(E,m.mode,v),E.return=m,E;case Zs:var b=E._init;return d(m,b(E._payload),v)}if(sd(E)||Mu(E))return E=Ca(E,m.mode,v,null),E.return=m,E;Rf(m,E)}return null}function f(m,E,v,b){var k=E!==null?E.key:null;if(typeof v=="string"&&v!==""||typeof v=="number")return k!==null?null:a(m,E,""+v,b);if(typeof v=="object"&&v!==null){switch(v.$$typeof){case gf:return v.key===k?l(m,E,v,b):null;case bl:return v.key===k?c(m,E,v,b):null;case Zs:return k=v._init,f(m,E,k(v._payload),b)}if(sd(v)||Mu(v))return k!==null?null:u(m,E,v,b,null);Rf(m,v)}return null}function p(m,E,v,b,k){if(typeof b=="string"&&b!==""||typeof b=="number")return m=m.get(v)||null,a(E,m,""+b,k);if(typeof b=="object"&&b!==null){switch(b.$$typeof){case gf:return m=m.get(b.key===null?v:b.key)||null,l(E,m,b,k);case bl:return m=m.get(b.key===null?v:b.key)||null,c(E,m,b,k);case Zs:var A=b._init;return p(m,E,v,A(b._payload),k)}if(sd(b)||Mu(b))return m=m.get(v)||null,u(E,m,b,k,null);Rf(E,b)}return null}function y(m,E,v,b){for(var k=null,A=null,T=E,P=E=0,_=null;T!==null&&P<v.length;P++){T.index>P?(_=T,T=null):_=T.sibling;var N=f(m,T,v[P],b);if(N===null){T===null&&(T=_);break}n&&T&&N.alternate===null&&e(m,T),E=s(N,E,P),A===null?k=N:A.sibling=N,A=N,T=_}if(P===v.length)return t(m,T),dt&&na(m,P),k;if(T===null){for(;P<v.length;P++)T=d(m,v[P],b),T!==null&&(E=s(T,E,P),A===null?k=T:A.sibling=T,A=T);return dt&&na(m,P),k}for(T=r(m,T);P<v.length;P++)_=p(T,m,P,v[P],b),_!==null&&(n&&_.alternate!==null&&T.delete(_.key===null?P:_.key),E=s(_,E,P),A===null?k=_:A.sibling=_,A=_);return n&&T.forEach(function(V){return e(m,V)}),dt&&na(m,P),k}function g(m,E,v,b){var k=Mu(v);if(typeof k!="function")throw Error(q(150));if(v=k.call(v),v==null)throw Error(q(151));for(var A=k=null,T=E,P=E=0,_=null,N=v.next();T!==null&&!N.done;P++,N=v.next()){T.index>P?(_=T,T=null):_=T.sibling;var V=f(m,T,N.value,b);if(V===null){T===null&&(T=_);break}n&&T&&V.alternate===null&&e(m,T),E=s(V,E,P),A===null?k=V:A.sibling=V,A=V,T=_}if(N.done)return t(m,T),dt&&na(m,P),k;if(T===null){for(;!N.done;P++,N=v.next())N=d(m,N.value,b),N!==null&&(E=s(N,E,P),A===null?k=N:A.sibling=N,A=N);return dt&&na(m,P),k}for(T=r(m,T);!N.done;P++,N=v.next())N=p(T,m,P,N.value,b),N!==null&&(n&&N.alternate!==null&&T.delete(N.key===null?P:N.key),E=s(N,E,P),A===null?k=N:A.sibling=N,A=N);return n&&T.forEach(function(z){return e(m,z)}),dt&&na(m,P),k}function w(m,E,v,b){if(typeof v=="object"&&v!==null&&v.type===_l&&v.key===null&&(v=v.props.children),typeof v=="object"&&v!==null){switch(v.$$typeof){case gf:e:{for(var k=v.key,A=E;A!==null;){if(A.key===k){if(k=v.type,k===_l){if(A.tag===7){t(m,A.sibling),E=i(A,v.props.children),E.return=m,m=E;break e}}else if(A.elementType===k||typeof k=="object"&&k!==null&&k.$$typeof===Zs&&e7(k)===A.type){t(m,A.sibling),E=i(A,v.props),E.ref=Vu(m,A,v),E.return=m,m=E;break e}t(m,A);break}else e(m,A);A=A.sibling}v.type===_l?(E=Ca(v.props.children,m.mode,b,v.key),E.return=m,m=E):(b=_1(v.type,v.key,v.props,null,m.mode,b),b.ref=Vu(m,E,v),b.return=m,m=b)}return o(m);case bl:e:{for(A=v.key;E!==null;){if(E.key===A)if(E.tag===4&&E.stateNode.containerInfo===v.containerInfo&&E.stateNode.implementation===v.implementation){t(m,E.sibling),E=i(E,v.children||[]),E.return=m,m=E;break e}else{t(m,E);break}else e(m,E);E=E.sibling}E=xg(v,m.mode,b),E.return=m,m=E}return o(m);case Zs:return A=v._init,w(m,E,A(v._payload),b)}if(sd(v))return y(m,E,v,b);if(Mu(v))return g(m,E,v,b);Rf(m,v)}return typeof v=="string"&&v!==""||typeof v=="number"?(v=""+v,E!==null&&E.tag===6?(t(m,E.sibling),E=i(E,v),E.return=m,m=E):(t(m,E),E=Sg(v,m.mode,b),E.return=m,m=E),o(m)):t(m,E)}return w}var Sc=N_(!0),D_=N_(!1),c0=Vo(null),u0=null,Tl=null,vm=null;function Em(){vm=Tl=u0=null}function bm(n){var e=c0.current;lt(c0),n._currentValue=e}function Z3(n,e,t){for(;n!==null;){var r=n.alternate;if((n.childLanes&e)!==e?(n.childLanes|=e,r!==null&&(r.childLanes|=e)):r!==null&&(r.childLanes&e)!==e&&(r.childLanes|=e),n===t)break;n=n.return}}function Jl(n,e){u0=n,vm=Tl=null,n=n.dependencies,n!==null&&n.firstContext!==null&&(n.lanes&e&&(Kn=!0),n.firstContext=null)}function Lr(n){var e=n._currentValue;if(vm!==n)if(n={context:n,memoizedValue:e,next:null},Tl===null){if(u0===null)throw Error(q(308));Tl=n,u0.dependencies={lanes:0,firstContext:n}}else Tl=Tl.next=n;return e}var da=null;function _m(n){da===null?da=[n]:da.push(n)}function P_(n,e,t,r){var i=e.interleaved;return i===null?(t.next=t,_m(e)):(t.next=i.next,i.next=t),e.interleaved=t,Is(n,r)}function Is(n,e){n.lanes|=e;var t=n.alternate;for(t!==null&&(t.lanes|=e),t=n,n=n.return;n!==null;)n.childLanes|=e,t=n.alternate,t!==null&&(t.childLanes|=e),t=n,n=n.return;return t.tag===3?t.stateNode:null}var eo=!1;function Sm(n){n.updateQueue={baseState:n.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function O_(n,e){n=n.updateQueue,e.updateQueue===n&&(e.updateQueue={baseState:n.baseState,firstBaseUpdate:n.firstBaseUpdate,lastBaseUpdate:n.lastBaseUpdate,shared:n.shared,effects:n.effects})}function Es(n,e){return{eventTime:n,lane:e,tag:0,payload:null,callback:null,next:null}}function vo(n,e,t){var r=n.updateQueue;if(r===null)return null;if(r=r.shared,Me&2){var i=r.pending;return i===null?e.next=e:(e.next=i.next,i.next=e),r.pending=e,Is(n,t)}return i=r.interleaved,i===null?(e.next=e,_m(r)):(e.next=i.next,i.next=e),r.interleaved=e,Is(n,t)}function y1(n,e,t){if(e=e.updateQueue,e!==null&&(e=e.shared,(t&4194240)!==0)){var r=e.lanes;r&=n.pendingLanes,t|=r,e.lanes=t,lm(n,t)}}function t7(n,e){var t=n.updateQueue,r=n.alternate;if(r!==null&&(r=r.updateQueue,t===r)){var i=null,s=null;if(t=t.firstBaseUpdate,t!==null){do{var o={eventTime:t.eventTime,lane:t.lane,tag:t.tag,payload:t.payload,callback:t.callback,next:null};s===null?i=s=o:s=s.next=o,t=t.next}while(t!==null);s===null?i=s=e:s=s.next=e}else i=s=e;t={baseState:r.baseState,firstBaseUpdate:i,lastBaseUpdate:s,shared:r.shared,effects:r.effects},n.updateQueue=t;return}n=t.lastBaseUpdate,n===null?t.firstBaseUpdate=e:n.next=e,t.lastBaseUpdate=e}function d0(n,e,t,r){var i=n.updateQueue;eo=!1;var s=i.firstBaseUpdate,o=i.lastBaseUpdate,a=i.shared.pending;if(a!==null){i.shared.pending=null;var l=a,c=l.next;l.next=null,o===null?s=c:o.next=c,o=l;var u=n.alternate;u!==null&&(u=u.updateQueue,a=u.lastBaseUpdate,a!==o&&(a===null?u.firstBaseUpdate=c:a.next=c,u.lastBaseUpdate=l))}if(s!==null){var d=i.baseState;o=0,u=c=l=null,a=s;do{var f=a.lane,p=a.eventTime;if((r&f)===f){u!==null&&(u=u.next={eventTime:p,lane:0,tag:a.tag,payload:a.payload,callback:a.callback,next:null});e:{var y=n,g=a;switch(f=e,p=t,g.tag){case 1:if(y=g.payload,typeof y=="function"){d=y.call(p,d,f);break e}d=y;break e;case 3:y.flags=y.flags&-65537|128;case 0:if(y=g.payload,f=typeof y=="function"?y.call(p,d,f):y,f==null)break e;d=mt({},d,f);break e;case 2:eo=!0}}a.callback!==null&&a.lane!==0&&(n.flags|=64,f=i.effects,f===null?i.effects=[a]:f.push(a))}else p={eventTime:p,lane:f,tag:a.tag,payload:a.payload,callback:a.callback,next:null},u===null?(c=u=p,l=d):u=u.next=p,o|=f;if(a=a.next,a===null){if(a=i.shared.pending,a===null)break;f=a,a=f.next,f.next=null,i.lastBaseUpdate=f,i.shared.pending=null}}while(!0);if(u===null&&(l=d),i.baseState=l,i.firstBaseUpdate=c,i.lastBaseUpdate=u,e=i.shared.interleaved,e!==null){i=e;do o|=i.lane,i=i.next;while(i!==e)}else s===null&&(i.shared.lanes=0);Ma|=o,n.lanes=o,n.memoizedState=d}}function n7(n,e,t){if(n=e.effects,e.effects=null,n!==null)for(e=0;e<n.length;e++){var r=n[e],i=r.callback;if(i!==null){if(r.callback=null,r=t,typeof i!="function")throw Error(q(191,i));i.call(r)}}}var Vh={},$i=Vo(Vh),Yd=Vo(Vh),Qd=Vo(Vh);function ha(n){if(n===Vh)throw Error(q(174));return n}function xm(n,e){switch(tt(Qd,e),tt(Yd,n),tt($i,Vh),n=e.nodeType,n){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:P3(null,"");break;default:n=n===8?e.parentNode:e,e=n.namespaceURI||null,n=n.tagName,e=P3(e,n)}lt($i),tt($i,e)}function xc(){lt($i),lt(Yd),lt(Qd)}function L_(n){ha(Qd.current);var e=ha($i.current),t=P3(e,n.type);e!==t&&(tt(Yd,n),tt($i,t))}function km(n){Yd.current===n&&(lt($i),lt(Yd))}var gt=Vo(0);function h0(n){for(var e=n;e!==null;){if(e.tag===13){var t=e.memoizedState;if(t!==null&&(t=t.dehydrated,t===null||t.data==="$?"||t.data==="$!"))return e}else if(e.tag===19&&e.memoizedProps.revealOrder!==void 0){if(e.flags&128)return e}else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===n)break;for(;e.sibling===null;){if(e.return===null||e.return===n)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var mg=[];function Rm(){for(var n=0;n<mg.length;n++)mg[n]._workInProgressVersionPrimary=null;mg.length=0}var m1=Ps.ReactCurrentDispatcher,wg=Ps.ReactCurrentBatchConfig,Ba=0,yt=null,Bt=null,Vt=null,f0=!1,Sd=!1,Xd=0,QP=0;function on(){throw Error(q(321))}function Am(n,e){if(e===null)return!1;for(var t=0;t<e.length&&t<n.length;t++)if(!li(n[t],e[t]))return!1;return!0}function Im(n,e,t,r,i,s){if(Ba=s,yt=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,m1.current=n===null||n.memoizedState===null?eO:tO,n=t(r,i),Sd){s=0;do{if(Sd=!1,Xd=0,25<=s)throw Error(q(301));s+=1,Vt=Bt=null,e.updateQueue=null,m1.current=nO,n=t(r,i)}while(Sd)}if(m1.current=p0,e=Bt!==null&&Bt.next!==null,Ba=0,Vt=Bt=yt=null,f0=!1,e)throw Error(q(300));return n}function Cm(){var n=Xd!==0;return Xd=0,n}function Ei(){var n={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Vt===null?yt.memoizedState=Vt=n:Vt=Vt.next=n,Vt}function Br(){if(Bt===null){var n=yt.alternate;n=n!==null?n.memoizedState:null}else n=Bt.next;var e=Vt===null?yt.memoizedState:Vt.next;if(e!==null)Vt=e,Bt=n;else{if(n===null)throw Error(q(310));Bt=n,n={memoizedState:Bt.memoizedState,baseState:Bt.baseState,baseQueue:Bt.baseQueue,queue:Bt.queue,next:null},Vt===null?yt.memoizedState=Vt=n:Vt=Vt.next=n}return Vt}function Jd(n,e){return typeof e=="function"?e(n):e}function vg(n){var e=Br(),t=e.queue;if(t===null)throw Error(q(311));t.lastRenderedReducer=n;var r=Bt,i=r.baseQueue,s=t.pending;if(s!==null){if(i!==null){var o=i.next;i.next=s.next,s.next=o}r.baseQueue=i=s,t.pending=null}if(i!==null){s=i.next,r=r.baseState;var a=o=null,l=null,c=s;do{var u=c.lane;if((Ba&u)===u)l!==null&&(l=l.next={lane:0,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null}),r=c.hasEagerState?c.eagerState:n(r,c.action);else{var d={lane:u,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null};l===null?(a=l=d,o=r):l=l.next=d,yt.lanes|=u,Ma|=u}c=c.next}while(c!==null&&c!==s);l===null?o=r:l.next=a,li(r,e.memoizedState)||(Kn=!0),e.memoizedState=r,e.baseState=o,e.baseQueue=l,t.lastRenderedState=r}if(n=t.interleaved,n!==null){i=n;do s=i.lane,yt.lanes|=s,Ma|=s,i=i.next;while(i!==n)}else i===null&&(t.lanes=0);return[e.memoizedState,t.dispatch]}function Eg(n){var e=Br(),t=e.queue;if(t===null)throw Error(q(311));t.lastRenderedReducer=n;var r=t.dispatch,i=t.pending,s=e.memoizedState;if(i!==null){t.pending=null;var o=i=i.next;do s=n(s,o.action),o=o.next;while(o!==i);li(s,e.memoizedState)||(Kn=!0),e.memoizedState=s,e.baseQueue===null&&(e.baseState=s),t.lastRenderedState=s}return[s,r]}function B_(){}function M_(n,e){var t=yt,r=Br(),i=e(),s=!li(r.memoizedState,i);if(s&&(r.memoizedState=i,Kn=!0),r=r.queue,Tm(F_.bind(null,t,r,n),[n]),r.getSnapshot!==e||s||Vt!==null&&Vt.memoizedState.tag&1){if(t.flags|=2048,Zd(9,U_.bind(null,t,r,i,e),void 0,null),Ht===null)throw Error(q(349));Ba&30||$_(t,e,i)}return i}function $_(n,e,t){n.flags|=16384,n={getSnapshot:e,value:t},e=yt.updateQueue,e===null?(e={lastEffect:null,stores:null},yt.updateQueue=e,e.stores=[n]):(t=e.stores,t===null?e.stores=[n]:t.push(n))}function U_(n,e,t,r){e.value=t,e.getSnapshot=r,z_(e)&&V_(n)}function F_(n,e,t){return t(function(){z_(e)&&V_(n)})}function z_(n){var e=n.getSnapshot;n=n.value;try{var t=e();return!li(n,t)}catch{return!0}}function V_(n){var e=Is(n,1);e!==null&&ri(e,n,1,-1)}function r7(n){var e=Ei();return typeof n=="function"&&(n=n()),e.memoizedState=e.baseState=n,n={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Jd,lastRenderedState:n},e.queue=n,n=n.dispatch=ZP.bind(null,yt,n),[e.memoizedState,n]}function Zd(n,e,t,r){return n={tag:n,create:e,destroy:t,deps:r,next:null},e=yt.updateQueue,e===null?(e={lastEffect:null,stores:null},yt.updateQueue=e,e.lastEffect=n.next=n):(t=e.lastEffect,t===null?e.lastEffect=n.next=n:(r=t.next,t.next=n,n.next=r,e.lastEffect=n)),n}function H_(){return Br().memoizedState}function w1(n,e,t,r){var i=Ei();yt.flags|=n,i.memoizedState=Zd(1|e,t,void 0,r===void 0?null:r)}function K2(n,e,t,r){var i=Br();r=r===void 0?null:r;var s=void 0;if(Bt!==null){var o=Bt.memoizedState;if(s=o.destroy,r!==null&&Am(r,o.deps)){i.memoizedState=Zd(e,t,s,r);return}}yt.flags|=n,i.memoizedState=Zd(1|e,t,s,r)}function i7(n,e){return w1(8390656,8,n,e)}function Tm(n,e){return K2(2048,8,n,e)}function K_(n,e){return K2(4,2,n,e)}function W_(n,e){return K2(4,4,n,e)}function G_(n,e){if(typeof e=="function")return n=n(),e(n),function(){e(null)};if(e!=null)return n=n(),e.current=n,function(){e.current=null}}function q_(n,e,t){return t=t!=null?t.concat([n]):null,K2(4,4,G_.bind(null,e,n),t)}function Nm(){}function j_(n,e){var t=Br();e=e===void 0?null:e;var r=t.memoizedState;return r!==null&&e!==null&&Am(e,r[1])?r[0]:(t.memoizedState=[n,e],n)}function Y_(n,e){var t=Br();e=e===void 0?null:e;var r=t.memoizedState;return r!==null&&e!==null&&Am(e,r[1])?r[0]:(n=n(),t.memoizedState=[n,e],n)}function Q_(n,e,t){return Ba&21?(li(t,e)||(t=t_(),yt.lanes|=t,Ma|=t,n.baseState=!0),e):(n.baseState&&(n.baseState=!1,Kn=!0),n.memoizedState=t)}function XP(n,e){var t=Ye;Ye=t!==0&&4>t?t:4,n(!0);var r=wg.transition;wg.transition={};try{n(!1),e()}finally{Ye=t,wg.transition=r}}function X_(){return Br().memoizedState}function JP(n,e,t){var r=bo(n);if(t={lane:r,action:t,hasEagerState:!1,eagerState:null,next:null},J_(n))Z_(e,t);else if(t=P_(n,e,t,r),t!==null){var i=Nn();ri(t,n,r,i),eS(t,e,r)}}function ZP(n,e,t){var r=bo(n),i={lane:r,action:t,hasEagerState:!1,eagerState:null,next:null};if(J_(n))Z_(e,i);else{var s=n.alternate;if(n.lanes===0&&(s===null||s.lanes===0)&&(s=e.lastRenderedReducer,s!==null))try{var o=e.lastRenderedState,a=s(o,t);if(i.hasEagerState=!0,i.eagerState=a,li(a,o)){var l=e.interleaved;l===null?(i.next=i,_m(e)):(i.next=l.next,l.next=i),e.interleaved=i;return}}catch{}finally{}t=P_(n,e,i,r),t!==null&&(i=Nn(),ri(t,n,r,i),eS(t,e,r))}}function J_(n){var e=n.alternate;return n===yt||e!==null&&e===yt}function Z_(n,e){Sd=f0=!0;var t=n.pending;t===null?e.next=e:(e.next=t.next,t.next=e),n.pending=e}function eS(n,e,t){if(t&4194240){var r=e.lanes;r&=n.pendingLanes,t|=r,e.lanes=t,lm(n,t)}}var p0={readContext:Lr,useCallback:on,useContext:on,useEffect:on,useImperativeHandle:on,useInsertionEffect:on,useLayoutEffect:on,useMemo:on,useReducer:on,useRef:on,useState:on,useDebugValue:on,useDeferredValue:on,useTransition:on,useMutableSource:on,useSyncExternalStore:on,useId:on,unstable_isNewReconciler:!1},eO={readContext:Lr,useCallback:function(n,e){return Ei().memoizedState=[n,e===void 0?null:e],n},useContext:Lr,useEffect:i7,useImperativeHandle:function(n,e,t){return t=t!=null?t.concat([n]):null,w1(4194308,4,G_.bind(null,e,n),t)},useLayoutEffect:function(n,e){return w1(4194308,4,n,e)},useInsertionEffect:function(n,e){return w1(4,2,n,e)},useMemo:function(n,e){var t=Ei();return e=e===void 0?null:e,n=n(),t.memoizedState=[n,e],n},useReducer:function(n,e,t){var r=Ei();return e=t!==void 0?t(e):e,r.memoizedState=r.baseState=e,n={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:n,lastRenderedState:e},r.queue=n,n=n.dispatch=JP.bind(null,yt,n),[r.memoizedState,n]},useRef:function(n){var e=Ei();return n={current:n},e.memoizedState=n},useState:r7,useDebugValue:Nm,useDeferredValue:function(n){return Ei().memoizedState=n},useTransition:function(){var n=r7(!1),e=n[0];return n=XP.bind(null,n[1]),Ei().memoizedState=n,[e,n]},useMutableSource:function(){},useSyncExternalStore:function(n,e,t){var r=yt,i=Ei();if(dt){if(t===void 0)throw Error(q(407));t=t()}else{if(t=e(),Ht===null)throw Error(q(349));Ba&30||$_(r,e,t)}i.memoizedState=t;var s={value:t,getSnapshot:e};return i.queue=s,i7(F_.bind(null,r,s,n),[n]),r.flags|=2048,Zd(9,U_.bind(null,r,s,t,e),void 0,null),t},useId:function(){var n=Ei(),e=Ht.identifierPrefix;if(dt){var t=ws,r=ms;t=(r&~(1<<32-ni(r)-1)).toString(32)+t,e=":"+e+"R"+t,t=Xd++,0<t&&(e+="H"+t.toString(32)),e+=":"}else t=QP++,e=":"+e+"r"+t.toString(32)+":";return n.memoizedState=e},unstable_isNewReconciler:!1},tO={readContext:Lr,useCallback:j_,useContext:Lr,useEffect:Tm,useImperativeHandle:q_,useInsertionEffect:K_,useLayoutEffect:W_,useMemo:Y_,useReducer:vg,useRef:H_,useState:function(){return vg(Jd)},useDebugValue:Nm,useDeferredValue:function(n){var e=Br();return Q_(e,Bt.memoizedState,n)},useTransition:function(){var n=vg(Jd)[0],e=Br().memoizedState;return[n,e]},useMutableSource:B_,useSyncExternalStore:M_,useId:X_,unstable_isNewReconciler:!1},nO={readContext:Lr,useCallback:j_,useContext:Lr,useEffect:Tm,useImperativeHandle:q_,useInsertionEffect:K_,useLayoutEffect:W_,useMemo:Y_,useReducer:Eg,useRef:H_,useState:function(){return Eg(Jd)},useDebugValue:Nm,useDeferredValue:function(n){var e=Br();return Bt===null?e.memoizedState=n:Q_(e,Bt.memoizedState,n)},useTransition:function(){var n=Eg(Jd)[0],e=Br().memoizedState;return[n,e]},useMutableSource:B_,useSyncExternalStore:M_,useId:X_,unstable_isNewReconciler:!1};function Wr(n,e){if(n&&n.defaultProps){e=mt({},e),n=n.defaultProps;for(var t in n)e[t]===void 0&&(e[t]=n[t]);return e}return e}function e4(n,e,t,r){e=n.memoizedState,t=t(r,e),t=t==null?e:mt({},e,t),n.memoizedState=t,n.lanes===0&&(n.updateQueue.baseState=t)}var W2={isMounted:function(n){return(n=n._reactInternals)?Xa(n)===n:!1},enqueueSetState:function(n,e,t){n=n._reactInternals;var r=Nn(),i=bo(n),s=Es(r,i);s.payload=e,t!=null&&(s.callback=t),e=vo(n,s,i),e!==null&&(ri(e,n,i,r),y1(e,n,i))},enqueueReplaceState:function(n,e,t){n=n._reactInternals;var r=Nn(),i=bo(n),s=Es(r,i);s.tag=1,s.payload=e,t!=null&&(s.callback=t),e=vo(n,s,i),e!==null&&(ri(e,n,i,r),y1(e,n,i))},enqueueForceUpdate:function(n,e){n=n._reactInternals;var t=Nn(),r=bo(n),i=Es(t,r);i.tag=2,e!=null&&(i.callback=e),e=vo(n,i,r),e!==null&&(ri(e,n,r,t),y1(e,n,r))}};function s7(n,e,t,r,i,s,o){return n=n.stateNode,typeof n.shouldComponentUpdate=="function"?n.shouldComponentUpdate(r,s,o):e.prototype&&e.prototype.isPureReactComponent?!Wd(t,r)||!Wd(i,s):!0}function tS(n,e,t){var r=!1,i=Co,s=e.contextType;return typeof s=="object"&&s!==null?s=Lr(s):(i=qn(e)?Oa:wn.current,r=e.contextTypes,s=(r=r!=null)?bc(n,i):Co),e=new e(t,s),n.memoizedState=e.state!==null&&e.state!==void 0?e.state:null,e.updater=W2,n.stateNode=e,e._reactInternals=n,r&&(n=n.stateNode,n.__reactInternalMemoizedUnmaskedChildContext=i,n.__reactInternalMemoizedMaskedChildContext=s),e}function o7(n,e,t,r){n=e.state,typeof e.componentWillReceiveProps=="function"&&e.componentWillReceiveProps(t,r),typeof e.UNSAFE_componentWillReceiveProps=="function"&&e.UNSAFE_componentWillReceiveProps(t,r),e.state!==n&&W2.enqueueReplaceState(e,e.state,null)}function t4(n,e,t,r){var i=n.stateNode;i.props=t,i.state=n.memoizedState,i.refs={},Sm(n);var s=e.contextType;typeof s=="object"&&s!==null?i.context=Lr(s):(s=qn(e)?Oa:wn.current,i.context=bc(n,s)),i.state=n.memoizedState,s=e.getDerivedStateFromProps,typeof s=="function"&&(e4(n,e,s,t),i.state=n.memoizedState),typeof e.getDerivedStateFromProps=="function"||typeof i.getSnapshotBeforeUpdate=="function"||typeof i.UNSAFE_componentWillMount!="function"&&typeof i.componentWillMount!="function"||(e=i.state,typeof i.componentWillMount=="function"&&i.componentWillMount(),typeof i.UNSAFE_componentWillMount=="function"&&i.UNSAFE_componentWillMount(),e!==i.state&&W2.enqueueReplaceState(i,i.state,null),d0(n,t,i,r),i.state=n.memoizedState),typeof i.componentDidMount=="function"&&(n.flags|=4194308)}function kc(n,e){try{var t="",r=e;do t+=TD(r),r=r.return;while(r);var i=t}catch(s){i=`
Error generating stack: `+s.message+`
`+s.stack}return{value:n,source:e,stack:i,digest:null}}function bg(n,e,t){return{value:n,source:null,stack:t??null,digest:e??null}}function n4(n,e){try{console.error(e.value)}catch(t){setTimeout(function(){throw t})}}var rO=typeof WeakMap=="function"?WeakMap:Map;function nS(n,e,t){t=Es(-1,t),t.tag=3,t.payload={element:null};var r=e.value;return t.callback=function(){y0||(y0=!0,h4=r),n4(n,e)},t}function rS(n,e,t){t=Es(-1,t),t.tag=3;var r=n.type.getDerivedStateFromError;if(typeof r=="function"){var i=e.value;t.payload=function(){return r(i)},t.callback=function(){n4(n,e)}}var s=n.stateNode;return s!==null&&typeof s.componentDidCatch=="function"&&(t.callback=function(){n4(n,e),typeof r!="function"&&(Eo===null?Eo=new Set([this]):Eo.add(this));var o=e.stack;this.componentDidCatch(e.value,{componentStack:o!==null?o:""})}),t}function a7(n,e,t){var r=n.pingCache;if(r===null){r=n.pingCache=new rO;var i=new Set;r.set(e,i)}else i=r.get(e),i===void 0&&(i=new Set,r.set(e,i));i.has(t)||(i.add(t),n=mO.bind(null,n,e,t),e.then(n,n))}function l7(n){do{var e;if((e=n.tag===13)&&(e=n.memoizedState,e=e!==null?e.dehydrated!==null:!0),e)return n;n=n.return}while(n!==null);return null}function c7(n,e,t,r,i){return n.mode&1?(n.flags|=65536,n.lanes=i,n):(n===e?n.flags|=65536:(n.flags|=128,t.flags|=131072,t.flags&=-52805,t.tag===1&&(t.alternate===null?t.tag=17:(e=Es(-1,1),e.tag=2,vo(t,e,1))),t.lanes|=1),n)}var iO=Ps.ReactCurrentOwner,Kn=!1;function An(n,e,t,r){e.child=n===null?D_(e,null,t,r):Sc(e,n.child,t,r)}function u7(n,e,t,r,i){t=t.render;var s=e.ref;return Jl(e,i),r=Im(n,e,t,r,s,i),t=Cm(),n!==null&&!Kn?(e.updateQueue=n.updateQueue,e.flags&=-2053,n.lanes&=~i,Cs(n,e,i)):(dt&&t&&ym(e),e.flags|=1,An(n,e,r,i),e.child)}function d7(n,e,t,r,i){if(n===null){var s=t.type;return typeof s=="function"&&!Um(s)&&s.defaultProps===void 0&&t.compare===null&&t.defaultProps===void 0?(e.tag=15,e.type=s,iS(n,e,s,r,i)):(n=_1(t.type,null,r,e,e.mode,i),n.ref=e.ref,n.return=e,e.child=n)}if(s=n.child,!(n.lanes&i)){var o=s.memoizedProps;if(t=t.compare,t=t!==null?t:Wd,t(o,r)&&n.ref===e.ref)return Cs(n,e,i)}return e.flags|=1,n=_o(s,r),n.ref=e.ref,n.return=e,e.child=n}function iS(n,e,t,r,i){if(n!==null){var s=n.memoizedProps;if(Wd(s,r)&&n.ref===e.ref)if(Kn=!1,e.pendingProps=r=s,(n.lanes&i)!==0)n.flags&131072&&(Kn=!0);else return e.lanes=n.lanes,Cs(n,e,i)}return r4(n,e,t,r,i)}function sS(n,e,t){var r=e.pendingProps,i=r.children,s=n!==null?n.memoizedState:null;if(r.mode==="hidden")if(!(e.mode&1))e.memoizedState={baseLanes:0,cachePool:null,transitions:null},tt(Dl,Zn),Zn|=t;else{if(!(t&1073741824))return n=s!==null?s.baseLanes|t:t,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:n,cachePool:null,transitions:null},e.updateQueue=null,tt(Dl,Zn),Zn|=n,null;e.memoizedState={baseLanes:0,cachePool:null,transitions:null},r=s!==null?s.baseLanes:t,tt(Dl,Zn),Zn|=r}else s!==null?(r=s.baseLanes|t,e.memoizedState=null):r=t,tt(Dl,Zn),Zn|=r;return An(n,e,i,t),e.child}function oS(n,e){var t=e.ref;(n===null&&t!==null||n!==null&&n.ref!==t)&&(e.flags|=512,e.flags|=2097152)}function r4(n,e,t,r,i){var s=qn(t)?Oa:wn.current;return s=bc(e,s),Jl(e,i),t=Im(n,e,t,r,s,i),r=Cm(),n!==null&&!Kn?(e.updateQueue=n.updateQueue,e.flags&=-2053,n.lanes&=~i,Cs(n,e,i)):(dt&&r&&ym(e),e.flags|=1,An(n,e,t,i),e.child)}function h7(n,e,t,r,i){if(qn(t)){var s=!0;o0(e)}else s=!1;if(Jl(e,i),e.stateNode===null)v1(n,e),tS(e,t,r),t4(e,t,r,i),r=!0;else if(n===null){var o=e.stateNode,a=e.memoizedProps;o.props=a;var l=o.context,c=t.contextType;typeof c=="object"&&c!==null?c=Lr(c):(c=qn(t)?Oa:wn.current,c=bc(e,c));var u=t.getDerivedStateFromProps,d=typeof u=="function"||typeof o.getSnapshotBeforeUpdate=="function";d||typeof o.UNSAFE_componentWillReceiveProps!="function"&&typeof o.componentWillReceiveProps!="function"||(a!==r||l!==c)&&o7(e,o,r,c),eo=!1;var f=e.memoizedState;o.state=f,d0(e,r,o,i),l=e.memoizedState,a!==r||f!==l||Gn.current||eo?(typeof u=="function"&&(e4(e,t,u,r),l=e.memoizedState),(a=eo||s7(e,t,a,r,f,l,c))?(d||typeof o.UNSAFE_componentWillMount!="function"&&typeof o.componentWillMount!="function"||(typeof o.componentWillMount=="function"&&o.componentWillMount(),typeof o.UNSAFE_componentWillMount=="function"&&o.UNSAFE_componentWillMount()),typeof o.componentDidMount=="function"&&(e.flags|=4194308)):(typeof o.componentDidMount=="function"&&(e.flags|=4194308),e.memoizedProps=r,e.memoizedState=l),o.props=r,o.state=l,o.context=c,r=a):(typeof o.componentDidMount=="function"&&(e.flags|=4194308),r=!1)}else{o=e.stateNode,O_(n,e),a=e.memoizedProps,c=e.type===e.elementType?a:Wr(e.type,a),o.props=c,d=e.pendingProps,f=o.context,l=t.contextType,typeof l=="object"&&l!==null?l=Lr(l):(l=qn(t)?Oa:wn.current,l=bc(e,l));var p=t.getDerivedStateFromProps;(u=typeof p=="function"||typeof o.getSnapshotBeforeUpdate=="function")||typeof o.UNSAFE_componentWillReceiveProps!="function"&&typeof o.componentWillReceiveProps!="function"||(a!==d||f!==l)&&o7(e,o,r,l),eo=!1,f=e.memoizedState,o.state=f,d0(e,r,o,i);var y=e.memoizedState;a!==d||f!==y||Gn.current||eo?(typeof p=="function"&&(e4(e,t,p,r),y=e.memoizedState),(c=eo||s7(e,t,c,r,f,y,l)||!1)?(u||typeof o.UNSAFE_componentWillUpdate!="function"&&typeof o.componentWillUpdate!="function"||(typeof o.componentWillUpdate=="function"&&o.componentWillUpdate(r,y,l),typeof o.UNSAFE_componentWillUpdate=="function"&&o.UNSAFE_componentWillUpdate(r,y,l)),typeof o.componentDidUpdate=="function"&&(e.flags|=4),typeof o.getSnapshotBeforeUpdate=="function"&&(e.flags|=1024)):(typeof o.componentDidUpdate!="function"||a===n.memoizedProps&&f===n.memoizedState||(e.flags|=4),typeof o.getSnapshotBeforeUpdate!="function"||a===n.memoizedProps&&f===n.memoizedState||(e.flags|=1024),e.memoizedProps=r,e.memoizedState=y),o.props=r,o.state=y,o.context=l,r=c):(typeof o.componentDidUpdate!="function"||a===n.memoizedProps&&f===n.memoizedState||(e.flags|=4),typeof o.getSnapshotBeforeUpdate!="function"||a===n.memoizedProps&&f===n.memoizedState||(e.flags|=1024),r=!1)}return i4(n,e,t,r,s,i)}function i4(n,e,t,r,i,s){oS(n,e);var o=(e.flags&128)!==0;if(!r&&!o)return i&&X8(e,t,!1),Cs(n,e,s);r=e.stateNode,iO.current=e;var a=o&&typeof t.getDerivedStateFromError!="function"?null:r.render();return e.flags|=1,n!==null&&o?(e.child=Sc(e,n.child,null,s),e.child=Sc(e,null,a,s)):An(n,e,a,s),e.memoizedState=r.state,i&&X8(e,t,!0),e.child}function aS(n){var e=n.stateNode;e.pendingContext?Q8(n,e.pendingContext,e.pendingContext!==e.context):e.context&&Q8(n,e.context,!1),xm(n,e.containerInfo)}function f7(n,e,t,r,i){return _c(),wm(i),e.flags|=256,An(n,e,t,r),e.child}var s4={dehydrated:null,treeContext:null,retryLane:0};function o4(n){return{baseLanes:n,cachePool:null,transitions:null}}function lS(n,e,t){var r=e.pendingProps,i=gt.current,s=!1,o=(e.flags&128)!==0,a;if((a=o)||(a=n!==null&&n.memoizedState===null?!1:(i&2)!==0),a?(s=!0,e.flags&=-129):(n===null||n.memoizedState!==null)&&(i|=1),tt(gt,i&1),n===null)return J3(e),n=e.memoizedState,n!==null&&(n=n.dehydrated,n!==null)?(e.mode&1?n.data==="$!"?e.lanes=8:e.lanes=1073741824:e.lanes=1,null):(o=r.children,n=r.fallback,s?(r=e.mode,s=e.child,o={mode:"hidden",children:o},!(r&1)&&s!==null?(s.childLanes=0,s.pendingProps=o):s=j2(o,r,0,null),n=Ca(n,r,t,null),s.return=e,n.return=e,s.sibling=n,e.child=s,e.child.memoizedState=o4(t),e.memoizedState=s4,n):Dm(e,o));if(i=n.memoizedState,i!==null&&(a=i.dehydrated,a!==null))return sO(n,e,o,r,a,i,t);if(s){s=r.fallback,o=e.mode,i=n.child,a=i.sibling;var l={mode:"hidden",children:r.children};return!(o&1)&&e.child!==i?(r=e.child,r.childLanes=0,r.pendingProps=l,e.deletions=null):(r=_o(i,l),r.subtreeFlags=i.subtreeFlags&14680064),a!==null?s=_o(a,s):(s=Ca(s,o,t,null),s.flags|=2),s.return=e,r.return=e,r.sibling=s,e.child=r,r=s,s=e.child,o=n.child.memoizedState,o=o===null?o4(t):{baseLanes:o.baseLanes|t,cachePool:null,transitions:o.transitions},s.memoizedState=o,s.childLanes=n.childLanes&~t,e.memoizedState=s4,r}return s=n.child,n=s.sibling,r=_o(s,{mode:"visible",children:r.children}),!(e.mode&1)&&(r.lanes=t),r.return=e,r.sibling=null,n!==null&&(t=e.deletions,t===null?(e.deletions=[n],e.flags|=16):t.push(n)),e.child=r,e.memoizedState=null,r}function Dm(n,e){return e=j2({mode:"visible",children:e},n.mode,0,null),e.return=n,n.child=e}function Af(n,e,t,r){return r!==null&&wm(r),Sc(e,n.child,null,t),n=Dm(e,e.pendingProps.children),n.flags|=2,e.memoizedState=null,n}function sO(n,e,t,r,i,s,o){if(t)return e.flags&256?(e.flags&=-257,r=bg(Error(q(422))),Af(n,e,o,r)):e.memoizedState!==null?(e.child=n.child,e.flags|=128,null):(s=r.fallback,i=e.mode,r=j2({mode:"visible",children:r.children},i,0,null),s=Ca(s,i,o,null),s.flags|=2,r.return=e,s.return=e,r.sibling=s,e.child=r,e.mode&1&&Sc(e,n.child,null,o),e.child.memoizedState=o4(o),e.memoizedState=s4,s);if(!(e.mode&1))return Af(n,e,o,null);if(i.data==="$!"){if(r=i.nextSibling&&i.nextSibling.dataset,r)var a=r.dgst;return r=a,s=Error(q(419)),r=bg(s,r,void 0),Af(n,e,o,r)}if(a=(o&n.childLanes)!==0,Kn||a){if(r=Ht,r!==null){switch(o&-o){case 4:i=2;break;case 16:i=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:i=32;break;case 536870912:i=268435456;break;default:i=0}i=i&(r.suspendedLanes|o)?0:i,i!==0&&i!==s.retryLane&&(s.retryLane=i,Is(n,i),ri(r,n,i,-1))}return $m(),r=bg(Error(q(421))),Af(n,e,o,r)}return i.data==="$?"?(e.flags|=128,e.child=n.child,e=wO.bind(null,n),i._reactRetry=e,null):(n=s.treeContext,rr=wo(i.nextSibling),or=e,dt=!0,Jr=null,n!==null&&(Rr[Ar++]=ms,Rr[Ar++]=ws,Rr[Ar++]=La,ms=n.id,ws=n.overflow,La=e),e=Dm(e,r.children),e.flags|=4096,e)}function p7(n,e,t){n.lanes|=e;var r=n.alternate;r!==null&&(r.lanes|=e),Z3(n.return,e,t)}function _g(n,e,t,r,i){var s=n.memoizedState;s===null?n.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:r,tail:t,tailMode:i}:(s.isBackwards=e,s.rendering=null,s.renderingStartTime=0,s.last=r,s.tail=t,s.tailMode=i)}function cS(n,e,t){var r=e.pendingProps,i=r.revealOrder,s=r.tail;if(An(n,e,r.children,t),r=gt.current,r&2)r=r&1|2,e.flags|=128;else{if(n!==null&&n.flags&128)e:for(n=e.child;n!==null;){if(n.tag===13)n.memoizedState!==null&&p7(n,t,e);else if(n.tag===19)p7(n,t,e);else if(n.child!==null){n.child.return=n,n=n.child;continue}if(n===e)break e;for(;n.sibling===null;){if(n.return===null||n.return===e)break e;n=n.return}n.sibling.return=n.return,n=n.sibling}r&=1}if(tt(gt,r),!(e.mode&1))e.memoizedState=null;else switch(i){case"forwards":for(t=e.child,i=null;t!==null;)n=t.alternate,n!==null&&h0(n)===null&&(i=t),t=t.sibling;t=i,t===null?(i=e.child,e.child=null):(i=t.sibling,t.sibling=null),_g(e,!1,i,t,s);break;case"backwards":for(t=null,i=e.child,e.child=null;i!==null;){if(n=i.alternate,n!==null&&h0(n)===null){e.child=i;break}n=i.sibling,i.sibling=t,t=i,i=n}_g(e,!0,t,null,s);break;case"together":_g(e,!1,null,null,void 0);break;default:e.memoizedState=null}return e.child}function v1(n,e){!(e.mode&1)&&n!==null&&(n.alternate=null,e.alternate=null,e.flags|=2)}function Cs(n,e,t){if(n!==null&&(e.dependencies=n.dependencies),Ma|=e.lanes,!(t&e.childLanes))return null;if(n!==null&&e.child!==n.child)throw Error(q(153));if(e.child!==null){for(n=e.child,t=_o(n,n.pendingProps),e.child=t,t.return=e;n.sibling!==null;)n=n.sibling,t=t.sibling=_o(n,n.pendingProps),t.return=e;t.sibling=null}return e.child}function oO(n,e,t){switch(e.tag){case 3:aS(e),_c();break;case 5:L_(e);break;case 1:qn(e.type)&&o0(e);break;case 4:xm(e,e.stateNode.containerInfo);break;case 10:var r=e.type._context,i=e.memoizedProps.value;tt(c0,r._currentValue),r._currentValue=i;break;case 13:if(r=e.memoizedState,r!==null)return r.dehydrated!==null?(tt(gt,gt.current&1),e.flags|=128,null):t&e.child.childLanes?lS(n,e,t):(tt(gt,gt.current&1),n=Cs(n,e,t),n!==null?n.sibling:null);tt(gt,gt.current&1);break;case 19:if(r=(t&e.childLanes)!==0,n.flags&128){if(r)return cS(n,e,t);e.flags|=128}if(i=e.memoizedState,i!==null&&(i.rendering=null,i.tail=null,i.lastEffect=null),tt(gt,gt.current),r)break;return null;case 22:case 23:return e.lanes=0,sS(n,e,t)}return Cs(n,e,t)}var uS,a4,dS,hS;uS=function(n,e){for(var t=e.child;t!==null;){if(t.tag===5||t.tag===6)n.appendChild(t.stateNode);else if(t.tag!==4&&t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return;t=t.return}t.sibling.return=t.return,t=t.sibling}};a4=function(){};dS=function(n,e,t,r){var i=n.memoizedProps;if(i!==r){n=e.stateNode,ha($i.current);var s=null;switch(t){case"input":i=C3(n,i),r=C3(n,r),s=[];break;case"select":i=mt({},i,{value:void 0}),r=mt({},r,{value:void 0}),s=[];break;case"textarea":i=D3(n,i),r=D3(n,r),s=[];break;default:typeof i.onClick!="function"&&typeof r.onClick=="function"&&(n.onclick=i0)}O3(t,r);var o;t=null;for(c in i)if(!r.hasOwnProperty(c)&&i.hasOwnProperty(c)&&i[c]!=null)if(c==="style"){var a=i[c];for(o in a)a.hasOwnProperty(o)&&(t||(t={}),t[o]="")}else c!=="dangerouslySetInnerHTML"&&c!=="children"&&c!=="suppressContentEditableWarning"&&c!=="suppressHydrationWarning"&&c!=="autoFocus"&&($d.hasOwnProperty(c)?s||(s=[]):(s=s||[]).push(c,null));for(c in r){var l=r[c];if(a=i!=null?i[c]:void 0,r.hasOwnProperty(c)&&l!==a&&(l!=null||a!=null))if(c==="style")if(a){for(o in a)!a.hasOwnProperty(o)||l&&l.hasOwnProperty(o)||(t||(t={}),t[o]="");for(o in l)l.hasOwnProperty(o)&&a[o]!==l[o]&&(t||(t={}),t[o]=l[o])}else t||(s||(s=[]),s.push(c,t)),t=l;else c==="dangerouslySetInnerHTML"?(l=l?l.__html:void 0,a=a?a.__html:void 0,l!=null&&a!==l&&(s=s||[]).push(c,l)):c==="children"?typeof l!="string"&&typeof l!="number"||(s=s||[]).push(c,""+l):c!=="suppressContentEditableWarning"&&c!=="suppressHydrationWarning"&&($d.hasOwnProperty(c)?(l!=null&&c==="onScroll"&&st("scroll",n),s||a===l||(s=[])):(s=s||[]).push(c,l))}t&&(s=s||[]).push("style",t);var c=s;(e.updateQueue=c)&&(e.flags|=4)}};hS=function(n,e,t,r){t!==r&&(e.flags|=4)};function Hu(n,e){if(!dt)switch(n.tailMode){case"hidden":e=n.tail;for(var t=null;e!==null;)e.alternate!==null&&(t=e),e=e.sibling;t===null?n.tail=null:t.sibling=null;break;case"collapsed":t=n.tail;for(var r=null;t!==null;)t.alternate!==null&&(r=t),t=t.sibling;r===null?e||n.tail===null?n.tail=null:n.tail.sibling=null:r.sibling=null}}function an(n){var e=n.alternate!==null&&n.alternate.child===n.child,t=0,r=0;if(e)for(var i=n.child;i!==null;)t|=i.lanes|i.childLanes,r|=i.subtreeFlags&14680064,r|=i.flags&14680064,i.return=n,i=i.sibling;else for(i=n.child;i!==null;)t|=i.lanes|i.childLanes,r|=i.subtreeFlags,r|=i.flags,i.return=n,i=i.sibling;return n.subtreeFlags|=r,n.childLanes=t,e}function aO(n,e,t){var r=e.pendingProps;switch(mm(e),e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return an(e),null;case 1:return qn(e.type)&&s0(),an(e),null;case 3:return r=e.stateNode,xc(),lt(Gn),lt(wn),Rm(),r.pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),(n===null||n.child===null)&&(kf(e)?e.flags|=4:n===null||n.memoizedState.isDehydrated&&!(e.flags&256)||(e.flags|=1024,Jr!==null&&(g4(Jr),Jr=null))),a4(n,e),an(e),null;case 5:km(e);var i=ha(Qd.current);if(t=e.type,n!==null&&e.stateNode!=null)dS(n,e,t,r,i),n.ref!==e.ref&&(e.flags|=512,e.flags|=2097152);else{if(!r){if(e.stateNode===null)throw Error(q(166));return an(e),null}if(n=ha($i.current),kf(e)){r=e.stateNode,t=e.type;var s=e.memoizedProps;switch(r[Oi]=e,r[jd]=s,n=(e.mode&1)!==0,t){case"dialog":st("cancel",r),st("close",r);break;case"iframe":case"object":case"embed":st("load",r);break;case"video":case"audio":for(i=0;i<ad.length;i++)st(ad[i],r);break;case"source":st("error",r);break;case"img":case"image":case"link":st("error",r),st("load",r);break;case"details":st("toggle",r);break;case"input":S8(r,s),st("invalid",r);break;case"select":r._wrapperState={wasMultiple:!!s.multiple},st("invalid",r);break;case"textarea":k8(r,s),st("invalid",r)}O3(t,s),i=null;for(var o in s)if(s.hasOwnProperty(o)){var a=s[o];o==="children"?typeof a=="string"?r.textContent!==a&&(s.suppressHydrationWarning!==!0&&xf(r.textContent,a,n),i=["children",a]):typeof a=="number"&&r.textContent!==""+a&&(s.suppressHydrationWarning!==!0&&xf(r.textContent,a,n),i=["children",""+a]):$d.hasOwnProperty(o)&&a!=null&&o==="onScroll"&&st("scroll",r)}switch(t){case"input":yf(r),x8(r,s,!0);break;case"textarea":yf(r),R8(r);break;case"select":case"option":break;default:typeof s.onClick=="function"&&(r.onclick=i0)}r=i,e.updateQueue=r,r!==null&&(e.flags|=4)}else{o=i.nodeType===9?i:i.ownerDocument,n==="http://www.w3.org/1999/xhtml"&&(n=Fb(t)),n==="http://www.w3.org/1999/xhtml"?t==="script"?(n=o.createElement("div"),n.innerHTML="<script><\/script>",n=n.removeChild(n.firstChild)):typeof r.is=="string"?n=o.createElement(t,{is:r.is}):(n=o.createElement(t),t==="select"&&(o=n,r.multiple?o.multiple=!0:r.size&&(o.size=r.size))):n=o.createElementNS(n,t),n[Oi]=e,n[jd]=r,uS(n,e,!1,!1),e.stateNode=n;e:{switch(o=L3(t,r),t){case"dialog":st("cancel",n),st("close",n),i=r;break;case"iframe":case"object":case"embed":st("load",n),i=r;break;case"video":case"audio":for(i=0;i<ad.length;i++)st(ad[i],n);i=r;break;case"source":st("error",n),i=r;break;case"img":case"image":case"link":st("error",n),st("load",n),i=r;break;case"details":st("toggle",n),i=r;break;case"input":S8(n,r),i=C3(n,r),st("invalid",n);break;case"option":i=r;break;case"select":n._wrapperState={wasMultiple:!!r.multiple},i=mt({},r,{value:void 0}),st("invalid",n);break;case"textarea":k8(n,r),i=D3(n,r),st("invalid",n);break;default:i=r}O3(t,i),a=i;for(s in a)if(a.hasOwnProperty(s)){var l=a[s];s==="style"?Hb(n,l):s==="dangerouslySetInnerHTML"?(l=l?l.__html:void 0,l!=null&&zb(n,l)):s==="children"?typeof l=="string"?(t!=="textarea"||l!=="")&&Ud(n,l):typeof l=="number"&&Ud(n,""+l):s!=="suppressContentEditableWarning"&&s!=="suppressHydrationWarning"&&s!=="autoFocus"&&($d.hasOwnProperty(s)?l!=null&&s==="onScroll"&&st("scroll",n):l!=null&&nm(n,s,l,o))}switch(t){case"input":yf(n),x8(n,r,!1);break;case"textarea":yf(n),R8(n);break;case"option":r.value!=null&&n.setAttribute("value",""+Io(r.value));break;case"select":n.multiple=!!r.multiple,s=r.value,s!=null?jl(n,!!r.multiple,s,!1):r.defaultValue!=null&&jl(n,!!r.multiple,r.defaultValue,!0);break;default:typeof i.onClick=="function"&&(n.onclick=i0)}switch(t){case"button":case"input":case"select":case"textarea":r=!!r.autoFocus;break e;case"img":r=!0;break e;default:r=!1}}r&&(e.flags|=4)}e.ref!==null&&(e.flags|=512,e.flags|=2097152)}return an(e),null;case 6:if(n&&e.stateNode!=null)hS(n,e,n.memoizedProps,r);else{if(typeof r!="string"&&e.stateNode===null)throw Error(q(166));if(t=ha(Qd.current),ha($i.current),kf(e)){if(r=e.stateNode,t=e.memoizedProps,r[Oi]=e,(s=r.nodeValue!==t)&&(n=or,n!==null))switch(n.tag){case 3:xf(r.nodeValue,t,(n.mode&1)!==0);break;case 5:n.memoizedProps.suppressHydrationWarning!==!0&&xf(r.nodeValue,t,(n.mode&1)!==0)}s&&(e.flags|=4)}else r=(t.nodeType===9?t:t.ownerDocument).createTextNode(r),r[Oi]=e,e.stateNode=r}return an(e),null;case 13:if(lt(gt),r=e.memoizedState,n===null||n.memoizedState!==null&&n.memoizedState.dehydrated!==null){if(dt&&rr!==null&&e.mode&1&&!(e.flags&128))T_(),_c(),e.flags|=98560,s=!1;else if(s=kf(e),r!==null&&r.dehydrated!==null){if(n===null){if(!s)throw Error(q(318));if(s=e.memoizedState,s=s!==null?s.dehydrated:null,!s)throw Error(q(317));s[Oi]=e}else _c(),!(e.flags&128)&&(e.memoizedState=null),e.flags|=4;an(e),s=!1}else Jr!==null&&(g4(Jr),Jr=null),s=!0;if(!s)return e.flags&65536?e:null}return e.flags&128?(e.lanes=t,e):(r=r!==null,r!==(n!==null&&n.memoizedState!==null)&&r&&(e.child.flags|=8192,e.mode&1&&(n===null||gt.current&1?$t===0&&($t=3):$m())),e.updateQueue!==null&&(e.flags|=4),an(e),null);case 4:return xc(),a4(n,e),n===null&&Gd(e.stateNode.containerInfo),an(e),null;case 10:return bm(e.type._context),an(e),null;case 17:return qn(e.type)&&s0(),an(e),null;case 19:if(lt(gt),s=e.memoizedState,s===null)return an(e),null;if(r=(e.flags&128)!==0,o=s.rendering,o===null)if(r)Hu(s,!1);else{if($t!==0||n!==null&&n.flags&128)for(n=e.child;n!==null;){if(o=h0(n),o!==null){for(e.flags|=128,Hu(s,!1),r=o.updateQueue,r!==null&&(e.updateQueue=r,e.flags|=4),e.subtreeFlags=0,r=t,t=e.child;t!==null;)s=t,n=r,s.flags&=14680066,o=s.alternate,o===null?(s.childLanes=0,s.lanes=n,s.child=null,s.subtreeFlags=0,s.memoizedProps=null,s.memoizedState=null,s.updateQueue=null,s.dependencies=null,s.stateNode=null):(s.childLanes=o.childLanes,s.lanes=o.lanes,s.child=o.child,s.subtreeFlags=0,s.deletions=null,s.memoizedProps=o.memoizedProps,s.memoizedState=o.memoizedState,s.updateQueue=o.updateQueue,s.type=o.type,n=o.dependencies,s.dependencies=n===null?null:{lanes:n.lanes,firstContext:n.firstContext}),t=t.sibling;return tt(gt,gt.current&1|2),e.child}n=n.sibling}s.tail!==null&&kt()>Rc&&(e.flags|=128,r=!0,Hu(s,!1),e.lanes=4194304)}else{if(!r)if(n=h0(o),n!==null){if(e.flags|=128,r=!0,t=n.updateQueue,t!==null&&(e.updateQueue=t,e.flags|=4),Hu(s,!0),s.tail===null&&s.tailMode==="hidden"&&!o.alternate&&!dt)return an(e),null}else 2*kt()-s.renderingStartTime>Rc&&t!==1073741824&&(e.flags|=128,r=!0,Hu(s,!1),e.lanes=4194304);s.isBackwards?(o.sibling=e.child,e.child=o):(t=s.last,t!==null?t.sibling=o:e.child=o,s.last=o)}return s.tail!==null?(e=s.tail,s.rendering=e,s.tail=e.sibling,s.renderingStartTime=kt(),e.sibling=null,t=gt.current,tt(gt,r?t&1|2:t&1),e):(an(e),null);case 22:case 23:return Mm(),r=e.memoizedState!==null,n!==null&&n.memoizedState!==null!==r&&(e.flags|=8192),r&&e.mode&1?Zn&1073741824&&(an(e),e.subtreeFlags&6&&(e.flags|=8192)):an(e),null;case 24:return null;case 25:return null}throw Error(q(156,e.tag))}function lO(n,e){switch(mm(e),e.tag){case 1:return qn(e.type)&&s0(),n=e.flags,n&65536?(e.flags=n&-65537|128,e):null;case 3:return xc(),lt(Gn),lt(wn),Rm(),n=e.flags,n&65536&&!(n&128)?(e.flags=n&-65537|128,e):null;case 5:return km(e),null;case 13:if(lt(gt),n=e.memoizedState,n!==null&&n.dehydrated!==null){if(e.alternate===null)throw Error(q(340));_c()}return n=e.flags,n&65536?(e.flags=n&-65537|128,e):null;case 19:return lt(gt),null;case 4:return xc(),null;case 10:return bm(e.type._context),null;case 22:case 23:return Mm(),null;case 24:return null;default:return null}}var If=!1,gn=!1,cO=typeof WeakSet=="function"?WeakSet:Set,oe=null;function Nl(n,e){var t=n.ref;if(t!==null)if(typeof t=="function")try{t(null)}catch(r){Et(n,e,r)}else t.current=null}function l4(n,e,t){try{t()}catch(r){Et(n,e,r)}}var g7=!1;function uO(n,e){if(W3=t0,n=m_(),gm(n)){if("selectionStart"in n)var t={start:n.selectionStart,end:n.selectionEnd};else e:{t=(t=n.ownerDocument)&&t.defaultView||window;var r=t.getSelection&&t.getSelection();if(r&&r.rangeCount!==0){t=r.anchorNode;var i=r.anchorOffset,s=r.focusNode;r=r.focusOffset;try{t.nodeType,s.nodeType}catch{t=null;break e}var o=0,a=-1,l=-1,c=0,u=0,d=n,f=null;t:for(;;){for(var p;d!==t||i!==0&&d.nodeType!==3||(a=o+i),d!==s||r!==0&&d.nodeType!==3||(l=o+r),d.nodeType===3&&(o+=d.nodeValue.length),(p=d.firstChild)!==null;)f=d,d=p;for(;;){if(d===n)break t;if(f===t&&++c===i&&(a=o),f===s&&++u===r&&(l=o),(p=d.nextSibling)!==null)break;d=f,f=d.parentNode}d=p}t=a===-1||l===-1?null:{start:a,end:l}}else t=null}t=t||{start:0,end:0}}else t=null;for(G3={focusedElem:n,selectionRange:t},t0=!1,oe=e;oe!==null;)if(e=oe,n=e.child,(e.subtreeFlags&1028)!==0&&n!==null)n.return=e,oe=n;else for(;oe!==null;){e=oe;try{var y=e.alternate;if(e.flags&1024)switch(e.tag){case 0:case 11:case 15:break;case 1:if(y!==null){var g=y.memoizedProps,w=y.memoizedState,m=e.stateNode,E=m.getSnapshotBeforeUpdate(e.elementType===e.type?g:Wr(e.type,g),w);m.__reactInternalSnapshotBeforeUpdate=E}break;case 3:var v=e.stateNode.containerInfo;v.nodeType===1?v.textContent="":v.nodeType===9&&v.documentElement&&v.removeChild(v.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(q(163))}}catch(b){Et(e,e.return,b)}if(n=e.sibling,n!==null){n.return=e.return,oe=n;break}oe=e.return}return y=g7,g7=!1,y}function xd(n,e,t){var r=e.updateQueue;if(r=r!==null?r.lastEffect:null,r!==null){var i=r=r.next;do{if((i.tag&n)===n){var s=i.destroy;i.destroy=void 0,s!==void 0&&l4(e,t,s)}i=i.next}while(i!==r)}}function G2(n,e){if(e=e.updateQueue,e=e!==null?e.lastEffect:null,e!==null){var t=e=e.next;do{if((t.tag&n)===n){var r=t.create;t.destroy=r()}t=t.next}while(t!==e)}}function c4(n){var e=n.ref;if(e!==null){var t=n.stateNode;switch(n.tag){case 5:n=t;break;default:n=t}typeof e=="function"?e(n):e.current=n}}function fS(n){var e=n.alternate;e!==null&&(n.alternate=null,fS(e)),n.child=null,n.deletions=null,n.sibling=null,n.tag===5&&(e=n.stateNode,e!==null&&(delete e[Oi],delete e[jd],delete e[Y3],delete e[GP],delete e[qP])),n.stateNode=null,n.return=null,n.dependencies=null,n.memoizedProps=null,n.memoizedState=null,n.pendingProps=null,n.stateNode=null,n.updateQueue=null}function pS(n){return n.tag===5||n.tag===3||n.tag===4}function y7(n){e:for(;;){for(;n.sibling===null;){if(n.return===null||pS(n.return))return null;n=n.return}for(n.sibling.return=n.return,n=n.sibling;n.tag!==5&&n.tag!==6&&n.tag!==18;){if(n.flags&2||n.child===null||n.tag===4)continue e;n.child.return=n,n=n.child}if(!(n.flags&2))return n.stateNode}}function u4(n,e,t){var r=n.tag;if(r===5||r===6)n=n.stateNode,e?t.nodeType===8?t.parentNode.insertBefore(n,e):t.insertBefore(n,e):(t.nodeType===8?(e=t.parentNode,e.insertBefore(n,t)):(e=t,e.appendChild(n)),t=t._reactRootContainer,t!=null||e.onclick!==null||(e.onclick=i0));else if(r!==4&&(n=n.child,n!==null))for(u4(n,e,t),n=n.sibling;n!==null;)u4(n,e,t),n=n.sibling}function d4(n,e,t){var r=n.tag;if(r===5||r===6)n=n.stateNode,e?t.insertBefore(n,e):t.appendChild(n);else if(r!==4&&(n=n.child,n!==null))for(d4(n,e,t),n=n.sibling;n!==null;)d4(n,e,t),n=n.sibling}var jt=null,jr=!1;function Vs(n,e,t){for(t=t.child;t!==null;)gS(n,e,t),t=t.sibling}function gS(n,e,t){if(Mi&&typeof Mi.onCommitFiberUnmount=="function")try{Mi.onCommitFiberUnmount($2,t)}catch{}switch(t.tag){case 5:gn||Nl(t,e);case 6:var r=jt,i=jr;jt=null,Vs(n,e,t),jt=r,jr=i,jt!==null&&(jr?(n=jt,t=t.stateNode,n.nodeType===8?n.parentNode.removeChild(t):n.removeChild(t)):jt.removeChild(t.stateNode));break;case 18:jt!==null&&(jr?(n=jt,t=t.stateNode,n.nodeType===8?gg(n.parentNode,t):n.nodeType===1&&gg(n,t),Hd(n)):gg(jt,t.stateNode));break;case 4:r=jt,i=jr,jt=t.stateNode.containerInfo,jr=!0,Vs(n,e,t),jt=r,jr=i;break;case 0:case 11:case 14:case 15:if(!gn&&(r=t.updateQueue,r!==null&&(r=r.lastEffect,r!==null))){i=r=r.next;do{var s=i,o=s.destroy;s=s.tag,o!==void 0&&(s&2||s&4)&&l4(t,e,o),i=i.next}while(i!==r)}Vs(n,e,t);break;case 1:if(!gn&&(Nl(t,e),r=t.stateNode,typeof r.componentWillUnmount=="function"))try{r.props=t.memoizedProps,r.state=t.memoizedState,r.componentWillUnmount()}catch(a){Et(t,e,a)}Vs(n,e,t);break;case 21:Vs(n,e,t);break;case 22:t.mode&1?(gn=(r=gn)||t.memoizedState!==null,Vs(n,e,t),gn=r):Vs(n,e,t);break;default:Vs(n,e,t)}}function m7(n){var e=n.updateQueue;if(e!==null){n.updateQueue=null;var t=n.stateNode;t===null&&(t=n.stateNode=new cO),e.forEach(function(r){var i=vO.bind(null,n,r);t.has(r)||(t.add(r),r.then(i,i))})}}function zr(n,e){var t=e.deletions;if(t!==null)for(var r=0;r<t.length;r++){var i=t[r];try{var s=n,o=e,a=o;e:for(;a!==null;){switch(a.tag){case 5:jt=a.stateNode,jr=!1;break e;case 3:jt=a.stateNode.containerInfo,jr=!0;break e;case 4:jt=a.stateNode.containerInfo,jr=!0;break e}a=a.return}if(jt===null)throw Error(q(160));gS(s,o,i),jt=null,jr=!1;var l=i.alternate;l!==null&&(l.return=null),i.return=null}catch(c){Et(i,e,c)}}if(e.subtreeFlags&12854)for(e=e.child;e!==null;)yS(e,n),e=e.sibling}function yS(n,e){var t=n.alternate,r=n.flags;switch(n.tag){case 0:case 11:case 14:case 15:if(zr(e,n),yi(n),r&4){try{xd(3,n,n.return),G2(3,n)}catch(g){Et(n,n.return,g)}try{xd(5,n,n.return)}catch(g){Et(n,n.return,g)}}break;case 1:zr(e,n),yi(n),r&512&&t!==null&&Nl(t,t.return);break;case 5:if(zr(e,n),yi(n),r&512&&t!==null&&Nl(t,t.return),n.flags&32){var i=n.stateNode;try{Ud(i,"")}catch(g){Et(n,n.return,g)}}if(r&4&&(i=n.stateNode,i!=null)){var s=n.memoizedProps,o=t!==null?t.memoizedProps:s,a=n.type,l=n.updateQueue;if(n.updateQueue=null,l!==null)try{a==="input"&&s.type==="radio"&&s.name!=null&&$b(i,s),L3(a,o);var c=L3(a,s);for(o=0;o<l.length;o+=2){var u=l[o],d=l[o+1];u==="style"?Hb(i,d):u==="dangerouslySetInnerHTML"?zb(i,d):u==="children"?Ud(i,d):nm(i,u,d,c)}switch(a){case"input":T3(i,s);break;case"textarea":Ub(i,s);break;case"select":var f=i._wrapperState.wasMultiple;i._wrapperState.wasMultiple=!!s.multiple;var p=s.value;p!=null?jl(i,!!s.multiple,p,!1):f!==!!s.multiple&&(s.defaultValue!=null?jl(i,!!s.multiple,s.defaultValue,!0):jl(i,!!s.multiple,s.multiple?[]:"",!1))}i[jd]=s}catch(g){Et(n,n.return,g)}}break;case 6:if(zr(e,n),yi(n),r&4){if(n.stateNode===null)throw Error(q(162));i=n.stateNode,s=n.memoizedProps;try{i.nodeValue=s}catch(g){Et(n,n.return,g)}}break;case 3:if(zr(e,n),yi(n),r&4&&t!==null&&t.memoizedState.isDehydrated)try{Hd(e.containerInfo)}catch(g){Et(n,n.return,g)}break;case 4:zr(e,n),yi(n);break;case 13:zr(e,n),yi(n),i=n.child,i.flags&8192&&(s=i.memoizedState!==null,i.stateNode.isHidden=s,!s||i.alternate!==null&&i.alternate.memoizedState!==null||(Lm=kt())),r&4&&m7(n);break;case 22:if(u=t!==null&&t.memoizedState!==null,n.mode&1?(gn=(c=gn)||u,zr(e,n),gn=c):zr(e,n),yi(n),r&8192){if(c=n.memoizedState!==null,(n.stateNode.isHidden=c)&&!u&&n.mode&1)for(oe=n,u=n.child;u!==null;){for(d=oe=u;oe!==null;){switch(f=oe,p=f.child,f.tag){case 0:case 11:case 14:case 15:xd(4,f,f.return);break;case 1:Nl(f,f.return);var y=f.stateNode;if(typeof y.componentWillUnmount=="function"){r=f,t=f.return;try{e=r,y.props=e.memoizedProps,y.state=e.memoizedState,y.componentWillUnmount()}catch(g){Et(r,t,g)}}break;case 5:Nl(f,f.return);break;case 22:if(f.memoizedState!==null){v7(d);continue}}p!==null?(p.return=f,oe=p):v7(d)}u=u.sibling}e:for(u=null,d=n;;){if(d.tag===5){if(u===null){u=d;try{i=d.stateNode,c?(s=i.style,typeof s.setProperty=="function"?s.setProperty("display","none","important"):s.display="none"):(a=d.stateNode,l=d.memoizedProps.style,o=l!=null&&l.hasOwnProperty("display")?l.display:null,a.style.display=Vb("display",o))}catch(g){Et(n,n.return,g)}}}else if(d.tag===6){if(u===null)try{d.stateNode.nodeValue=c?"":d.memoizedProps}catch(g){Et(n,n.return,g)}}else if((d.tag!==22&&d.tag!==23||d.memoizedState===null||d===n)&&d.child!==null){d.child.return=d,d=d.child;continue}if(d===n)break e;for(;d.sibling===null;){if(d.return===null||d.return===n)break e;u===d&&(u=null),d=d.return}u===d&&(u=null),d.sibling.return=d.return,d=d.sibling}}break;case 19:zr(e,n),yi(n),r&4&&m7(n);break;case 21:break;default:zr(e,n),yi(n)}}function yi(n){var e=n.flags;if(e&2){try{e:{for(var t=n.return;t!==null;){if(pS(t)){var r=t;break e}t=t.return}throw Error(q(160))}switch(r.tag){case 5:var i=r.stateNode;r.flags&32&&(Ud(i,""),r.flags&=-33);var s=y7(n);d4(n,s,i);break;case 3:case 4:var o=r.stateNode.containerInfo,a=y7(n);u4(n,a,o);break;default:throw Error(q(161))}}catch(l){Et(n,n.return,l)}n.flags&=-3}e&4096&&(n.flags&=-4097)}function dO(n,e,t){oe=n,mS(n)}function mS(n,e,t){for(var r=(n.mode&1)!==0;oe!==null;){var i=oe,s=i.child;if(i.tag===22&&r){var o=i.memoizedState!==null||If;if(!o){var a=i.alternate,l=a!==null&&a.memoizedState!==null||gn;a=If;var c=gn;if(If=o,(gn=l)&&!c)for(oe=i;oe!==null;)o=oe,l=o.child,o.tag===22&&o.memoizedState!==null?E7(i):l!==null?(l.return=o,oe=l):E7(i);for(;s!==null;)oe=s,mS(s),s=s.sibling;oe=i,If=a,gn=c}w7(n)}else i.subtreeFlags&8772&&s!==null?(s.return=i,oe=s):w7(n)}}function w7(n){for(;oe!==null;){var e=oe;if(e.flags&8772){var t=e.alternate;try{if(e.flags&8772)switch(e.tag){case 0:case 11:case 15:gn||G2(5,e);break;case 1:var r=e.stateNode;if(e.flags&4&&!gn)if(t===null)r.componentDidMount();else{var i=e.elementType===e.type?t.memoizedProps:Wr(e.type,t.memoizedProps);r.componentDidUpdate(i,t.memoizedState,r.__reactInternalSnapshotBeforeUpdate)}var s=e.updateQueue;s!==null&&n7(e,s,r);break;case 3:var o=e.updateQueue;if(o!==null){if(t=null,e.child!==null)switch(e.child.tag){case 5:t=e.child.stateNode;break;case 1:t=e.child.stateNode}n7(e,o,t)}break;case 5:var a=e.stateNode;if(t===null&&e.flags&4){t=a;var l=e.memoizedProps;switch(e.type){case"button":case"input":case"select":case"textarea":l.autoFocus&&t.focus();break;case"img":l.src&&(t.src=l.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(e.memoizedState===null){var c=e.alternate;if(c!==null){var u=c.memoizedState;if(u!==null){var d=u.dehydrated;d!==null&&Hd(d)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(q(163))}gn||e.flags&512&&c4(e)}catch(f){Et(e,e.return,f)}}if(e===n){oe=null;break}if(t=e.sibling,t!==null){t.return=e.return,oe=t;break}oe=e.return}}function v7(n){for(;oe!==null;){var e=oe;if(e===n){oe=null;break}var t=e.sibling;if(t!==null){t.return=e.return,oe=t;break}oe=e.return}}function E7(n){for(;oe!==null;){var e=oe;try{switch(e.tag){case 0:case 11:case 15:var t=e.return;try{G2(4,e)}catch(l){Et(e,t,l)}break;case 1:var r=e.stateNode;if(typeof r.componentDidMount=="function"){var i=e.return;try{r.componentDidMount()}catch(l){Et(e,i,l)}}var s=e.return;try{c4(e)}catch(l){Et(e,s,l)}break;case 5:var o=e.return;try{c4(e)}catch(l){Et(e,o,l)}}}catch(l){Et(e,e.return,l)}if(e===n){oe=null;break}var a=e.sibling;if(a!==null){a.return=e.return,oe=a;break}oe=e.return}}var hO=Math.ceil,g0=Ps.ReactCurrentDispatcher,Pm=Ps.ReactCurrentOwner,Pr=Ps.ReactCurrentBatchConfig,Me=0,Ht=null,Nt=null,Jt=0,Zn=0,Dl=Vo(0),$t=0,eh=null,Ma=0,q2=0,Om=0,kd=null,Vn=null,Lm=0,Rc=1/0,is=null,y0=!1,h4=null,Eo=null,Cf=!1,uo=null,m0=0,Rd=0,f4=null,E1=-1,b1=0;function Nn(){return Me&6?kt():E1!==-1?E1:E1=kt()}function bo(n){return n.mode&1?Me&2&&Jt!==0?Jt&-Jt:YP.transition!==null?(b1===0&&(b1=t_()),b1):(n=Ye,n!==0||(n=window.event,n=n===void 0?16:l_(n.type)),n):1}function ri(n,e,t,r){if(50<Rd)throw Rd=0,f4=null,Error(q(185));Uh(n,t,r),(!(Me&2)||n!==Ht)&&(n===Ht&&(!(Me&2)&&(q2|=t),$t===4&&so(n,Jt)),jn(n,r),t===1&&Me===0&&!(e.mode&1)&&(Rc=kt()+500,H2&&Ho()))}function jn(n,e){var t=n.callbackNode;YD(n,e);var r=e0(n,n===Ht?Jt:0);if(r===0)t!==null&&C8(t),n.callbackNode=null,n.callbackPriority=0;else if(e=r&-r,n.callbackPriority!==e){if(t!=null&&C8(t),e===1)n.tag===0?jP(b7.bind(null,n)):A_(b7.bind(null,n)),KP(function(){!(Me&6)&&Ho()}),t=null;else{switch(n_(r)){case 1:t=am;break;case 4:t=Zb;break;case 16:t=Z1;break;case 536870912:t=e_;break;default:t=Z1}t=kS(t,wS.bind(null,n))}n.callbackPriority=e,n.callbackNode=t}}function wS(n,e){if(E1=-1,b1=0,Me&6)throw Error(q(327));var t=n.callbackNode;if(Zl()&&n.callbackNode!==t)return null;var r=e0(n,n===Ht?Jt:0);if(r===0)return null;if(r&30||r&n.expiredLanes||e)e=w0(n,r);else{e=r;var i=Me;Me|=2;var s=ES();(Ht!==n||Jt!==e)&&(is=null,Rc=kt()+500,Ia(n,e));do try{gO();break}catch(a){vS(n,a)}while(!0);Em(),g0.current=s,Me=i,Nt!==null?e=0:(Ht=null,Jt=0,e=$t)}if(e!==0){if(e===2&&(i=F3(n),i!==0&&(r=i,e=p4(n,i))),e===1)throw t=eh,Ia(n,0),so(n,r),jn(n,kt()),t;if(e===6)so(n,r);else{if(i=n.current.alternate,!(r&30)&&!fO(i)&&(e=w0(n,r),e===2&&(s=F3(n),s!==0&&(r=s,e=p4(n,s))),e===1))throw t=eh,Ia(n,0),so(n,r),jn(n,kt()),t;switch(n.finishedWork=i,n.finishedLanes=r,e){case 0:case 1:throw Error(q(345));case 2:ra(n,Vn,is);break;case 3:if(so(n,r),(r&130023424)===r&&(e=Lm+500-kt(),10<e)){if(e0(n,0)!==0)break;if(i=n.suspendedLanes,(i&r)!==r){Nn(),n.pingedLanes|=n.suspendedLanes&i;break}n.timeoutHandle=j3(ra.bind(null,n,Vn,is),e);break}ra(n,Vn,is);break;case 4:if(so(n,r),(r&4194240)===r)break;for(e=n.eventTimes,i=-1;0<r;){var o=31-ni(r);s=1<<o,o=e[o],o>i&&(i=o),r&=~s}if(r=i,r=kt()-r,r=(120>r?120:480>r?480:1080>r?1080:1920>r?1920:3e3>r?3e3:4320>r?4320:1960*hO(r/1960))-r,10<r){n.timeoutHandle=j3(ra.bind(null,n,Vn,is),r);break}ra(n,Vn,is);break;case 5:ra(n,Vn,is);break;default:throw Error(q(329))}}}return jn(n,kt()),n.callbackNode===t?wS.bind(null,n):null}function p4(n,e){var t=kd;return n.current.memoizedState.isDehydrated&&(Ia(n,e).flags|=256),n=w0(n,e),n!==2&&(e=Vn,Vn=t,e!==null&&g4(e)),n}function g4(n){Vn===null?Vn=n:Vn.push.apply(Vn,n)}function fO(n){for(var e=n;;){if(e.flags&16384){var t=e.updateQueue;if(t!==null&&(t=t.stores,t!==null))for(var r=0;r<t.length;r++){var i=t[r],s=i.getSnapshot;i=i.value;try{if(!li(s(),i))return!1}catch{return!1}}}if(t=e.child,e.subtreeFlags&16384&&t!==null)t.return=e,e=t;else{if(e===n)break;for(;e.sibling===null;){if(e.return===null||e.return===n)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}function so(n,e){for(e&=~Om,e&=~q2,n.suspendedLanes|=e,n.pingedLanes&=~e,n=n.expirationTimes;0<e;){var t=31-ni(e),r=1<<t;n[t]=-1,e&=~r}}function b7(n){if(Me&6)throw Error(q(327));Zl();var e=e0(n,0);if(!(e&1))return jn(n,kt()),null;var t=w0(n,e);if(n.tag!==0&&t===2){var r=F3(n);r!==0&&(e=r,t=p4(n,r))}if(t===1)throw t=eh,Ia(n,0),so(n,e),jn(n,kt()),t;if(t===6)throw Error(q(345));return n.finishedWork=n.current.alternate,n.finishedLanes=e,ra(n,Vn,is),jn(n,kt()),null}function Bm(n,e){var t=Me;Me|=1;try{return n(e)}finally{Me=t,Me===0&&(Rc=kt()+500,H2&&Ho())}}function $a(n){uo!==null&&uo.tag===0&&!(Me&6)&&Zl();var e=Me;Me|=1;var t=Pr.transition,r=Ye;try{if(Pr.transition=null,Ye=1,n)return n()}finally{Ye=r,Pr.transition=t,Me=e,!(Me&6)&&Ho()}}function Mm(){Zn=Dl.current,lt(Dl)}function Ia(n,e){n.finishedWork=null,n.finishedLanes=0;var t=n.timeoutHandle;if(t!==-1&&(n.timeoutHandle=-1,HP(t)),Nt!==null)for(t=Nt.return;t!==null;){var r=t;switch(mm(r),r.tag){case 1:r=r.type.childContextTypes,r!=null&&s0();break;case 3:xc(),lt(Gn),lt(wn),Rm();break;case 5:km(r);break;case 4:xc();break;case 13:lt(gt);break;case 19:lt(gt);break;case 10:bm(r.type._context);break;case 22:case 23:Mm()}t=t.return}if(Ht=n,Nt=n=_o(n.current,null),Jt=Zn=e,$t=0,eh=null,Om=q2=Ma=0,Vn=kd=null,da!==null){for(e=0;e<da.length;e++)if(t=da[e],r=t.interleaved,r!==null){t.interleaved=null;var i=r.next,s=t.pending;if(s!==null){var o=s.next;s.next=i,r.next=o}t.pending=r}da=null}return n}function vS(n,e){do{var t=Nt;try{if(Em(),m1.current=p0,f0){for(var r=yt.memoizedState;r!==null;){var i=r.queue;i!==null&&(i.pending=null),r=r.next}f0=!1}if(Ba=0,Vt=Bt=yt=null,Sd=!1,Xd=0,Pm.current=null,t===null||t.return===null){$t=1,eh=e,Nt=null;break}e:{var s=n,o=t.return,a=t,l=e;if(e=Jt,a.flags|=32768,l!==null&&typeof l=="object"&&typeof l.then=="function"){var c=l,u=a,d=u.tag;if(!(u.mode&1)&&(d===0||d===11||d===15)){var f=u.alternate;f?(u.updateQueue=f.updateQueue,u.memoizedState=f.memoizedState,u.lanes=f.lanes):(u.updateQueue=null,u.memoizedState=null)}var p=l7(o);if(p!==null){p.flags&=-257,c7(p,o,a,s,e),p.mode&1&&a7(s,c,e),e=p,l=c;var y=e.updateQueue;if(y===null){var g=new Set;g.add(l),e.updateQueue=g}else y.add(l);break e}else{if(!(e&1)){a7(s,c,e),$m();break e}l=Error(q(426))}}else if(dt&&a.mode&1){var w=l7(o);if(w!==null){!(w.flags&65536)&&(w.flags|=256),c7(w,o,a,s,e),wm(kc(l,a));break e}}s=l=kc(l,a),$t!==4&&($t=2),kd===null?kd=[s]:kd.push(s),s=o;do{switch(s.tag){case 3:s.flags|=65536,e&=-e,s.lanes|=e;var m=nS(s,l,e);t7(s,m);break e;case 1:a=l;var E=s.type,v=s.stateNode;if(!(s.flags&128)&&(typeof E.getDerivedStateFromError=="function"||v!==null&&typeof v.componentDidCatch=="function"&&(Eo===null||!Eo.has(v)))){s.flags|=65536,e&=-e,s.lanes|=e;var b=rS(s,a,e);t7(s,b);break e}}s=s.return}while(s!==null)}_S(t)}catch(k){e=k,Nt===t&&t!==null&&(Nt=t=t.return);continue}break}while(!0)}function ES(){var n=g0.current;return g0.current=p0,n===null?p0:n}function $m(){($t===0||$t===3||$t===2)&&($t=4),Ht===null||!(Ma&268435455)&&!(q2&268435455)||so(Ht,Jt)}function w0(n,e){var t=Me;Me|=2;var r=ES();(Ht!==n||Jt!==e)&&(is=null,Ia(n,e));do try{pO();break}catch(i){vS(n,i)}while(!0);if(Em(),Me=t,g0.current=r,Nt!==null)throw Error(q(261));return Ht=null,Jt=0,$t}function pO(){for(;Nt!==null;)bS(Nt)}function gO(){for(;Nt!==null&&!FD();)bS(Nt)}function bS(n){var e=xS(n.alternate,n,Zn);n.memoizedProps=n.pendingProps,e===null?_S(n):Nt=e,Pm.current=null}function _S(n){var e=n;do{var t=e.alternate;if(n=e.return,e.flags&32768){if(t=lO(t,e),t!==null){t.flags&=32767,Nt=t;return}if(n!==null)n.flags|=32768,n.subtreeFlags=0,n.deletions=null;else{$t=6,Nt=null;return}}else if(t=aO(t,e,Zn),t!==null){Nt=t;return}if(e=e.sibling,e!==null){Nt=e;return}Nt=e=n}while(e!==null);$t===0&&($t=5)}function ra(n,e,t){var r=Ye,i=Pr.transition;try{Pr.transition=null,Ye=1,yO(n,e,t,r)}finally{Pr.transition=i,Ye=r}return null}function yO(n,e,t,r){do Zl();while(uo!==null);if(Me&6)throw Error(q(327));t=n.finishedWork;var i=n.finishedLanes;if(t===null)return null;if(n.finishedWork=null,n.finishedLanes=0,t===n.current)throw Error(q(177));n.callbackNode=null,n.callbackPriority=0;var s=t.lanes|t.childLanes;if(QD(n,s),n===Ht&&(Nt=Ht=null,Jt=0),!(t.subtreeFlags&2064)&&!(t.flags&2064)||Cf||(Cf=!0,kS(Z1,function(){return Zl(),null})),s=(t.flags&15990)!==0,t.subtreeFlags&15990||s){s=Pr.transition,Pr.transition=null;var o=Ye;Ye=1;var a=Me;Me|=4,Pm.current=null,uO(n,t),yS(t,n),BP(G3),t0=!!W3,G3=W3=null,n.current=t,dO(t),zD(),Me=a,Ye=o,Pr.transition=s}else n.current=t;if(Cf&&(Cf=!1,uo=n,m0=i),s=n.pendingLanes,s===0&&(Eo=null),KD(t.stateNode),jn(n,kt()),e!==null)for(r=n.onRecoverableError,t=0;t<e.length;t++)i=e[t],r(i.value,{componentStack:i.stack,digest:i.digest});if(y0)throw y0=!1,n=h4,h4=null,n;return m0&1&&n.tag!==0&&Zl(),s=n.pendingLanes,s&1?n===f4?Rd++:(Rd=0,f4=n):Rd=0,Ho(),null}function Zl(){if(uo!==null){var n=n_(m0),e=Pr.transition,t=Ye;try{if(Pr.transition=null,Ye=16>n?16:n,uo===null)var r=!1;else{if(n=uo,uo=null,m0=0,Me&6)throw Error(q(331));var i=Me;for(Me|=4,oe=n.current;oe!==null;){var s=oe,o=s.child;if(oe.flags&16){var a=s.deletions;if(a!==null){for(var l=0;l<a.length;l++){var c=a[l];for(oe=c;oe!==null;){var u=oe;switch(u.tag){case 0:case 11:case 15:xd(8,u,s)}var d=u.child;if(d!==null)d.return=u,oe=d;else for(;oe!==null;){u=oe;var f=u.sibling,p=u.return;if(fS(u),u===c){oe=null;break}if(f!==null){f.return=p,oe=f;break}oe=p}}}var y=s.alternate;if(y!==null){var g=y.child;if(g!==null){y.child=null;do{var w=g.sibling;g.sibling=null,g=w}while(g!==null)}}oe=s}}if(s.subtreeFlags&2064&&o!==null)o.return=s,oe=o;else e:for(;oe!==null;){if(s=oe,s.flags&2048)switch(s.tag){case 0:case 11:case 15:xd(9,s,s.return)}var m=s.sibling;if(m!==null){m.return=s.return,oe=m;break e}oe=s.return}}var E=n.current;for(oe=E;oe!==null;){o=oe;var v=o.child;if(o.subtreeFlags&2064&&v!==null)v.return=o,oe=v;else e:for(o=E;oe!==null;){if(a=oe,a.flags&2048)try{switch(a.tag){case 0:case 11:case 15:G2(9,a)}}catch(k){Et(a,a.return,k)}if(a===o){oe=null;break e}var b=a.sibling;if(b!==null){b.return=a.return,oe=b;break e}oe=a.return}}if(Me=i,Ho(),Mi&&typeof Mi.onPostCommitFiberRoot=="function")try{Mi.onPostCommitFiberRoot($2,n)}catch{}r=!0}return r}finally{Ye=t,Pr.transition=e}}return!1}function _7(n,e,t){e=kc(t,e),e=nS(n,e,1),n=vo(n,e,1),e=Nn(),n!==null&&(Uh(n,1,e),jn(n,e))}function Et(n,e,t){if(n.tag===3)_7(n,n,t);else for(;e!==null;){if(e.tag===3){_7(e,n,t);break}else if(e.tag===1){var r=e.stateNode;if(typeof e.type.getDerivedStateFromError=="function"||typeof r.componentDidCatch=="function"&&(Eo===null||!Eo.has(r))){n=kc(t,n),n=rS(e,n,1),e=vo(e,n,1),n=Nn(),e!==null&&(Uh(e,1,n),jn(e,n));break}}e=e.return}}function mO(n,e,t){var r=n.pingCache;r!==null&&r.delete(e),e=Nn(),n.pingedLanes|=n.suspendedLanes&t,Ht===n&&(Jt&t)===t&&($t===4||$t===3&&(Jt&130023424)===Jt&&500>kt()-Lm?Ia(n,0):Om|=t),jn(n,e)}function SS(n,e){e===0&&(n.mode&1?(e=vf,vf<<=1,!(vf&130023424)&&(vf=4194304)):e=1);var t=Nn();n=Is(n,e),n!==null&&(Uh(n,e,t),jn(n,t))}function wO(n){var e=n.memoizedState,t=0;e!==null&&(t=e.retryLane),SS(n,t)}function vO(n,e){var t=0;switch(n.tag){case 13:var r=n.stateNode,i=n.memoizedState;i!==null&&(t=i.retryLane);break;case 19:r=n.stateNode;break;default:throw Error(q(314))}r!==null&&r.delete(e),SS(n,t)}var xS;xS=function(n,e,t){if(n!==null)if(n.memoizedProps!==e.pendingProps||Gn.current)Kn=!0;else{if(!(n.lanes&t)&&!(e.flags&128))return Kn=!1,oO(n,e,t);Kn=!!(n.flags&131072)}else Kn=!1,dt&&e.flags&1048576&&I_(e,l0,e.index);switch(e.lanes=0,e.tag){case 2:var r=e.type;v1(n,e),n=e.pendingProps;var i=bc(e,wn.current);Jl(e,t),i=Im(null,e,r,n,i,t);var s=Cm();return e.flags|=1,typeof i=="object"&&i!==null&&typeof i.render=="function"&&i.$$typeof===void 0?(e.tag=1,e.memoizedState=null,e.updateQueue=null,qn(r)?(s=!0,o0(e)):s=!1,e.memoizedState=i.state!==null&&i.state!==void 0?i.state:null,Sm(e),i.updater=W2,e.stateNode=i,i._reactInternals=e,t4(e,r,n,t),e=i4(null,e,r,!0,s,t)):(e.tag=0,dt&&s&&ym(e),An(null,e,i,t),e=e.child),e;case 16:r=e.elementType;e:{switch(v1(n,e),n=e.pendingProps,i=r._init,r=i(r._payload),e.type=r,i=e.tag=bO(r),n=Wr(r,n),i){case 0:e=r4(null,e,r,n,t);break e;case 1:e=h7(null,e,r,n,t);break e;case 11:e=u7(null,e,r,n,t);break e;case 14:e=d7(null,e,r,Wr(r.type,n),t);break e}throw Error(q(306,r,""))}return e;case 0:return r=e.type,i=e.pendingProps,i=e.elementType===r?i:Wr(r,i),r4(n,e,r,i,t);case 1:return r=e.type,i=e.pendingProps,i=e.elementType===r?i:Wr(r,i),h7(n,e,r,i,t);case 3:e:{if(aS(e),n===null)throw Error(q(387));r=e.pendingProps,s=e.memoizedState,i=s.element,O_(n,e),d0(e,r,null,t);var o=e.memoizedState;if(r=o.element,s.isDehydrated)if(s={element:r,isDehydrated:!1,cache:o.cache,pendingSuspenseBoundaries:o.pendingSuspenseBoundaries,transitions:o.transitions},e.updateQueue.baseState=s,e.memoizedState=s,e.flags&256){i=kc(Error(q(423)),e),e=f7(n,e,r,t,i);break e}else if(r!==i){i=kc(Error(q(424)),e),e=f7(n,e,r,t,i);break e}else for(rr=wo(e.stateNode.containerInfo.firstChild),or=e,dt=!0,Jr=null,t=D_(e,null,r,t),e.child=t;t;)t.flags=t.flags&-3|4096,t=t.sibling;else{if(_c(),r===i){e=Cs(n,e,t);break e}An(n,e,r,t)}e=e.child}return e;case 5:return L_(e),n===null&&J3(e),r=e.type,i=e.pendingProps,s=n!==null?n.memoizedProps:null,o=i.children,q3(r,i)?o=null:s!==null&&q3(r,s)&&(e.flags|=32),oS(n,e),An(n,e,o,t),e.child;case 6:return n===null&&J3(e),null;case 13:return lS(n,e,t);case 4:return xm(e,e.stateNode.containerInfo),r=e.pendingProps,n===null?e.child=Sc(e,null,r,t):An(n,e,r,t),e.child;case 11:return r=e.type,i=e.pendingProps,i=e.elementType===r?i:Wr(r,i),u7(n,e,r,i,t);case 7:return An(n,e,e.pendingProps,t),e.child;case 8:return An(n,e,e.pendingProps.children,t),e.child;case 12:return An(n,e,e.pendingProps.children,t),e.child;case 10:e:{if(r=e.type._context,i=e.pendingProps,s=e.memoizedProps,o=i.value,tt(c0,r._currentValue),r._currentValue=o,s!==null)if(li(s.value,o)){if(s.children===i.children&&!Gn.current){e=Cs(n,e,t);break e}}else for(s=e.child,s!==null&&(s.return=e);s!==null;){var a=s.dependencies;if(a!==null){o=s.child;for(var l=a.firstContext;l!==null;){if(l.context===r){if(s.tag===1){l=Es(-1,t&-t),l.tag=2;var c=s.updateQueue;if(c!==null){c=c.shared;var u=c.pending;u===null?l.next=l:(l.next=u.next,u.next=l),c.pending=l}}s.lanes|=t,l=s.alternate,l!==null&&(l.lanes|=t),Z3(s.return,t,e),a.lanes|=t;break}l=l.next}}else if(s.tag===10)o=s.type===e.type?null:s.child;else if(s.tag===18){if(o=s.return,o===null)throw Error(q(341));o.lanes|=t,a=o.alternate,a!==null&&(a.lanes|=t),Z3(o,t,e),o=s.sibling}else o=s.child;if(o!==null)o.return=s;else for(o=s;o!==null;){if(o===e){o=null;break}if(s=o.sibling,s!==null){s.return=o.return,o=s;break}o=o.return}s=o}An(n,e,i.children,t),e=e.child}return e;case 9:return i=e.type,r=e.pendingProps.children,Jl(e,t),i=Lr(i),r=r(i),e.flags|=1,An(n,e,r,t),e.child;case 14:return r=e.type,i=Wr(r,e.pendingProps),i=Wr(r.type,i),d7(n,e,r,i,t);case 15:return iS(n,e,e.type,e.pendingProps,t);case 17:return r=e.type,i=e.pendingProps,i=e.elementType===r?i:Wr(r,i),v1(n,e),e.tag=1,qn(r)?(n=!0,o0(e)):n=!1,Jl(e,t),tS(e,r,i),t4(e,r,i,t),i4(null,e,r,!0,n,t);case 19:return cS(n,e,t);case 22:return sS(n,e,t)}throw Error(q(156,e.tag))};function kS(n,e){return Jb(n,e)}function EO(n,e,t,r){this.tag=n,this.key=t,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=r,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Tr(n,e,t,r){return new EO(n,e,t,r)}function Um(n){return n=n.prototype,!(!n||!n.isReactComponent)}function bO(n){if(typeof n=="function")return Um(n)?1:0;if(n!=null){if(n=n.$$typeof,n===im)return 11;if(n===sm)return 14}return 2}function _o(n,e){var t=n.alternate;return t===null?(t=Tr(n.tag,e,n.key,n.mode),t.elementType=n.elementType,t.type=n.type,t.stateNode=n.stateNode,t.alternate=n,n.alternate=t):(t.pendingProps=e,t.type=n.type,t.flags=0,t.subtreeFlags=0,t.deletions=null),t.flags=n.flags&14680064,t.childLanes=n.childLanes,t.lanes=n.lanes,t.child=n.child,t.memoizedProps=n.memoizedProps,t.memoizedState=n.memoizedState,t.updateQueue=n.updateQueue,e=n.dependencies,t.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext},t.sibling=n.sibling,t.index=n.index,t.ref=n.ref,t}function _1(n,e,t,r,i,s){var o=2;if(r=n,typeof n=="function")Um(n)&&(o=1);else if(typeof n=="string")o=5;else e:switch(n){case _l:return Ca(t.children,i,s,e);case rm:o=8,i|=8;break;case k3:return n=Tr(12,t,e,i|2),n.elementType=k3,n.lanes=s,n;case R3:return n=Tr(13,t,e,i),n.elementType=R3,n.lanes=s,n;case A3:return n=Tr(19,t,e,i),n.elementType=A3,n.lanes=s,n;case Lb:return j2(t,i,s,e);default:if(typeof n=="object"&&n!==null)switch(n.$$typeof){case Pb:o=10;break e;case Ob:o=9;break e;case im:o=11;break e;case sm:o=14;break e;case Zs:o=16,r=null;break e}throw Error(q(130,n==null?n:typeof n,""))}return e=Tr(o,t,e,i),e.elementType=n,e.type=r,e.lanes=s,e}function Ca(n,e,t,r){return n=Tr(7,n,r,e),n.lanes=t,n}function j2(n,e,t,r){return n=Tr(22,n,r,e),n.elementType=Lb,n.lanes=t,n.stateNode={isHidden:!1},n}function Sg(n,e,t){return n=Tr(6,n,null,e),n.lanes=t,n}function xg(n,e,t){return e=Tr(4,n.children!==null?n.children:[],n.key,e),e.lanes=t,e.stateNode={containerInfo:n.containerInfo,pendingChildren:null,implementation:n.implementation},e}function _O(n,e,t,r,i){this.tag=e,this.containerInfo=n,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=ig(0),this.expirationTimes=ig(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=ig(0),this.identifierPrefix=r,this.onRecoverableError=i,this.mutableSourceEagerHydrationData=null}function Fm(n,e,t,r,i,s,o,a,l){return n=new _O(n,e,t,a,l),e===1?(e=1,s===!0&&(e|=8)):e=0,s=Tr(3,null,null,e),n.current=s,s.stateNode=n,s.memoizedState={element:r,isDehydrated:t,cache:null,transitions:null,pendingSuspenseBoundaries:null},Sm(s),n}function SO(n,e,t){var r=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:bl,key:r==null?null:""+r,children:n,containerInfo:e,implementation:t}}function RS(n){if(!n)return Co;n=n._reactInternals;e:{if(Xa(n)!==n||n.tag!==1)throw Error(q(170));var e=n;do{switch(e.tag){case 3:e=e.stateNode.context;break e;case 1:if(qn(e.type)){e=e.stateNode.__reactInternalMemoizedMergedChildContext;break e}}e=e.return}while(e!==null);throw Error(q(171))}if(n.tag===1){var t=n.type;if(qn(t))return R_(n,t,e)}return e}function AS(n,e,t,r,i,s,o,a,l){return n=Fm(t,r,!0,n,i,s,o,a,l),n.context=RS(null),t=n.current,r=Nn(),i=bo(t),s=Es(r,i),s.callback=e??null,vo(t,s,i),n.current.lanes=i,Uh(n,i,r),jn(n,r),n}function Y2(n,e,t,r){var i=e.current,s=Nn(),o=bo(i);return t=RS(t),e.context===null?e.context=t:e.pendingContext=t,e=Es(s,o),e.payload={element:n},r=r===void 0?null:r,r!==null&&(e.callback=r),n=vo(i,e,o),n!==null&&(ri(n,i,o,s),y1(n,i,o)),o}function v0(n){if(n=n.current,!n.child)return null;switch(n.child.tag){case 5:return n.child.stateNode;default:return n.child.stateNode}}function S7(n,e){if(n=n.memoizedState,n!==null&&n.dehydrated!==null){var t=n.retryLane;n.retryLane=t!==0&&t<e?t:e}}function zm(n,e){S7(n,e),(n=n.alternate)&&S7(n,e)}function xO(){return null}var IS=typeof reportError=="function"?reportError:function(n){console.error(n)};function Vm(n){this._internalRoot=n}Q2.prototype.render=Vm.prototype.render=function(n){var e=this._internalRoot;if(e===null)throw Error(q(409));Y2(n,e,null,null)};Q2.prototype.unmount=Vm.prototype.unmount=function(){var n=this._internalRoot;if(n!==null){this._internalRoot=null;var e=n.containerInfo;$a(function(){Y2(null,n,null,null)}),e[As]=null}};function Q2(n){this._internalRoot=n}Q2.prototype.unstable_scheduleHydration=function(n){if(n){var e=s_();n={blockedOn:null,target:n,priority:e};for(var t=0;t<io.length&&e!==0&&e<io[t].priority;t++);io.splice(t,0,n),t===0&&a_(n)}};function Hm(n){return!(!n||n.nodeType!==1&&n.nodeType!==9&&n.nodeType!==11)}function X2(n){return!(!n||n.nodeType!==1&&n.nodeType!==9&&n.nodeType!==11&&(n.nodeType!==8||n.nodeValue!==" react-mount-point-unstable "))}function x7(){}function kO(n,e,t,r,i){if(i){if(typeof r=="function"){var s=r;r=function(){var c=v0(o);s.call(c)}}var o=AS(e,r,n,0,null,!1,!1,"",x7);return n._reactRootContainer=o,n[As]=o.current,Gd(n.nodeType===8?n.parentNode:n),$a(),o}for(;i=n.lastChild;)n.removeChild(i);if(typeof r=="function"){var a=r;r=function(){var c=v0(l);a.call(c)}}var l=Fm(n,0,!1,null,null,!1,!1,"",x7);return n._reactRootContainer=l,n[As]=l.current,Gd(n.nodeType===8?n.parentNode:n),$a(function(){Y2(e,l,t,r)}),l}function J2(n,e,t,r,i){var s=t._reactRootContainer;if(s){var o=s;if(typeof i=="function"){var a=i;i=function(){var l=v0(o);a.call(l)}}Y2(e,o,n,i)}else o=kO(t,e,n,i,r);return v0(o)}r_=function(n){switch(n.tag){case 3:var e=n.stateNode;if(e.current.memoizedState.isDehydrated){var t=od(e.pendingLanes);t!==0&&(lm(e,t|1),jn(e,kt()),!(Me&6)&&(Rc=kt()+500,Ho()))}break;case 13:$a(function(){var r=Is(n,1);if(r!==null){var i=Nn();ri(r,n,1,i)}}),zm(n,1)}};cm=function(n){if(n.tag===13){var e=Is(n,134217728);if(e!==null){var t=Nn();ri(e,n,134217728,t)}zm(n,134217728)}};i_=function(n){if(n.tag===13){var e=bo(n),t=Is(n,e);if(t!==null){var r=Nn();ri(t,n,e,r)}zm(n,e)}};s_=function(){return Ye};o_=function(n,e){var t=Ye;try{return Ye=n,e()}finally{Ye=t}};M3=function(n,e,t){switch(e){case"input":if(T3(n,t),e=t.name,t.type==="radio"&&e!=null){for(t=n;t.parentNode;)t=t.parentNode;for(t=t.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<t.length;e++){var r=t[e];if(r!==n&&r.form===n.form){var i=V2(r);if(!i)throw Error(q(90));Mb(r),T3(r,i)}}}break;case"textarea":Ub(n,t);break;case"select":e=t.value,e!=null&&jl(n,!!t.multiple,e,!1)}};Gb=Bm;qb=$a;var RO={usingClientEntryPoint:!1,Events:[zh,Rl,V2,Kb,Wb,Bm]},Ku={findFiberByHostInstance:ua,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},AO={bundleType:Ku.bundleType,version:Ku.version,rendererPackageName:Ku.rendererPackageName,rendererConfig:Ku.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:Ps.ReactCurrentDispatcher,findHostInstanceByFiber:function(n){return n=Qb(n),n===null?null:n.stateNode},findFiberByHostInstance:Ku.findFiberByHostInstance||xO,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Tf=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Tf.isDisabled&&Tf.supportsFiber)try{$2=Tf.inject(AO),Mi=Tf}catch{}}fr.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=RO;fr.createPortal=function(n,e){var t=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!Hm(e))throw Error(q(200));return SO(n,e,null,t)};fr.createRoot=function(n,e){if(!Hm(n))throw Error(q(299));var t=!1,r="",i=IS;return e!=null&&(e.unstable_strictMode===!0&&(t=!0),e.identifierPrefix!==void 0&&(r=e.identifierPrefix),e.onRecoverableError!==void 0&&(i=e.onRecoverableError)),e=Fm(n,1,!1,null,null,t,!1,r,i),n[As]=e.current,Gd(n.nodeType===8?n.parentNode:n),new Vm(e)};fr.findDOMNode=function(n){if(n==null)return null;if(n.nodeType===1)return n;var e=n._reactInternals;if(e===void 0)throw typeof n.render=="function"?Error(q(188)):(n=Object.keys(n).join(","),Error(q(268,n)));return n=Qb(e),n=n===null?null:n.stateNode,n};fr.flushSync=function(n){return $a(n)};fr.hydrate=function(n,e,t){if(!X2(e))throw Error(q(200));return J2(null,n,e,!0,t)};fr.hydrateRoot=function(n,e,t){if(!Hm(n))throw Error(q(405));var r=t!=null&&t.hydratedSources||null,i=!1,s="",o=IS;if(t!=null&&(t.unstable_strictMode===!0&&(i=!0),t.identifierPrefix!==void 0&&(s=t.identifierPrefix),t.onRecoverableError!==void 0&&(o=t.onRecoverableError)),e=AS(e,null,n,1,t??null,i,!1,s,o),n[As]=e.current,Gd(n),r)for(n=0;n<r.length;n++)t=r[n],i=t._getVersion,i=i(t._source),e.mutableSourceEagerHydrationData==null?e.mutableSourceEagerHydrationData=[t,i]:e.mutableSourceEagerHydrationData.push(t,i);return new Q2(e)};fr.render=function(n,e,t){if(!X2(e))throw Error(q(200));return J2(null,n,e,!1,t)};fr.unmountComponentAtNode=function(n){if(!X2(n))throw Error(q(40));return n._reactRootContainer?($a(function(){J2(null,null,n,!1,function(){n._reactRootContainer=null,n[As]=null})}),!0):!1};fr.unstable_batchedUpdates=Bm;fr.unstable_renderSubtreeIntoContainer=function(n,e,t,r){if(!X2(t))throw Error(q(200));if(n==null||n._reactInternals===void 0)throw Error(q(38));return J2(n,e,t,!1,r)};fr.version="18.3.1-next-f1338f8080-20240426";function CS(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(CS)}catch(n){console.error(n)}}CS(),Cb.exports=fr;var IO=Cb.exports,k7=IO;S3.createRoot=k7.createRoot,S3.hydrateRoot=k7.hydrateRoot;let CO="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",TO=(n=21)=>{let e="",t=n|0;for(;t--;)e+=CO[Math.random()*64|0];return e};function Zr(n){for(var e=arguments.length,t=Array(e>1?e-1:0),r=1;r<e;r++)t[r-1]=arguments[r];throw Error("[Immer] minified error nr: "+n+(t.length?" "+t.map(function(i){return"'"+i+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function Ac(n){return!!n&&!!n[cr]}function Ua(n){var e;return!!n&&(function(t){if(!t||typeof t!="object")return!1;var r=Object.getPrototypeOf(t);if(r===null)return!0;var i=Object.hasOwnProperty.call(r,"constructor")&&r.constructor;return i===Object||typeof i=="function"&&Function.toString.call(i)===$O}(n)||Array.isArray(n)||!!n[P7]||!!(!((e=n.constructor)===null||e===void 0)&&e[P7])||Km(n)||Wm(n))}function th(n,e,t){t===void 0&&(t=!1),hu(n)===0?(t?Object.keys:Qm)(n).forEach(function(r){t&&typeof r=="symbol"||e(r,n[r],n)}):n.forEach(function(r,i){return e(i,r,n)})}function hu(n){var e=n[cr];return e?e.i>3?e.i-4:e.i:Array.isArray(n)?1:Km(n)?2:Wm(n)?3:0}function y4(n,e){return hu(n)===2?n.has(e):Object.prototype.hasOwnProperty.call(n,e)}function NO(n,e){return hu(n)===2?n.get(e):n[e]}function TS(n,e,t){var r=hu(n);r===2?n.set(e,t):r===3?n.add(t):n[e]=t}function DO(n,e){return n===e?n!==0||1/n==1/e:n!=n&&e!=e}function Km(n){return BO&&n instanceof Map}function Wm(n){return MO&&n instanceof Set}function ia(n){return n.o||n.t}function Gm(n){if(Array.isArray(n))return Array.prototype.slice.call(n);var e=UO(n);delete e[cr];for(var t=Qm(e),r=0;r<t.length;r++){var i=t[r],s=e[i];s.writable===!1&&(s.writable=!0,s.configurable=!0),(s.get||s.set)&&(e[i]={configurable:!0,writable:!0,enumerable:s.enumerable,value:n[i]})}return Object.create(Object.getPrototypeOf(n),e)}function qm(n,e){return e===void 0&&(e=!1),jm(n)||Ac(n)||!Ua(n)||(hu(n)>1&&(n.set=n.add=n.clear=n.delete=PO),Object.freeze(n),e&&th(n,function(t,r){return qm(r,!0)},!0)),n}function PO(){Zr(2)}function jm(n){return n==null||typeof n!="object"||Object.isFrozen(n)}function Ui(n){var e=FO[n];return e||Zr(18,n),e}function R7(){return nh}function kg(n,e){e&&(Ui("Patches"),n.u=[],n.s=[],n.v=e)}function E0(n){m4(n),n.p.forEach(OO),n.p=null}function m4(n){n===nh&&(nh=n.l)}function A7(n){return nh={p:[],l:nh,h:n,m:!0,_:0}}function OO(n){var e=n[cr];e.i===0||e.i===1?e.j():e.g=!0}function Rg(n,e){e._=e.p.length;var t=e.p[0],r=n!==void 0&&n!==t;return e.h.O||Ui("ES5").S(e,n,r),r?(t[cr].P&&(E0(e),Zr(4)),Ua(n)&&(n=b0(e,n),e.l||_0(e,n)),e.u&&Ui("Patches").M(t[cr].t,n,e.u,e.s)):n=b0(e,t,[]),E0(e),e.u&&e.v(e.u,e.s),n!==NS?n:void 0}function b0(n,e,t){if(jm(e))return e;var r=e[cr];if(!r)return th(e,function(a,l){return I7(n,r,e,a,l,t)},!0),e;if(r.A!==n)return e;if(!r.P)return _0(n,r.t,!0),r.t;if(!r.I){r.I=!0,r.A._--;var i=r.i===4||r.i===5?r.o=Gm(r.k):r.o,s=i,o=!1;r.i===3&&(s=new Set(i),i.clear(),o=!0),th(s,function(a,l){return I7(n,r,i,a,l,t,o)}),_0(n,i,!1),t&&n.u&&Ui("Patches").N(r,t,n.u,n.s)}return r.o}function I7(n,e,t,r,i,s,o){if(Ac(i)){var a=b0(n,i,s&&e&&e.i!==3&&!y4(e.R,r)?s.concat(r):void 0);if(TS(t,r,a),!Ac(a))return;n.m=!1}else o&&t.add(i);if(Ua(i)&&!jm(i)){if(!n.h.D&&n._<1)return;b0(n,i),e&&e.A.l||_0(n,i)}}function _0(n,e,t){t===void 0&&(t=!1),!n.l&&n.h.D&&n.m&&qm(e,t)}function Ag(n,e){var t=n[cr];return(t?ia(t):n)[e]}function C7(n,e){if(e in n)for(var t=Object.getPrototypeOf(n);t;){var r=Object.getOwnPropertyDescriptor(t,e);if(r)return r;t=Object.getPrototypeOf(t)}}function w4(n){n.P||(n.P=!0,n.l&&w4(n.l))}function Ig(n){n.o||(n.o=Gm(n.t))}function v4(n,e,t){var r=Km(e)?Ui("MapSet").F(e,t):Wm(e)?Ui("MapSet").T(e,t):n.O?function(i,s){var o=Array.isArray(i),a={i:o?1:0,A:s?s.A:R7(),P:!1,I:!1,R:{},l:s,t:i,k:null,o:null,j:null,C:!1},l=a,c=E4;o&&(l=[a],c=ld);var u=Proxy.revocable(l,c),d=u.revoke,f=u.proxy;return a.k=f,a.j=d,f}(e,t):Ui("ES5").J(e,t);return(t?t.A:R7()).p.push(r),r}function LO(n){return Ac(n)||Zr(22,n),function e(t){if(!Ua(t))return t;var r,i=t[cr],s=hu(t);if(i){if(!i.P&&(i.i<4||!Ui("ES5").K(i)))return i.t;i.I=!0,r=T7(t,s),i.I=!1}else r=T7(t,s);return th(r,function(o,a){i&&NO(i.t,o)===a||TS(r,o,e(a))}),s===3?new Set(r):r}(n)}function T7(n,e){switch(e){case 2:return new Map(n);case 3:return Array.from(n)}return Gm(n)}var N7,nh,Ym=typeof Symbol<"u"&&typeof Symbol("x")=="symbol",BO=typeof Map<"u",MO=typeof Set<"u",D7=typeof Proxy<"u"&&Proxy.revocable!==void 0&&typeof Reflect<"u",NS=Ym?Symbol.for("immer-nothing"):((N7={})["immer-nothing"]=!0,N7),P7=Ym?Symbol.for("immer-draftable"):"__$immer_draftable",cr=Ym?Symbol.for("immer-state"):"__$immer_state",$O=""+Object.prototype.constructor,Qm=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(n){return Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n))}:Object.getOwnPropertyNames,UO=Object.getOwnPropertyDescriptors||function(n){var e={};return Qm(n).forEach(function(t){e[t]=Object.getOwnPropertyDescriptor(n,t)}),e},FO={},E4={get:function(n,e){if(e===cr)return n;var t=ia(n);if(!y4(t,e))return function(i,s,o){var a,l=C7(s,o);return l?"value"in l?l.value:(a=l.get)===null||a===void 0?void 0:a.call(i.k):void 0}(n,t,e);var r=t[e];return n.I||!Ua(r)?r:r===Ag(n.t,e)?(Ig(n),n.o[e]=v4(n.A.h,r,n)):r},has:function(n,e){return e in ia(n)},ownKeys:function(n){return Reflect.ownKeys(ia(n))},set:function(n,e,t){var r=C7(ia(n),e);if(r!=null&&r.set)return r.set.call(n.k,t),!0;if(!n.P){var i=Ag(ia(n),e),s=i==null?void 0:i[cr];if(s&&s.t===t)return n.o[e]=t,n.R[e]=!1,!0;if(DO(t,i)&&(t!==void 0||y4(n.t,e)))return!0;Ig(n),w4(n)}return n.o[e]===t&&(t!==void 0||e in n.o)||Number.isNaN(t)&&Number.isNaN(n.o[e])||(n.o[e]=t,n.R[e]=!0),!0},deleteProperty:function(n,e){return Ag(n.t,e)!==void 0||e in n.t?(n.R[e]=!1,Ig(n),w4(n)):delete n.R[e],n.o&&delete n.o[e],!0},getOwnPropertyDescriptor:function(n,e){var t=ia(n),r=Reflect.getOwnPropertyDescriptor(t,e);return r&&{writable:!0,configurable:n.i!==1||e!=="length",enumerable:r.enumerable,value:t[e]}},defineProperty:function(){Zr(11)},getPrototypeOf:function(n){return Object.getPrototypeOf(n.t)},setPrototypeOf:function(){Zr(12)}},ld={};th(E4,function(n,e){ld[n]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}}),ld.deleteProperty=function(n,e){return ld.set.call(this,n,e,void 0)},ld.set=function(n,e,t){return E4.set.call(this,n[0],e,t,n[0])};var zO=function(){function n(t){var r=this;this.O=D7,this.D=!0,this.produce=function(i,s,o){if(typeof i=="function"&&typeof s!="function"){var a=s;s=i;var l=r;return function(g){var w=this;g===void 0&&(g=a);for(var m=arguments.length,E=Array(m>1?m-1:0),v=1;v<m;v++)E[v-1]=arguments[v];return l.produce(g,function(b){var k;return(k=s).call.apply(k,[w,b].concat(E))})}}var c;if(typeof s!="function"&&Zr(6),o!==void 0&&typeof o!="function"&&Zr(7),Ua(i)){var u=A7(r),d=v4(r,i,void 0),f=!0;try{c=s(d),f=!1}finally{f?E0(u):m4(u)}return typeof Promise<"u"&&c instanceof Promise?c.then(function(g){return kg(u,o),Rg(g,u)},function(g){throw E0(u),g}):(kg(u,o),Rg(c,u))}if(!i||typeof i!="object"){if((c=s(i))===void 0&&(c=i),c===NS&&(c=void 0),r.D&&qm(c,!0),o){var p=[],y=[];Ui("Patches").M(i,c,p,y),o(p,y)}return c}Zr(21,i)},this.produceWithPatches=function(i,s){if(typeof i=="function")return function(c){for(var u=arguments.length,d=Array(u>1?u-1:0),f=1;f<u;f++)d[f-1]=arguments[f];return r.produceWithPatches(c,function(p){return i.apply(void 0,[p].concat(d))})};var o,a,l=r.produce(i,s,function(c,u){o=c,a=u});return typeof Promise<"u"&&l instanceof Promise?l.then(function(c){return[c,o,a]}):[l,o,a]},typeof(t==null?void 0:t.useProxies)=="boolean"&&this.setUseProxies(t.useProxies),typeof(t==null?void 0:t.autoFreeze)=="boolean"&&this.setAutoFreeze(t.autoFreeze)}var e=n.prototype;return e.createDraft=function(t){Ua(t)||Zr(8),Ac(t)&&(t=LO(t));var r=A7(this),i=v4(this,t,void 0);return i[cr].C=!0,m4(r),i},e.finishDraft=function(t,r){var i=t&&t[cr],s=i.A;return kg(s,r),Rg(void 0,s)},e.setAutoFreeze=function(t){this.D=t},e.setUseProxies=function(t){t&&!D7&&Zr(20),this.O=t},e.applyPatches=function(t,r){var i;for(i=r.length-1;i>=0;i--){var s=r[i];if(s.path.length===0&&s.op==="replace"){t=s.value;break}}i>-1&&(r=r.slice(i+1));var o=Ui("Patches").$;return Ac(t)?o(t,r):this.produce(t,function(a){return o(a,r)})},n}(),ur=new zO,VO=ur.produce;ur.produceWithPatches.bind(ur);ur.setAutoFreeze.bind(ur);ur.setUseProxies.bind(ur);ur.applyPatches.bind(ur);ur.createDraft.bind(ur);ur.finishDraft.bind(ur);class HO{constructor(e){const t=KO();this.c=1,this.s0=t(" "),this.s1=t(" "),this.s2=t(" "),this.s0-=t(e),this.s0<0&&(this.s0+=1),this.s1-=t(e),this.s1<0&&(this.s1+=1),this.s2-=t(e),this.s2<0&&(this.s2+=1)}next(){const e=2091639*this.s0+this.c*23283064365386963e-26;return this.s0=this.s1,this.s1=this.s2,this.s2=e-(this.c=Math.trunc(e))}}function KO(){let n=4022871197;return function(t){const r=t.toString();for(let i=0;i<r.length;i++){n+=r.charCodeAt(i);let s=.02519603282416938*n;n=s>>>0,s-=n,s*=n,n=s>>>0,s-=n,n+=s*4294967296}return(n>>>0)*23283064365386963e-26}}function O7(n,e){return e.c=n.c,e.s0=n.s0,e.s1=n.s1,e.s2=n.s2,e}function DS(n,e){const t=new HO(n),r=t.next.bind(t);return e&&O7(e,t),r.state=()=>O7(t,{}),r}class L7{constructor(e){this.state=e||{seed:"0"},this.used=!1}static seed(){return Date.now().toString(36).slice(-10)}isUsed(){return this.used}getState(){return this.state}_random(){this.used=!0;const e=this.state,t=e.prngstate?"":e.seed,r=DS(t,e.prngstate),i=r();return this.state={...e,prngstate:r.state()},i}api(){const e=this._random.bind(this),t={D4:4,D6:6,D8:8,D10:10,D12:12,D20:20},r={};for(const s in t){const o=t[s];r[s]=a=>a===void 0?Math.floor(e()*o)+1:Array.from({length:a}).map(()=>Math.floor(e()*o)+1)}function i(s=6,o){return o===void 0?Math.floor(e()*s)+1:Array.from({length:o}).map(()=>Math.floor(e()*s)+1)}return{...r,Die:i,Number:()=>e(),Shuffle:s=>{const o=[...s];let a=s.length,l=0;const c=Array.from({length:a});for(;a;){const u=Math.trunc(a*e());c[l++]=o[u],o[u]=o[--a]}return c},_private:this}}}const WO={name:"random",noClient:({api:n})=>n._private.isUsed(),flush:({api:n})=>n._private.getState(),api:({data:n})=>new L7(n).api(),setup:({game:n})=>{let{seed:e}=n;return e===void 0&&(e=L7.seed()),{seed:e}},playerView:()=>{}};var GO=Function.prototype,qO=GO.toString;qO.call(Object);const rh="MAKE_MOVE",Z2="GAME_EVENT",ep="REDO",Xm="RESET",Jm="SYNC",tp="UNDO",Zm="UPDATE",e6="PATCH",PS="PLUGIN",np="STRIP_TRANSIENTS",OS=(n,e,t,r)=>({type:rh,payload:{type:n,args:e,playerID:t,credentials:r}}),Ad=(n,e,t,r)=>({type:Z2,payload:{type:n,args:e,playerID:t,credentials:r}}),LS=(n,e,t,r)=>({type:Z2,payload:{type:n,args:e,playerID:t,credentials:r},automatic:!0}),BS=n=>({type:Jm,state:n.state,log:n.log,initialState:n.initialState,clientOnly:!0}),MS=(n,e,t,r)=>({type:e6,prevStateID:n,stateID:e,patch:t,deltalog:r,clientOnly:!0}),$S=(n,e)=>({type:Zm,state:n,deltalog:e,clientOnly:!0}),US=n=>({type:Xm,state:n,clientOnly:!0}),FS=(n,e)=>({type:tp,payload:{type:null,args:null,playerID:n,credentials:e}}),zS=(n,e)=>({type:ep,payload:{type:null,args:null,playerID:n,credentials:e}}),jO=(n,e,t,r)=>({type:PS,payload:{type:n,args:e,playerID:t,credentials:r}}),VS=()=>({type:np});var YO=Object.freeze({__proto__:null,makeMove:OS,gameEvent:Ad,automaticGameEvent:LS,sync:BS,patch:MS,update:$S,reset:US,undo:FS,redo:zS,plugin:jO,stripTransients:VS});const ec="INVALID_MOVE",QO={name:"plugin-immer",fnWrap:n=>(e,...t)=>{let r=!1;const i=VO(e.G,s=>{const o=n({...e,G:s},...t);if(o===ec){r=!0;return}return o});return r?ec:i}};var pn;(function(n){n.MOVE="MOVE",n.GAME_ON_END="GAME_ON_END",n.PHASE_ON_BEGIN="PHASE_ON_BEGIN",n.PHASE_ON_END="PHASE_ON_END",n.TURN_ON_BEGIN="TURN_ON_BEGIN",n.TURN_ON_MOVE="TURN_ON_MOVE",n.TURN_ON_END="TURN_ON_END"})(pn||(pn={}));var ss;(function(n){n.CalledOutsideHook="Events must be called from moves or the `onBegin`, `onEnd`, and `onMove` hooks.\nThis error probably means you called an event from other game code, like an `endIf` trigger or one of the `turn.order` methods.",n.EndTurnInOnEnd="`endTurn` is disallowed in `onEnd` hooks  the turn is already ending.",n.MaxTurnEndings=`Maximum number of turn endings exceeded for this update.
This likely means game code is triggering an infinite loop.`,n.PhaseEventInOnEnd="`setPhase` & `endPhase` are disallowed in a phases `onEnd` hook  the phase is already ending.\nIf youre trying to dynamically choose the next phase when a phase ends, use the phases `next` trigger.",n.StageEventInOnEnd="`setStage`, `endStage` & `setActivePlayers` are disallowed in `onEnd` hooks.",n.StageEventInPhaseBegin="`setStage`, `endStage` & `setActivePlayers` are disallowed in a phases `onBegin` hook.\nUse `setActivePlayers` in a `turn.onBegin` hook or declare stages with `turn.activePlayers` instead.",n.StageEventInTurnBegin="`setStage` & `endStage` are disallowed in `turn.onBegin`.\nUse `setActivePlayers` or declare stages with `turn.activePlayers` instead."})(ss||(ss={}));class XO{constructor(e,t,r){this.flow=e,this.playerID=r,this.dispatch=[],this.initialTurn=t.turn,this.updateTurnContext(t,void 0),this.maxEndedTurnsPerAction=t.numPlayers*100}api(){const e={_private:this};for(const t of this.flow.eventNames)e[t]=(...r)=>{this.dispatch.push({type:t,args:r,phase:this.currentPhase,turn:this.currentTurn,calledFrom:this.currentMethod,error:new Error("Events Plugin Error")})};return e}isUsed(){return this.dispatch.length>0}updateTurnContext(e,t){this.currentPhase=e.phase,this.currentTurn=e.turn,this.currentMethod=t}unsetCurrentMethod(){this.currentMethod=void 0}update(e){const t=e,r=({stack:i},s)=>({...t,plugins:{...t.plugins,events:{...t.plugins.events,data:{error:s+`
`+i}}}});e:for(let i=0;i<this.dispatch.length;i++){const s=this.dispatch[i],o=s.turn!==e.ctx.turn;if(this.currentTurn-this.initialTurn>=this.maxEndedTurnsPerAction)return r(s.error,ss.MaxTurnEndings);if(s.calledFrom===void 0)return r(s.error,ss.CalledOutsideHook);if(e.ctx.gameover)break e;switch(s.type){case"endStage":case"setStage":case"setActivePlayers":{switch(s.calledFrom){case pn.TURN_ON_END:case pn.PHASE_ON_END:return r(s.error,ss.StageEventInOnEnd);case pn.PHASE_ON_BEGIN:return r(s.error,ss.StageEventInPhaseBegin);case pn.TURN_ON_BEGIN:if(s.type==="setActivePlayers")break;return r(s.error,ss.StageEventInTurnBegin)}if(o)continue e;break}case"endTurn":{if(s.calledFrom===pn.TURN_ON_END||s.calledFrom===pn.PHASE_ON_END)return r(s.error,ss.EndTurnInOnEnd);if(o)continue e;break}case"endPhase":case"setPhase":{if(s.calledFrom===pn.PHASE_ON_END)return r(s.error,ss.PhaseEventInOnEnd);if(s.phase!==e.ctx.phase)continue e;break}}const l=LS(s.type,s.args,this.playerID);e=this.flow.processEvent(e,l)}return e}}const t6={name:"events",noClient:({api:n})=>n._private.isUsed(),isInvalid:({data:n})=>n.error||!1,fnWrap:(n,e)=>(t,...r)=>{const i=t.events;i&&i._private.updateTurnContext(t.ctx,e);const s=n(t,...r);return i&&i._private.unsetCurrentMethod(),s},dangerouslyFlushRawState:({state:n,api:e})=>e._private.update(n),api:({game:n,ctx:e,playerID:t})=>new XO(n.flow,e,t).api()},JO={name:"log",flush:()=>({}),api:({data:n})=>({setMetadata:e=>{n.metadata=e}}),setup:()=>({})},ZO={name:"plugin-serializable",fnWrap:n=>(e,...t)=>n(e,...t)},eL=(...n)=>console.error(...n);function Ge(n){eL("ERROR:",n)}const n6=[QO,WO,JO,ZO],Hh=[...n6,t6],tL=(n,e,t)=>(t.game.plugins.filter(r=>r.action!==void 0).filter(r=>r.name===e.payload.type).forEach(r=>{const i=r.name,s=n.plugins[i]||{data:{}},o=r.action(s.data,e.payload);n={...n,plugins:{...n.plugins,[i]:{...s,data:o}}}}),n),Ic=({plugins:n})=>Object.entries(n||{}).reduce((e,[t,{api:r}])=>(e[t]=r,e),{}),HS=(n,e,t)=>[...n6,...t,t6].filter(r=>r.fnWrap!==void 0).reduce((r,{fnWrap:i})=>i(r,e),n),nL=(n,e)=>([...Hh,...e.game.plugins].filter(t=>t.setup!==void 0).forEach(t=>{const r=t.name,i=t.setup({G:n.G,ctx:n.ctx,game:e.game});n={...n,plugins:{...n.plugins,[r]:{data:i}}}}),n),b4=(n,e)=>([...Hh,...e.game.plugins].filter(t=>t.api!==void 0).forEach(t=>{const r=t.name,i=n.plugins[r]||{data:{}},s=t.api({G:n.G,ctx:n.ctx,data:i.data,game:e.game,playerID:e.playerID});n={...n,plugins:{...n.plugins,[r]:{...i,api:s}}}}),n),rL=(n,e)=>([...n6,...e.game.plugins,t6].reverse().forEach(t=>{const r=t.name,i=n.plugins[r]||{data:{}};if(t.flush){const s=t.flush({G:n.G,ctx:n.ctx,game:e.game,api:i.api,data:i.data});n={...n,plugins:{...n.plugins,[t.name]:{data:s}}}}else if(t.dangerouslyFlushRawState){n=t.dangerouslyFlushRawState({state:n,game:e.game,api:i.api,data:i.data});const s=n.plugins[r].data;n={...n,plugins:{...n.plugins,[t.name]:{data:s}}}}}),n),iL=(n,e)=>[...Hh,...e.game.plugins].filter(t=>t.noClient!==void 0).map(t=>{const r=t.name,i=n.plugins[r];return i?t.noClient({G:n.G,ctx:n.ctx,game:e.game,api:i.api,data:i.data}):!1}).includes(!0),sL=(n,e)=>[...Hh,...e.game.plugins].filter(r=>r.isInvalid!==void 0).map(r=>{const{name:i}=r,s=n.plugins[i],o=r.isInvalid({G:n.G,ctx:n.ctx,game:e.game,data:s&&s.data});return o?{plugin:i,message:o}:!1}).find(r=>r)||!1,KS=(n,e)=>{const t=rL(n,e),r=sL(t,e);if(!r)return[t];const{plugin:i,message:s}=r;return Ge(`${i} plugin declared action invalid:
${s}`),[n,r]},WS=({G:n,ctx:e,plugins:t={}},{game:r,playerID:i})=>([...Hh,...r.plugins].forEach(({name:s,playerView:o})=>{if(!o)return;const{data:a}=t[s]||{data:{}},l=o({G:n,ctx:e,game:r,data:a,playerID:i});t={...t,[s]:{data:l}}}),t);function S0(n,e=!1){n.moveLimit&&(e&&(n.minMoves=n.moveLimit),n.maxMoves=n.moveLimit,delete n.moveLimit)}function x0(n,e){let t={},r=[],i=null,s={},o={};if(Array.isArray(e)){const l={};e.forEach(c=>l[c]=k0.NULL),t=l}else{if(S0(e),e.next&&(i=e.next),e.revert&&(r=[...n._prevActivePlayers,{activePlayers:n.activePlayers,_activePlayersMinMoves:n._activePlayersMinMoves,_activePlayersMaxMoves:n._activePlayersMaxMoves,_activePlayersNumMoves:n._activePlayersNumMoves}]),e.currentPlayer!==void 0&&Nf(t,s,o,n.currentPlayer,e.currentPlayer),e.others!==void 0)for(let l=0;l<n.playOrder.length;l++){const c=n.playOrder[l];c!==n.currentPlayer&&Nf(t,s,o,c,e.others)}if(e.all!==void 0)for(let l=0;l<n.playOrder.length;l++){const c=n.playOrder[l];Nf(t,s,o,c,e.all)}if(e.value)for(const l in e.value)Nf(t,s,o,l,e.value[l]);if(e.minMoves)for(const l in t)s[l]===void 0&&(s[l]=e.minMoves);if(e.maxMoves)for(const l in t)o[l]===void 0&&(o[l]=e.maxMoves)}Object.keys(t).length===0&&(t=null),Object.keys(s).length===0&&(s=null),Object.keys(o).length===0&&(o=null);const a={};for(const l in t)a[l]=0;return{...n,activePlayers:t,_activePlayersMinMoves:s,_activePlayersMaxMoves:o,_activePlayersNumMoves:a,_prevActivePlayers:r,_nextActivePlayers:i}}function oL(n){let{activePlayers:e,_activePlayersMinMoves:t,_activePlayersMaxMoves:r,_activePlayersNumMoves:i,_prevActivePlayers:s,_nextActivePlayers:o}=n;if(e&&Object.keys(e).length===0)if(o)n=x0(n,o),{activePlayers:e,_activePlayersMinMoves:t,_activePlayersMaxMoves:r,_activePlayersNumMoves:i,_prevActivePlayers:s}=n;else if(s.length>0){const a=s.length-1;({activePlayers:e,_activePlayersMinMoves:t,_activePlayersMaxMoves:r,_activePlayersNumMoves:i}=s[a]),s=s.slice(0,a)}else e=null,t=null,r=null;return{...n,activePlayers:e,_activePlayersMinMoves:t,_activePlayersMaxMoves:r,_activePlayersNumMoves:i,_prevActivePlayers:s}}function Nf(n,e,t,r,i){(typeof i!="object"||i===k0.NULL)&&(i={stage:i}),i.stage!==void 0&&(S0(i),n[r]=i.stage,i.minMoves&&(e[r]=i.minMoves),i.maxMoves&&(t[r]=i.maxMoves))}function _4(n,e){return n[e]+""}function aL(n,e){let{G:t,ctx:r}=n;const{numPlayers:i}=r,o={...Ic(n),G:t,ctx:r},a=e.order;let l=[...Array.from({length:i})].map((f,p)=>p+"");a.playOrder!==void 0&&(l=a.playOrder(o));const c=a.first(o),u=typeof c;u!=="number"&&Ge(`invalid value returned by turn.order.first  expected number got ${u} ${c}.`);const d=_4(l,c);return r={...r,currentPlayer:d,playOrderPos:c,playOrder:l},r=x0(r,e.activePlayers||{}),r}function lL(n,e,t,r){const i=t.order;let{G:s,ctx:o}=n,a=o.playOrderPos,l=!1;if(r&&r!==!0)typeof r!="object"&&Ge(`invalid argument to endTurn: ${r}`),Object.keys(r).forEach(c=>{switch(c){case"remove":e=_4(o.playOrder,a);break;case"next":a=o.playOrder.indexOf(r.next),e=r.next;break;default:Ge(`invalid argument to endTurn: ${c}`)}});else{const u={...Ic(n),G:s,ctx:o},d=i.next(u),f=typeof d;d!==void 0&&f!=="number"&&Ge(`invalid value returned by turn.order.next  expected number or undefined got ${f} ${d}.`),d===void 0?l=!0:(a=d,e=_4(o.playOrder,a))}return o={...o,playOrderPos:a,currentPlayer:e},{endPhase:l,ctx:o}}const cL={DEFAULT:{first:({ctx:n})=>n.turn===0?n.playOrderPos:(n.playOrderPos+1)%n.playOrder.length,next:({ctx:n})=>(n.playOrderPos+1)%n.playOrder.length}},k0={NULL:null};var r6={},bs={};Object.defineProperty(bs,"__esModule",{value:!0});bs.Pointer=bs.escapeToken=bs.unescapeToken=void 0;function GS(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}bs.unescapeToken=GS;function qS(n){return n.replace(/~/g,"~0").replace(/\//g,"~1")}bs.escapeToken=qS;var uL=function(){function n(e){e===void 0&&(e=[""]),this.tokens=e}return n.fromJSON=function(e){var t=e.split("/").map(GS);if(t[0]!=="")throw new Error("Invalid JSON Pointer: ".concat(e));return new n(t)},n.prototype.toString=function(){return this.tokens.map(qS).join("/")},n.prototype.evaluate=function(e){for(var t=null,r="",i=e,s=1,o=this.tokens.length;s<o;s++)t=i,r=this.tokens[s],!(r=="__proto__"||r=="constructor"||r=="prototype")&&(i=(t||{})[r]);return{parent:t,key:r,value:i}},n.prototype.get=function(e){return this.evaluate(e).value},n.prototype.set=function(e,t){var r=this.evaluate(e);r.parent&&(r.parent[r.key]=t)},n.prototype.push=function(e){this.tokens.push(e)},n.prototype.add=function(e){var t=this.tokens.concat(String(e));return new n(t)},n}();bs.Pointer=uL;var wt={},i6={};(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.clone=n.objectType=n.hasOwnProperty=void 0,n.hasOwnProperty=Object.prototype.hasOwnProperty;function e(i){return i===void 0?"undefined":i===null?"null":Array.isArray(i)?"array":typeof i}n.objectType=e;function t(i){return i!=null&&typeof i=="object"}function r(i){if(!t(i))return i;if(i.constructor==Array){for(var s=i.length,o=new Array(s),a=0;a<s;a++)o[a]=r(i[a]);return o}if(i.constructor==Date){var l=new Date(+i);return l}var c={};for(var u in i)n.hasOwnProperty.call(i,u)&&(c[u]=r(i[u]));return c}n.clone=r})(i6);var Cn={};Object.defineProperty(Cn,"__esModule",{value:!0});Cn.diffAny=Cn.diffObjects=Cn.diffArrays=Cn.intersection=Cn.subtract=Cn.isDestructive=void 0;var ih=i6;function dL(n){var e=n.op;return e==="remove"||e==="replace"||e==="copy"||e==="move"}Cn.isDestructive=dL;function S4(n,e){var t={};for(var r in n)ih.hasOwnProperty.call(n,r)&&n[r]!==void 0&&(t[r]=1);for(var i in e)ih.hasOwnProperty.call(e,i)&&e[i]!==void 0&&delete t[i];return Object.keys(t)}Cn.subtract=S4;function jS(n){for(var e=n.length,t={},r=0;r<e;r++){var i=n[r];for(var s in i)ih.hasOwnProperty.call(i,s)&&i[s]!==void 0&&(t[s]=(t[s]||0)+1)}for(var s in t)t[s]<e&&delete t[s];return Object.keys(t)}Cn.intersection=jS;function hL(n){return n.op==="add"}function fL(n){return n.op==="remove"}function Cg(n,e){return{operations:n.operations.concat(e),cost:n.cost+1}}function YS(n,e,t,r){r===void 0&&(r=rp);var i={"0,0":{operations:[],cost:0}};function s(u,d){var f="".concat(u,",").concat(d),p=i[f];if(p===void 0){if(u>0&&d>0&&!r(n[u-1],e[d-1],t.add(String(u-1))).length)p=s(u-1,d-1);else{var y=[];if(u>0){var g=s(u-1,d),w={op:"remove",index:u-1};y.push(Cg(g,w))}if(d>0){var m=s(u,d-1),E={op:"add",index:u-1,value:e[d-1]};y.push(Cg(m,E))}if(u>0&&d>0){var v=s(u-1,d-1),b={op:"replace",index:u-1,original:n[u-1],value:e[d-1]};y.push(Cg(v,b))}var k=y.sort(function(A,T){return A.cost-T.cost})[0];p=k}i[f]=p}return p}var o=isNaN(n.length)||n.length<=0?0:n.length,a=isNaN(e.length)||e.length<=0?0:e.length,l=s(o,a).operations,c=l.reduce(function(u,d){var f=u[0],p=u[1];if(hL(d)){var y=d.index+1+p,g=y<o+p?String(y):"-",w={op:d.op,path:t.add(g).toString(),value:d.value};return[f.concat(w),p+1]}else if(fL(d)){var w={op:d.op,path:t.add(String(d.index+p)).toString()};return[f.concat(w),p-1]}else{var m=t.add(String(d.index+p)),E=r(d.original,d.value,m);return[f.concat.apply(f,E),p]}},[[],0])[0];return c}Cn.diffArrays=YS;function QS(n,e,t,r){r===void 0&&(r=rp);var i=[];return S4(n,e).forEach(function(s){i.push({op:"remove",path:t.add(s).toString()})}),S4(e,n).forEach(function(s){i.push({op:"add",path:t.add(s).toString(),value:e[s]})}),jS([n,e]).forEach(function(s){i.push.apply(i,r(n[s],e[s],t.add(s)))}),i}Cn.diffObjects=QS;function rp(n,e,t,r){if(r===void 0&&(r=rp),n===e)return[];var i=(0,ih.objectType)(n),s=(0,ih.objectType)(e);return i=="array"&&s=="array"?YS(n,e,t,r):i=="object"&&s=="object"?QS(n,e,t,r):[{op:"replace",path:t.toString(),value:e}]}Cn.diffAny=rp;var s6=Aa&&Aa.__extends||function(){var n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,i){r.__proto__=i}||function(r,i){for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(r[s]=i[s])},n(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");n(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperty(wt,"__esModule",{value:!0});wt.apply=wt.InvalidOperationError=wt.test=wt.copy=wt.move=wt.replace=wt.remove=wt.add=wt.TestError=wt.MissingError=void 0;var Ts=bs,o6=i6,pL=Cn,Fi=function(n){s6(e,n);function e(t){var r=n.call(this,"Value required at path: ".concat(t))||this;return r.path=t,r.name="MissingError",r}return e}(Error);wt.MissingError=Fi;var XS=function(n){s6(e,n);function e(t,r){var i=n.call(this,"Test failed: ".concat(t," != ").concat(r))||this;return i.actual=t,i.expected=r,i.name="TestError",i}return e}(Error);wt.TestError=XS;function a6(n,e,t){if(Array.isArray(n))if(e=="-")n.push(t);else{var r=parseInt(e,10);n.splice(r,0,t)}else n[e]=t}function JS(n,e){if(Array.isArray(n)){var t=parseInt(e,10);n.splice(t,1)}else delete n[e]}function ZS(n,e){var t=Ts.Pointer.fromJSON(e.path).evaluate(n);return t.parent===void 0?new Fi(e.path):(a6(t.parent,t.key,(0,o6.clone)(e.value)),null)}wt.add=ZS;function ex(n,e){var t=Ts.Pointer.fromJSON(e.path).evaluate(n);return t.value===void 0?new Fi(e.path):(JS(t.parent,t.key),null)}wt.remove=ex;function tx(n,e){var t=Ts.Pointer.fromJSON(e.path).evaluate(n);if(t.parent===null)return new Fi(e.path);if(Array.isArray(t.parent)){if(parseInt(t.key,10)>=t.parent.length)return new Fi(e.path)}else if(t.value===void 0)return new Fi(e.path);return t.parent[t.key]=(0,o6.clone)(e.value),null}wt.replace=tx;function nx(n,e){var t=Ts.Pointer.fromJSON(e.from).evaluate(n);if(t.value===void 0)return new Fi(e.from);var r=Ts.Pointer.fromJSON(e.path).evaluate(n);return r.parent===void 0?new Fi(e.path):(JS(t.parent,t.key),a6(r.parent,r.key,t.value),null)}wt.move=nx;function rx(n,e){var t=Ts.Pointer.fromJSON(e.from).evaluate(n);if(t.value===void 0)return new Fi(e.from);var r=Ts.Pointer.fromJSON(e.path).evaluate(n);return r.parent===void 0?new Fi(e.path):(a6(r.parent,r.key,(0,o6.clone)(t.value)),null)}wt.copy=rx;function ix(n,e){var t=Ts.Pointer.fromJSON(e.path).evaluate(n);return(0,pL.diffAny)(t.value,e.value,new Ts.Pointer).length?new XS(t.value,e.value):null}wt.test=ix;var sx=function(n){s6(e,n);function e(t){var r=n.call(this,"Invalid operation: ".concat(t.op))||this;return r.operation=t,r.name="InvalidOperationError",r}return e}(Error);wt.InvalidOperationError=sx;function gL(n,e){switch(e.op){case"add":return ZS(n,e);case"remove":return ex(n,e);case"replace":return tx(n,e);case"move":return nx(n,e);case"copy":return rx(n,e);case"test":return ix(n,e)}return new sx(e)}wt.apply=gL;(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.createTests=n.createPatch=n.applyPatch=n.Pointer=void 0;var e=bs;Object.defineProperty(n,"Pointer",{enumerable:!0,get:function(){return e.Pointer}});var t=wt,r=Cn;function i(c,u){return u.map(function(d){return(0,t.apply)(c,d)})}n.applyPatch=i;function s(c){function u(d,f,p){var y=c(d,f,p);return Array.isArray(y)?y:(0,r.diffAny)(d,f,p,u)}return u}function o(c,u,d){var f=new e.Pointer;return(d?s(d):r.diffAny)(c,u,f)}n.createPatch=o;function a(c,u){var d=e.Pointer.fromJSON(u).evaluate(c);if(d!==void 0)return{op:"test",path:u,value:d.value}}function l(c,u){var d=new Array;return u.filter(r.isDestructive).forEach(function(f){var p=a(c,f.path);if(p&&d.push(p),"from"in f){var y=a(c,f.from);y&&d.push(y)}}),d}n.createTests=l})(r6);function yL({moves:n,phases:e,endIf:t,onEnd:r,turn:i,events:s,plugins:o}){n===void 0&&(n={}),s===void 0&&(s={}),o===void 0&&(o=[]),e===void 0&&(e={}),t||(t=()=>{}),r||(r=({G:D})=>D),i||(i={});const a={...e};""in a&&Ge("cannot specify phase with empty name"),a[""]={};const l={},c=new Set;let u=null;Object.keys(n).forEach(D=>c.add(D));const d=(D,F)=>{const W=HS(D,F,o);return ve=>{const de=Ic(ve);return W({...de,G:ve.G,ctx:ve.ctx,playerID:ve.playerID})}},f=D=>F=>{const W=Ic(F);return D({...W,G:F.G,ctx:F.ctx})},p={onEnd:d(r,pn.GAME_ON_END),endIf:f(t)};for(const D in a){const F=a[D];if(F.start===!0&&(u=D),F.moves!==void 0)for(const W of Object.keys(F.moves))l[D+"."+W]=F.moves[W],c.add(W);F.endIf===void 0&&(F.endIf=()=>{}),F.onBegin===void 0&&(F.onBegin=({G:W})=>W),F.onEnd===void 0&&(F.onEnd=({G:W})=>W),F.turn===void 0&&(F.turn=i),F.turn.order===void 0&&(F.turn.order=cL.DEFAULT),F.turn.onBegin===void 0&&(F.turn.onBegin=({G:W})=>W),F.turn.onEnd===void 0&&(F.turn.onEnd=({G:W})=>W),F.turn.endIf===void 0&&(F.turn.endIf=()=>!1),F.turn.onMove===void 0&&(F.turn.onMove=({G:W})=>W),F.turn.stages===void 0&&(F.turn.stages={}),S0(F.turn,!0);for(const W in F.turn.stages){const de=F.turn.stages[W].moves||{};for(const ge of Object.keys(de)){const rt=D+"."+W+"."+ge;l[rt]=de[ge],c.add(ge)}}if(F.wrapped={onBegin:d(F.onBegin,pn.PHASE_ON_BEGIN),onEnd:d(F.onEnd,pn.PHASE_ON_END),endIf:f(F.endIf)},F.turn.wrapped={onMove:d(F.turn.onMove,pn.TURN_ON_MOVE),onBegin:d(F.turn.onBegin,pn.TURN_ON_BEGIN),onEnd:d(F.turn.onEnd,pn.TURN_ON_END),endIf:f(F.turn.endIf)},typeof F.next!="function"){const{next:W}=F;F.next=()=>W||null}F.wrapped.next=f(F.next)}function y(D){return D.phase?a[D.phase]:a[""]}function g(D){return D}function w(D,F){const W=new Set,ve=new Set;for(let de=0;de<F.length;de++){const{fn:ge,arg:rt,...it}=F[de];if(ge===z){ve.clear();const _n=D.ctx.phase;if(W.has(_n)){const gi={...D.ctx,phase:null};return{...D,ctx:gi}}W.add(_n)}const mr=[];if(D=ge(D,{...it,arg:rt,next:mr}),ge===V)break;const It=P(D);if(It){F.push({fn:V,arg:It,turn:D.ctx.turn,phase:D.ctx.phase,automatic:!0});continue}const Wt=_(D);if(Wt){F.push({fn:z,arg:Wt,turn:D.ctx.turn,phase:D.ctx.phase,automatic:!0});continue}if([g,A,T].includes(ge)){const _n=N(D);if(_n){F.push({fn:R,arg:_n,turn:D.ctx.turn,phase:D.ctx.phase,automatic:!0});continue}}F.push(...mr)}return D}function m(D,{next:F}){return F.push({fn:E}),D}function E(D,{next:F}){let{G:W,ctx:ve}=D;return W=y(ve).wrapped.onBegin(D),F.push({fn:v}),{...D,G:W,ctx:ve}}function v(D,{currentPlayer:F}){let{ctx:W}=D;const ve=y(W);F?(W={...W,currentPlayer:F},ve.turn.activePlayers&&(W=x0(W,ve.turn.activePlayers))):W=aL(D,ve.turn);const de=W.turn+1;W={...W,turn:de,numMoves:0,_prevActivePlayers:[]};const ge=ve.turn.wrapped.onBegin({...D,ctx:W});return{...D,G:ge,ctx:W,_undo:[],_redo:[]}}function b(D,{arg:F,next:W,phase:ve}){const de=y({phase:ve});let{ctx:ge}=D;if(F&&F.next)if(F.next in a)ge={...ge,phase:F.next};else return Ge("invalid phase: "+F.next),D;else ge={...ge,phase:de.wrapped.next(D)||null};return D={...D,ctx:ge},W.push({fn:E}),D}function k(D,{arg:F,currentPlayer:W,next:ve}){let{G:de,ctx:ge}=D;const rt=y(ge),{endPhase:it,ctx:mr}=lL(D,W,rt.turn,F);return ge=mr,D={...D,G:de,ctx:ge},it?ve.push({fn:z,turn:ge.turn,phase:ge.phase}):ve.push({fn:v,currentPlayer:ge.currentPlayer}),D}function A(D,{arg:F,playerID:W}){if((typeof F=="string"||F===k0.NULL)&&(F={stage:F}),typeof F!="object")return D;S0(F);let{ctx:ve}=D,{activePlayers:de,_activePlayersMinMoves:ge,_activePlayersMaxMoves:rt,_activePlayersNumMoves:it}=ve;return F.stage!==void 0&&(de===null&&(de={}),de[W]=F.stage,it[W]=0,F.minMoves&&(ge===null&&(ge={}),ge[W]=F.minMoves),F.maxMoves&&(rt===null&&(rt={}),rt[W]=F.maxMoves)),ve={...ve,activePlayers:de,_activePlayersMinMoves:ge,_activePlayersMaxMoves:rt,_activePlayersNumMoves:it},{...D,ctx:ve}}function T(D,{arg:F}){return{...D,ctx:x0(D.ctx,F)}}function P(D){return p.endIf(D)}function _(D){return y(D.ctx).wrapped.endIf(D)}function N(D){const F=y(D.ctx),W=D.ctx.numMoves||0;return F.turn.maxMoves&&W>=F.turn.maxMoves?!0:F.turn.wrapped.endIf(D)}function V(D,{arg:F,phase:W}){D=z(D,{}),F===void 0&&(F=!0),D={...D,ctx:{...D.ctx,gameover:F}};const ve=p.onEnd(D);return{...D,G:ve}}function z(D,{arg:F,next:W,turn:ve,automatic:de}){D=R(D,{turn:ve,force:!0,automatic:!0});const{phase:ge,turn:rt}=D.ctx;if(W&&W.push({fn:b,arg:F,phase:ge}),ge===null)return D;const mr=y(D.ctx).wrapped.onEnd(D),It={...D.ctx,phase:null},Wt=Ad("endPhase",F),{_stateID:_n}=D,gi={action:Wt,_stateID:_n,turn:rt,phase:ge};de&&(gi.automatic=!0);const qo=[...D.deltalog||[],gi];return{...D,G:mr,ctx:It,deltalog:qo}}function R(D,{arg:F,next:W,turn:ve,force:de,automatic:ge,playerID:rt}){if(ve!==D.ctx.turn)return D;const{currentPlayer:it,numMoves:mr,phase:It,turn:Wt}=D.ctx,_n=y(D.ctx),gi=mr||0;if(!de&&_n.turn.minMoves&&gi<_n.turn.minMoves)return`${_n.turn.minMoves}`,D;const qo=_n.turn.wrapped.onEnd(D);W&&W.push({fn:k,arg:F,currentPlayer:it});let zs={...D.ctx,activePlayers:null};if(F&&F.remove){rt=rt||it;const jo=zs.playOrder.filter(eD=>eD!=rt),ZN=zs.playOrderPos>jo.length-1?0:zs.playOrderPos;if(zs={...zs,playOrder:jo,playOrderPos:ZN},jo.length===0)return W.push({fn:z,turn:Wt,phase:It}),D}const Qp=Ad("endTurn",F),{_stateID:g8}=D,Bu={action:Qp,_stateID:g8,turn:Wt,phase:It};ge&&(Bu.automatic=!0);const Xp=[...D.deltalog||[],Bu];return{...D,G:qo,ctx:zs,deltalog:Xp,_undo:[],_redo:[]}}function C(D,{arg:F,next:W,automatic:ve,playerID:de}){de=de||D.ctx.currentPlayer;let{ctx:ge,_stateID:rt}=D,{activePlayers:it,_activePlayersNumMoves:mr,_activePlayersMinMoves:It,_activePlayersMaxMoves:Wt,phase:_n,turn:gi}=ge;const qo=it!==null&&de in it,zs=y(ge);if(!F&&qo){const jo=zs.turn.stages[it[de]];jo&&jo.next&&(F=jo.next)}if(W&&W.push({fn:A,arg:F,playerID:de}),!qo)return D;const Qp=mr[de]||0;if(It&&It[de]&&Qp<It[de])return`${It[de]}`,D;it={...it},delete it[de],It&&(It={...It},delete It[de]),Wt&&(Wt={...Wt},delete Wt[de]),ge=oL({...ge,activePlayers:it,_activePlayersMinMoves:It,_activePlayersMaxMoves:Wt});const Bu={action:Ad("endStage",F),_stateID:rt,turn:gi,phase:_n};ve&&(Bu.automatic=!0);const Xp=[...D.deltalog||[],Bu];return{...D,ctx:ge,deltalog:Xp}}function x(D,F,W){const ve=y(D),de=ve.turn.stages,{activePlayers:ge}=D;if(ge&&ge[W]!==void 0&&ge[W]!==k0.NULL&&de[ge[W]]!==void 0&&de[ge[W]].moves!==void 0){const it=de[ge[W]].moves;if(F in it)return it[F]}else if(ve.moves){if(F in ve.moves)return ve.moves[F]}else if(F in n)return n[F];return null}function M(D,F){const{playerID:W,type:ve}=F,{currentPlayer:de,activePlayers:ge,_activePlayersMaxMoves:rt}=D.ctx,it=x(D.ctx,ve,W),mr=!it||typeof it=="function"||it.noLimit!==!0;let{numMoves:It,_activePlayersNumMoves:Wt}=D.ctx;mr&&(W===de&&It++,ge&&Wt[W]++),D={...D,ctx:{...D.ctx,numMoves:It,_activePlayersNumMoves:Wt}},rt&&Wt[W]>=rt[W]&&(D=C(D,{playerID:W,automatic:!0}));const gi=y(D.ctx).turn.wrapped.onMove({...D,playerID:W});return D={...D,G:gi},w(D,[{fn:g}])}function K(D,F,W){return w(D,[{fn:C,arg:W,playerID:F}])}function L(D,F){return w(D,[{fn:C,playerID:F}])}function O(D,F,W){return w(D,[{fn:T,arg:W}])}function H(D,F,W){return w(D,[{fn:z,phase:D.ctx.phase,turn:D.ctx.turn,arg:{next:W}}])}function G(D){return w(D,[{fn:z,phase:D.ctx.phase,turn:D.ctx.turn}])}function j(D,F,W){return w(D,[{fn:R,turn:D.ctx.turn,phase:D.ctx.phase,arg:W}])}function be(D,F,W){return w(D,[{fn:R,turn:D.ctx.turn,phase:D.ctx.phase,force:!0,arg:W}])}function Ee(D,F,W){return w(D,[{fn:V,turn:D.ctx.turn,phase:D.ctx.phase,arg:W}])}const pe={endStage:L,setStage:K,endTurn:j,pass:be,endPhase:G,setPhase:H,endGame:Ee,setActivePlayers:O},we=[];s.endTurn!==!1&&we.push("endTurn"),s.pass!==!1&&we.push("pass"),s.endPhase!==!1&&we.push("endPhase"),s.setPhase!==!1&&we.push("setPhase"),s.endGame!==!1&&we.push("endGame"),s.setActivePlayers!==!1&&we.push("setActivePlayers"),s.endStage!==!1&&we.push("endStage"),s.setStage!==!1&&we.push("setStage");function Ie(D,F){const{type:W,playerID:ve,args:de}=F.payload;return typeof pe[W]!="function"?D:pe[W](D,ve,...Array.isArray(de)?de:[de])}function Ze(D,F,W){return F.activePlayers?W in F.activePlayers:F.currentPlayer===W}return{ctx:D=>({numPlayers:D,turn:0,currentPlayer:"0",playOrder:[...Array.from({length:D})].map((F,W)=>W+""),playOrderPos:0,phase:u,activePlayers:null}),init:D=>w(D,[{fn:m}]),isPlayerActive:Ze,eventHandlers:pe,eventNames:Object.keys(pe),enabledEventNames:we,moveMap:l,moveNames:[...c.values()],processMove:M,processEvent:Ie,getMove:x}}function mL(n){return n.processMove!==void 0}function ip(n){if(mL(n))return n;if(n.name===void 0&&(n.name="default"),n.deltaState===void 0&&(n.deltaState=!1),n.disableUndo===void 0&&(n.disableUndo=!1),n.setup===void 0&&(n.setup=()=>({})),n.moves===void 0&&(n.moves={}),n.playerView===void 0&&(n.playerView=({G:t})=>t),n.plugins===void 0&&(n.plugins=[]),n.plugins.forEach(t=>{if(t.name===void 0)throw new Error("Plugin missing name attribute");if(t.name.includes(" "))throw new Error(t.name+": Plugin name must not include spaces")}),n.name.includes(" "))throw new Error(n.name+": Game name must not include spaces");const e=yL(n);return{...n,flow:e,moveNames:e.moveNames,pluginNames:n.plugins.map(t=>t.name),processMove:(t,r)=>{let i=e.getMove(t.ctx,r.type,r.playerID);if(ox(i)&&(i=i.move),i instanceof Function){const s=HS(i,pn.MOVE,n.plugins);let o=[];r.args!==void 0&&(o=Array.isArray(r.args)?r.args:[r.args]);const a={...Ic(t),G:t.G,ctx:t.ctx,playerID:r.playerID};return s(a,...o)}return Ge(`invalid move object: ${r.type}`),t.G}}}function ox(n){return n instanceof Object&&n.move!==void 0}var x4;(function(n){n.UnauthorizedAction="update/unauthorized_action",n.MatchNotFound="update/match_not_found",n.PatchFailed="update/patch_failed"})(x4||(x4={}));var un;(function(n){n.StaleStateId="action/stale_state_id",n.UnavailableMove="action/unavailable_move",n.InvalidMove="action/invalid_move",n.InactivePlayer="action/inactive_player",n.GameOver="action/gameover",n.ActionDisabled="action/action_disabled",n.ActionInvalid="action/action_invalid",n.PluginActionInvalid="action/plugin_invalid"})(un||(un={}));const Df=n=>n.payload.playerID!==null&&n.payload.playerID!==void 0,wL=(n,e,t)=>{function r(s){return s.undoable!==void 0}function i(s){return s instanceof Function}return r(t)?i(t.undoable)?t.undoable({G:n,ctx:e}):t.undoable:!0};function B7(n,e){if(e.game.disableUndo)return n;const t={G:n.G,ctx:n.ctx,plugins:n.plugins,playerID:e.action.payload.playerID||n.ctx.currentPlayer};return e.action.type==="MAKE_MOVE"&&(t.moveType=e.action.payload.type),{...n,_undo:[...n._undo,t],_redo:[]}}function Tg(n,e,t){const r={action:e,_stateID:n._stateID,turn:n.ctx.turn,phase:n.ctx.phase},i=n.plugins.log.data.metadata;return i!==void 0&&(r.metadata=i),typeof t=="object"&&t.redact===!0?r.redact=!0:typeof t=="object"&&t.redact instanceof Function&&(r.redact=t.redact({G:n.G,ctx:n.ctx})),{...n,deltalog:[r]}}function Ng(n,e,t){const[r,i]=KS(n,t);return i?[r,xn(e,un.PluginActionInvalid,i)]:[r]}function ax(n){if(!n)return[null,void 0];const{transients:e,...t}=n;return[t,e]}function xn(n,e,t){return{...n,transients:{error:{type:e,payload:t}}}}const lx=n=>e=>t=>{const r=e(t);switch(t.type){case np:return r;default:{const[,i]=ax(n.getState());return typeof i<"u"?(n.dispatch(VS()),{...r,transients:i}):r}}};function l6({game:n,isClient:e}){return n=ip(n),(t=null,r)=>{let[i]=ax(t);switch(r.type){case np:return i;case Z2:{if(i={...i,deltalog:[]},e)return i;if(i.ctx.gameover!==void 0)return Ge("cannot call event after game end"),xn(i,un.GameOver);if(Df(r)&&!n.flow.isPlayerActive(i.G,i.ctx,r.payload.playerID))return Ge(`disallowed event: ${r.payload.type}`),xn(i,un.InactivePlayer);i=b4(i,{game:n,playerID:r.payload.playerID});let s=n.flow.processEvent(i,r),o;return[s,o]=Ng(s,i,{game:n}),o||(s=B7(s,{game:n,action:r}),{...s,_stateID:i._stateID+1})}case rh:{const s=i={...i,deltalog:[]},o=n.flow.getMove(i.ctx,r.payload.type,r.payload.playerID||i.ctx.currentPlayer);if(o===null)return Ge(`disallowed move: ${r.payload.type}`),xn(i,un.UnavailableMove);if(e&&o.client===!1)return i;if(i.ctx.gameover!==void 0)return Ge("cannot make move after game end"),xn(i,un.GameOver);if(Df(r)&&!n.flow.isPlayerActive(i.G,i.ctx,r.payload.playerID))return Ge(`disallowed move: ${r.payload.type}`),xn(i,un.InactivePlayer);i=b4(i,{game:n,playerID:r.payload.playerID});const a=n.processMove(i,r.payload);if(a===ec)return Ge(`invalid move: ${r.payload.type} args: ${r.payload.args}`),xn(i,un.InvalidMove);const l={...i,G:a};if(e&&iL(l,{game:n}))return i;if(i=l,e){let u;return[i,u]=Ng(i,s,{game:n}),u||{...i,_stateID:i._stateID+1}}i=Tg(i,r,o),i=n.flow.processMove(i,r.payload);let c;return[i,c]=Ng(i,s,{game:n}),c||(i=B7(i,{game:n,action:r}),{...i,_stateID:i._stateID+1})}case Xm:case Zm:case Jm:return r.state;case tp:{if(i={...i,deltalog:[]},n.disableUndo)return Ge("Undo is not enabled"),xn(i,un.ActionDisabled);const{G:s,ctx:o,_undo:a,_redo:l,_stateID:c}=i;if(a.length<2)return Ge("No moves to undo"),xn(i,un.ActionInvalid);const u=a[a.length-1],d=a[a.length-2];if(Df(r)&&r.payload.playerID!==u.playerID)return Ge("Cannot undo other players' moves"),xn(i,un.ActionInvalid);if(u.moveType){const f=n.flow.getMove(d.ctx,u.moveType,u.playerID);if(!wL(s,o,f))return Ge("Move cannot be undone"),xn(i,un.ActionInvalid)}return i=Tg(i,r),{...i,G:d.G,ctx:d.ctx,plugins:d.plugins,_stateID:c+1,_undo:a.slice(0,-1),_redo:[u,...l]}}case ep:{if(i={...i,deltalog:[]},n.disableUndo)return Ge("Redo is not enabled"),xn(i,un.ActionDisabled);const{_undo:s,_redo:o,_stateID:a}=i;if(o.length===0)return Ge("No moves to redo"),xn(i,un.ActionInvalid);const l=o[0];return Df(r)&&r.payload.playerID!==l.playerID?(Ge("Cannot redo other players' moves"),xn(i,un.ActionInvalid)):(i=Tg(i,r),{...i,G:l.G,ctx:l.ctx,plugins:l.plugins,_stateID:a+1,_undo:[...s,l],_redo:o.slice(1)})}case PS:return tL(i,r,{game:n});case e6:{const s=i,o=JSON.parse(JSON.stringify(s)),a=r6.applyPatch(o,r.patch);return a.some(c=>c!==null)?(Ge(`Patch ${JSON.stringify(r.patch)} apply failed`),xn(s,x4.PatchFailed,a)):o}default:return i}}}(function(n,e){if(n.setImmediate)return;var t=1,r={},i=!1,s=n.document,o;function a(E){typeof E!="function"&&(E=new Function(""+E));for(var v=new Array(arguments.length-1),b=0;b<v.length;b++)v[b]=arguments[b+1];var k={callback:E,args:v};return r[t]=k,o(t),t++}function l(E){delete r[E]}function c(E){var v=E.callback,b=E.args;switch(b.length){case 0:v();break;case 1:v(b[0]);break;case 2:v(b[0],b[1]);break;case 3:v(b[0],b[1],b[2]);break;default:v.apply(e,b);break}}function u(E){if(i)setTimeout(u,0,E);else{var v=r[E];if(v){i=!0;try{c(v)}finally{l(E),i=!1}}}}function d(){o=function(E){process.nextTick(function(){u(E)})}}function f(){if(n.postMessage&&!n.importScripts){var E=!0,v=n.onmessage;return n.onmessage=function(){E=!1},n.postMessage("","*"),n.onmessage=v,E}}function p(){var E="setImmediate$"+Math.random()+"$",v=function(b){b.source===n&&typeof b.data=="string"&&b.data.indexOf(E)===0&&u(+b.data.slice(E.length))};n.addEventListener?n.addEventListener("message",v,!1):n.attachEvent("onmessage",v),o=function(b){n.postMessage(E+b,"*")}}function y(){var E=new MessageChannel;E.port1.onmessage=function(v){var b=v.data;u(b)},o=function(v){E.port2.postMessage(v)}}function g(){var E=s.documentElement;o=function(v){var b=s.createElement("script");b.onreadystatechange=function(){u(v),b.onreadystatechange=null,E.removeChild(b),b=null},E.appendChild(b)}}function w(){o=function(E){setTimeout(u,0,E)}}var m=Object.getPrototypeOf&&Object.getPrototypeOf(n);m=m&&m.setTimeout?m:n,{}.toString.call(n.process)==="[object process]"?d():f()?p():n.MessageChannel?y():s&&"onreadystatechange"in s.createElement("script")?g():w(),m.setImmediate=a,m.clearImmediate=l})(typeof self>"u"?Aa:self);class vL{constructor({enumerate:e,seed:t}){this.enumerateFn=e,this.seed=t,this.iterationCounter=0,this._opts={}}addOpt({key:e,range:t,initial:r}){this._opts[e]={range:t,value:r}}getOpt(e){return this._opts[e].value}setOpt(e,t){e in this._opts&&(this._opts[e].value=t)}opts(){return this._opts}enumerate(e,t,r){return this.enumerateFn(e,t,r).map(s=>{if("payload"in s)return s;if("move"in s)return OS(s.move,s.args,r);if("event"in s)return Ad(s.event,s.args,r)})}random(e){let t;if(this.seed!==void 0){const r=this.prngstate?"":this.seed,i=DS(r,this.prngstate);t=i(),this.prngstate=i.state()}else t=Math.random();if(e)if(Array.isArray(e)){const r=Math.floor(t*e.length);return e[r]}else return Math.floor(t*e);return t}}const EL=25;class bL extends vL{constructor({enumerate:e,seed:t,objectives:r,game:i,iterations:s,playoutDepth:o,iterationCallback:a}){super({enumerate:e,seed:t}),r===void 0&&(r=()=>({})),this.objectives=r,this.iterationCallback=a||(()=>{}),this.reducer=l6({game:i}),this.iterations=s,this.playoutDepth=o,this.addOpt({key:"async",initial:!1}),this.addOpt({key:"iterations",initial:typeof s=="number"?s:1e3,range:{min:1,max:2e3}}),this.addOpt({key:"playoutDepth",initial:typeof o=="number"?o:50,range:{min:1,max:100}})}createNode({state:e,parentAction:t,parent:r,playerID:i}){const{G:s,ctx:o}=e;let a=[],l=[];if(i!==void 0)a=this.enumerate(s,o,i),l=this.objectives(s,o,i);else if(o.activePlayers)for(const c in o.activePlayers)a.push(...this.enumerate(s,o,c)),l.push(this.objectives(s,o,c));else a=this.enumerate(s,o,o.currentPlayer),l=this.objectives(s,o,o.currentPlayer);return{state:e,parent:r,parentAction:t,actions:a,objectives:l,children:[],visits:0,value:0}}select(e){if(e.actions.length>0||e.children.length===0)return e;let t=null,r=0;for(const i of e.children){const s=i.visits+Number.EPSILON,o=i.value/s+Math.sqrt(2*Math.log(e.visits)/s);(t==null||o>r)&&(r=o,t=i)}return this.select(t)}expand(e){const t=e.actions;if(t.length===0||e.state.ctx.gameover!==void 0)return e;const r=this.random(t.length),i=t[r];e.actions.splice(r,1);const s=this.reducer(e.state,i),o=this.createNode({state:s,parentAction:i,parent:e});return e.children.push(o),o}playout({state:e}){let t=this.getOpt("playoutDepth");typeof this.playoutDepth=="function"&&(t=this.playoutDepth(e.G,e.ctx));for(let r=0;r<t&&e.ctx.gameover===void 0;r++){const{G:i,ctx:s}=e;let o=s.currentPlayer;s.activePlayers&&(o=Object.keys(s.activePlayers)[0]);const a=this.enumerate(i,s,o),l=this.objectives(i,s,o),c=Object.keys(l).reduce((f,p)=>{const y=l[p];return y.checker(i,s)?f+y.weight:f},0);if(c>0)return{score:c};if(!a||a.length===0)return;const u=this.random(a.length);e=this.reducer(e,a[u])}return e.ctx.gameover}backpropagate(e,t={}){e.visits++,t.score!==void 0&&(e.value+=t.score),t.draw===!0&&(e.value+=.5),e.parentAction&&t.winner===e.parentAction.payload.playerID&&e.value++,e.parent&&this.backpropagate(e.parent,t)}play(e,t){const r=this.createNode({state:e,playerID:t});let i=this.getOpt("iterations");typeof this.iterations=="function"&&(i=this.iterations(e.G,e.ctx));const s=()=>{let o=null;for(const c of r.children)(o==null||c.visits>o.visits)&&(o=c);return{action:o&&o.parentAction,metadata:r}};return new Promise(o=>{const a=()=>{for(let l=0;l<EL&&this.iterationCounter<i;l++){const c=this.select(r),u=this.expand(c),d=this.playout(u);this.backpropagate(u,d),this.iterationCounter++}this.iterationCallback({iterationCounter:this.iterationCounter,numIterations:i,metadata:r})};if(this.iterationCounter=0,this.getOpt("async")){const l=()=>{this.iterationCounter<i?(a(),setImmediate(l)):o(s())};l()}else{for(;this.iterationCounter<i;)a();o(s())}})}}function sh(n){"@babel/helpers - typeof";return sh=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},sh(n)}function _L(n,e){if(sh(n)!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(sh(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function SL(n){var e=_L(n,"string");return sh(e)=="symbol"?e:e+""}function xL(n,e,t){return(e=SL(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function M7(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(n,i).enumerable})),t.push.apply(t,r)}return t}function $7(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?M7(Object(t),!0).forEach(function(r){xL(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):M7(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}function Jn(n){return"Minified Redux error #"+n+"; visit https://redux.js.org/Errors?code="+n+" for the full message or use the non-minified dev environment for full errors. "}var U7=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}(),F7=function(){return Math.random().toString(36).substring(7).split("").join(".")},z7={INIT:"@@redux/INIT"+F7(),REPLACE:"@@redux/REPLACE"+F7()};function kL(n){if(typeof n!="object"||n===null)return!1;for(var e=n;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(n)===e}function c6(n,e,t){var r;if(typeof e=="function"&&typeof t=="function"||typeof t=="function"&&typeof arguments[3]=="function")throw new Error(Jn(0));if(typeof e=="function"&&typeof t>"u"&&(t=e,e=void 0),typeof t<"u"){if(typeof t!="function")throw new Error(Jn(1));return t(c6)(n,e)}if(typeof n!="function")throw new Error(Jn(2));var i=n,s=e,o=[],a=o,l=!1;function c(){a===o&&(a=o.slice())}function u(){if(l)throw new Error(Jn(3));return s}function d(g){if(typeof g!="function")throw new Error(Jn(4));if(l)throw new Error(Jn(5));var w=!0;return c(),a.push(g),function(){if(w){if(l)throw new Error(Jn(6));w=!1,c();var E=a.indexOf(g);a.splice(E,1),o=null}}}function f(g){if(!kL(g))throw new Error(Jn(7));if(typeof g.type>"u")throw new Error(Jn(8));if(l)throw new Error(Jn(9));try{l=!0,s=i(s,g)}finally{l=!1}for(var w=o=a,m=0;m<w.length;m++){var E=w[m];E()}return g}function p(g){if(typeof g!="function")throw new Error(Jn(10));i=g,f({type:z7.REPLACE})}function y(){var g,w=d;return g={subscribe:function(E){if(typeof E!="object"||E===null)throw new Error(Jn(11));function v(){E.next&&E.next(u())}v();var b=w(v);return{unsubscribe:b}}},g[U7]=function(){return this},g}return f({type:z7.INIT}),r={dispatch:f,subscribe:d,getState:u,replaceReducer:p},r[U7]=y,r}function cx(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];return e.length===0?function(r){return r}:e.length===1?e[0]:e.reduce(function(r,i){return function(){return r(i.apply(void 0,arguments))}})}function ux(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];return function(r){return function(){var i=r.apply(void 0,arguments),s=function(){throw new Error(Jn(15))},o={getState:i.getState,dispatch:function(){return s.apply(void 0,arguments)}},a=e.map(function(l){return l(o)});return s=cx.apply(void 0,a)(i.dispatch),$7($7({},i),{},{dispatch:s})}}}function dx({game:n,numPlayers:e,setupData:t}){n=ip(n),e||(e=2);const r=n.flow.ctx(e);let i={G:{},ctx:r,plugins:{}};i=nL(i,{game:n}),i=b4(i,{game:n,playerID:void 0});const s=Ic(i);i.G=n.setup({...s,ctx:i.ctx},t);let o={...i,_undo:[],_redo:[],_stateID:0};return o=n.flow.init(o),[o]=KS(o,{game:n}),n.disableUndo||(o._undo=[{G:o.G,ctx:o.ctx,plugins:o.plugins}]),o}let u6=class{constructor({transportDataCallback:e,gameName:t,playerID:r,matchID:i,credentials:s,numPlayers:o}){this.connectionStatusCallback=()=>{},this.isConnected=!1,this.transportDataCallback=e,this.gameName=t||"default",this.playerID=r||null,this.matchID=i||"default",this.credentials=s,this.numPlayers=o||2}subscribeToConnectionStatus(e){this.connectionStatusCallback=e}setConnectionStatus(e){this.isConnected=e,this.connectionStatusCallback()}notifyClient(e){this.transportDataCallback(e)}};class RL extends u6{connect(){}disconnect(){}sendAction(){}sendChatMessage(){}requestSync(){}updateCredentials(){}updateMatchID(){}updatePlayerID(){}}const AL=n=>new RL(n);class IL{constructor(){this.debugPanel=null,this.currentClient=null,this.clients=new Map,this.subscribers=new Map}register(e){this.clients.set(e,e),this.mountDebug(e),this.notifySubscribers()}unregister(e){if(this.clients.delete(e),this.currentClient===e){this.unmountDebug();for(const[t]of this.clients){if(this.debugPanel)break;this.mountDebug(t)}}this.notifySubscribers()}subscribe(e){const t=Symbol();return this.subscribers.set(t,e),e(this.getState()),()=>{this.subscribers.delete(t)}}switchPlayerID(e){if(this.currentClient.multiplayer){for(const[t]of this.clients)if(t.playerID===e&&t.debugOpt!==!1&&t.multiplayer===this.currentClient.multiplayer){this.switchToClient(t);return}}this.currentClient.updatePlayerID(e),this.notifySubscribers()}switchToClient(e){e!==this.currentClient&&(this.unmountDebug(),this.mountDebug(e),this.notifySubscribers())}notifySubscribers(){const e=this.getState();this.subscribers.forEach(t=>{t(e)})}getState(){return{client:this.currentClient,debuggableClients:this.getDebuggableClients()}}getDebuggableClients(){return[...this.clients.values()].filter(e=>e.debugOpt!==!1)}mountDebug(e){if(e.debugOpt===!1||this.debugPanel!==null||typeof document>"u")return;let t,r=document.body;e.debugOpt&&e.debugOpt!==!0&&(t=e.debugOpt.impl||t,r=e.debugOpt.target||r),t&&(this.currentClient=e,this.debugPanel=new t({target:r,props:{clientManager:this}}))}unmountDebug(){this.debugPanel.$destroy(),this.debugPanel=null,this.currentClient=null}}const CL=new IL;function k4(n,e,t){return!t&&n==null&&(n=e.getState().ctx.currentPlayer),n}function d6(n,e,t,r,i,s){const o={};for(const a of e)o[a]=(...l)=>{const c=YO[n](a,l,k4(r,t,s),i);t.dispatch(c)};return o}const TL=d6.bind(null,"makeMove"),NL=d6.bind(null,"gameEvent"),DL=d6.bind(null,"plugin");class PL{constructor({game:e,debug:t,numPlayers:r,multiplayer:i,matchID:s,playerID:o,credentials:a,enhancer:l}){this.game=ip(e),this.playerID=o,this.matchID=s||"default",this.credentials=a,this.multiplayer=i,this.debugOpt=t,this.manager=CL,this.gameStateOverride=null,this.subscribers={},this._running=!1,this.reducer=l6({game:this.game,isClient:i!==void 0}),this.initialState=null,i||(this.initialState=dx({game:this.game,numPlayers:r})),this.reset=()=>{this.store.dispatch(US(this.initialState))},this.undo=()=>{const p=FS(k4(this.playerID,this.store,this.multiplayer),this.credentials);this.store.dispatch(p)},this.redo=()=>{const p=zS(k4(this.playerID,this.store,this.multiplayer),this.credentials);this.store.dispatch(p)},this.log=[];const f=ux(lx,()=>p=>y=>{const g=p(y);return this.notifySubscribers(),g},p=>y=>g=>{const w=p.getState(),m=y(g);return!("clientOnly"in g)&&g.type!==np&&this.transport.sendAction(w,g),m},p=>y=>g=>{const w=y(g),m=p.getState();switch(g.type){case rh:case Z2:case tp:case ep:{const E=m.deltalog;this.log=[...this.log,...E];break}case Xm:{this.log=[];break}case e6:case Zm:{let E=-1;this.log.length>0&&(E=this.log[this.log.length-1]._stateID);let v=g.deltalog||[];v=v.filter(b=>b._stateID>E),this.log=[...this.log,...v];break}case Jm:{this.initialState=g.initialState,this.log=g.log||[];break}}return w});l=l!==void 0?cx(f,l):f,this.store=c6(this.reducer,this.initialState,l),i||(i=AL),this.transport=i({transportDataCallback:p=>this.receiveTransportData(p),gameKey:e,game:this.game,matchID:s,playerID:o,credentials:a,gameName:this.game.name,numPlayers:r}),this.createDispatchers(),this.chatMessages=[],this.sendChatMessage=p=>{this.transport.sendChatMessage(this.matchID,{id:TO(7),sender:this.playerID,payload:p})}}receiveMatchData(e){this.matchData=e,this.notifySubscribers()}receiveChatMessage(e){this.chatMessages=[...this.chatMessages,e],this.notifySubscribers()}receiveTransportData(e){const[t]=e.args;if(t===this.matchID)switch(e.type){case"sync":{const[,r]=e.args,i=BS(r);this.receiveMatchData(r.filteredMetadata),this.store.dispatch(i);break}case"update":{const[,r,i]=e.args,s=this.store.getState();if(r._stateID>=s._stateID){const o=$S(r,i);this.store.dispatch(o)}break}case"patch":{const[,r,i,s,o]=e.args,a=this.store.getState()._stateID;if(r!==a)break;const l=MS(r,i,s,o);this.store.dispatch(l),this.store.getState()._stateID===a&&this.transport.requestSync();break}case"matchData":{const[,r]=e.args;this.receiveMatchData(r);break}case"chat":{const[,r]=e.args;this.receiveChatMessage(r);break}}}notifySubscribers(){Object.values(this.subscribers).forEach(e=>e(this.getState()))}overrideGameState(e){this.gameStateOverride=e,this.notifySubscribers()}start(){this.transport.connect(),this._running=!0,this.manager.register(this)}stop(){this.transport.disconnect(),this._running=!1,this.manager.unregister(this)}subscribe(e){const t=Object.keys(this.subscribers).length;return this.subscribers[t]=e,this.transport.subscribeToConnectionStatus(()=>this.notifySubscribers()),(this._running||!this.multiplayer)&&e(this.getState()),()=>{delete this.subscribers[t]}}getInitialState(){return this.initialState}getState(){let e=this.store.getState();if(this.gameStateOverride!==null&&(e=this.gameStateOverride),e===null)return e;let t=!0;const r=this.game.flow.isPlayerActive(e.G,e.ctx,this.playerID);return this.multiplayer&&!r&&(t=!1),!this.multiplayer&&this.playerID!==null&&this.playerID!==void 0&&!r&&(t=!1),e.ctx.gameover!==void 0&&(t=!1),this.multiplayer||(e={...e,G:this.game.playerView({G:e.G,ctx:e.ctx,playerID:this.playerID}),plugins:WS(e,this)}),{...e,log:this.log,isActive:t,isConnected:this.transport.isConnected}}createDispatchers(){this.moves=TL(this.game.moveNames,this.store,this.playerID,this.credentials,this.multiplayer),this.events=NL(this.game.flow.enabledEventNames,this.store,this.playerID,this.credentials,this.multiplayer),this.plugins=DL(this.game.pluginNames,this.store,this.playerID,this.credentials,this.multiplayer)}updatePlayerID(e){this.playerID=e,this.createDispatchers(),this.transport.updatePlayerID(e),this.notifySubscribers()}updateMatchID(e){this.matchID=e,this.createDispatchers(),this.transport.updateMatchID(e),this.notifySubscribers()}updateCredentials(e){this.credentials=e,this.createDispatchers(),this.transport.updateCredentials(e),this.notifySubscribers()}}function OL(n){return new PL(n)}const hx=(n,e)=>{if(!n||typeof n!="string")throw new Error(`Expected ${e} string, got "${n}".`)},Yo=n=>hx(n,"game name"),Wu=n=>hx(n,"match ID"),Gu=(n,e)=>{if(!n)throw new Error(`Expected body, got ${n}.`);for(const t in e){const r=e[t],i=Array.isArray(r)?r:[r],s=n[t];if(!i.includes(typeof s)){const o=i.join("|");throw new TypeError(`Expected body.${t} to be of type ${o}, got ${s}.`)}}};class LL extends Error{constructor(e,t){super(e),this.details=t}}class BL{constructor({server:e=""}={}){this.server=e.replace(/\/$/,"")}async request(e,t){const r=await fetch(this.server+e,t);if(!r.ok){let i;try{i=await r.clone().json()}catch{try{i=await r.text()}catch(s){i=s.message}}throw new LL(`HTTP status ${r.status}`,i)}return r.json()}async post(e,t){let r={method:"post",body:JSON.stringify(t.body),headers:{"Content-Type":"application/json"}};return t.init&&(r={...r,...t.init,headers:{...r.headers,...t.init.headers}}),this.request(e,r)}async listGames(e){return this.request("/games",e)}async listMatches(e,t,r){Yo(e);let i="";if(t){const s=[],{isGameover:o,updatedBefore:a,updatedAfter:l}=t;o!==void 0&&s.push(`isGameover=${o}`),a&&s.push(`updatedBefore=${a}`),l&&s.push(`updatedAfter=${l}`),s.length>0&&(i="?"+s.join("&"))}return this.request(`/games/${e}${i}`,r)}async getMatch(e,t,r){return Yo(e),Wu(t),this.request(`/games/${e}/${t}`,r)}async createMatch(e,t,r){return Yo(e),Gu(t,{numPlayers:"number"}),this.post(`/games/${e}/create`,{body:t,init:r})}async joinMatch(e,t,r,i){return Yo(e),Wu(t),Gu(r,{playerID:["string","undefined"],playerName:"string"}),this.post(`/games/${e}/${t}/join`,{body:r,init:i})}async leaveMatch(e,t,r,i){Yo(e),Wu(t),Gu(r,{playerID:"string",credentials:"string"}),await this.post(`/games/${e}/${t}/leave`,{body:r,init:i})}async updatePlayer(e,t,r,i){Yo(e),Wu(t),Gu(r,{playerID:"string",credentials:"string"}),await this.post(`/games/${e}/${t}/update`,{body:r,init:i})}async playAgain(e,t,r,i){return Yo(e),Wu(t),Gu(r,{playerID:"string",credentials:"string"}),this.post(`/games/${e}/${t}/playAgain`,{body:r,init:i})}}var fx={exports:{}},ML="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED",$L=ML,UL=$L;function px(){}function gx(){}gx.resetWarningCache=px;var FL=function(){function n(r,i,s,o,a,l){if(l!==UL){var c=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw c.name="Invariant Violation",c}}n.isRequired=n;function e(){return n}var t={array:n,bigint:n,bool:n,func:n,number:n,object:n,string:n,symbol:n,any:n,arrayOf:e,element:n,elementType:n,instanceOf:e,node:n,objectOf:e,oneOf:e,oneOfType:e,shape:e,exact:e,checkPropTypes:gx,resetWarningCache:px};return t.PropTypes=t,t};fx.exports=FL();var zL=fx.exports;const Ti=ci(zL);var Os={},h6={};/*!
 * cookie
 * Copyright(c) 2012-2014 Roman Shtylman
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */h6.parse=WL;h6.serialize=GL;var VL=decodeURIComponent,HL=encodeURIComponent,KL=/; */,Pf=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function WL(n,e){if(typeof n!="string")throw new TypeError("argument str must be a string");for(var t={},r=e||{},i=n.split(KL),s=r.decode||VL,o=0;o<i.length;o++){var a=i[o],l=a.indexOf("=");if(!(l<0)){var c=a.substr(0,l).trim(),u=a.substr(++l,a.length).trim();u[0]=='"'&&(u=u.slice(1,-1)),t[c]==null&&(t[c]=qL(u,s))}}return t}function GL(n,e,t){var r=t||{},i=r.encode||HL;if(typeof i!="function")throw new TypeError("option encode is invalid");if(!Pf.test(n))throw new TypeError("argument name is invalid");var s=i(e);if(s&&!Pf.test(s))throw new TypeError("argument val is invalid");var o=n+"="+s;if(r.maxAge!=null){var a=r.maxAge-0;if(isNaN(a))throw new Error("maxAge should be a Number");o+="; Max-Age="+Math.floor(a)}if(r.domain){if(!Pf.test(r.domain))throw new TypeError("option domain is invalid");o+="; Domain="+r.domain}if(r.path){if(!Pf.test(r.path))throw new TypeError("option path is invalid");o+="; Path="+r.path}if(r.expires){if(typeof r.expires.toUTCString!="function")throw new TypeError("option expires is invalid");o+="; Expires="+r.expires.toUTCString()}if(r.httpOnly&&(o+="; HttpOnly"),r.secure&&(o+="; Secure"),r.sameSite){var l=typeof r.sameSite=="string"?r.sameSite.toLowerCase():r.sameSite;switch(l){case!0:o+="; SameSite=Strict";break;case"lax":o+="; SameSite=Lax";break;case"strict":o+="; SameSite=Strict";break;default:throw new TypeError("option sameSite is invalid")}}return o}function qL(n,e){try{return e(n)}catch{return n}}/*
object-assign
(c) Sindre Sorhus
@license MIT
*/var V7=Object.getOwnPropertySymbols,jL=Object.prototype.hasOwnProperty,YL=Object.prototype.propertyIsEnumerable;function QL(n){if(n==null)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(n)}function XL(){try{if(!Object.assign)return!1;var n=new String("abc");if(n[5]="de",Object.getOwnPropertyNames(n)[0]==="5")return!1;for(var e={},t=0;t<10;t++)e["_"+String.fromCharCode(t)]=t;var r=Object.getOwnPropertyNames(e).map(function(s){return e[s]});if(r.join("")!=="0123456789")return!1;var i={};return"abcdefghijklmnopqrst".split("").forEach(function(s){i[s]=s}),Object.keys(Object.assign({},i)).join("")==="abcdefghijklmnopqrst"}catch{return!1}}var JL=XL()?Object.assign:function(n,e){for(var t,r=QL(n),i,s=1;s<arguments.length;s++){t=Object(arguments[s]);for(var o in t)jL.call(t,o)&&(r[o]=t[o]);if(V7){i=V7(t);for(var a=0;a<i.length;a++)YL.call(t,i[a])&&(r[i[a]]=t[i[a]])}}return r},ZL={};Object.defineProperty(Os,"__esModule",{value:!0});var eB=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(n){return typeof n}:function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n};Os.load=vx;Os.loadAll=Ex;Os.select=bx;Os.save=_x;Os.remove=Sx;Os.setRawCookie=f6;Os.plugToRequest=xx;var tB=h6,fu=mx(tB),nB=JL,yx=mx(nB);function mx(n){return n&&n.__esModule?n:{default:n}}var sp=typeof document>"u"||typeof process<"u"&&ZL&&!1,ir={},To=void 0;function wx(){return To&&!To.headersSent}function vx(n,e){var t=sp?ir:fu.default.parse(document.cookie),r=t&&t[n];if(typeof e>"u"&&(e=!r||r[0]!=="{"&&r[0]!=="["),!e)try{r=JSON.parse(r)}catch{}return r}function Ex(n){var e=sp?ir:fu.default.parse(document.cookie),t=e;if(typeof n>"u"&&(n=!t||t[0]!=="{"&&t[0]!=="["),!n)try{t=JSON.parse(t)}catch{}return t}function bx(n){var e=sp?ir:fu.default.parse(document.cookie);return e?n?Object.keys(e).reduce(function(t,r){if(!n.test(r))return t;var i={};return i[r]=e[r],(0,yx.default)({},t,i)},{}):e:{}}function _x(n,e,t){ir[n]=e,(typeof e>"u"?"undefined":eB(e))==="object"&&(ir[n]=JSON.stringify(e)),sp||(document.cookie=fu.default.serialize(n,ir[n],t)),wx()&&To.cookie&&To.cookie(n,e,t)}function Sx(n,e){delete ir[n],typeof e>"u"?e={}:typeof e=="string"?e={path:e}:e=(0,yx.default)({},e),typeof document<"u"&&(e.expires=new Date(1970,1,1,0,0,1),e.maxAge=0,document.cookie=fu.default.serialize(n,"",e)),wx()&&To.clearCookie&&To.clearCookie(n,e)}function f6(n){n?ir=fu.default.parse(n):ir={}}function xx(n,e){return n.cookie?ir=n.cookie:n.cookies?ir=n.cookies:n.headers&&n.headers.cookie?f6(n.headers.cookie):ir={},To=e,function(){To=null,ir={}}}var H7=Os.default={setRawCookie:f6,load:vx,loadAll:Ex,select:bx,save:_x,remove:Sx,plugToRequest:xx},R0;(function(n){n[n.SYNC=0]="SYNC",n[n.ASYNC=1]="ASYNC"})(R0||(R0={}));function Qo(n){return n.type()===R0.SYNC}class rB{type(){return R0.SYNC}connect(){}createMatch(e,t){if(this.createGame)return console.warn("The database connector does not implement a createMatch method.",`
Using the deprecated createGame method instead.`),this.createGame(e,t);console.error("The database connector does not implement a createMatch method.")}listMatches(e){if(this.listGames)return console.warn("The database connector does not implement a listMatches method.",`
Using the deprecated listGames method instead.`),this.listGames(e);console.error("The database connector does not implement a listMatches method.")}}const iB=({game:n,unlisted:e,setupData:t,numPlayers:r})=>{const i={gameName:n.name,unlisted:!0,players:{},createdAt:Date.now(),updatedAt:Date.now()};for(let s=0;s<r;s++)i.players[s]={id:s};return i},sB=({game:n,numPlayers:e,setupData:t,unlisted:r})=>{(!e||typeof e!="number")&&(e=2);const i=n.validateSetupData&&n.validateSetupData(t,e);if(i!==void 0)return{setupDataError:i};const s=iB({game:n,numPlayers:e,setupData:t,unlisted:r}),o=dx({game:n,numPlayers:e,setupData:t});return{metadata:s,initialState:o}},K7=n=>Object.values(n.players).map(e=>{const{credentials:t,...r}=e;return r}),oB=n=>{const{credentials:e,...t}=n.payload;return{...n,payload:t}};class aB{constructor(e,t,r,i){this.game=ip(e),this.storageAPI=t,this.transportAPI=r,this.subscribeCallback=()=>{},this.auth=i}subscribe(e){this.subscribeCallback=e}async onUpdate(e,t,r,i){if(!e||!e.payload)return{error:"missing action or action payload"};let s;if(Qo(this.storageAPI)?{metadata:s}=this.storageAPI.fetch(r,{metadata:!0}):{metadata:s}=await this.storageAPI.fetch(r,{metadata:!0}),this.auth&&!await this.auth.authenticateCredentials({playerID:i,credentials:e.payload.credentials,metadata:s}))return{error:"unauthorized action"};const o=oB(e),a=r;let l;if(Qo(this.storageAPI)?{state:l}=this.storageAPI.fetch(a,{state:!0}):{state:l}=await this.storageAPI.fetch(a,{state:!0}),l===void 0)return Ge(`game not found, matchID=[${a}]`),{error:"game not found"};if(l.ctx.gameover!==void 0){Ge(`game over - matchID=[${a}] - playerID=[${i}] - action[${o.payload.type}]`);return}const c=l6({game:this.game}),u=ux(lx),d=c6(c,l,u);if(o.type==tp||o.type==ep){const m=l.ctx.activePlayers!==null,E=l.ctx.currentPlayer===i;if(!m&&!E||m&&(l.ctx.activePlayers[i]===void 0||Object.keys(l.ctx.activePlayers).length>1)){Ge(`playerID=[${i}] cannot undo / redo right now`);return}}if(!this.game.flow.isPlayerActive(l.G,l.ctx,i)){Ge(`player not active - playerID=[${i}] - action[${o.payload.type}]`);return}const f=o.type==rh?this.game.flow.getMove(l.ctx,o.payload.type,i):null;if(o.type==rh&&!f){Ge(`move not processed - canPlayerMakeMove=false - playerID=[${i}] - action[${o.payload.type}]`);return}if(l._stateID!==t&&!(f&&ox(f)&&f.ignoreStaleStateID)){Ge(`invalid stateID, was=[${t}], expected=[${l._stateID}] - playerID=[${i}] - action[${o.payload.type}]`);return}const p=d.getState();d.dispatch(o),l=d.getState(),this.subscribeCallback({state:l,action:o,matchID:r}),this.game.deltaState?this.transportAPI.sendAll({type:"patch",args:[r,t,p,l]}):this.transportAPI.sendAll({type:"update",args:[r,l]});const{deltalog:y,...g}=l;let w;if(s&&(s.gameover===void 0||s.gameover===null)&&(w={...s,updatedAt:Date.now()},l.ctx.gameover!==void 0&&(w.gameover=l.ctx.gameover)),Qo(this.storageAPI))this.storageAPI.setState(a,g,y),w&&this.storageAPI.setMetadata(a,w);else{const m=[this.storageAPI.setState(a,g,y)];w&&m.push(this.storageAPI.setMetadata(a,w)),await Promise.all(m)}}async onSync(e,t,r,i=2){const s=e,o={state:!0,metadata:!0,log:!0,initialState:!0},a=Qo(this.storageAPI)?this.storageAPI.fetch(s,o):await this.storageAPI.fetch(s,o);let{state:l,initialState:c,log:u,metadata:d}=a;if(this.auth&&t!==void 0&&t!==null&&!await this.auth.authenticateCredentials({playerID:t,credentials:r,metadata:d}))return{error:"unauthorized"};if(l===void 0){const y=sB({game:this.game,unlisted:!0,numPlayers:i,setupData:void 0});if("setupDataError"in y)return{error:"game requires setupData"};c=l=y.initialState,d=y.metadata,this.subscribeCallback({state:l,matchID:e}),Qo(this.storageAPI)?this.storageAPI.createMatch(s,{initialState:c,metadata:d}):await this.storageAPI.createMatch(s,{initialState:c,metadata:d})}const f=d?K7(d):void 0,p={state:l,log:u,filteredMetadata:f,initialState:c};this.transportAPI.send({playerID:t,type:"sync",args:[e,p]})}async onConnectionChange(e,t,r,i){const s=e;if(t==null)return;let o;if(Qo(this.storageAPI)?{metadata:o}=this.storageAPI.fetch(s,{metadata:!0}):{metadata:o}=await this.storageAPI.fetch(s,{metadata:!0}),o===void 0)return Ge(`metadata not found for matchID=[${s}]`),{error:"metadata not found"};if(o.players[t]===void 0)return Ge(`Player not in the match, matchID=[${s}] playerID=[${t}]`),{error:"player not in the match"};if(this.auth&&!await this.auth.authenticateCredentials({playerID:t,credentials:r,metadata:o}))return{error:"unauthorized"};o.players[t].isConnected=i;const a=K7(o);this.transportAPI.sendAll({type:"matchData",args:[e,a]}),Qo(this.storageAPI)?this.storageAPI.setMetadata(s,o):await this.storageAPI.setMetadata(s,o)}async onChatMessage(e,t,r){const i=e;if(this.auth){const{metadata:s}=await this.storageAPI.fetch(i,{metadata:!0});if(!(t&&typeof t.sender=="string"))return{error:"unauthorized"};if(!await this.auth.authenticateCredentials({playerID:t.sender,credentials:r,metadata:s}))return{error:"unauthorized"}}this.transportAPI.sendAll({type:"chat",args:[e,t]})}}const Of=(n,e,t)=>({...t,G:n.playerView({G:t.G,ctx:t.ctx,playerID:e}),plugins:WS(t,{playerID:e,game:n}),deltalog:void 0,_undo:[],_redo:[]}),lB=n=>(e,t)=>{switch(t.type){case"patch":{const[r,i,s,o]=t.args,a=Dg(o.deltalog,e),l=Of(n,e,o),c=o._stateID,u=Of(n,e,s),d=r6.createPatch(u,l);return{type:"patch",args:[r,i,c,d,a]}}case"update":{const[r,i]=t.args,s=Dg(i.deltalog,e),o=Of(n,e,i);return{type:"update",args:[r,o,s]}}case"sync":{const[r,i]=t.args,s=Of(n,e,i.state),o=Dg(i.log,e),a={...i,state:s,log:o};return{type:"sync",args:[r,a]}}default:return t}};function Dg(n,e){return n===void 0?n:n.map(t=>{if(e!==null&&+e==+t.action.payload.playerID||t.redact!==!0)return t;const r={...t.action.payload,args:null},i={...t,action:{...t.action,payload:r}},{redact:s,...o}=i;return o})}const Gi=Object.create(null);Gi.open="0";Gi.close="1";Gi.ping="2";Gi.pong="3";Gi.message="4";Gi.upgrade="5";Gi.noop="6";const S1=Object.create(null);Object.keys(Gi).forEach(n=>{S1[Gi[n]]=n});const R4={type:"error",data:"parser error"},kx=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",Rx=typeof ArrayBuffer=="function",Ax=n=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(n):n&&n.buffer instanceof ArrayBuffer,p6=({type:n,data:e},t,r)=>kx&&e instanceof Blob?t?r(e):W7(e,r):Rx&&(e instanceof ArrayBuffer||Ax(e))?t?r(e):W7(new Blob([e]),r):r(Gi[n]+(e||"")),W7=(n,e)=>{const t=new FileReader;return t.onload=function(){const r=t.result.split(",")[1];e("b"+(r||""))},t.readAsDataURL(n)};function G7(n){return n instanceof Uint8Array?n:n instanceof ArrayBuffer?new Uint8Array(n):new Uint8Array(n.buffer,n.byteOffset,n.byteLength)}let Pg;function cB(n,e){if(kx&&n.data instanceof Blob)return n.data.arrayBuffer().then(G7).then(e);if(Rx&&(n.data instanceof ArrayBuffer||Ax(n.data)))return e(G7(n.data));p6(n,!1,t=>{Pg||(Pg=new TextEncoder),e(Pg.encode(t))})}const q7="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",cd=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let n=0;n<q7.length;n++)cd[q7.charCodeAt(n)]=n;const uB=n=>{let e=n.length*.75,t=n.length,r,i=0,s,o,a,l;n[n.length-1]==="="&&(e--,n[n.length-2]==="="&&e--);const c=new ArrayBuffer(e),u=new Uint8Array(c);for(r=0;r<t;r+=4)s=cd[n.charCodeAt(r)],o=cd[n.charCodeAt(r+1)],a=cd[n.charCodeAt(r+2)],l=cd[n.charCodeAt(r+3)],u[i++]=s<<2|o>>4,u[i++]=(o&15)<<4|a>>2,u[i++]=(a&3)<<6|l&63;return c},dB=typeof ArrayBuffer=="function",g6=(n,e)=>{if(typeof n!="string")return{type:"message",data:Ix(n,e)};const t=n.charAt(0);return t==="b"?{type:"message",data:hB(n.substring(1),e)}:S1[t]?n.length>1?{type:S1[t],data:n.substring(1)}:{type:S1[t]}:R4},hB=(n,e)=>{if(dB){const t=uB(n);return Ix(t,e)}else return{base64:!0,data:n}},Ix=(n,e)=>{switch(e){case"blob":return n instanceof Blob?n:new Blob([n]);case"arraybuffer":default:return n instanceof ArrayBuffer?n:n.buffer}},Cx="",fB=(n,e)=>{const t=n.length,r=new Array(t);let i=0;n.forEach((s,o)=>{p6(s,!1,a=>{r[o]=a,++i===t&&e(r.join(Cx))})})},pB=(n,e)=>{const t=n.split(Cx),r=[];for(let i=0;i<t.length;i++){const s=g6(t[i],e);if(r.push(s),s.type==="error")break}return r};function gB(){return new TransformStream({transform(n,e){cB(n,t=>{const r=t.length;let i;if(r<126)i=new Uint8Array(1),new DataView(i.buffer).setUint8(0,r);else if(r<65536){i=new Uint8Array(3);const s=new DataView(i.buffer);s.setUint8(0,126),s.setUint16(1,r)}else{i=new Uint8Array(9);const s=new DataView(i.buffer);s.setUint8(0,127),s.setBigUint64(1,BigInt(r))}n.data&&typeof n.data!="string"&&(i[0]|=128),e.enqueue(i),e.enqueue(t)})}})}let Og;function Lf(n){return n.reduce((e,t)=>e+t.length,0)}function Bf(n,e){if(n[0].length===e)return n.shift();const t=new Uint8Array(e);let r=0;for(let i=0;i<e;i++)t[i]=n[0][r++],r===n[0].length&&(n.shift(),r=0);return n.length&&r<n[0].length&&(n[0]=n[0].slice(r)),t}function yB(n,e){Og||(Og=new TextDecoder);const t=[];let r=0,i=-1,s=!1;return new TransformStream({transform(o,a){for(t.push(o);;){if(r===0){if(Lf(t)<1)break;const l=Bf(t,1);s=(l[0]&128)===128,i=l[0]&127,i<126?r=3:i===126?r=1:r=2}else if(r===1){if(Lf(t)<2)break;const l=Bf(t,2);i=new DataView(l.buffer,l.byteOffset,l.length).getUint16(0),r=3}else if(r===2){if(Lf(t)<8)break;const l=Bf(t,8),c=new DataView(l.buffer,l.byteOffset,l.length),u=c.getUint32(0);if(u>Math.pow(2,21)-1){a.enqueue(R4);break}i=u*Math.pow(2,32)+c.getUint32(4),r=3}else{if(Lf(t)<i)break;const l=Bf(t,i);a.enqueue(g6(s?l:Og.decode(l),e)),r=0}if(i===0||i>n){a.enqueue(R4);break}}}})}const Tx=4;function Dt(n){if(n)return mB(n)}function mB(n){for(var e in Dt.prototype)n[e]=Dt.prototype[e];return n}Dt.prototype.on=Dt.prototype.addEventListener=function(n,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+n]=this._callbacks["$"+n]||[]).push(e),this};Dt.prototype.once=function(n,e){function t(){this.off(n,t),e.apply(this,arguments)}return t.fn=e,this.on(n,t),this};Dt.prototype.off=Dt.prototype.removeListener=Dt.prototype.removeAllListeners=Dt.prototype.removeEventListener=function(n,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+n];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+n],this;for(var r,i=0;i<t.length;i++)if(r=t[i],r===e||r.fn===e){t.splice(i,1);break}return t.length===0&&delete this._callbacks["$"+n],this};Dt.prototype.emit=function(n){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+n],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(t){t=t.slice(0);for(var r=0,i=t.length;r<i;++r)t[r].apply(this,e)}return this};Dt.prototype.emitReserved=Dt.prototype.emit;Dt.prototype.listeners=function(n){return this._callbacks=this._callbacks||{},this._callbacks["$"+n]||[]};Dt.prototype.hasListeners=function(n){return!!this.listeners(n).length};const op=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),Ir=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),wB="arraybuffer";function Nx(n,...e){return e.reduce((t,r)=>(n.hasOwnProperty(r)&&(t[r]=n[r]),t),{})}const vB=Ir.setTimeout,EB=Ir.clearTimeout;function ap(n,e){e.useNativeTimers?(n.setTimeoutFn=vB.bind(Ir),n.clearTimeoutFn=EB.bind(Ir)):(n.setTimeoutFn=Ir.setTimeout.bind(Ir),n.clearTimeoutFn=Ir.clearTimeout.bind(Ir))}const bB=1.33;function _B(n){return typeof n=="string"?SB(n):Math.ceil((n.byteLength||n.size)*bB)}function SB(n){let e=0,t=0;for(let r=0,i=n.length;r<i;r++)e=n.charCodeAt(r),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(r++,t+=4);return t}function Dx(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function xB(n){let e="";for(let t in n)n.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(n[t]));return e}function kB(n){let e={},t=n.split("&");for(let r=0,i=t.length;r<i;r++){let s=t[r].split("=");e[decodeURIComponent(s[0])]=decodeURIComponent(s[1])}return e}class RB extends Error{constructor(e,t,r){super(e),this.description=t,this.context=r,this.type="TransportError"}}class y6 extends Dt{constructor(e){super(),this.writable=!1,ap(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,r){return super.emitReserved("error",new RB(e,t,r)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=g6(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=xB(e);return t.length?"?"+t:""}}class AB extends y6{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let r=0;this._polling&&(r++,this.once("pollComplete",function(){--r||t()})),this.writable||(r++,this.once("drain",function(){--r||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=r=>{if(this.readyState==="opening"&&r.type==="open"&&this.onOpen(),r.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(r)};pB(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,fB(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=Dx()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let Px=!1;try{Px=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const IB=Px;function CB(){}class TB extends AB{constructor(e){if(super(e),typeof location<"u"){const t=location.protocol==="https:";let r=location.port;r||(r=t?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||r!==e.port}}doWrite(e,t){const r=this.request({method:"POST",data:e});r.on("success",t),r.on("error",(i,s)=>{this.onError("xhr post error",i,s)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,r)=>{this.onError("xhr poll error",t,r)}),this.pollXhr=e}}class zi extends Dt{constructor(e,t,r){super(),this.createRequest=e,ap(this,r),this._opts=r,this._method=r.method||"GET",this._uri=t,this._data=r.data!==void 0?r.data:null,this._create()}_create(){var e;const t=Nx(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const r=this._xhr=this.createRequest(t);try{r.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){r.setDisableHeaderCheck&&r.setDisableHeaderCheck(!0);for(let i in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(i)&&r.setRequestHeader(i,this._opts.extraHeaders[i])}}catch{}if(this._method==="POST")try{r.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{r.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(r),"withCredentials"in r&&(r.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(r.timeout=this._opts.requestTimeout),r.onreadystatechange=()=>{var i;r.readyState===3&&((i=this._opts.cookieJar)===null||i===void 0||i.parseCookies(r.getResponseHeader("set-cookie"))),r.readyState===4&&(r.status===200||r.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof r.status=="number"?r.status:0)},0))},r.send(this._data)}catch(i){this.setTimeoutFn(()=>{this._onError(i)},0);return}typeof document<"u"&&(this._index=zi.requestsCount++,zi.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=CB,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete zi.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}zi.requestsCount=0;zi.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",j7);else if(typeof addEventListener=="function"){const n="onpagehide"in Ir?"pagehide":"unload";addEventListener(n,j7,!1)}}function j7(){for(let n in zi.requests)zi.requests.hasOwnProperty(n)&&zi.requests[n].abort()}const NB=function(){const n=Ox({xdomain:!1});return n&&n.responseType!==null}();class DB extends TB{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=NB&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new zi(Ox,this.uri(),e)}}function Ox(n){const e=n.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||IB))return new XMLHttpRequest}catch{}if(!e)try{return new Ir[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const Lx=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class PB extends y6{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,r=Lx?{}:Nx(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(r.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,r)}catch(i){return this.emitReserved("error",i)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const r=e[t],i=t===e.length-1;p6(r,this.supportsBinary,s=>{try{this.doWrite(r,s)}catch{}i&&op(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=Dx()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const Lg=Ir.WebSocket||Ir.MozWebSocket;class OB extends PB{createSocket(e,t,r){return Lx?new Lg(e,t,r):t?new Lg(e,t):new Lg(e)}doWrite(e,t){this.ws.send(t)}}class LB extends y6{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=yB(Number.MAX_SAFE_INTEGER,this.socket.binaryType),r=e.readable.pipeThrough(t).getReader(),i=gB();i.readable.pipeTo(e.writable),this._writer=i.writable.getWriter();const s=()=>{r.read().then(({done:a,value:l})=>{a||(this.onPacket(l),s())}).catch(a=>{})};s();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this._writer.write(o).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const r=e[t],i=t===e.length-1;this._writer.write(r).then(()=>{i&&op(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const BB={websocket:OB,webtransport:LB,polling:DB},MB=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,$B=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function A4(n){if(n.length>8e3)throw"URI too long";const e=n,t=n.indexOf("["),r=n.indexOf("]");t!=-1&&r!=-1&&(n=n.substring(0,t)+n.substring(t,r).replace(/:/g,";")+n.substring(r,n.length));let i=MB.exec(n||""),s={},o=14;for(;o--;)s[$B[o]]=i[o]||"";return t!=-1&&r!=-1&&(s.source=e,s.host=s.host.substring(1,s.host.length-1).replace(/;/g,":"),s.authority=s.authority.replace("[","").replace("]","").replace(/;/g,":"),s.ipv6uri=!0),s.pathNames=UB(s,s.path),s.queryKey=FB(s,s.query),s}function UB(n,e){const t=/\/{2,9}/g,r=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&r.splice(0,1),e.slice(-1)=="/"&&r.splice(r.length-1,1),r}function FB(n,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(r,i,s){i&&(t[i]=s)}),t}const I4=typeof addEventListener=="function"&&typeof removeEventListener=="function",x1=[];I4&&addEventListener("offline",()=>{x1.forEach(n=>n())},!1);class So extends Dt{constructor(e,t){if(super(),this.binaryType=wB,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const r=A4(e);t.hostname=r.host,t.secure=r.protocol==="https"||r.protocol==="wss",t.port=r.port,r.query&&(t.query=r.query)}else t.host&&(t.hostname=A4(t.host).host);ap(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(r=>{const i=r.prototype.name;this.transports.push(i),this._transportsByName[i]=r}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=kB(this.opts.query)),I4&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},x1.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=Tx,t.transport=e,this.id&&(t.sid=this.id);const r=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](r)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&So.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",So.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let r=0;r<this.writeBuffer.length;r++){const i=this.writeBuffer[r].data;if(i&&(t+=_B(i)),r>0&&t>this._maxPayload)return this.writeBuffer.slice(0,r);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,op(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,r){return this._sendPacket("message",e,t,r),this}send(e,t,r){return this._sendPacket("message",e,t,r),this}_sendPacket(e,t,r,i){if(typeof t=="function"&&(i=t,t=void 0),typeof r=="function"&&(i=r,r=null),this.readyState==="closing"||this.readyState==="closed")return;r=r||{},r.compress=r.compress!==!1;const s={type:e,data:t,options:r};this.emitReserved("packetCreate",s),this.writeBuffer.push(s),i&&this.once("flush",i),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},r=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?r():e()}):this.upgrading?r():e()),this}_onError(e){if(So.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),I4&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const r=x1.indexOf(this._offlineEventListener);r!==-1&&x1.splice(r,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}So.protocol=Tx;class zB extends So{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),r=!1;So.priorWebsocketSuccess=!1;const i=()=>{r||(t.send([{type:"ping",data:"probe"}]),t.once("packet",d=>{if(!r)if(d.type==="pong"&&d.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;So.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{r||this.readyState!=="closed"&&(u(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const f=new Error("probe error");f.transport=t.name,this.emitReserved("upgradeError",f)}}))};function s(){r||(r=!0,u(),t.close(),t=null)}const o=d=>{const f=new Error("probe error: "+d);f.transport=t.name,s(),this.emitReserved("upgradeError",f)};function a(){o("transport closed")}function l(){o("socket closed")}function c(d){t&&d.name!==t.name&&s()}const u=()=>{t.removeListener("open",i),t.removeListener("error",o),t.removeListener("close",a),this.off("close",l),this.off("upgrading",c)};t.once("open",i),t.once("error",o),t.once("close",a),this.once("close",l),this.once("upgrading",c),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{r||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let r=0;r<e.length;r++)~this.transports.indexOf(e[r])&&t.push(e[r]);return t}}let VB=class extends zB{constructor(e,t={}){const r=typeof e=="object"?e:t;(!r.transports||r.transports&&typeof r.transports[0]=="string")&&(r.transports=(r.transports||["polling","websocket","webtransport"]).map(i=>BB[i]).filter(i=>!!i)),super(e,r)}};function HB(n,e="",t){let r=n;t=t||typeof location<"u"&&location,n==null&&(n=t.protocol+"//"+t.host),typeof n=="string"&&(n.charAt(0)==="/"&&(n.charAt(1)==="/"?n=t.protocol+n:n=t.host+n),/^(https?|wss?):\/\//.test(n)||(typeof t<"u"?n=t.protocol+"//"+n:n="https://"+n),r=A4(n)),r.port||(/^(http|ws)$/.test(r.protocol)?r.port="80":/^(http|ws)s$/.test(r.protocol)&&(r.port="443")),r.path=r.path||"/";const s=r.host.indexOf(":")!==-1?"["+r.host+"]":r.host;return r.id=r.protocol+"://"+s+":"+r.port+e,r.href=r.protocol+"://"+s+(t&&t.port===r.port?"":":"+r.port),r}const KB=typeof ArrayBuffer=="function",WB=n=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(n):n.buffer instanceof ArrayBuffer,Bx=Object.prototype.toString,GB=typeof Blob=="function"||typeof Blob<"u"&&Bx.call(Blob)==="[object BlobConstructor]",qB=typeof File=="function"||typeof File<"u"&&Bx.call(File)==="[object FileConstructor]";function m6(n){return KB&&(n instanceof ArrayBuffer||WB(n))||GB&&n instanceof Blob||qB&&n instanceof File}function k1(n,e){if(!n||typeof n!="object")return!1;if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(k1(n[t]))return!0;return!1}if(m6(n))return!0;if(n.toJSON&&typeof n.toJSON=="function"&&arguments.length===1)return k1(n.toJSON(),!0);for(const t in n)if(Object.prototype.hasOwnProperty.call(n,t)&&k1(n[t]))return!0;return!1}function jB(n){const e=[],t=n.data,r=n;return r.data=C4(t,e),r.attachments=e.length,{packet:r,buffers:e}}function C4(n,e){if(!n)return n;if(m6(n)){const t={_placeholder:!0,num:e.length};return e.push(n),t}else if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<n.length;r++)t[r]=C4(n[r],e);return t}else if(typeof n=="object"&&!(n instanceof Date)){const t={};for(const r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=C4(n[r],e));return t}return n}function YB(n,e){return n.data=T4(n.data,e),delete n.attachments,n}function T4(n,e){if(!n)return n;if(n&&n._placeholder===!0){if(typeof n.num=="number"&&n.num>=0&&n.num<e.length)return e[n.num];throw new Error("illegal attachments")}else if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t]=T4(n[t],e);else if(typeof n=="object")for(const t in n)Object.prototype.hasOwnProperty.call(n,t)&&(n[t]=T4(n[t],e));return n}const QB=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],XB=5;var Ne;(function(n){n[n.CONNECT=0]="CONNECT",n[n.DISCONNECT=1]="DISCONNECT",n[n.EVENT=2]="EVENT",n[n.ACK=3]="ACK",n[n.CONNECT_ERROR=4]="CONNECT_ERROR",n[n.BINARY_EVENT=5]="BINARY_EVENT",n[n.BINARY_ACK=6]="BINARY_ACK"})(Ne||(Ne={}));let JB=class{constructor(e){this.replacer=e}encode(e){return(e.type===Ne.EVENT||e.type===Ne.ACK)&&k1(e)?this.encodeAsBinary({type:e.type===Ne.EVENT?Ne.BINARY_EVENT:Ne.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===Ne.BINARY_EVENT||e.type===Ne.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=jB(e),r=this.encodeAsString(t.packet),i=t.buffers;return i.unshift(r),i}};function Y7(n){return Object.prototype.toString.call(n)==="[object Object]"}let ZB=class Mx extends Dt{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const r=t.type===Ne.BINARY_EVENT;r||t.type===Ne.BINARY_ACK?(t.type=r?Ne.EVENT:Ne.ACK,this.reconstructor=new eM(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(m6(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const r={type:Number(e.charAt(0))};if(Ne[r.type]===void 0)throw new Error("unknown packet type "+r.type);if(r.type===Ne.BINARY_EVENT||r.type===Ne.BINARY_ACK){const s=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const o=e.substring(s,t);if(o!=Number(o)||e.charAt(t)!=="-")throw new Error("Illegal attachments");r.attachments=Number(o)}if(e.charAt(t+1)==="/"){const s=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););r.nsp=e.substring(s,t)}else r.nsp="/";const i=e.charAt(t+1);if(i!==""&&Number(i)==i){const s=t+1;for(;++t;){const o=e.charAt(t);if(o==null||Number(o)!=o){--t;break}if(t===e.length)break}r.id=Number(e.substring(s,t+1))}if(e.charAt(++t)){const s=this.tryParse(e.substr(t));if(Mx.isPayloadValid(r.type,s))r.data=s;else throw new Error("invalid payload")}return r}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case Ne.CONNECT:return Y7(t);case Ne.DISCONNECT:return t===void 0;case Ne.CONNECT_ERROR:return typeof t=="string"||Y7(t);case Ne.EVENT:case Ne.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&QB.indexOf(t[0])===-1);case Ne.ACK:case Ne.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}};class eM{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=YB(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const tM=Object.freeze(Object.defineProperty({__proto__:null,Decoder:ZB,Encoder:JB,get PacketType(){return Ne},protocol:XB},Symbol.toStringTag,{value:"Module"}));function Yr(n,e,t){return n.on(e,t),function(){n.off(e,t)}}const nM=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class $x extends Dt{constructor(e,t,r){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,r&&r.auth&&(this.auth=r.auth),this._opts=Object.assign({},r),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[Yr(e,"open",this.onopen.bind(this)),Yr(e,"packet",this.onpacket.bind(this)),Yr(e,"error",this.onerror.bind(this)),Yr(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var r,i,s;if(nM.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const o={type:Ne.EVENT,data:t};if(o.options={},o.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const u=this.ids++,d=t.pop();this._registerAckCallback(u,d),o.id=u}const a=(i=(r=this.io.engine)===null||r===void 0?void 0:r.transport)===null||i===void 0?void 0:i.writable,l=this.connected&&!(!((s=this.io.engine)===null||s===void 0)&&s._hasPingExpired());return this.flags.volatile&&!a||(l?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}_registerAckCallback(e,t){var r;const i=(r=this.flags.timeout)!==null&&r!==void 0?r:this._opts.ackTimeout;if(i===void 0){this.acks[e]=t;return}const s=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let a=0;a<this.sendBuffer.length;a++)this.sendBuffer[a].id===e&&this.sendBuffer.splice(a,1);t.call(this,new Error("operation has timed out"))},i),o=(...a)=>{this.io.clearTimeoutFn(s),t.apply(this,a)};o.withError=!0,this.acks[e]=o}emitWithAck(e,...t){return new Promise((r,i)=>{const s=(o,a)=>o?i(o):r(a);s.withError=!0,t.push(s),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const r={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((i,...s)=>r!==this._queue[0]?void 0:(i!==null?r.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(i)):(this._queue.shift(),t&&t(null,...s)),r.pending=!1,this._drainQueue())),this._queue.push(r),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:Ne.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(r=>String(r.id)===e)){const r=this.acks[e];delete this.acks[e],r.withError&&r.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case Ne.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case Ne.EVENT:case Ne.BINARY_EVENT:this.onevent(e);break;case Ne.ACK:case Ne.BINARY_ACK:this.onack(e);break;case Ne.DISCONNECT:this.ondisconnect();break;case Ne.CONNECT_ERROR:this.destroy();const r=new Error(e.data.message);r.data=e.data.data,this.emitReserved("connect_error",r);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const r of t)r.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let r=!1;return function(...i){r||(r=!0,t.packet({type:Ne.ACK,id:e,data:i}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:Ne.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let r=0;r<t.length;r++)if(e===t[r])return t.splice(r,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let r=0;r<t.length;r++)if(e===t[r])return t.splice(r,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const r of t)r.apply(this,e.data)}}}function pu(n){n=n||{},this.ms=n.min||100,this.max=n.max||1e4,this.factor=n.factor||2,this.jitter=n.jitter>0&&n.jitter<=1?n.jitter:0,this.attempts=0}pu.prototype.duration=function(){var n=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*n);n=Math.floor(e*10)&1?n+t:n-t}return Math.min(n,this.max)|0};pu.prototype.reset=function(){this.attempts=0};pu.prototype.setMin=function(n){this.ms=n};pu.prototype.setMax=function(n){this.max=n};pu.prototype.setJitter=function(n){this.jitter=n};class N4 extends Dt{constructor(e,t){var r;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,ap(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((r=t.randomizationFactor)!==null&&r!==void 0?r:.5),this.backoff=new pu({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const i=t.parser||tM;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new VB(this.uri,this.opts);const t=this.engine,r=this;this._readyState="opening",this.skipReconnect=!1;const i=Yr(t,"open",function(){r.onopen(),e&&e()}),s=a=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",a),e?e(a):this.maybeReconnectOnOpen()},o=Yr(t,"error",s);if(this._timeout!==!1){const a=this._timeout,l=this.setTimeoutFn(()=>{i(),s(new Error("timeout")),t.close()},a);this.opts.autoUnref&&l.unref(),this.subs.push(()=>{this.clearTimeoutFn(l)})}return this.subs.push(i),this.subs.push(o),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(Yr(e,"ping",this.onping.bind(this)),Yr(e,"data",this.ondata.bind(this)),Yr(e,"error",this.onerror.bind(this)),Yr(e,"close",this.onclose.bind(this)),Yr(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){op(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let r=this.nsps[e];return r?this._autoConnect&&!r.active&&r.connect():(r=new $x(this,e,t),this.nsps[e]=r),r}_destroy(e){const t=Object.keys(this.nsps);for(const r of t)if(this.nsps[r].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let r=0;r<t.length;r++)this.engine.write(t[r],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var r;this.cleanup(),(r=this.engine)===null||r===void 0||r.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const r=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(i=>{i?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",i)):e.onreconnect()}))},t);this.opts.autoUnref&&r.unref(),this.subs.push(()=>{this.clearTimeoutFn(r)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const qu={};function R1(n,e){typeof n=="object"&&(e=n,n=void 0),e=e||{};const t=HB(n,e.path||"/socket.io"),r=t.source,i=t.id,s=t.path,o=qu[i]&&s in qu[i].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||o;let l;return a?l=new N4(r,e):(qu[i]||(qu[i]=new N4(r,e)),l=qu[i]),t.query&&!e.query&&(e.query=t.queryKey),l.socket(t.path,e)}Object.assign(R1,{Manager:N4,Socket:$x,io:R1,connect:R1});class Ux extends rB{constructor(){super(),this.state=new Map,this.initial=new Map,this.metadata=new Map,this.log=new Map}createMatch(e,t){this.initial.set(e,t.initialState),this.setState(e,t.initialState),this.setMetadata(e,t.metadata)}setMetadata(e,t){this.metadata.set(e,t)}setState(e,t,r){if(r&&r.length>0){const i=this.log.get(e)||[];this.log.set(e,[...i,...r])}this.state.set(e,t)}fetch(e,t){const r={};return t.state&&(r.state=this.state.get(e)),t.metadata&&(r.metadata=this.metadata.get(e)),t.log&&(r.log=this.log.get(e)||[]),t.initialState&&(r.initialState=this.initial.get(e)),r}wipe(e){this.state.delete(e),this.metadata.delete(e)}listMatches(e){return[...this.metadata.entries()].filter(([,t])=>e?!(e.gameName!==void 0&&t.gameName!==e.gameName||e.where!==void 0&&(e.where.isGameover!==void 0&&t.gameover!==void 0!==e.where.isGameover||e.where.updatedBefore!==void 0&&t.updatedAt>=e.where.updatedBefore||e.where.updatedAfter!==void 0&&t.updatedAt<=e.where.updatedAfter)):!0).map(([t])=>t)}}class rM extends Map{constructor(e){super(),this.key=e,(JSON.parse(localStorage.getItem(this.key))||[]).forEach(r=>this.set(...r))}sync(){const e=[...this.entries()];localStorage.setItem(this.key,JSON.stringify(e))}set(e,t){return super.set(e,t),this.sync(),this}delete(e){const t=super.delete(e);return this.sync(),t}}class iM extends Ux{constructor(e="bgio"){super();const t=r=>new rM(`${e}_${r}`);this.state=t("state"),this.initial=t("initial"),this.metadata=t("metadata"),this.log=t("log")}}function sM(n,e){if(n.ctx.gameover!==void 0)return null;if(n.ctx.activePlayers){for(const t of Object.keys(e))if(t in n.ctx.activePlayers)return t}else if(n.ctx.currentPlayer in e)return n.ctx.currentPlayer;return null}class oM extends aB{constructor({game:e,bots:t,storageKey:r,persist:i}){const s={},o={};if(e&&e.ai&&t)for(const d in t){const f=t[d];o[d]=new f({game:e,enumerate:e.ai.enumerate,seed:e.seed})}const a=({playerID:d,...f})=>{const p=s[d];p!==void 0&&p(l(d,f))},l=lB(e),c={send:a,sendAll:d=>{for(const f in s)a({playerID:f,...d})}},u=i?new iM(r):new Ux;super(e,u,c),this.connect=(d,f)=>{s[d]=f},this.subscribe(({state:d,matchID:f})=>{if(!t)return;const p=sM(d,o);p!==null&&setTimeout(async()=>{const y=await o[p].play(d,p);await this.onUpdate(y.action,d._stateID,f,y.action.payload.playerID)},100)})}}class aM extends u6{constructor({master:e,...t}){super(t),this.master=e}sendChatMessage(e,t){const r=[e,t,this.credentials];this.master.onChatMessage(...r)}sendAction(e,t){this.master.onUpdate(t,e._stateID,this.matchID,this.playerID)}requestSync(){this.master.onSync(this.matchID,this.playerID,this.credentials,this.numPlayers)}connect(){this.setConnectionStatus(!0),this.master.connect(this.playerID,e=>this.notifyClient(e)),this.requestSync()}disconnect(){this.setConnectionStatus(!1)}updateMatchID(e){this.matchID=e,this.connect()}updatePlayerID(e){this.playerID=e,this.connect()}updateCredentials(e){this.credentials=e,this.connect()}}const Q7=new Map;function Fx({bots:n,persist:e,storageKey:t}={}){return r=>{const{gameKey:i,game:s}=r;let o;const a=Q7.get(i);return a&&a.bots===n&&a.storageKey===t&&a.persist===e&&(o=a.master),o||(o=new oM({game:s,bots:n,persist:e,storageKey:t}),Q7.set(i,{master:o,bots:n,persist:e,storageKey:t})),new aM({master:o,...r})}}const X7=R1;class lM extends u6{constructor({socket:e,socketOpts:t,server:r,...i}){super(i),this.server=r,this.socket=e,this.socketOpts=t}sendAction(e,t){const r=[t,e._stateID,this.matchID,this.playerID];this.socket.emit("update",...r)}sendChatMessage(e,t){const r=[e,t,this.credentials];this.socket.emit("chat",...r)}connect(){if(!this.socket)if(this.server){let e=this.server;e.search(/^https?:\/\//)==-1&&(e="http://"+this.server),e.slice(-1)!="/"&&(e=e+"/"),this.socket=X7(e+this.gameName,this.socketOpts)}else this.socket=X7("/"+this.gameName,this.socketOpts);this.socket.on("patch",(e,t,r,i,s)=>{this.notifyClient({type:"patch",args:[e,t,r,i,s]})}),this.socket.on("update",(e,t,r)=>{this.notifyClient({type:"update",args:[e,t,r]})}),this.socket.on("sync",(e,t)=>{this.notifyClient({type:"sync",args:[e,t]})}),this.socket.on("matchData",(e,t)=>{this.notifyClient({type:"matchData",args:[e,t]})}),this.socket.on("chat",(e,t)=>{this.notifyClient({type:"chat",args:[e,t]})}),this.socket.on("connect",()=>{this.requestSync(),this.setConnectionStatus(!0)}),this.socket.on("disconnect",()=>{this.setConnectionStatus(!1)})}disconnect(){this.socket.close(),this.socket=null,this.setConnectionStatus(!1)}requestSync(){if(this.socket){const e=[this.matchID,this.playerID,this.credentials,this.numPlayers];this.socket.emit("sync",...e)}}updateMatchID(e){this.matchID=e,this.requestSync()}updatePlayerID(e){this.playerID=e,this.requestSync()}updateCredentials(e){this.credentials=e,this.requestSync()}}function J7({server:n,socketOpts:e}={}){return t=>new lM({server:n,socketOpts:e,...t})}function zx(n){var e;const{game:t,numPlayers:r,board:i,multiplayer:s,enhancer:o}=n;let{loading:a,debug:l}=n;return a===void 0&&(a=()=>ae.createElement("div",{className:"bgio-loading"},"connecting...")),e=class extends ae.Component{constructor(u){super(u),l===void 0&&(l=u.debug),this.client=OL({game:t,debug:l,numPlayers:r,multiplayer:s,matchID:u.matchID,playerID:u.playerID,credentials:u.credentials,enhancer:o})}componentDidMount(){this.unsubscribe=this.client.subscribe(()=>this.forceUpdate()),this.client.start()}componentWillUnmount(){this.client.stop(),this.unsubscribe()}componentDidUpdate(u){this.props.matchID!=u.matchID&&this.client.updateMatchID(this.props.matchID),this.props.playerID!=u.playerID&&this.client.updatePlayerID(this.props.playerID),this.props.credentials!=u.credentials&&this.client.updateCredentials(this.props.credentials)}render(){const u=this.client.getState();if(u===null)return ae.createElement(a);let d=null;return i&&(d=ae.createElement(i,{...u,...this.props,isMultiplayer:!!s,moves:this.client.moves,events:this.client.events,matchID:this.client.matchID,playerID:this.client.playerID,reset:this.client.reset,undo:this.client.undo,redo:this.client.redo,log:this.client.log,matchData:this.client.matchData,sendChatMessage:this.client.sendChatMessage,chatMessages:this.client.chatMessages})),ae.createElement("div",{className:"bgio-client"},d)}},e.propTypes={matchID:Ti.string,playerID:Ti.string,credentials:Ti.string,debug:Ti.any},e.defaultProps={matchID:"default",playerID:null,credentials:null,debug:!0},e}class cM{constructor({server:e,gameComponents:t,playerName:r,playerCredentials:i}){this.client=new BL({server:e}),this.gameComponents=t,this.playerName=r||"Visitor",this.playerCredentials=i,this.matches=[]}async refresh(){try{this.matches=[];const e=await this.client.listGames();for(const t of e){if(!this._getGameComponents(t))continue;const{matches:r}=await this.client.listMatches(t);this.matches.push(...r)}}catch(e){throw new Error("failed to retrieve list of matches ("+e+")")}}_getMatchInstance(e){for(const t of this.matches)if(t.matchID===e)return t}_getGameComponents(e){for(const t of this.gameComponents)if(t.game.name===e)return t}_findPlayer(e){for(const t of this.matches)if(t.players.some(r=>r.name===e))return t}async join(e,t,r){try{let i=this._findPlayer(this.playerName);if(i)throw new Error("player has already joined "+i.matchID);if(i=this._getMatchInstance(t),!i)throw new Error("game instance "+t+" not found");const s=await this.client.joinMatch(e,t,{playerID:r,playerName:this.playerName});i.players[Number.parseInt(r)].name=this.playerName,this.playerCredentials=s.playerCredentials}catch(i){throw new Error("failed to join match "+t+" ("+i+")")}}async leave(e,t){try{const r=this._getMatchInstance(t);if(!r)throw new Error("match instance not found");for(const i of r.players)if(i.name===this.playerName){await this.client.leaveMatch(e,t,{playerID:i.id.toString(),credentials:this.playerCredentials}),delete i.name,delete this.playerCredentials;return}throw new Error("player not found in match")}catch(r){throw new Error("failed to leave match "+t+" ("+r+")")}}async disconnect(){const e=this._findPlayer(this.playerName);e&&await this.leave(e.gameName,e.matchID),this.matches=[],this.playerName="Visitor"}async create(e,t){try{const r=this._getGameComponents(e);if(!r)throw new Error("game not found");if(t<r.game.minPlayers||t>r.game.maxPlayers)throw new Error("invalid number of players "+t);await this.client.createMatch(e,{numPlayers:t})}catch(r){throw new Error("failed to create match for "+e+" ("+r+")")}}}function uM(n){return new cM(n)}class Vx extends ae.Component{constructor(){super(...arguments),this.state={playerName:this.props.playerName,nameErrorMsg:""},this.onClickEnter=()=>{this.state.playerName!==""&&this.props.onEnter(this.state.playerName)},this.onKeyPress=e=>{e.key==="Enter"&&this.onClickEnter()},this.onChangePlayerName=e=>{const t=e.target.value.trim();this.setState({playerName:t,nameErrorMsg:t.length>0?"":"empty player name"})}}render(){return ae.createElement("div",null,ae.createElement("p",{className:"phase-title"},"Choose a player name:"),ae.createElement("input",{type:"text",value:this.state.playerName,onChange:this.onChangePlayerName,onKeyPress:this.onKeyPress}),ae.createElement("span",{className:"buttons"},ae.createElement("button",{className:"buttons",onClick:this.onClickEnter},"Enter")),ae.createElement("br",null),ae.createElement("span",{className:"error-msg"},this.state.nameErrorMsg,ae.createElement("br",null)))}}Vx.defaultProps={playerName:""};class dM extends ae.Component{constructor(){super(...arguments),this._createSeat=e=>e.name||"[free]",this._createButtonJoin=(e,t)=>ae.createElement("button",{key:"button-join-"+e.matchID,onClick:()=>this.props.onClickJoin(e.gameName,e.matchID,""+t)},"Join"),this._createButtonLeave=e=>ae.createElement("button",{key:"button-leave-"+e.matchID,onClick:()=>this.props.onClickLeave(e.gameName,e.matchID)},"Leave"),this._createButtonPlay=(e,t)=>ae.createElement("button",{key:"button-play-"+e.matchID,onClick:()=>this.props.onClickPlay(e.gameName,{matchID:e.matchID,playerID:""+t,numPlayers:e.players.length})},"Play"),this._createButtonSpectate=e=>ae.createElement("button",{key:"button-spectate-"+e.matchID,onClick:()=>this.props.onClickPlay(e.gameName,{matchID:e.matchID,numPlayers:e.players.length})},"Spectate"),this._createInstanceButtons=e=>{const t=e.players.find(i=>i.name===this.props.playerName),r=e.players.find(i=>!i.name);return t&&r?this._createButtonLeave(e):r?this._createButtonJoin(e,r.id):t?ae.createElement("div",null,[this._createButtonPlay(e,t.id),this._createButtonLeave(e)]):this._createButtonSpectate(e)}}render(){const e=this.props.match;let t="OPEN";return e.players.some(r=>!r.name)||(t="RUNNING"),ae.createElement("tr",{key:"line-"+e.matchID},ae.createElement("td",{key:"cell-name-"+e.matchID},e.gameName),ae.createElement("td",{key:"cell-status-"+e.matchID},t),ae.createElement("td",{key:"cell-seats-"+e.matchID},e.players.map(r=>this._createSeat(r)).join(", ")),ae.createElement("td",{key:"cell-buttons-"+e.matchID},this._createInstanceButtons(e)))}}class hM extends ae.Component{constructor(e){super(e),this.state={selectedGame:0,numPlayers:2},this._createGameNameOption=(t,r)=>ae.createElement("option",{key:"name-option-"+r,value:r},t.game.name),this._createNumPlayersOption=t=>ae.createElement("option",{key:"num-option-"+t,value:t},t),this._createNumPlayersRange=t=>Array.from({length:t.maxPlayers+1}).map((r,i)=>i).slice(t.minPlayers),this.onChangeNumPlayers=t=>{this.setState({numPlayers:Number.parseInt(t.target.value)})},this.onChangeSelectedGame=t=>{const r=Number.parseInt(t.target.value);this.setState({selectedGame:r,numPlayers:this.props.games[r].game.minPlayers})},this.onClickCreate=()=>{this.props.createMatch(this.props.games[this.state.selectedGame].game.name,this.state.numPlayers)};for(const t of e.games){const r=t.game;r.minPlayers||(r.minPlayers=1),r.maxPlayers||(r.maxPlayers=4),console.assert(r.maxPlayers>=r.minPlayers)}this.state={selectedGame:0,numPlayers:e.games[0].game.minPlayers}}render(){return ae.createElement("div",null,ae.createElement("select",{value:this.state.selectedGame,onChange:e=>this.onChangeSelectedGame(e)},this.props.games.map((e,t)=>this._createGameNameOption(e,t))),ae.createElement("span",null,"Players:"),ae.createElement("select",{value:this.state.numPlayers,onChange:this.onChangeNumPlayers},this._createNumPlayersRange(this.props.games[this.state.selectedGame].game).map(e=>this._createNumPlayersOption(e))),ae.createElement("span",{className:"buttons"},ae.createElement("button",{onClick:this.onClickCreate},"Create")))}}var $n;(function(n){n.ENTER="enter",n.PLAY="play",n.LIST="list"})($n||($n={}));let Hx=class extends ae.Component{constructor(e){super(e),this.state={phase:$n.ENTER,playerName:"Visitor",runningMatch:null,errorMsg:"",credentialStore:{}},this._createConnection=t=>{const r=this.state.playerName;this.connection=uM({server:t.lobbyServer,gameComponents:t.gameComponents,playerName:r,playerCredentials:this.state.credentialStore[r]})},this._updateCredentials=(t,r)=>{this.setState(i=>{const s=Object.assign({},i.credentialStore);return s[t]=r,{credentialStore:s}})},this._updateConnection=async()=>{await this.connection.refresh(),this.forceUpdate()},this._enterLobby=t=>{this._startRefreshInterval(),this.setState({playerName:t,phase:$n.LIST})},this._exitLobby=async()=>{this._clearRefreshInterval(),await this.connection.disconnect(),this.setState({phase:$n.ENTER,errorMsg:""})},this._createMatch=async(t,r)=>{try{await this.connection.create(t,r),await this.connection.refresh(),this.setState({})}catch(i){this.setState({errorMsg:i.message})}},this._joinMatch=async(t,r,i)=>{try{await this.connection.join(t,r,i),await this.connection.refresh(),this._updateCredentials(this.connection.playerName,this.connection.playerCredentials)}catch(s){this.setState({errorMsg:s.message})}},this._leaveMatch=async(t,r)=>{try{await this.connection.leave(t,r),await this.connection.refresh(),this._updateCredentials(this.connection.playerName,this.connection.playerCredentials)}catch(i){this.setState({errorMsg:i.message})}},this._startMatch=(t,r)=>{const i=this.connection._getGameComponents(t);if(!i){this.setState({errorMsg:"game "+t+" not supported"});return}let s;if(r.numPlayers>1&&(s=this.props.gameServer?J7({server:this.props.gameServer}):J7()),r.numPlayers==1){const l=i.game.maxPlayers,c={};for(let u=1;u<l;u++)c[u+""]=bL;s=Fx({bots:c})}const a={app:this.props.clientFactory({game:i.game,board:i.board,debug:this.props.debug,multiplayer:s}),matchID:r.matchID,playerID:r.numPlayers>1?r.playerID:"0",credentials:this.connection.playerCredentials};this._clearRefreshInterval(),this.setState({phase:$n.PLAY,runningMatch:a})},this._exitMatch=()=>{this._startRefreshInterval(),this.setState({phase:$n.LIST,runningMatch:null})},this._getPhaseVisibility=t=>this.state.phase!==t?"hidden":"phase",this.renderMatches=(t,r)=>t.map(i=>{const{matchID:s,gameName:o,players:a}=i;return ae.createElement(dM,{key:"instance-"+s,match:{matchID:s,gameName:o,players:Object.values(a)},playerName:r,onClickJoin:this._joinMatch,onClickLeave:this._leaveMatch,onClickPlay:this._startMatch})}),this._createConnection(this.props)}componentDidMount(){const e=H7.load("lobbyState")||{};e.phase&&e.phase===$n.PLAY&&(e.phase=$n.LIST),e.phase&&e.phase!==$n.ENTER&&this._startRefreshInterval(),this.setState({phase:e.phase||$n.ENTER,playerName:e.playerName||"Visitor",credentialStore:e.credentialStore||{}})}componentDidUpdate(e,t){const r=this.state.playerName,i=this.state.credentialStore[r];if(t.phase!==this.state.phase||t.credentialStore[r]!==i||t.playerName!==r){this._createConnection(this.props),this._updateConnection();const s={phase:this.state.phase,playerName:r,credentialStore:this.state.credentialStore};H7.save("lobbyState",s,{path:"/"})}e.refreshInterval!==this.props.refreshInterval&&this._startRefreshInterval()}componentWillUnmount(){this._clearRefreshInterval()}_startRefreshInterval(){this._clearRefreshInterval(),this._currentInterval=setInterval(this._updateConnection,this.props.refreshInterval)}_clearRefreshInterval(){clearInterval(this._currentInterval)}render(){const{gameComponents:e,renderer:t}=this.props,{errorMsg:r,playerName:i,phase:s,runningMatch:o}=this.state;return t?t({errorMsg:r,gameComponents:e,matches:this.connection.matches,phase:s,playerName:i,runningMatch:o,handleEnterLobby:this._enterLobby,handleExitLobby:this._exitLobby,handleCreateMatch:this._createMatch,handleJoinMatch:this._joinMatch,handleLeaveMatch:this._leaveMatch,handleExitMatch:this._exitMatch,handleRefreshMatches:this._updateConnection,handleStartMatch:this._startMatch}):ae.createElement("div",{id:"lobby-view",style:{padding:50}},ae.createElement("div",{className:this._getPhaseVisibility($n.ENTER)},ae.createElement(Vx,{key:i,playerName:i,onEnter:this._enterLobby})),ae.createElement("div",{className:this._getPhaseVisibility($n.LIST)},ae.createElement("p",null,"Welcome, ",i),ae.createElement("div",{className:"phase-title",id:"match-creation"},ae.createElement("span",null,"Create a match:"),ae.createElement(hM,{games:e,createMatch:this._createMatch})),ae.createElement("p",{className:"phase-title"},"Join a match:"),ae.createElement("div",{id:"instances"},ae.createElement("table",null,ae.createElement("tbody",null,this.renderMatches(this.connection.matches,i))),ae.createElement("span",{className:"error-msg"},r,ae.createElement("br",null))),ae.createElement("p",{className:"phase-title"},"Matches that become empty are automatically deleted.")),ae.createElement("div",{className:this._getPhaseVisibility($n.PLAY)},o&&ae.createElement(o.app,{matchID:o.matchID,playerID:o.playerID,credentials:o.credentials}),ae.createElement("div",{className:"buttons",id:"match-exit"},ae.createElement("button",{onClick:this._exitMatch},"Exit match"))),ae.createElement("div",{className:"buttons",id:"lobby-exit"},ae.createElement("button",{onClick:this._exitLobby},"Exit lobby")))}};Hx.propTypes={gameComponents:Ti.array.isRequired,lobbyServer:Ti.string,gameServer:Ti.string,debug:Ti.bool,clientFactory:Ti.func,refreshInterval:Ti.number};Hx.defaultProps={debug:!1,clientFactory:zx,refreshInterval:2e3};function fM(n,e){const t={},r={};for(let i=0;i<e;i++)t[i.toString()]=[],r[i.toString()]=[];return{deck:pM(n),hands:t,field:r,discard:[],winner:null,maxHandSize:7,cardsToWin:5}}function pM(n){const e=n.slice();for(let t=e.length-1;t>0;t--){const r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e}function gM(n,e){const t=n.deck.slice(),r={...n.hands};if(t.length===0)return{state:{...n,deck:t,hands:r},drawnCard:null};const i=t.shift(),s=(r[e]||[]).slice();return s.push(i),r[e]=s,{state:{...n,deck:t,hands:r},drawnCard:i}}function yM(n,e,t){const r={...n.hands},i={...n.field},s=(r[e]||[]).slice(),o=s.findIndex(u=>u.id===t);if(o===-1)return{state:n,success:!1,error:"Card not in hand"};const[a]=s.splice(o,1);r[e]=s;const l=(i[e]||[]).slice();l.push(a),i[e]=l;let c=n.winner;return l.length>=n.cardsToWin&&(c=e),{state:{...n,hands:r,field:i,winner:c},success:!0}}function mM(n,e,t){const r={...n.hands},i=n.discard.slice(),s=(r[e]||[]).slice(),o=s.findIndex(l=>l.id===t);if(o===-1)return{state:n,success:!1,error:"Card not in hand"};const[a]=s.splice(o,1);return r[e]=s,i.push(a),{state:{...n,hands:r,discard:i},success:!0}}function wM(n){return n.winner!==null||n.deck.length===0}function vM(n=20){const e=[];for(let t=1;t<=n;t++)e.push({id:`card-${t}`,name:`Card ${t}`});return e}const EM={name:"simple-card-game",setup:()=>{const n=vM(20);return fM(n,2)},turn:{minMoves:1,maxMoves:3},moves:{drawCard:({G:n,ctx:e})=>{const t=gM(n,e.currentPlayer);return t.drawnCard?t.state:ec},playCard:({G:n,ctx:e},t)=>{const r=yM(n,e.currentPlayer,t);return r.success?r.state:ec},discardCard:({G:n,ctx:e},t)=>{const r=mM(n,e.currentPlayer,t);return r.success?r.state:ec}},endIf:({G:n})=>{if(n.winner)return{winner:n.winner};if(wM(n))return{draw:!0}}},bM=Symbol.for("@libp2p/connection"),Cc=Symbol.for("@libp2p/content-routing"),A0=Symbol.for("@libp2p/peer-discovery"),lp=Symbol.for("@libp2p/peer-id");function cp(n){return n!=null&&!!n[lp]}const Tc=Symbol.for("@libp2p/peer-routing"),_M="keep-alive",Kh=Symbol.for("@libp2p/transport");var tc;(function(n){n[n.FATAL_ALL=0]="FATAL_ALL",n[n.NO_FATAL=1]="NO_FATAL"})(tc||(tc={}));var gs;let up=(gs=class extends Error{constructor(t="The operation was aborted"){super(t);h(this,"code");h(this,"type");this.name="AbortError",this.code=gs.code,this.type=gs.type}},h(gs,"code","ABORT_ERR"),h(gs,"type","aborted"),gs),S=class extends Error{constructor(t,r,i){super(t);h(this,"code");h(this,"props");this.code=r,this.name=(i==null?void 0:i.name)??"CodeError",this.props=i??{}}};class SM extends AggregateError{constructor(t,r,i,s){super(t,r);h(this,"code");h(this,"props");this.code=i,this.name=(s==null?void 0:s.name)??"AggregateCodeError",this.props=s??{}}}const Nc="ERR_TIMEOUT",sa="ERR_INVALID_MESSAGE";const ue=(n,...e)=>{try{[...e]}catch{}};var Ri,oE;let tn=(oE=class extends EventTarget{constructor(){super();le(this,Ri,new Map);ue(1/0,this)}listenerCount(t){const r=I(this,Ri).get(t);return r==null?0:r.length}addEventListener(t,r,i){super.addEventListener(t,r,i);let s=I(this,Ri).get(t);s==null&&(s=[],I(this,Ri).set(t,s)),s.push({callback:r,once:(i!==!0&&i!==!1&&(i==null?void 0:i.once))??!1})}removeEventListener(t,r,i){super.removeEventListener(t.toString(),r??null,i);let s=I(this,Ri).get(t);s!=null&&(s=s.filter(({callback:o})=>o!==r),I(this,Ri).set(t,s))}dispatchEvent(t){const r=super.dispatchEvent(t);let i=I(this,Ri).get(t.type);return i==null||(i=i.filter(({once:s})=>!s),I(this,Ri).set(t.type,i)),r}safeDispatchEvent(t,r={}){return this.dispatchEvent(new ui(t,r))}},Ri=new WeakMap,oE);const ui=globalThis.CustomEvent;function w6(n){return n!=null&&typeof n.start=="function"&&typeof n.stop=="function"}async function gu(...n){const e=[];for(const t of n)w6(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function yu(...n){const e=[];for(const t of n)w6(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const Dn=Symbol.for("@libp2p/service-capabilities"),Dc=Symbol.for("@libp2p/service-dependencies");function bt(n){const e=new globalThis.AbortController;function t(){e.abort();for(const s of n)(s==null?void 0:s.removeEventListener)!=null&&s.removeEventListener("abort",t)}for(const s of n){if((s==null?void 0:s.aborted)===!0){t();break}(s==null?void 0:s.addEventListener)!=null&&s.addEventListener("abort",t)}function r(){for(const s of n)(s==null?void 0:s.removeEventListener)!=null&&s.removeEventListener("abort",t)}const i=e.signal;return i.clear=r,i}function Se(){const n={};return n.promise=new Promise((e,t)=>{n.resolve=e,n.reject=t}),n}class Z7{constructor(e){h(this,"buffer");h(this,"mask");h(this,"top");h(this,"btm");h(this,"next");if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class Bg{constructor(e={}){h(this,"size");h(this,"hwm");h(this,"head");h(this,"tail");this.hwm=e.splitLimit??16,this.head=new Z7(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return(e==null?void 0:e.byteLength)!=null?e.byteLength:1}push(e){if((e==null?void 0:e.value)!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new Z7(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return(e==null?void 0:e.value)!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let xM=class extends Error{constructor(t,r){super(t??"The operation was aborted");h(this,"type");h(this,"code");this.type="aborted",this.code=r??"ABORT_ERR"}};function Ko(n={}){return kM(t=>{const r=t.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function kM(n,e){e=e??{};let t=e.onEnd,r=new Bg,i,s,o,a=Se();const l=async()=>{try{return r.isEmpty()?o?{done:!0}:await new Promise((w,m)=>{s=E=>{s=null,r.push(E);try{w(n(r))}catch(v){m(v)}return i}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=Se()})}},c=w=>s!=null?s(w):(r.push(w),i),u=w=>(r=new Bg,s!=null?s({error:w}):(r.push({error:w}),i)),d=w=>{if(o)return i;if((e==null?void 0:e.objectMode)!==!0&&(w==null?void 0:w.byteLength)==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return c({done:!1,value:w})},f=w=>o?i:(o=!0,w!=null?u(w):c({done:!0})),p=()=>(r=new Bg,f(),{done:!0}),y=w=>(f(w),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:l,return:p,throw:y,push:d,end:f,get readableLength(){return r.size},onEmpty:async w=>{const m=w==null?void 0:w.signal;if(m==null||m.throwIfAborted(),r.isEmpty())return;let E,v;m!=null&&(E=new Promise((b,k)=>{v=()=>{k(new xM)},m.addEventListener("abort",v)}));try{await Promise.race([a.promise,E])}finally{v!=null&&m!=null&&(m==null||m.removeEventListener("abort",v))}}},t==null)return i;const g=i;return i={[Symbol.asyncIterator](){return this},next(){return g.next()},throw(w){return g.throw(w),t!=null&&(t(w),t=void 0),{done:!0}},return(){return g.return(),t!=null&&(t(),t=void 0),{done:!0}},push:d,end(w){return g.end(w),t!=null&&(t(w),t=void 0),i},get readableLength(){return g.readableLength},onEmpty:w=>g.onEmpty(w)},i}var b3;let Pc=(b3=class extends Error{constructor(t="The operation was aborted",...r){super(t,...r);h(this,"name","AbortError")}},h(b3,"name","AbortError"),b3);async function Nr(n,e,t,r){const i=new Pc(r==null?void 0:r.errorMessage);(r==null?void 0:r.errorCode)!=null&&(i.code=r.errorCode);const s=(r==null?void 0:r.errorEvent)??"error";return(t==null?void 0:t.aborted)===!0?Promise.reject(i):new Promise((o,a)=>{function l(){$g(t,"abort",d),$g(n,e,c),$g(n,s,u)}const c=f=>{var p;try{if(((p=r==null?void 0:r.filter)==null?void 0:p.call(r,f))===!1)return}catch(y){l(),a(y);return}l(),o(f)},u=f=>{if(l(),f instanceof Error){a(f);return}a(f.detail??(r==null?void 0:r.error)??new Error(`The "${r==null?void 0:r.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},d=()=>{l(),a(i)};Mg(t,"abort",d),Mg(n,e,c),Mg(n,s,u)})}function Mg(n,e,t){n!=null&&(Kx(n)?n.addEventListener(e,t):n.addListener(e,t))}function $g(n,e,t){n!=null&&(Kx(n)?n.removeEventListener(e,t):n.removeListener(e,t))}function Kx(n){return typeof n.addEventListener=="function"&&typeof n.removeEventListener=="function"}let ew=class extends Error{constructor(t,r,i){super(t??"The operation was aborted");h(this,"type");h(this,"code");this.type="aborted",this.name=i??"AbortError",this.code=r??"ABORT_ERR"}};async function Pt(n,e,t){if(e==null)return n;if(e.aborted)return n.catch(()=>{}),Promise.reject(new ew(t==null?void 0:t.errorMessage,t==null?void 0:t.errorCode,t==null?void 0:t.errorName));let r;const i=new ew(t==null?void 0:t.errorMessage,t==null?void 0:t.errorCode,t==null?void 0:t.errorName);try{return await Promise.race([n,new Promise((s,o)=>{r=()=>{o(i)},e.addEventListener("abort",r)})])}finally{r!=null&&e.removeEventListener("abort",r)}}let RM=class{constructor(e){h(this,"deferred");h(this,"signal");var t;this.signal=e,this.deferred=Se(),this.onAbort=this.onAbort.bind(this),(t=this.signal)==null||t.addEventListener("abort",this.onAbort)}onAbort(){var e;this.deferred.reject(((e=this.signal)==null?void 0:e.reason)??new up)}cleanup(){var e;(e=this.signal)==null||e.removeEventListener("abort",this.onAbort)}};function AM(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let IM=class{constructor(e,t){h(this,"id");h(this,"fn");h(this,"options");h(this,"recipients");h(this,"status");h(this,"timeline");h(this,"controller");this.id=AM(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,ue(1/0,this.controller.signal),this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>{var i;return t&&((i=r.signal)==null?void 0:i.aborted)===!0},!0)&&(this.controller.abort(new up),this.cleanup())}async join(e={}){var r;const t=new RM(e.signal);return this.recipients.push(t),(r=e.signal)==null||r.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Pt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{var t;e.cleanup(),(t=e.signal)==null||t.removeEventListener("abort",this.onAbort)})}},Oc=class extends tn{constructor(t={}){var r;super();h(this,"concurrency");h(this,"queue");h(this,"pending");h(this,"sort");this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.pending=0,t.metricName!=null&&((r=t.metrics)==null||r.registerMetricGroup(t.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})})),this.sort=t.sort,this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let t;for(const r of this.queue)if(r.status==="queued"){t=r;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let r=0;r<this.queue.length;r++)if(this.queue[r]===t){this.queue.splice(r,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}async add(t,r){var s;(s=r==null?void 0:r.signal)==null||s.throwIfAborted();const i=new IM(t,r);return this.enqueue(i),this.safeDispatchEvent("add"),this.tryToStartAnother(),i.join(r).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:i,result:o}}),o)).catch(o=>{if(i.status==="queued"){for(let a=0;a<this.queue.length;a++)if(this.queue[a]===i){this.queue.splice(a,1);break}}throw this.safeDispatchEvent("error",{detail:o}),this.safeDispatchEvent("failure",{detail:{job:i,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new up)}),this.clear()}async onEmpty(t){this.size!==0&&await Nr(this,"empty",t==null?void 0:t.signal)}async onSizeLessThan(t,r){this.size<t||await Nr(this,"next",r==null?void 0:r.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await Nr(this,"idle",t==null?void 0:t.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){var c,u,d;(c=t==null?void 0:t.signal)==null||c.throwIfAborted();const r=Ko({objectMode:!0}),i=f=>{f!=null?this.abort():this.clear(),r.end(f)},s=f=>{f.detail!=null&&r.push(f.detail)},o=f=>{i(f.detail)},a=()=>{i()},l=()=>{i(new S("Queue aborted","ERR_QUEUE_ABORTED"))};this.addEventListener("completed",s),this.addEventListener("error",o),this.addEventListener("idle",a),(u=t==null?void 0:t.signal)==null||u.addEventListener("abort",l);try{yield*r}finally{this.removeEventListener("completed",s),this.removeEventListener("error",o),this.removeEventListener("idle",a),(d=t==null?void 0:t.signal)==null||d.removeEventListener("abort",l),i()}}};class mu extends Oc{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}function CM(n){return n[Symbol.asyncIterator]!=null}function Fa(n){if(CM(n))return(async()=>{for await(const e of n);})();for(const e of n);}function Xe(n=0){return new Uint8Array(n)}function dr(n=0){return new Uint8Array(n)}const TM=Math.pow(2,7),NM=Math.pow(2,14),DM=Math.pow(2,21),v6=Math.pow(2,28),E6=Math.pow(2,35),b6=Math.pow(2,42),_6=Math.pow(2,49),qe=128,hn=127;function ht(n){if(n<TM)return 1;if(n<NM)return 2;if(n<DM)return 3;if(n<v6)return 4;if(n<E6)return 5;if(n<b6)return 6;if(n<_6)return 7;if(Number.MAX_SAFE_INTEGER!=null&&n>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function I0(n,e,t=0){switch(ht(n)){case 8:e[t++]=n&255|qe,n/=128;case 7:e[t++]=n&255|qe,n/=128;case 6:e[t++]=n&255|qe,n/=128;case 5:e[t++]=n&255|qe,n/=128;case 4:e[t++]=n&255|qe,n>>>=7;case 3:e[t++]=n&255|qe,n>>>=7;case 2:e[t++]=n&255|qe,n>>>=7;case 1:{e[t++]=n&255,n>>>=7;break}default:throw new Error("unreachable")}return e}function PM(n,e,t=0){switch(ht(n)){case 8:e.set(t++,n&255|qe),n/=128;case 7:e.set(t++,n&255|qe),n/=128;case 6:e.set(t++,n&255|qe),n/=128;case 5:e.set(t++,n&255|qe),n/=128;case 4:e.set(t++,n&255|qe),n>>>=7;case 3:e.set(t++,n&255|qe),n>>>=7;case 2:e.set(t++,n&255|qe),n>>>=7;case 1:{e.set(t++,n&255),n>>>=7;break}default:throw new Error("unreachable")}return e}function Wx(n,e){let t=n[e],r=0;if(r+=t&hn,t<qe||(t=n[e+1],r+=(t&hn)<<7,t<qe)||(t=n[e+2],r+=(t&hn)<<14,t<qe)||(t=n[e+3],r+=(t&hn)<<21,t<qe)||(t=n[e+4],r+=(t&hn)*v6,t<qe)||(t=n[e+5],r+=(t&hn)*E6,t<qe)||(t=n[e+6],r+=(t&hn)*b6,t<qe)||(t=n[e+7],r+=(t&hn)*_6,t<qe))return r;throw new RangeError("Could not decode varint")}function OM(n,e){let t=n.get(e),r=0;if(r+=t&hn,t<qe||(t=n.get(e+1),r+=(t&hn)<<7,t<qe)||(t=n.get(e+2),r+=(t&hn)<<14,t<qe)||(t=n.get(e+3),r+=(t&hn)<<21,t<qe)||(t=n.get(e+4),r+=(t&hn)*v6,t<qe)||(t=n.get(e+5),r+=(t&hn)*E6,t<qe)||(t=n.get(e+6),r+=(t&hn)*b6,t<qe)||(t=n.get(e+7),r+=(t&hn)*_6,t<qe))return r;throw new RangeError("Could not decode varint")}function ii(n,e,t=0){return e==null&&(e=dr(ht(n))),e instanceof Uint8Array?I0(n,e,t):PM(n,e,t)}function wu(n,e=0){return n instanceof Uint8Array?Wx(n,e):OM(n,e)}function vn(n,e){e==null&&(e=n.reduce((i,s)=>i+s.length,0));const t=dr(e);let r=0;for(const i of n)t.set(i,r),r+=i.length;return t}function Pe(n,e){if(n===e)return!0;if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return!1;return!0}const Gx=Symbol.for("@achingbrain/uint8arraylist");function tw(n,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const r of n){const i=t+r.byteLength;if(e<i)return{buf:r,index:e-t};t=i}throw new RangeError("index is out of bounds")}function ud(n){return!!(n!=null&&n[Gx])}var aE;class Fe{constructor(...e){h(this,"bufs");h(this,"length");h(this,aE,!0);this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[(aE=Gx,Symbol.iterator)](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const r of e)if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.push(r);else if(ud(r))t+=r.byteLength,this.bufs.push(...r.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const r of e.reverse())if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.unshift(r);else if(ud(r))t+=r.byteLength,this.bufs.unshift(...r.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=tw(this.bufs,e);return t.buf[t.index]}set(e,t){const r=tw(this.bufs,e);r.buf[r.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let r=0;r<e.length;r++)this.set(t+r,e[r]);else if(ud(e))for(let r=0;r<e.length;r++)this.set(t+r,e.get(r));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:r,length:i}=this._subList(e,t);return vn(r,i)}subarray(e,t){const{bufs:r,length:i}=this._subList(e,t);return r.length===1?r[0]:vn(r,i)}sublist(e,t){const{bufs:r,length:i}=this._subList(e,t),s=new Fe;return s.length=i,s.bufs=[...r],s}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const r=[];let i=0;for(let s=0;s<this.bufs.length;s++){const o=this.bufs[s],a=i,l=a+o.byteLength;if(i=l,e>=l)continue;const c=e>=a&&e<l,u=t>a&&t<=l;if(c&&u){if(e===a&&t===l){r.push(o);break}const d=e-a;r.push(o.subarray(d,d+(t-e)));break}if(c){if(e===0){r.push(o);continue}r.push(o.subarray(e-a));continue}if(u){if(t===l){r.push(o);break}r.push(o.subarray(0,t-a));break}r.push(o)}return{bufs:r,length:t-e}}indexOf(e,t=0){if(!ud(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const r=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const i=r.byteLength;if(i===0)throw new TypeError("search must be at least 1 byte long");const s=256,o=new Int32Array(s);for(let d=0;d<s;d++)o[d]=-1;for(let d=0;d<i;d++)o[r[d]]=d;const a=o,l=this.byteLength-r.byteLength,c=r.byteLength-1;let u;for(let d=t;d<=l;d+=u){u=0;for(let f=c;f>=0;f--){const p=this.get(d+f);if(r[f]!==p){u=Math.max(1,f-a[p]);break}}if(u===0)return d}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const r=dr(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt8(0,t),this.write(r,e)}getInt16(e,t){const r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt16(0,t)}setInt16(e,t,r){const i=Xe(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt16(0,t,r),this.write(i,e)}getInt32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt32(0,t)}setInt32(e,t,r){const i=Xe(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt32(0,t,r),this.write(i,e)}getBigInt64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigInt64(0,t)}setBigInt64(e,t,r){const i=Xe(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigInt64(0,t,r),this.write(i,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const r=dr(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint8(0,t),this.write(r,e)}getUint16(e,t){const r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,t)}setUint16(e,t,r){const i=Xe(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint16(0,t,r),this.write(i,e)}getUint32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(0,t)}setUint32(e,t,r){const i=Xe(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint32(0,t,r),this.write(i,e)}getBigUint64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigUint64(0,t)}setBigUint64(e,t,r){const i=Xe(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigUint64(0,t,r),this.write(i,e)}getFloat32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat32(0,t)}setFloat32(e,t,r){const i=Xe(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat32(0,t,r),this.write(i,e)}getFloat64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat64(0,t)}setFloat64(e,t,r){const i=Xe(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat64(0,t,r),this.write(i,e)}equals(e){if(e==null||!(e instanceof Fe)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!Pe(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const r=new Fe;return r.bufs=e,t==null&&(t=e.reduce((i,s)=>i+s.byteLength,0)),r.length=t,r}}function qx(n){return n[Symbol.asyncIterator]!=null}const dp=n=>{const e=ht(n),t=dr(e);return ii(n,t),dp.bytes=e,t};dp.bytes=0;function No(n,e){e=e??{};const t=e.lengthEncoder??dp;function*r(i){const s=t(i.byteLength);s instanceof Uint8Array?yield s:yield*s,i instanceof Uint8Array?yield i:yield*i}return qx(n)?async function*(){for await(const i of n)yield*r(i)}():function*(){for(const i of n)yield*r(i)}()}No.single=(n,e)=>{e=e??{};const t=e.lengthEncoder??dp;return new Fe(t(n.byteLength),n)};let LM=class extends Error{constructor(){super(...arguments);h(this,"name","InvalidMessageLengthError");h(this,"code","ERR_INVALID_MSG_LENGTH")}},BM=class extends Error{constructor(){super(...arguments);h(this,"name","InvalidDataLengthError");h(this,"code","ERR_MSG_DATA_TOO_LONG")}},MM=class extends Error{constructor(){super(...arguments);h(this,"name","InvalidDataLengthLengthError");h(this,"code","ERR_MSG_LENGTH_TOO_LONG")}},nw=class extends Error{constructor(){super(...arguments);h(this,"name","UnexpectedEOFError");h(this,"code","ERR_UNEXPECTED_EOF")}};const $M=8,UM=1024*1024*4;var la;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(la||(la={}));const S6=n=>{const e=wu(n);return S6.bytes=ht(e),e};S6.bytes=0;function Do(n,e){const t=new Fe;let r=la.LENGTH,i=-1;const s=(e==null?void 0:e.lengthDecoder)??S6,o=(e==null?void 0:e.maxLengthLength)??$M,a=(e==null?void 0:e.maxDataLength)??UM;function*l(){for(;t.byteLength>0;){if(r===la.LENGTH)try{if(i=s(t),i<0)throw new LM("Invalid message length");if(i>a)throw new BM("Message length too long");const c=s.bytes;t.consume(c),(e==null?void 0:e.onLength)!=null&&e.onLength(i),r=la.DATA}catch(c){if(c instanceof RangeError){if(t.byteLength>o)throw new MM("Message length length too long");break}throw c}if(r===la.DATA){if(t.byteLength<i)break;const c=t.sublist(0,i);t.consume(i),(e==null?void 0:e.onData)!=null&&e.onData(c),yield c,r=la.LENGTH}}}return qx(n)?async function*(){for await(const c of n)t.append(c),yield*l();if(t.byteLength>0)throw new nw("Unexpected end of input")}():function*(){for(const c of n)t.append(c),yield*l();if(t.byteLength>0)throw new nw("Unexpected end of input")}()}Do.fromReader=(n,e)=>{let t=1;const r=async function*(){for(;;)try{const{done:s,value:o}=await n.next(t);if(s===!0)return;o!=null&&(yield o)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{t=1}}();return Do(r,{...e??{},onLength:s=>{t=s}})};function x6(n){const[e,t]=n[Symbol.asyncIterator]!=null?[n[Symbol.asyncIterator](),Symbol.asyncIterator]:[n[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>e.next(),push:i=>{r.push(i)},next:()=>r.length>0?{done:!1,value:r.shift()}:e.next(),[t](){return this}}}function FM(n){return n[Symbol.asyncIterator]!=null}function Wo(n,e){let t=0;if(FM(n))return async function*(){for await(const l of n)yield e(l,t++)}();const r=x6(n),{value:i,done:s}=r.next();if(s===!0)return function*(){}();const o=e(i,t++);if(typeof o.then=="function")return async function*(){yield await o;for(const l of r)yield e(l,t++)}();const a=e;return function*(){yield o;for(const l of r)yield a(l,t++)}()}let zM=class{constructor(){h(this,"readNext");h(this,"haveNext");h(this,"ended");h(this,"nextResult");h(this,"error");this.ended=!1,this.readNext=Se(),this.haveNext=Se()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Se(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Se(),await Pt(this.readNext.promise,t==null?void 0:t.signal,t)}};function VM(){return new zM}function HM(n){return n[Symbol.asyncIterator]!=null}async function KM(n,e,t){try{await Promise.all(n.map(async r=>{for await(const i of r)await e.push(i,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(r){await e.end(r,{signal:t}).catch(()=>{})}}async function*WM(n){const e=new AbortController,t=VM();KM(n,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*GM(n){for(const e of n)yield*e}function xo(...n){const e=[];for(const t of n)HM(t)||e.push(t);return e.length===n.length?GM(e):WM(n)}function En(n,...e){if(n==null)throw new Error("Empty pipeline");if(Ug(n)){const r=n;n=()=>r.source}else if(Yx(n)||jx(n)){const r=n;n=()=>r}const t=[n,...e];if(t.length>1&&Ug(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let r=1;r<t.length-1;r++)Ug(t[r])&&(t[r]=jM(t[r]));return qM(...t)}const qM=(...n)=>{let e;for(;n.length>0;)e=n.shift()(e);return e},jx=n=>(n==null?void 0:n[Symbol.asyncIterator])!=null,Yx=n=>(n==null?void 0:n[Symbol.iterator])!=null,Ug=n=>n==null?!1:n.sink!=null&&n.source!=null,jM=n=>e=>{const t=n.sink(e);if((t==null?void 0:t.then)!=null){const r=Ko({objectMode:!0});t.then(()=>{r.end()},o=>{r.end(o)});let i;const s=n.source;if(jx(s))i=async function*(){yield*s,r.end()};else if(Yx(s))i=function*(){yield*s,r.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return xo(r,i())}return n.source};function YM(n){return n[Symbol.asyncIterator]!=null}function C0(n,e){return YM(n)?async function*(){let t=0;if(!(e<1)){for await(const r of n)if(yield r,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(const r of n)if(yield r,t++,t===e)return}}()}class se extends Event{constructor(t,r){super(t);h(this,"type");h(this,"detail");this.type=t,this.detail=r}}const Mf="/ipfs/bitswap/1.2.0",QM=1024,XM=1024,JM=1024,ZM=5e3,e$=10,t$=50,n$=!1,r$=3,Qx=1024*1024*4,i$=Qx,k6=new Float32Array([-0]),ho=new Uint8Array(k6.buffer);function s$(n,e,t){k6[0]=n,e[t]=ho[0],e[t+1]=ho[1],e[t+2]=ho[2],e[t+3]=ho[3]}function o$(n,e){return ho[0]=n[e],ho[1]=n[e+1],ho[2]=n[e+2],ho[3]=n[e+3],k6[0]}const R6=new Float64Array([-0]),fn=new Uint8Array(R6.buffer);function a$(n,e,t){R6[0]=n,e[t]=fn[0],e[t+1]=fn[1],e[t+2]=fn[2],e[t+3]=fn[3],e[t+4]=fn[4],e[t+5]=fn[5],e[t+6]=fn[6],e[t+7]=fn[7]}function l$(n,e){return fn[0]=n[e],fn[1]=n[e+1],fn[2]=n[e+2],fn[3]=n[e+3],fn[4]=n[e+4],fn[5]=n[e+5],fn[6]=n[e+6],fn[7]=n[e+7],R6[0]}const c$=BigInt(Number.MAX_SAFE_INTEGER),u$=BigInt(Number.MIN_SAFE_INTEGER);class yn{constructor(e,t){h(this,"lo");h(this,"hi");this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let r=~this.hi>>>0;return t===0&&(r=r+1>>>0),-(t+r*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let r=~this.hi>>>0;return t===0&&(r=r+1>>>0),-(BigInt(t)+(BigInt(r)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return r===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:r<128?9:10}static fromBigInt(e){if(e===0n)return Ta;if(e<c$&&e>u$)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let r=e>>32n,i=e-(r<<32n);return t&&(r=~r|0n,i=~i|0n,++i>rw&&(i=0n,++r>rw&&(r=0n))),new yn(Number(i),Number(r))}static fromNumber(e){if(e===0)return Ta;const t=e<0;t&&(e=-e);let r=e>>>0,i=(e-r)/4294967296>>>0;return t&&(i=~i>>>0,r=~r>>>0,++r>4294967295&&(r=0,++i>4294967295&&(i=0))),new yn(r,i)}static from(e){return typeof e=="number"?yn.fromNumber(e):typeof e=="bigint"?yn.fromBigInt(e):typeof e=="string"?yn.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new yn(e.low>>>0,e.high>>>0):Ta}}const Ta=new yn(0,0);Ta.toBigInt=function(){return 0n};Ta.zzEncode=Ta.zzDecode=function(){return this};Ta.length=function(){return 1};const rw=4294967296n;function d$(n){let e=0,t=0;for(let r=0;r<n.length;++r)t=n.charCodeAt(r),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(n.charCodeAt(r+1)&64512)===56320?(++r,e+=4):e+=3;return e}function h$(n,e,t){if(t-e<1)return"";let i;const s=[];let o=0,a;for(;e<t;)a=n[e++],a<128?s[o++]=a:a>191&&a<224?s[o++]=(a&31)<<6|n[e++]&63:a>239&&a<365?(a=((a&7)<<18|(n[e++]&63)<<12|(n[e++]&63)<<6|n[e++]&63)-65536,s[o++]=55296+(a>>10),s[o++]=56320+(a&1023)):s[o++]=(a&15)<<12|(n[e++]&63)<<6|n[e++]&63,o>8191&&((i??(i=[])).push(String.fromCharCode.apply(String,s)),o=0);return i!=null?(o>0&&i.push(String.fromCharCode.apply(String,s.slice(0,o))),i.join("")):String.fromCharCode.apply(String,s.slice(0,o))}function Xx(n,e,t){const r=t;let i,s;for(let o=0;o<n.length;++o)i=n.charCodeAt(o),i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&((s=n.charCodeAt(o+1))&64512)===56320?(i=65536+((i&1023)<<10)+(s&1023),++o,e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128);return t-r}function Vr(n,e){return RangeError(`index out of range: ${n.pos} + ${e??1} > ${n.len}`)}function $f(n,e){return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0}class f${constructor(e){h(this,"buf");h(this,"pos");h(this,"len");h(this,"_slice",Uint8Array.prototype.subarray);this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Vr(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Vr(this,4);return $f(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Vr(this,4);return $f(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Vr(this,4);const e=o$(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Vr(this,4);const e=l$(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,r=this.pos+e;if(r>this.len)throw Vr(this,e);return this.pos+=e,t===r?new Uint8Array(0):this.buf.subarray(t,r)}string(){const e=this.bytes();return h$(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Vr(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Vr(this);while(this.buf[this.pos++]&128);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new yn(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw Vr(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Vr(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Vr(this,8);const e=$f(this.buf,this.pos+=4),t=$f(this.buf,this.pos+=4);return new yn(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=Wx(this.buf,this.pos);return this.pos+=ht(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function p$(n){return new f$(n instanceof Uint8Array?n:n.subarray())}function ke(n,e,t){const r=p$(n);return e.decode(r,void 0,t)}const g$=new Uint8Array(0);function y$(n){const e=n.match(/../g);return e!=null?new Uint8Array(e.map(t=>parseInt(t,16))):g$}function m$(n,e){if(n===e)return!0;if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return!1;return!0}function hp(n){if(n instanceof Uint8Array&&n.constructor.name==="Uint8Array")return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(ArrayBuffer.isView(n))return new Uint8Array(n.buffer,n.byteOffset,n.byteLength);throw new Error("Unknown type, must be binary type")}function w$(n){return new TextEncoder().encode(n)}function v$(n){return new TextDecoder().decode(n)}function E$(n,e){if(n.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var i=0;i<n.length;i++){var s=n.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=n.length,l=n.charAt(0),c=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function d(y){if(y instanceof Uint8Array||(ArrayBuffer.isView(y)?y=new Uint8Array(y.buffer,y.byteOffset,y.byteLength):Array.isArray(y)&&(y=Uint8Array.from(y))),!(y instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(y.length===0)return"";for(var g=0,w=0,m=0,E=y.length;m!==E&&y[m]===0;)m++,g++;for(var v=(E-m)*u+1>>>0,b=new Uint8Array(v);m!==E;){for(var k=y[m],A=0,T=v-1;(k!==0||A<w)&&T!==-1;T--,A++)k+=256*b[T]>>>0,b[T]=k%a>>>0,k=k/a>>>0;if(k!==0)throw new Error("Non-zero carry");w=A,m++}for(var P=v-w;P!==v&&b[P]===0;)P++;for(var _=l.repeat(g);P<v;++P)_+=n.charAt(b[P]);return _}function f(y){if(typeof y!="string")throw new TypeError("Expected String");if(y.length===0)return new Uint8Array;var g=0;if(y[g]!==" "){for(var w=0,m=0;y[g]===l;)w++,g++;for(var E=(y.length-g)*c+1>>>0,v=new Uint8Array(E);y[g];){var b=t[y.charCodeAt(g)];if(b===255)return;for(var k=0,A=E-1;(b!==0||k<m)&&A!==-1;A--,k++)b+=a*v[A]>>>0,v[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");m=k,g++}if(y[g]!==" "){for(var T=E-m;T!==E&&v[T]===0;)T++;for(var P=new Uint8Array(w+(E-T)),_=w;T!==E;)P[_++]=v[T++];return P}}}function p(y){var g=f(y);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:p}}var b$=E$,_$=b$;let S$=class{constructor(e,t,r){h(this,"name");h(this,"prefix");h(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},x$=class{constructor(e,t,r){h(this,"name");h(this,"prefix");h(this,"baseDecode");h(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=r}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Jx(this,e)}},k$=class{constructor(e){h(this,"decoders");this.decoders=e}or(e){return Jx(this,e)}decode(e){const t=e[0],r=this.decoders[t];if(r!=null)return r.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function Jx(n,e){return new k$({...n.decoders??{[n.prefix]:n},...e.decoders??{[e.prefix]:e}})}let R$=class{constructor(e,t,r,i){h(this,"name");h(this,"prefix");h(this,"baseEncode");h(this,"baseDecode");h(this,"encoder");h(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=i,this.encoder=new S$(e,t,r),this.decoder=new x$(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function fp({name:n,prefix:e,encode:t,decode:r}){return new R$(n,e,t,r)}function Wh({name:n,prefix:e,alphabet:t}){const{encode:r,decode:i}=_$(t,n);return fp({prefix:e,name:n,encode:r,decode:s=>hp(i(s))})}function A$(n,e,t,r){let i=n.length;for(;n[i-1]==="=";)--i;const s=new Uint8Array(i*t/8|0);let o=0,a=0,l=0;for(let c=0;c<i;++c){const u=e[n[c]];if(u===void 0)throw new SyntaxError(`Non-${r} character`);a=a<<t|u,o+=t,o>=8&&(o-=8,s[l++]=255&a>>o)}if(o>=t||255&a<<8-o)throw new SyntaxError("Unexpected end of data");return s}function I$(n,e,t){const r=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let l=0;l<n.length;++l)for(a=a<<8|n[l],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),r)for(;s.length*t&7;)s+="=";return s}function C$(n){const e={};for(let t=0;t<n.length;++t)e[n[t]]=t;return e}function rn({name:n,prefix:e,bitsPerChar:t,alphabet:r}){const i=C$(r);return fp({prefix:e,name:n,encode(s){return I$(s,r,t)},decode(s){return A$(s,i,t,n)}})}const T$=Wh({prefix:"9",name:"base10",alphabet:"0123456789"}),N$=Object.freeze(Object.defineProperty({__proto__:null,base10:T$},Symbol.toStringTag,{value:"Module"})),D$=rn({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),P$=rn({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),O$=Object.freeze(Object.defineProperty({__proto__:null,base16:D$,base16upper:P$},Symbol.toStringTag,{value:"Module"})),L$=rn({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),B$=Object.freeze(Object.defineProperty({__proto__:null,base2:L$},Symbol.toStringTag,{value:"Module"})),Zx=Array.from(""),M$=Zx.reduce((n,e,t)=>(n[t]=e,n),[]),$$=Zx.reduce((n,e,t)=>{const r=e.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${e}`);return n[r]=t,n},[]);function U$(n){return n.reduce((e,t)=>(e+=M$[t],e),"")}function F$(n){const e=[];for(const t of n){const r=t.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${t}`);const i=$$[r];if(i==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const z$=fp({prefix:"",name:"base256emoji",encode:U$,decode:F$}),V$=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:z$},Symbol.toStringTag,{value:"Module"})),Hn=rn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),H$=rn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),K$=rn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),W$=rn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),G$=rn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),q$=rn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),j$=rn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Y$=rn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Q$=rn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),X$=Object.freeze(Object.defineProperty({__proto__:null,base32:Hn,base32hex:G$,base32hexpad:j$,base32hexpadupper:Y$,base32hexupper:q$,base32pad:K$,base32padupper:W$,base32upper:H$,base32z:Q$},Symbol.toStringTag,{value:"Module"})),_s=Wh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),J$=Wh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Z$=Object.freeze(Object.defineProperty({__proto__:null,base36:_s,base36upper:J$},Symbol.toStringTag,{value:"Module"})),mn=Wh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),eU=Wh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),tU=Object.freeze(Object.defineProperty({__proto__:null,base58btc:mn,base58flickr:eU},Symbol.toStringTag,{value:"Module"})),ar=rn({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),nU=rn({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),A6=rn({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),rU=rn({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),iU=Object.freeze(Object.defineProperty({__proto__:null,base64:ar,base64pad:nU,base64url:A6,base64urlpad:rU},Symbol.toStringTag,{value:"Module"})),sU=rn({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),oU=Object.freeze(Object.defineProperty({__proto__:null,base8:sU},Symbol.toStringTag,{value:"Module"})),aU=fp({prefix:"\0",name:"identity",encode:n=>v$(n),decode:n=>w$(n)}),lU=Object.freeze(Object.defineProperty({__proto__:null,identity:aU},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const cU=512,ek=85;var uU=tk,iw=128,dU=-128,hU=Math.pow(2,31);function tk(n,e,t){e=e||[],t=t||0;for(var r=t;n>=hU;)e[t++]=n&255|iw,n/=128;for(;n&dU;)e[t++]=n&255|iw,n>>>=7;return e[t]=n|0,tk.bytes=t-r+1,e}var fU=D4,pU=128,sw=127;function D4(n,r){var t=0,r=r||0,i=0,s=r,o,a=n.length;do{if(s>=a)throw D4.bytes=0,new RangeError("Could not decode varint");o=n[s++],t+=i<28?(o&sw)<<i:(o&sw)*Math.pow(2,i),i+=7}while(o>=pU);return D4.bytes=s-r,t}var gU=Math.pow(2,7),yU=Math.pow(2,14),mU=Math.pow(2,21),wU=Math.pow(2,28),vU=Math.pow(2,35),EU=Math.pow(2,42),bU=Math.pow(2,49),_U=Math.pow(2,56),SU=Math.pow(2,63),xU=function(n){return n<gU?1:n<yU?2:n<mU?3:n<wU?4:n<vU?5:n<EU?6:n<bU?7:n<_U?8:n<SU?9:10},kU={encode:uU,decode:fU,encodingLength:xU},T0=kU;function P4(n,e=0){return[T0.decode(n,e),T0.decode.bytes]}function N0(n,e,t=0){return T0.encode(n,e,t),e}function D0(n){return T0.encodingLength(n)}function Lc(n,e){const t=e.byteLength,r=D0(n),i=r+D0(t),s=new Uint8Array(i+t);return N0(n,s,0),N0(t,s,r),s.set(e,i),new I6(n,t,e,s)}function vu(n){const e=hp(n),[t,r]=P4(e),[i,s]=P4(e.subarray(r)),o=e.subarray(r+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new I6(t,i,o,e)}function RU(n,e){if(n===e)return!0;{const t=e;return n.code===t.code&&n.size===t.size&&t.bytes instanceof Uint8Array&&m$(n.bytes,t.bytes)}}let I6=class{constructor(e,t,r,i){h(this,"code");h(this,"size");h(this,"digest");h(this,"bytes");this.code=e,this.size=t,this.digest=r,this.bytes=i}};const nk=0,AU="identity",rk=hp;function IU(n,e){if((e==null?void 0:e.truncate)!=null&&e.truncate!==n.byteLength){if(e.truncate<0||e.truncate>n.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${n.byteLength}`);n=n.subarray(0,e.truncate)}return Lc(nk,rk(n))}const Po={code:nk,name:AU,encode:rk,digest:IU},CU=20;function C6({name:n,code:e,encode:t,minDigestLength:r,maxDigestLength:i}){return new TU(n,e,t,r,i)}let TU=class{constructor(e,t,r,i,s){h(this,"name");h(this,"code");h(this,"encode");h(this,"minDigestLength");h(this,"maxDigestLength");this.name=e,this.code=t,this.encode=r,this.minDigestLength=i??CU,this.maxDigestLength=s}digest(e,t){if((t==null?void 0:t.truncate)!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const r=this.encode(e);return r instanceof Uint8Array?ow(r,this.code,t==null?void 0:t.truncate):r.then(i=>ow(i,this.code,t==null?void 0:t.truncate))}else throw Error("Unknown type, must be binary type")}};function ow(n,e,t){if(t!=null&&t!==n.byteLength){if(t>n.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${n.byteLength}`);n=n.subarray(0,t)}return Lc(e,n)}function ik(n){return async e=>new Uint8Array(await crypto.subtle.digest(n,e))}const nn=C6({name:"sha2-256",code:18,encode:ik("SHA-256")}),NU=C6({name:"sha2-512",code:19,encode:ik("SHA-512")});function aw(n,e){const{bytes:t,version:r}=n;switch(r){case 0:return PU(t,O4(n),e??mn.encoder);default:return OU(t,O4(n),e??Hn.encoder)}}const lw=new WeakMap;function O4(n){const e=lw.get(n);if(e==null){const t=new Map;return lw.set(n,t),t}return e}var lE;let nt=class cn{constructor(e,t,r,i){h(this,"code");h(this,"version");h(this,"multihash");h(this,"bytes");h(this,"/");h(this,lE,"CID");this.code=t,this.version=e,this.multihash=r,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ju)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==LU)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return cn.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,r=Lc(e,t);return cn.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return cn.equals(this,e)}static equals(e,t){const r=t;return r!=null&&e.code===r.code&&e.version===r.version&&RU(e.multihash,r.multihash)}toString(e){return aw(this,e)}toJSON(){return{"/":aw(this)}}link(){return this}[(lE=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof cn)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:r,code:i,multihash:s,bytes:o}=t;return new cn(r,i,s,o??cw(r,i,s.bytes))}else if(t[BU]===!0){const{version:r,multihash:i,code:s}=t,o=vu(i);return cn.create(r,s,o)}else return null}static create(e,t,r){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(r.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ju)throw new Error(`Version 0 CID must use dag-pb (code: ${ju}) block encoding`);return new cn(e,t,r,r.bytes)}case 1:{const i=cw(e,t,r.bytes);return new cn(e,t,r,i)}default:throw new Error("Invalid version")}}static createV0(e){return cn.create(0,ju,e)}static createV1(e,t){return cn.create(1,e,t)}static decode(e){const[t,r]=cn.decodeFirst(e);if(r.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=cn.inspectBytes(e),r=t.size-t.multihashSize,i=hp(e.subarray(r,r+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new I6(t.multihashCode,t.digestSize,s,i);return[t.version===0?cn.createV0(o):cn.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const r=()=>{const[d,f]=P4(e.subarray(t));return t+=f,d};let i=r(),s=ju;if(i===18?(i=0,t=0):s=r(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=r(),l=r(),c=t+l,u=c-o;return{version:i,codec:s,multihashCode:a,digestSize:l,multihashSize:u,size:c}}static parse(e,t){const[r,i]=DU(e,t),s=cn.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return O4(s).set(r,e),s}};function DU(n,e){switch(n[0]){case"Q":{const t=e??mn;return[mn.prefix,t.decode(`${mn.prefix}${n}`)]}case mn.prefix:{const t=e??mn;return[mn.prefix,t.decode(n)]}case Hn.prefix:{const t=e??Hn;return[Hn.prefix,t.decode(n)]}case _s.prefix:{const t=e??_s;return[_s.prefix,t.decode(n)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[n[0],e.decode(n)]}}}function PU(n,e,t){const{prefix:r}=t;if(r!==mn.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(r);if(i==null){const s=t.encode(n).slice(1);return e.set(r,s),s}else return i}function OU(n,e,t){const{prefix:r}=t,i=e.get(r);if(i==null){const s=t.encode(n);return e.set(r,s),s}else return i}const ju=112,LU=18;function cw(n,e,t){const r=D0(n),i=r+D0(e),s=new Uint8Array(i+t.byteLength);return N0(n,s,0),N0(e,s,r),s.set(t,i),s}const BU=Symbol.for("@ipld/js-cid/CID"),za={...lU,...B$,...oU,...N$,...O$,...X$,...Z$,...tU,...iU,...V$};function sk(n,e,t,r){return{name:n,prefix:e,encoder:{name:n,prefix:e,encode:t},decoder:{decode:r}}}const uw=sk("utf8","u",n=>"u"+new TextDecoder("utf8").decode(n),n=>new TextEncoder().encode(n.substring(1))),Fg=sk("ascii","a",n=>{let e="a";for(let t=0;t<n.length;t++)e+=String.fromCharCode(n[t]);return e},n=>{n=n.substring(1);const e=dr(n.length);for(let t=0;t<n.length;t++)e[t]=n.charCodeAt(t);return e}),ok={utf8:uw,"utf-8":uw,hex:za.base16,latin1:Fg,ascii:Fg,binary:Fg,...za};function Y(n,e="utf8"){const t=ok[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${n}`)}function MU(n){let r,i=8192;return function(o){if(o<1||o>4096)return dr(o);i+o>8192&&(r=dr(8192),i=0);const a=r.subarray(i,i+=o);return i&7&&(i=(i|7)+1),a}}class dd{constructor(e,t,r){h(this,"fn");h(this,"len");h(this,"next");h(this,"val");this.fn=e,this.len=t,this.next=void 0,this.val=r}}function zg(){}class $U{constructor(e){h(this,"head");h(this,"tail");h(this,"len");h(this,"next");this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const UU=MU();function FU(n){return globalThis.Buffer!=null?dr(n):UU(n)}class L4{constructor(){h(this,"len");h(this,"head");h(this,"tail");h(this,"states");this.len=0,this.head=new dd(zg,0,0),this.tail=this.head,this.states=null}_push(e,t,r){return this.tail=this.tail.next=new dd(e,t,r),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new VU((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(Uf,10,yn.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=yn.fromBigInt(e);return this._push(Uf,t.length(),t)}uint64Number(e){return this._push(I0,ht(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=yn.fromBigInt(e).zzEncode();return this._push(Uf,t.length(),t)}sint64Number(e){const t=yn.fromNumber(e).zzEncode();return this._push(Uf,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(Vg,1,e?1:0)}fixed32(e){return this._push(Yu,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=yn.fromBigInt(e);return this._push(Yu,4,t.lo)._push(Yu,4,t.hi)}fixed64Number(e){const t=yn.fromNumber(e);return this._push(Yu,4,t.lo)._push(Yu,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(s$,4,e)}double(e){return this._push(a$,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(Vg,1,0):this.uint32(t)._push(HU,t,e)}string(e){const t=d$(e);return t!==0?this.uint32(t)._push(Xx,t,e):this._push(Vg,1,0)}fork(){return this.states=new $U(this),this.head=this.tail=new dd(zg,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new dd(zg,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,r=this.len;return this.reset().uint32(r),r!==0&&(this.tail.next=e.next,this.tail=t,this.len+=r),this}finish(){let e=this.head.next;const t=FU(this.len);let r=0;for(;e!=null;)e.fn(e.val,t,r),r+=e.len,e=e.next;return t}}function Vg(n,e,t){e[t]=n&255}function zU(n,e,t){for(;n>127;)e[t++]=n&127|128,n>>>=7;e[t]=n}class VU extends dd{constructor(t,r){super(zU,t,r);h(this,"next");this.next=void 0}}function Uf(n,e,t){for(;n.hi!==0;)e[t++]=n.lo&127|128,n.lo=(n.lo>>>7|n.hi<<25)>>>0,n.hi>>>=7;for(;n.lo>127;)e[t++]=n.lo&127|128,n.lo=n.lo>>>7;e[t++]=n.lo}function Yu(n,e,t){e[t]=n&255,e[t+1]=n>>>8&255,e[t+2]=n>>>16&255,e[t+3]=n>>>24}function HU(n,e,t){e.set(n,t)}globalThis.Buffer!=null&&(L4.prototype.bytes=function(n){const e=n.length>>>0;return this.uint32(e),e>0&&this._push(KU,e,n),this},L4.prototype.string=function(n){const e=globalThis.Buffer.byteLength(n);return this.uint32(e),e>0&&this._push(WU,e,n),this});function KU(n,e,t){e.set(n,t)}function WU(n,e,t){n.length<40?Xx(n,e,t):e.utf8Write!=null?e.utf8Write(n,t):e.set(Y(n),t)}function GU(){return new L4}function Re(n,e){const t=GU();return e.encode(n,t,{lengthDelimited:!1}),t.finish()}var P0;(function(n){n[n.VARINT=0]="VARINT",n[n.BIT64=1]="BIT64",n[n.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",n[n.START_GROUP=3]="START_GROUP",n[n.END_GROUP=4]="END_GROUP",n[n.BIT32=5]="BIT32"})(P0||(P0={}));function ak(n,e,t,r){return{name:n,type:e,encode:t,decode:r}}function Pn(n){function e(i){if(n[i.toString()]==null)throw new Error("Invalid enum value");return n[i]}const t=function(s,o){const a=e(s);o.int32(a)},r=function(s){const o=s.int32();return e(o)};return ak("enum",P0.VARINT,t,r)}function Ae(n,e){return ak("message",P0.LENGTH_DELIMITED,n,e)}let Va=class extends Error{constructor(t,r){super(t);h(this,"code");this.code=r}};var zt;(function(n){n.WantBlock="WantBlock",n.WantHave="WantHave"})(zt||(zt={}));var B4;(function(n){n[n.WantBlock=0]="WantBlock",n[n.WantHave=1]="WantHave"})(B4||(B4={}));(function(n){n.codec=()=>Pn(B4)})(zt||(zt={}));var oh;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.cid!=null&&t.cid.byteLength>0&&(r.uint32(10),r.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(r.uint32(16),r.int32(t.priority)),t.cancel!=null&&(r.uint32(24),r.bool(t.cancel)),t.wantType!=null&&(r.uint32(32),zt.codec().encode(t.wantType,r)),t.sendDontHave!=null&&(r.uint32(40),r.bool(t.sendDontHave)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={cid:Xe(0),priority:0},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.priority=t.int32();break}case 3:{s.cancel=t.bool();break}case 4:{s.wantType=zt.codec().decode(t);break}case 5:{s.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>Re(t,n.codec()),n.decode=(t,r)=>ke(t,n.codec(),r)})(oh||(oh={}));var O0;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.entries!=null)for(const s of t.entries)r.uint32(10),oh.codec().encode(s,r);t.full!=null&&(r.uint32(16),r.bool(t.full)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a,l;const s={entries:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{if(((a=i.limits)==null?void 0:a.entries)!=null&&s.entries.length===i.limits.entries)throw new Va('decode error - map field "entries" had too many elements',"ERR_MAX_LENGTH");s.entries.push(oh.codec().decode(t,t.uint32(),{limits:(l=i.limits)==null?void 0:l.entries$}));break}case 2:{s.full=t.bool();break}default:{t.skipType(c&7);break}}}return s})),e),n.encode=t=>Re(t,n.codec()),n.decode=(t,r)=>ke(t,n.codec(),r)})(O0||(O0={}));var ah;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(r.uint32(10),r.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(r.uint32(18),r.bytes(t.data)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={prefix:Xe(0),data:Xe(0)},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.prefix=t.bytes();break}case 2:{s.data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>Re(t,n.codec()),n.decode=(t,r)=>ke(t,n.codec(),r)})(ah||(ah={}));var Vi;(function(n){n.HaveBlock="HaveBlock",n.DontHaveBlock="DontHaveBlock"})(Vi||(Vi={}));var L0;(function(n){n[n.HaveBlock=0]="HaveBlock",n[n.DontHaveBlock=1]="DontHaveBlock"})(L0||(L0={}));(function(n){n.codec=()=>Pn(L0)})(Vi||(Vi={}));var lh;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.cid!=null&&t.cid.byteLength>0&&(r.uint32(10),r.bytes(t.cid)),t.type!=null&&L0[t.type]!==0&&(r.uint32(16),Vi.codec().encode(t.type,r)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={cid:Xe(0),type:Vi.HaveBlock},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.type=Vi.codec().decode(t);break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>Re(t,n.codec()),n.decode=(t,r)=>ke(t,n.codec(),r)})(lh||(lh={}));var ch;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.wantlist!=null&&(r.uint32(10),O0.codec().encode(t.wantlist,r)),t.blocks!=null)for(const s of t.blocks)r.uint32(26),ah.codec().encode(s,r);if(t.blockPresences!=null)for(const s of t.blockPresences)r.uint32(34),lh.codec().encode(s,r);t.pendingBytes!=null&&t.pendingBytes!==0&&(r.uint32(40),r.int32(t.pendingBytes)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a,l,c,u,d;const s={blocks:[],blockPresences:[],pendingBytes:0},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const f=t.uint32();switch(f>>>3){case 1:{s.wantlist=O0.codec().decode(t,t.uint32(),{limits:(a=i.limits)==null?void 0:a.wantlist});break}case 3:{if(((l=i.limits)==null?void 0:l.blocks)!=null&&s.blocks.length===i.limits.blocks)throw new Va('decode error - map field "blocks" had too many elements',"ERR_MAX_LENGTH");s.blocks.push(ah.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.blocks$}));break}case 4:{if(((u=i.limits)==null?void 0:u.blockPresences)!=null&&s.blockPresences.length===i.limits.blockPresences)throw new Va('decode error - map field "blockPresences" had too many elements',"ERR_MAX_LENGTH");s.blockPresences.push(lh.codec().decode(t,t.uint32(),{limits:(d=i.limits)==null?void 0:d.blockPresences$}));break}case 5:{s.pendingBytes=t.int32();break}default:{t.skipType(f&7);break}}}return s})),e),n.encode=t=>Re(t,n.codec()),n.decode=(t,r)=>ke(t,n.codec(),r)})(ch||(ch={}));function qU(n,e){for(const[t,r]of e.wantlist.entries()){const i=n.wantlist.get(t);i!=null&&(i.priority>r.priority&&(r.priority=i.priority),r.cancel=r.cancel??i.cancel,r.wantType=r.wantType??i.wantType,r.sendDontHave=r.sendDontHave??i.sendDontHave),n.wantlist.set(t,r)}for(const[t,r]of e.blockPresences.entries())n.blockPresences.set(t,r);for(const[t,r]of e.blocks.entries())n.blocks.set(t,r);return e.full&&!n.full&&(n.full=!0),n}const jU=4193648,YU=jU+16;function*QU(n,e){const t=[...n.wantlist.values()],r=[...n.blockPresences.values()],i=[...n.blocks.values()];let s=0,o=0,a=0,l=!1;for(;;){const c={wantlist:{full:n.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0};let u=ch.encode(c).byteLength,{added:d,hasMore:f,newSize:p}=Hg(i,c.blocks,a,e,u,XU);a+=d,u=p;const y=f;({added:d,hasMore:f,newSize:p}=Hg(r,c.blockPresences,o,e,u,JU)),o+=d,u=p;const g=f;if({added:d,hasMore:f,newSize:p}=Hg(t,c.wantlist.entries,s,e,u,ZU),s+=d,u=p,l=!y&&!g&&!f,l||(c.wantlist.full=!1),yield ch.encode(c),l)break}}function Hg(n,e,t,r,i,s){let o=0,a=!1;for(let l=t;l<n.length;l++){const c=n[l],u=s(c);if(u>YU)throw new S("Cannot send block as after encoding it is over the max message size","ERR_BLOCK_TOO_LARGE");const d=i+u;if(d>r){a=!0;break}e.push(c),o++,i=d}return{hasMore:a,added:o,newSize:i}}function XU(n){return T6(3,ah.encode(n))}function JU(n){return T6(4,lh.encode(n))}function ZU(n){return T6(1,oh.encode(n))}function T6(n,e){const t=ht(n),r=ht(e.byteLength);return t+r+e.byteLength}let eF=class extends tn{constructor(t,r={}){var i,s;super();h(this,"log");h(this,"libp2p");h(this,"routing");h(this,"protocols");h(this,"running");h(this,"maxInboundStreams");h(this,"maxOutboundStreams");h(this,"messageReceiveTimeout");h(this,"registrarIds");h(this,"metrics");h(this,"sendQueue");h(this,"runOnTransientConnections");h(this,"maxOutgoingMessageSize");h(this,"maxIncomingMessageSize");this.log=t.logger.forComponent("helia:bitswap:network"),this.libp2p=t.libp2p,this.routing=t.routing,this.protocols=r.protocols??[Mf],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=r.maxInboundStreams??XM,this.maxOutboundStreams=r.maxOutboundStreams??JM,this.messageReceiveTimeout=r.messageReceiveTimeout??ZM,this.runOnTransientConnections=r.runOnTransientConnections??n$,this.maxIncomingMessageSize=r.maxIncomingMessageSize??Qx,this.maxOutgoingMessageSize=r.maxOutgoingMessageSize??r.maxIncomingMessageSize??i$,this.metrics={blocksSent:(i=t.metrics)==null?void 0:i.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:(s=t.metrics)==null?void 0:s.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new mu({concurrency:r.messageSendConcurrency??t$,metrics:t.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",o=>{this.log.error("error sending wantlist to peer",o.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnections});const t={onConnect:r=>{this.safeDispatchEvent("peer:connected",{detail:r})},onDisconnect:r=>{this.safeDispatchEvent("peer:disconnected",{detail:r})}};this.registrarIds=[];for(const r of this.protocols)this.registrarIds.push(await this.libp2p.register(r,t));this.libp2p.getConnections().forEach(r=>{this.safeDispatchEvent("peer:connected",{detail:r.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(const t of this.registrarIds)this.libp2p.unregister(t);this.registrarIds=[]}}_onStream(t){if(!this.running)return;const{stream:r,connection:i}=t;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",r.protocol,i.remotePeer);const s=()=>{r.status==="open"?r.abort(new S(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`,"ERR_TIMEOUT")):this.log("stream aborted with status %s",r.status)};let o=AbortSignal.timeout(this.messageReceiveTimeout);ue(1/0,o),o.addEventListener("abort",s),await r.closeWrite(),await En(r,a=>Do(a,{maxDataLength:this.maxIncomingMessageSize}),async a=>{for await(const l of a)try{const c=ch.decode(l);this.log("incoming new bitswap %s message from %p on stream",r.protocol,i.remotePeer,r.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:i.remotePeer,message:c}}),o.removeEventListener("abort",s),o=AbortSignal.timeout(this.messageReceiveTimeout),ue(1/0,o),o.addEventListener("abort",s)}catch(c){this.log.error("error reading incoming bitswap message from %p on stream",i.remotePeer,r.id,c),r.abort(c);break}})}).catch(s=>{this.log.error("error handling incoming stream from %p",i.remotePeer,s),r.abort(s)})}async*findProviders(t,r){var i;(i=r==null?void 0:r.onProgress)==null||i.call(r,new se("bitswap:network:find-providers",t));for await(const s of this.routing.findProviders(t,r))await this.libp2p.isDialable(s.multiaddrs,{runOnTransientConnection:this.runOnTransientConnections})&&(yield s)}async findAndConnect(t,r){await Fa(Wo(C0(this.findProviders(t,r),(r==null?void 0:r.maxProviders)??r$),async i=>this.connectTo(i.id,r))).catch(i=>{this.log.error(i)})}async sendMessage(t,r,i){if(!this.running)throw new Error("network isn't running");const s=this.sendQueue.queue.find(o=>t.equals(o.options.peerId)&&o.status==="queued");if(s!=null){s.options.message=qU(s.options.message,r),await s.join({signal:i==null?void 0:i.signal});return}await this.sendQueue.add(async o=>{var c,u;const a=o==null?void 0:o.message;if(a==null)throw new S("No message to send","ERR_NO_MESSAGE");this.log("sendMessage to %p",t),(c=o==null?void 0:o.onProgress)==null||c.call(o,new se("bitswap:network:send-wantlist",t));const l=await this.libp2p.dialProtocol(t,Mf,o);await l.closeRead();try{await En(QU(a,this.maxOutgoingMessageSize),d=>No(d),l),await l.close(o)}catch(d){(u=o==null?void 0:o.onProgress)==null||u.call(o,new se("bitswap:network:send-wantlist:error",{peer:t,error:d})),this.log.error("error sending message to %p",t,d),l.abort(d)}this._updateSentStats(a.blocks)},{peerId:t,signal:i==null?void 0:i.signal,message:r})}async connectTo(t,r){var s;if(!this.running)throw new S("Network isn't running","ERR_NOT_STARTED");(s=r==null?void 0:r.onProgress)==null||s.call(r,new se("bitswap:network:dial",t));const[i]=await Promise.all([this.libp2p.dial(t,r),Nr(this.libp2p,"peer:identify",r==null?void 0:r.signal,{filter:o=>{if(!o.detail.peerId.equals(t))return!1;if(o.detail.protocols.includes(Mf))return!0;throw new S(`${t} did not support ${Mf}`,"ERR_BITSWAP_UNSUPPORTED_BY_PEER")}})]);return i}_updateSentStats(t){var i,s;let r=0;for(const o of t.values())r+=o.data.byteLength;(i=this.metrics.dataSent)==null||i.increment(r),(s=this.metrics.blocksSent)==null||s.increment(t.size)}};function ne(n,e="utf8"){const t=ok[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(n).substring(1)}const lk=Symbol.for("nodejs.util.inspect.custom"),tF=Object.values(za).map(n=>n.decoder).reduce((n,e)=>n.or(e),za.identity.decoder),ck=114,N6=36,D6=37;var cE;class P6{constructor(e){h(this,"type");h(this,"multihash");h(this,"privateKey");h(this,"publicKey");h(this,"string");h(this,cE,!0);this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=mn.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return nt.createV1(ck,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e==null)return!1;if(e instanceof Uint8Array)return Pe(this.multihash.bytes,e);if(typeof e=="string")return xt(e).equals(this);if(((t=e==null?void 0:e.multihash)==null?void 0:t.bytes)!=null)return Pe(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[(cE=lp,lk)](){return`PeerId(${this.toString()})`}}class Gh extends P6{constructor(t){super({...t,type:"RSA"});h(this,"type","RSA");h(this,"publicKey");this.publicKey=t.publicKey}}class qh extends P6{constructor(t){super({...t,type:"Ed25519"});h(this,"type","Ed25519");h(this,"publicKey");this.publicKey=t.multihash.digest}}class jh extends P6{constructor(t){super({...t,type:"secp256k1"});h(this,"type","secp256k1");h(this,"publicKey");this.publicKey=t.multihash.digest}}const M4=2336;var uE,dE;class nF{constructor(e){h(this,"type","url");h(this,"multihash");h(this,"privateKey");h(this,"publicKey");h(this,"url");h(this,uE,!0);this.url=e.toString(),this.multihash=Po.digest(Y(this.url))}[(dE=lk,uE=lp,dE)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toCID(){return nt.createV1(M4,this.multihash)}toBytes(){return this.toCID().bytes}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=ne(e)),e.toString()===this.toString())}}function rF(n){if(n.type==="RSA")return new Gh(n);if(n.type==="Ed25519")return new qh(n);if(n.type==="secp256k1")return new jh(n);throw new S("Not a PeerId","ERR_INVALID_PARAMETERS")}function xt(n,e){if(n.charAt(0)==="1"||n.charAt(0)==="Q"){const t=vu(mn.decode(`z${n}`));return n.startsWith("12D")?new qh({multihash:t}):n.startsWith("16U")?new jh({multihash:t}):new Gh({multihash:t})}return di(tF.decode(n))}function di(n){try{const e=vu(n);if(e.code===Po.code){if(e.digest.length===N6)return new qh({multihash:e});if(e.digest.length===D6)return new jh({multihash:e})}if(e.code===nn.code)return new Gh({multihash:e})}catch{return iF(nt.decode(n))}throw new Error("Supplied PeerID CID is invalid")}function iF(n){if((n==null?void 0:n.multihash)==null||n.version==null||n.version===1&&n.code!==ck&&n.code!==M4)throw new Error("Supplied PeerID CID is invalid");if(n.code===M4){const t=ne(n.multihash.digest);return new nF(new URL(t))}const e=n.multihash;if(e.code===nn.code)return new Gh({multihash:n.multihash});if(e.code===Po.code){if(e.digest.length===N6)return new qh({multihash:n.multihash});if(e.digest.length===D6)return new jh({multihash:n.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function qi(n,e){return n.length===N6?new qh({multihash:Lc(Po.code,n),privateKey:e}):n.length===D6?new jh({multihash:Lc(Po.code,n),privateKey:e}):new Gh({multihash:await nn.digest(n),publicKey:n,privateKey:e})}function B0(n,e){const t={[Symbol.iterator]:()=>t,next:()=>{const r=n.next(),i=r.value;return r.done===!0||i==null?{done:!0,value:void 0}:{done:!1,value:e(i)}}};return t}class Ls{constructor(e){h(this,"map");if(this.map=new Map,e!=null)for(const[t,r]of e.entries())this.map.set(t.toString(),r)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return B0(this.map.entries(),e=>[xt(e[0]),e[1]])}forEach(e){this.map.forEach((t,r)=>{e(t,xt(r),this)})}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return B0(this.map.keys(),e=>xt(e))}values(){return this.map.values()}get size(){return this.map.size}}class si{constructor(e){h(this,"set");if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return B0(this.set.entries(),e=>{const t=xt(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const r=xt(t);e(r,r,this)})}has(e){return this.set.has(e.toString())}values(){return B0(this.set.values(),e=>xt(e))}intersection(e){const t=new si;for(const r of e)this.has(r)&&t.add(r);return t}difference(e){const t=new si;for(const r of this)e.has(r)||t.add(r);return t}union(e){const t=new si;for(const r of e)t.add(r);for(const r of this)t.add(r);return t}}const Mr={get(n=globalThis){const e=n.crypto;if((e==null?void 0:e.subtle)==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};function Go(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}const gl=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Yh(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function Na(n){if(!Number.isSafeInteger(n)||n<0)throw new Error("positive integer expected, got "+n)}function Bs(n,...e){if(!Yh(n))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(n.length))throw new Error("Uint8Array expected of length "+e+", got length="+n.length)}function Qh(n){if(typeof n!="function"||typeof n.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Na(n.outputLen),Na(n.blockLen)}function M0(n,e=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(e&&n.finished)throw new Error("Hash#digest() has already been called")}function sF(n,e){Bs(n);const t=e.outputLen;if(n.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function ji(...n){for(let e=0;e<n.length;e++)n[e].fill(0)}function Id(n){return new DataView(n.buffer,n.byteOffset,n.byteLength)}function mi(n,e){return n<<32-e|n>>>e}function Kg(n,e){return n<<e|n>>>32-e>>>0}const uk=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",oF=Array.from({length:256},(n,e)=>e.toString(16).padStart(2,"0"));function Da(n){if(Bs(n),uk)return n.toHex();let e="";for(let t=0;t<n.length;t++)e+=oF[n[t]];return e}const Ji={_0:48,_9:57,A:65,F:70,a:97,f:102};function dw(n){if(n>=Ji._0&&n<=Ji._9)return n-Ji._0;if(n>=Ji.A&&n<=Ji.F)return n-(Ji.A-10);if(n>=Ji.a&&n<=Ji.f)return n-(Ji.a-10)}function $0(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);if(uk)return Uint8Array.fromHex(n);const e=n.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(t);for(let i=0,s=0;i<t;i++,s+=2){const o=dw(n.charCodeAt(s)),a=dw(n.charCodeAt(s+1));if(o===void 0||a===void 0){const l=n[s]+n[s+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+s)}r[i]=o*16+a}return r}const aF=async()=>{};async function lF(n,e,t){let r=Date.now();for(let i=0;i<n;i++){t(i);const s=Date.now()-r;s>=0&&s<e||(await aF(),r+=s)}}function dk(n){if(typeof n!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(n))}function uh(n){return typeof n=="string"&&(n=dk(n)),Bs(n),n}function hw(n){return typeof n=="string"&&(n=dk(n)),Bs(n),n}function Li(...n){let e=0;for(let r=0;r<n.length;r++){const i=n[r];Bs(i),e+=i.length}const t=new Uint8Array(e);for(let r=0,i=0;r<n.length;r++){const s=n[r];t.set(s,i),i+=s.length}return t}function cF(n,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(n,e)}class hk{}function O6(n){const e=r=>n().update(uh(r)).digest(),t=n();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>n(),e}function Xh(n=32){if(gl&&typeof gl.getRandomValues=="function")return gl.getRandomValues(new Uint8Array(n));if(gl&&typeof gl.randomBytes=="function")return Uint8Array.from(gl.randomBytes(n));throw new Error("crypto.getRandomValues must be defined")}function uF(n,e,t,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(e,t,r);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),l=r?4:0,c=r?0:4;n.setUint32(e+l,o,r),n.setUint32(e+c,a,r)}function fk(n,e,t){return n&e^~n&t}function pk(n,e,t){return n&e^n&t^e&t}class L6 extends hk{constructor(e,t,r,i){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=r,this.isLE=i,this.buffer=new Uint8Array(e),this.view=Id(this.buffer)}update(e){M0(this),e=uh(e),Bs(e);const{view:t,buffer:r,blockLen:i}=this,s=e.length;for(let o=0;o<s;){const a=Math.min(i-this.pos,s-o);if(a===i){const l=Id(e);for(;i<=s-o;o+=i)this.process(l,o);continue}r.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){M0(this),sF(e,this),this.finished=!0;const{buffer:t,view:r,blockLen:i,isLE:s}=this;let{pos:o}=this;t[o++]=128,ji(this.buffer.subarray(o)),this.padOffset>i-o&&(this.process(r,0),o=0);for(let d=o;d<i;d++)t[d]=0;uF(r,i-8,BigInt(this.length*8),s),this.process(r,0);const a=Id(e),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const c=l/4,u=this.get();if(c>u.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<c;d++)a.setUint32(4*d,u[d],s)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:r,length:i,finished:s,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=s,e.length=i,e.pos=a,i%t&&e.buffer.set(r),e}clone(){return this._cloneInto()}}const Hs=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ln=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),Ff=BigInt(2**32-1),fw=BigInt(32);function dF(n,e=!1){return e?{h:Number(n&Ff),l:Number(n>>fw&Ff)}:{h:Number(n>>fw&Ff)|0,l:Number(n&Ff)|0}}function hF(n,e=!1){const t=n.length;let r=new Uint32Array(t),i=new Uint32Array(t);for(let s=0;s<t;s++){const{h:o,l:a}=dF(n[s],e);[r[s],i[s]]=[o,a]}return[r,i]}const pw=(n,e,t)=>n>>>t,gw=(n,e,t)=>n<<32-t|e>>>t,yl=(n,e,t)=>n>>>t|e<<32-t,ml=(n,e,t)=>n<<32-t|e>>>t,zf=(n,e,t)=>n<<64-t|e>>>t-32,Vf=(n,e,t)=>n>>>t-32|e<<64-t;function Zi(n,e,t,r){const i=(e>>>0)+(r>>>0);return{h:n+t+(i/2**32|0)|0,l:i|0}}const fF=(n,e,t)=>(n>>>0)+(e>>>0)+(t>>>0),pF=(n,e,t,r)=>e+t+r+(n/2**32|0)|0,gF=(n,e,t,r)=>(n>>>0)+(e>>>0)+(t>>>0)+(r>>>0),yF=(n,e,t,r,i)=>e+t+r+i+(n/2**32|0)|0,mF=(n,e,t,r,i)=>(n>>>0)+(e>>>0)+(t>>>0)+(r>>>0)+(i>>>0),wF=(n,e,t,r,i,s)=>e+t+r+i+s+(n/2**32|0)|0,vF=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ks=new Uint32Array(64);class EF extends L6{constructor(e=32){super(64,e,8,!1),this.A=Hs[0]|0,this.B=Hs[1]|0,this.C=Hs[2]|0,this.D=Hs[3]|0,this.E=Hs[4]|0,this.F=Hs[5]|0,this.G=Hs[6]|0,this.H=Hs[7]|0}get(){const{A:e,B:t,C:r,D:i,E:s,F:o,G:a,H:l}=this;return[e,t,r,i,s,o,a,l]}set(e,t,r,i,s,o,a,l){this.A=e|0,this.B=t|0,this.C=r|0,this.D=i|0,this.E=s|0,this.F=o|0,this.G=a|0,this.H=l|0}process(e,t){for(let d=0;d<16;d++,t+=4)Ks[d]=e.getUint32(t,!1);for(let d=16;d<64;d++){const f=Ks[d-15],p=Ks[d-2],y=mi(f,7)^mi(f,18)^f>>>3,g=mi(p,17)^mi(p,19)^p>>>10;Ks[d]=g+Ks[d-7]+y+Ks[d-16]|0}let{A:r,B:i,C:s,D:o,E:a,F:l,G:c,H:u}=this;for(let d=0;d<64;d++){const f=mi(a,6)^mi(a,11)^mi(a,25),p=u+f+fk(a,l,c)+vF[d]+Ks[d]|0,g=(mi(r,2)^mi(r,13)^mi(r,22))+pk(r,i,s)|0;u=c,c=l,l=a,a=o+p|0,o=s,s=i,i=r,r=p+g|0}r=r+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,l=l+this.F|0,c=c+this.G|0,u=u+this.H|0,this.set(r,i,s,o,a,l,c,u)}roundClean(){ji(Ks)}destroy(){this.set(0,0,0,0,0,0,0,0),ji(this.buffer)}}const gk=hF(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(n=>BigInt(n))),bF=gk[0],_F=gk[1],Ws=new Uint32Array(80),Gs=new Uint32Array(80);class SF extends L6{constructor(e=64){super(128,e,16,!1),this.Ah=ln[0]|0,this.Al=ln[1]|0,this.Bh=ln[2]|0,this.Bl=ln[3]|0,this.Ch=ln[4]|0,this.Cl=ln[5]|0,this.Dh=ln[6]|0,this.Dl=ln[7]|0,this.Eh=ln[8]|0,this.El=ln[9]|0,this.Fh=ln[10]|0,this.Fl=ln[11]|0,this.Gh=ln[12]|0,this.Gl=ln[13]|0,this.Hh=ln[14]|0,this.Hl=ln[15]|0}get(){const{Ah:e,Al:t,Bh:r,Bl:i,Ch:s,Cl:o,Dh:a,Dl:l,Eh:c,El:u,Fh:d,Fl:f,Gh:p,Gl:y,Hh:g,Hl:w}=this;return[e,t,r,i,s,o,a,l,c,u,d,f,p,y,g,w]}set(e,t,r,i,s,o,a,l,c,u,d,f,p,y,g,w){this.Ah=e|0,this.Al=t|0,this.Bh=r|0,this.Bl=i|0,this.Ch=s|0,this.Cl=o|0,this.Dh=a|0,this.Dl=l|0,this.Eh=c|0,this.El=u|0,this.Fh=d|0,this.Fl=f|0,this.Gh=p|0,this.Gl=y|0,this.Hh=g|0,this.Hl=w|0}process(e,t){for(let v=0;v<16;v++,t+=4)Ws[v]=e.getUint32(t),Gs[v]=e.getUint32(t+=4);for(let v=16;v<80;v++){const b=Ws[v-15]|0,k=Gs[v-15]|0,A=yl(b,k,1)^yl(b,k,8)^pw(b,k,7),T=ml(b,k,1)^ml(b,k,8)^gw(b,k,7),P=Ws[v-2]|0,_=Gs[v-2]|0,N=yl(P,_,19)^zf(P,_,61)^pw(P,_,6),V=ml(P,_,19)^Vf(P,_,61)^gw(P,_,6),z=gF(T,V,Gs[v-7],Gs[v-16]),R=yF(z,A,N,Ws[v-7],Ws[v-16]);Ws[v]=R|0,Gs[v]=z|0}let{Ah:r,Al:i,Bh:s,Bl:o,Ch:a,Cl:l,Dh:c,Dl:u,Eh:d,El:f,Fh:p,Fl:y,Gh:g,Gl:w,Hh:m,Hl:E}=this;for(let v=0;v<80;v++){const b=yl(d,f,14)^yl(d,f,18)^zf(d,f,41),k=ml(d,f,14)^ml(d,f,18)^Vf(d,f,41),A=d&p^~d&g,T=f&y^~f&w,P=mF(E,k,T,_F[v],Gs[v]),_=wF(P,m,b,A,bF[v],Ws[v]),N=P|0,V=yl(r,i,28)^zf(r,i,34)^zf(r,i,39),z=ml(r,i,28)^Vf(r,i,34)^Vf(r,i,39),R=r&s^r&a^s&a,C=i&o^i&l^o&l;m=g|0,E=w|0,g=p|0,w=y|0,p=d|0,y=f|0,{h:d,l:f}=Zi(c|0,u|0,_|0,N|0),c=a|0,u=l|0,a=s|0,l=o|0,s=r|0,o=i|0;const x=fF(N,z,C);r=pF(x,_,V,R),i=x|0}({h:r,l:i}=Zi(this.Ah|0,this.Al|0,r|0,i|0)),{h:s,l:o}=Zi(this.Bh|0,this.Bl|0,s|0,o|0),{h:a,l}=Zi(this.Ch|0,this.Cl|0,a|0,l|0),{h:c,l:u}=Zi(this.Dh|0,this.Dl|0,c|0,u|0),{h:d,l:f}=Zi(this.Eh|0,this.El|0,d|0,f|0),{h:p,l:y}=Zi(this.Fh|0,this.Fl|0,p|0,y|0),{h:g,l:w}=Zi(this.Gh|0,this.Gl|0,g|0,w|0),{h:m,l:E}=Zi(this.Hh|0,this.Hl|0,m|0,E|0),this.set(r,i,s,o,a,l,c,u,d,f,p,y,g,w,m,E)}roundClean(){ji(Ws,Gs)}destroy(){ji(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const yk=O6(()=>new EF),mk=O6(()=>new SF);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const B6=BigInt(0),$4=BigInt(1);function Ha(n,e=""){if(typeof n!="boolean"){const t=e&&`"${e}"`;throw new Error(t+"expected boolean, got type="+typeof n)}return n}function ei(n,e,t=""){const r=Yh(n),i=n==null?void 0:n.length,s=e!==void 0;if(!r||s&&i!==e){const o=t&&`"${t}" `,a=s?` of length ${e}`:"",l=r?`length=${i}`:`type=${typeof n}`;throw new Error(o+"expected Uint8Array"+a+", got "+l)}return n}function Hf(n){const e=n.toString(16);return e.length&1?"0"+e:e}function wk(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);return n===""?B6:BigInt("0x"+n)}function pp(n){return wk(Da(n))}function Ka(n){return Bs(n),wk(Da(Uint8Array.from(n).reverse()))}function M6(n,e){return $0(n.toString(16).padStart(e*2,"0"))}function $6(n,e){return M6(n,e).reverse()}function ut(n,e,t){let r;if(typeof e=="string")try{r=$0(e)}catch(s){throw new Error(n+" must be hex string or Uint8Array, cause: "+s)}else if(Yh(e))r=Uint8Array.from(e);else throw new Error(n+" must be hex string or Uint8Array");const i=r.length;if(typeof t=="number"&&i!==t)throw new Error(n+" of length "+t+" expected, got "+i);return r}function yw(n){return Uint8Array.from(n)}const Wg=n=>typeof n=="bigint"&&B6<=n;function xF(n,e,t){return Wg(n)&&Wg(e)&&Wg(t)&&e<=n&&n<t}function dh(n,e,t,r){if(!xF(e,t,r))throw new Error("expected valid "+n+": "+t+" <= n < "+r+", got "+e)}function vk(n){let e;for(e=0;n>B6;n>>=$4,e+=1);return e}const Jh=n=>($4<<BigInt(n))-$4;function kF(n,e,t){if(typeof n!="number"||n<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");const r=p=>new Uint8Array(p),i=p=>Uint8Array.of(p);let s=r(n),o=r(n),a=0;const l=()=>{s.fill(1),o.fill(0),a=0},c=(...p)=>t(o,s,...p),u=(p=r(0))=>{o=c(i(0),p),s=c(),p.length!==0&&(o=c(i(1),p),s=c())},d=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let p=0;const y=[];for(;p<e;){s=c();const g=s.slice();y.push(g),p+=s.length}return Li(...y)};return(p,y)=>{l(),u(p);let g;for(;!(g=y(d()));)u();return l(),g}}function Eu(n,e,t={}){if(!n||typeof n!="object")throw new Error("expected valid options object");function r(i,s,o){const a=n[i];if(o&&a===void 0)return;const l=typeof a;if(l!==s||a===null)throw new Error(`param "${i}" is invalid: expected ${s}, got ${l}`)}Object.entries(e).forEach(([i,s])=>r(i,s,!1)),Object.entries(t).forEach(([i,s])=>r(i,s,!0))}function U0(n){const e=new WeakMap;return(t,...r)=>{const i=e.get(t);if(i!==void 0)return i;const s=n(t,...r);return e.set(t,s),s}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Wn=BigInt(0),Zt=BigInt(1),fa=BigInt(2),Ek=BigInt(3),bk=BigInt(4),_k=BigInt(5),RF=BigInt(7),Sk=BigInt(8),AF=BigInt(9),xk=BigInt(16);function _t(n,e){const t=n%e;return t>=Wn?t:e+t}function pt(n,e,t){let r=n;for(;e-- >Wn;)r*=r,r%=t;return r}function mw(n,e){if(n===Wn)throw new Error("invert: expected non-zero number");if(e<=Wn)throw new Error("invert: expected positive modulus, got "+e);let t=_t(n,e),r=e,i=Wn,s=Zt;for(;t!==Wn;){const a=r/t,l=r%t,c=i-s*a;r=t,t=l,i=s,s=c}if(r!==Zt)throw new Error("invert: does not exist");return _t(i,e)}function U6(n,e,t){if(!n.eql(n.sqr(e),t))throw new Error("Cannot find square root")}function kk(n,e){const t=(n.ORDER+Zt)/bk,r=n.pow(e,t);return U6(n,r,e),r}function IF(n,e){const t=(n.ORDER-_k)/Sk,r=n.mul(e,fa),i=n.pow(r,t),s=n.mul(e,i),o=n.mul(n.mul(s,fa),i),a=n.mul(s,n.sub(o,n.ONE));return U6(n,a,e),a}function CF(n){const e=Ja(n),t=Rk(n),r=t(e,e.neg(e.ONE)),i=t(e,r),s=t(e,e.neg(r)),o=(n+RF)/xk;return(a,l)=>{let c=a.pow(l,o),u=a.mul(c,r);const d=a.mul(c,i),f=a.mul(c,s),p=a.eql(a.sqr(u),l),y=a.eql(a.sqr(d),l);c=a.cmov(c,u,p),u=a.cmov(f,d,y);const g=a.eql(a.sqr(u),l),w=a.cmov(c,u,g);return U6(a,w,l),w}}function Rk(n){if(n<Ek)throw new Error("sqrt is not defined for small field");let e=n-Zt,t=0;for(;e%fa===Wn;)e/=fa,t++;let r=fa;const i=Ja(n);for(;ww(i,r)===1;)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return kk;let s=i.pow(r,e);const o=(e+Zt)/fa;return function(l,c){if(l.is0(c))return c;if(ww(l,c)!==1)throw new Error("Cannot find square root");let u=t,d=l.mul(l.ONE,s),f=l.pow(c,e),p=l.pow(c,o);for(;!l.eql(f,l.ONE);){if(l.is0(f))return l.ZERO;let y=1,g=l.sqr(f);for(;!l.eql(g,l.ONE);)if(y++,g=l.sqr(g),y===u)throw new Error("Cannot find square root");const w=Zt<<BigInt(u-y-1),m=l.pow(d,w);u=y,d=l.sqr(m),f=l.mul(f,d),p=l.mul(p,m)}return p}}function TF(n){return n%bk===Ek?kk:n%Sk===_k?IF:n%xk===AF?CF(n):Rk(n)}const NF=(n,e)=>(_t(n,e)&Zt)===Zt,DF=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function PF(n){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=DF.reduce((r,i)=>(r[i]="function",r),e);return Eu(n,t),n}function OF(n,e,t){if(t<Wn)throw new Error("invalid exponent, negatives unsupported");if(t===Wn)return n.ONE;if(t===Zt)return e;let r=n.ONE,i=e;for(;t>Wn;)t&Zt&&(r=n.mul(r,i)),i=n.sqr(i),t>>=Zt;return r}function Ak(n,e,t=!1){const r=new Array(e.length).fill(t?n.ZERO:void 0),i=e.reduce((o,a,l)=>n.is0(a)?o:(r[l]=o,n.mul(o,a)),n.ONE),s=n.inv(i);return e.reduceRight((o,a,l)=>n.is0(a)?o:(r[l]=n.mul(o,r[l]),n.mul(o,a)),s),r}function ww(n,e){const t=(n.ORDER-Zt)/fa,r=n.pow(e,t),i=n.eql(r,n.ONE),s=n.eql(r,n.ZERO),o=n.eql(r,n.neg(n.ONE));if(!i&&!s&&!o)throw new Error("invalid Legendre symbol result");return i?1:s?0:-1}function Ik(n,e){e!==void 0&&Na(e);const t=e!==void 0?e:n.toString(2).length,r=Math.ceil(t/8);return{nBitLength:t,nByteLength:r}}function Ja(n,e,t=!1,r={}){if(n<=Wn)throw new Error("invalid field: expected ORDER > 0, got "+n);let i,s,o=!1,a;if(typeof e=="object"&&e!=null){if(r.sqrt||t)throw new Error("cannot specify opts in two arguments");const f=e;f.BITS&&(i=f.BITS),f.sqrt&&(s=f.sqrt),typeof f.isLE=="boolean"&&(t=f.isLE),typeof f.modFromBytes=="boolean"&&(o=f.modFromBytes),a=f.allowedLengths}else typeof e=="number"&&(i=e),r.sqrt&&(s=r.sqrt);const{nBitLength:l,nByteLength:c}=Ik(n,i);if(c>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let u;const d=Object.freeze({ORDER:n,isLE:t,BITS:l,BYTES:c,MASK:Jh(l),ZERO:Wn,ONE:Zt,allowedLengths:a,create:f=>_t(f,n),isValid:f=>{if(typeof f!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof f);return Wn<=f&&f<n},is0:f=>f===Wn,isValidNot0:f=>!d.is0(f)&&d.isValid(f),isOdd:f=>(f&Zt)===Zt,neg:f=>_t(-f,n),eql:(f,p)=>f===p,sqr:f=>_t(f*f,n),add:(f,p)=>_t(f+p,n),sub:(f,p)=>_t(f-p,n),mul:(f,p)=>_t(f*p,n),pow:(f,p)=>OF(d,f,p),div:(f,p)=>_t(f*mw(p,n),n),sqrN:f=>f*f,addN:(f,p)=>f+p,subN:(f,p)=>f-p,mulN:(f,p)=>f*p,inv:f=>mw(f,n),sqrt:s||(f=>(u||(u=TF(n)),u(d,f))),toBytes:f=>t?$6(f,c):M6(f,c),fromBytes:(f,p=!0)=>{if(a){if(!a.includes(f.length)||f.length>c)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+f.length);const g=new Uint8Array(c);g.set(f,t?0:g.length-f.length),f=g}if(f.length!==c)throw new Error("Field.fromBytes: expected "+c+" bytes, got "+f.length);let y=t?Ka(f):pp(f);if(o&&(y=_t(y,n)),!p&&!d.isValid(y))throw new Error("invalid field element: outside of range 0..ORDER");return y},invertBatch:f=>Ak(d,f),cmov:(f,p,y)=>y?p:f});return Object.freeze(d)}function Ck(n){if(typeof n!="bigint")throw new Error("field order must be bigint");const e=n.toString(2).length;return Math.ceil(e/8)}function Tk(n){const e=Ck(n);return e+Math.ceil(e/2)}function LF(n,e,t=!1){const r=n.length,i=Ck(e),s=Tk(e);if(r<16||r<s||r>1024)throw new Error("expected "+s+"-1024 bytes of input, got "+r);const o=t?Ka(n):pp(n),a=_t(o,e-Zt)+Zt;return t?$6(a,i):M6(a,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Bc=BigInt(0),pa=BigInt(1);function F0(n,e){const t=e.negate();return n?t:e}function ga(n,e){const t=Ak(n.Fp,e.map(r=>r.Z));return e.map((r,i)=>n.fromAffine(r.toAffine(t[i])))}function Nk(n,e){if(!Number.isSafeInteger(n)||n<=0||n>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+n)}function Gg(n,e){Nk(n,e);const t=Math.ceil(e/n)+1,r=2**(n-1),i=2**n,s=Jh(n),o=BigInt(n);return{windows:t,windowSize:r,mask:s,maxNumber:i,shiftBy:o}}function vw(n,e,t){const{windowSize:r,mask:i,maxNumber:s,shiftBy:o}=t;let a=Number(n&i),l=n>>o;a>r&&(a-=s,l+=pa);const c=e*r,u=c+Math.abs(a)-1,d=a===0,f=a<0,p=e%2!==0;return{nextN:l,offset:u,isZero:d,isNeg:f,isNegF:p,offsetF:c}}function BF(n,e){if(!Array.isArray(n))throw new Error("array expected");n.forEach((t,r)=>{if(!(t instanceof e))throw new Error("invalid point at index "+r)})}function MF(n,e){if(!Array.isArray(n))throw new Error("array of scalars expected");n.forEach((t,r)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+r)})}const qg=new WeakMap,Dk=new WeakMap;function jg(n){return Dk.get(n)||1}function Ew(n){if(n!==Bc)throw new Error("invalid wNAF")}class Pk{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,r=this.ZERO){let i=e;for(;t>Bc;)t&pa&&(r=r.add(i)),i=i.double(),t>>=pa;return r}precomputeWindow(e,t){const{windows:r,windowSize:i}=Gg(t,this.bits),s=[];let o=e,a=o;for(let l=0;l<r;l++){a=o,s.push(a);for(let c=1;c<i;c++)a=a.add(o),s.push(a);o=a.double()}return s}wNAF(e,t,r){if(!this.Fn.isValid(r))throw new Error("invalid scalar");let i=this.ZERO,s=this.BASE;const o=Gg(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:l,offset:c,isZero:u,isNeg:d,isNegF:f,offsetF:p}=vw(r,a,o);r=l,u?s=s.add(F0(f,t[p])):i=i.add(F0(d,t[c]))}return Ew(r),{p:i,f:s}}wNAFUnsafe(e,t,r,i=this.ZERO){const s=Gg(e,this.bits);for(let o=0;o<s.windows&&r!==Bc;o++){const{nextN:a,offset:l,isZero:c,isNeg:u}=vw(r,o,s);if(r=a,!c){const d=t[l];i=i.add(u?d.negate():d)}}return Ew(r),i}getPrecomputes(e,t,r){let i=qg.get(t);return i||(i=this.precomputeWindow(t,e),e!==1&&(typeof r=="function"&&(i=r(i)),qg.set(t,i))),i}cached(e,t,r){const i=jg(e);return this.wNAF(i,this.getPrecomputes(i,e,r),t)}unsafe(e,t,r,i){const s=jg(e);return s===1?this._unsafeLadder(e,t,i):this.wNAFUnsafe(s,this.getPrecomputes(s,e,r),t,i)}createCache(e,t){Nk(t,this.bits),Dk.set(e,t),qg.delete(e)}hasCache(e){return jg(e)!==1}}function $F(n,e,t,r){let i=e,s=n.ZERO,o=n.ZERO;for(;t>Bc||r>Bc;)t&pa&&(s=s.add(i)),r&pa&&(o=o.add(i)),i=i.double(),t>>=pa,r>>=pa;return{p1:s,p2:o}}function Ok(n,e,t,r){BF(t,n),MF(r,e);const i=t.length,s=r.length;if(i!==s)throw new Error("arrays of points and scalars must have equal length");const o=n.ZERO,a=vk(BigInt(i));let l=1;a>12?l=a-3:a>4?l=a-2:a>0&&(l=2);const c=Jh(l),u=new Array(Number(c)+1).fill(o),d=Math.floor((e.BITS-1)/l)*l;let f=o;for(let p=d;p>=0;p-=l){u.fill(o);for(let g=0;g<s;g++){const w=r[g],m=Number(w>>BigInt(p)&c);u[m]=u[m].add(t[g])}let y=o;for(let g=u.length-1,w=o;g>0;g--)w=w.add(u[g]),y=y.add(w);if(f=f.add(y),p!==0)for(let g=0;g<l;g++)f=f.double()}return f}function bw(n,e,t){if(e){if(e.ORDER!==n)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return PF(e),e}else return Ja(n,{isLE:t})}function Lk(n,e,t={},r){if(r===void 0&&(r=n==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${n} CURVE object`);for(const l of["p","n","h"]){const c=e[l];if(!(typeof c=="bigint"&&c>Bc))throw new Error(`CURVE.${l} must be positive bigint`)}const i=bw(e.p,t.Fp,r),s=bw(e.n,t.Fn,r),a=["Gx","Gy","a",n==="weierstrass"?"b":"d"];for(const l of a)if(!i.isValid(e[l]))throw new Error(`CURVE.${l} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:i,Fn:s}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const qs=BigInt(0),Ft=BigInt(1),Yg=BigInt(2),UF=BigInt(8);function FF(n,e,t,r){const i=n.sqr(t),s=n.sqr(r),o=n.add(n.mul(e.a,i),s),a=n.add(n.ONE,n.mul(e.d,n.mul(i,s)));return n.eql(o,a)}function zF(n,e={}){const t=Lk("edwards",n,e,e.FpFnLE),{Fp:r,Fn:i}=t;let s=t.CURVE;const{h:o}=s;Eu(e,{},{uvRatio:"function"});const a=Yg<<BigInt(i.BYTES*8)-Ft,l=w=>r.create(w),c=e.uvRatio||((w,m)=>{try{return{isValid:!0,value:r.sqrt(r.div(w,m))}}catch{return{isValid:!1,value:qs}}});if(!FF(r,s,s.Gx,s.Gy))throw new Error("bad curve params: generator point");function u(w,m,E=!1){const v=E?Ft:qs;return dh("coordinate "+w,m,v,a),m}function d(w){if(!(w instanceof y))throw new Error("ExtendedPoint expected")}const f=U0((w,m)=>{const{X:E,Y:v,Z:b}=w,k=w.is0();m==null&&(m=k?UF:r.inv(b));const A=l(E*m),T=l(v*m),P=r.mul(b,m);if(k)return{x:qs,y:Ft};if(P!==Ft)throw new Error("invZ was invalid");return{x:A,y:T}}),p=U0(w=>{const{a:m,d:E}=s;if(w.is0())throw new Error("bad point: ZERO");const{X:v,Y:b,Z:k,T:A}=w,T=l(v*v),P=l(b*b),_=l(k*k),N=l(_*_),V=l(T*m),z=l(_*l(V+P)),R=l(N+l(E*l(T*P)));if(z!==R)throw new Error("bad point: equation left != right (1)");const C=l(v*b),x=l(k*A);if(C!==x)throw new Error("bad point: equation left != right (2)");return!0});class y{constructor(m,E,v,b){this.X=u("x",m),this.Y=u("y",E),this.Z=u("z",v,!0),this.T=u("t",b),Object.freeze(this)}static CURVE(){return s}static fromAffine(m){if(m instanceof y)throw new Error("extended point not allowed");const{x:E,y:v}=m||{};return u("x",E),u("y",v),new y(E,v,Ft,l(E*v))}static fromBytes(m,E=!1){const v=r.BYTES,{a:b,d:k}=s;m=yw(ei(m,v,"point")),Ha(E,"zip215");const A=yw(m),T=m[v-1];A[v-1]=T&-129;const P=Ka(A),_=E?a:r.ORDER;dh("point.y",P,qs,_);const N=l(P*P),V=l(N-Ft),z=l(k*N-b);let{isValid:R,value:C}=c(V,z);if(!R)throw new Error("bad point: invalid y coordinate");const x=(C&Ft)===Ft,M=(T&128)!==0;if(!E&&C===qs&&M)throw new Error("bad point: x=0 and x_0=1");return M!==x&&(C=l(-C)),y.fromAffine({x:C,y:P})}static fromHex(m,E=!1){return y.fromBytes(ut("point",m),E)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(m=8,E=!0){return g.createCache(this,m),E||this.multiply(Yg),this}assertValidity(){p(this)}equals(m){d(m);const{X:E,Y:v,Z:b}=this,{X:k,Y:A,Z:T}=m,P=l(E*T),_=l(k*b),N=l(v*T),V=l(A*b);return P===_&&N===V}is0(){return this.equals(y.ZERO)}negate(){return new y(l(-this.X),this.Y,this.Z,l(-this.T))}double(){const{a:m}=s,{X:E,Y:v,Z:b}=this,k=l(E*E),A=l(v*v),T=l(Yg*l(b*b)),P=l(m*k),_=E+v,N=l(l(_*_)-k-A),V=P+A,z=V-T,R=P-A,C=l(N*z),x=l(V*R),M=l(N*R),K=l(z*V);return new y(C,x,K,M)}add(m){d(m);const{a:E,d:v}=s,{X:b,Y:k,Z:A,T}=this,{X:P,Y:_,Z:N,T:V}=m,z=l(b*P),R=l(k*_),C=l(T*v*V),x=l(A*N),M=l((b+k)*(P+_)-z-R),K=x-C,L=x+C,O=l(R-E*z),H=l(M*K),G=l(L*O),j=l(M*O),be=l(K*L);return new y(H,G,be,j)}subtract(m){return this.add(m.negate())}multiply(m){if(!i.isValidNot0(m))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:E,f:v}=g.cached(this,m,b=>ga(y,b));return ga(y,[E,v])[0]}multiplyUnsafe(m,E=y.ZERO){if(!i.isValid(m))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return m===qs?y.ZERO:this.is0()||m===Ft?this:g.unsafe(this,m,v=>ga(y,v),E)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return g.unsafe(this,s.n).is0()}toAffine(m){return f(this,m)}clearCofactor(){return o===Ft?this:this.multiplyUnsafe(o)}toBytes(){const{x:m,y:E}=this.toAffine(),v=r.toBytes(E);return v[v.length-1]|=m&Ft?128:0,v}toHex(){return Da(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get ex(){return this.X}get ey(){return this.Y}get ez(){return this.Z}get et(){return this.T}static normalizeZ(m){return ga(y,m)}static msm(m,E){return Ok(y,i,m,E)}_setWindowSize(m){this.precompute(m)}toRawBytes(){return this.toBytes()}}y.BASE=new y(s.Gx,s.Gy,Ft,l(s.Gx*s.Gy)),y.ZERO=new y(qs,Ft,Ft,qs),y.Fp=r,y.Fn=i;const g=new Pk(y,i.BITS);return y.BASE.precompute(8),y}function VF(n,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');Eu(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:r}=t,{BASE:i,Fp:s,Fn:o}=n,a=t.randomBytes||Xh,l=t.adjustScalarBytes||(_=>_),c=t.domain||((_,N,V)=>{if(Ha(V,"phflag"),N.length||V)throw new Error("Contexts/pre-hash are not supported");return _});function u(_){return o.create(Ka(_))}function d(_){const N=v.secretKey;_=ut("private key",_,N);const V=ut("hashed private key",e(_),2*N),z=l(V.slice(0,N)),R=V.slice(N,2*N),C=u(z);return{head:z,prefix:R,scalar:C}}function f(_){const{head:N,prefix:V,scalar:z}=d(_),R=i.multiply(z),C=R.toBytes();return{head:N,prefix:V,scalar:z,point:R,pointBytes:C}}function p(_){return f(_).pointBytes}function y(_=Uint8Array.of(),...N){const V=Li(...N);return u(e(c(V,ut("context",_),!!r)))}function g(_,N,V={}){_=ut("message",_),r&&(_=r(_));const{prefix:z,scalar:R,pointBytes:C}=f(N),x=y(V.context,z,_),M=i.multiply(x).toBytes(),K=y(V.context,M,C,_),L=o.create(x+K*R);if(!o.isValid(L))throw new Error("sign failed: invalid s");const O=Li(M,o.toBytes(L));return ei(O,v.signature,"result")}const w={zip215:!0};function m(_,N,V,z=w){const{context:R,zip215:C}=z,x=v.signature;_=ut("signature",_,x),N=ut("message",N),V=ut("publicKey",V,v.publicKey),C!==void 0&&Ha(C,"zip215"),r&&(N=r(N));const M=x/2,K=_.subarray(0,M),L=Ka(_.subarray(M,x));let O,H,G;try{O=n.fromBytes(V,C),H=n.fromBytes(K,C),G=i.multiplyUnsafe(L)}catch{return!1}if(!C&&O.isSmallOrder())return!1;const j=y(R,H.toBytes(),O.toBytes(),N);return H.add(O.multiplyUnsafe(j)).subtract(G).clearCofactor().is0()}const E=s.BYTES,v={secretKey:E,publicKey:E,signature:2*E,seed:E};function b(_=a(v.seed)){return ei(_,v.seed,"seed")}function k(_){const N=P.randomSecretKey(_);return{secretKey:N,publicKey:p(N)}}function A(_){return Yh(_)&&_.length===o.BYTES}function T(_,N){try{return!!n.fromBytes(_,N)}catch{return!1}}const P={getExtendedPublicKey:f,randomSecretKey:b,isValidSecretKey:A,isValidPublicKey:T,toMontgomery(_){const{y:N}=n.fromBytes(_),V=v.publicKey,z=V===32;if(!z&&V!==57)throw new Error("only defined for 25519 and 448");const R=z?s.div(Ft+N,Ft-N):s.div(N-Ft,N+Ft);return s.toBytes(R)},toMontgomerySecret(_){const N=v.secretKey;ei(_,N);const V=e(_.subarray(0,N));return l(V).subarray(0,N)},randomPrivateKey:b,precompute(_=8,N=n.BASE){return N.precompute(_,!1)}};return Object.freeze({keygen:k,getPublicKey:p,sign:g,verify:m,utils:P,Point:n,lengths:v})}function HF(n){const e={a:n.a,d:n.d,p:n.Fp.ORDER,n:n.n,h:n.h,Gx:n.Gx,Gy:n.Gy},t=n.Fp,r=Ja(e.n,n.nBitLength,!0),i={Fp:t,Fn:r,uvRatio:n.uvRatio},s={randomBytes:n.randomBytes,adjustScalarBytes:n.adjustScalarBytes,domain:n.domain,prehash:n.prehash,mapToCurve:n.mapToCurve};return{CURVE:e,curveOpts:i,hash:n.hash,eddsaOpts:s}}function KF(n,e){const t=e.Point;return Object.assign({},e,{ExtendedPoint:t,CURVE:n,nBitLength:t.Fn.BITS,nByteLength:t.Fn.BYTES})}function WF(n){const{CURVE:e,curveOpts:t,hash:r,eddsaOpts:i}=HF(n),s=zF(e,t),o=VF(s,r,i);return KF(n,o)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Qu=BigInt(0),wl=BigInt(1),Kf=BigInt(2);function GF(n){return Eu(n,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...n})}function qF(n){const e=GF(n),{P:t,type:r,adjustScalarBytes:i,powPminus2:s,randomBytes:o}=e,a=r==="x25519";if(!a&&r!=="x448")throw new Error("invalid type");const l=o||Xh,c=a?255:448,u=a?32:56,d=BigInt(a?9:5),f=BigInt(a?121665:39081),p=a?Kf**BigInt(254):Kf**BigInt(447),y=a?BigInt(8)*Kf**BigInt(251)-wl:BigInt(4)*Kf**BigInt(445)-wl,g=p+y+wl,w=R=>_t(R,t),m=E(d);function E(R){return $6(w(R),u)}function v(R){const C=ut("u coordinate",R,u);return a&&(C[31]&=127),w(Ka(C))}function b(R){return Ka(i(ut("scalar",R,u)))}function k(R,C){const x=P(v(C),b(R));if(x===Qu)throw new Error("invalid private or public key received");return E(x)}function A(R){return k(R,m)}function T(R,C,x){const M=w(R*(C-x));return C=w(C-M),x=w(x+M),{x_2:C,x_3:x}}function P(R,C){dh("u",R,Qu,t),dh("scalar",C,p,g);const x=C,M=R;let K=wl,L=Qu,O=R,H=wl,G=Qu;for(let be=BigInt(c-1);be>=Qu;be--){const Ee=x>>be&wl;G^=Ee,{x_2:K,x_3:O}=T(G,K,O),{x_2:L,x_3:H}=T(G,L,H),G=Ee;const pe=K+L,we=w(pe*pe),Ie=K-L,Ze=w(Ie*Ie),D=we-Ze,F=O+H,W=O-H,ve=w(W*pe),de=w(F*Ie),ge=ve+de,rt=ve-de;O=w(ge*ge),H=w(M*w(rt*rt)),K=w(we*Ze),L=w(D*(we+w(f*D)))}({x_2:K,x_3:O}=T(G,K,O)),{x_2:L,x_3:H}=T(G,L,H);const j=s(L);return w(K*j)}const _={secretKey:u,publicKey:u,seed:u},N=(R=l(u))=>(Bs(R,_.seed),R);function V(R){const C=N(R);return{secretKey:C,publicKey:A(C)}}return{keygen:V,getSharedSecret:(R,C)=>k(R,C),getPublicKey:R=>A(R),scalarMult:k,scalarMultBase:A,utils:{randomSecretKey:N,randomPrivateKey:N},GuBytes:m.slice(),lengths:_}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const jF=BigInt(1),_w=BigInt(2),YF=BigInt(3),QF=BigInt(5),XF=BigInt(8),F6=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),Bk={p:F6,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:XF,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function Mk(n){const e=BigInt(10),t=BigInt(20),r=BigInt(40),i=BigInt(80),s=F6,a=n*n%s*n%s,l=pt(a,_w,s)*a%s,c=pt(l,jF,s)*n%s,u=pt(c,QF,s)*c%s,d=pt(u,e,s)*u%s,f=pt(d,t,s)*d%s,p=pt(f,r,s)*f%s,y=pt(p,i,s)*p%s,g=pt(y,i,s)*p%s,w=pt(g,e,s)*u%s;return{pow_p_5_8:pt(w,_w,s)*n%s,b2:a}}function $k(n){return n[0]&=248,n[31]&=127,n[31]|=64,n}const Sw=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function JF(n,e){const t=F6,r=_t(e*e*e,t),i=_t(r*r*e,t),s=Mk(n*i).pow_p_5_8;let o=_t(n*r*s,t);const a=_t(e*o*o,t),l=o,c=_t(o*Sw,t),u=a===n,d=a===_t(-n,t),f=a===_t(-n*Sw,t);return u&&(o=l),(d||f)&&(o=c),NF(o,t)&&(o=_t(-o,t)),{isValid:u||d,value:o}}const Uk=Ja(Bk.p,{isLE:!0}),ZF={...Bk,Fp:Uk,hash:mk,adjustScalarBytes:$k,uvRatio:JF},hh=WF(ZF),Wf=(()=>{const n=Uk.ORDER;return qF({P:n,type:"x25519",powPminus2:e=>{const{pow_p_5_8:t,b2:r}=Mk(e);return _t(pt(t,YF,n)*r,n)},adjustScalarBytes:$k})})(),fh=32,to=64,z0=32;function ez(){const n=hh.utils.randomPrivateKey(),e=hh.getPublicKey(n);return{privateKey:Fk(n,e),publicKey:e}}function tz(n){if(n.length!==z0)throw new TypeError('"seed" must be 32 bytes in length.');if(!(n instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const e=n,t=hh.getPublicKey(e);return{privateKey:Fk(e,t),publicKey:t}}function nz(n,e){const t=n.subarray(0,z0);return hh.sign(e instanceof Uint8Array?e:e.subarray(),t)}function rz(n,e,t){return hh.verify(e,t instanceof Uint8Array?t:t.subarray(),n)}function Fk(n,e){const t=new Uint8Array(to);for(let r=0;r<z0;r++)t[r]=n[r],t[z0+r]=e[r];return t}const Qg={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function zk(n){const e="AES-GCM";let t=16;const r=12,i="SHA-256",s=16,o=32767,a=Mr.get();t*=8;async function l(d,f){const p=a.getRandomValues(new Uint8Array(s)),y=a.getRandomValues(new Uint8Array(r)),g={name:e,iv:y};typeof f=="string"&&(f=Y(f));let w;if(f.length===0){w=await a.subtle.importKey("jwk",Qg,{name:"AES-GCM"},!0,["encrypt"]);try{const E={name:"PBKDF2",salt:p,iterations:o,hash:{name:i}},v=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(E,v,{name:e,length:t},!0,["encrypt"])}catch{w=await a.subtle.importKey("jwk",Qg,{name:"AES-GCM"},!0,["encrypt"])}}else{const E={name:"PBKDF2",salt:p,iterations:o,hash:{name:i}},v=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(E,v,{name:e,length:t},!0,["encrypt"])}const m=await a.subtle.encrypt(g,w,d);return vn([p,g.iv,new Uint8Array(m)])}async function c(d,f){const p=d.subarray(0,s),y=d.subarray(s,s+r),g=d.subarray(s+r),w={name:e,iv:y};typeof f=="string"&&(f=Y(f));let m;if(f.length===0)try{const v={name:"PBKDF2",salt:p,iterations:o,hash:{name:i}},b=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(v,b,{name:e,length:t},!0,["decrypt"])}catch{m=await a.subtle.importKey("jwk",Qg,{name:"AES-GCM"},!0,["decrypt"])}else{const v={name:"PBKDF2",salt:p,iterations:o,hash:{name:i}},b=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(v,b,{name:e,length:t},!0,["decrypt"])}const E=await a.subtle.decrypt(w,m,g);return new Uint8Array(E)}return{encrypt:l,decrypt:c}}async function z6(n,e){const r=await zk().encrypt(n,e);return ar.encode(r)}var Ot;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.Secp256k1="Secp256k1"})(Ot||(Ot={}));var U4;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.Secp256k1=2]="Secp256k1"})(U4||(U4={}));(function(n){n.codec=()=>Pn(U4)})(Ot||(Ot={}));var Mc;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),Ot.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.Type=Ot.codec().decode(t);break;case 2:i.Data=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(Mc||(Mc={}));var $c;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),Ot.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.Type=Ot.codec().decode(t);break;case 2:i.Data=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})($c||($c={}));class V6{constructor(e){h(this,"_key");this._key=Uc(e,fh)}verify(e,t){return rz(this._key,t,e)}marshal(){return this._key}get bytes(){return Mc.encode({Type:Ot.Ed25519,Data:this.marshal()}).subarray()}equals(e){return Pe(this.bytes,e.bytes)}hash(){const e=nn.digest(this.bytes);return Go(e)?e.then(({bytes:t})=>t):e.bytes}}class ph{constructor(e,t){h(this,"_key");h(this,"_publicKey");this._key=Uc(e,to),this._publicKey=Uc(t,fh)}sign(e){return nz(this._key,e)}get public(){return new V6(this._publicKey)}marshal(){return this._key}get bytes(){return $c.encode({Type:Ot.Ed25519,Data:this.marshal()}).subarray()}equals(e){return Pe(this.bytes,e.bytes)}async hash(){const e=nn.digest(this.bytes);let t;return Go(e)?{bytes:t}=await e:t=e.bytes,t}async id(){const e=Po.digest(this.public.bytes);return mn.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return z6(this.bytes,e);throw new S(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function iz(n){if(n.length>to){n=Uc(n,to+fh);const r=n.subarray(0,to),i=n.subarray(to,n.length);return new ph(r,i)}n=Uc(n,to);const e=n.subarray(0,to),t=n.subarray(fh);return new ph(e,t)}function sz(n){return n=Uc(n,fh),new V6(n)}async function oz(){const{privateKey:n,publicKey:e}=ez();return new ph(n,e)}async function az(n){const{privateKey:e,publicKey:t}=tz(n);return new ph(e,t)}function Uc(n,e){if(n=Uint8Array.from(n??[]),n.length!==e)throw new S(`Key must be a Uint8Array of length ${e}, got ${n.length}`,"ERR_INVALID_KEY_TYPE");return n}const lz=Object.freeze(Object.defineProperty({__proto__:null,Ed25519PrivateKey:ph,Ed25519PublicKey:V6,generateKeyPair:oz,generateKeyPairFromSeed:az,unmarshalEd25519PrivateKey:iz,unmarshalEd25519PublicKey:sz},Symbol.toStringTag,{value:"Module"}));async function cz(n,e){const t=ar.decode(n);return zk().decrypt(t,e)}function Yi(n){if(isNaN(n)||n<=0)throw new S("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return Xh(n)}class Vk extends hk{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Qh(e);const r=uh(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,s=new Uint8Array(i);s.set(r.length>i?e.create().update(r).digest():r);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),ji(s)}update(e){return M0(this),this.iHash.update(e),this}digestInto(e){M0(this),Bs(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:r,finished:i,destroyed:s,blockLen:o,outputLen:a}=this;return e=e,e.finished=i,e.destroyed=s,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Zh=(n,e,t)=>new Vk(n,e).update(t).digest();Zh.create=(n,e)=>new Vk(n,e);function Hk(n,e,t,r){Qh(n);const i=cF({dkLen:32,asyncTick:10},r),{c:s,dkLen:o,asyncTick:a}=i;if(Na(s),Na(o),Na(a),s<1)throw new Error("iterations (c) should be >= 1");const l=hw(e),c=hw(t),u=new Uint8Array(o),d=Zh.create(n,l),f=d._cloneInto().update(c);return{c:s,dkLen:o,asyncTick:a,DK:u,PRF:d,PRFSalt:f}}function Kk(n,e,t,r,i){return n.destroy(),e.destroy(),r&&r.destroy(),ji(i),t}function uz(n,e,t,r){const{c:i,dkLen:s,DK:o,PRF:a,PRFSalt:l}=Hk(n,e,t,r);let c;const u=new Uint8Array(4),d=Id(u),f=new Uint8Array(a.outputLen);for(let p=1,y=0;y<s;p++,y+=a.outputLen){const g=o.subarray(y,y+a.outputLen);d.setInt32(0,p,!1),(c=l._cloneInto(c)).update(u).digestInto(f),g.set(f.subarray(0,g.length));for(let w=1;w<i;w++){a._cloneInto(c).update(f).digestInto(f);for(let m=0;m<g.length;m++)g[m]^=f[m]}}return Kk(a,l,o,c,f)}async function Wk(n,e,t,r){const{c:i,dkLen:s,asyncTick:o,DK:a,PRF:l,PRFSalt:c}=Hk(n,e,t,r);let u;const d=new Uint8Array(4),f=Id(d),p=new Uint8Array(l.outputLen);for(let y=1,g=0;g<s;y++,g+=l.outputLen){const w=a.subarray(g,g+l.outputLen);f.setInt32(0,y,!1),(u=c._cloneInto(u)).update(d).digestInto(p),w.set(p.subarray(0,w.length)),await lF(i-1,o,()=>{l._cloneInto(u).update(p).digestInto(p);for(let m=0;m<w.length;m++)w[m]^=p[m]})}return Kk(l,c,a,u,p)}const H6=mk;/*!
 * MIT License
 * 
 * Copyright (c) 2017-2024 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const dz="[object ArrayBuffer]";class Je{static isArrayBuffer(e){return Object.prototype.toString.call(e)===dz}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const r=Je.toUint8Array(e),i=Je.toUint8Array(t);if(r.length!==i.byteLength)return!1;for(let s=0;s<r.length;s++)if(r[s]!==i[s])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let r=0;for(const o of t)r+=o.byteLength;const i=new Uint8Array(r);let s=0;for(const o of t){const a=this.toUint8Array(o);i.set(a,s),s+=a.length}return e[e.length-1]instanceof Function?this.toView(i,e[e.length-1]):i.buffer}}const Xg="string",hz=/^[0-9a-f\s]+$/i,fz=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,pz=/^[a-zA-Z0-9-_]+$/;class xw{static fromString(e){const t=unescape(encodeURIComponent(e)),r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r.buffer}static toString(e){const t=Je.toUint8Array(e);let r="";for(let s=0;s<t.length;s++)r+=String.fromCharCode(t[s]);return decodeURIComponent(escape(r))}}class wi{static toString(e,t=!1){const r=Je.toArrayBuffer(e),i=new DataView(r);let s="";for(let o=0;o<r.byteLength;o+=2){const a=i.getUint16(o,t);s+=String.fromCharCode(a)}return s}static fromString(e,t=!1){const r=new ArrayBuffer(e.length*2),i=new DataView(r);for(let s=0;s<e.length;s++)i.setUint16(s*2,e.charCodeAt(s),t);return r}}class St{static isHex(e){return typeof e===Xg&&hz.test(e)}static isBase64(e){return typeof e===Xg&&fz.test(e)}static isBase64Url(e){return typeof e===Xg&&pz.test(e)}static ToString(e,t="utf8"){const r=Je.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(r);case"binary":return this.ToBinary(r);case"hex":return this.ToHex(r);case"base64":return this.ToBase64(r);case"base64url":return this.ToBase64Url(r);case"utf16le":return wi.toString(r,!0);case"utf16":case"utf16be":return wi.toString(r);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return wi.fromString(e,!0);case"utf16":case"utf16be":return wi.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=Je.toUint8Array(e);if(typeof btoa<"u"){const r=this.ToString(t,"binary");return btoa(r)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!St.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!St.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=St.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return xw.fromString(e);case"utf16":case"utf16be":return wi.fromString(e);case"utf16le":case"usc2":return wi.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=St.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return xw.toString(e);case"utf16":case"utf16be":return wi.toString(e);case"utf16le":case"usc2":return wi.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,r=new Uint8Array(t);for(let i=0;i<t;i++)r[i]=e.charCodeAt(i);return r.buffer}static ToBinary(e){const t=Je.toUint8Array(e);let r="";for(let i=0;i<t.length;i++)r+=String.fromCharCode(t[i]);return r}static ToHex(e){const t=Je.toUint8Array(e);let r="";const i=t.length;for(let s=0;s<i;s++){const o=t[s];o<16&&(r+="0"),r+=o.toString(16)}return r}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!St.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const r=new Uint8Array(t.length/2);for(let i=0;i<t.length;i=i+2){const s=t.slice(i,i+2);r[i/2]=parseInt(s,16)}return r.buffer}static ToUtf16String(e,t=!1){return wi.toString(e,t)}static FromUtf16String(e,t=!1){return wi.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let r=0;r<t;r++)e+="=";return e}static formatString(e){return(e==null?void 0:e.replace(/[\n\r\t ]/g,""))||""}}St.DEFAULT_UTF8_ENCODING="utf8";/*!
 Copyright (c) Peculiar Ventures, LLC
*/function Fc(n,e){let t=0;if(n.length===1)return n[0];for(let r=n.length-1;r>=0;r--)t+=n[n.length-1-r]*Math.pow(2,e*r);return t}function Wa(n,e,t=-1){const r=t;let i=n,s=0,o=Math.pow(2,e);for(let a=1;a<8;a++){if(n<o){let l;if(r<0)l=new ArrayBuffer(a),s=a;else{if(r<a)return new ArrayBuffer(0);l=new ArrayBuffer(r),s=r}const c=new Uint8Array(l);for(let u=a-1;u>=0;u--){const d=Math.pow(2,u*e);c[s-u-1]=Math.floor(i/d),i-=c[s-u-1]*d}return l}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function F4(...n){let e=0,t=0;for(const s of n)e+=s.length;const r=new ArrayBuffer(e),i=new Uint8Array(r);for(const s of n)i.set(s,t),t+=s.length;return i}function Gk(){const n=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=n[0]===255&&n[1]&128,l=n[0]===0&&(n[1]&128)===0;(a||l)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=n[0]&128;const r=Fc(t,8),i=new ArrayBuffer(this.valueHex.byteLength),s=new Uint8Array(i);for(let a=0;a<this.valueHex.byteLength;a++)s[a]=n[a];return s[0]&=127,Fc(s,8)-r}function gz(n){const e=n<0?n*-1:n;let t=128;for(let r=1;r<8;r++){if(e<=t){if(n<0){const o=t-e,a=Wa(o,8,r),l=new Uint8Array(a);return l[0]|=128,a}let i=Wa(e,8,r),s=new Uint8Array(i);if(s[0]&128){const o=i.slice(0),a=new Uint8Array(o);i=new ArrayBuffer(i.byteLength+1),s=new Uint8Array(i);for(let l=0;l<o.byteLength;l++)s[l+1]=a[l];s[0]=0}return i}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function yz(n,e){if(n.byteLength!==e.byteLength)return!1;const t=new Uint8Array(n),r=new Uint8Array(e);for(let i=0;i<t.length;i++)if(t[i]!==r[i])return!1;return!0}function er(n,e){const t=n.toString(10);if(e<t.length)return"";const r=e-t.length,i=new Array(r);for(let o=0;o<r;o++)i[o]="0";return i.join("").concat(t)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function V0(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function K6(n){let e=0,t=0;for(let i=0;i<n.length;i++){const s=n[i];e+=s.byteLength}const r=new Uint8Array(e);for(let i=0;i<n.length;i++){const s=n[i];r.set(new Uint8Array(s),t),t+=s.byteLength}return r.buffer}function Ms(n,e,t,r){return e instanceof Uint8Array?e.byteLength?t<0?(n.error="Wrong parameter: inputOffset less than zero",!1):r<0?(n.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-r<0?(n.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(n.error="Wrong parameter: inputBuffer has zero length",!1):(n.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class W6{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return K6(this.items)}}const Xu=[new Uint8Array([1])],kw="0123456789",bu="",hi=new ArrayBuffer(0),G6=new Uint8Array(0),gh="EndOfContent",qk="OCTET STRING",jk="BIT STRING";function $s(n){var e;return e=class extends n{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(r){this.valueHexView=new Uint8Array(r)}constructor(...r){var i;super(...r);const s=r[0]||{};this.isHexOnly=(i=s.isHexOnly)!==null&&i!==void 0?i:!1,this.valueHexView=s.valueHex?Je.toUint8Array(s.valueHex):G6}fromBER(r,i,s){const o=r instanceof ArrayBuffer?new Uint8Array(r):r;if(!Ms(this,o,i,s))return-1;const a=i+s;return this.valueHexView=o.subarray(i,a),this.valueHexView.length?(this.blockLength=s,a):(this.warnings.push("Zero buffer length"),i)}toBER(r=!1){return this.isHexOnly?r?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",hi)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:St.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class Za{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=bu,warnings:r=[],valueBeforeDecode:i=G6}={}){this.blockLength=e,this.error=t,this.warnings=r,this.valueBeforeDecodeView=Je.toUint8Array(i)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:St.ToHex(this.valueBeforeDecodeView)}}}Za.NAME="baseBlock";class Qn extends Za{fromBER(e,t,r){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Qn.NAME="valueBlock";class Yk extends $s(Za){constructor({idBlock:e={}}={}){var t,r,i,s;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?Je.toUint8Array(e.valueHex):G6,this.tagClass=(r=e.tagClass)!==null&&r!==void 0?r:-1,this.tagNumber=(i=e.tagNumber)!==null&&i!==void 0?i:-1,this.isConstructed=(s=e.isConstructed)!==null&&s!==void 0?s:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",hi}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const i=new Uint8Array(1);if(!e){let s=this.tagNumber;s&=31,t|=s,i[0]=t}return i.buffer}if(!this.isHexOnly){const i=Wa(this.tagNumber,7),s=new Uint8Array(i),o=i.byteLength,a=new Uint8Array(o+1);if(a[0]=t|31,!e){for(let l=0;l<o-1;l++)a[l+1]=s[l]|128;a[o]=s[o-1]}return a.buffer}const r=new Uint8Array(this.valueHexView.byteLength+1);if(r[0]=t|31,!e){const i=this.valueHexView;for(let s=0;s<i.length-1;s++)r[s+1]=i[s]|128;r[this.valueHexView.byteLength]=i[i.length-1]}return r.buffer}fromBER(e,t,r){const i=Je.toUint8Array(e);if(!Ms(this,i,t,r))return-1;const s=i.subarray(t,t+r);if(s.length===0)return this.error="Zero buffer length",-1;switch(s[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(s[0]&32)===32,this.isHexOnly=!1;const a=s[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let l=1,c=this.valueHexView=new Uint8Array(255),u=255;for(;s[l]&128;){if(c[l-1]=s[l]&127,l++,l>=s.length)return this.error="End of input reached before message was fully decoded",-1;if(l===u){u+=255;const f=new Uint8Array(u);for(let p=0;p<c.length;p++)f[p]=c[p];c=this.valueHexView=new Uint8Array(u)}}this.blockLength=l+1,c[l-1]=s[l]&127;const d=new Uint8Array(l);for(let f=0;f<l;f++)d[f]=c[f];c=this.valueHexView=new Uint8Array(l),c.set(d),this.blockLength<=9?this.tagNumber=Fc(c,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}Yk.NAME="identificationBlock";class Qk extends Za{constructor({lenBlock:e={}}={}){var t,r,i;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(r=e.longFormUsed)!==null&&r!==void 0?r:!1,this.length=(i=e.length)!==null&&i!==void 0?i:0}fromBER(e,t,r){const i=Je.toUint8Array(e);if(!Ms(this,i,t,r))return-1;const s=i.subarray(t,t+r);if(s.length===0)return this.error="Zero buffer length",-1;if(s[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=s[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(s[0]&128),this.longFormUsed===!1)return this.length=s[0],this.blockLength=1,t+this.blockLength;const o=s[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>s.length)return this.error="End of input reached before message was fully decoded",-1;const a=t+1,l=i.subarray(a,a+o);return l[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=Fc(l,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,r;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(r=new Uint8Array(t),r[0]=128),t;if(this.longFormUsed){const i=Wa(this.length,8);if(i.byteLength>127)return this.error="Too big length",hi;if(t=new ArrayBuffer(i.byteLength+1),e)return t;const s=new Uint8Array(i);r=new Uint8Array(t),r[0]=i.byteLength|128;for(let o=0;o<i.byteLength;o++)r[o+1]=s[o];return t}return t=new ArrayBuffer(1),e===!1&&(r=new Uint8Array(t),r[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}Qk.NAME="lengthBlock";const ie={};class On extends Za{constructor({name:e=bu,optional:t=!1,primitiveSchema:r,...i}={},s){super(i),this.name=e,this.optional=t,r&&(this.primitiveSchema=r),this.idBlock=new Yk(i),this.lenBlock=new Qk(i),this.valueBlock=s?new s(i):new Qn(i)}fromBER(e,t,r){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}toBER(e,t){const r=t||new W6;t||Xk(this);const i=this.idBlock.toBER(e);if(r.write(i),this.lenBlock.isIndefiniteForm)r.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,r),r.write(new ArrayBuffer(2));else{const s=this.valueBlock.toBER(e);this.lenBlock.length=s.byteLength;const o=this.lenBlock.toBER(e);r.write(o),r.write(s)}return t?hi:r.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():St.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=St.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),r=e.toBER();return yz(t,r)}}On.NAME="BaseBlock";function Xk(n){var e;if(n instanceof ie.Constructed)for(const t of n.valueBlock.value)Xk(t)&&(n.lenBlock.isIndefiniteForm=!0);return!!(!((e=n.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class Jk extends On{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=bu,...t}={},r){super(t,r),e&&this.fromString(e)}fromBER(e,t,r){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}Jk.NAME="BaseStringBlock";class Zk extends $s(Qn){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}Zk.NAME="PrimitiveValueBlock";var eR;class tR extends On{constructor(e={}){super(e,Zk),this.idBlock.isConstructed=!1}}eR=tR;ie.Primitive=eR;tR.NAME="PRIMITIVE";function mz(n,e){if(n instanceof e)return n;const t=new e;return t.idBlock=n.idBlock,t.lenBlock=n.lenBlock,t.warnings=n.warnings,t.valueBeforeDecodeView=n.valueBeforeDecodeView,t}function gp(n,e=0,t=n.length){const r=e;let i=new On({},Qn);const s=new Za;if(!Ms(s,n,e,t))return i.error=s.error,{offset:-1,result:i};if(!n.subarray(e,e+t).length)return i.error="Zero buffer length",{offset:-1,result:i};let a=i.idBlock.fromBER(n,e,t);if(i.idBlock.warnings.length&&i.warnings.concat(i.idBlock.warnings),a===-1)return i.error=i.idBlock.error,{offset:-1,result:i};if(e=a,t-=i.idBlock.blockLength,a=i.lenBlock.fromBER(n,e,t),i.lenBlock.warnings.length&&i.warnings.concat(i.lenBlock.warnings),a===-1)return i.error=i.lenBlock.error,{offset:-1,result:i};if(e=a,t-=i.lenBlock.blockLength,!i.idBlock.isConstructed&&i.lenBlock.isIndefiniteForm)return i.error="Indefinite length form used for primitive encoding form",{offset:-1,result:i};let l=On;switch(i.idBlock.tagClass){case 1:if(i.idBlock.tagNumber>=37&&i.idBlock.isHexOnly===!1)return i.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:i};switch(i.idBlock.tagNumber){case 0:if(i.idBlock.isConstructed&&i.lenBlock.length>0)return i.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:i};l=ie.EndOfContent;break;case 1:l=ie.Boolean;break;case 2:l=ie.Integer;break;case 3:l=ie.BitString;break;case 4:l=ie.OctetString;break;case 5:l=ie.Null;break;case 6:l=ie.ObjectIdentifier;break;case 10:l=ie.Enumerated;break;case 12:l=ie.Utf8String;break;case 13:l=ie.RelativeObjectIdentifier;break;case 14:l=ie.TIME;break;case 15:return i.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:i};case 16:l=ie.Sequence;break;case 17:l=ie.Set;break;case 18:l=ie.NumericString;break;case 19:l=ie.PrintableString;break;case 20:l=ie.TeletexString;break;case 21:l=ie.VideotexString;break;case 22:l=ie.IA5String;break;case 23:l=ie.UTCTime;break;case 24:l=ie.GeneralizedTime;break;case 25:l=ie.GraphicString;break;case 26:l=ie.VisibleString;break;case 27:l=ie.GeneralString;break;case 28:l=ie.UniversalString;break;case 29:l=ie.CharacterString;break;case 30:l=ie.BmpString;break;case 31:l=ie.DATE;break;case 32:l=ie.TimeOfDay;break;case 33:l=ie.DateTime;break;case 34:l=ie.Duration;break;default:{const c=i.idBlock.isConstructed?new ie.Constructed:new ie.Primitive;c.idBlock=i.idBlock,c.lenBlock=i.lenBlock,c.warnings=i.warnings,i=c}}break;case 2:case 3:case 4:default:l=i.idBlock.isConstructed?ie.Constructed:ie.Primitive}return i=mz(i,l),a=i.fromBER(n,e,i.lenBlock.isIndefiniteForm?t:i.lenBlock.length),i.valueBeforeDecodeView=n.subarray(r,r+i.blockLength),{offset:a,result:i}}function Cd(n){if(!n.byteLength){const e=new On({},Qn);return e.error="Input buffer has zero length",{offset:-1,result:e}}return gp(Je.toUint8Array(n).slice(),0,n.byteLength)}function wz(n,e){return n?1:e}class ko extends Qn{constructor({value:e=[],isIndefiniteForm:t=!1,...r}={}){super(r),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,r){const i=Je.toUint8Array(e);if(!Ms(this,i,t,r))return-1;if(this.valueBeforeDecodeView=i.subarray(t,t+r),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let s=t;for(;wz(this.isIndefiniteForm,r)>0;){const o=gp(i,s,r);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(s=o.offset,this.blockLength+=o.result.blockLength,r-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===gh)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===gh?this.value.pop():this.warnings.push("No EndOfContent block encoded")),s}toBER(e,t){const r=t||new W6;for(let i=0;i<this.value.length;i++)this.value[i].toBER(e,r);return t?hi:r.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}ko.NAME="ConstructedValueBlock";var nR;class _u extends On{constructor(e={}){super(e,ko),this.idBlock.isConstructed=!0}fromBER(e,t,r){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){const e=[];for(const r of this.valueBlock.value)e.push(r.toString("ascii").split(`
`).map(i=>`  ${i}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}nR=_u;ie.Constructed=nR;_u.NAME="CONSTRUCTED";class rR extends Qn{fromBER(e,t,r){return t}toBER(e){return hi}}rR.override="EndOfContentValueBlock";var iR;class sR extends On{constructor(e={}){super(e,rR),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}iR=sR;ie.EndOfContent=iR;sR.NAME=gh;var oR;class yh extends On{constructor(e={}){super(e,Qn),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,r){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=r,t+r>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+r}toBER(e,t){const r=new ArrayBuffer(2);if(!e){const i=new Uint8Array(r);i[0]=5,i[1]=0}return t&&t.write(r),r}onAsciiEncoding(){return`${this.constructor.NAME}`}}oR=yh;ie.Null=oR;yh.NAME="NULL";class aR extends $s(Qn){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=Je.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,r){const i=Je.toUint8Array(e);return Ms(this,i,t,r)?(this.valueHexView=i.subarray(t,t+r),r>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,Gk.call(this),this.blockLength=r,t+r):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}aR.NAME="BooleanValueBlock";var lR;let cR=class extends On{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,aR),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};lR=cR;ie.Boolean=lR;cR.NAME="BOOLEAN";class uR extends $s(ko){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,r){let i=0;if(this.isConstructed){if(this.isHexOnly=!1,i=ko.prototype.fromBER.call(this,e,t,r),i===-1)return i;for(let s=0;s<this.value.length;s++){const o=this.value[s].constructor.NAME;if(o===gh){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==qk)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,i=super.fromBER(e,t,r),this.blockLength=r;return i}toBER(e,t){return this.isConstructed?ko.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}uR.NAME="OctetStringValueBlock";var q6;class Pl extends On{constructor({idBlock:e={},lenBlock:t={},...r}={}){var i,s;(i=r.isConstructed)!==null&&i!==void 0||(r.isConstructed=!!(!((s=r.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},uR),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,r){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,r===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const s=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+r);try{if(s.byteLength){const o=gp(s,0,s.byteLength);o.offset!==-1&&o.offset===r&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return _u.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=St.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof q6&&e.push(t.valueBlock.valueHexView);return Je.concat(e)}}q6=Pl;ie.OctetString=q6;Pl.NAME=qk;class dR extends $s(ko){constructor({unusedBits:e=0,isConstructed:t=!1,...r}={}){super(r),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,r){if(!r)return t;let i=-1;if(this.isConstructed){if(i=ko.prototype.fromBER.call(this,e,t,r),i===-1)return i;for(const a of this.value){const l=a.constructor.NAME;if(l===gh){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(l!==jk)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const c=a.valueBlock;if(this.unusedBits>0&&c.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=c.unusedBits}return i}const s=Je.toUint8Array(e);if(!Ms(this,s,t,r))return-1;const o=s.subarray(t,t+r);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const l=gp(a,0,a.byteLength);l.offset!==-1&&l.offset===r-1&&(this.value=[l.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+r}toBER(e,t){if(this.isConstructed)return ko.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return hi;const r=new Uint8Array(this.valueHexView.length+1);return r[0]=this.unusedBits,r.set(this.valueHexView,1),r.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}dR.NAME="BitStringValueBlock";var hR;class j6 extends On{constructor({idBlock:e={},lenBlock:t={},...r}={}){var i,s;(i=r.isConstructed)!==null&&i!==void 0||(r.isConstructed=!!(!((s=r.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},dR),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,r){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return _u.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const r=e.join(""),i=this.constructor.NAME,s=r.substring(0,r.length-this.valueBlock.unusedBits);return`${i} : ${s}`}}}hR=j6;ie.BitString=hR;j6.NAME=jk;var fR;function vz(n,e){const t=new Uint8Array([0]),r=new Uint8Array(n),i=new Uint8Array(e);let s=r.slice(0);const o=s.length-1,a=i.slice(0),l=a.length-1;let c=0;const u=l<o?o:l;let d=0;for(let f=u;f>=0;f--,d++){switch(!0){case d<a.length:c=s[o-d]+a[l-d]+t[0];break;default:c=s[o-d]+t[0]}switch(t[0]=c/10,!0){case d>=s.length:s=F4(new Uint8Array([c%10]),s);break;default:s[o-d]=c%10}}return t[0]>0&&(s=F4(t,s)),s}function Rw(n){if(n>=Xu.length)for(let e=Xu.length;e<=n;e++){const t=new Uint8Array([0]);let r=Xu[e-1].slice(0);for(let i=r.length-1;i>=0;i--){const s=new Uint8Array([(r[i]<<1)+t[0]]);t[0]=s[0]/10,r[i]=s[0]%10}t[0]>0&&(r=F4(t,r)),Xu.push(r)}return Xu[n]}function Ez(n,e){let t=0;const r=new Uint8Array(n),i=new Uint8Array(e),s=r.slice(0),o=s.length-1,a=i.slice(0),l=a.length-1;let c,u=0;for(let d=l;d>=0;d--,u++)switch(c=s[o-u]-a[l-u]-t,!0){case c<0:t=1,s[o-u]=c+10;break;default:t=0,s[o-u]=c}if(t>0)for(let d=o-l+1;d>=0;d--,u++)if(c=s[o-u]-t,c<0)t=1,s[o-u]=c+10;else{t=0,s[o-u]=c;break}return s.slice()}class Y6 extends $s(Qn){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=Gk.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(gz(e))}get valueDec(){return this._valueDec}fromDER(e,t,r,i=0){const s=this.fromBER(e,t,r);if(s===-1)return s;const o=this.valueHexView;return o[0]===0&&o[1]&128?this.valueHexView=o.subarray(1):i!==0&&o.length<i&&(i-o.length>1&&(i=o.length+1),this.valueHexView=o.subarray(i-o.length)),s}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const r=new Uint8Array(this.valueHexView.length+1);r[0]=0,r.set(t,1),this.valueHexView=r}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,r){const i=super.fromBER(e,t,r);return i===-1||this.setValueHex(),i}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),r=0,i;const s=this.valueHexView;let o="",a=!1;for(let l=s.byteLength-1;l>=0;l--){i=s[l];for(let c=0;c<8;c++){if((i&1)===1)switch(r){case e:t=Ez(Rw(r),t),o="-";break;default:t=vz(t,Rw(r))}r++,i>>=1}}for(let l=0;l<t.length;l++)t[l]&&(a=!0),a&&(o+=kw.charAt(t[l]));return a===!1&&(o+=kw.charAt(0)),o}}fR=Y6;Y6.NAME="IntegerValueBlock";Object.defineProperty(fR.prototype,"valueHex",{set:function(n){this.valueHexView=new Uint8Array(n),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var Td;class Yt extends On{constructor(e={}){super(e,Y6),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return V0(),BigInt(this.valueBlock.toString())}static fromBigInt(e){V0();const t=BigInt(e),r=new W6,i=t.toString(16).replace(/^-/,""),s=new Uint8Array(St.FromHex(i));if(t<0){const a=new Uint8Array(s.length+(s[0]&128?1:0));a[0]|=128;const c=BigInt(`0x${St.ToHex(a)}`)+t,u=Je.toUint8Array(St.FromHex(c.toString(16)));u[0]|=128,r.write(u)}else s[0]&128&&r.write(new Uint8Array([0])),r.write(s);return new Td({valueHex:r.final()})}convertToDER(){const e=new Td({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new Td({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}Td=Yt;ie.Integer=Td;Yt.NAME="INTEGER";var pR;class gR extends Yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}pR=gR;ie.Enumerated=pR;gR.NAME="ENUMERATED";class z4 extends $s(Qn){constructor({valueDec:e=-1,isFirstSid:t=!1,...r}={}){super(r),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,r){if(!r)return t;const i=Je.toUint8Array(e);if(!Ms(this,i,t,r))return-1;const s=i.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=s[a]&127,this.blockLength++,!!(s[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,s[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Fc(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){V0();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const r=new Uint8Array(t.length/7);for(let i=0;i<r.length;i++)r[i]=parseInt(t.slice(i*7,i*7+7),2)+(i+1<r.length?128:0);this.fromBER(r.buffer,0,r.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=Wa(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",hi;const r=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)r[o]=i[o]|128;r[s]=i[s]}return r}toString(){let e="";if(this.isHexOnly)e=St.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}z4.NAME="sidBlock";class yR extends Qn{constructor({value:e=bu,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let i=t;for(;r>0;){const s=new z4;if(i=s.fromBER(e,i,r),i===-1)return this.blockLength=0,this.error=s.error,i;this.value.length===0&&(s.isFirstSid=!0),this.blockLength+=s.blockLength,r-=s.blockLength,this.value.push(s)}return i}toBER(e){const t=[];for(let r=0;r<this.value.length;r++){const i=this.value[r].toBER(e);if(i.byteLength===0)return this.error=this.value[r].error,hi;t.push(i)}return K6(t)}fromString(e){this.value=[];let t=0,r=0,i="",s=!1;do if(r=e.indexOf(".",t),r===-1?i=e.substring(t):i=e.substring(t,r),t=r+1,s){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const l=parseInt(i,10);if(isNaN(l))return;o.valueDec=l+a,s=!1}else{const o=new z4;if(i>Number.MAX_SAFE_INTEGER){V0();const a=BigInt(i);o.valueBigInt=a}else if(o.valueDec=parseInt(i,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,s=!0),this.value.push(o)}while(r!==-1)}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let i=this.value[r].toString();r!==0&&(e=`${e}.`),t?(i=`{${i}}`,this.value[r].isFirstSid?e=`2.{${i} - 80}`:e+=i):e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}yR.NAME="ObjectIdentifierValueBlock";var mR;class oo extends On{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,yR),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}mR=oo;ie.ObjectIdentifier=mR;oo.NAME="OBJECT IDENTIFIER";class V4 extends $s(Za){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,r){if(r===0)return t;const i=Je.toUint8Array(e);if(!Ms(this,i,t,r))return-1;const s=i.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=s[a]&127,this.blockLength++,!!(s[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,s[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Fc(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=Wa(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",hi;const r=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)r[o]=i[o]|128;r[s]=i[s]}return r.buffer}toString(){let e="";return this.isHexOnly?e=St.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}V4.NAME="relativeSidBlock";class wR extends Qn{constructor({value:e=bu,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let i=t;for(;r>0;){const s=new V4;if(i=s.fromBER(e,i,r),i===-1)return this.blockLength=0,this.error=s.error,i;this.blockLength+=s.blockLength,r-=s.blockLength,this.value.push(s)}return i}toBER(e,t){const r=[];for(let i=0;i<this.value.length;i++){const s=this.value[i].toBER(e);if(s.byteLength===0)return this.error=this.value[i].error,hi;r.push(s)}return K6(r)}fromString(e){this.value=[];let t=0,r=0,i="";do{r=e.indexOf(".",t),r===-1?i=e.substring(t):i=e.substring(t,r),t=r+1;const s=new V4;if(s.valueDec=parseInt(i,10),isNaN(s.valueDec))return!0;this.value.push(s)}while(r!==-1);return!0}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let i=this.value[r].toString();r!==0&&(e=`${e}.`),t&&(i=`{${i}}`),e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}wR.NAME="RelativeObjectIdentifierValueBlock";var vR;class ER extends On{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,wR),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}vR=ER;ie.RelativeObjectIdentifier=vR;ER.NAME="RelativeObjectIdentifier";var bR;class In extends _u{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}bR=In;ie.Sequence=bR;In.NAME="SEQUENCE";var _R;let SR=class extends _u{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};_R=SR;ie.Set=_R;SR.NAME="SET";class xR extends $s(Qn){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=bu}toJSON(){return{...super.toJSON(),value:this.value}}}xR.NAME="StringValueBlock";class kR extends xR{}kR.NAME="SimpleStringValueBlock";class gr extends Jk{constructor({...e}={}){super(e,kR)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,Je.toUint8Array(e))}fromString(e){const t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(t);for(let i=0;i<t;i++)r[i]=e.charCodeAt(i);this.valueBlock.value=e}}gr.NAME="SIMPLE STRING";class RR extends gr{fromBuffer(e){this.valueBlock.valueHexView=Je.toUint8Array(e);try{this.valueBlock.value=St.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=St.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(St.FromUtf8String(e)),this.valueBlock.value=e}}RR.NAME="Utf8StringValueBlock";var AR;class el extends RR{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}AR=el;ie.Utf8String=AR;el.NAME="UTF8String";class IR extends gr{fromBuffer(e){this.valueBlock.value=St.ToUtf16String(e),this.valueBlock.valueHexView=Je.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(St.FromUtf16String(e))}}IR.NAME="BmpStringValueBlock";var CR;class TR extends IR{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}CR=TR;ie.BmpString=CR;TR.NAME="BMPString";class NR extends gr{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),r=new Uint8Array(t);for(let i=0;i<r.length;i+=4)r[i]=r[i+3],r[i+1]=r[i+2],r[i+2]=0,r[i+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let i=0;i<t;i++){const s=Wa(e.charCodeAt(i),8),o=new Uint8Array(s);if(o.length>4)continue;const a=4-o.length;for(let l=o.length-1;l>=0;l--)r[i*4+l+a]=o[l]}this.valueBlock.value=e}}NR.NAME="UniversalStringValueBlock";var DR;class PR extends NR{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}DR=PR;ie.UniversalString=DR;PR.NAME="UniversalString";var OR;class LR extends gr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}OR=LR;ie.NumericString=OR;LR.NAME="NumericString";var BR;class MR extends gr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}BR=MR;ie.PrintableString=BR;MR.NAME="PrintableString";var $R;class UR extends gr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}$R=UR;ie.TeletexString=$R;UR.NAME="TeletexString";var FR;class zR extends gr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}FR=zR;ie.VideotexString=FR;zR.NAME="VideotexString";var VR;class HR extends gr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}VR=HR;ie.IA5String=VR;HR.NAME="IA5String";var KR;class WR extends gr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}KR=WR;ie.GraphicString=KR;WR.NAME="GraphicString";var GR;class Q6 extends gr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}GR=Q6;ie.VisibleString=GR;Q6.NAME="VisibleString";var qR;class jR extends gr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}qR=jR;ie.GeneralString=qR;jR.NAME="GeneralString";var YR;class QR extends gr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}YR=QR;ie.CharacterString=YR;QR.NAME="CharacterString";var XR;class X6 extends Q6{constructor({value:e,valueDate:t,...r}={}){if(super(r),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let i=0;i<e.length;i++)this.valueBlock.valueHexView[i]=e.charCodeAt(i)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,Je.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),r=new Uint8Array(t);for(let i=0;i<e.length;i++)r[i]=e.charCodeAt(i);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const r=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(r===null){this.error="Wrong input string for conversion";return}const i=parseInt(r[1],10);i>=50?this.year=1900+i:this.year=2e3+i,this.month=parseInt(r[2],10),this.day=parseInt(r[3],10),this.hour=parseInt(r[4],10),this.minute=parseInt(r[5],10),this.second=parseInt(r[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=er(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=er(this.month,2),t[2]=er(this.day,2),t[3]=er(this.hour,2),t[4]=er(this.minute,2),t[5]=er(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}XR=X6;ie.UTCTime=XR;X6.NAME="UTCTime";var JR;class ZR extends X6{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,r="",i="",s=0,o,a=0,l=0;if(e[e.length-1]==="Z")r=e.substring(0,e.length-1),t=!0;else{const d=new Number(e[e.length-1]);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");r=e}if(t){if(r.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(r.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let d=1,f=r.indexOf("+"),p="";if(f===-1&&(f=r.indexOf("-"),d=-1),f!==-1){if(p=r.substring(f+1),r=r.substring(0,f),p.length!==2&&p.length!==4)throw new Error("Wrong input string for conversion");let y=parseInt(p.substring(0,2),10);if(isNaN(y.valueOf()))throw new Error("Wrong input string for conversion");if(a=d*y,p.length===4){if(y=parseInt(p.substring(2,4),10),isNaN(y.valueOf()))throw new Error("Wrong input string for conversion");l=d*y}}}let c=r.indexOf(".");if(c===-1&&(c=r.indexOf(",")),c!==-1){const d=new Number(`0${r.substring(c)}`);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");s=d.valueOf(),i=r.substring(0,c)}else i=r;switch(!0){case i.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,c!==-1)throw new Error("Wrong input string for conversion");break;case i.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,c!==-1){let d=60*s;this.minute=Math.floor(d),d=60*(d-this.minute),this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case i.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,c!==-1){let d=60*s;this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case i.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,c!==-1){const d=1e3*s;this.millisecond=Math.floor(d)}break;default:throw new Error("Wrong input string for conversion")}const u=o.exec(i);if(u===null)throw new Error("Wrong input string for conversion");for(let d=1;d<u.length;d++)switch(d){case 1:this.year=parseInt(u[d],10);break;case 2:this.month=parseInt(u[d],10);break;case 3:this.day=parseInt(u[d],10);break;case 4:this.hour=parseInt(u[d],10)+a;break;case 5:this.minute=parseInt(u[d],10)+l;break;case 6:this.second=parseInt(u[d],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const d=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=d.getUTCFullYear(),this.month=d.getUTCMonth(),this.day=d.getUTCDay(),this.hour=d.getUTCHours(),this.minute=d.getUTCMinutes(),this.second=d.getUTCSeconds(),this.millisecond=d.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(er(this.year,4)),t.push(er(this.month,2)),t.push(er(this.day,2)),t.push(er(this.hour,2)),t.push(er(this.minute,2)),t.push(er(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(er(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}JR=ZR;ie.GeneralizedTime=JR;ZR.NAME="GeneralizedTime";var eA;class tA extends el{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}eA=tA;ie.DATE=eA;tA.NAME="DATE";var nA;class rA extends el{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}nA=rA;ie.TimeOfDay=nA;rA.NAME="TimeOfDay";var iA;class sA extends el{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}iA=sA;ie.DateTime=iA;sA.NAME="DateTime";var oA;class aA extends el{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}oA=aA;ie.Duration=oA;aA.NAME="Duration";var lA;class cA extends el{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}lA=cA;ie.TIME=lA;cA.NAME="TIME";function bz(n){const{result:e}=Cd(n),t=e.valueBlock.value;return{n:ne(bi(t[1].toBigInt()),"base64url"),e:ne(bi(t[2].toBigInt()),"base64url"),d:ne(bi(t[3].toBigInt()),"base64url"),p:ne(bi(t[4].toBigInt()),"base64url"),q:ne(bi(t[5].toBigInt()),"base64url"),dp:ne(bi(t[6].toBigInt()),"base64url"),dq:ne(bi(t[7].toBigInt()),"base64url"),qi:ne(bi(t[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function _z(n){if(n.n==null||n.e==null||n.d==null||n.p==null||n.q==null||n.dp==null||n.dq==null||n.qi==null)throw new S("JWK was missing components","ERR_INVALID_PARAMETERS");const t=new In({value:[new Yt({value:0}),Yt.fromBigInt(_i(Y(n.n,"base64url"))),Yt.fromBigInt(_i(Y(n.e,"base64url"))),Yt.fromBigInt(_i(Y(n.d,"base64url"))),Yt.fromBigInt(_i(Y(n.p,"base64url"))),Yt.fromBigInt(_i(Y(n.q,"base64url"))),Yt.fromBigInt(_i(Y(n.dp,"base64url"))),Yt.fromBigInt(_i(Y(n.dq,"base64url"))),Yt.fromBigInt(_i(Y(n.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}function Sz(n){const{result:e}=Cd(n),t=e.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:ne(bi(t[0].toBigInt()),"base64url"),e:ne(bi(t[1].toBigInt()),"base64url")}}function xz(n){if(n.n==null||n.e==null)throw new S("JWK was missing components","ERR_INVALID_PARAMETERS");const t=new In({value:[new In({value:[new oo({value:"1.2.840.113549.1.1.1"}),new yh]}),new j6({valueHex:new In({value:[Yt.fromBigInt(_i(Y(n.n,"base64url"))),Yt.fromBigInt(_i(Y(n.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}function bi(n){let e=n.toString(16);e.length%2>0&&(e=`0${e}`);const t=e.length/2,r=new Uint8Array(t);let i=0,s=0;for(;i<t;)r[i]=parseInt(e.slice(s,s+2),16),i+=1,s+=2;return r}function _i(n){const e=[];return n.forEach(function(t){let r=t.toString(16);r.length%2>0&&(r=`0${r}`),e.push(r)}),BigInt("0x"+e.join(""))}const kz=16,H4=32,K4=1e4;async function Rz(n,e){const t=Mr.get(),i=new In({value:[new Yt({value:0}),new In({value:[new oo({value:"1.2.840.113549.1.1.1"}),new yh]}),new Pl({valueHex:n.marshal()})]}).toBER(),s=new Uint8Array(i,0,i.byteLength),o=Yi(kz),a=await Wk(H6,e,o,{c:K4,dkLen:H4}),l=Yi(16),c=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:l},c,s),d=new In({value:[new Pl({valueHex:o}),new Yt({value:K4}),new Yt({value:H4}),new In({value:[new oo({value:"1.2.840.113549.2.11"}),new yh]})]}),f=new In({value:[new oo({value:"1.2.840.113549.1.5.13"}),new In({value:[new In({value:[new oo({value:"1.2.840.113549.1.5.12"}),d]}),new In({value:[new oo({value:"2.16.840.1.101.3.4.1.42"}),new Pl({valueHex:l})]})]})]}),y=new In({value:[f,new Pl({valueHex:u})]}).toBER(),g=new Uint8Array(y,0,y.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...ne(g,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function Az(n,e){const t=Mr.get();let r;if(n.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const i=Y(n.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=Cd(i),{iv:o,salt:a,iterations:l,keySize:c,cipherText:u}=Iz(s),d=await Wk(H6,e,a,{c:l,dkLen:c}),f=await t.subtle.importKey("raw",d,"AES-CBC",!1,["decrypt"]),p=Nd(await t.subtle.decrypt({name:"AES-CBC",iv:o},f,u)),{result:y}=Cd(p);r=Aw(y)}else if(n.includes("-----BEGIN PRIVATE KEY-----")){const i=Y(n.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=Cd(i);r=Aw(s)}else throw new S("Could not parse private key from PEM data","ERR_INVALID_PARAMETERS");return hA(r)}function Iz(n){const e=n.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new S("Only pkcs5PBES2 encrypted private keys are supported","ERR_INVALID_PARAMS");const r=e.valueBlock.value[1].valueBlock.value[0];if(r.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new S("Only pkcs5PBKDF2 key derivation functions are supported","ERR_INVALID_PARAMS");const s=r.valueBlock.value[1],o=Nd(s.valueBlock.value[0].getValue());let a=K4,l=H4;if(s.valueBlock.value.length===3)a=Number(s.valueBlock.value[1].toBigInt()),l=Number(s.valueBlock.value[2].toBigInt());else if(s.valueBlock.value.length===2)throw new S("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key","ERR_INVALID_PARAMS");const c=e.valueBlock.value[1].valueBlock.value[1],u=c.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new S("Only AES-CBC encryption schemes are supported","ERR_INVALID_PARAMS")}}}}const d=Nd(c.valueBlock.value[1].getValue());return{cipherText:Nd(n.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:l,iv:d}}function Aw(n){return Nd(n.valueBlock.value[2].getValue())}function Nd(n){return new Uint8Array(n,0,n.byteLength)}async function Cz(n){const e=await Mr.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:n,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await dA(e);return{privateKey:t[0],publicKey:t[1]}}async function uA(n){const t=[await Mr.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await Dz(n)],r=await dA({privateKey:t[0],publicKey:t[1]});return{privateKey:r[0],publicKey:r[1]}}async function Tz(n,e){const t=await Mr.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await Mr.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(r,0,r.byteLength)}async function Nz(n,e,t){const r=await Mr.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Mr.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,e,t instanceof Uint8Array?t:t.subarray())}async function dA(n){if(n.privateKey==null||n.publicKey==null)throw new S("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([Mr.get().subtle.exportKey("jwk",n.privateKey),Mr.get().subtle.exportKey("jwk",n.publicKey)])}async function Dz(n){return Mr.get().subtle.importKey("jwk",{kty:n.kty,n:n.n,e:n.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function J6(n){if(n.kty!=="RSA")throw new S("invalid key type","ERR_INVALID_KEY_TYPE");if(n.n==null)throw new S("invalid key modulus","ERR_INVALID_KEY_MODULUS");return Y(n.n,"base64url").length*8}const ef=8192;class Z6{constructor(e){h(this,"_key");this._key=e}verify(e,t){return Nz(this._key,t,e)}marshal(){return xz(this._key)}get bytes(){return Mc.encode({Type:Ot.RSA,Data:this.marshal()}).subarray()}equals(e){return Pe(this.bytes,e.bytes)}hash(){const e=nn.digest(this.bytes);return Go(e)?e.then(({bytes:t})=>t):e.bytes}}class yp{constructor(e,t){h(this,"_key");h(this,"_publicKey");this._key=e,this._publicKey=t}genSecret(){return Yi(16)}sign(e){return Tz(this._key,e)}get public(){if(this._publicKey==null)throw new S("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new Z6(this._publicKey)}marshal(){return _z(this._key)}get bytes(){return $c.encode({Type:Ot.RSA,Data:this.marshal()}).subarray()}equals(e){return Pe(this.bytes,e.bytes)}hash(){const e=nn.digest(this.bytes);return Go(e)?e.then(({bytes:t})=>t):e.bytes}async id(){const e=await this.public.hash();return ne(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8")return Rz(this,e);if(t==="libp2p-key")return z6(this.bytes,e);throw new S(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}async function hA(n){const e=bz(n);if(J6(e)>ef)throw new S("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await uA(e);return new yp(t.privateKey,t.publicKey)}function Pz(n){const e=Sz(n);if(J6(e)>ef)throw new S("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new Z6(e)}async function Oz(n){if(J6(n)>ef)throw new S("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const e=await uA(n);return new yp(e.privateKey,e.publicKey)}async function Lz(n){if(n>ef)throw new S("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const e=await Cz(n);return new yp(e.privateKey,e.publicKey)}const Bz=Object.freeze(Object.defineProperty({__proto__:null,MAX_RSA_KEY_SIZE:ef,RsaPrivateKey:yp,RsaPublicKey:Z6,fromJwk:Oz,generateKeyPair:Lz,unmarshalRsaPrivateKey:hA,unmarshalRsaPublicKey:Pz},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Iw=(n,e)=>(n+(n>=0?e:-e)/fA)/e;function Mz(n,e,t){const[[r,i],[s,o]]=e,a=Iw(o*n,t),l=Iw(-i*n,t);let c=n-a*r-l*s,u=-a*i-l*o;const d=c<vs,f=u<vs;d&&(c=-c),f&&(u=-u);const p=Jh(Math.ceil(vk(t)/2))+nc;if(c<vs||c>=p||u<vs||u>=p)throw new Error("splitScalar (endomorphism): failed, k="+n);return{k1neg:d,k1:c,k2neg:f,k2:u}}function W4(n){if(!["compact","recovered","der"].includes(n))throw new Error('Signature format must be "compact", "recovered", or "der"');return n}function Jg(n,e){const t={};for(let r of Object.keys(e))t[r]=n[r]===void 0?e[r]:n[r];return Ha(t.lowS,"lowS"),Ha(t.prehash,"prehash"),t.format!==void 0&&W4(t.format),t}class $z extends Error{constructor(e=""){super(e)}}const cs={Err:$z,_tlv:{encode:(n,e)=>{const{Err:t}=cs;if(n<0||n>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const r=e.length/2,i=Hf(r);if(i.length/2&128)throw new t("tlv.encode: long form length too big");const s=r>127?Hf(i.length/2|128):"";return Hf(n)+s+i+e},decode(n,e){const{Err:t}=cs;let r=0;if(n<0||n>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[r++]!==n)throw new t("tlv.decode: wrong tlv");const i=e[r++],s=!!(i&128);let o=0;if(!s)o=i;else{const l=i&127;if(!l)throw new t("tlv.decode(long): indefinite length not supported");if(l>4)throw new t("tlv.decode(long): byte length is too big");const c=e.subarray(r,r+l);if(c.length!==l)throw new t("tlv.decode: length bytes not complete");if(c[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const u of c)o=o<<8|u;if(r+=l,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(r,r+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(r+o)}}},_int:{encode(n){const{Err:e}=cs;if(n<vs)throw new e("integer: negative integers are not allowed");let t=Hf(n);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(n){const{Err:e}=cs;if(n[0]&128)throw new e("invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return pp(n)}},toSig(n){const{Err:e,_int:t,_tlv:r}=cs,i=ut("signature",n),{v:s,l:o}=r.decode(48,i);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l}=r.decode(2,s),{v:c,l:u}=r.decode(2,l);if(u.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(c)}},hexFromSig(n){const{_tlv:e,_int:t}=cs,r=e.encode(2,t.encode(n.r)),i=e.encode(2,t.encode(n.s)),s=r+i;return e.encode(48,s)}},vs=BigInt(0),nc=BigInt(1),fA=BigInt(2),Gf=BigInt(3),Uz=BigInt(4);function Ol(n,e){const{BYTES:t}=n;let r;if(typeof e=="bigint")r=e;else{let i=ut("private key",e);try{r=n.fromBytes(i)}catch{throw new Error(`invalid private key: expected ui8a of size ${t}, got ${typeof e}`)}}if(!n.isValidNot0(r))throw new Error("invalid private key: out of range [1..N-1]");return r}function Fz(n,e={}){const t=Lk("weierstrass",n,e),{Fp:r,Fn:i}=t;let s=t.CURVE;const{h:o,n:a}=s;Eu(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:l}=e;if(l&&(!r.is0(s.a)||typeof l.beta!="bigint"||!Array.isArray(l.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const c=gA(r,i);function u(){if(!r.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function d(z,R,C){const{x,y:M}=R.toAffine(),K=r.toBytes(x);if(Ha(C,"isCompressed"),C){u();const L=!r.isOdd(M);return Li(pA(L),K)}else return Li(Uint8Array.of(4),K,r.toBytes(M))}function f(z){ei(z,void 0,"Point");const{publicKey:R,publicKeyUncompressed:C}=c,x=z.length,M=z[0],K=z.subarray(1);if(x===R&&(M===2||M===3)){const L=r.fromBytes(K);if(!r.isValid(L))throw new Error("bad point: is not on curve, wrong x");const O=g(L);let H;try{H=r.sqrt(O)}catch(be){const Ee=be instanceof Error?": "+be.message:"";throw new Error("bad point: is not on curve, sqrt error"+Ee)}u();const G=r.isOdd(H);return(M&1)===1!==G&&(H=r.neg(H)),{x:L,y:H}}else if(x===C&&M===4){const L=r.BYTES,O=r.fromBytes(K.subarray(0,L)),H=r.fromBytes(K.subarray(L,L*2));if(!w(O,H))throw new Error("bad point: is not on curve");return{x:O,y:H}}else throw new Error(`bad point: got length ${x}, expected compressed=${R} or uncompressed=${C}`)}const p=e.toBytes||d,y=e.fromBytes||f;function g(z){const R=r.sqr(z),C=r.mul(R,z);return r.add(r.add(C,r.mul(z,s.a)),s.b)}function w(z,R){const C=r.sqr(R),x=g(z);return r.eql(C,x)}if(!w(s.Gx,s.Gy))throw new Error("bad curve params: generator point");const m=r.mul(r.pow(s.a,Gf),Uz),E=r.mul(r.sqr(s.b),BigInt(27));if(r.is0(r.add(m,E)))throw new Error("bad curve params: a or b");function v(z,R,C=!1){if(!r.isValid(R)||C&&r.is0(R))throw new Error(`bad point coordinate ${z}`);return R}function b(z){if(!(z instanceof _))throw new Error("ProjectivePoint expected")}function k(z){if(!l||!l.basises)throw new Error("no endo");return Mz(z,l.basises,i.ORDER)}const A=U0((z,R)=>{const{X:C,Y:x,Z:M}=z;if(r.eql(M,r.ONE))return{x:C,y:x};const K=z.is0();R==null&&(R=K?r.ONE:r.inv(M));const L=r.mul(C,R),O=r.mul(x,R),H=r.mul(M,R);if(K)return{x:r.ZERO,y:r.ZERO};if(!r.eql(H,r.ONE))throw new Error("invZ was invalid");return{x:L,y:O}}),T=U0(z=>{if(z.is0()){if(e.allowInfinityPoint&&!r.is0(z.Y))return;throw new Error("bad point: ZERO")}const{x:R,y:C}=z.toAffine();if(!r.isValid(R)||!r.isValid(C))throw new Error("bad point: x or y not field elements");if(!w(R,C))throw new Error("bad point: equation left != right");if(!z.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function P(z,R,C,x,M){return C=new _(r.mul(C.X,z),C.Y,C.Z),R=F0(x,R),C=F0(M,C),R.add(C)}class _{constructor(R,C,x){this.X=v("x",R),this.Y=v("y",C,!0),this.Z=v("z",x),Object.freeze(this)}static CURVE(){return s}static fromAffine(R){const{x:C,y:x}=R||{};if(!R||!r.isValid(C)||!r.isValid(x))throw new Error("invalid affine point");if(R instanceof _)throw new Error("projective point not allowed");return r.is0(C)&&r.is0(x)?_.ZERO:new _(C,x,r.ONE)}static fromBytes(R){const C=_.fromAffine(y(ei(R,void 0,"point")));return C.assertValidity(),C}static fromHex(R){return _.fromBytes(ut("pointHex",R))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(R=8,C=!0){return V.createCache(this,R),C||this.multiply(Gf),this}assertValidity(){T(this)}hasEvenY(){const{y:R}=this.toAffine();if(!r.isOdd)throw new Error("Field doesn't support isOdd");return!r.isOdd(R)}equals(R){b(R);const{X:C,Y:x,Z:M}=this,{X:K,Y:L,Z:O}=R,H=r.eql(r.mul(C,O),r.mul(K,M)),G=r.eql(r.mul(x,O),r.mul(L,M));return H&&G}negate(){return new _(this.X,r.neg(this.Y),this.Z)}double(){const{a:R,b:C}=s,x=r.mul(C,Gf),{X:M,Y:K,Z:L}=this;let O=r.ZERO,H=r.ZERO,G=r.ZERO,j=r.mul(M,M),be=r.mul(K,K),Ee=r.mul(L,L),pe=r.mul(M,K);return pe=r.add(pe,pe),G=r.mul(M,L),G=r.add(G,G),O=r.mul(R,G),H=r.mul(x,Ee),H=r.add(O,H),O=r.sub(be,H),H=r.add(be,H),H=r.mul(O,H),O=r.mul(pe,O),G=r.mul(x,G),Ee=r.mul(R,Ee),pe=r.sub(j,Ee),pe=r.mul(R,pe),pe=r.add(pe,G),G=r.add(j,j),j=r.add(G,j),j=r.add(j,Ee),j=r.mul(j,pe),H=r.add(H,j),Ee=r.mul(K,L),Ee=r.add(Ee,Ee),j=r.mul(Ee,pe),O=r.sub(O,j),G=r.mul(Ee,be),G=r.add(G,G),G=r.add(G,G),new _(O,H,G)}add(R){b(R);const{X:C,Y:x,Z:M}=this,{X:K,Y:L,Z:O}=R;let H=r.ZERO,G=r.ZERO,j=r.ZERO;const be=s.a,Ee=r.mul(s.b,Gf);let pe=r.mul(C,K),we=r.mul(x,L),Ie=r.mul(M,O),Ze=r.add(C,x),D=r.add(K,L);Ze=r.mul(Ze,D),D=r.add(pe,we),Ze=r.sub(Ze,D),D=r.add(C,M);let F=r.add(K,O);return D=r.mul(D,F),F=r.add(pe,Ie),D=r.sub(D,F),F=r.add(x,M),H=r.add(L,O),F=r.mul(F,H),H=r.add(we,Ie),F=r.sub(F,H),j=r.mul(be,D),H=r.mul(Ee,Ie),j=r.add(H,j),H=r.sub(we,j),j=r.add(we,j),G=r.mul(H,j),we=r.add(pe,pe),we=r.add(we,pe),Ie=r.mul(be,Ie),D=r.mul(Ee,D),we=r.add(we,Ie),Ie=r.sub(pe,Ie),Ie=r.mul(be,Ie),D=r.add(D,Ie),pe=r.mul(we,D),G=r.add(G,pe),pe=r.mul(F,D),H=r.mul(Ze,H),H=r.sub(H,pe),pe=r.mul(Ze,we),j=r.mul(F,j),j=r.add(j,pe),new _(H,G,j)}subtract(R){return this.add(R.negate())}is0(){return this.equals(_.ZERO)}multiply(R){const{endo:C}=e;if(!i.isValidNot0(R))throw new Error("invalid scalar: out of range");let x,M;const K=L=>V.cached(this,L,O=>ga(_,O));if(C){const{k1neg:L,k1:O,k2neg:H,k2:G}=k(R),{p:j,f:be}=K(O),{p:Ee,f:pe}=K(G);M=be.add(pe),x=P(C.beta,j,Ee,L,H)}else{const{p:L,f:O}=K(R);x=L,M=O}return ga(_,[x,M])[0]}multiplyUnsafe(R){const{endo:C}=e,x=this;if(!i.isValid(R))throw new Error("invalid scalar: out of range");if(R===vs||x.is0())return _.ZERO;if(R===nc)return x;if(V.hasCache(this))return this.multiply(R);if(C){const{k1neg:M,k1:K,k2neg:L,k2:O}=k(R),{p1:H,p2:G}=$F(_,x,K,O);return P(C.beta,H,G,M,L)}else return V.unsafe(x,R)}multiplyAndAddUnsafe(R,C,x){const M=this.multiplyUnsafe(C).add(R.multiplyUnsafe(x));return M.is0()?void 0:M}toAffine(R){return A(this,R)}isTorsionFree(){const{isTorsionFree:R}=e;return o===nc?!0:R?R(_,this):V.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:R}=e;return o===nc?this:R?R(_,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(R=!0){return Ha(R,"isCompressed"),this.assertValidity(),p(_,this,R)}toHex(R=!0){return Da(this.toBytes(R))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(R=!0){return this.toBytes(R)}_setWindowSize(R){this.precompute(R)}static normalizeZ(R){return ga(_,R)}static msm(R,C){return Ok(_,i,R,C)}static fromPrivateKey(R){return _.BASE.multiply(Ol(i,R))}}_.BASE=new _(s.Gx,s.Gy,r.ONE),_.ZERO=new _(r.ZERO,r.ONE,r.ZERO),_.Fp=r,_.Fn=i;const N=i.BITS,V=new Pk(_,e.endo?Math.ceil(N/2):N);return _.BASE.precompute(8),_}function pA(n){return Uint8Array.of(n?2:3)}function gA(n,e){return{secretKey:e.BYTES,publicKey:1+n.BYTES,publicKeyUncompressed:1+2*n.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function zz(n,e={}){const{Fn:t}=n,r=e.randomBytes||Xh,i=Object.assign(gA(n.Fp,t),{seed:Tk(t.ORDER)});function s(p){try{return!!Ol(t,p)}catch{return!1}}function o(p,y){const{publicKey:g,publicKeyUncompressed:w}=i;try{const m=p.length;return y===!0&&m!==g||y===!1&&m!==w?!1:!!n.fromBytes(p)}catch{return!1}}function a(p=r(i.seed)){return LF(ei(p,i.seed,"seed"),t.ORDER)}function l(p,y=!0){return n.BASE.multiply(Ol(t,p)).toBytes(y)}function c(p){const y=a(p);return{secretKey:y,publicKey:l(y)}}function u(p){if(typeof p=="bigint")return!1;if(p instanceof n)return!0;const{secretKey:y,publicKey:g,publicKeyUncompressed:w}=i;if(t.allowedLengths||y===g)return;const m=ut("key",p).length;return m===g||m===w}function d(p,y,g=!0){if(u(p)===!0)throw new Error("first arg must be private key");if(u(y)===!1)throw new Error("second arg must be public key");const w=Ol(t,p);return n.fromHex(y).multiply(w).toBytes(g)}return Object.freeze({getPublicKey:l,getSharedSecret:d,keygen:c,Point:n,utils:{isValidSecretKey:s,isValidPublicKey:o,randomSecretKey:a,isValidPrivateKey:s,randomPrivateKey:a,normPrivateKeyToScalar:p=>Ol(t,p),precompute(p=8,y=n.BASE){return y.precompute(p,!1)}},lengths:i})}function Vz(n,e,t={}){Qh(e),Eu(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const r=t.randomBytes||Xh,i=t.hmac||((C,...x)=>Zh(e,C,Li(...x))),{Fp:s,Fn:o}=n,{ORDER:a,BITS:l}=o,{keygen:c,getPublicKey:u,getSharedSecret:d,utils:f,lengths:p}=zz(n,t),y={prehash:!1,lowS:typeof t.lowS=="boolean"?t.lowS:!1,format:void 0,extraEntropy:!1},g="compact";function w(C){const x=a>>nc;return C>x}function m(C,x){if(!o.isValidNot0(x))throw new Error(`invalid signature ${C}: out of range 1..Point.Fn.ORDER`);return x}function E(C,x){W4(x);const M=p.signature,K=x==="compact"?M:x==="recovered"?M+1:void 0;return ei(C,K,`${x} signature`)}class v{constructor(x,M,K){this.r=m("r",x),this.s=m("s",M),K!=null&&(this.recovery=K),Object.freeze(this)}static fromBytes(x,M=g){E(x,M);let K;if(M==="der"){const{r:G,s:j}=cs.toSig(ei(x));return new v(G,j)}M==="recovered"&&(K=x[0],M="compact",x=x.subarray(1));const L=o.BYTES,O=x.subarray(0,L),H=x.subarray(L,L*2);return new v(o.fromBytes(O),o.fromBytes(H),K)}static fromHex(x,M){return this.fromBytes($0(x),M)}addRecoveryBit(x){return new v(this.r,this.s,x)}recoverPublicKey(x){const M=s.ORDER,{r:K,s:L,recovery:O}=this;if(O==null||![0,1,2,3].includes(O))throw new Error("recovery id invalid");if(a*fA<M&&O>1)throw new Error("recovery id is ambiguous for h>1 curve");const G=O===2||O===3?K+a:K;if(!s.isValid(G))throw new Error("recovery id 2 or 3 invalid");const j=s.toBytes(G),be=n.fromBytes(Li(pA((O&1)===0),j)),Ee=o.inv(G),pe=k(ut("msgHash",x)),we=o.create(-pe*Ee),Ie=o.create(L*Ee),Ze=n.BASE.multiplyUnsafe(we).add(be.multiplyUnsafe(Ie));if(Ze.is0())throw new Error("point at infinify");return Ze.assertValidity(),Ze}hasHighS(){return w(this.s)}toBytes(x=g){if(W4(x),x==="der")return $0(cs.hexFromSig(this));const M=o.toBytes(this.r),K=o.toBytes(this.s);if(x==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return Li(Uint8Array.of(this.recovery),M,K)}return Li(M,K)}toHex(x){return Da(this.toBytes(x))}assertValidity(){}static fromCompact(x){return v.fromBytes(ut("sig",x),"compact")}static fromDER(x){return v.fromBytes(ut("sig",x),"der")}normalizeS(){return this.hasHighS()?new v(this.r,o.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return Da(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return Da(this.toBytes("compact"))}}const b=t.bits2int||function(x){if(x.length>8192)throw new Error("input is too large");const M=pp(x),K=x.length*8-l;return K>0?M>>BigInt(K):M},k=t.bits2int_modN||function(x){return o.create(b(x))},A=Jh(l);function T(C){return dh("num < 2^"+l,C,vs,A),o.toBytes(C)}function P(C,x){return ei(C,void 0,"message"),x?ei(e(C),void 0,"prehashed message"):C}function _(C,x,M){if(["recovered","canonical"].some(we=>we in M))throw new Error("sign() legacy options not supported");const{lowS:K,prehash:L,extraEntropy:O}=Jg(M,y);C=P(C,L);const H=k(C),G=Ol(o,x),j=[T(G),T(H)];if(O!=null&&O!==!1){const we=O===!0?r(p.secretKey):O;j.push(ut("extraEntropy",we))}const be=Li(...j),Ee=H;function pe(we){const Ie=b(we);if(!o.isValidNot0(Ie))return;const Ze=o.inv(Ie),D=n.BASE.multiply(Ie).toAffine(),F=o.create(D.x);if(F===vs)return;const W=o.create(Ze*o.create(Ee+F*G));if(W===vs)return;let ve=(D.x===F?0:2)|Number(D.y&nc),de=W;return K&&w(W)&&(de=o.neg(W),ve^=1),new v(F,de,ve)}return{seed:be,k2sig:pe}}function N(C,x,M={}){C=ut("message",C);const{seed:K,k2sig:L}=_(C,x,M);return kF(e.outputLen,o.BYTES,i)(K,L)}function V(C){let x;const M=typeof C=="string"||Yh(C),K=!M&&C!==null&&typeof C=="object"&&typeof C.r=="bigint"&&typeof C.s=="bigint";if(!M&&!K)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(K)x=new v(C.r,C.s);else if(M){try{x=v.fromBytes(ut("sig",C),"der")}catch(L){if(!(L instanceof cs.Err))throw L}if(!x)try{x=v.fromBytes(ut("sig",C),"compact")}catch{return!1}}return x||!1}function z(C,x,M,K={}){const{lowS:L,prehash:O,format:H}=Jg(K,y);if(M=ut("publicKey",M),x=P(ut("message",x),O),"strict"in K)throw new Error("options.strict was renamed to lowS");const G=H===void 0?V(C):v.fromBytes(ut("sig",C),H);if(G===!1)return!1;try{const j=n.fromBytes(M);if(L&&G.hasHighS())return!1;const{r:be,s:Ee}=G,pe=k(x),we=o.inv(Ee),Ie=o.create(pe*we),Ze=o.create(be*we),D=n.BASE.multiplyUnsafe(Ie).add(j.multiplyUnsafe(Ze));return D.is0()?!1:o.create(D.x)===be}catch{return!1}}function R(C,x,M={}){const{prehash:K}=Jg(M,y);return x=P(x,K),v.fromBytes(C,"recovered").recoverPublicKey(x).toBytes()}return Object.freeze({keygen:c,getPublicKey:u,getSharedSecret:d,utils:f,lengths:p,Point:n,sign:N,verify:z,recoverPublicKey:R,Signature:v,hash:e})}function Hz(n){const e={a:n.a,b:n.b,p:n.Fp.ORDER,n:n.n,h:n.h,Gx:n.Gx,Gy:n.Gy},t=n.Fp;let r=n.allowedPrivateKeyLengths?Array.from(new Set(n.allowedPrivateKeyLengths.map(o=>Math.ceil(o/2)))):void 0;const i=Ja(e.n,{BITS:n.nBitLength,allowedLengths:r,modFromBytes:n.wrapPrivateKey}),s={Fp:t,Fn:i,allowInfinityPoint:n.allowInfinityPoint,endo:n.endo,isTorsionFree:n.isTorsionFree,clearCofactor:n.clearCofactor,fromBytes:n.fromBytes,toBytes:n.toBytes};return{CURVE:e,curveOpts:s}}function Kz(n){const{CURVE:e,curveOpts:t}=Hz(n),r={hmac:n.hmac,randomBytes:n.randomBytes,lowS:n.lowS,bits2int:n.bits2int,bits2int_modN:n.bits2int_modN};return{CURVE:e,curveOpts:t,hash:n.hash,ecdsaOpts:r}}function Wz(n,e){const t=e.Point;return Object.assign({},e,{ProjectivePoint:t,CURVE:Object.assign({},n,Ik(t.Fn.ORDER,t.Fn.BITS))})}function Gz(n){const{CURVE:e,curveOpts:t,hash:r,ecdsaOpts:i}=Kz(n),s=Fz(e,t),o=Vz(s,r,i);return Wz(n,o)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function qz(n,e){const t=r=>Gz({...n,hash:r});return{...t(e),create:t}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const e5={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},jz={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Cw=BigInt(2);function Yz(n){const e=e5.p,t=BigInt(3),r=BigInt(6),i=BigInt(11),s=BigInt(22),o=BigInt(23),a=BigInt(44),l=BigInt(88),c=n*n*n%e,u=c*c*n%e,d=pt(u,t,e)*u%e,f=pt(d,t,e)*u%e,p=pt(f,Cw,e)*c%e,y=pt(p,i,e)*p%e,g=pt(y,s,e)*y%e,w=pt(g,a,e)*g%e,m=pt(w,l,e)*w%e,E=pt(m,a,e)*g%e,v=pt(E,t,e)*u%e,b=pt(v,o,e)*y%e,k=pt(b,r,e)*c%e,A=pt(k,Cw,e);if(!G4.eql(G4.sqr(A),n))throw new Error("Cannot find square root");return A}const G4=Ja(e5.p,{sqrt:Yz}),Ns=qz({...e5,Fp:G4,lowS:!0,endo:jz},yk);function Qz(){return Ns.utils.randomPrivateKey()}function Xz(n,e){const t=nn.digest(e instanceof Uint8Array?e:e.subarray());if(Go(t))return t.then(({digest:r})=>Ns.sign(r,n).toDERRawBytes()).catch(r=>{throw new S(String(r),"ERR_INVALID_INPUT")});try{return Ns.sign(t.digest,n).toDERRawBytes()}catch(r){throw new S(String(r),"ERR_INVALID_INPUT")}}function Jz(n,e,t){const r=nn.digest(t instanceof Uint8Array?t:t.subarray());if(Go(r))return r.then(({digest:i})=>Ns.verify(e,i,n)).catch(i=>{throw new S(String(i),"ERR_INVALID_INPUT")});try{return Ns.verify(e,r.digest,n)}catch(i){throw new S(String(i),"ERR_INVALID_INPUT")}}function Zz(n){return Ns.ProjectivePoint.fromHex(n).toRawBytes(!0)}function eV(n){try{Ns.getPublicKey(n,!0)}catch(e){throw new S(String(e),"ERR_INVALID_PRIVATE_KEY")}}function yA(n){try{Ns.ProjectivePoint.fromHex(n)}catch(e){throw new S(String(e),"ERR_INVALID_PUBLIC_KEY")}}function tV(n){try{return Ns.getPublicKey(n,!0)}catch(e){throw new S(String(e),"ERR_INVALID_PRIVATE_KEY")}}class t5{constructor(e){h(this,"_key");yA(e),this._key=e}verify(e,t){return Jz(this._key,t,e)}marshal(){return Zz(this._key)}get bytes(){return Mc.encode({Type:Ot.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return Pe(this.bytes,e.bytes)}async hash(){const e=nn.digest(this.bytes);let t;return Go(e)?{bytes:t}=await e:t=e.bytes,t}}class n5{constructor(e,t){h(this,"_key");h(this,"_publicKey");this._key=e,this._publicKey=t??tV(e),eV(this._key),yA(this._publicKey)}sign(e){return Xz(this._key,e)}get public(){return new t5(this._publicKey)}marshal(){return this._key}get bytes(){return $c.encode({Type:Ot.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return Pe(this.bytes,e.bytes)}hash(){const e=nn.digest(this.bytes);return Go(e)?e.then(({bytes:t})=>t):e.bytes}async id(){const e=await this.public.hash();return ne(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return z6(this.bytes,e);throw new S(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function nV(n){return new n5(n)}function rV(n){return new t5(n)}async function iV(){const n=Qz();return new n5(n)}const sV=Object.freeze(Object.defineProperty({__proto__:null,Secp256k1PrivateKey:n5,Secp256k1PublicKey:t5,generateKeyPair:iV,unmarshalSecp256k1PrivateKey:nV,unmarshalSecp256k1PublicKey:rV},Symbol.toStringTag,{value:"Module"})),Ro={rsa:Bz,ed25519:lz,secp256k1:sV};function r5(n){const e=Object.keys(Ro).join(" / ");return new S(`invalid or unsupported key type ${n}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function i5(n){if(n=n.toLowerCase(),n==="rsa"||n==="ed25519"||n==="secp256k1")return Ro[n];throw r5(n)}async function mA(n,e){return i5(n).generateKeyPair(e??2048)}function mh(n){const e=Mc.decode(n),t=e.Data??new Uint8Array;switch(e.Type){case Ot.RSA:return Ro.rsa.unmarshalRsaPublicKey(t);case Ot.Ed25519:return Ro.ed25519.unmarshalEd25519PublicKey(t);case Ot.Secp256k1:return Ro.secp256k1.unmarshalSecp256k1PublicKey(t);default:throw r5(e.Type??"unknown")}}function wA(n,e){return e=(e??"rsa").toLowerCase(),i5(e),n.bytes}async function zc(n){const e=$c.decode(n),t=e.Data??new Uint8Array;switch(e.Type){case Ot.RSA:return Ro.rsa.unmarshalRsaPrivateKey(t);case Ot.Ed25519:return Ro.ed25519.unmarshalEd25519PrivateKey(t);case Ot.Secp256k1:return Ro.secp256k1.unmarshalSecp256k1PrivateKey(t);default:throw r5(e.Type??"RSA")}}function oV(n,e){return e=(e??"rsa").toLowerCase(),i5(e),n.bytes}async function qf(n,e){try{const t=await cz(n,e);return await zc(t)}catch{}if(!n.includes("BEGIN"))throw new S("Encrypted key was not a libp2p-key or a PEM file","ERR_INVALID_IMPORT_FORMAT");return Az(n,e)}const Ju=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),js=new Uint32Array(80);class aV extends L6{constructor(){super(64,20,8,!1),this.A=Ju[0]|0,this.B=Ju[1]|0,this.C=Ju[2]|0,this.D=Ju[3]|0,this.E=Ju[4]|0}get(){const{A:e,B:t,C:r,D:i,E:s}=this;return[e,t,r,i,s]}set(e,t,r,i,s){this.A=e|0,this.B=t|0,this.C=r|0,this.D=i|0,this.E=s|0}process(e,t){for(let l=0;l<16;l++,t+=4)js[l]=e.getUint32(t,!1);for(let l=16;l<80;l++)js[l]=Kg(js[l-3]^js[l-8]^js[l-14]^js[l-16],1);let{A:r,B:i,C:s,D:o,E:a}=this;for(let l=0;l<80;l++){let c,u;l<20?(c=fk(i,s,o),u=1518500249):l<40?(c=i^s^o,u=1859775393):l<60?(c=pk(i,s,o),u=2400959708):(c=i^s^o,u=3395469782);const d=Kg(r,5)+c+a+u+js[l]|0;a=o,o=s,s=Kg(i,30),i=r,r=d}r=r+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,this.set(r,i,s,o,a)}roundClean(){ji(js)}destroy(){this.set(0,0,0,0,0),ji(this.buffer)}}const lV=O6(()=>new aV),cV=lV,A1=yk,Tw={sha1:cV,"sha2-256":A1,"sha2-512":H6};function Nw(n,e,t,r,i){if(i!=="sha1"&&i!=="sha2-256"&&i!=="sha2-512"){const a=Object.keys(Tw).join(" / ");throw new S(`Hash '${i}' is unknown or not supported. Must be ${a}`,"ERR_UNSUPPORTED_HASH_TYPE")}const s=Tw[i],o=uz(s,n,e,{c:t,dkLen:r});return ar.encode(o).substring(1)}var q4={exports:{}};(function(n,e){(function(t,r){var i={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function s(g){if(!Array.isArray(g)&&!ArrayBuffer.isView(g))return!1;for(var w=0;w<g.length;w++)if(!Number.isInteger(g[w])||g[w]<0||g[w]>255)return!1;return!0}function o(g,w){return(g&65535)*w+(((g>>>16)*w&65535)<<16)}function a(g,w){return g<<w|g>>>32-w}function l(g){return g^=g>>>16,g=o(g,2246822507),g^=g>>>13,g=o(g,3266489909),g^=g>>>16,g}function c(g,w){g=[g[0]>>>16,g[0]&65535,g[1]>>>16,g[1]&65535],w=[w[0]>>>16,w[0]&65535,w[1]>>>16,w[1]&65535];var m=[0,0,0,0];return m[3]+=g[3]+w[3],m[2]+=m[3]>>>16,m[3]&=65535,m[2]+=g[2]+w[2],m[1]+=m[2]>>>16,m[2]&=65535,m[1]+=g[1]+w[1],m[0]+=m[1]>>>16,m[1]&=65535,m[0]+=g[0]+w[0],m[0]&=65535,[m[0]<<16|m[1],m[2]<<16|m[3]]}function u(g,w){g=[g[0]>>>16,g[0]&65535,g[1]>>>16,g[1]&65535],w=[w[0]>>>16,w[0]&65535,w[1]>>>16,w[1]&65535];var m=[0,0,0,0];return m[3]+=g[3]*w[3],m[2]+=m[3]>>>16,m[3]&=65535,m[2]+=g[2]*w[3],m[1]+=m[2]>>>16,m[2]&=65535,m[2]+=g[3]*w[2],m[1]+=m[2]>>>16,m[2]&=65535,m[1]+=g[1]*w[3],m[0]+=m[1]>>>16,m[1]&=65535,m[1]+=g[2]*w[2],m[0]+=m[1]>>>16,m[1]&=65535,m[1]+=g[3]*w[1],m[0]+=m[1]>>>16,m[1]&=65535,m[0]+=g[0]*w[3]+g[1]*w[2]+g[2]*w[1]+g[3]*w[0],m[0]&=65535,[m[0]<<16|m[1],m[2]<<16|m[3]]}function d(g,w){return w%=64,w===32?[g[1],g[0]]:w<32?[g[0]<<w|g[1]>>>32-w,g[1]<<w|g[0]>>>32-w]:(w-=32,[g[1]<<w|g[0]>>>32-w,g[0]<<w|g[1]>>>32-w])}function f(g,w){return w%=64,w===0?g:w<32?[g[0]<<w|g[1]>>>32-w,g[1]<<w]:[g[1]<<w-32,0]}function p(g,w){return[g[0]^w[0],g[1]^w[1]]}function y(g){return g=p(g,[0,g[0]>>>1]),g=u(g,[4283543511,3981806797]),g=p(g,[0,g[0]>>>1]),g=u(g,[3301882366,444984403]),g=p(g,[0,g[0]>>>1]),g}i.x86.hash32=function(g,w){if(i.inputValidation&&!s(g))return r;w=w||0;for(var m=g.length%4,E=g.length-m,v=w,b=0,k=3432918353,A=461845907,T=0;T<E;T=T+4)b=g[T]|g[T+1]<<8|g[T+2]<<16|g[T+3]<<24,b=o(b,k),b=a(b,15),b=o(b,A),v^=b,v=a(v,13),v=o(v,5)+3864292196;switch(b=0,m){case 3:b^=g[T+2]<<16;case 2:b^=g[T+1]<<8;case 1:b^=g[T],b=o(b,k),b=a(b,15),b=o(b,A),v^=b}return v^=g.length,v=l(v),v>>>0},i.x86.hash128=function(g,w){if(i.inputValidation&&!s(g))return r;w=w||0;for(var m=g.length%16,E=g.length-m,v=w,b=w,k=w,A=w,T=0,P=0,_=0,N=0,V=597399067,z=2869860233,R=951274213,C=2716044179,x=0;x<E;x=x+16)T=g[x]|g[x+1]<<8|g[x+2]<<16|g[x+3]<<24,P=g[x+4]|g[x+5]<<8|g[x+6]<<16|g[x+7]<<24,_=g[x+8]|g[x+9]<<8|g[x+10]<<16|g[x+11]<<24,N=g[x+12]|g[x+13]<<8|g[x+14]<<16|g[x+15]<<24,T=o(T,V),T=a(T,15),T=o(T,z),v^=T,v=a(v,19),v+=b,v=o(v,5)+1444728091,P=o(P,z),P=a(P,16),P=o(P,R),b^=P,b=a(b,17),b+=k,b=o(b,5)+197830471,_=o(_,R),_=a(_,17),_=o(_,C),k^=_,k=a(k,15),k+=A,k=o(k,5)+2530024501,N=o(N,C),N=a(N,18),N=o(N,V),A^=N,A=a(A,13),A+=v,A=o(A,5)+850148119;switch(T=0,P=0,_=0,N=0,m){case 15:N^=g[x+14]<<16;case 14:N^=g[x+13]<<8;case 13:N^=g[x+12],N=o(N,C),N=a(N,18),N=o(N,V),A^=N;case 12:_^=g[x+11]<<24;case 11:_^=g[x+10]<<16;case 10:_^=g[x+9]<<8;case 9:_^=g[x+8],_=o(_,R),_=a(_,17),_=o(_,C),k^=_;case 8:P^=g[x+7]<<24;case 7:P^=g[x+6]<<16;case 6:P^=g[x+5]<<8;case 5:P^=g[x+4],P=o(P,z),P=a(P,16),P=o(P,R),b^=P;case 4:T^=g[x+3]<<24;case 3:T^=g[x+2]<<16;case 2:T^=g[x+1]<<8;case 1:T^=g[x],T=o(T,V),T=a(T,15),T=o(T,z),v^=T}return v^=g.length,b^=g.length,k^=g.length,A^=g.length,v+=b,v+=k,v+=A,b+=v,k+=v,A+=v,v=l(v),b=l(b),k=l(k),A=l(A),v+=b,v+=k,v+=A,b+=v,k+=v,A+=v,("00000000"+(v>>>0).toString(16)).slice(-8)+("00000000"+(b>>>0).toString(16)).slice(-8)+("00000000"+(k>>>0).toString(16)).slice(-8)+("00000000"+(A>>>0).toString(16)).slice(-8)},i.x64.hash128=function(g,w){if(i.inputValidation&&!s(g))return r;w=w||0;for(var m=g.length%16,E=g.length-m,v=[0,w],b=[0,w],k=[0,0],A=[0,0],T=[2277735313,289559509],P=[1291169091,658871167],_=0;_<E;_=_+16)k=[g[_+4]|g[_+5]<<8|g[_+6]<<16|g[_+7]<<24,g[_]|g[_+1]<<8|g[_+2]<<16|g[_+3]<<24],A=[g[_+12]|g[_+13]<<8|g[_+14]<<16|g[_+15]<<24,g[_+8]|g[_+9]<<8|g[_+10]<<16|g[_+11]<<24],k=u(k,T),k=d(k,31),k=u(k,P),v=p(v,k),v=d(v,27),v=c(v,b),v=c(u(v,[0,5]),[0,1390208809]),A=u(A,P),A=d(A,33),A=u(A,T),b=p(b,A),b=d(b,31),b=c(b,v),b=c(u(b,[0,5]),[0,944331445]);switch(k=[0,0],A=[0,0],m){case 15:A=p(A,f([0,g[_+14]],48));case 14:A=p(A,f([0,g[_+13]],40));case 13:A=p(A,f([0,g[_+12]],32));case 12:A=p(A,f([0,g[_+11]],24));case 11:A=p(A,f([0,g[_+10]],16));case 10:A=p(A,f([0,g[_+9]],8));case 9:A=p(A,[0,g[_+8]]),A=u(A,P),A=d(A,33),A=u(A,T),b=p(b,A);case 8:k=p(k,f([0,g[_+7]],56));case 7:k=p(k,f([0,g[_+6]],48));case 6:k=p(k,f([0,g[_+5]],40));case 5:k=p(k,f([0,g[_+4]],32));case 4:k=p(k,f([0,g[_+3]],24));case 3:k=p(k,f([0,g[_+2]],16));case 2:k=p(k,f([0,g[_+1]],8));case 1:k=p(k,[0,g[_]]),k=u(k,T),k=d(k,31),k=u(k,P),v=p(v,k)}return v=p(v,[0,g.length]),b=p(b,[0,g.length]),v=c(v,b),b=c(b,v),v=y(v),b=y(b),v=c(v,b),b=c(b,v),("00000000"+(v[0]>>>0).toString(16)).slice(-8)+("00000000"+(v[1]>>>0).toString(16)).slice(-8)+("00000000"+(b[0]>>>0).toString(16)).slice(-8)+("00000000"+(b[1]>>>0).toString(16)).slice(-8)},n.exports&&(e=n.exports=i),e.murmurHash3=i})()})(q4,q4.exports);var uV=q4.exports,dV=uV;const wh=ci(dV),hV=Math.LN2*Math.LN2;let fV=class{constructor(e={}){h(this,"seeds");h(this,"bits");h(this,"buffer");e.seeds!=null?this.seeds=e.seeds:this.seeds=yV(e.hashes??8),this.bits=e.bits??1024,this.buffer=Xe(Math.ceil(this.bits/8))}add(e){typeof e=="string"&&(e=Y(e));for(let t=0;t<this.seeds.length;t++){const i=wh.x86.hash32(e,this.seeds[t])%this.bits;this.setbit(i)}}has(e){typeof e=="string"&&(e=Y(e));for(let t=0;t<this.seeds.length;t++){const i=wh.x86.hash32(e,this.seeds[t])%this.bits;if(!this.getbit(i))return!1}return!0}clear(){this.buffer.fill(0)}setbit(e){let t=0,r=e;for(;r>7;)t++,r-=8;let i=this.buffer[t];i|=1<<r,this.buffer[t]=i}getbit(e){let t=0,r=e;for(;r>7;)t++,r-=8;return(this.buffer[t]&1<<r)!==0}};function pV(n,e=.005){const t=gV(n,e);return new fV(t)}function gV(n,e=.005){const t=Math.round(-1*n*Math.log(e)/hV),r=Math.round(t/n*Math.LN2);return{bits:t,hashes:r}}function yV(n){let e,t;const r=[];for(let i=0;i<n;i++)for(e=new Fe(Yi(4)),r[i]=e.getUint32(0,!0),t=0;t<i;t++)if(r[i]===r[t]){i--;break}return r}const vA=64;let ya=class{constructor(e,t,r,i=2){h(this,"fp");h(this,"h");h(this,"seed");if(i>vA)throw new TypeError("Invalid Fingerprint Size");const s=t.hashV(e,r),o=Xe(i);for(let a=0;a<o.length;a++)o[a]=s[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=r}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return(e==null?void 0:e.fp)instanceof Uint8Array?Pe(this.fp,e.fp):!1}};function H0(n,e){return Math.floor(Math.random()*(e-n))+n}let jf=class{constructor(e){h(this,"contents");this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof ya))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof ya))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof ya))throw new TypeError("Invalid Fingerprint");const t=H0(0,this.contents.length-1),r=this.contents[t];return this.contents[t]=e,r}remove(e){if(!(e instanceof ya))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(r=>e.equals(r));return t>-1?(this.contents[t]=null,!0):!1}};const s5={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},EA={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},bA=new globalThis.TextEncoder;function mV(n,e){const t=s5[e];let r=EA[e];for(let i=0;i<n.length;i++)r^=BigInt(n[i]),r=BigInt.asUintN(e,r*t);return r}function wV(n,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=s5[e];let i=EA[e],s=n;for(;s.length>0;){const o=bA.encodeInto(s,t);s=s.slice(o.read);for(let a=0;a<o.written;a++)i^=BigInt(t[a]),i=BigInt.asUintN(e,i*r)}return i}function _A(n,{size:e=32,utf8Buffer:t}={}){if(!s5[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof n=="string"){if(t)return wV(n,e,t);n=bA.encode(n)}return mV(n,e)}const o5={hash:n=>Number(_A(n,{size:32})),hashV:(n,e)=>vV(o5.hash(n,e))};function vV(n){let e=n.toString(16);return e.length%2===1&&(e=`0${e}`),Y(e,"base16")}const EV=500;let Dw=class{constructor(e){h(this,"bucketSize");h(this,"filterSize");h(this,"fingerprintSize");h(this,"buckets");h(this,"count");h(this,"hash");h(this,"seed");this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??o5,this.seed=e.seed??H0(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=Y(e));const t=new ya(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=(r^t.hash())%this.filterSize;if(this.buckets[r]==null&&(this.buckets[r]=new jf(this.bucketSize)),this.buckets[i]==null&&(this.buckets[i]=new jf(this.bucketSize)),this.buckets[r].add(t)||this.buckets[i].add(t))return this.count++,!0;const s=[r,i];let o=s[H0(0,s.length-1)];this.buckets[o]==null&&(this.buckets[o]=new jf(this.bucketSize));for(let a=0;a<EV;a++){const l=this.buckets[o].swap(t);if(l!=null&&(o=(o^l.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new jf(this.bucketSize)),this.buckets[o].add(l)))return this.count++,!0}return!1}has(e){var o,a;typeof e=="string"&&(e=Y(e));const t=new ya(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=((o=this.buckets[r])==null?void 0:o.has(t))??!1;if(i)return i;const s=(r^t.hash())%this.filterSize;return((a=this.buckets[s])==null?void 0:a.has(t))??!1}remove(e){var a,l;typeof e=="string"&&(e=Y(e));const t=new ya(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=((a=this.buckets[r])==null?void 0:a.remove(t))??!1;if(i)return this.count--,i;const s=(r^t.hash())%this.filterSize,o=((l=this.buckets[s])==null?void 0:l.remove(t))??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}};const bV={1:.5,2:.84,4:.95,8:.98};function _V(n=.001){return n>.002?2:n>1e-5?4:8}function SV(n,e=.001){const t=_V(e),r=bV[t],i=Math.round(n/r),s=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),vA);return{filterSize:i,bucketSize:t,fingerprintSize:s}}let xV=class{constructor(e){h(this,"filterSize");h(this,"bucketSize");h(this,"fingerprintSize");h(this,"scale");h(this,"filterSeries");h(this,"hash");h(this,"seed");this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??o5,this.seed=e.seed??H0(0,Math.pow(2,10)),this.filterSeries=[new Dw({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=Y(e)),this.has(e))return!0;let t=this.filterSeries.find(r=>r.reliable);if(t==null){const r=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Dw({filterSize:r,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=Y(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=Y(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}};function SA(n,e=.001,t){return new xV({...SV(n,e)})}class kV{constructor(e,t){h(this,"filter");this.filter=SA(e,t)}has(e){return this.filter.has(e.toBytes())}add(e){this.filter.add(e.toBytes())}remove(e){var t,r;(r=(t=this.filter).remove)==null||r.call(t,e.toBytes())}}function RV(n,e=.001){return new kV(n,e)}class AV extends Ls{constructor(t){super();h(this,"metric");const{name:r,metrics:i}=t;this.metric=i.registerMetric(r),this.updateComponentMetric()}set(t,r){return super.set(t,r),this.updateComponentMetric(),this}delete(t){const r=super.delete(t);return this.updateComponentMetric(),r}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function xA(n){const{name:e,metrics:t}=n;let r;return t!=null?r=new AV({name:e,metrics:t}):r=new Ls,r}class hd{constructor(e=!1,t=0){h(this,"full");h(this,"pendingBytes");h(this,"wantlist");h(this,"blocks");h(this,"blockPresences");this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){const r=ar.encode(e.multihash.bytes);this.wantlist.set(r,t)}addBlockPresence(e,t){const r=ar.encode(e.multihash.bytes);this.blockPresences.set(r,t)}addBlock(e,t){const r=ar.encode(e.multihash.bytes);this.blocks.set(r,t)}}function IV(n){let e=new Uint8Array(n.reduce((r,i)=>r+ht(i),0)),t=0;for(const r of n)e=ii(r,e,t),t+=ht(r);return e}function Pw(n){return IV([n.version,n.code,n.multihash.code,n.multihash.digest.byteLength])}class CV{constructor(e,t){h(this,"peerId");h(this,"blockstore");h(this,"network");h(this,"wants");h(this,"exchangeCount");h(this,"bytesSent");h(this,"bytesReceived");h(this,"lastExchange");h(this,"maxSizeReplaceHasWithBlock");h(this,"log");this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??QM}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){const t=new hd,r=new Set;for(const[i,s]of this.wants.entries())try{const o=await this.blockstore.get(s.cid,e);s.wantType===zt.WantHave?o.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",s.cid),r.add(i),t.addBlock(s.cid,{data:o,prefix:Pw(s.cid)})):(this.log("sending have for %c",s.cid),t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:Vi.HaveBlock})):(this.log("sending block for %c",s.cid),r.add(i),t.addBlock(s.cid,{data:o,prefix:Pw(s.cid)}))}catch(o){if(o.code!=="ERR_NOT_FOUND")throw o;if(this.log("do not have block for %c",s.cid),!s.sendDontHave||s.sentDontHave===!0)continue;s.sentDontHave=!0,t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:Vi.DontHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((i,s)=>i+s.data.byteLength,0));for(const i of r)this.wants.delete(i)}}}class TV{constructor(e,t={}){h(this,"blockstore");h(this,"network");h(this,"ledgerMap");h(this,"maxSizeReplaceHasWithBlock");h(this,"log");h(this,"logger");this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=xA({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",r=>{this.receiveMessage(r.detail.peer,r.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p",r.detail.peer,i)})}),this.network.addEventListener("peer:disconnected",r=>{this.peerDisconnected(r.detail)})}ledgerForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){var i;let r=this.ledgerMap.get(e);if(r==null&&(r=new CV({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,r)),r.receivedBytes(((i=t.blocks)==null?void 0:i.reduce((s,o)=>s+o.data.byteLength,0))??0),t.wantlist!=null){t.wantlist.full===!0&&r.wants.clear();for(const s of t.wantlist.entries){const o=nt.decode(s.cid),a=ne(o.multihash.bytes,"base64");s.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,o),r.wants.delete(a)):(s.wantType===zt.WantHave?this.log("peer %p wanted block presence for %c",e,o):this.log("peer %p wanted block for %c",e,o),r.wants.set(a,{cid:o,priority:s.priority,wantType:s.wantType??zt.WantBlock,sendDontHave:s.sendDontHave??!1}))}}this.log("send blocks to peer"),await r.sendBlocksToPeer()}async receivedBlock(e,t){const r=ne(e.multihash.bytes,"base64"),i=[];for(const s of this.ledgerMap.values())s.wants.has(r)&&i.push(s);await Promise.all(i.map(async s=>s.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}}const Vc=1e3,Hc=Vc*60,Kc=Hc*60,Ga=Kc*24,vh=Ga*7,Wc=Ga*365.25,Eh=Wc/12;function NV(n,e){if(typeof n=="string")return DV(n);if(typeof n=="number")return LV(n,e);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(n)}`)}var mp=NV;function DV(n){if(typeof n!="string"||n.length===0||n.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(n)}`);let e=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(n);if(!(e!=null&&e.groups))return NaN;let{value:t,unit:r="ms"}=e.groups,i=parseFloat(t),s=r.toLowerCase();switch(s){case"years":case"year":case"yrs":case"yr":case"y":return i*Wc;case"months":case"month":case"mo":return i*Eh;case"weeks":case"week":case"w":return i*vh;case"days":case"day":case"d":return i*Ga;case"hours":case"hour":case"hrs":case"hr":case"h":return i*Kc;case"minutes":case"minute":case"mins":case"min":case"m":return i*Hc;case"seconds":case"second":case"secs":case"sec":case"s":return i*Vc;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:throw Error(`Unknown unit "${s}" provided to ms.parse(). value=${JSON.stringify(n)}`)}}function PV(n){let e=Math.abs(n);return e>=Wc?`${Math.round(n/Wc)}y`:e>=Eh?`${Math.round(n/Eh)}mo`:e>=vh?`${Math.round(n/vh)}w`:e>=Ga?`${Math.round(n/Ga)}d`:e>=Kc?`${Math.round(n/Kc)}h`:e>=Hc?`${Math.round(n/Hc)}m`:e>=Vc?`${Math.round(n/Vc)}s`:`${n}ms`}function OV(n){let e=Math.abs(n);return e>=Wc?Xo(n,e,Wc,"year"):e>=Eh?Xo(n,e,Eh,"month"):e>=vh?Xo(n,e,vh,"week"):e>=Ga?Xo(n,e,Ga,"day"):e>=Kc?Xo(n,e,Kc,"hour"):e>=Hc?Xo(n,e,Hc,"minute"):e>=Vc?Xo(n,e,Vc,"second"):`${n} ms`}function LV(n,e){if(typeof n!="number"||!Number.isFinite(n))throw Error("Value provided to ms.format() must be of type number.");return e!=null&&e.long?OV(n):PV(n)}function Xo(n,e,t,r){let i=e>=t*1.5;return`${Math.round(n/t)} ${r}${i?"s":""}`}function BV(n){t.debug=t,t.default=t,t.coerce=l,t.disable=s,t.enable=i,t.enabled=o,t.humanize=mp,t.destroy=c,Object.keys(n).forEach(u=>{t[u]=n[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let d=0;for(let f=0;f<u.length;f++)d=(d<<5)-d+u.charCodeAt(f),d|=0;return t.colors[Math.abs(d)%t.colors.length]}t.selectColor=e;function t(u){let d,f=null,p,y;function g(...w){if(!g.enabled)return;const m=g,E=Number(new Date),v=E-(d||E);m.diff=v,m.prev=d,m.curr=E,d=E,w[0]=t.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let b=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(A,T)=>{if(A==="%%")return"%";b++;const P=t.formatters[T];if(typeof P=="function"){const _=w[b];A=P.call(m,_),w.splice(b,1),b--}return A}),t.formatArgs.call(m,w),(m.log||t.log).apply(m,w)}return g.namespace=u,g.useColors=t.useColors(),g.color=t.selectColor(u),g.extend=r,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(p!==t.namespaces&&(p=t.namespaces,y=t.enabled(u)),y),set:w=>{f=w}}),typeof t.init=="function"&&t.init(g),g}function r(u,d){const f=t(this.namespace+(typeof d>"u"?":":d)+u);return f.log=this.log,f}function i(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let d;const f=(typeof u=="string"?u:"").split(/[\s,]+/),p=f.length;for(d=0;d<p;d++)f[d]&&(u=f[d].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.substr(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function s(){const u=[...t.names.map(a),...t.skips.map(a).map(d=>"-"+d)].join(",");return t.enable(""),u}function o(u){if(u[u.length-1]==="*")return!0;let d,f;for(d=0,f=t.skips.length;d<f;d++)if(t.skips[d].test(u))return!1;for(d=0,f=t.names.length;d<f;d++)if(t.names[d].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function l(u){return u instanceof Error?u.stack??u.message:u}function c(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var MV={};const Ni=KV(),$V=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function UV(){var n,e,t,r,i;return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&((n=navigator.userAgent)==null?void 0:n.toLowerCase().match(/(edge|trident)\/(\d+)/))!=null?!1:typeof document<"u"&&((t=(e=document.documentElement)==null?void 0:e.style)==null?void 0:t.WebkitAppearance)||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&((r=navigator.userAgent)==null?void 0:r.toLowerCase().match(/firefox\/(\d+)/))!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&((i=navigator.userAgent)==null?void 0:i.toLowerCase().match(/applewebkit\/(\d+)/))}function FV(n){if(n[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+n[0]+(this.useColors?"%c ":" ")+"+"+mp(this.diff),!this.useColors)return;const e="color: "+this.color;n.splice(1,0,e,"color: inherit");let t=0,r=0;n[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(t++,i==="%c"&&(r=t))}),n.splice(r,0,e)}const zV=console.debug??console.log??(()=>{});function VV(n){try{n?Ni==null||Ni.setItem("debug",n):Ni==null||Ni.removeItem("debug")}catch{}}function HV(){let n;try{n=Ni==null?void 0:Ni.getItem("debug")}catch{}return!n&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(n=MV.DEBUG),n}function KV(){try{return localStorage}catch{}}function WV(n){n.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const Cr=BV({formatArgs:FV,save:VV,load:HV,useColors:UV,setupFormatters:WV,colors:$V,storage:Ni,log:zV});Cr.formatters.b=n=>n==null?"undefined":mn.baseEncode(n);Cr.formatters.t=n=>n==null?"undefined":Hn.baseEncode(n);Cr.formatters.m=n=>n==null?"undefined":ar.baseEncode(n);Cr.formatters.p=n=>n==null?"undefined":n.toString();Cr.formatters.c=n=>n==null?"undefined":n.toString();Cr.formatters.k=n=>n==null?"undefined":n.toString();Cr.formatters.a=n=>n==null?"undefined":n.toString();function GV(n){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=n,e.destroy=()=>!0,e.extend=()=>e,e}function wp(){return{forComponent(n){return Su(n)}}}function Su(n){let e=GV(`${n}:trace`);return Cr.enabled(`${n}:trace`)&&Cr.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=Cr(`${n}:trace`)),Object.assign(Cr(n),{error:Cr(`${n}:error`),trace:e})}var kA={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function i(l,c,u){this.fn=l,this.context=c,this.once=u||!1}function s(l,c,u,d,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var p=new i(u,d||l,f),y=t?t+c:c;return l._events[y]?l._events[y].fn?l._events[y]=[l._events[y],p]:l._events[y].push(p):(l._events[y]=p,l._eventsCount++),l}function o(l,c){--l._eventsCount===0?l._events=new r:delete l._events[c]}function a(){this._events=new r,this._eventsCount=0}a.prototype.eventNames=function(){var c=[],u,d;if(this._eventsCount===0)return c;for(d in u=this._events)e.call(u,d)&&c.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(u)):c},a.prototype.listeners=function(c){var u=t?t+c:c,d=this._events[u];if(!d)return[];if(d.fn)return[d.fn];for(var f=0,p=d.length,y=new Array(p);f<p;f++)y[f]=d[f].fn;return y},a.prototype.listenerCount=function(c){var u=t?t+c:c,d=this._events[u];return d?d.fn?1:d.length:0},a.prototype.emit=function(c,u,d,f,p,y){var g=t?t+c:c;if(!this._events[g])return!1;var w=this._events[g],m=arguments.length,E,v;if(w.fn){switch(w.once&&this.removeListener(c,w.fn,void 0,!0),m){case 1:return w.fn.call(w.context),!0;case 2:return w.fn.call(w.context,u),!0;case 3:return w.fn.call(w.context,u,d),!0;case 4:return w.fn.call(w.context,u,d,f),!0;case 5:return w.fn.call(w.context,u,d,f,p),!0;case 6:return w.fn.call(w.context,u,d,f,p,y),!0}for(v=1,E=new Array(m-1);v<m;v++)E[v-1]=arguments[v];w.fn.apply(w.context,E)}else{var b=w.length,k;for(v=0;v<b;v++)switch(w[v].once&&this.removeListener(c,w[v].fn,void 0,!0),m){case 1:w[v].fn.call(w[v].context);break;case 2:w[v].fn.call(w[v].context,u);break;case 3:w[v].fn.call(w[v].context,u,d);break;case 4:w[v].fn.call(w[v].context,u,d,f);break;default:if(!E)for(k=1,E=new Array(m-1);k<m;k++)E[k-1]=arguments[k];w[v].fn.apply(w[v].context,E)}}return!0},a.prototype.on=function(c,u,d){return s(this,c,u,d,!1)},a.prototype.once=function(c,u,d){return s(this,c,u,d,!0)},a.prototype.removeListener=function(c,u,d,f){var p=t?t+c:c;if(!this._events[p])return this;if(!u)return o(this,p),this;var y=this._events[p];if(y.fn)y.fn===u&&(!f||y.once)&&(!d||y.context===d)&&o(this,p);else{for(var g=0,w=[],m=y.length;g<m;g++)(y[g].fn!==u||f&&!y[g].once||d&&y[g].context!==d)&&w.push(y[g]);w.length?this._events[p]=w.length===1?w[0]:w:o(this,p)}return this},a.prototype.removeAllListeners=function(c){var u;return c?(u=t?t+c:c,this._events[u]&&o(this,u)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,n.exports=a})(kA);var qV=kA.exports;const RA=ci(qV);let a5=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},jV=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const Ow=n=>globalThis.DOMException===void 0?new jV(n):new DOMException(n),Lw=n=>{const e=n.reason===void 0?Ow("This operation was aborted."):n.reason;return e instanceof Error?e:Ow(e)};function vp(n,e){const{milliseconds:t,fallback:r,message:i,customTimers:s={setTimeout,clearTimeout}}=e;let o,a;const c=new Promise((u,d)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:p}=e;p.aborted&&d(Lw(p)),a=()=>{d(Lw(p))},p.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){n.then(u,d);return}const f=new a5;o=s.setTimeout.call(void 0,()=>{if(r){try{u(r())}catch(p){d(p)}return}typeof n.cancel=="function"&&n.cancel(),i===!1?u():i instanceof Error?d(i):(f.message=i??`Promise timed out after ${t} milliseconds`,d(f))},t),(async()=>{try{u(await n)}catch(p){d(p)}})()}).finally(()=>{c.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return c.clear=()=>{s.clearTimeout.call(void 0,o),o=void 0},c}function YV(n,e,t){let r=0,i=n.length;for(;i>0;){const s=Math.trunc(i/2);let o=r+s;t(n[o],e)<=0?(r=++o,i-=s+1):i=s}return r}var Er,hE;let QV=(hE=class{constructor(){le(this,Er,[])}enqueue(e,t){t={priority:0,...t};const r={priority:t.priority,id:t.id,run:e};if(this.size===0||I(this,Er)[this.size-1].priority>=t.priority){I(this,Er).push(r);return}const i=YV(I(this,Er),r,(s,o)=>o.priority-s.priority);I(this,Er).splice(i,0,r)}setPriority(e,t){const r=I(this,Er).findIndex(s=>s.id===e);if(r===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[i]=I(this,Er).splice(r,1);this.enqueue(i.run,{priority:t,id:e})}dequeue(){const e=I(this,Er).shift();return e==null?void 0:e.run}filter(e){return I(this,Er).filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return I(this,Er).length}},Er=new WeakMap,hE);var oc,ac,ao,Nh,lc,Dh,br,cc,kn,Ph,_r,uc,us,Oh,N2,ze,AA,IA,CA,TA,NA,I1,j4,Y4,C1,DA,T1,fE;let l5=(fE=class extends RA{constructor(t){var r,i;super();le(this,ze);le(this,oc);le(this,ac);le(this,ao,0);le(this,Nh);le(this,lc);le(this,Dh,0);le(this,br);le(this,cc);le(this,kn);le(this,Ph);le(this,_r,0);le(this,uc);le(this,us);le(this,Oh);le(this,N2,1n);h(this,"timeout");if(t={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:QV,...t},!(typeof t.intervalCap=="number"&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${((r=t.intervalCap)==null?void 0:r.toString())??""}\` (${typeof t.intervalCap})`);if(t.interval===void 0||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${((i=t.interval)==null?void 0:i.toString())??""}\` (${typeof t.interval})`);ye(this,oc,t.carryoverConcurrencyCount),ye(this,ac,t.intervalCap===Number.POSITIVE_INFINITY||t.interval===0),ye(this,Nh,t.intervalCap),ye(this,lc,t.interval),ye(this,kn,new t.queueClass),ye(this,Ph,t.queueClass),this.concurrency=t.concurrency,this.timeout=t.timeout,ye(this,Oh,t.throwOnTimeout===!0),ye(this,us,t.autoStart===!1)}get concurrency(){return I(this,uc)}set concurrency(t){if(!(typeof t=="number"&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);ye(this,uc,t),Q(this,ze,C1).call(this)}setPriority(t,r){I(this,kn).setPriority(t,r)}async add(t,r={}){return r.id??(r.id=(sn(this,N2)._++).toString()),r={timeout:this.timeout,throwOnTimeout:I(this,Oh),...r},new Promise((i,s)=>{I(this,kn).enqueue(async()=>{var o;sn(this,_r)._++;try{(o=r.signal)==null||o.throwIfAborted(),sn(this,ao)._++;let a=t({signal:r.signal});r.timeout&&(a=vp(Promise.resolve(a),{milliseconds:r.timeout})),r.signal&&(a=Promise.race([a,Q(this,ze,DA).call(this,r.signal)]));const l=await a;i(l),this.emit("completed",l)}catch(a){if(a instanceof a5&&!r.throwOnTimeout){i();return}s(a),this.emit("error",a)}finally{Q(this,ze,CA).call(this)}},r),this.emit("add"),Q(this,ze,I1).call(this)})}async addAll(t,r){return Promise.all(t.map(async i=>this.add(i,r)))}start(){return I(this,us)?(ye(this,us,!1),Q(this,ze,C1).call(this),this):this}pause(){ye(this,us,!0)}clear(){ye(this,kn,new(I(this,Ph)))}async onEmpty(){I(this,kn).size!==0&&await Q(this,ze,T1).call(this,"empty")}async onSizeLessThan(t){I(this,kn).size<t||await Q(this,ze,T1).call(this,"next",()=>I(this,kn).size<t)}async onIdle(){I(this,_r)===0&&I(this,kn).size===0||await Q(this,ze,T1).call(this,"idle")}get size(){return I(this,kn).size}sizeBy(t){return I(this,kn).filter(t).length}get pending(){return I(this,_r)}get isPaused(){return I(this,us)}},oc=new WeakMap,ac=new WeakMap,ao=new WeakMap,Nh=new WeakMap,lc=new WeakMap,Dh=new WeakMap,br=new WeakMap,cc=new WeakMap,kn=new WeakMap,Ph=new WeakMap,_r=new WeakMap,uc=new WeakMap,us=new WeakMap,Oh=new WeakMap,N2=new WeakMap,ze=new WeakSet,AA=function(){return I(this,ac)||I(this,ao)<I(this,Nh)},IA=function(){return I(this,_r)<I(this,uc)},CA=function(){sn(this,_r)._--,Q(this,ze,I1).call(this),this.emit("next")},TA=function(){Q(this,ze,Y4).call(this),Q(this,ze,j4).call(this),ye(this,cc,void 0)},NA=function(){const t=Date.now();if(I(this,br)===void 0){const r=I(this,Dh)-t;if(r<0)ye(this,ao,I(this,oc)?I(this,_r):0);else return I(this,cc)===void 0&&ye(this,cc,setTimeout(()=>{Q(this,ze,TA).call(this)},r)),!0}return!1},I1=function(){if(I(this,kn).size===0)return I(this,br)&&clearInterval(I(this,br)),ye(this,br,void 0),this.emit("empty"),I(this,_r)===0&&this.emit("idle"),!1;if(!I(this,us)){const t=!I(this,ze,NA);if(I(this,ze,AA)&&I(this,ze,IA)){const r=I(this,kn).dequeue();return r?(this.emit("active"),r(),t&&Q(this,ze,j4).call(this),!0):!1}}return!1},j4=function(){I(this,ac)||I(this,br)!==void 0||(ye(this,br,setInterval(()=>{Q(this,ze,Y4).call(this)},I(this,lc))),ye(this,Dh,Date.now()+I(this,lc)))},Y4=function(){I(this,ao)===0&&I(this,_r)===0&&I(this,br)&&(clearInterval(I(this,br)),ye(this,br,void 0)),ye(this,ao,I(this,oc)?I(this,_r):0),Q(this,ze,C1).call(this)},C1=function(){for(;Q(this,ze,I1).call(this););},DA=async function(t){return new Promise((r,i)=>{t.addEventListener("abort",()=>{i(t.reason)},{once:!0})})},T1=async function(t,r){return new Promise(i=>{const s=()=>{r&&!r()||(this.off(t,s),i())};this.on(t,s)})},fE);function PA(n){const e=[Oo.A];return n==null?e:Array.isArray(n)?n.length===0?e:n:[n]}const OA=60;function LA(n){return{Status:n.Status??0,TC:n.TC??n.flag_tc??!1,RD:n.RD??n.flag_rd??!1,RA:n.RA??n.flag_ra??!1,AD:n.AD??n.flag_ad??!1,CD:n.CD??n.flag_cd??!1,Question:(n.Question??n.questions??[]).map(e=>({name:e.name,type:Oo[e.type]})),Answer:(n.Answer??n.answers??[]).map(e=>({name:e.name,type:Oo[e.type],TTL:e.TTL??e.ttl??OA,data:e.data instanceof Uint8Array?ne(e.data):e.data}))}}const XV=4;function Bw(n,e={}){const t=new l5({concurrency:e.queryConcurrency??XV});return async(r,i={})=>{var a;const s=new URLSearchParams;s.set("name",r),PA(i.types).forEach(l=>{s.append("type",Oo[l])}),(a=i.onProgress)==null||a.call(i,new se("dns:query",r));const o=await t.add(async()=>{var u;const l=await fetch(`${n}?${s}`,{headers:{accept:"application/dns-json"},signal:i==null?void 0:i.signal});if(l.status!==200)throw new Error(`Unexpected HTTP status: ${l.status} - ${l.statusText}`);const c=LA(await l.json());return(u=i.onProgress)==null||u.call(i,new se("dns:response",c)),c},{signal:i.signal});if(o==null)throw new Error("No DNS response received");return o}}function JV(){return[Bw("https://cloudflare-dns.com/dns-query"),Bw("https://dns.google/resolve")]}var ZV=function(n){if(!n)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),r=Object.create(null);function i(s,o){t[s]=o,e++,e>=n&&(e=0,r=t,t=Object.create(null))}return{has:function(s){return t[s]!==void 0||r[s]!==void 0},remove:function(s){t[s]!==void 0&&(t[s]=void 0),r[s]!==void 0&&(r[s]=void 0)},get:function(s){var o=t[s];if(o!==void 0)return o;if((o=r[s])!==void 0)return i(s,o),o},set:function(s,o){t[s]!==void 0?t[s]=o:i(s,o)},clear:function(){t=Object.create(null),r=Object.create(null)}}};const BA=ci(ZV);class eH{constructor(e){h(this,"lru");this.lru=BA(e)}get(e,t){let r=!0;const i=[];for(const s of t){const o=this.getAnswers(e,s);if(o.length===0){r=!1;break}i.push(...o)}if(r)return LA({answers:i})}getAnswers(e,t){const r=`${e.toLowerCase()}-${t}`,i=this.lru.get(r);if(i!=null){const s=i.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:Oo[a.type]}));return s.length===0&&this.lru.remove(r),s}return[]}add(e,t){const r=`${e.toLowerCase()}-${t.type}`,i=this.lru.get(r)??[];i.push({expires:Date.now()+(t.TTL??OA)*1e3,value:t}),this.lru.set(r,i)}remove(e,t){const r=`${e.toLowerCase()}-${t}`;this.lru.remove(r)}clear(){this.lru.clear()}}function tH(n){return new eH(n)}const nH=1e3;let rH=class{constructor(e){h(this,"resolvers");h(this,"cache");this.resolvers={},this.cache=tH(e.cacheSize??nH),Object.entries(e.resolvers??{}).forEach(([t,r])=>{Array.isArray(r)||(r=[r]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=r}),this.resolvers["."]==null&&(this.resolvers["."]=JV())}async query(e,t={}){var l,c,u;const r=PA(t.types),i=t.cached!==!1?this.cache.get(e,r):void 0;if(i!=null)return(l=t.onProgress)==null||l.call(t,new se("dns:cache",i)),i;const s=`${e.split(".").pop()}.`,o=(this.resolvers[s]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const d of o){if(((c=t.signal)==null?void 0:c.aborted)===!0)break;try{const f=await d(e,{...t,types:r});for(const p of f.Answer)this.cache.add(e,p);return f}catch(f){a.push(f),(u=t.onProgress)==null||u.call(t,new se("dns:error",f))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${r} failed`)}};var Oo;(function(n){n[n.A=1]="A",n[n.CNAME=5]="CNAME",n[n.TXT=16]="TXT",n[n.AAAA=28]="AAAA"})(Oo||(Oo={}));function MA(n={}){return new rH(n)}const iH=["string","number","bigint","symbol"],sH=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function oH(n){if(n===null)return"null";if(n===void 0)return"undefined";if(n===!0||n===!1)return"boolean";const e=typeof n;if(iH.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(n))return"Array";if(aH(n))return"Buffer";const t=lH(n);return t||"Object"}function aH(n){return n&&n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer.call(null,n)}function lH(n){const e=Object.prototype.toString.call(n).slice(8,-1);if(sH.includes(e))return e}let U=class{constructor(e,t,r){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=r}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}};U.uint=new U(0,"uint",!0);U.negint=new U(1,"negint",!0);U.bytes=new U(2,"bytes",!0);U.string=new U(3,"string",!0);U.array=new U(4,"array",!1);U.map=new U(5,"map",!1);U.tag=new U(6,"tag",!1);U.float=new U(7,"float",!0);U.false=new U(7,"false",!0);U.true=new U(7,"true",!0);U.null=new U(7,"null",!0);U.undefined=new U(7,"undefined",!0);U.break=new U(7,"break",!0);let Z=class{constructor(e,t,r){this.type=e,this.value=t,this.encodedLength=r,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}};const xu=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",cH=new TextDecoder,uH=new TextEncoder;function K0(n){return xu&&globalThis.Buffer.isBuffer(n)}function c5(n){return n instanceof Uint8Array?K0(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):n:Uint8Array.from(n)}const dH=xu?(n,e,t)=>t-e>64?globalThis.Buffer.from(n.subarray(e,t)).toString("utf8"):$w(n,e,t):(n,e,t)=>t-e>64?cH.decode(n.subarray(e,t)):$w(n,e,t),$A=xu?n=>n.length>64?globalThis.Buffer.from(n):Mw(n):n=>n.length>64?uH.encode(n):Mw(n),es=n=>Uint8Array.from(n),u5=xu?(n,e,t)=>K0(n)?new Uint8Array(n.subarray(e,t)):n.slice(e,t):(n,e,t)=>n.slice(e,t),hH=xu?(n,e)=>(n=n.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),c5(globalThis.Buffer.concat(n,e))):(n,e)=>{const t=new Uint8Array(e);let r=0;for(let i of n)r+i.length>t.length&&(i=i.subarray(0,t.length-r)),t.set(i,r),r+=i.length;return t},fH=xu?n=>globalThis.Buffer.allocUnsafe(n):n=>new Uint8Array(n);function pH(n,e){if(K0(n)&&K0(e))return n.compare(e);for(let t=0;t<n.length;t++)if(n[t]!==e[t])return n[t]<e[t]?-1:1;return 0}function Mw(n){const e=[];let t=0;for(let r=0;r<n.length;r++){let i=n.charCodeAt(r);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&r+1<n.length&&(n.charCodeAt(r+1)&64512)===56320?(i=65536+((i&1023)<<10)+(n.charCodeAt(++r)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e}function $w(n,e,t){const r=[];for(;e<t;){const i=n[e];let s=null,o=i>239?4:i>223?3:i>191?2:1;if(e+o<=t){let a,l,c,u;switch(o){case 1:i<128&&(s=i);break;case 2:a=n[e+1],(a&192)===128&&(u=(i&31)<<6|a&63,u>127&&(s=u));break;case 3:a=n[e+1],l=n[e+2],(a&192)===128&&(l&192)===128&&(u=(i&15)<<12|(a&63)<<6|l&63,u>2047&&(u<55296||u>57343)&&(s=u));break;case 4:a=n[e+1],l=n[e+2],c=n[e+3],(a&192)===128&&(l&192)===128&&(c&192)===128&&(u=(i&15)<<18|(a&63)<<12|(l&63)<<6|c&63,u>65535&&u<1114112&&(s=u))}}s===null?(s=65533,o=1):s>65535&&(s-=65536,r.push(s>>>10&1023|55296),s=56320|s&1023),r.push(s),e+=o}return UA(r)}const Uw=4096;function UA(n){const e=n.length;if(e<=Uw)return String.fromCharCode.apply(String,n);let t="",r=0;for(;r<e;)t+=String.fromCharCode.apply(String,n.slice(r,r+=Uw));return t}const gH=256;class FA{constructor(e=gH){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){const i=t.length-(this.maxCursor-this.cursor)-1;t.set(e,i)}else{if(t){const i=t.length-(this.maxCursor-this.cursor)-1;i<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,i),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=fH(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){const r=this.chunks[0];e&&this.cursor>r.length/2?(t=this.cursor===r.length?r:r.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=u5(r,0,this.cursor)}else t=hH(this.chunks,this.cursor);return e&&this.reset(),t}}const he="CBOR decode error:",W0="CBOR encode error:";function ku(n,e,t){if(n.length-e<t)throw new Error(`${he} not enough data for type`)}const Qt=[24,256,65536,4294967296,BigInt("18446744073709551616")];function tl(n,e,t){ku(n,e,1);const r=n[e];if(t.strict===!0&&r<Qt[0])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);return r}function nl(n,e,t){ku(n,e,2);const r=n[e]<<8|n[e+1];if(t.strict===!0&&r<Qt[1])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);return r}function rl(n,e,t){ku(n,e,4);const r=n[e]*16777216+(n[e+1]<<16)+(n[e+2]<<8)+n[e+3];if(t.strict===!0&&r<Qt[2])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);return r}function il(n,e,t){ku(n,e,8);const r=n[e]*16777216+(n[e+1]<<16)+(n[e+2]<<8)+n[e+3],i=n[e+4]*16777216+(n[e+5]<<16)+(n[e+6]<<8)+n[e+7],s=(BigInt(r)<<BigInt(32))+BigInt(i);if(t.strict===!0&&s<Qt[3])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);if(s<=Number.MAX_SAFE_INTEGER)return Number(s);if(t.allowBigInt===!0)return s;throw new Error(`${he} integers outside of the safe integer range are not supported`)}function yH(n,e,t,r){return new Z(U.uint,tl(n,e+1,r),2)}function mH(n,e,t,r){return new Z(U.uint,nl(n,e+1,r),3)}function wH(n,e,t,r){return new Z(U.uint,rl(n,e+1,r),5)}function vH(n,e,t,r){return new Z(U.uint,il(n,e+1,r),9)}function sl(n,e){return Ur(n,0,e.value)}function Ur(n,e,t){if(t<Qt[0]){const r=Number(t);n.push([e|r])}else if(t<Qt[1]){const r=Number(t);n.push([e|24,r])}else if(t<Qt[2]){const r=Number(t);n.push([e|25,r>>>8,r&255])}else if(t<Qt[3]){const r=Number(t);n.push([e|26,r>>>24&255,r>>>16&255,r>>>8&255,r&255])}else{const r=BigInt(t);if(r<Qt[4]){const i=[e|27,0,0,0,0,0,0,0];let s=Number(r&BigInt(4294967295)),o=Number(r>>BigInt(32)&BigInt(4294967295));i[8]=s&255,s=s>>8,i[7]=s&255,s=s>>8,i[6]=s&255,s=s>>8,i[5]=s&255,i[4]=o&255,o=o>>8,i[3]=o&255,o=o>>8,i[2]=o&255,o=o>>8,i[1]=o&255,n.push(i)}else throw new Error(`${he} encountered BigInt larger than allowable range`)}}sl.encodedSize=function(e){return Ur.encodedSize(e.value)};Ur.encodedSize=function(e){return e<Qt[0]?1:e<Qt[1]?2:e<Qt[2]?3:e<Qt[3]?5:9};sl.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function EH(n,e,t,r){return new Z(U.negint,-1-tl(n,e+1,r),2)}function bH(n,e,t,r){return new Z(U.negint,-1-nl(n,e+1,r),3)}function _H(n,e,t,r){return new Z(U.negint,-1-rl(n,e+1,r),5)}const d5=BigInt(-1),zA=BigInt(1);function SH(n,e,t,r){const i=il(n,e+1,r);if(typeof i!="bigint"){const s=-1-i;if(s>=Number.MIN_SAFE_INTEGER)return new Z(U.negint,s,9)}if(r.allowBigInt!==!0)throw new Error(`${he} integers outside of the safe integer range are not supported`);return new Z(U.negint,d5-BigInt(i),9)}function h5(n,e){const t=e.value,r=typeof t=="bigint"?t*d5-zA:t*-1-1;Ur(n,e.type.majorEncoded,r)}h5.encodedSize=function(e){const t=e.value,r=typeof t=="bigint"?t*d5-zA:t*-1-1;return r<Qt[0]?1:r<Qt[1]?2:r<Qt[2]?3:r<Qt[3]?5:9};h5.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function tf(n,e,t,r){ku(n,e,t+r);const i=u5(n,e+t,e+t+r);return new Z(U.bytes,i,t+r)}function xH(n,e,t,r){return tf(n,e,1,t)}function kH(n,e,t,r){return tf(n,e,2,tl(n,e+1,r))}function RH(n,e,t,r){return tf(n,e,3,nl(n,e+1,r))}function AH(n,e,t,r){return tf(n,e,5,rl(n,e+1,r))}function IH(n,e,t,r){const i=il(n,e+1,r);if(typeof i=="bigint")throw new Error(`${he} 64-bit integer bytes lengths not supported`);return tf(n,e,9,i)}function G0(n){return n.encodedBytes===void 0&&(n.encodedBytes=n.type===U.string?$A(n.value):n.value),n.encodedBytes}function Ep(n,e){const t=G0(e);Ur(n,e.type.majorEncoded,t.length),n.push(t)}Ep.encodedSize=function(e){const t=G0(e);return Ur.encodedSize(t.length)+t.length};Ep.compareTokens=function(e,t){return CH(G0(e),G0(t))};function CH(n,e){return n.length<e.length?-1:n.length>e.length?1:pH(n,e)}function nf(n,e,t,r,i){const s=t+r;ku(n,e,s);const o=new Z(U.string,dH(n,e+t,e+s),s);return i.retainStringBytes===!0&&(o.byteValue=u5(n,e+t,e+s)),o}function TH(n,e,t,r){return nf(n,e,1,t,r)}function NH(n,e,t,r){return nf(n,e,2,tl(n,e+1,r),r)}function DH(n,e,t,r){return nf(n,e,3,nl(n,e+1,r),r)}function PH(n,e,t,r){return nf(n,e,5,rl(n,e+1,r),r)}function OH(n,e,t,r){const i=il(n,e+1,r);if(typeof i=="bigint")throw new Error(`${he} 64-bit integer string lengths not supported`);return nf(n,e,9,i,r)}const LH=Ep;function Ru(n,e,t,r){return new Z(U.array,r,t)}function BH(n,e,t,r){return Ru(n,e,1,t)}function MH(n,e,t,r){return Ru(n,e,2,tl(n,e+1,r))}function $H(n,e,t,r){return Ru(n,e,3,nl(n,e+1,r))}function UH(n,e,t,r){return Ru(n,e,5,rl(n,e+1,r))}function FH(n,e,t,r){const i=il(n,e+1,r);if(typeof i=="bigint")throw new Error(`${he} 64-bit integer array lengths not supported`);return Ru(n,e,9,i)}function zH(n,e,t,r){if(r.allowIndefinite===!1)throw new Error(`${he} indefinite length items not allowed`);return Ru(n,e,1,1/0)}function f5(n,e){Ur(n,U.array.majorEncoded,e.value)}f5.compareTokens=sl.compareTokens;f5.encodedSize=function(e){return Ur.encodedSize(e.value)};function Au(n,e,t,r){return new Z(U.map,r,t)}function VH(n,e,t,r){return Au(n,e,1,t)}function HH(n,e,t,r){return Au(n,e,2,tl(n,e+1,r))}function KH(n,e,t,r){return Au(n,e,3,nl(n,e+1,r))}function WH(n,e,t,r){return Au(n,e,5,rl(n,e+1,r))}function GH(n,e,t,r){const i=il(n,e+1,r);if(typeof i=="bigint")throw new Error(`${he} 64-bit integer map lengths not supported`);return Au(n,e,9,i)}function qH(n,e,t,r){if(r.allowIndefinite===!1)throw new Error(`${he} indefinite length items not allowed`);return Au(n,e,1,1/0)}function p5(n,e){Ur(n,U.map.majorEncoded,e.value)}p5.compareTokens=sl.compareTokens;p5.encodedSize=function(e){return Ur.encodedSize(e.value)};function jH(n,e,t,r){return new Z(U.tag,t,1)}function YH(n,e,t,r){return new Z(U.tag,tl(n,e+1,r),2)}function QH(n,e,t,r){return new Z(U.tag,nl(n,e+1,r),3)}function XH(n,e,t,r){return new Z(U.tag,rl(n,e+1,r),5)}function JH(n,e,t,r){return new Z(U.tag,il(n,e+1,r),9)}function g5(n,e){Ur(n,U.tag.majorEncoded,e.value)}g5.compareTokens=sl.compareTokens;g5.encodedSize=function(e){return Ur.encodedSize(e.value)};const ZH=20,eK=21,tK=22,nK=23;function rK(n,e,t,r){if(r.allowUndefined===!1)throw new Error(`${he} undefined values are not supported`);return r.coerceUndefinedToNull===!0?new Z(U.null,null,1):new Z(U.undefined,void 0,1)}function iK(n,e,t,r){if(r.allowIndefinite===!1)throw new Error(`${he} indefinite length items not allowed`);return new Z(U.break,void 0,1)}function y5(n,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(n))throw new Error(`${he} NaN values are not supported`);if(t.allowInfinity===!1&&(n===1/0||n===-1/0))throw new Error(`${he} Infinity values are not supported`)}return new Z(U.float,n,e)}function sK(n,e,t,r){return y5(w5(n,e+1),3,r)}function oK(n,e,t,r){return y5(v5(n,e+1),5,r)}function aK(n,e,t,r){return y5(WA(n,e+1),9,r)}function m5(n,e,t){const r=e.value;if(r===!1)n.push([U.float.majorEncoded|ZH]);else if(r===!0)n.push([U.float.majorEncoded|eK]);else if(r===null)n.push([U.float.majorEncoded|tK]);else if(r===void 0)n.push([U.float.majorEncoded|nK]);else{let i,s=!1;(!t||t.float64!==!0)&&(HA(r),i=w5(Hr,1),r===i||Number.isNaN(r)?(Hr[0]=249,n.push(Hr.slice(0,3)),s=!0):(KA(r),i=v5(Hr,1),r===i&&(Hr[0]=250,n.push(Hr.slice(0,5)),s=!0))),s||(lK(r),i=WA(Hr,1),Hr[0]=251,n.push(Hr.slice(0,9)))}}m5.encodedSize=function(e,t){const r=e.value;if(r===!1||r===!0||r===null||r===void 0)return 1;if(!t||t.float64!==!0){HA(r);let i=w5(Hr,1);if(r===i||Number.isNaN(r))return 3;if(KA(r),i=v5(Hr,1),r===i)return 5}return 9};const VA=new ArrayBuffer(9),wr=new DataView(VA,1),Hr=new Uint8Array(VA,0);function HA(n){if(n===1/0)wr.setUint16(0,31744,!1);else if(n===-1/0)wr.setUint16(0,64512,!1);else if(Number.isNaN(n))wr.setUint16(0,32256,!1);else{wr.setFloat32(0,n);const e=wr.getUint32(0),t=(e&2139095040)>>23,r=e&8388607;if(t===255)wr.setUint16(0,31744,!1);else if(t===0)wr.setUint16(0,(n&2147483648)>>16|r>>13,!1);else{const i=t-127;i<-24?wr.setUint16(0,0):i<-14?wr.setUint16(0,(e&2147483648)>>16|1<<24+i,!1):wr.setUint16(0,(e&2147483648)>>16|i+15<<10|r>>13,!1)}}}function w5(n,e){if(n.length-e<2)throw new Error(`${he} not enough data for float16`);const t=(n[e]<<8)+n[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;const r=t>>10&31,i=t&1023;let s;return r===0?s=i*2**-24:r!==31?s=(i+1024)*2**(r-25):s=i===0?1/0:NaN,t&32768?-s:s}function KA(n){wr.setFloat32(0,n,!1)}function v5(n,e){if(n.length-e<4)throw new Error(`${he} not enough data for float32`);const t=(n.byteOffset||0)+e;return new DataView(n.buffer,t,4).getFloat32(0,!1)}function lK(n){wr.setFloat64(0,n,!1)}function WA(n,e){if(n.length-e<8)throw new Error(`${he} not enough data for float64`);const t=(n.byteOffset||0)+e;return new DataView(n.buffer,t,8).getFloat64(0,!1)}m5.compareTokens=sl.compareTokens;function Ve(n,e,t){throw new Error(`${he} encountered invalid minor (${t}) for major ${n[e]>>>5}`)}function bp(n){return()=>{throw new Error(`${he} ${n}`)}}const X=[];for(let n=0;n<=23;n++)X[n]=Ve;X[24]=yH;X[25]=mH;X[26]=wH;X[27]=vH;X[28]=Ve;X[29]=Ve;X[30]=Ve;X[31]=Ve;for(let n=32;n<=55;n++)X[n]=Ve;X[56]=EH;X[57]=bH;X[58]=_H;X[59]=SH;X[60]=Ve;X[61]=Ve;X[62]=Ve;X[63]=Ve;for(let n=64;n<=87;n++)X[n]=xH;X[88]=kH;X[89]=RH;X[90]=AH;X[91]=IH;X[92]=Ve;X[93]=Ve;X[94]=Ve;X[95]=bp("indefinite length bytes/strings are not supported");for(let n=96;n<=119;n++)X[n]=TH;X[120]=NH;X[121]=DH;X[122]=PH;X[123]=OH;X[124]=Ve;X[125]=Ve;X[126]=Ve;X[127]=bp("indefinite length bytes/strings are not supported");for(let n=128;n<=151;n++)X[n]=BH;X[152]=MH;X[153]=$H;X[154]=UH;X[155]=FH;X[156]=Ve;X[157]=Ve;X[158]=Ve;X[159]=zH;for(let n=160;n<=183;n++)X[n]=VH;X[184]=HH;X[185]=KH;X[186]=WH;X[187]=GH;X[188]=Ve;X[189]=Ve;X[190]=Ve;X[191]=qH;for(let n=192;n<=215;n++)X[n]=jH;X[216]=YH;X[217]=QH;X[218]=XH;X[219]=JH;X[220]=Ve;X[221]=Ve;X[222]=Ve;X[223]=Ve;for(let n=224;n<=243;n++)X[n]=bp("simple values are not supported");X[244]=Ve;X[245]=Ve;X[246]=Ve;X[247]=rK;X[248]=bp("simple values are not supported");X[249]=sK;X[250]=oK;X[251]=aK;X[252]=Ve;X[253]=Ve;X[254]=Ve;X[255]=iK;const Qi=[];for(let n=0;n<24;n++)Qi[n]=new Z(U.uint,n,1);for(let n=-1;n>=-24;n--)Qi[31-n]=new Z(U.negint,n,1);Qi[64]=new Z(U.bytes,new Uint8Array(0),1);Qi[96]=new Z(U.string,"",1);Qi[128]=new Z(U.array,0,1);Qi[160]=new Z(U.map,0,1);Qi[244]=new Z(U.false,!1,1);Qi[245]=new Z(U.true,!0,1);Qi[246]=new Z(U.null,null,1);function cK(n){switch(n.type){case U.false:return es([244]);case U.true:return es([245]);case U.null:return es([246]);case U.bytes:return n.value.length?void 0:es([64]);case U.string:return n.value===""?es([96]):void 0;case U.array:return n.value===0?es([128]):void 0;case U.map:return n.value===0?es([160]):void 0;case U.uint:return n.value<24?es([Number(n.value)]):void 0;case U.negint:if(n.value>=-24)return es([31-Number(n.value)])}}const uK={float64:!1,mapSorter:fK,quickEncodeToken:cK};function dK(){const n=[];return n[U.uint.major]=sl,n[U.negint.major]=h5,n[U.bytes.major]=Ep,n[U.string.major]=LH,n[U.array.major]=f5,n[U.map.major]=p5,n[U.tag.major]=g5,n[U.float.major]=m5,n}const GA=dK(),Zg=new FA;let Fw=class qA{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${W0} object contains circular references`);return new qA(t,e)}};const Ys={null:new Z(U.null,null),undefined:new Z(U.undefined,void 0),true:new Z(U.true,!0),false:new Z(U.false,!1),emptyArray:new Z(U.array,0),emptyMap:new Z(U.map,0)},Lo={number(n,e,t,r){return!Number.isInteger(n)||!Number.isSafeInteger(n)?new Z(U.float,n):n>=0?new Z(U.uint,n):new Z(U.negint,n)},bigint(n,e,t,r){return n>=BigInt(0)?new Z(U.uint,n):new Z(U.negint,n)},Uint8Array(n,e,t,r){return new Z(U.bytes,n)},string(n,e,t,r){return new Z(U.string,n)},boolean(n,e,t,r){return n?Ys.true:Ys.false},null(n,e,t,r){return Ys.null},undefined(n,e,t,r){return Ys.undefined},ArrayBuffer(n,e,t,r){return new Z(U.bytes,new Uint8Array(n))},DataView(n,e,t,r){return new Z(U.bytes,new Uint8Array(n.buffer,n.byteOffset,n.byteLength))},Array(n,e,t,r){if(!n.length)return t.addBreakTokens===!0?[Ys.emptyArray,new Z(U.break)]:Ys.emptyArray;r=Fw.createCheck(r,n);const i=[];let s=0;for(const o of n)i[s++]=N1(o,t,r);return t.addBreakTokens?[new Z(U.array,n.length),i,new Z(U.break)]:[new Z(U.array,n.length),i]},Object(n,e,t,r){const i=e!=="Object",s=i?n.keys():Object.keys(n),o=i?n.size:s.length;if(!o)return t.addBreakTokens===!0?[Ys.emptyMap,new Z(U.break)]:Ys.emptyMap;r=Fw.createCheck(r,n);const a=[];let l=0;for(const c of s)a[l++]=[N1(c,t,r),N1(i?n.get(c):n[c],t,r)];return hK(a,t),t.addBreakTokens?[new Z(U.map,o),a,new Z(U.break)]:[new Z(U.map,o),a]}};Lo.Map=Lo.Object;Lo.Buffer=Lo.Uint8Array;for(const n of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Lo[`${n}Array`]=Lo.DataView;function N1(n,e={},t){const r=oH(n),i=e&&e.typeEncoders&&e.typeEncoders[r]||Lo[r];if(typeof i=="function"){const o=i(n,r,e,t);if(o!=null)return o}const s=Lo[r];if(!s)throw new Error(`${W0} unsupported type: ${r}`);return s(n,r,e,t)}function hK(n,e){e.mapSorter&&n.sort(e.mapSorter)}function fK(n,e){const t=Array.isArray(n[0])?n[0][0]:n[0],r=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==r.type)return t.type.compare(r.type);const i=t.type.major,s=GA[i].compareTokens(t,r);return s===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),s}function jA(n,e,t,r){if(Array.isArray(e))for(const i of e)jA(n,i,t,r);else t[e.type.major](n,e,r)}function pK(n,e,t){const r=N1(n,t);if(!Array.isArray(r)&&t.quickEncodeToken){const i=t.quickEncodeToken(r);if(i)return i;const s=e[r.type.major];if(s.encodedSize){const o=s.encodedSize(r,t),a=new FA(o);if(s(a,r,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${r} was wrong`);return c5(a.chunks[0])}}return Zg.reset(),jA(Zg,r,e,t),Zg.toBytes(!0)}function zw(n,e){return e=Object.assign({},uK,e),pK(n,GA,e)}const gK={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};let yK=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){const e=this.data[this._pos];let t=Qi[e];if(t===void 0){const r=X[e];if(!r)throw new Error(`${he} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);const i=e&31;t=r(this.data,this._pos,i,this.options)}return this._pos+=t.encodedLength,t}};const bh=Symbol.for("DONE"),_p=Symbol.for("BREAK");function mK(n,e,t){const r=[];for(let i=0;i<n.value;i++){const s=_h(e,t);if(s===_p){if(n.value===1/0)break;throw new Error(`${he} got unexpected break to lengthed array`)}if(s===bh)throw new Error(`${he} found array but not enough entries (got ${i}, expected ${n.value})`);r[i]=s}return r}function wK(n,e,t){const r=t.useMaps===!0,i=r?void 0:{},s=r?new Map:void 0;for(let o=0;o<n.value;o++){const a=_h(e,t);if(a===_p){if(n.value===1/0)break;throw new Error(`${he} got unexpected break to lengthed map`)}if(a===bh)throw new Error(`${he} found map but not enough entries (got ${o} [no key], expected ${n.value})`);if(r!==!0&&typeof a!="string")throw new Error(`${he} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(r&&s.has(a)||!r&&a in i))throw new Error(`${he} found repeat map key "${a}"`);const l=_h(e,t);if(l===bh)throw new Error(`${he} found map but not enough entries (got ${o} [no value], expected ${n.value})`);r?s.set(a,l):i[a]=l}return r?s:i}function _h(n,e){if(n.done())return bh;const t=n.next();if(t.type===U.break)return _p;if(t.type.terminal)return t.value;if(t.type===U.array)return mK(t,n,e);if(t.type===U.map)return wK(t,n,e);if(t.type===U.tag){if(e.tags&&typeof e.tags[t.value]=="function"){const r=_h(n,e);return e.tags[t.value](r)}throw new Error(`${he} tag not supported (${t.value})`)}throw new Error("unsupported")}function vK(n,e){if(!(n instanceof Uint8Array))throw new Error(`${he} data to decode must be a Uint8Array`);e=Object.assign({},gK,e);const t=e.tokenizer||new yK(n,e),r=_h(t,e);if(r===bh)throw new Error(`${he} did not find any content to decode`);if(r===_p)throw new Error(`${he} got unexpected break`);return[r,n.subarray(t.pos())]}function Pa(n,e){const[t,r]=vK(n,e);if(r.length>0)throw new Error(`${he} too many terminals, data makes no sense`);return t}const rs="/",YA=new TextEncoder().encode(rs),Yf=YA[0];class ot{constructor(e,t){h(this,"_buf");if(typeof e=="string")this._buf=Y(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Yf)throw new Error("Invalid key")}toString(e="utf8"){return ne(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new ot(e.join(rs))}static random(){return new ot(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new ot(e):typeof e.uint8Array=="function"?new ot(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=YA),this._buf[0]!==Yf){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Yf,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Yf;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),r=e.list();for(let i=0;i<t.length;i++){if(r.length<i+1)return!1;const s=t[i],o=r[i];if(s<o)return!0;if(s>o)return!1}return t.length<r.length}reverse(){return ot.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(rs).slice(1)}type(){return EK(this.baseNamespace())}name(){return bK(this.baseNamespace())}instance(e){return new ot(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(rs)||(e+=rs),e+=this.type(),new ot(e)}parent(){const e=this.list();return e.length===1?new ot(rs):new ot(e.slice(0,-1).join(rs))}child(e){return this.toString()===rs?e:e.toString()===rs?this:new ot(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return ot.withNamespaces([...this.namespaces(),..._K(e.map(t=>t.namespaces()))])}}function EK(n){const e=n.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function bK(n){const e=n.split(":");return e[e.length-1]}function _K(n){return[].concat(...n)}const QA="/pin/",Vw="/pinned-block/",Q4=_s,Hw=1;function Kw(n){return n.version===0&&(n=n.toV1()),new ot(`${QA}${n.toString(Q4)}`)}var ks,D1,X4;class SK{constructor(e,t,r){le(this,ks);h(this,"datastore");h(this,"blockstore");h(this,"dagWalkers");this.datastore=e,this.blockstore=t,this.dagWalkers=r}async*add(e,t={}){const r=Kw(e);if(await this.datastore.has(r))throw new Error("Already pinned");const i=Math.round(t.depth??1/0);if(i<0)throw new Error("Depth must be greater than or equal to 0");const s=new Oc({concurrency:Hw});for await(const a of Q(this,ks,D1).call(this,e,s,{...t,depth:i}))await Q(this,ks,X4).call(this,a,l=>l.pinnedBy.find(c=>Pe(c,e.bytes))!=null?!1:(l.pinCount++,l.pinnedBy.push(e.bytes),!0),t),yield a;const o={depth:i,metadata:t.metadata??{}};await this.datastore.put(r,zw(o),t)}async*rm(e,t={}){const r=Kw(e),i=await this.datastore.get(r,t),s=Pa(i);await this.datastore.delete(r,t);const o=new Oc({concurrency:Hw});for await(const a of Q(this,ks,D1).call(this,e,o,{...t,depth:s.depth}))await Q(this,ks,X4).call(this,a,l=>(l.pinCount--,l.pinnedBy=l.pinnedBy.filter(c=>Pe(c,e.bytes)),!0),{...t,depth:s.depth}),yield a}async*ls(e={}){for await(const{key:t,value:r}of this.datastore.query({prefix:QA+(e.cid!=null?`${e.cid.toString(_s)}`:"")},e)){const i=nt.parse(t.toString().substring(5),_s),s=Pa(r);yield{cid:i,...s}}}async isPinned(e,t={}){const r=new ot(`${Vw}${Q4.encode(e.multihash.bytes)}`);return this.datastore.has(r,t)}}ks=new WeakSet,D1=async function*(e,t,r){if(r.depth===-1)return;const i=this.dagWalkers[e.code];if(i==null)throw new Error(`No dag walker found for cid codec ${e.code}`);const s=await this.blockstore.get(e,r);yield e;for await(const o of i.walk(s))yield*await t.add(async()=>Q(this,ks,D1).call(this,o,t,{...r,depth:r.depth-1}))},X4=async function(e,t,r){var a;const i=new ot(`${Vw}${Q4.encode(e.multihash.bytes)}`);let s={pinCount:0,pinnedBy:[]};try{s=Pa(await this.datastore.get(i,r))}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}if(t(s)){if(s.pinCount===0&&await this.datastore.has(i)){await this.datastore.delete(i);return}await this.datastore.put(i,zw(s),r),(a=r.onProgress)==null||a.call(r,new se("helia:pin:add",e))}};const xK=5;class kK{constructor(e,t){h(this,"log");h(this,"routers");h(this,"providerLookupConcurrency");this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??xK}async start(){await gu(...this.routers)}async stop(){await yu(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new S("No content routers available","ERR_NO_ROUTERS_AVAILABLE");const r=new mu({concurrency:this.providerLookupConcurrency});r.addEventListener("error",()=>{});for await(const i of xo(r.toGenerator(),...vl(this.routers,"findProviders").map(s=>s.findProviders(e,t))))if(i!=null){if(i.multiaddrs.length===0){if(r.find(i.id)!=null)continue;r.add(async()=>{try{const s=await this.findPeer(i.id,t);return s.multiaddrs.length===0?null:s}catch(s){return this.log.error("could not load multiaddrs for peer %p",i.id,s),null}},{peerId:i.id,signal:t.signal}).catch(s=>{this.log.error("could not load multiaddrs for peer %p",i.id,s)})}yield i}}async provide(e,t={}){if(this.routers.length===0)throw new S("No content routers available","ERR_NO_ROUTERS_AVAILABLE");await Promise.all(vl(this.routers,"provide").map(async r=>{await r.provide(e,t)}))}async put(e,t,r){await Promise.all(vl(this.routers,"put").map(async i=>{await i.put(e,t,r)}))}async get(e,t){return Promise.any(vl(this.routers,"get").map(async r=>r.get(e,t)))}async findPeer(e,t){if(this.routers.length===0)throw new S("No peer routers available","ERR_NO_ROUTERS_AVAILABLE");const r=this,i=xo(...vl(this.routers,"findPeer").map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(o){r.log.error(o)}}()));for await(const s of i)if(s!=null)return s;throw new S("Could not find peer in routing","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new S("No peer routers available","ERR_NO_ROUTERS_AVAILABLE");for await(const r of xo(...vl(this.routers,"getClosestPeers").map(i=>i.getClosestPeers(e,t))))r!=null&&(yield r)}}function vl(n,e){return n.filter(t=>t[e]!=null)}var Ai;class XA extends EventTarget{constructor(){super();le(this,Ai,new Map)}listenerCount(t){const r=I(this,Ai).get(t);return r==null?0:r.length}addEventListener(t,r,i){super.addEventListener(t,r,i);let s=I(this,Ai).get(t);s==null&&(s=[],I(this,Ai).set(t,s)),s.push({callback:r,once:(i!==!0&&i!==!1&&(i==null?void 0:i.once))??!1})}removeEventListener(t,r,i){super.removeEventListener(t.toString(),r??null,i);let s=I(this,Ai).get(t);s!=null&&(s=s.filter(({callback:o})=>o!==r),I(this,Ai).set(t,s))}dispatchEvent(t){const r=super.dispatchEvent(t);let i=I(this,Ai).get(t.type);return i==null||(i=i.filter(({once:s})=>!s),I(this,Ai).set(t.type,i)),r}safeDispatchEvent(t,r={}){return this.dispatchEvent(new CustomEvent(t,r))}}Ai=new WeakMap;class JA extends Error{constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}h(JA,"name","QueueFullError");class RK{constructor(e){h(this,"deferred");h(this,"signal");var t;this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),(t=this.signal)==null||t.addEventListener("abort",this.onAbort)}onAbort(){var e;this.deferred.reject(((e=this.signal)==null?void 0:e.reason)??new Pc)}cleanup(){var e;(e=this.signal)==null||e.removeEventListener("abort",this.onAbort)}}function AK(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class IK{constructor(e,t){h(this,"id");h(this,"fn");h(this,"options");h(this,"recipients");h(this,"status");h(this,"timeline");h(this,"controller");this.id=AK(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>{var i;return t&&((i=r.signal)==null?void 0:i.aborted)===!0},!0)&&(this.controller.abort(new Pc),this.cleanup())}async join(e={}){var r;const t=new RK(e.signal);return this.recipients.push(t),(r=e.signal)==null||r.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Pt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{var t;e.cleanup(),(t=e.signal)==null||t.removeEventListener("abort",this.onAbort)})}}function Ww(n,e){let t;const r=function(){const i=function(){t=void 0,n()};clearTimeout(t),t=setTimeout(i,e)};return r.start=()=>{},r.stop=()=>{clearTimeout(t)},r}class Gw extends XA{constructor(t={}){super();h(this,"concurrency");h(this,"maxSize");h(this,"queue");h(this,"pending");h(this,"sort");h(this,"autoStart");this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=t.autoStart??!0,this.sort=t.sort,this.queue=[],this.emitEmpty=Ww(this.emitEmpty.bind(this),1),this.emitIdle=Ww(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let t;for(const r of this.queue)if(r.status==="queued"){t=r;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let r=0;r<this.queue.length;r++)if(this.queue[r]===t){this.queue.splice(r,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(t,r){var s;if((s=r==null?void 0:r.signal)==null||s.throwIfAborted(),this.size===this.maxSize)throw new JA;const i=new IK(t,r);return this.enqueue(i),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),i.join(r).then(o=>(this.safeDispatchEvent("success",{detail:{job:i,result:o}}),o)).catch(o=>{if(i.status==="queued"){for(let a=0;a<this.queue.length;a++)if(this.queue[a]===i){this.queue.splice(a,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:i,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new Pc)}),this.clear()}async onEmpty(t){this.size!==0&&await Nr(this,"empty",t==null?void 0:t.signal)}async onSizeLessThan(t,r){this.size<t||await Nr(this,"next",r==null?void 0:r.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await Nr(this,"idle",t==null?void 0:t.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){var c,u,d;(c=t==null?void 0:t.signal)==null||c.throwIfAborted();const r=Ko({objectMode:!0}),i=f=>{f!=null?this.abort():this.clear(),r.end(f)},s=f=>{f.detail!=null&&r.push(f.detail.result)},o=f=>{i(f.detail.error)},a=()=>{i()},l=()=>{i(new Pc("Queue aborted"))};this.addEventListener("success",s),this.addEventListener("failure",o),this.addEventListener("idle",a),(u=t==null?void 0:t.signal)==null||u.addEventListener("abort",l);try{yield*r}finally{this.removeEventListener("success",s),this.removeEventListener("failure",o),this.removeEventListener("idle",a),(d=t==null?void 0:t.signal)==null||d.removeEventListener("abort",l),i()}}}const ZA="lock:worker:request-read",eI="lock:worker:abort-read-request",tI="lock:worker:release-read",nI="lock:master:grant-read",rI="lock:master:error-read",iI="lock:worker:request-write",sI="lock:worker:abort-write-request",oI="lock:worker:release-write",aI="lock:master:grant-write",lI="lock:master:error-write",cI="lock:worker:finalize",uI="mortice",CK={singleProcess:!1},qw=(n,e,t,r,i,s,o,a,l)=>c=>{if(c.data==null)return;const u={type:c.data.type,name:c.data.name,identifier:c.data.identifier};u.type===i&&n.safeDispatchEvent(t,{detail:{name:u.name,identifier:u.identifier,handler:async()=>{e.postMessage({type:l,name:u.name,identifier:u.identifier}),await new Promise(d=>{const f=p=>{if((p==null?void 0:p.data)==null)return;const y={type:p.data.type,name:p.data.name,identifier:p.data.identifier};y.type===a&&y.identifier===u.identifier&&(e.removeEventListener("message",f),d())};e.addEventListener("message",f)})},onError:d=>{e.postMessage({type:o,name:u.name,identifier:u.identifier,error:{message:d.message,name:d.name,stack:d.stack}})}}}),u.type===s&&n.safeDispatchEvent(r,{detail:{name:u.name,identifier:u.identifier}}),u.type===cI&&n.safeDispatchEvent("finalizeRequest",{detail:{name:u.name}})},TK=(n=10)=>Math.random().toString().substring(2,n+2);class NK{constructor(e){h(this,"name");h(this,"channel");this.name=e,this.channel=new BroadcastChannel(uI)}readLock(e){return this.sendRequest(ZA,eI,nI,rI,tI,e)}writeLock(e){return this.sendRequest(iI,sI,aI,lI,oI,e)}finalize(){this.channel.postMessage({type:cI,name:this.name}),this.channel.close()}async sendRequest(e,t,r,i,s,o){var l;(l=o==null?void 0:o.signal)==null||l.throwIfAborted();const a=TK();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,u)=>{var p;const d=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};(p=o==null?void 0:o.signal)==null||p.addEventListener("abort",d,{once:!0});const f=y=>{var g,w,m,E;if(((g=y.data)==null?void 0:g.identifier)===a&&(((w=y.data)==null?void 0:w.type)===r&&(this.channel.removeEventListener("message",f),(m=o==null?void 0:o.signal)==null||m.removeEventListener("abort",d),c(()=>{this.channel.postMessage({type:s,identifier:a,name:this.name})})),y.data.type===i)){this.channel.removeEventListener("message",f),(E=o==null?void 0:o.signal)==null||E.removeEventListener("abort",d);const v=new Error;y.data.error!=null&&(v.message=y.data.error.message,v.name=y.data.error.name,v.stack=y.data.error.stack),u(v)}};this.channel.addEventListener("message",f)})}}const DK=n=>{if(n=Object.assign({},CK,n),!!globalThis.document||n.singleProcess){const t=new BroadcastChannel(uI),r=new XA;return t.addEventListener("message",qw(r,t,"requestReadLock","abortReadLockRequest",ZA,eI,rI,tI,nI)),t.addEventListener("message",qw(r,t,"requestWriteLock","abortWriteLockRequest",iI,sI,lI,oI,aI)),r}return new NK(n.name)},ma=new Map;let Zu;function dI(n){return typeof(n==null?void 0:n.readLock)=="function"&&typeof(n==null?void 0:n.writeLock)=="function"}function PK(n){if(Zu==null&&(Zu=DK(n),!dI(Zu))){const e=Zu;e.addEventListener("requestReadLock",t=>{const r=t.detail.name,i=t.detail.identifier,s=ma.get(r);if(s==null)return;const o=new AbortController,a=l=>{l.detail.name!==r||l.detail.identifier!==i||o.abort()};e.addEventListener("abortReadLockRequest",a),s.readLock({signal:o.signal}).then(async l=>{await t.detail.handler().finally(()=>{l()})}).catch(l=>{t.detail.onError(l)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{const r=t.detail.name,i=t.detail.identifier,s=ma.get(r);if(s==null)return;const o=new AbortController,a=l=>{l.detail.name!==r||l.detail.identifier!==i||o.abort()};e.addEventListener("abortWriteLockRequest",a),s.writeLock({signal:o.signal}).then(async l=>{await t.detail.handler().finally(()=>{l()})}).catch(l=>{t.detail.onError(l)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{const r=t.detail.name,i=ma.get(r);i!=null&&i.finalize()})}return Zu}async function e3(n,e){var o;let t,r;const i=new Promise((a,l)=>{t=a,r=l}),s=()=>{r(new Pc)};return(o=e==null?void 0:e.signal)==null||o.addEventListener("abort",s,{once:!0}),n.add(async()=>{await new Promise(a=>{t(()=>{var l;(l=e==null?void 0:e.signal)==null||l.removeEventListener("abort",s),a()})})},{signal:e==null?void 0:e.signal}).catch(a=>{r(a)}),i}const OK=(n,e)=>{let t=ma.get(n);if(t!=null)return t;const r=PK(e);if(dI(r))return t=r,ma.set(n,t),t;const i=new Gw({concurrency:1});let s;return t={async readLock(o){if(s!=null)return e3(s,o);s=new Gw({concurrency:e.concurrency,autoStart:!1});const a=s,l=e3(s,o);return i.add(async()=>{a.start(),await a.onIdle().then(()=>{s===a&&(s=null)})}),l},async writeLock(o){return s=null,e3(i,o)},finalize:()=>{ma.delete(n)},queue:i},ma.set(n,t),e.autoFinalize===!0&&i.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},LK={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function hI(n){const e=Object.assign({},LK,n);return OK(e.name,e)}class BK{constructor(e,t,r={}){h(this,"lock");h(this,"child");h(this,"pins");h(this,"started");this.child=e,this.pins=t,this.lock=hI({singleProcess:r.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await gu(this.child),this.started=!0}async stop(){await yu(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,r={}){var s;(s=r==null?void 0:r.signal)==null||s.throwIfAborted();const i=await this.lock.readLock();try{return await this.child.put(e,t,r)}finally{i()}}async*putMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{r()}}async get(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.readLock();try{return await this.child.get(e,t)}finally{r()}}async*getMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{r()}}async delete(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{r()}}async*deleteMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.writeLock();try{const s=this;yield*this.child.deleteMany(async function*(){for await(const o of e){if(await s.pins.isPinned(o))throw new Error("CID was pinned");yield o}}(),t)}finally{r()}}async has(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const r=await this.lock.readLock();try{return await this.child.has(e,t)}finally{r()}}async*getAll(e={}){var r;(r=e==null?void 0:e.signal)==null||r.throwIfAborted();const t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){var r;return(r=t==null?void 0:t.signal)==null||r.throwIfAborted(),this.child.createSession(e,t)}}const fI=42;function MK(n){return n instanceof ArrayBuffer?new Uint8Array(n,0,n.byteLength):n}function $K(n){if(n.asCID!==n&&n["/"]!==n.bytes)return null;const e=nt.asCID(n);if(!e)return null;const t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new Z(U.tag,fI),new Z(U.bytes,t)]}function UK(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function FK(n){if(Number.isNaN(n))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(n===1/0||n===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}function zK(n){for(const e of n.keys())if(typeof e!="string"||e.length===0)throw new Error("Non-string Map keys are not supported by the IPLD Data Model and cannot be encoded");return null}const VK={typeEncoders:{Map:zK,Object:$K,undefined:UK,number:FK}};({...VK.typeEncoders});function HK(n){if(n[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return nt.decode(n.subarray(1))}const q0={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};q0.tags[fI]=HK;({...q0,tags:q0.tags.slice()});const E5=113,pI=n=>Pa(MK(n),q0);let lle=class extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){const t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===U.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===U.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[U.uint.major](e,t){this.prefix(e);const r=String(t.value),i=[];for(let s=0;s<r.length;s++)i[s]=r.charCodeAt(s);e.push(i)}[U.negint.major](e,t){this[U.uint.major](e,t)}[U.bytes.major](e,t){throw new Error(`${W0} unsupported type: Uint8Array`)}[U.string.major](e,t){this.prefix(e);const r=$A(JSON.stringify(t.value));e.push(r.length>32?c5(r):r)}[U.array.major](e,t){this.prefix(e),this.inRecursive.push({type:U.array,elements:0}),e.push([91])}[U.map.major](e,t){this.prefix(e),this.inRecursive.push({type:U.map,elements:0}),e.push([123])}[U.tag.major](e,t){}[U.float.major](e,t){if(t.type.name==="break"){const o=this.inRecursive.pop();if(o){if(o.type===U.array)e.push([93]);else if(o.type===U.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${W0} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}const r=String(t.value),i=[];let s=!1;for(let o=0;o<r.length;o++)i[o]=r.charCodeAt(o),!s&&(i[o]===46||i[o]===101||i[o]===69)&&(s=!0);s||(i.push(46),i.push(48)),e.push(i)}},gI=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${he} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${he} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this._pos;let t=!1,r=!1;const i=a=>{for(;!this.done();){const l=this.ch();if(a.includes(l))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,r=!0;else return new Z(U.uint,0,this._pos-e);if(i([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${he} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(r)throw new Error(`${he} unexpected token at position ${this._pos}`);r=!0,this._pos++,i([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(r=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,i([48,49,50,51,52,53,54,55,56,57]));const s=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),o=parseFloat(s);return r?new Z(U.float,o,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new Z(o>=0?U.uint:U.negint,o,this._pos-e):new Z(o>=0?U.uint:U.negint,BigInt(s),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${he} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let s=this._pos,o=0;s<this.data.length&&o<65536;s++,o++){const a=this.data[s];if(a===92||a<32||a>=128)break;if(a===34){const l=String.fromCharCode.apply(null,this.data.subarray(this._pos,s));return this._pos=s+1,new Z(U.string,l,o)}}const e=this._pos,t=[],r=()=>{if(this._pos+4>=this.data.length)throw new Error(`${he} unexpected end of unicode escape sequence at position ${this._pos}`);let s=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${he} unexpected unicode escape character at position ${this._pos}`);s=s*16+a,this._pos++}return s},i=()=>{const s=this.ch();let o=null,a=s>239?4:s>223?3:s>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${he} unexpected unicode sequence at position ${this._pos}`);let l,c,u,d;switch(a){case 1:s<128&&(o=s);break;case 2:l=this.data[this._pos+1],(l&192)===128&&(d=(s&31)<<6|l&63,d>127&&(o=d));break;case 3:l=this.data[this._pos+1],c=this.data[this._pos+2],(l&192)===128&&(c&192)===128&&(d=(s&15)<<12|(l&63)<<6|c&63,d>2047&&(d<55296||d>57343)&&(o=d));break;case 4:l=this.data[this._pos+1],c=this.data[this._pos+2],u=this.data[this._pos+3],(l&192)===128&&(c&192)===128&&(u&192)===128&&(d=(s&15)<<18|(l&63)<<12|(c&63)<<6|u&63,d>65535&&d<1114112&&(o=d))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this._pos+=a};for(;!this.done();){const s=this.ch();let o;switch(s){case 92:if(this._pos++,this.done())throw new Error(`${he} unexpected string termination at position ${this._pos}`);switch(o=this.ch(),this._pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(r());break;default:throw new Error(`${he} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new Z(U.string,UA(t),this._pos-e);default:if(s<32)throw new Error(`${he} invalid control character at position ${this._pos}`);s<128?(t.push(s),this._pos++):i()}}throw new Error(`${he} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new Z(U.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new Z(U.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new Z(U.null,null,4);case 102:return this.expect([102,97,108,115,101]),new Z(U.false,!1,5);case 116:return this.expect([116,114,117,101]),new Z(U.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${he} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new Z(U.break,void 0,1);if(this.ch()!==44)throw new Error(`${he} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new Z(U.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new Z(U.break,void 0,1);if(this.ch()!==44)throw new Error(`${he} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new Z(U.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${he} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${he} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}};function KK(n,e){return e=Object.assign({tokenizer:new gI(n,e)},e),Pa(n,e)}const WK=297;new TextDecoder;new TextEncoder;const GK=new TextDecoder;function b5(n,e){let t=0;for(let r=0;;r+=7){if(r>=64)throw new Error("protobuf: varint overflow");if(e>=n.length)throw new Error("protobuf: unexpected end of data");const i=n[e++];if(t+=r<28?(i&127)<<r:(i&127)*2**r,i<128)break}return[t,e]}function j0(n,e){let t;[t,e]=b5(n,e);const r=e+t;if(t<0||r<0)throw new Error("protobuf: invalid length");if(r>n.length)throw new Error("protobuf: unexpected end of data");return[n.subarray(e,r),r]}function yI(n,e){let t;return[t,e]=b5(n,e),[t&7,t>>3,e]}function qK(n){const e={},t=n.length;let r=0;for(;r<t;){let i,s;if([i,s,r]=yI(n,r),s===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,r]=j0(n,r)}else if(s===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,r]=j0(n,r),e.Name=GK.decode(o)}else if(s===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(i!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Tsize`);[e.Tsize,r]=b5(n,r)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${s}`)}if(r>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function jK(n){const e=n.length;let t=0,r,i=!1,s;for(;t<e;){let a,l;if([a,l,t]=yI(n,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(l===1){if(s)throw new Error("protobuf: (PBNode) duplicate Data section");[s,t]=j0(n,t),r&&(i=!0)}else if(l===2){if(i)throw new Error("protobuf: (PBNode) duplicate Links section");r||(r=[]);let c;[c,t]=j0(n,t),r.push(qK(c))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${l}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");const o={};return s&&(o.Data=s),o.Links=r||[],o}const mI=new TextEncoder,jw=2**32,YK=2**31;function QK(n,e){let t=e.length;if(typeof n.Tsize=="number"){if(n.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(n.Tsize))throw new Error("Tsize too large for encoding");t=Dd(e,t,n.Tsize)-1,e[t]=24}if(typeof n.Name=="string"){const r=mI.encode(n.Name);t-=r.length,e.set(r,t),t=Dd(e,t,r.length)-1,e[t]=18}return n.Hash&&(t-=n.Hash.length,e.set(n.Hash,t),t=Dd(e,t,n.Hash.length)-1,e[t]=10),e.length-t}function XK(n){const e=ZK(n),t=new Uint8Array(e);let r=e;if(n.Data&&(r-=n.Data.length,t.set(n.Data,r),r=Dd(t,r,n.Data.length)-1,t[r]=10),n.Links)for(let i=n.Links.length-1;i>=0;i--){const s=QK(n.Links[i],t.subarray(0,r));r-=s,r=Dd(t,r,s)-1,t[r]=18}return t}function JK(n){let e=0;if(n.Hash){const t=n.Hash.length;e+=1+t+rc(t)}if(typeof n.Name=="string"){const t=mI.encode(n.Name).length;e+=1+t+rc(t)}return typeof n.Tsize=="number"&&(e+=1+rc(n.Tsize)),e}function ZK(n){let e=0;if(n.Data){const t=n.Data.length;e+=1+t+rc(t)}if(n.Links)for(const t of n.Links){const r=JK(t);e+=1+r+rc(r)}return e}function Dd(n,e,t){e-=rc(t);const r=e;for(;t>=YK;)n[e++]=t&127|128,t/=128;for(;t>=128;)n[e++]=t&127|128,t>>>=7;return n[e]=t,r}function rc(n){return n%2===0&&n++,Math.floor((eW(n)+6)/7)}function eW(n){let e=0;return n>=jw&&(n=Math.floor(n/jw),e=32),n>=65536&&(n>>>=16,e+=16),n>=256&&(n>>>=8,e+=8),e+tW[n]}const tW=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],nW=["Data","Links"],rW=["Hash","Name","Tsize"],J4=new TextEncoder;function wI(n,e){if(n===e)return 0;const t=n.Name?J4.encode(n.Name):[],r=e.Name?J4.encode(e.Name):[];let i=t.length,s=r.length;for(let o=0,a=Math.min(i,s);o<a;++o)if(t[o]!==r[o]){i=t[o],s=r[o];break}return i<s?-1:s<i?1:0}function Yw(n,e){return!Object.keys(n).some(t=>!e.includes(t))}function vI(n){if(typeof n.asCID=="object"){const t=nt.asCID(n);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof n!="object"||Array.isArray(n))throw new TypeError("Invalid DAG-PB form");const e={};if(n.Hash){let t=nt.asCID(n.Hash);try{t||(typeof n.Hash=="string"?t=nt.parse(n.Hash):n.Hash instanceof Uint8Array&&(t=nt.decode(n.Hash)))}catch(r){throw new TypeError(`Invalid DAG-PB form: ${r.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof n.Name=="string"&&(e.Name=n.Name),typeof n.Tsize=="number"&&(e.Tsize=n.Tsize),e}function hr(n){if((n instanceof Uint8Array||typeof n=="string")&&(n={Data:n}),typeof n!="object"||Array.isArray(n))throw new TypeError("Invalid DAG-PB form");const e={};if(n.Data!==void 0)if(typeof n.Data=="string")e.Data=J4.encode(n.Data);else if(n.Data instanceof Uint8Array)e.Data=n.Data;else throw new TypeError("Invalid DAG-PB form");if(n.Links!==void 0)if(Array.isArray(n.Links))e.Links=n.Links.map(vI),e.Links.sort(wI);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function EI(n){if(!n||typeof n!="object"||Array.isArray(n)||n instanceof Uint8Array||n["/"]&&n["/"]===n.bytes)throw new TypeError("Invalid DAG-PB form");if(!Yw(n,nW))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(n.Data!==void 0&&!(n.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(n.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<n.Links.length;e++){const t=n.Links[e];if(!t||typeof t!="object"||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!Yw(t,rW))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(t.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash==null||!t.Hash["/"]||t.Hash["/"]!==t.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0){if(typeof t.Tsize!="number"||t.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&wI(t,n.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function iW(n,e=[]){return hr({Data:n,Links:e})}function sW(n,e,t){return vI({Hash:t,Name:n,Tsize:e})}function oW(n){return n instanceof ArrayBuffer?new Uint8Array(n,0,n.byteLength):n}const aW="dag-pb",fi=112;function Rt(n){EI(n);const e={};return n.Links&&(e.Links=n.Links.map(t=>{const r={};return t.Hash&&(r.Hash=t.Hash.bytes),t.Name!==void 0&&(r.Name=t.Name),t.Tsize!==void 0&&(r.Tsize=t.Tsize),r})),n.Data&&(e.Data=n.Data),XK(e)}function yr(n){const e=oW(n),t=jK(e),r={};return t.Data&&(r.Data=t.Data),t.Links&&(r.Links=t.Links.map(i=>{const s={};try{s.Hash=nt.decode(i.Hash)}catch{}if(!s.Hash)throw new Error("Invalid Hash field found in link, expected CID");return i.Name!==void 0&&(s.Name=i.Name),i.Tsize!==void 0&&(s.Tsize=i.Tsize),s})),r}const Sp=Object.freeze(Object.defineProperty({__proto__:null,code:fi,createLink:sW,createNode:iW,decode:yr,encode:Rt,name:aW,prepare:hr,validate:EI},Symbol.toStringTag,{value:"Module"})),lW={codec:fi,*walk(n){yield*yr(n).Links.map(t=>t.Hash)}},cW={codec:ek,*walk(){}},bI=42,uW={codec:E5,*walk(n){const e=[],t=[];t[bI]=r=>{if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");const i=nt.decode(r.subarray(1));return e.push(i),i},Pa(n,{tags:t}),yield*e}};let dW=class extends gI{constructor(t,r){super(t,r);h(this,"tokenBuffer");this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const t=this._next();if(t.type===U.map){const r=this._next();if(r.type===U.string&&r.value==="/"){const i=this._next();if(i.type===U.string){if(this._next().type!==U.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(i),new Z(U.tag,42,0)}if(i.type===U.map){const s=this._next();if(s.type===U.string&&s.value==="bytes"){const o=this._next();if(o.type===U.string){for(let l=0;l<2;l++)if(this._next().type!==U.break)throw new Error("Invalid encoded Bytes form");const a=ar.decode(`m${o.value}`);return new Z(U.bytes,a,o.value.length)}this.tokenBuffer.push(o)}this.tokenBuffer.push(s)}this.tokenBuffer.push(i)}this.tokenBuffer.push(r)}return t}};const hW={codec:WK,*walk(n){const e=[],t=[];t[bI]=r=>{const i=nt.parse(r);return e.push(i),i},KK(n,{tags:t,tokenizer:new dW(n,{tags:t,allowIndefinite:!0,allowUndefined:!0,allowNaN:!0,allowInfinity:!0,allowBigInt:!0,strict:!1,rejectDuplicateMapKeys:!1})}),yield*e}},fW={codec:cU,*walk(){}};function pW(n=[]){const e={};return[lW,cW,uW,hW,fW,...n].forEach(t=>{e[t.codec]=t}),e}const t3=new ot("/version"),Qw=1;async function gW(n){if(!await n.has(t3)){await n.put(t3,Y(`${Qw}`));return}const e=await n.get(t3),t=ne(e);if(parseInt(t,10)!==Qw)throw new Error("Unknown datastore version, a datastore migration may be required")}function yW(n=[]){const e={};return[nn,NU,Po,...n].forEach(t=>{e[t.code]=t}),e}class _I{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(const{cid:r,block:i}of e)await this.put(r,i,t),yield r}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(const r of e)yield{cid:r,block:await this.get(r,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(const r of e)await this.delete(r,t),yield r}async*getAll(e){throw new Error(".getAll is not implemented")}}function Xw(n,e){for(const t in e)Object.defineProperty(n,t,{value:e[t],enumerable:!0,configurable:!0});return n}function mW(n,e,t){if(!n||typeof n=="string")throw new TypeError("Please pass an Error to err-code");t||(t={}),typeof e=="object"&&(t=e,e=""),e&&(t.code=e);try{return Xw(n,t)}catch{t.message=n.message,t.stack=n.stack;const i=function(){};return i.prototype=Object.create(Object.getPrototypeOf(n)),Xw(new i,t)}}var wW=mW;const at=ci(wW);function vW(n){return n=n??new Error("Open failed"),at(n,"ERR_OPEN_FAILED")}function EW(n){return n=n??new Error("Close failed"),at(n,"ERR_CLOSE_FAILED")}function bW(n){return n=n??new Error("Put failed"),at(n,"ERR_PUT_FAILED")}function _W(n){return n=n??new Error("Get failed"),at(n,"ERR_GET_FAILED")}function SW(n){return n=n??new Error("Delete failed"),at(n,"ERR_DELETE_FAILED")}function xW(n){return n=n??new Error("Has failed"),at(n,"ERR_HAS_FAILED")}function SI(n){return n=n??new Error("Not Found"),at(n,"ERR_NOT_FOUND")}function kW(n){return n=n??new Error("Aborted"),at(n,"ERR_ABORTED")}const RW=Object.freeze(Object.defineProperty({__proto__:null,abortedError:kW,closeFailedError:EW,deleteFailedError:SW,getFailedError:_W,hasFailedError:xW,notFoundError:SI,openFailedError:vW,putFailedError:bW},Symbol.toStringTag,{value:"Module"}));class AW extends _I{constructor(){super();h(this,"data");this.data=new Map}put(t,r){return this.data.set(Hn.encode(t.multihash.bytes),r),t}get(t){const r=this.data.get(Hn.encode(t.multihash.bytes));if(r==null)throw SI();return r}has(t){return this.data.has(Hn.encode(t.multihash.bytes))}async delete(t){this.data.delete(Hn.encode(t.multihash.bytes))}async*getAll(){for(const[t,r]of this.data.entries())yield{cid:nt.createV1(ek,vu(Hn.decode(t))),block:r}}}function IW(n){return n[Symbol.asyncIterator]!=null}function oa(n,e){let t=0;if(IW(n))return async function*(){for await(const l of n)await e(l,t++)&&(yield l)}();const r=x6(n),{value:i,done:s}=r.next();if(s===!0)return function*(){}();const o=e(i,t++);if(typeof o.then=="function")return async function*(){await o&&(yield i);for(const l of r)await e(l,t++)&&(yield l)}();const a=e;return function*(){o===!0&&(yield i);for(const l of r)a(l,t++)&&(yield l)}()}Su("blockstore:core:tiered");const CW={...RW},Qf=0;class TW extends _I{constructor(t){super();h(this,"child");this.child=t}put(t,r){return t.multihash.code===Qf||this.child==null?t:this.child.put(t,r)}get(t){if(t.multihash.code===Qf)return t.multihash.digest;if(this.child==null)throw CW.notFoundError();return this.child.get(t)}has(t){return t.multihash.code===Qf?!0:this.child==null?!1:this.child.has(t)}delete(t){if(t.code!==Qf&&this.child!=null)return this.child.delete(t)}getAll(t){return this.child!=null?this.child.getAll(t):[]}}function NW(n){return n[Symbol.asyncIterator]!=null}function Jw(n){return(n==null?void 0:n.then)!=null}function Z4(n,e){let t=0;if(NW(n))return async function*(){for await(const l of n){const c=e(l,t++);Jw(c)&&await c,yield l}}();const r=x6(n),{value:i,done:s}=r.next();if(s===!0)return function*(){}();const o=e(i,t++);if(typeof(o==null?void 0:o.then)=="function")return async function*(){yield i;for(const l of r){const c=e(l,t++);Jw(c)&&await c,yield l}}();const a=e;return function*(){yield i;for(const l of r)a(l,t++),yield l}()}class xI{constructor(e){h(this,"child");h(this,"hashers");h(this,"log");h(this,"logger");h(this,"components");this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new TW(e.blockstore),this.hashers=e.hashers??{}}async put(e,t,r={}){var i,s,o;return await this.child.has(e,r)?((i=r.onProgress)==null||i.call(r,new se("blocks:put:duplicate",e)),e):((s=r.onProgress)==null||s.call(r,new se("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async a=>{var l;return(l=a.announce)==null?void 0:l.call(a,e,t,r)})),(o=r.onProgress)==null||o.call(r,new se("blocks:put:blockstore:put",e)),this.child.put(e,t,r))}async*putMany(e,t={}){var s;const r=oa(e,async({cid:o})=>{var l;const a=await this.child.has(o,t);return a&&((l=t.onProgress)==null||l.call(t,new se("blocks:put-many:duplicate",o))),!a}),i=Z4(r,async({cid:o,block:a})=>{var l;(l=t.onProgress)==null||l.call(t,new se("blocks:put-many:providers:notify",o)),await Promise.all(this.components.blockBrokers.map(async c=>{var u;return(u=c.announce)==null?void 0:u.call(c,o,a,t)}))});(s=t.onProgress)==null||s.call(t,new se("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(i,t)}async get(e,t={}){var r,i,s,o;if(t.offline!==!0&&!await this.child.has(e,t)){(r=t.onProgress)==null||r.call(t,new se("blocks:get:providers:get",e));const a=await Zw(e,this.components.blockBrokers,this.hashers[e.multihash.code],{...t,log:this.log});return(i=t.onProgress)==null||i.call(t,new se("blocks:get:blockstore:put",e)),await this.child.put(e,a,t),(s=t.onProgress)==null||s.call(t,new se("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async l=>{var c;return(c=l.announce)==null?void 0:c.call(l,e,a,t)})),a}return(o=t.onProgress)==null||o.call(t,new se("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){var r;(r=t.onProgress)==null||r.call(t,new se("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(Z4(e,async i=>{var s,o,a;if(t.offline!==!0&&!await this.child.has(i,t)){(s=t.onProgress)==null||s.call(t,new se("blocks:get-many:providers:get",i));const l=await Zw(i,this.components.blockBrokers,this.hashers[i.multihash.code],{...t,log:this.log});(o=t.onProgress)==null||o.call(t,new se("blocks:get-many:blockstore:put",i)),await this.child.put(i,l,t),(a=t.onProgress)==null||a.call(t,new se("blocks:get-many:providers:notify",i)),await Promise.all(this.components.blockBrokers.map(async c=>{var u;return(u=c.announce)==null?void 0:u.call(c,i,l,t)}))}}))}async delete(e,t={}){var r;(r=t.onProgress)==null||r.call(t,new se("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){var r;(r=t.onProgress)==null||r.call(t,new se("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(const i of e)yield i}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){var t;(t=e.onProgress)==null||t.call(e,new se("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}}class DW extends xI{constructor(t){super(t);h(this,"started");this.started=!1}isStarted(){return this.started}async start(){await gu(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await yu(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(t,r){const i=this.components.blockBrokers.map(s=>s.createSession==null?s:s.createSession(r));return new PW({blockstore:this.child,blockBrokers:i,hashers:this.hashers,logger:this.logger},{root:t})}}class PW extends xI{constructor(t,r){super(t);h(this,"closeController");this.closeController=new AbortController,ue(1/0,this.closeController.signal),this.log=t.logger.forComponent(`helia:session-storage:${r.root}`)}close(){this.closeController.abort()}async put(t,r,i={}){const s=bt([this.closeController.signal,i.signal]);ue(1/0,s);try{return await super.put(t,r,{...i,signal:s})}finally{s.clear()}}async*putMany(t,r={}){const i=bt([this.closeController.signal,r.signal]);ue(1/0,i);try{yield*super.putMany(t,{...r,signal:i})}finally{i.clear()}}async get(t,r={}){const i=bt([this.closeController.signal,r.signal]);ue(1/0,i);try{return await super.get(t,{...r,signal:i})}finally{i.clear()}}async*getMany(t,r={}){const i=bt([this.closeController.signal,r.signal]);ue(1/0,i);try{yield*super.getMany(t,{...r,signal:i})}finally{i.clear()}}async delete(t,r={}){const i=bt([this.closeController.signal,r.signal]);ue(1/0,i);try{await super.delete(t,{...r,signal:i})}finally{i.clear()}}async*deleteMany(t,r={}){const i=bt([this.closeController.signal,r.signal]);ue(1/0,i);try{yield*super.deleteMany(t,{...r,signal:i})}finally{i.clear()}}async has(t,r={}){const i=bt([this.closeController.signal,r.signal]);ue(1/0,i);try{return await super.has(t,{...r,signal:i})}finally{i.clear()}}async*getAll(t={}){const r=bt([this.closeController.signal,t.signal]);ue(1/0,r);try{yield*super.getAll({...t,signal:r})}finally{r.clear()}}}function OW(n){return typeof n.retrieve=="function"}const LW=(n,e)=>{if(e==null)throw new S(`No hasher configured for multihash code 0x${n.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`,"ERR_UNKNOWN_HASH_ALG");return async t=>{const r=await e.digest(t);if(!Pe(r.digest,n.multihash.digest))throw new S("Hash of downloaded block did not match multihash from passed CID","ERR_HASH_MISMATCH")}};async function Zw(n,e,t,r){const i=LW(n,t),s=new AbortController,o=bt([s.signal,r.signal]);ue(1/0,s.signal,o);const a=[];for(const l of e)OW(l)&&a.push(l);try{return await Promise.any(a.map(async l=>{try{let c=!1;const u=await l.retrieve(n,{...r,signal:o,validateFn:async d=>{await i(d),c=!0}});return c||await i(u),u}catch(c){throw r.log.error("could not retrieve verified block for %c",n,c),c}}))}finally{s.abort(),o.clear()}}const BW=1,MW=5,$W=Math.LN2*Math.LN2;class _5{constructor(e={}){h(this,"seeds");h(this,"bits");h(this,"buffer");e.seeds!=null?this.seeds=e.seeds:this.seeds=FW(e.hashes??8),this.bits=e.bits??1024,this.buffer=Xe(Math.ceil(this.bits/8))}static create(e,t=.005){const r=UW(e,t);return new _5(r)}add(e){typeof e=="string"&&(e=Y(e));for(let t=0;t<this.seeds.length;t++){const i=wh.x86.hash32(e,this.seeds[t])%this.bits;this.setbit(i)}}has(e){typeof e=="string"&&(e=Y(e));for(let t=0;t<this.seeds.length;t++){const i=wh.x86.hash32(e,this.seeds[t])%this.bits;if(!this.getbit(i))return!1}return!0}clear(){this.buffer.fill(0)}setbit(e){let t=0,r=e;for(;r>7;)t++,r-=8;let i=this.buffer[t];i|=1<<r,this.buffer[t]=i}getbit(e){let t=0,r=e;for(;r>7;)t++,r-=8;return(this.buffer[t]&1<<r)!==0}}function UW(n,e=.005){const t=Math.round(-1*n*Math.log(e)/$W),r=Math.round(t/n*Math.LN2);return{bits:t,hashes:r}}function FW(n){let e,t;const r=[];for(let i=0;i<n;i++)for(e=new Fe(Yi(4)),r[i]=e.getUint32(0,!0),t=0;t<i;t++)if(r[i]===r[t]){i--;break}return r}class kI extends tn{constructor(t,r){super();h(this,"intialPeerSearchComplete");h(this,"requests");h(this,"name");h(this,"log");h(this,"logger");h(this,"minProviders");h(this,"maxProviders");h(this,"providers");h(this,"evictionFilter");ue(1/0,this),this.name=r.name,this.logger=t.logger,this.log=t.logger.forComponent(this.name),this.requests=new Map,this.minProviders=r.minProviders??BW,this.maxProviders=r.maxProviders??MW,this.providers=[],this.evictionFilter=_5.create(this.maxProviders)}async retrieve(t,r={}){const i=ar.encode(t.multihash.bytes),s=this.requests.get(i);if(s!=null)return this.log("join existing request for %c",t),s;const o=Se();if(this.requests.set(i,o.promise),this.providers.length===0){let u=!1;this.intialPeerSearchComplete==null&&(u=!0,this.log=this.logger.forComponent(`${this.name}:${t}`),this.intialPeerSearchComplete=this.findProviders(t,this.minProviders,r)),await this.intialPeerSearchComplete,u&&this.log("found initial session peers for %c",t)}let a=!1;const l=new Oc({concurrency:this.maxProviders});l.addEventListener("error",()=>{}),l.addEventListener("failure",u=>{this.log.error("error querying provider %o, evicting from session",u.detail.job.options.provider,u.detail.error),this.evict(u.detail.job.options.provider)}),l.addEventListener("success",u=>{a=!0,o.resolve(u.detail.result)}),l.addEventListener("idle",()=>{var u;a||((u=r.signal)==null?void 0:u.aborted)===!0||Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",t);for(let d=0;d<this.minProviders&&this.providers.length!==0;d++){const f=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(f)}await this.findProviders(t,this.minProviders,r),this.log("found new providers re-retrieving %c",t),this.requests.delete(i),o.resolve(await this.retrieve(t,r))}).catch(d=>{this.log.error("could not find new providers for %c",t,d),o.reject(d)})});const c=u=>{l.add(async()=>this.queryProvider(t,u.detail,r),{provider:u.detail}).catch(d=>{var f;((f=r.signal)==null?void 0:f.aborted)!==!0&&this.log.error("error retrieving session block for %c",t,d)})};this.addEventListener("provider",c),Promise.all([...this.providers].map(async u=>l.add(async()=>this.queryProvider(t,u,r),{provider:u}))).catch(u=>{var d;((d=r.signal)==null?void 0:d.aborted)!==!0&&this.log.error("error retrieving session block for %c",t,u)});try{return await o.promise}finally{this.removeEventListener("provider",c),l.clear(),this.requests.delete(i)}}evict(t){this.evictionFilter.add(this.toEvictionKey(t));const r=this.providers.findIndex(i=>this.equals(i,t));r!==-1&&this.providers.splice(r,1)}isEvicted(t){return this.evictionFilter.has(this.toEvictionKey(t))}hasProvider(t){return!!(this.providers.find(r=>this.equals(r,t))!=null||this.isEvicted(t))}async findProviders(t,r,i){const s=Se();let o=0;return Promise.resolve().then(async()=>{var a;this.log("finding %d-%d new provider(s) for %c",r,this.maxProviders,t);for await(const l of this.findNewProviders(t,i)){if(o===this.maxProviders||((a=i.signal)==null?void 0:a.aborted)===!0)break;if(!this.hasProvider(l)&&(this.log("found %d/%d new providers",o,this.maxProviders),this.providers.push(l),this.safeDispatchEvent("provider",{detail:l}),o++,o===r&&(this.log("session is ready"),s.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",o);break}}if(this.log("found %d/%d new session peers",o,this.maxProviders),o<r)throw new S(`Found ${o} of ${r} ${this.name} providers for ${t}`,"ERR_INSUFFICIENT_PROVIDERS_FOUND")}).catch(a=>{this.log.error("error searching routing for potential session peers for %c",t,a.errors??a),s.reject(a)}),s.promise}}class zW{constructor(e){h(this,"blockstore");h(this,"datastore");h(this,"pins");h(this,"logger");h(this,"routing");h(this,"dagWalkers");h(this,"hashers");h(this,"dns");h(this,"metrics");h(this,"log");this.logger=e.logger??wp(),this.log=this.logger.forComponent("helia"),this.hashers=yW(e.hashers),this.dagWalkers=pW(e.dagWalkers),this.dns=e.dns??MA(),this.metrics=e.metrics;const t={blockstore:e.blockstore,datastore:e.datastore,hashers:this.hashers,dagWalkers:this.dagWalkers,logger:this.logger,blockBrokers:[],dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new kK(t,{routers:(e.routers??[]).flatMap(i=>{const s=[i];return i[Cc]!=null&&s.push(i[Cc]),i[Tc]!=null&&s.push(i[Tc]),s}),providerLookupConcurrency:e.providerLookupConcurrency});const r=new DW(t);this.pins=new SK(e.datastore,r,this.dagWalkers),this.blockstore=new BK(r,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(i=>i(t))}async start(){await gW(this.datastore),await gu(this.blockstore,this.datastore,this.routing)}async stop(){await yu(this.blockstore,this.datastore,this.routing)}async gc(e={}){const t=await this.blockstore.lock.writeLock();try{const r=this,i=this.blockstore.unwrap();this.log("gc start"),await Fa(i.deleteMany(async function*(){var s,o;for await(const{cid:a}of i.getAll())try{if(await r.pins.isPinned(a,e))continue;yield a,(s=e.onProgress)==null||s.call(e,new se("helia:gc:deleted",a))}catch(l){r.log.error("Error during gc",l),(o=e.onProgress)==null||o.call(e,new se("helia:gc:error",l))}}()))}finally{t()}this.log("gc finished")}}class VW extends kI{constructor(t,r){super(t,{...r,name:"helia:bitswap:session"});h(this,"wantList");h(this,"network");this.wantList=t.wantList,this.network=t.network}async queryProvider(t,r,i){this.log("sending WANT-BLOCK for %c to %p",t,r);const s=await this.wantList.wantSessionBlock(t,r,i);if(this.log("%p %s %c",r,s.has?"has":"does not have",t),s.has&&s.block!=null)return s.block;throw new Error("Provider did not have block")}async*findNewProviders(t,r={}){for await(const i of this.network.findProviders(t,r))yield i.id}toEvictionKey(t){return t.toBytes()}equals(t,r){return t.equals(r)}}function HW(n,e){return new VW(n,e)}class KW{constructor(e){h(this,"blocksReceived");h(this,"duplicateBlocksReceived");h(this,"dataReceived");h(this,"duplicateDataReceived");var t,r,i,s;this.blocksReceived=(t=e.metrics)==null?void 0:t.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=(r=e.metrics)==null?void 0:r.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=(i=e.metrics)==null?void 0:i.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=(s=e.metrics)==null?void 0:s.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){var i;const r={global:e};t!=null&&(r[t.toString()]=e),(i=this.blocksReceived)==null||i.increment(r)}updateDuplicateBlocksReceived(e=1,t){var i;const r={global:e};t!=null&&(r[t.toString()]=e),(i=this.duplicateBlocksReceived)==null||i.increment(r)}updateDataReceived(e,t){var i;const r={global:e};t!=null&&(r[t.toString()]=e),(i=this.dataReceived)==null||i.increment(r)}updateDuplicateDataReceived(e,t){var i;const r={global:e};t!=null&&(r[t.toString()]=e),(i=this.duplicateDataReceived)==null||i.increment(r)}}class WW extends Map{constructor(t){super();h(this,"metric");const{name:r,metrics:i}=t;this.metric=i.registerMetric(r),this.updateComponentMetric()}set(t,r){return super.set(t,r),this.updateComponentMetric(),this}delete(t){const r=super.delete(t);return this.updateComponentMetric(),r}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function RI(n){const{name:e,metrics:t}=n;let r;return t!=null?r=new WW({name:e,metrics:t}):r=new Map,r}function GW(n){if(!(n instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const e=[];for(;n.length>0;){const t=wu(n);e.push(t),n=n.slice(ht(t))}return e}class qW extends tn{constructor(t,r={}){super();h(this,"peers");h(this,"wants");h(this,"network");h(this,"log");h(this,"sendMessagesDelay");h(this,"sendMessagesTimeout");h(this,"hashLoader");h(this,"sendingMessages");ue(1/0,this),this.peers=xA({name:"helia_bitswap_peers",metrics:t.metrics}),this.wants=RI({name:"helia_bitswap_wantlist",metrics:t.metrics}),this.network=t.network,this.sendMessagesDelay=r.sendMessagesDelay??e$,this.log=t.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=r.hashLoader,this.network.addEventListener("bitswap:message",i=>{this.receiveMessage(i.detail.peer,i.detail.message).catch(s=>{this.log.error("error receiving bitswap message from %p",i.detail.peer,s)})}),this.network.addEventListener("peer:connected",i=>{this.peerConnected(i.detail).catch(s=>{this.log.error("error processing newly connected bitswap peer %p",i.detail,s)})}),this.network.addEventListener("peer:disconnected",i=>{this.peerDisconnected(i.detail)})}async addEntry(t,r){var o;const i=ne(t.multihash.bytes,"base64");let s=this.wants.get(i);s==null&&(s={cid:t,priority:r.priority??1,wantType:r.wantType??zt.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(i,s)),s.wantType===zt.WantHave&&r.wantType===zt.WantBlock&&(s.wantType=zt.WantBlock),await this.sendMessagesDebounced();try{return r.wantType===zt.WantBlock?(await Nr(this,"block",r==null?void 0:r.signal,{filter:c=>Pe(t.multihash.digest,c.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await Nr(this,"presence",r==null?void 0:r.signal,{filter:l=>Pe(t.multihash.digest,l.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{((o=r.signal)==null?void 0:o.aborted)===!0&&(this.log("want for %c was aborted, cancelling want",t),s.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){var t;await((t=this.sendingMessages)==null?void 0:t.promise),clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(r=>{this.log("error sending messages to peers",r)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=Se(),await Promise.all([...this.peers.entries()].map(async([t,r])=>{const i=new Set,s=new hd;for(const[o,a]of this.wants.entries())r.has(o)||a.cancel||(i.add(o),s.addWantlistEntry(a.cid,{cid:a.cid.bytes,priority:a.priority,wantType:a.wantType,cancel:a.cancel,sendDontHave:a.sendDontHave}));if(s.wantlist.size!==0)try{await this.network.sendMessage(t,s);for(const o of i)r.add(o)}catch(o){this.log.error("error sending full wantlist to new peer",o)}})).catch(t=>{this.log.error("error sending messages",t)});for(const[t,r]of this.wants)if(r.cancel){this.wants.delete(t);for(const i of this.peers.values())i.delete(t)}this.sendingMessages.resolve()}has(t){const r=ne(t.multihash.bytes,"base64");return this.wants.has(r)}async wantSessionPresence(t,r,i={}){const s=new hd;return s.addWantlistEntry(t,{cid:t.bytes,sendDontHave:!0,wantType:zt.WantHave,priority:1}),await this.network.sendMessage(r,s),(await Nr(this,"presence",i.signal,{filter:a=>r.equals(a.detail.sender)&&Pe(t.multihash.digest,a.detail.cid.multihash.digest)})).detail}async wantBlock(t,r={}){return this.addEntry(t,{...r,wantType:zt.WantBlock})}async wantSessionBlock(t,r,i={}){const s=new hd;return s.addWantlistEntry(t,{cid:t.bytes,sendDontHave:!0,wantType:zt.WantBlock,priority:1}),await this.network.sendMessage(r,s),(await Nr(this,"presence",i.signal,{filter:a=>r.equals(a.detail.sender)&&Pe(t.multihash.digest,a.detail.cid.multihash.digest)})).detail}async receivedBlock(t,r){const i=ne(t.multihash.bytes,"base64"),s=this.wants.get(i);s!=null&&(s.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(t,r){var s;this.log("received message from %p with %d blocks",t,r.blocks.length);let i=!1;for(const o of r.blocks){if(o.prefix==null||o.data==null)continue;const a=GW(o.prefix),l=a[0],c=a[1],u=a[2],d=u===nn.code?nn:await((s=this.hashLoader)==null?void 0:s.getHasher(u));if(d==null){this.log.error("unknown hash algorithm",u);continue}let f=d.digest(o.data);f.then!=null&&(f=await f);const p=nt.create(l===0?0:1,c,f);this.log("received block from %p for %c",t,p),this.safeDispatchEvent("block",{detail:{sender:t,cid:p,block:o.data}}),this.safeDispatchEvent("presence",{detail:{sender:t,cid:p,has:!0,block:o.data}});const y=ne(p.multihash.bytes,"base64"),g=this.wants.get(y);g!=null&&(g.cancel=!0,i=!0)}for(const{cid:o,type:a}of r.blockPresences){const l=nt.decode(o);this.log("received %s from %p for %c",a,t,l),this.safeDispatchEvent("presence",{detail:{sender:t,cid:l,has:a===Vi.HaveBlock}})}i&&await this.sendMessagesDebounced()}async peerConnected(t){const r=new Set,i=new hd(!0);for(const[s,o]of this.wants.entries())o.cancel||(r.add(s),i.addWantlistEntry(o.cid,{cid:o.cid.bytes,priority:1,wantType:zt.WantBlock,cancel:!1,sendDontHave:!1}));if(i.wantlist.size===0){this.peers.set(t,r);return}try{await this.network.sendMessage(t,i),this.peers.set(t,r)}catch(s){this.log.error("error sending full wantlist to new peer %p",t,s)}}peerDisconnected(t){this.peers.delete(t)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}}class jW{constructor(e,t={}){h(this,"log");h(this,"logger");h(this,"stats");h(this,"network");h(this,"blockstore");h(this,"peerWantLists");h(this,"wantList");this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.stats=new KW(e),this.network=new eF(e,t),this.peerWantLists=new TV({...e,network:this.network},t),this.wantList=new qW({...e,network:this.network},t)}createSession(e={}){return HW({wantList:this.wantList,network:this.network,logger:this.logger},e)}async want(e,t={}){const r=new AbortController,i=bt([r.signal,t.signal]);ue(1/0,r.signal,i),this.network.findAndConnect(e,{...t,signal:i}).catch(s=>{r.signal.aborted||this.log.error("error during finding and connect for cid %c",e,s)});try{return(await this.wantList.wantBlock(e,{...t,signal:i})).block}finally{r.abort(),i.clear()}}async notify(e,t,r={}){await Promise.all([this.peerWantLists.receivedBlock(e,r),this.wantList.receivedBlock(e,r)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}}const YW=(n,e={})=>new jW(n,e);class QW{constructor(e,t={}){h(this,"bitswap");h(this,"started");const{hashers:r}=e;this.bitswap=YW(e,{hashLoader:{getHasher:async i=>{let s;if(typeof i=="string"?s=Object.values(r).find(o=>o.name===i):s=r[i],s!=null)return s;throw new Error(`Could not load hasher for code/name "${i}"`)}},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,r){await this.bitswap.notify(e,t,r)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){const t=this.bitswap.createSession(e);return{announce:async(r,i,s)=>{await this.bitswap.notify(r,i,s)},retrieve:async(r,i)=>t.retrieve(r,i)}}}function XW(n={}){return e=>new QW(e,n)}class JW{constructor(){h(this,"index",0);h(this,"input","")}new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,r=e();return r===void 0&&(this.index=t),r}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,r){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return r()})}readNumber(e,t,r,i){return this.readAtomically(()=>{let s=0,o=0;const a=this.peekChar();if(a===void 0)return;const l=a==="0",c=2**(8*i)-1;for(;;){const u=this.readAtomically(()=>{const d=this.readChar();if(d===void 0)return;const f=Number.parseInt(d,e);if(!Number.isNaN(f))return f});if(u===void 0)break;if(s*=e,s+=u,s>c||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!r&&l&&o>1?void 0:s})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const r=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(r===void 0)return;e[t]=r}return e})}readIPv6Addr(){const e=t=>{for(let r=0;r<t.length/2;r++){const i=r*2;if(r<t.length-3){const o=this.readSeparator(":",r,()=>this.readIPv4Addr());if(o!==void 0)return t[i]=o[0],t[i+1]=o[1],t[i+2]=o[2],t[i+3]=o[3],[i+4,!0]}const s=this.readSeparator(":",r,()=>this.readNumber(16,4,!0,2));if(s===void 0)return[i,!1];t[i]=s>>8,t[i+1]=s&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[r,i]=e(t);if(r===16)return t;if(i||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const s=new Uint8Array(14),o=16-(r+2),[a]=e(s.subarray(0,o));return t.set(s.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const ZW=45,eG=15,Y0=new JW;function tG(n){if(!(n.length>eG))return Y0.new(n).parseWith(()=>Y0.readIPv4Addr())}function nG(n){if(n.includes("%")&&(n=n.split("%")[0]),!(n.length>ZW))return Y0.new(n).parseWith(()=>Y0.readIPv6Addr())}function xp(n){return!!tG(n)}function S5(n){return!!nG(n)}var AI;(function(){var n,e,t,r,i,s,o,a;a=function(l){var c,u,d,f;return c=(l&255<<24)>>>24,u=(l&255<<16)>>>16,d=(l&65280)>>>8,f=l&255,[c,u,d,f].join(".")},o=function(l){var c,u,d,f,p,y;for(c=[],d=f=0;f<=3&&l.length!==0;d=++f){if(d>0){if(l[0]!==".")throw new Error("Invalid IP");l=l.substring(1)}y=e(l),p=y[0],u=y[1],l=l.substring(u),c.push(p)}if(l.length!==0)throw new Error("Invalid IP");switch(c.length){case 1:if(c[0]>4294967295)throw new Error("Invalid IP");return c[0]>>>0;case 2:if(c[0]>255||c[1]>16777215)throw new Error("Invalid IP");return(c[0]<<24|c[1])>>>0;case 3:if(c[0]>255||c[1]>255||c[2]>65535)throw new Error("Invalid IP");return(c[0]<<24|c[1]<<16|c[2])>>>0;case 4:if(c[0]>255||c[1]>255||c[2]>255||c[3]>255)throw new Error("Invalid IP");return(c[0]<<24|c[1]<<16|c[2]<<8|c[3])>>>0;default:throw new Error("Invalid IP")}},t=function(l){return l.charCodeAt(0)},r=t("0"),s=t("a"),i=t("A"),e=function(l){var c,u,d,f,p;for(f=0,c=10,u="9",d=0,l.length>1&&l[d]==="0"&&(l[d+1]==="x"||l[d+1]==="X"?(d+=2,c=16):"0"<=l[d+1]&&l[d+1]<="9"&&(d++,c=8,u="7")),p=d;d<l.length;){if("0"<=l[d]&&l[d]<=u)f=f*c+(t(l[d])-r)>>>0;else if(c===16)if("a"<=l[d]&&l[d]<="f")f=f*c+(10+t(l[d])-s)>>>0;else if("A"<=l[d]&&l[d]<="F")f=f*c+(10+t(l[d])-i)>>>0;else break;else break;if(f>4294967295)throw new Error("too large");d++}if(d===p)throw new Error("empty octet");return[f,d]},n=function(){function l(c,u){var d,f,p;if(typeof c!="string")throw new Error("Missing `net' parameter");if(u||(p=c.split("/",2),c=p[0],u=p[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=o(u)}catch{throw new Error("Invalid mask: "+u)}for(d=f=32;f>=0;d=--f)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(c)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+c)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return l.prototype.contains=function(c){return typeof c=="string"&&(c.indexOf("/")>0||c.split(".").length!==4)&&(c=new l(c)),c instanceof l?this.contains(c.base)&&this.contains(c.broadcast||c.last):(o(c)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},l.prototype.next=function(c){return c==null&&(c=1),new l(a(this.netLong+this.size*c),this.mask)},l.prototype.forEach=function(c){var u,d,f;for(f=o(this.first),d=o(this.last),u=0;f<=d;)c(a(f),f,u),u++,f++},l.prototype.toString=function(){return this.base+"/"+this.bitmask},l}(),AI=n}).call(Aa);const rG=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],iG=rG.map(n=>new AI(n));function x5(n){for(const e of iG)if(e.contains(n))return!0;return!1}function sG(n){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(n)}function oG(n){const e=n.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),r=e[e.length-2].padStart(4,"0"),i=`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return x5(i)}function aG(n){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)}function lG(n){const e=n.split(":"),t=e[e.length-1];return x5(t)}function cG(n){return/^::$/.test(n)||/^::1$/.test(n)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(n)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(n)||/^ff([0-9a-fA-F]{2,2}):/i.test(n)}function Bo(n){return xp(n)?x5(n):sG(n)?oG(n):aG(n)?lG(n):S5(n)?cG(n):void 0}const uG=n=>n.toString().split("/").slice(1),rf=n=>({match:e=>e.length<1?!1:n(e[0])?e.slice(1):!1,pattern:"fn"}),Te=n=>({match:e=>rf(t=>t===n).match(e),pattern:n}),ol=()=>({match:n=>rf(e=>typeof e=="string").match(n),pattern:"{string}"}),Sh=()=>({match:n=>rf(e=>!isNaN(parseInt(e))).match(n),pattern:"{number}"}),je=()=>({match:n=>{if(n.length<2||n[0]!=="p2p"&&n[0]!=="ipfs")return!1;if(n[1].startsWith("Q")||n[1].startsWith("1"))try{mn.decode(`z${n[1]}`)}catch{return!1}else return!1;return n.slice(2)},pattern:"/p2p/{peerid}"}),Q0=()=>({match:n=>{if(n.length<2||n[0]!=="certhash")return!1;try{A6.decode(n[1])}catch{return!1}return n.slice(2)},pattern:"/certhash/{certhash}"}),We=n=>({match:e=>{const t=n.match(e);return t===!1?e:t},pattern:`optional(${n.pattern})`}),bn=(...n)=>({match:e=>{let t;for(const r of n){const i=r.match(e);i!==!1&&(t==null||i.length<t.length)&&(t=i)}return t??!1},pattern:`or(${n.map(e=>e.pattern).join(", ")})`}),De=(...n)=>({match:e=>{for(const t of n){const r=t.match(e);if(r===!1)return!1;e=r}return e},pattern:`and(${n.map(e=>e.pattern).join(", ")})`});function ft(...n){function e(i){let s=uG(i);for(const o of n){const a=o.match(s);if(a===!1)return!1;s=a}return s}function t(i){return e(i)!==!1}function r(i){const s=e(i);return s===!1?!1:s.length===0}return{matchers:n,matches:t,exactMatch:r}}const dG=je();ft(dG);const kp=De(Te("dns4"),ol()),Rp=De(Te("dns6"),ol()),Ap=De(Te("dnsaddr"),ol()),k5=De(Te("dns"),ol());ft(kp,We(je()));ft(Rp,We(je()));ft(Ap,We(je()));const II=ft(bn(k5,Ap,kp,Rp),We(je())),CI=De(Te("ip4"),rf(xp)),TI=De(Te("ip6"),rf(S5)),R5=bn(CI,TI),Ss=bn(R5,k5,kp,Rp,Ap),hG=ft(bn(R5,De(bn(k5,Ap,kp,Rp),We(je()))));ft(CI);ft(TI);const fG=ft(R5),A5=De(Ss,Te("tcp"),Sh()),sf=De(Ss,Te("udp"),Sh());ft(De(A5,We(je())));ft(sf);const I5=De(sf,Te("quic"),We(je())),Ip=De(sf,Te("quic-v1"),We(je())),pG=bn(I5,Ip);ft(I5);ft(Ip);const ey=bn(Ss,A5,sf,I5,Ip),NI=bn(De(ey,Te("ws"),We(je())));ft(NI);const DI=bn(De(ey,Te("wss"),We(je())),De(ey,Te("tls"),We(De(Te("sni"),ol())),Te("ws"),We(je())));ft(DI);const PI=De(sf,Te("webrtc-direct"),We(Q0()),We(Q0()),We(je())),gG=ft(PI),OI=De(Ip,Te("webtransport"),We(Q0()),We(Q0()),We(je())),LI=ft(OI),X0=bn(NI,DI,De(A5,We(je())),De(pG,We(je())),De(Ss,We(je())),PI,OI,je());ft(X0);const yG=De(X0,Te("p2p-circuit"),je()),J0=ft(yG),mG=bn(De(X0,Te("p2p-circuit"),Te("webrtc"),We(je())),De(X0,Te("webrtc"),We(je())),De(Te("webrtc"),We(je()))),wG=ft(mG),vG=bn(De(Ss,Te("tcp"),Sh(),Te("http"),We(je())),De(Ss,Te("http"),We(je()))),EG=ft(vG),bG=bn(De(Ss,Te("tcp"),bn(De(Te("443"),Te("http")),De(Sh(),Te("https")),De(Sh(),Te("tls"),Te("http"))),We(je())),De(Ss,Te("tls"),Te("http"),We(je())),De(Ss,Te("https"),We(je()))),_G=ft(bG),SG=bn(De(Te("memory"),ol(),We(je())));ft(SG);const xG=bn(De(Te("unix"),ol(),We(je())));ft(xG);class sr extends Error{constructor(){super(...arguments);h(this,"name","InvalidMultiaddrError")}}h(sr,"name","InvalidMultiaddrError");class Gc extends Error{constructor(){super(...arguments);h(this,"name","ValidationError")}}h(Gc,"name","ValidationError");var _3;let kG=(_3=class extends Error{constructor(){super(...arguments);h(this,"name","InvalidParametersError")}},h(_3,"name","InvalidParametersError"),_3);class BI extends Error{constructor(){super(...arguments);h(this,"name","UnknownProtocolError")}}h(BI,"name","UnknownProtocolError");const ty=4,ny=6,ry=273,RG=33,P1=41,MI=42,AG=43,$I=53,UI=54,C5=55,FI=56,IG=132,CG=301,TG=302,NG=400,zI=421,DG=444,PG=445,OG=446,LG=447,BG=448,MG=449,$G=454,UG=460,FG=461,zG=465,VG=466,HG=480,KG=481,WG=443,GG=477,qG=478,jG=479,YG=277,QG=275,XG=276,JG=280,ZG=281,VI=290,eq=777;function e9(n){return e=>ne(e,n)}function t9(n){return e=>Y(e,n)}function fd(n){return new DataView(n.buffer).getUint16(n.byteOffset).toString()}function Ll(n){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof n=="string"?parseInt(n):n),new Uint8Array(e)}function tq(n){const e=n.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=Y(e[0],"base32"),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const i=Ll(r);return vn([t,i],t.length+i.length)}function nq(n){const e=n.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Hn.decode(`b${e[0]}`),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const i=Ll(r);return vn([t,i],t.length+i.length)}function n9(n){const e=n.subarray(0,n.length-2),t=n.subarray(n.length-2),r=ne(e,"base32"),i=fd(t);return`${r}:${i}`}const HI=function(n){n=n.toString().trim();const e=new Uint8Array(4);return n.split(/\./g).forEach((t,r)=>{const i=parseInt(t,10);if(isNaN(i)||i<0||i>255)throw new sr("Invalid byte value in IP address");e[r]=i}),e},rq=function(n){let e=0;n=n.toString().trim();const t=n.split(":",8);let r;for(r=0;r<t.length;r++){const s=xp(t[r]);let o;s&&(o=HI(t[r]),t[r]=ne(o.subarray(0,2),"base16")),o!=null&&++r<8&&t.splice(r,0,ne(o.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(r=0;r<t.length&&t[r]!=="";r++);const s=[r,1];for(r=9-t.length;r>0;r--)s.push("0");t.splice.apply(t,s)}const i=new Uint8Array(e+16);for(r=0;r<t.length;r++){t[r]===""&&(t[r]="0");const s=parseInt(t[r],16);if(isNaN(s)||s<0||s>65535)throw new sr("Invalid byte value in IP address");i[e++]=s>>8&255,i[e++]=s&255}return i},iq=function(n){if(n.byteLength!==4)throw new sr("IPv4 address was incorrect length");const e=[];for(let t=0;t<n.byteLength;t++)e.push(n[t]);return e.join(".")},sq=function(n){if(n.byteLength!==16)throw new sr("IPv6 address was incorrect length");const e=[];for(let r=0;r<n.byteLength;r+=2){const i=n[r],s=n[r+1],o=`${i.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`;e.push(o)}const t=e.join(":");try{const r=new URL(`http://[${t}]`);return r.hostname.substring(1,r.hostname.length-1)}catch{throw new sr(`Invalid IPv6 address "${t}"`)}};function oq(n){try{const e=new URL(`http://[${n}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new sr(`Invalid IPv6 address "${n}"`)}}const n3=Object.values(za).map(n=>n.decoder),aq=function(){let n=n3[0].or(n3[1]);return n3.slice(2).forEach(e=>n=n.or(e)),n}();function lq(n){return aq.decode(n)}function cq(n){return e=>n.encoder.encode(e)}function uq(n){if(parseInt(n).toString()!==n)throw new Gc("Value must be an integer")}function dq(n){if(n<0)throw new Gc("Value must be a positive integer, or zero")}function hq(n){return e=>{if(e>n)throw new Gc(`Value must be smaller than or equal to ${n}`)}}function fq(...n){return e=>{for(const t of n)t(e)}}const Xf=fq(uq,dq,hq(65535)),dn=-1;class pq{constructor(){h(this,"protocolsByCode",new Map);h(this,"protocolsByName",new Map)}getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new BI(`Protocol ${e} was unknown`);return t}addProtocol(e){var t;this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),(t=e.aliases)==null||t.forEach(r=>{this.protocolsByName.set(r,e)})}removeProtocol(e){var r;const t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),(r=t.aliases)==null||r.forEach(i=>{this.protocolsByName.delete(i)}))}}const Hi=new pq,gq=[{code:ty,name:"ip4",size:32,valueToBytes:HI,bytesToValue:iq,validate:n=>{if(!xp(n))throw new Gc(`Invalid IPv4 address "${n}"`)}},{code:ny,name:"tcp",size:16,valueToBytes:Ll,bytesToValue:fd,validate:Xf},{code:ry,name:"udp",size:16,valueToBytes:Ll,bytesToValue:fd,validate:Xf},{code:RG,name:"dccp",size:16,valueToBytes:Ll,bytesToValue:fd,validate:Xf},{code:P1,name:"ip6",size:128,valueToBytes:rq,bytesToValue:sq,stringToValue:oq,validate:n=>{if(!S5(n))throw new Gc(`Invalid IPv6 address "${n}"`)}},{code:MI,name:"ip6zone",size:dn},{code:AG,name:"ipcidr",size:8,bytesToValue:e9("base10"),valueToBytes:t9("base10")},{code:$I,name:"dns",size:dn,resolvable:!0},{code:UI,name:"dns4",size:dn,resolvable:!0},{code:C5,name:"dns6",size:dn,resolvable:!0},{code:FI,name:"dnsaddr",size:dn,resolvable:!0},{code:IG,name:"sctp",size:16,valueToBytes:Ll,bytesToValue:fd,validate:Xf},{code:CG,name:"udt"},{code:TG,name:"utp"},{code:NG,name:"unix",size:dn,path:!0,stringToValue:n=>decodeURIComponent(n),valueToString:n=>encodeURIComponent(n)},{code:zI,name:"p2p",aliases:["ipfs"],size:dn,bytesToValue:e9("base58btc"),valueToBytes:n=>n.startsWith("Q")||n.startsWith("1")?t9("base58btc")(n):nt.parse(n).multihash.bytes},{code:DG,name:"onion",size:96,bytesToValue:n9,valueToBytes:tq},{code:PG,name:"onion3",size:296,bytesToValue:n9,valueToBytes:nq},{code:OG,name:"garlic64",size:dn},{code:LG,name:"garlic32",size:dn},{code:BG,name:"tls"},{code:MG,name:"sni",size:dn},{code:$G,name:"noise"},{code:UG,name:"quic"},{code:FG,name:"quic-v1"},{code:zG,name:"webtransport"},{code:VG,name:"certhash",size:dn,bytesToValue:cq(A6),valueToBytes:lq},{code:HG,name:"http"},{code:KG,name:"http-path",size:dn,stringToValue:n=>`/${decodeURIComponent(n)}`,valueToString:n=>encodeURIComponent(n.substring(1))},{code:WG,name:"https"},{code:GG,name:"ws"},{code:qG,name:"wss"},{code:jG,name:"p2p-websocket-star"},{code:YG,name:"p2p-stardust"},{code:QG,name:"p2p-webrtc-star"},{code:XG,name:"p2p-webrtc-direct"},{code:JG,name:"webrtc-direct"},{code:ZG,name:"webrtc"},{code:VI,name:"p2p-circuit"},{code:eq,name:"memory",size:dn}];gq.forEach(n=>{Hi.addProtocol(n)});function yq(n){var r;const e=[];let t=0;for(;t<n.length;){const i=wu(n,t),s=Hi.getProtocol(i),o=ht(i),a=Eq(s,n,t+o);let l=0;a>0&&s.size===dn&&(l=ht(a));const c=o+l+a,u={code:i,name:s.name,bytes:n.subarray(t,t+c)};if(a>0){const d=t+o+l,f=n.subarray(d,d+a);u.value=((r=s.bytesToValue)==null?void 0:r.call(s,f))??ne(f)}e.push(u),t+=c}return e}function mq(n){var r;let e=0;const t=[];for(const i of n){if(i.bytes==null){const s=Hi.getProtocol(i.code),o=ht(i.code);let a,l=0,c=0;i.value!=null&&(a=((r=s.valueToBytes)==null?void 0:r.call(s,i.value))??Y(i.value),l=a.byteLength,s.size===dn&&(c=ht(l)));const u=new Uint8Array(o+c+l);let d=0;I0(i.code,u,d),d+=o,a!=null&&(s.size===dn&&(I0(l,u,d),d+=c),u.set(a,d)),i.bytes=u}t.push(i.bytes),e+=i.bytes.byteLength}return vn(t,e)}function wq(n){var s;if(n.charAt(0)!=="/")throw new sr('String multiaddr must start with "/"');const e=[];let t="protocol",r="",i="";for(let o=1;o<n.length;o++){const a=n.charAt(o);a!=="/"&&(t==="protocol"?i+=n.charAt(o):r+=n.charAt(o));const l=o===n.length-1;if(a==="/"||l){const c=Hi.getProtocol(i);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),r="",i="",t="protocol";continue}else if(l)throw new sr(`Component ${i} was missing value`);t="value"}else if(t==="value"){const u={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(r==="")throw new sr(`Component ${i} was missing value`);u.value=((s=c.stringToValue)==null?void 0:s.call(c,r))??r}e.push(u),r="",i="",t="protocol"}}}if(i!==""&&r!=="")throw new sr("Incomplete multiaddr");return e}function vq(n){return`/${n.flatMap(e=>{var r;if(e.value==null)return e.name;const t=Hi.getProtocol(e.code);if(t==null)throw new sr(`Unknown protocol code ${e.code}`);return[e.name,((r=t.valueToString)==null?void 0:r.call(t,e.value))??e.value]}).join("/")}`}function Eq(n,e,t){return n.size==null||n.size===0?0:n.size>0?n.size/8:wu(e,t)}const bq=Symbol.for("nodejs.util.inspect.custom"),KI=Symbol.for("@multiformats/multiaddr"),_q=[$I,UI,C5,FI];class Sq extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}function xq(n){if(n==null&&(n="/"),Cp(n))return n.getComponents();if(n instanceof Uint8Array)return yq(n);if(typeof n=="string")return n=n.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),n===""&&(n="/"),wq(n);if(Array.isArray(n))return n;throw new sr("Must be a string, Uint8Array, Component[], or another Multiaddr")}var pE,ct,dc,hc;const Ml=class Ml{constructor(e="/",t={}){h(this,pE,!0);le(this,ct);le(this,dc);le(this,hc);ye(this,ct,xq(e)),t.validate!==!1&&kq(this)}get bytes(){return I(this,hc)==null&&ye(this,hc,mq(I(this,ct))),I(this,hc)}toString(){return I(this,dc)==null&&ye(this,dc,vq(I(this,ct))),I(this,dc)}toJSON(){return this.toString()}toOptions(){let e,t,r,i,s="";for(const{code:a,name:l,value:c}of I(this,ct))a===MI&&(s=`%${c??""}`),_q.includes(a)&&(t="tcp",i=443,r=`${c??""}${s}`,e=a===C5?6:4),(a===ny||a===ry)&&(t=l==="tcp"?"tcp":"udp",i=parseInt(c??"")),(a===ty||a===P1)&&(t="tcp",r=`${c??""}${s}`,e=a===P1?6:4);if(e==null||t==null||r==null||i==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:r,transport:t,port:i}}getComponents(){return[...I(this,ct)]}protos(){return I(this,ct).map(({code:e,value:t})=>{const r=Hi.getProtocol(e);return{code:e,size:r.size??0,name:r.name,resolvable:!!r.resolvable,path:!!r.path}})}protoCodes(){return I(this,ct).map(({code:e})=>e)}protoNames(){return I(this,ct).map(({name:e})=>e)}tuples(){return I(this,ct).map(({code:e,value:t})=>{var s;if(t==null)return[e];const r=Hi.getProtocol(e),i=[e];return t!=null&&i.push(((s=r.valueToBytes)==null?void 0:s.call(r,t))??Y(t)),i})}stringTuples(){return I(this,ct).map(({code:e,value:t})=>t==null?[e]:[e,t])}encapsulate(e){const t=new Ml(e);return new Ml([...I(this,ct),...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),r=this.toString(),i=r.lastIndexOf(t);if(i<0)throw new kG(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Ml(r.slice(0,i),{validate:!1})}decapsulateCode(e){let t;for(let r=I(this,ct).length-1;r>-1;r--)if(I(this,ct)[r].code===e){t=r;break}return new Ml(I(this,ct).slice(0,t),{validate:!1})}getPeerId(){try{let e=[];I(this,ct).forEach(({code:r,value:i})=>{r===zI&&e.push([r,i]),r===VI&&(e=[])});const t=e.pop();if((t==null?void 0:t[1])!=null){const r=t[1];return r[0]==="Q"||r[0]==="1"?ne(mn.decode(`z${r}`),"base58btc"):ne(nt.parse(r).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){for(const e of I(this,ct))if(Hi.getProtocol(e.code).path)return e.value??null;return null}equals(e){return Pe(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(s=>s.resolvable);if(t==null)return[this];const r=T5.get(t.name);if(r==null)throw new Sq(`no available resolver for ${t.name}`);return(await r(this,e)).map(s=>xe(s))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return!(I(this,ct).length!==2||I(this,ct)[0].code!==ty&&I(this,ct)[0].code!==P1||I(this,ct)[1].code!==ny&&I(this,ct)[1].code!==ry)}[(pE=KI,bq)](){return`Multiaddr(${this.toString()})`}};ct=new WeakMap,dc=new WeakMap,hc=new WeakMap;let iy=Ml;function kq(n){n.getComponents().forEach(e=>{var r;const t=Hi.getProtocol(e.code);e.value!=null&&((r=t.validate)==null||r.call(t,e.value))})}const T5=new Map;function Cp(n){return!!(n!=null&&n[KI])}function xe(n){return new iy(n)}function Mt(n){const e=Hi.getProtocol(n);return{code:e.code,size:e.size??0,name:e.name,resolvable:!!e.resolvable,path:!!e.path}}const Rq=[Mt("tcp").code,Mt("dns").code,Mt("dnsaddr").code,Mt("dns4").code,Mt("dns6").code];function r9(n){var e;return(e=WI("sni",n))==null?void 0:e[1]}function i9(n){var t;const e=(t=WI("tcp",n))==null?void 0:t[1];return e==null?"":`:${e}`}function WI(n,e){let t;try{t=Mt(n).code}catch{return}for(const[r,i]of e)if(r===t&&i!=null)return[r,i]}function s9(n){return n.some(([e,t])=>e===Mt("tls").code)}function Mn(n,e,t){const r=GI[Mt(n).name];if(r==null)throw new Error(`Can't interpret protocol ${Mt(n).name}`);const i=r(e,t);return n===Mt("ip6").code?`[${i}]`:i}const GI={ip4:(n,e)=>n,ip6:(n,e)=>e.length===0?n:`[${n}]`,tcp:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${Mn(t[0],t[1]??"",e)}:${n}`},udp:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${Mn(t[0],t[1]??"",e)}:${n}`},dnsaddr:(n,e)=>n,dns4:(n,e)=>n,dns6:(n,e)=>n,dns:(n,e)=>n,ipfs:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Mn(t[0],t[1]??"",e)}/ipfs/${n}`},p2p:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Mn(t[0],t[1]??"",e)}/p2p/${n}`},http:(n,e)=>{const t=s9(e),r=r9(e),i=i9(e);if(t&&r!=null)return`https://${r}${i}`;const s=t?"https://":"http://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Mn(o[0],o[1]??"",e);return a=a.replace("tcp://",""),`${s}${a}`},"http-path":(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const r=Mn(t[0],t[1]??"",e),i=decodeURIComponent(n);return`${r}/${i}`},tls:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Mn(t[0],t[1]??"",e)},sni:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Mn(t[0],t[1]??"",e)},https:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let r=Mn(t[0],t[1]??"",e);return r=r.replace("tcp://",""),`https://${r}`},ws:(n,e)=>{const t=s9(e),r=r9(e),i=i9(e);if(t&&r!=null)return`wss://${r}${i}`;const s=t?"wss://":"ws://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Mn(o[0],o[1]??"",e);return a=a.replace("tcp://",""),`${s}${a}`},wss:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let r=Mn(t[0],t[1]??"",e);return r=r.replace("tcp://",""),`wss://${r}`},"p2p-websocket-star":(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Mn(t[0],t[1]??"",e)}/p2p-websocket-star`},"p2p-webrtc-star":(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Mn(t[0],t[1]??"",e)}/p2p-webrtc-star`},"p2p-webrtc-direct":(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Mn(t[0],t[1]??"",e)}/p2p-webrtc-direct`}};function qI(n,e){const r=xe(n).stringTuples(),i=r.pop();if(i==null)throw new Error("Unexpected end of multiaddr");const s=Mt(i[0]),o=GI[s.name];if(o==null)throw new Error(`No interpreter found for ${s.name}`);let a=o(i[1]??"",r);return Rq.includes(i[0])&&(a=a.replace(/^.*:\/\//,""),i[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("ws://")||a.startsWith("wss://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}var Ea,ba,fc,pc,_a,D2,jI;class Aq{constructor(e,t){le(this,D2);h(this,"url");le(this,Ea,0);le(this,ba,0);le(this,fc,0);le(this,pc,0);le(this,_a,new Map);h(this,"log");this.url=e instanceof URL?e:new URL(e),this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}async getRawBlock(e,t){const r=new URL(this.url.toString());if(r.pathname=`/ipfs/${e.toString()}`,r.search="?format=raw",(t==null?void 0:t.aborted)===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);const i=Q(this,D2,jI).call(this,e),s=new AbortController,o=()=>{s.abort()};t==null||t.addEventListener("abort",o);try{let a=I(this,_a).get(i);return a==null&&(sn(this,Ea)._++,a=fetch(r.toString(),{signal:s.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"}).then(async l=>{if(this.log("GET %s %d",r,l.status),!l.ok)throw sn(this,ba)._++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return sn(this,pc)._++,new Uint8Array(await l.arrayBuffer())}),I(this,_a).set(i,a)),await a}catch{throw(t==null?void 0:t.aborted)===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(sn(this,ba)._++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t==null||t.removeEventListener("abort",o),I(this,_a).delete(i)}}reliability(){return I(this,Ea)===0?1:I(this,fc)>0?-1/0:I(this,pc)/(I(this,Ea)+I(this,ba)*3)}incrementInvalidBlocks(){sn(this,fc)._++}getStats(){return{attempts:I(this,Ea),errors:I(this,ba),invalidBlocks:I(this,fc),successes:I(this,pc),pendingResponses:I(this,_a).size}}}Ea=new WeakMap,ba=new WeakMap,fc=new WeakMap,pc=new WeakMap,_a=new WeakMap,D2=new WeakSet,jI=function(e){const t=e.multihash.bytes;return ar.encode(t)};function Iq(n,e,t){return n.filter(r=>{if(_G.matches(r)||e&&EG.matches(r))return t||II.matches(r)?!0:Bo(r.toOptions().host)===!1;if(!e&&t){const{host:i}=r.toOptions();if(i==="127.0.0.1"||i==="localhost"||i.endsWith(".localhost"))return!0}return!1})}async function*YI(n,e,t,r,i,s){for await(const o of e.findProviders(n,s)){const a=Iq(o.multiaddrs,r,i);if(a.length===0)continue;const l=qI(a[0]);yield new Aq(l,t)}}class Cq extends kI{constructor(t,r){super(t,{...r,name:"helia:trustless-gateway:session"});h(this,"routing");h(this,"allowInsecure");h(this,"allowLocal");this.routing=t.routing,this.allowInsecure=r.allowInsecure??QI,this.allowLocal=r.allowLocal??XI}async queryProvider(t,r,i){var o;this.log("fetching BLOCK for %c from %s",t,r.url);const s=await r.getRawBlock(t,i.signal);return this.log.trace("got block for %c from %s",t,r.url),await((o=i.validateFn)==null?void 0:o.call(i,s)),s}async*findNewProviders(t,r={}){yield*YI(t,this.routing,this.logger,this.allowInsecure,this.allowLocal,r)}toEvictionKey(t){return t.url.toString()}equals(t,r){return t.url.toString()===r.url.toString()}}function Tq(n,e){return new Cq(n,e)}class Nq{constructor(e,t={}){h(this,"allowInsecure");h(this,"allowLocal");h(this,"routing");h(this,"log");h(this,"logger");this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??QI,this.allowLocal=t.allowLocal??XI}async retrieve(e,t={}){var i,s;const r=[];for await(const o of YI(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,t)){this.log("getting block for %c from %s",e,o.url);try{const a=await o.getRawBlock(e,t.signal);this.log.trace("got block for %c from %s",e,o.url);try{await((i=t.validateFn)==null?void 0:i.call(t,a))}catch(l){this.log.error("failed to validate block for %c from %s",e,o.url,l);continue}return a}catch(a){if(this.log.error("failed to get block for %c from %s",e,o.url,a),a instanceof Error?r.push(a):r.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${o.url}`)),((s=t.signal)==null?void 0:s.aborted)===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,o.url);break}}}throw r.length>0?new AggregateError(r,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return Tq({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure})}}const QI=!1,XI=!1;function Dq(n={}){return e=>new Nq(e,n)}async function*o9(n,e={}){const t=n.getReader();try{for(;;){const r=await t.read();if(r.done)return;yield r.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var JI={exports:{}};(function(n){(function(){n.exports=w;var e=86400,t=3200,r=146097*t/400,i=e*r,s=1e3*i,o=864e13,a=4294967296,l=1e6,c="000000000",u=Math.trunc||function(_){var N=_-_%1;return N==0&&(_<0||_===0&&1/_!=1/0)?-0:N},d=w.prototype,f=(w.fromDate=function(_){return new w(+_)},w.fromInt64BE=k(0,1,2,3,0,4),w.fromInt64LE=k(3,2,1,0,4,0),w.fromString=function(z){var N,V=new w,z=(z+="").replace(/^\s*[+\-]?\d+/,function(C){var C=+C,x=1970+(C-1970)%400;return V.year=C-x,x}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(R,C,x){return C<0&&(x*=-1),N=6e4*(60*+C+ +x),""}).replace(/\.\d+$/,function(R){return V.nano=+(R+c).substr(1,9),""}).split(/\D+/);if(1<z.length?z[1]--:z[1]=0,V.time=N=Date.UTC.apply(Date,z)-(N||0),isNaN(N))throw new TypeError("Invalid Date");return m(V)},w.fromTimeT=function(_){return v(_,0)},d.year=0,d.time=0,d.nano=0,d.addNano=function(_){return this.nano+=+_||0,this},d.getNano=function(){var _=m(this);return(_.time%1e3*l+ +_.nano+1e9)%1e9},d.getTimeT=function(){var N=m(this),_=Math.floor(N.time/1e3),N=N.year;return N&&(_+=N*r*e/t),_},d.getYear=function(){return this.toDate().getUTCFullYear()+this.year},d.toDate=function(){return E(m(this).time)},d.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},d.toString=function(_){var N=this,V=N.toDate(),z={H:function(){return T(V.getUTCHours())},L:function(){return P(V.getUTCMilliseconds(),3)},M:function(){return T(V.getUTCMinutes())},N:function(){return P(N.getNano(),9)},S:function(){return T(V.getUTCSeconds())},Y:function(){var R=N.getYear();return 999999<R?"+"+R:9999<R?"+"+P(R,6):0<=R?P(R,4):-999999<=R?"-"+P(-R,6):R},a:function(){return y[V.getUTCDay()]},b:function(){return p[V.getUTCMonth()]},d:function(){return T(V.getUTCDate())},e:function(){return function(R){return(9<R?"":" ")+(0|R)}(V.getUTCDate())},m:function(){return T(V.getUTCMonth()+1)}};return function R(C){return C.replace(/%./g,function(x){var K=x[1],M=g[K],K=z[K];return M?R(M):K?K():x})}(_||f)},d.writeInt64BE=b(0,1,2,3,0,4),d.writeInt64LE=b(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),p=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],y=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],g={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return w;function w(_,N,V){var z=this;if(!(z instanceof w))return new w(_,N,V);z.time=+_||0,z.nano=+N||0,z.year=+V||0,m(z)}function m(_){var N,V,z,R=_.year,C=_.time,x=_.nano,M=((x<0||l<=x)&&(x-=(V=Math.floor(x/l))*l,C+=V,V=1),R%t);return(C<-o||o<C||M)&&((N=u(C/s))&&(R+=N*t,C-=N*s),(z=E(C)).setUTCFullYear(M+z.getUTCFullYear()),z=(C=+z)+(N=u((R-=M)/t))*s,N&&-o<=z&&z<=o&&(R-=N*t,C=z),V=1),V&&(_.year=R,_.time=C,_.nano=x),_}function E(_){var N=new Date(0);return N.setTime(_),N}function v(R,z){R=+R||0;var V=u((z=(z|0)*a)/i)+u(R/i),z=z%i+R%i,R=u(z/i);return R&&(V+=R,z-=R*i),new w(1e3*z,0,V*t)}function b(_,N,V,z,R,C){return function(M,K){var O=m(this);M=M||new Array(8),A(M,K|=0);var H=Math.floor(O.time/1e3),O=O.year*(r*e/t),L=u(O/a)+u(H/a),O=O%a+H%a,H=Math.floor(O/a);return H&&(L+=H,O-=H*a),x(M,K+R,L),x(M,K+C,O),M};function x(M,K,L){M[K+_]=L>>24&255,M[K+N]=L>>16&255,M[K+V]=L>>8&255,M[K+z]=255&L}}function k(_,N,V,z,R,C){return function(M,K){A(M,K|=0);var L=x(M,K+R);return v(x(M,K+C),L)};function x(M,K){return 16777216*M[K+_]+(M[K+N]<<16|M[K+V]<<8|M[K+z])}}function A(_,N){if(_=_&&_.length,_==null)throw new TypeError("Invalid Buffer");if(_<N+8)throw new RangeError("Out of range")}function T(_){return(9<_?"":"0")+(0|_)}function P(_,N){return(c+(0|_)).substr(-N)}})()})(JI);var Pq=JI.exports;const sy=ci(Pq),Oq="ERR_IPNS_EXPIRED_RECORD",ZI="ERR_UNRECOGNIZED_VALIDITY",ca="ERR_SIGNATURE_VERIFICATION",a9="ERR_UNDEFINED_PARAMETER",Lq="ERR_INVALID_RECORD_DATA",Bq="ERR_INVALID_VALUE",Mq="ERR_INVALID_EMBEDDED_KEY",$q="ERR_RECORD_TOO_LARGE";var oi;(function(n){(function(r){r.EOL="EOL"})(n.ValidityType||(n.ValidityType={}));let e;(function(r){r[r.EOL=0]="EOL"})(e||(e={})),function(r){r.codec=()=>Pn(e)}(n.ValidityType||(n.ValidityType={}));let t;n.codec=()=>(t==null&&(t=Ae((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.value!=null&&(i.uint32(10),i.bytes(r.value)),r.signatureV1!=null&&(i.uint32(18),i.bytes(r.signatureV1)),r.validityType!=null&&(i.uint32(24),n.ValidityType.codec().encode(r.validityType,i)),r.validity!=null&&(i.uint32(34),i.bytes(r.validity)),r.sequence!=null&&(i.uint32(40),i.uint64(r.sequence)),r.ttl!=null&&(i.uint32(48),i.uint64(r.ttl)),r.pubKey!=null&&(i.uint32(58),i.bytes(r.pubKey)),r.signatureV2!=null&&(i.uint32(66),i.bytes(r.signatureV2)),r.data!=null&&(i.uint32(74),i.bytes(r.data)),s.lengthDelimited!==!1&&i.ldelim()},(r,i)=>{const s={},o=i==null?r.len:r.pos+i;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:s.value=r.bytes();break;case 2:s.signatureV1=r.bytes();break;case 3:s.validityType=n.ValidityType.codec().decode(r);break;case 4:s.validity=r.bytes();break;case 5:s.sequence=r.uint64();break;case 6:s.ttl=r.uint64();break;case 7:s.pubKey=r.bytes();break;case 8:s.signatureV2=r.bytes();break;case 9:s.data=r.bytes();break;default:r.skipType(a&7);break}}return s})),t),n.encode=r=>Re(r,n.codec()),n.decode=r=>ke(r,n.codec())})(oi||(oi={}));const l9=Su("ipns:utils"),eC=Y("/ipns/"),Uq=114,Fq=async(n,e)=>{if(e==null||n==null){const r=new Error("one or more of the provided parameters are not defined");throw l9.error(r),at(r,a9)}let t;if(e.pubKey!=null){try{t=mh(e.pubKey)}catch(i){throw l9.error(i),i}if(!(await qi(e.pubKey)).equals(n))throw at(new Error("Embedded public key did not match PeerID"),Mq)}else n.publicKey!=null&&(t=mh(n.publicKey));if(t!=null)return t;throw at(new Error("no public key is available"),a9)},zq=n=>{const e=Y("ipns-signature:");return vn([e,n])},tC=n=>"signatureV1"in n?oi.encode({value:Y(n.value),signatureV1:n.signatureV1,validityType:n.validityType,validity:Y(n.validity),sequence:n.sequence,ttl:n.ttl,pubKey:n.pubKey,signatureV2:n.signatureV2,data:n.data}):oi.encode({pubKey:n.pubKey,signatureV2:n.signatureV2,data:n.data});function of(n){const e=oi.decode(n);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw at(new Error("missing data or signatureV2"),ca);const t=nC(e.data),r=Kq(t.Value),i=ne(t.Validity);if(e.value!=null&&e.signatureV1!=null)return Wq(e),{value:r,validityType:oi.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:r,validityType:oi.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}const Vq=n=>vn([eC,n.toBytes()]),Hq=n=>di(n.slice(eC.length)),nC=n=>{const e=Pa(n);if(e.ValidityType===0)e.ValidityType=oi.ValidityType.EOL;else throw at(new Error("Unknown validity type"),ZI);return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e},Kq=n=>{if(n!=null){if(cp(n))return`/ipns/${n.toCID().toString(_s)}`;if(n instanceof Uint8Array){const r=ne(n);r.startsWith("/")&&(n=r)}const e=n.toString().trim();if(e.startsWith("/")&&e.length>1)return e;const t=nt.asCID(n);if(t!=null)return t.code===Uq?`/ipns/${t.toString(_s)}`:`/ipfs/${t.toV1().toString()}`;try{return n instanceof Uint8Array?`/ipfs/${nt.decode(n).toV1().toString()}`:`/ipfs/${nt.parse(e).toV1().toString()}`}catch{}}throw at(new Error("Value must be a valid content path starting with /"),Bq)},Wq=n=>{if(n.data==null)throw at(new Error("Record data is missing"),Lq);const e=nC(n.data);if(!Pe(e.Value,n.value??new Uint8Array(0)))throw at(new Error('Field "value" did not match between protobuf and CBOR'),ca);if(!Pe(e.Validity,n.validity??new Uint8Array(0)))throw at(new Error('Field "validity" did not match between protobuf and CBOR'),ca);if(e.ValidityType!==n.validityType)throw at(new Error('Field "validityType" did not match between protobuf and CBOR'),ca);if(e.Sequence!==n.sequence)throw at(new Error('Field "sequence" did not match between protobuf and CBOR'),ca);if(e.TTL!==n.ttl)throw at(new Error('Field "ttl" did not match between protobuf and CBOR'),ca)},Jf=Su("ipns:validator"),Gq=1024*10,qq=async(n,e)=>{const t=of(e);let r;try{const i=zq(t.data);r=await n.verify(i,t.signatureV2)}catch{r=!1}if(!r)throw Jf.error("record signature verification failed"),at(new Error("record signature verification failed"),ca);if(t.validityType===oi.ValidityType.EOL){if(sy.fromString(t.validity).toDate().getTime()<Date.now())throw Jf.error("record has expired"),at(new Error("record has expired"),Oq)}else if(t.validityType!=null)throw Jf.error("unrecognized validity type"),at(new Error("unrecognized validity type"),ZI);Jf("ipns record for %s is valid",t.value)};async function rC(n,e){if(e.byteLength>Gq)throw at(new Error("record too large"),$q);const t=Hq(n),r=of(e),i=await Fq(t,r);await qq(i,e)}let jq=class extends Error{constructor(){super(...arguments);h(this,"name","InvalidMessageLengthError");h(this,"code","ERR_INVALID_MESSAGE_LENGTH")}};async function*c9(n,e={}){const t=/\r?\n/,r=new TextDecoder("utf8");let i="";for await(let s of n){if(typeof s=="string"&&(s=new TextEncoder().encode(s)),ud(s)&&(s=s.subarray()),i+=r.decode(s,{stream:!0}),i.length>((e==null?void 0:e.maxMessageLength)??i.length))throw new jq("Incoming message too long");const o=i.split(t);i=o.pop()??"";for(let a=0;a<o.length;a++)yield JSON.parse(o[a])}i+=r.decode(),i!==""&&(yield JSON.parse(i))}function Yq(n){return n[Symbol.asyncIterator]!=null}function qc(n){if(Yq(n))return(async()=>{for await(const e of n)return e})();for(const e of n)return e}const oy=Y("/ipns/");function u9(n){return Pe(n.subarray(0,oy.byteLength),oy)}const d9=n=>di(n.slice(oy.length));class Qq{constructor(e){h(this,"client");this.client=e}async*findProviders(e,t={}){yield*Wo(this.client.getProviders(e,t),r=>({id:r.ID,multiaddrs:r.Addrs??[]}))}async provide(){}async put(e,t,r){if(!u9(e))return;const i=d9(e),s=of(t);await this.client.putIPNS(i,s,r)}async get(e,t){if(!u9(e))throw new S("Not found","ERR_NOT_FOUND");const r=d9(e);try{const i=await this.client.getIPNS(r,t);return tC(i)}catch(i){throw i.code==="ERR_BAD_RESPONSE"?new S("Not found","ERR_NOT_FOUND"):i}}}class Xq{constructor(e){h(this,"client");this.client=e}async findPeer(e,t={}){const r=await qc(this.client.getPeers(e,t));if(r!=null)return{id:r.ID,multiaddrs:r.Addrs??[]};throw new S("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){}}const Sn=Su("delegated-routing-v1-http-api-client"),h9={concurrentRequests:4,timeout:3e4};var Sa,pd;class Jq{constructor(e,t={}){le(this,Sa);h(this,"started");h(this,"httpQueue");h(this,"shutDownController");h(this,"clientUrl");h(this,"timeout");h(this,"contentRouting");h(this,"peerRouting");this.started=!1,this.shutDownController=new AbortController,ue(1/0,this.shutDownController.signal),this.httpQueue=new l5({concurrency:t.concurrentRequests??h9.concurrentRequests}),this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??h9.timeout,this.contentRouting=new Qq(this),this.peerRouting=new Xq(this)}get[Cc](){return this.contentRouting}get[Tc](){return this.peerRouting}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.shutDownController.abort(),this.started=!1}async*getProviders(e,t={}){Sn("getProviders starts: %c",e);const r=AbortSignal.timeout(this.timeout),i=bt([this.shutDownController.signal,r,t.signal]);ue(1/0,r,i);const s=Se(),o=Se();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const a=`${this.clientUrl}routing/v1/providers/${e.toString()}`,c=await fetch(a,{headers:{Accept:"application/x-ndjson"},signal:i});if(c.status===404)throw new S("No matching records found.","ERR_NOT_FOUND");if(c.status===422)throw new S("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(c.body==null)throw new S("Routing response had no body","ERR_BAD_RESPONSE");if(c.headers.get("Content-Type")==="application/json"){const d=await c.json();for(const f of d.Providers){const p=Q(this,Sa,pd).call(this,f);p!=null&&(yield p)}}else for await(const d of c9(o9(c.body))){const f=Q(this,Sa,pd).call(this,d);f!=null&&(yield f)}}catch(a){Sn.error("getProviders errored:",a)}finally{i.clear(),o.resolve(),Sn("getProviders finished: %c",e)}}async*getPeers(e,t={}){Sn("getPeers starts: %c",e);const r=AbortSignal.timeout(this.timeout),i=bt([this.shutDownController.signal,r,t.signal]);ue(1/0,r,i);const s=Se(),o=Se();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const a=`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`,c=await fetch(a,{headers:{Accept:"application/x-ndjson"},signal:i});if(c.status===404)throw new S("No matching records found.","ERR_NOT_FOUND");if(c.status===422)throw new S("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(c.body==null)throw new S("Routing response had no body","ERR_BAD_RESPONSE");if(c.headers.get("Content-Type")==="application/json"){const d=await c.json();for(const f of d.Peers){const p=Q(this,Sa,pd).call(this,f);p!=null&&(yield p)}}else for await(const d of c9(o9(c.body))){const f=Q(this,Sa,pd).call(this,d);f!=null&&(yield f)}}catch(a){Sn.error("getPeers errored:",a)}finally{i.clear(),o.resolve(),Sn("getPeers finished: %c",e)}}async getIPNS(e,t={}){Sn("getIPNS starts: %c",e);const r=AbortSignal.timeout(this.timeout),i=bt([this.shutDownController.signal,r,t.signal]);ue(1/0,r,i);const s=Se(),o=Se();this.httpQueue.add(async()=>(s.resolve(),o.promise));const a=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`;try{await s.promise;const c=await fetch(a,{headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:i});if(Sn("getIPNS GET %s %d",a,c.status),c.status===404)throw new S("No matching records found.","ERR_NOT_FOUND");if(c.status===422)throw new S("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(c.body==null)throw new S("GET ipns response had no body","ERR_BAD_RESPONSE");const u=await c.arrayBuffer(),d=new Uint8Array(u,0,u.byteLength);return t.validate!==!1&&await rC(Vq(e),d),of(d)}catch(l){throw Sn.error("getIPNS GET %s error:",a,l),l}finally{i.clear(),o.resolve(),Sn("getIPNS finished: %c",e)}}async putIPNS(e,t,r={}){Sn("putIPNS starts: %c",e);const i=AbortSignal.timeout(this.timeout),s=bt([this.shutDownController.signal,i,r.signal]);ue(1/0,i,s);const o=Se(),a=Se();this.httpQueue.add(async()=>(o.resolve(),a.promise));const l=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`;try{await o.promise;const c=tC(t),d=await fetch(l,{method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:c,signal:s});if(Sn("putIPNS PUT %s %d",l,d.status),d.status!==200)throw new S("PUT ipns response had status other than 200","ERR_BAD_RESPONSE")}catch(c){throw Sn.error("putIPNS PUT %s error:",l,c.stack),c}finally{s.clear(),a.resolve(),Sn("putIPNS finished: %c",e)}}}Sa=new WeakSet,pd=function(e){var t;try{const r=[],i=((t=e.Addrs)==null?void 0:t.map(xe))??[];return e.Protocols!=null&&r.push(...e.Protocols),e.Protocol!=null&&(r.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:xt(e.ID),Addrs:i,Protocols:r}}catch(r){Sn.error("could not conform record to peer schema",r)}};function Zq(n,e={}){return new Jq(new URL(n),e)}const f9="[a-fA-F\\d:]",fo=n=>n&&n.includeBoundaries?`(?:(?<=\\s|^)(?=${f9})|(?<=${f9})(?=\\s|$))`:"",Qr="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",Ct="[a-fA-F\\d]{1,4}",Tp=`
(?:
(?:${Ct}:){7}(?:${Ct}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${Ct}:){6}(?:${Qr}|:${Ct}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${Ct}:){5}(?::${Qr}|(?::${Ct}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${Ct}:){4}(?:(?::${Ct}){0,1}:${Qr}|(?::${Ct}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${Ct}:){3}(?:(?::${Ct}){0,2}:${Qr}|(?::${Ct}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${Ct}:){2}(?:(?::${Ct}){0,3}:${Qr}|(?::${Ct}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${Ct}:){1}(?:(?::${Ct}){0,4}:${Qr}|(?::${Ct}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${Ct}){0,5}:${Qr}|(?::${Ct}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),ej=new RegExp(`(?:^${Qr}$)|(?:^${Tp}$)`),tj=new RegExp(`^${Qr}$`),nj=new RegExp(`^${Tp}$`),Np=n=>n&&n.exact?ej:new RegExp(`(?:${fo(n)}${Qr}${fo(n)})|(?:${fo(n)}${Tp}${fo(n)})`,"g");Np.v4=n=>n&&n.exact?tj:new RegExp(`${fo(n)}${Qr}${fo(n)}`,"g");Np.v6=n=>n&&n.exact?nj:new RegExp(`${fo(n)}${Tp}${fo(n)}`,"g");function rj(n){const e=(...t)=>n(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${n.name||"<anonymous>"})`,configurable:!0}),e}const{toString:ij}=Object.prototype;function sj(n){return ij.call(n)==="[object RegExp]"}const p9={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function oj(n,e={}){if(!sj(n))throw new TypeError("Expected a RegExp instance");const t=Object.keys(p9).map(i=>(typeof e[i]=="boolean"?e[i]:n[i])?p9[i]:"").join(""),r=new RegExp(e.source||n.source,t);return r.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:n.lastIndex,r}function iC(n,e,{timeout:t}={}){try{return rj(()=>oj(n).test(e),{timeout:t})()}catch(r){throw r}}const aj=15,lj=45,sC={timeout:400};function g9(n){return n.length>lj?!1:iC(Np.v6({exact:!0}),n,sC)}function cj(n){return n.length>aj?!1:iC(Np.v4({exact:!0}),n,sC)}const y9={http:"80",https:"443",ws:"80",wss:"443"},uj=["http","https","ws","wss"];function dj(n,e){e=e??{};const t=e.defaultDnsType??"dns4",{scheme:r,hostname:i,port:s,path:o}=hj(n),a=[fj(i,t),pj(s,r),gj(r)];o!=null&&a.push(yj(o));const l="/"+a.filter(c=>!!c).reduce((c,u)=>c.concat(u),[]).join("/");return xe(l)}function hj(n){const[e]=n.split(":");uj.includes(e)||(n="http"+n.substring(e.length));let{protocol:t,hostname:r,port:i,pathname:s,search:o}=new URL(n);if(i==null||i===""){const l=mj(e);l!=null&&(i=l),l==null&&t==="http:"&&(i="80")}let a;return s!=null&&s!==""&&s!=="/"&&(s.startsWith("/")&&(s=s.substring(1)),a=s),o!=null&&o!==""&&(a=a??"",a+=o),{scheme:e,hostname:r,port:i,path:a}}function fj(n,e){if(!(n==null||n==="")){if(cj(n))return["ip4",n];if(g9(n))return["ip6",n];if(n[0]==="["){const t=n.substring(1,n.length-1);if(g9(t))return["ip6",t]}return[e,n]}}function pj(n,e){if(!(n==null||n===""))return e==="udp"?["udp",n]:["tcp",n]}function gj(n){if(n.match(/^tcp$|^udp$/)==null)return[n]}function yj(n){if(!(n==null||n===""))return["http-path",encodeURIComponent(n)]}function mj(n){if(!(n==null||n===""||y9[n]==null))return y9[n]}const wj=["https://trustless-gateway.link","https://4everland.io"],vj=2336,Ej=Symbol.for("nodejs.util.inspect.custom");var gE,yE;class bj{constructor(e){h(this,"type","url");h(this,"multihash");h(this,"privateKey");h(this,"publicKey");h(this,"url");h(this,gE,!0);this.url=e.toString(),this.multihash=Po.digest(Y(this.url))}[(yE=Ej,gE=lp,yE)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toCID(){return nt.createV1(vj,this.multihash)}toBytes(){return this.toCID().bytes}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=ne(e)),e.toString()===this.toString())}}function _j(n){return n=n.toString(),{id:new bj(new URL(n)),multiaddrs:[dj(n)]}}class Sj{constructor(e={}){h(this,"gateways");this.gateways=(e.gateways??wj).map(t=>_j(t))}async*findProviders(e,t){yield*this.gateways.toSorted(()=>Math.random()>.5?1:-1).map(r=>({...r,protocols:["transport-ipfs-gateway-http"]}))}}function xj(n={}){return new Sj(n)}class kj{constructor(e){h(this,"libp2p");this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,r){await this.libp2p.contentRouting.put(e,t,r)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}}function Rj(n){return new kj(n)}function Aj(n){return n=n??new Error("Not Found"),at(n,"ERR_NOT_FOUND")}const Ij="SHARDING";function Cj(n){return n[Symbol.asyncIterator]!=null}function Z0(n){if(Cj(n))return(async()=>{const t=[];for await(const r of n)t.push(r);return t})();const e=[];for(const t of n)e.push(t);return e}function Tj(n){return n[Symbol.asyncIterator]!=null}function m9(n,e){return Tj(n)?async function*(){yield*(await Z0(n)).sort(e)}():function*(){yield*Z0(n).sort(e)}()}class Nj{put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:r,value:i}of e)await this.put(r,i,t),yield r}async*getMany(e,t={}){for await(const r of e)yield{key:r,value:await this.get(r,t)}}async*deleteMany(e,t={}){for await(const r of e)await this.delete(r,t),yield r}batch(){let e=[],t=[];return{put(r,i){e.push({key:r,value:i})},delete(r){t.push(r)},commit:async r=>{await Fa(this.putMany(e,r)),e=[],await Fa(this.deleteMany(t,r)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let r=this._all(e,t);if(e.prefix!=null){const i=e.prefix;r=oa(r,s=>s.key.toString().startsWith(i))}if(Array.isArray(e.filters)&&(r=e.filters.reduce((i,s)=>oa(i,s),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((i,s)=>m9(i,s),r)),e.offset!=null){let i=0;const s=e.offset;r=oa(r,()=>i++>=s)}return e.limit!=null&&(r=C0(r,e.limit)),r}queryKeys(e,t){let r=this._allKeys(e,t);if(e.prefix!=null){const i=e.prefix;r=oa(r,s=>s.toString().startsWith(i))}if(Array.isArray(e.filters)&&(r=e.filters.reduce((i,s)=>oa(i,s),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((i,s)=>m9(i,s),r)),e.offset!=null){const i=e.offset;let s=0;r=oa(r,()=>s++>=i)}return e.limit!=null&&(r=C0(r,e.limit)),r}}class oC extends Nj{constructor(){super();h(this,"data");this.data=new Map}put(t,r){return this.data.set(t.toString(),r),t}get(t){const r=this.data.get(t.toString());if(r==null)throw Aj();return r}has(t){return this.data.has(t.toString())}delete(t){this.data.delete(t.toString())}*_all(){for(const[t,r]of this.data.entries())yield{key:new ot(t),value:r}}*_allKeys(){for(const t of this.data.keys())yield new ot(t)}}new ot(Ij);Su("datastore:core:tiered");class Dj extends zW{constructor(t){super({...t,components:{libp2p:t.libp2p}});h(this,"libp2p");this.libp2p=t.libp2p}async start(){await super.start(),await this.libp2p.start()}async stop(){await super.stop(),await this.libp2p.stop()}}class Pj{constructor(){h(this,"readNext");h(this,"haveNext");h(this,"ended");h(this,"nextResult");this.ended=!1,this.readNext=Se(),this.haveNext=Se()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Se(),e}async throw(e){return this.ended=!0,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Se(),await Pt(this.readNext.promise,t==null?void 0:t.signal,t)}}function Oj(){return new Pj}class Lj extends Error{constructor(){super(...arguments);h(this,"name","UnexpectedEOFError");h(this,"code","ERR_UNEXPECTED_EOF")}}class Bj extends Error{constructor(t,r){super(t);h(this,"code");this.code=r}}class Mj extends Bj{constructor(t){super(t,"ABORT_ERR");h(this,"type");this.type="aborted",this.name="AbortError"}}function aC(n,e){const t=Oj();n.sink(t).catch(async o=>{await t.end(o)}),n.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let r=n.source;n.source[Symbol.iterator]!=null?r=n.source[Symbol.iterator]():n.source[Symbol.asyncIterator]!=null&&(r=n.source[Symbol.asyncIterator]());const i=new Fe;return{read:async(o,a)=>{var u,d;(u=a==null?void 0:a.signal)==null||u.throwIfAborted();let l;const c=new Promise((f,p)=>{var y;l=()=>{p(new Mj("Read aborted"))},(y=a==null?void 0:a.signal)==null||y.addEventListener("abort",l)});try{if(o==null){const{done:p,value:y}=await Promise.race([r.next(),c]);return p===!0?new Fe:y}for(;i.byteLength<o;){const{value:p,done:y}=await Promise.race([r.next(),c]);if(y===!0)throw new Lj("unexpected end of input");i.append(p)}const f=i.sublist(0,o);return i.consume(o),f}finally{l!=null&&((d=a==null?void 0:a.signal)==null||d.removeEventListener("abort",l))}},write:async(o,a)=>{var l;(l=a==null?void 0:a.signal)==null||l.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(i.byteLength>0){const o=n.source;n.source=async function*(){(e==null?void 0:e.yieldBytes)===!1?yield i:yield*i,yield*o}()}return n}}}class $j extends Error{constructor(){super(...arguments);h(this,"name","InvalidMessageLengthError");h(this,"code","ERR_INVALID_MSG_LENGTH")}}class Uj extends Error{constructor(){super(...arguments);h(this,"name","InvalidDataLengthError");h(this,"code","ERR_MSG_DATA_TOO_LONG")}}class Fj extends Error{constructor(){super(...arguments);h(this,"name","InvalidDataLengthLengthError");h(this,"code","ERR_MSG_LENGTH_TOO_LONG")}}function jc(n,e={}){const t=aC(n,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=ht(e.maxDataLength));const r=(e==null?void 0:e.lengthDecoder)??wu,i=(e==null?void 0:e.lengthEncoder)??ii;return{read:async o=>{let a=-1;const l=new Fe;for(;;){l.append(await t.read(1,o));try{a=r(l)}catch(c){if(c instanceof RangeError)continue;throw c}if(a<0)throw new $j("Invalid message length");if((e==null?void 0:e.maxLengthLength)!=null&&l.byteLength>e.maxLengthLength)throw new Fj("message length length too long");if(a>-1)break}if((e==null?void 0:e.maxDataLength)!=null&&a>e.maxDataLength)throw new Uj("message length too long");return t.read(a,o)},write:async(o,a)=>{await t.write(new Fe(i(o.byteLength),o),a)},writeV:async(o,a)=>{const l=new Fe(...o.flatMap(c=>[i(c.byteLength),c]));await t.write(l,a)},unwrap:()=>t.unwrap()}}function w9(){const n=Se();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,n.resolve(t)},source:async function*(){yield*await n.promise}()}}function zj(){const n=w9(),e=w9();return[{source:n.source,sink:e.sink},{source:e.source,sink:n.sink}]}const xh=65535,v9=xh-16;var mE,wE;const af=!!((wE=(mE=globalThis.process)==null?void 0:mE.env)!=null&&wE.DUMP_SESSION_KEYS);function r3(n){if(!Number.isSafeInteger(n)||n<0)throw new Error(`positive integer expected, not ${n}`)}function E9(n){if(typeof n!="boolean")throw new Error(`boolean expected, not ${n}`)}function lC(n){return n instanceof Uint8Array||n!=null&&typeof n=="object"&&n.constructor.name==="Uint8Array"}function Bi(n,...e){if(!lC(n))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(n.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${n.length}`)}function b9(n,e=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(e&&n.finished)throw new Error("Hash#digest() has already been called")}function Vj(n,e){Bi(n);const t=e.outputLen;if(n.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const Ao=n=>new Uint32Array(n.buffer,n.byteOffset,Math.floor(n.byteLength/4)),Hj=n=>new DataView(n.buffer,n.byteOffset,n.byteLength),Kj=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!Kj)throw new Error("Non little-endian hardware is not supported");function Wj(n){if(typeof n!="string")throw new Error(`string expected, got ${typeof n}`);return new Uint8Array(new TextEncoder().encode(n))}function ay(n){if(typeof n=="string")n=Wj(n);else if(lC(n))n=ly(n);else throw new Error(`Uint8Array expected, got ${typeof n}`);return n}function Gj(n,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(n,e)}function qj(n,e){if(n.length!==e.length)return!1;let t=0;for(let r=0;r<n.length;r++)t|=n[r]^e[r];return t===0}const jj=(n,e)=>(Object.assign(e,n),e);function _9(n,e,t,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(e,t,r);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),l=4,c=0;n.setUint32(e+l,o,r),n.setUint32(e+c,a,r)}function ly(n){return Uint8Array.from(n)}function Yc(...n){for(let e=0;e<n.length;e++)n[e].fill(0)}const cC=n=>Uint8Array.from(n.split("").map(e=>e.charCodeAt(0))),Yj=cC("expand 16-byte k"),Qj=cC("expand 32-byte k"),Xj=Ao(Yj),uC=Ao(Qj);uC.slice();function $e(n,e){return n<<e|n>>>32-e}function cy(n){return n.byteOffset%4===0}const Zf=64,Jj=16,dC=2**32-1,S9=new Uint32Array;function Zj(n,e,t,r,i,s,o,a){const l=i.length,c=new Uint8Array(Zf),u=Ao(c),d=cy(i)&&cy(s),f=d?Ao(i):S9,p=d?Ao(s):S9;for(let y=0;y<l;o++){if(n(e,t,r,u,o,a),o>=dC)throw new Error("arx: counter overflow");const g=Math.min(Zf,l-y);if(d&&g===Zf){const w=y/4;if(y%4!==0)throw new Error("arx: invalid block position");for(let m=0,E;m<Jj;m++)E=w+m,p[E]=f[E]^u[m];y+=Zf;continue}for(let w=0,m;w<g;w++)m=y+w,s[m]=i[m]^c[w];y+=g}}function eY(n,e){const{allowShortKeys:t,extendNonceFn:r,counterLength:i,counterRight:s,rounds:o}=Gj({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof n!="function")throw new Error("core must be a function");return r3(i),r3(o),E9(s),E9(t),(a,l,c,u,d=0)=>{Bi(a),Bi(l),Bi(c);const f=c.length;if(u===void 0&&(u=new Uint8Array(f)),Bi(u),r3(d),d<0||d>=dC)throw new Error("arx: counter overflow");if(u.length<f)throw new Error(`arx: output (${u.length}) is shorter than data (${f})`);const p=[];let y=a.length,g,w;if(y===32)p.push(g=ly(a)),w=uC;else if(y===16&&t)g=new Uint8Array(32),g.set(a),g.set(a,16),w=Xj,p.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${y}`);cy(l)||p.push(l=ly(l));const m=Ao(g);if(r){if(l.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(w,m,Ao(l.subarray(0,16)),m),l=l.subarray(16)}const E=16-i;if(E!==l.length)throw new Error(`arx: nonce must be ${E} or 16 bytes`);if(E!==12){const b=new Uint8Array(12);b.set(l,s?0:12-l.length),l=b,p.push(l)}const v=Ao(l);return Zj(n,w,m,v,c,u,d,o),Yc(...p),u}}const Gt=(n,e)=>n[e++]&255|(n[e++]&255)<<8;class tY{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=ay(e),Bi(e,32);const t=Gt(e,0),r=Gt(e,2),i=Gt(e,4),s=Gt(e,6),o=Gt(e,8),a=Gt(e,10),l=Gt(e,12),c=Gt(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|r<<3)&8191,this.r[2]=(r>>>10|i<<6)&7939,this.r[3]=(i>>>7|s<<9)&8191,this.r[4]=(s>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|l<<5)&8065,this.r[8]=(l>>>8|c<<8)&8191,this.r[9]=c>>>5&127;for(let u=0;u<8;u++)this.pad[u]=Gt(e,16+2*u)}process(e,t,r=!1){const i=r?0:2048,{h:s,r:o}=this,a=o[0],l=o[1],c=o[2],u=o[3],d=o[4],f=o[5],p=o[6],y=o[7],g=o[8],w=o[9],m=Gt(e,t+0),E=Gt(e,t+2),v=Gt(e,t+4),b=Gt(e,t+6),k=Gt(e,t+8),A=Gt(e,t+10),T=Gt(e,t+12),P=Gt(e,t+14);let _=s[0]+(m&8191),N=s[1]+((m>>>13|E<<3)&8191),V=s[2]+((E>>>10|v<<6)&8191),z=s[3]+((v>>>7|b<<9)&8191),R=s[4]+((b>>>4|k<<12)&8191),C=s[5]+(k>>>1&8191),x=s[6]+((k>>>14|A<<2)&8191),M=s[7]+((A>>>11|T<<5)&8191),K=s[8]+((T>>>8|P<<8)&8191),L=s[9]+(P>>>5|i),O=0,H=O+_*a+N*(5*w)+V*(5*g)+z*(5*y)+R*(5*p);O=H>>>13,H&=8191,H+=C*(5*f)+x*(5*d)+M*(5*u)+K*(5*c)+L*(5*l),O+=H>>>13,H&=8191;let G=O+_*l+N*a+V*(5*w)+z*(5*g)+R*(5*y);O=G>>>13,G&=8191,G+=C*(5*p)+x*(5*f)+M*(5*d)+K*(5*u)+L*(5*c),O+=G>>>13,G&=8191;let j=O+_*c+N*l+V*a+z*(5*w)+R*(5*g);O=j>>>13,j&=8191,j+=C*(5*y)+x*(5*p)+M*(5*f)+K*(5*d)+L*(5*u),O+=j>>>13,j&=8191;let be=O+_*u+N*c+V*l+z*a+R*(5*w);O=be>>>13,be&=8191,be+=C*(5*g)+x*(5*y)+M*(5*p)+K*(5*f)+L*(5*d),O+=be>>>13,be&=8191;let Ee=O+_*d+N*u+V*c+z*l+R*a;O=Ee>>>13,Ee&=8191,Ee+=C*(5*w)+x*(5*g)+M*(5*y)+K*(5*p)+L*(5*f),O+=Ee>>>13,Ee&=8191;let pe=O+_*f+N*d+V*u+z*c+R*l;O=pe>>>13,pe&=8191,pe+=C*a+x*(5*w)+M*(5*g)+K*(5*y)+L*(5*p),O+=pe>>>13,pe&=8191;let we=O+_*p+N*f+V*d+z*u+R*c;O=we>>>13,we&=8191,we+=C*l+x*a+M*(5*w)+K*(5*g)+L*(5*y),O+=we>>>13,we&=8191;let Ie=O+_*y+N*p+V*f+z*d+R*u;O=Ie>>>13,Ie&=8191,Ie+=C*c+x*l+M*a+K*(5*w)+L*(5*g),O+=Ie>>>13,Ie&=8191;let Ze=O+_*g+N*y+V*p+z*f+R*d;O=Ze>>>13,Ze&=8191,Ze+=C*u+x*c+M*l+K*a+L*(5*w),O+=Ze>>>13,Ze&=8191;let D=O+_*w+N*g+V*y+z*p+R*f;O=D>>>13,D&=8191,D+=C*d+x*u+M*c+K*l+L*a,O+=D>>>13,D&=8191,O=(O<<2)+O|0,O=O+H|0,H=O&8191,O=O>>>13,G+=O,s[0]=H,s[1]=G,s[2]=j,s[3]=be,s[4]=Ee,s[5]=pe,s[6]=we,s[7]=Ie,s[8]=Ze,s[9]=D}finalize(){const{h:e,pad:t}=this,r=new Uint16Array(10);let i=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=i,i=e[a]>>>13,e[a]&=8191;e[0]+=i*5,i=e[0]>>>13,e[0]&=8191,e[1]+=i,i=e[1]>>>13,e[1]&=8191,e[2]+=i,r[0]=e[0]+5,i=r[0]>>>13,r[0]&=8191;for(let a=1;a<10;a++)r[a]=e[a]+i,i=r[a]>>>13,r[a]&=8191;r[9]-=8192;let s=(i^1)-1;for(let a=0;a<10;a++)r[a]&=s;s=~s;for(let a=0;a<10;a++)e[a]=e[a]&s|r[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;Yc(r)}update(e){b9(this);const{buffer:t,blockLen:r}=this;e=ay(e);const i=e.length;for(let s=0;s<i;){const o=Math.min(r-this.pos,i-s);if(o===r){for(;r<=i-s;s+=r)this.process(e,s);continue}t.set(e.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===r&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){Yc(this.h,this.r,this.buffer,this.pad)}digestInto(e){b9(this),Vj(e,this),this.finished=!0;const{buffer:t,h:r}=this;let{pos:i}=this;if(i){for(t[i++]=1;i<16;i++)t[i]=0;this.process(t,0,!0)}this.finalize();let s=0;for(let o=0;o<8;o++)e[s++]=r[o]>>>0,e[s++]=r[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}}function nY(n){const e=(r,i)=>n(i).update(ay(r)).digest(),t=n(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=r=>n(r),e}const rY=nY(n=>new tY(n));function iY(n,e,t,r,i,s=20){let o=n[0],a=n[1],l=n[2],c=n[3],u=e[0],d=e[1],f=e[2],p=e[3],y=e[4],g=e[5],w=e[6],m=e[7],E=i,v=t[0],b=t[1],k=t[2],A=o,T=a,P=l,_=c,N=u,V=d,z=f,R=p,C=y,x=g,M=w,K=m,L=E,O=v,H=b,G=k;for(let be=0;be<s;be+=2)A=A+N|0,L=$e(L^A,16),C=C+L|0,N=$e(N^C,12),A=A+N|0,L=$e(L^A,8),C=C+L|0,N=$e(N^C,7),T=T+V|0,O=$e(O^T,16),x=x+O|0,V=$e(V^x,12),T=T+V|0,O=$e(O^T,8),x=x+O|0,V=$e(V^x,7),P=P+z|0,H=$e(H^P,16),M=M+H|0,z=$e(z^M,12),P=P+z|0,H=$e(H^P,8),M=M+H|0,z=$e(z^M,7),_=_+R|0,G=$e(G^_,16),K=K+G|0,R=$e(R^K,12),_=_+R|0,G=$e(G^_,8),K=K+G|0,R=$e(R^K,7),A=A+V|0,G=$e(G^A,16),M=M+G|0,V=$e(V^M,12),A=A+V|0,G=$e(G^A,8),M=M+G|0,V=$e(V^M,7),T=T+z|0,L=$e(L^T,16),K=K+L|0,z=$e(z^K,12),T=T+z|0,L=$e(L^T,8),K=K+L|0,z=$e(z^K,7),P=P+R|0,O=$e(O^P,16),C=C+O|0,R=$e(R^C,12),P=P+R|0,O=$e(O^P,8),C=C+O|0,R=$e(R^C,7),_=_+N|0,H=$e(H^_,16),x=x+H|0,N=$e(N^x,12),_=_+N|0,H=$e(H^_,8),x=x+H|0,N=$e(N^x,7);let j=0;r[j++]=o+A|0,r[j++]=a+T|0,r[j++]=l+P|0,r[j++]=c+_|0,r[j++]=u+N|0,r[j++]=d+V|0,r[j++]=f+z|0,r[j++]=p+R|0,r[j++]=y+C|0,r[j++]=g+x|0,r[j++]=w+M|0,r[j++]=m+K|0,r[j++]=E+L|0,r[j++]=v+O|0,r[j++]=b+H|0,r[j++]=k+G|0}const sY=eY(iY,{counterRight:!1,counterLength:4,allowShortKeys:!1}),oY=new Uint8Array(16),x9=(n,e)=>{n.update(e);const t=e.length%16;t&&n.update(oY.subarray(t))},aY=new Uint8Array(32);function k9(n,e,t,r,i){const s=n(e,t,aY),o=rY.create(s);i&&x9(o,i),x9(o,r);const a=new Uint8Array(16),l=Hj(a);_9(l,0,BigInt(i?i.length:0),!0),_9(l,8,BigInt(r.length),!0),o.update(a);const c=o.digest();return Yc(s,a),c}const lY=n=>(e,t,r)=>(Bi(e,32),Bi(t),{encrypt(s,o){const a=s.length,l=a+16;o?Bi(o,l):o=new Uint8Array(l),n(e,t,s,o,1);const c=k9(n,e,t,o.subarray(0,-16),r);return o.set(c,a),Yc(c),o},decrypt(s,o){const a=s.length,l=a-16;if(a<16)throw new Error("encrypted data must be at least 16 bytes");o?Bi(o,l):o=new Uint8Array(l);const c=s.subarray(0,-16),u=s.subarray(-16),d=k9(n,e,t,c,r);if(!qj(u,d))throw new Error("invalid tag");return n(e,t,c,o,1),Yc(d),o}}),R9=jj({blockSize:64,nonceLength:12,tagLength:16},lY(sY));function cY(n,e,t){return Qh(n),t===void 0&&(t=new Uint8Array(n.outputLen)),Zh(n,uh(t),uh(e))}const i3=Uint8Array.from([0]),A9=Uint8Array.of();function uY(n,e,t,r=32){Qh(n),Na(r);const i=n.outputLen;if(r>255*i)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(r/i);t===void 0&&(t=A9);const o=new Uint8Array(s*i),a=Zh.create(n,e),l=a._cloneInto(),c=new Uint8Array(a.outputLen);for(let u=0;u<s;u++)i3[0]=u+1,l.update(u===0?A9:c).update(t).update(i3).digestInto(c),o.set(c,i*u),a._cloneInto(l);return a.destroy(),l.destroy(),ji(c,i3),o.slice(0,r)}const dY={hashSHA256(n){return A1(n.subarray())},getHKDF(n,e){const t=cY(A1,e,n),i=uY(A1,t,void 0,96),s=i.subarray(0,32),o=i.subarray(32,64),a=i.subarray(64,96);return[s,o,a]},generateX25519KeyPair(){const n=Wf.utils.randomPrivateKey();return{publicKey:Wf.getPublicKey(n),privateKey:n}},generateX25519KeyPairFromSeed(n){return{publicKey:Wf.getPublicKey(n),privateKey:n}},generateX25519SharedKey(n,e){return Wf.getSharedSecret(n.subarray(),e.subarray())},chaCha20Poly1305Encrypt(n,e,t,r){return R9(r,e,t).encrypt(n.subarray())},chaCha20Poly1305Decrypt(n,e,t,r,i){return R9(r,e,t).decrypt(n.subarray(),i)}},hY=dY;function fY(n){return{generateKeypair:n.generateX25519KeyPair,dh:(e,t)=>n.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:n.chaCha20Poly1305Encrypt,decrypt:n.chaCha20Poly1305Decrypt,hash:n.hashSHA256,hkdf:n.getHKDF}}const e2=n=>{const e=dr(2);return e[0]=n>>8,e[1]=n,e};e2.bytes=2;const O1=n=>{if(n.length<2)throw RangeError("Could not decode int16BE");if(n instanceof Uint8Array){let e=0;return e+=n[0]<<8,e+=n[1],e}return n.getUint16(0)};O1.bytes=2;function pY(n){return{xxHandshakeSuccesses:n.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:n.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:n.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:n.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:n.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function hC(n,e){!e.enabled||!af||(n?(e(`LOCAL_STATIC_PUBLIC_KEY ${ne(n.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${ne(n.privateKey,"hex")}`)):e("Missing local static keys."))}function fC(n,e){!e.enabled||!af||(n?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${ne(n.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${ne(n.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function gY(n,e){!e.enabled||!af||e(n?`REMOTE_STATIC_PUBLIC_KEY ${ne(n.subarray(),"hex")}`:"Missing remote static public key.")}function pC(n,e){!e.enabled||!af||e(n?`REMOTE_EPHEMERAL_PUBLIC_KEY ${ne(n.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function gC(n,e,t){!t.enabled||!af||(t(`CIPHER_STATE_1 ${n.n.getUint64()} ${n.k&&ne(n.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&ne(e.k,"hex")}`))}function Qc(n,e){if(n.length!==e.length)throw new Error("Inputs should have the same length");const t=dr(n.length);for(let r=0;r<n.length;r++)t[r]=n[r]^e[r];return t}const P2=class P2 extends Error{constructor(t="Unexpected Peer"){super(t);h(this,"code");this.code=P2.code}};h(P2,"code","ERR_UNEXPECTED_PEER");let uy=P2;const O2=class O2 extends Error{constructor(t="Invalid crypto exchange"){super(t);h(this,"code");this.code=O2.code}};h(O2,"code","ERR_INVALID_CRYPTO_EXCHANGE");let Pd=O2;const yY=0,mY=4294967295,wY="Cipherstate has reached maximum n, a new handshake must be performed";class vY{constructor(e=yY){h(this,"n");h(this,"bytes");h(this,"view");this.n=e,this.bytes=Xe(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>mY)throw new Error(wY)}}const ic=Xe(0);class e1{constructor(e,t=void 0,r=0){h(this,"k");h(this,"n");h(this,"crypto");this.crypto=e,this.k=t,this.n=new vY(r)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const r=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),r}decryptWithAd(e,t,r){if(!this.hasKey())return t;this.n.assertValue();const i=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,r);return this.n.increment(),i}}class EY{constructor(e,t){h(this,"cs");h(this,"ck");h(this,"h");h(this,"crypto");this.crypto=e;const r=Y(t,"utf-8");this.h=_Y(e,r),this.ck=this.h,this.cs=new e1(e)}mixKey(e){const[t,r]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new e1(this.crypto,r)}mixHash(e){this.h=this.crypto.hash(new Fe(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,ic);return[new e1(this.crypto,e),new e1(this.crypto,t)]}}class bY{constructor(e){h(this,"ss");h(this,"s");h(this,"e");h(this,"rs");h(this,"re");h(this,"initiator");h(this,"crypto");const{crypto:t,protocolName:r,prologue:i,initiator:s,s:o,e:a,rs:l,re:c}=e;this.crypto=t,this.ss=new EY(t,r),this.ss.mixHash(i),this.initiator=s,this.s=o,this.e=a,this.rs=l,this.re=c}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const r=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+r)throw new Error("message is not long enough");const i=e.sublist(t,t+r);return this.rs=this.ss.decryptAndHash(i),r}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class yC extends bY{writeMessageA(e){return new Fe(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const r=this.writeS();return this.writeES(),new Fe(t,r,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new Fe(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new Pd(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new Pd(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new Pd(`handshake stage 2 validation fail: ${t.message}`)}}}function _Y(n,e){if(e.length<=32){const t=Xe(32);return t.set(e),t}else return n.hash(e)}var t2;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.webtransportCerthashes!=null)for(const s of t.webtransportCerthashes)r.uint32(10),r.bytes(s);i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={webtransportCerthashes:[]},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:{i.webtransportCerthashes.push(t.bytes());break}default:{t.skipType(o&7);break}}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(t2||(t2={}));var n2;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(r.uint32(10),r.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(r.uint32(18),r.bytes(t.identitySig)),t.extensions!=null&&(r.uint32(34),t2.codec().encode(t.extensions,r)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={identityKey:Xe(0),identitySig:Xe(0)},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:{i.identityKey=t.bytes();break}case 2:{i.identitySig=t.bytes();break}case 4:{i.extensions=t2.codec().decode(t,t.uint32());break}default:{t.skipType(o&7);break}}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(n2||(n2={}));async function mC(n,e,t){const r=await n.sign(vC(e));return n2.encode({identityKey:n.public.bytes,identitySig:r,extensions:t})}async function wC(n,e,t){try{const r=n2.decode(n);if(t){const o=t.subarray();if(!Pe(o,r.identityKey))throw new Error(`Payload identity key ${ne(r.identityKey,"hex")} does not match expected remote identity key ${ne(o,"hex")}`)}if(!e)throw new Error("Remote static does not exist");const i=vC(e);if(!await mh(r.identityKey).verify(i,r.identitySig))throw new Error("Invalid payload signature");return r}catch(r){throw new uy(r.message)}}function vC(n){const e=Y("noise-libp2p-static-key:");return n instanceof Uint8Array?vn([e,n],e.length+n.length):(n.prepend(e),n)}async function SY(n,e){const{log:t,connection:r,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:l,extensions:c}=n,u=await mC(s,a.publicKey,c),d=new yC({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});hC(d.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await r.write(d.writeMessageA(ic),e),t.trace("Stage 0 - Initiator finished sending first message."),fC(d.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const f=d.readMessageB(await r.read(e));t.trace("Stage 1 - Initiator received the message."),pC(d.re,t),gY(d.rs,t),t.trace("Initiator going to check remote's signature...");const p=await wC(f,d.rs,l);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await r.write(d.writeMessageC(u),e),t.trace("Stage 2 - Initiator sent message with signed payload.");const[y,g]=d.ss.split();return gC(y,g,t),{payload:p,encrypt:w=>y.encryptWithAd(ic,w),decrypt:(w,m)=>g.decryptWithAd(ic,w,m)}}async function xY(n,e){const{log:t,connection:r,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:l,extensions:c}=n,u=await mC(s,a.publicKey,c),d=new yC({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});hC(d.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),d.readMessageA(await r.read(e)),t.trace("Stage 0 - Responder received first message."),pC(d.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await r.write(d.writeMessageB(u),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),fC(d.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const f=d.readMessageC(await r.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");const p=await wC(f,d.rs,l),[y,g]=d.ss.split();return gC(y,g,t),{payload:p,encrypt:w=>g.encryptWithAd(ic,w),decrypt:(w,m)=>y.decryptWithAd(ic,w,m)}}const I9=16;function kY(n,e){return async function*(t){for await(const r of t)for(let i=0;i<r.length;i+=v9){let s=i+v9;s>r.length&&(s=r.length);let o;r instanceof Uint8Array?o=n.encrypt(r.subarray(i,s)):o=n.encrypt(r.sublist(i,s)),e==null||e.encryptedPackets.increment(),yield new Fe(e2(o.byteLength),o)}}}function RY(n,e){return async function*(t){for await(const r of t)for(let i=0;i<r.length;i+=xh){let s=i+xh;if(s>r.length&&(s=r.length),s-I9<i)throw new Error("Invalid chunk");const o=r.sublist(i,s),a=r.subarray(i,s-I9);try{const l=n.decrypt(o,a);e==null||e.decryptedPackets.increment(),yield l}catch(l){throw e==null||e.decryptErrors.increment(),l}}}}var vE,EE;EE=Symbol.toStringTag,vE=Dn;class AY{constructor(e,t={}){h(this,"protocol","/noise");h(this,"crypto");h(this,"prologue");h(this,"staticKey");h(this,"extensions");h(this,"metrics");h(this,"components");h(this,EE,"@chainsafe/libp2p-noise");h(this,vE,["@libp2p/connection-encryption","@chainsafe/libp2p-noise"]);const{staticNoiseKey:r,extensions:i,crypto:s,prologueBytes:o}=t,{metrics:a}=e;this.components=e;const l=s??hY;this.crypto=fY(l),this.extensions=i,this.metrics=a?pY(a):void 0,r?this.staticKey=l.generateX25519KeyPairFromSeed(r):this.staticKey=l.generateX25519KeyPair(),this.prologue=o??Xe(0)}async secureOutbound(...e){const{localPeer:t,connection:r,remotePeer:i,signal:s}=this.parseArgs(e),o=jc(r,{lengthEncoder:e2,lengthDecoder:O1,maxDataLength:xh});if(!t.privateKey)throw new S("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const a=await zc(t.privateKey),l=i==null?void 0:i.publicKey,c=await this.performHandshakeInitiator(o,a,l,{signal:s}),u=await this.createSecureConnection(o,c);return r.source=u.source,r.sink=u.sink,{conn:r,remoteExtensions:c.payload.extensions,remotePeer:await qi(c.payload.identityKey)}}async secureInbound(...e){const{localPeer:t,connection:r,remotePeer:i,signal:s}=this.parseArgs(e),o=jc(r,{lengthEncoder:e2,lengthDecoder:O1,maxDataLength:xh});if(!t.privateKey)throw new S("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const a=await zc(t.privateKey),l=i==null?void 0:i.publicKey,c=await this.performHandshakeResponder(o,a,l,{signal:s}),u=await this.createSecureConnection(o,c);return r.source=u.source,r.sink=u.sink,{conn:r,remoteExtensions:c.payload.extensions,remotePeer:await qi(c.payload.identityKey)}}async performHandshakeInitiator(e,t,r,i){var o,a;let s;try{s=await SY({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},i),(o=this.metrics)==null||o.xxHandshakeSuccesses.increment()}catch(l){throw(a=this.metrics)==null||a.xxHandshakeErrors.increment(),l}return s}async performHandshakeResponder(e,t,r,i){var o,a;let s;try{s=await xY({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},i),(o=this.metrics)==null||o.xxHandshakeSuccesses.increment()}catch(l){throw(a=this.metrics)==null||a.xxHandshakeErrors.increment(),l}return s}async createSecureConnection(e,t){const[r,i]=zj(),s=e.unwrap();return await En(r,kY(t,this.metrics),s,o=>Do(o,{lengthDecoder:O1}),RY(t,this.metrics),r),i}parseArgs(e){var t,r;return cp(e[0])?{localPeer:e[0],connection:e[1],remotePeer:e[2]}:{localPeer:this.components.peerId,connection:e[0],remotePeer:(t=e[1])==null?void 0:t.remotePeer,signal:(r=e[1])==null?void 0:r.signal}}}function N5(n={}){return e=>new AY(e,n)}function EC(n){if(n!=null){if(typeof n[Symbol.iterator]=="function")return n[Symbol.iterator]();if(typeof n[Symbol.asyncIterator]=="function")return n[Symbol.asyncIterator]();if(typeof n.next=="function")return n}throw new Error("argument is not an iterator or iterable")}const gd="ERR_INVALID_FRAME",bC="ERR_UNREQUESTED_PING",_C="ERR_NOT_MATCHING_PING",SC="ERR_STREAM_ALREADY_EXISTS",xC="ERR_DECODE_INVALID_VERSION",kC="ERR_BOTH_CLIENTS",RC="ERR_RECV_WINDOW_EXCEEDED",IY=new Set([gd,bC,_C,SC,xC,kC,RC]),Jo="ERR_INVALID_CONFIG",s3="ERR_MUXER_LOCAL_CLOSED",C9="ERR_MUXER_REMOTE_CLOSED",CY="ERR_STREAM_ABORT",TY="ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED",NY="ERR_DECODE_IN_PROGRESS",D5=256*1024,DY=16*1024*1024,PY={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:D5,maxStreamWindowSize:DY,maxMessageSize:64*1024};function OY(n){if(n.keepAliveInterval<=0)throw new S("keep-alive interval must be positive",Jo);if(n.maxInboundStreams<0)throw new S("max inbound streams must be larger or equal 0",Jo);if(n.maxOutboundStreams<0)throw new S("max outbound streams must be larger or equal 0",Jo);if(n.initialStreamWindowSize<D5)throw new S("InitialStreamWindowSize must be larger or equal 256 kB",Jo);if(n.maxStreamWindowSize<n.initialStreamWindowSize)throw new S("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",Jo);if(n.maxStreamWindowSize>2**32-1)throw new S("MaxStreamWindowSize must be less than equal MAX_UINT32",Jo);if(n.maxMessageSize<1024)throw new S("MaxMessageSize must be greater than a kilobyte",Jo)}var Lt;(function(n){n[n.Data=0]="Data",n[n.WindowUpdate=1]="WindowUpdate",n[n.Ping=2]="Ping",n[n.GoAway=3]="GoAway"})(Lt||(Lt={}));var vt;(function(n){n[n.SYN=1]="SYN",n[n.ACK=2]="ACK",n[n.FIN=4]="FIN",n[n.RST=8]="RST"})(vt||(vt={}));Object.values(vt).filter(n=>typeof n!="string");const LY=0;var Si;(function(n){n[n.NormalTermination=0]="NormalTermination",n[n.ProtocolError=1]="ProtocolError",n[n.InternalError=2]="InternalError"})(Si||(Si={}));const Od=12,T9=2**24;function BY(n){if(n[0]!==LY)throw new S("Invalid frame version",xC);return{type:n[1],flag:(n[2]<<8)+n[3],streamID:n[4]*T9+(n[5]<<16)+(n[6]<<8)+n[7],length:n[8]*T9+(n[9]<<16)+(n[10]<<8)+n[11]}}let MY=class{constructor(e){h(this,"source");h(this,"buffer");h(this,"frameInProgress");this.source=$Y(e),this.buffer=new Fe,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const t=this.readHeader();if(t===void 0)break;const{type:r,length:i}=t;r===Lt.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,i)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new S("decoding frame already in progress",NY);if(this.buffer.length<Od)return;const e=BY(this.buffer.subarray(0,Od));return this.buffer.consume(Od),e}async readBytes(e){if(this.buffer.length<e){for await(const r of this.source)if(this.buffer.append(r),this.buffer.length>=e)break}const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function $Y(n){if(n[Symbol.iterator]!==void 0){const e=n[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(n[Symbol.asyncIterator]!==void 0){const e=n[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function N9(n){const e=new Uint8Array(Od);return e[1]=n.type,e[2]=n.flag>>>8,e[3]=n.flag,e[4]=n.streamID>>>24,e[5]=n.streamID>>>16,e[6]=n.streamID>>>8,e[7]=n.streamID,e[8]=n.length>>>24,e[9]=n.length>>>16,e[10]=n.length>>>8,e[11]=n.length,e}function UY(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function AC(n,e){var r,i;const t=(i=(r=EC(n)).return)==null?void 0:i.call(r);UY(t)&&t.catch(s=>{e.error("could not cause iterator to return",s)})}const FY="ERR_STREAM_RESET",zY="ERR_SINK_INVALID_STATE",VY=5e3;function o3(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}class Dp{constructor(e){h(this,"id");h(this,"direction");h(this,"timeline");h(this,"protocol");h(this,"metadata");h(this,"source");h(this,"status");h(this,"readStatus");h(this,"writeStatus");h(this,"log");h(this,"sinkController");h(this,"sinkEnd");h(this,"closed");h(this,"endErr");h(this,"streamSource");h(this,"onEnd");h(this,"onCloseRead");h(this,"onCloseWrite");h(this,"onReset");h(this,"onAbort");h(this,"sendCloseWriteTimeout");h(this,"sendingData");this.sinkController=new AbortController,this.sinkEnd=Se(),this.closed=Se(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??VY,this.onEnd=e.onEnd,this.onCloseRead=e==null?void 0:e.onCloseRead,this.onCloseWrite=e==null?void 0:e.onCloseWrite,this.onReset=e==null?void 0:e.onReset,this.onAbort=e==null?void 0:e.onAbort,this.source=this.streamSource=Ko({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new S(`writable end state is "${this.writeStatus}" not "ready"`,zY);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if(this.direction==="outbound"){const i=this.sendNewStream(t);o3(i)&&await i}const r=()=>{AC(e,this.log)};try{this.sinkController.signal.addEventListener("abort",r),this.log.trace("sink reading from source");for await(let i of e){i=i instanceof Uint8Array?new Fe(i):i;const s=this.sendData(i,t);o3(s)&&(this.sendingData=Se(),await s,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",r)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){var t;this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),(t=this.onCloseRead)==null||t.call(this),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){var t;this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),(t=this.onCloseWrite)==null||t.call(this),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await Pt(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e==null?void 0:e.signal),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await Pt(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await Pt(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await Pt(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){var r;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();o3(t)&&t.catch(i=>{this.log.error("error sending reset message",i)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),(r=this.onAbort)==null||r.call(this,e)}reset(){var t;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const e=new S("stream reset",FY);this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),(t=this.onReset)==null||t.call(this)}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}var Xr;(function(n){n[n.Init=0]="Init",n[n.SYNSent=1]="SYNSent",n[n.SYNReceived=2]="SYNReceived",n[n.Established=3]="Established",n[n.Finished=4]="Finished"})(Xr||(Xr={}));class HY extends Dp{constructor(t){super({...t,onEnd:r=>{var i;this.state=Xr.Finished,(i=t.onEnd)==null||i.call(t,r)}});h(this,"name");h(this,"state");h(this,"config");h(this,"_id");h(this,"sendWindowCapacity");h(this,"sendWindowCapacityUpdate");h(this,"recvWindow");h(this,"recvWindowCapacity");h(this,"epochStart");h(this,"getRTT");h(this,"sendFrame");this.config=t.config,this._id=parseInt(t.id,10),this.name=t.name,this.state=t.state,this.sendWindowCapacity=D5,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=t.getRTT,this.sendFrame=t.sendFrame,this.source=Z4(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(t,r={}){var i,s;for(t=t.sublist();t.byteLength!==0;){if(this.sendWindowCapacity===0&&((i=this.log)==null||i.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(r),this.status==="closed"||this.status==="aborted"||this.status==="reset")){(s=this.log)==null||s.trace("%s while waiting for send window capacity",this.status);return}const o=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-Od,t.length),a=this.getSendFlags();this.sendFrame({type:Lt.Data,flag:a,streamID:this._id,length:o},t.sublist(0,o)),this.sendWindowCapacity-=o,t.consume(o)}}async sendReset(){this.sendFrame({type:Lt.WindowUpdate,flag:vt.RST,streamID:this._id,length:0})}async sendCloseWrite(){const t=this.getSendFlags()|vt.FIN;this.sendFrame({type:Lt.WindowUpdate,flag:t,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(t={}){var o,a;if(this.sendWindowCapacity>0)return;let r,i;const s=()=>{this.status==="open"||this.status==="closing"?i(new S("stream aborted",CY)):r()};(o=t.signal)==null||o.addEventListener("abort",s);try{await new Promise((l,c)=>{this.sendWindowCapacityUpdate=()=>{l()},i=c,r=l})}finally{(a=t.signal)==null||a.removeEventListener("abort",s)}}handleWindowUpdate(t){var i,s;(i=this.log)==null||i.trace("stream received window update id=%s",this._id),this.processFlags(t.flag);const r=this.sendWindowCapacity;this.sendWindowCapacity+=t.length,r===0&&t.length>0&&((s=this.sendWindowCapacityUpdate)==null||s.call(this))}async handleData(t,r){var s;if((s=this.log)==null||s.trace("stream received data id=%s",this._id),this.processFlags(t.flag),this.recvWindowCapacity<t.length)throw new S("receive window exceeded",RC,{available:this.recvWindowCapacity,recv:t.length});const i=await r();this.recvWindowCapacity-=t.length,this.sourcePush(i)}processFlags(t){(t&vt.ACK)===vt.ACK&&this.state===Xr.SYNSent&&(this.state=Xr.Established),(t&vt.FIN)===vt.FIN&&this.remoteCloseWrite(),(t&vt.RST)===vt.RST&&this.reset()}getSendFlags(){switch(this.state){case Xr.Init:return this.state=Xr.SYNSent,vt.SYN;case Xr.SYNReceived:return this.state=Xr.Established,vt.ACK;default:return 0}}sendWindowUpdate(){const t=this.getSendFlags(),r=Date.now(),i=this.getRTT();if(t===0&&i>-1&&r-this.epochStart<i*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&t===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=r,this.sendFrame({type:Lt.WindowUpdate,flag:t,streamID:this._id,length:s})}}const IC="/yamux/1.0.0",KY=500;class WY{constructor(e,t={}){h(this,"protocol",IC);h(this,"_components");h(this,"_init");this._components=e,this._init=t}createStreamMuxer(e){return new GY(this._components,{...this._init,...e})}}class GY{constructor(e,t){h(this,"protocol",IC);h(this,"source");h(this,"sink");h(this,"config");h(this,"log");h(this,"logger");h(this,"closeController");h(this,"nextStreamID");h(this,"_streams");h(this,"nextPingID");h(this,"activePing");h(this,"rtt");h(this,"client");h(this,"localGoAway");h(this,"remoteGoAway");h(this,"numInboundStreams");h(this,"numOutboundStreams");h(this,"onIncomingStream");h(this,"onStreamEnd");var r;this.client=t.direction==="outbound",this.config={...PY,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),OY(this.config),this.closeController=new AbortController,ue(1/0,this.closeController.signal),this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=Ko({onEnd:()=>{var i;(i=this.log)==null||i.trace("muxer source ended"),this._streams.forEach(s=>{s.destroy()})}}),this.sink=async i=>{var l,c,u;const s=()=>{const d=EC(i);if(d.return!=null){const f=d.return();qY(f)&&f.catch(p=>{var y;(y=this.log)==null||y.call(this,"could not cause sink source to return",p)})}};let o,a;try{const d=new MY(i);try{this.closeController.signal.addEventListener("abort",s);for await(const f of d.emitFrames())await this.handleFrame(f.header,f.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}o=Si.NormalTermination}catch(d){const f=d.code;IY.has(f)?((l=this.log)==null||l.error("protocol error in sink",d),o=Si.ProtocolError):((c=this.log)==null||c.error("internal error in sink",d),o=Si.InternalError),a=d}(u=this.log)==null||u.trace("muxer sink ended"),a!=null?this.abort(a,o):await this.close({reason:o})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,(r=this.log)==null||r.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(i=>{var s;return(s=this.log)==null?void 0:s.error("keepalive error: %s",i)}),this.ping().catch(i=>{var s;return(s=this.log)==null?void 0:s.error("ping error: %s",i)})}get streams(){return Array.from(this._streams.values())}newStream(e){var i;if(this.remoteGoAway!==void 0)throw new S("muxer closed remotely",C9);if(this.localGoAway!==void 0)throw new S("muxer closed locally",s3);const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new S("max outbound streams exceeded",TY);(i=this.log)==null||i.trace("new outgoing stream id=%s",t);const r=this._newStream(t,e,Xr.Init,"outbound");return this._streams.set(t,r),this.numOutboundStreams++,r.sendWindowUpdate(),r}async ping(){if(this.remoteGoAway!==void 0)throw new S("muxer closed remotely",C9);if(this.localGoAway!==void 0)throw new S("muxer closed locally",s3);if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((i,s)=>{const o=()=>{s(new S("muxer closed locally",s3))};this.closeController.signal.addEventListener("abort",o,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",o),i()}}),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const r=Date.now();this.rtt=r-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){var r;if(this.closeController.signal.aborted)return;const t=(e==null?void 0:e.reason)??Si.NormalTermination;if((r=this.log)==null||r.trace("muxer close reason=%s",t),e.signal==null){const i=AbortSignal.timeout(KY);ue(1/0,i),e={...e,signal:i}}try{await Promise.all([...this._streams.values()].map(async i=>i.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(i){this.abort(i)}}abort(e,t){var r;if(!this.closeController.signal.aborted){t=t??Si.InternalError,(r=this.log)==null||r.error("muxer abort reason=%s error=%s",t,e);for(const i of this._streams.values())i.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,r,i){if(this._streams.get(e)!=null)throw new S("Stream already exists",SC,{id:e});const s=new HY({id:e.toString(),name:t,state:r,direction:i,sendFrame:this.sendFrame.bind(this),onEnd:()=>{var o;this.closeStream(e),(o=this.onStreamEnd)==null||o.call(this,s)},log:this.logger.forComponent(`libp2p:yamux:${i}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return s}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){var t;const e=new Promise((r,i)=>{this.closeController.signal.addEventListener("abort",i,{once:!0})});for((t=this.log)==null||t.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let r;try{await Promise.race([e,new Promise(i=>{r=setTimeout(i,this.config.keepAliveInterval)})]),this.ping().catch(i=>{var s;return(s=this.log)==null?void 0:s.error("ping error: %s",i)})}catch{clearInterval(r);return}}}async handleFrame(e,t){var o;const{streamID:r,type:i,length:s}=e;if((o=this.log)==null||o.trace("received frame %o",e),r===0)switch(i){case Lt.Ping:{this.handlePing(e);return}case Lt.GoAway:{this.handleGoAway(s);return}default:throw new S("Invalid frame type",gd,{header:e})}else switch(e.type){case Lt.Data:case Lt.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new S("Invalid frame type",gd,{header:e})}}handlePing(e){var t,r;if(e.flag===vt.SYN)(t=this.log)==null||t.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,vt.ACK);else if(e.flag===vt.ACK)(r=this.log)==null||r.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new S("Invalid frame flag",gd,{header:e})}handlePingResponse(e){if(this.activePing===void 0)throw new S("ping not requested",bC);if(this.activePing.id!==e)throw new S("ping doesn't match our id",_C);this.activePing.resolve()}handleGoAway(e){var t;(t=this.log)==null||t.trace("received GoAway reason=%s",Si[e]??"unknown"),this.remoteGoAway=e;for(const r of this._streams.values())r.reset();this._closeMuxer()}async handleStreamMessage(e,t){var a,l;const{streamID:r,flag:i,type:s}=e;(i&vt.SYN)===vt.SYN&&this.incomingStream(r);const o=this._streams.get(r);if(o===void 0){if(s===Lt.Data){if((a=this.log)==null||a.call(this,"discarding data for stream id=%s",r),t===void 0)throw new Error("unreachable");await t()}else(l=this.log)==null||l.call(this,"frame for missing stream id=%s",r);return}switch(s){case Lt.WindowUpdate:{o.handleWindowUpdate(e);return}case Lt.Data:{if(t===void 0)throw new Error("unreachable");await o.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){var r,i,s;if(this.client!==(e%2===0))throw new S("both endpoints are clients",kC);if(this._streams.has(e))return;if((r=this.log)==null||r.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:Lt.WindowUpdate,flag:vt.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){(i=this.log)==null||i.call(this,"maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:Lt.WindowUpdate,flag:vt.RST,streamID:e,length:0});return}const t=this._newStream(e,void 0,Xr.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),(s=this.onIncomingStream)==null||s.call(this,t)}sendFrame(e,t){var r;if((r=this.log)==null||r.trace("sending frame %o",e),e.type===Lt.Data){if(t===void 0)throw new S("invalid frame",gd);this.source.push(new Fe(N9(e),t))}else this.source.push(N9(e))}sendPing(e,t=vt.SYN){var r,i;t===vt.SYN?(r=this.log)==null||r.trace("sending ping request pingId=%s",e):(i=this.log)==null||i.trace("sending ping response pingId=%s",e),this.sendFrame({type:Lt.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Si.NormalTermination){var t;(t=this.log)==null||t.call(this,"sending GoAway reason=%s",Si[e]),this.localGoAway=e,this.sendFrame({type:Lt.GoAway,flag:0,streamID:0,length:e})}}function qY(n){return n!=null&&typeof n.then=="function"}function jY(n={}){return e=>new WY(e,n)}const t1=globalThis.CustomEvent??Event;async function*al(n,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const r=e.ordered??!1,i=new EventTarget,s=[];let o=Se(),a=Se(),l=!1,c,u=!1;i.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const y of n){if(s.length===t&&(o=Se(),await o.promise),u)break;const g={done:!1};s.push(g),y().then(w=>{g.done=!0,g.ok=!0,g.value=w,i.dispatchEvent(new t1("task-complete"))},w=>{g.done=!0,g.err=w,i.dispatchEvent(new t1("task-complete"))})}l=!0,i.dispatchEvent(new t1("task-complete"))}catch(y){c=y,i.dispatchEvent(new t1("task-complete"))}});function d(){var y;return r?(y=s[0])==null?void 0:y.done:!!s.find(g=>g.done)}function*f(){for(;s.length>0&&s[0].done;){const y=s[0];if(s.shift(),y.ok)yield y.value;else throw u=!0,o.resolve(),y.err;o.resolve()}}function*p(){for(;d();)for(let y=0;y<s.length;y++)if(s[y].done){const g=s[y];if(s.splice(y,1),y--,g.ok)yield g.value;else throw u=!0,o.resolve(),g.err;o.resolve()}}for(;;){if(d()||(a=Se(),await a.promise),c!=null||(r?yield*f():yield*p(),c!=null))throw c;if(l&&s.length===0)break}}const YY="libp2p",QY="autonat",XY="1.0.0",JY=3e4,ZY=5e3,eQ=6e4,tQ=1,nQ=1;var Le;(function(n){(function(i){i.DIAL="DIAL",i.DIAL_RESPONSE="DIAL_RESPONSE"})(n.MessageType||(n.MessageType={}));let e;(function(i){i[i.DIAL=0]="DIAL",i[i.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(e||(e={})),function(i){i.codec=()=>Pn(e)}(n.MessageType||(n.MessageType={})),function(i){i.OK="OK",i.E_DIAL_ERROR="E_DIAL_ERROR",i.E_DIAL_REFUSED="E_DIAL_REFUSED",i.E_BAD_REQUEST="E_BAD_REQUEST",i.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(n.ResponseStatus||(n.ResponseStatus={}));let t;(function(i){i[i.OK=0]="OK",i[i.E_DIAL_ERROR=100]="E_DIAL_ERROR",i[i.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",i[i.E_BAD_REQUEST=200]="E_BAD_REQUEST",i[i.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(t||(t={})),function(i){i.codec=()=>Pn(t)}(n.ResponseStatus||(n.ResponseStatus={})),function(i){let s;i.codec=()=>(s==null&&(s=Ae((o,a,l={})=>{if(l.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const c of o.addrs)a.uint32(18),a.bytes(c);l.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const l={addrs:[]},c=a==null?o.len:o.pos+a;for(;o.pos<c;){const u=o.uint32();switch(u>>>3){case 1:l.id=o.bytes();break;case 2:l.addrs.push(o.bytes());break;default:o.skipType(u&7);break}}return l})),s),i.encode=o=>Re(o,i.codec()),i.decode=o=>ke(o,i.codec())}(n.PeerInfo||(n.PeerInfo={})),function(i){let s;i.codec=()=>(s==null&&(s=Ae((o,a,l={})=>{l.lengthDelimited!==!1&&a.fork(),o.peer!=null&&(a.uint32(10),n.PeerInfo.codec().encode(o.peer,a)),l.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const l={},c=a==null?o.len:o.pos+a;for(;o.pos<c;){const u=o.uint32();switch(u>>>3){case 1:l.peer=n.PeerInfo.codec().decode(o,o.uint32());break;default:o.skipType(u&7);break}}return l})),s),i.encode=o=>Re(o,i.codec()),i.decode=o=>ke(o,i.codec())}(n.Dial||(n.Dial={})),function(i){let s;i.codec=()=>(s==null&&(s=Ae((o,a,l={})=>{l.lengthDelimited!==!1&&a.fork(),o.status!=null&&(a.uint32(8),n.ResponseStatus.codec().encode(o.status,a)),o.statusText!=null&&(a.uint32(18),a.string(o.statusText)),o.addr!=null&&(a.uint32(26),a.bytes(o.addr)),l.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const l={},c=a==null?o.len:o.pos+a;for(;o.pos<c;){const u=o.uint32();switch(u>>>3){case 1:l.status=n.ResponseStatus.codec().decode(o);break;case 2:l.statusText=o.string();break;case 3:l.addr=o.bytes();break;default:o.skipType(u&7);break}}return l})),s),i.encode=o=>Re(o,i.codec()),i.decode=o=>ke(o,i.codec())}(n.DialResponse||(n.DialResponse={}));let r;n.codec=()=>(r==null&&(r=Ae((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.type!=null&&(s.uint32(8),n.MessageType.codec().encode(i.type,s)),i.dial!=null&&(s.uint32(18),n.Dial.codec().encode(i.dial,s)),i.dialResponse!=null&&(s.uint32(26),n.DialResponse.codec().encode(i.dialResponse,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{const o={},a=s==null?i.len:i.pos+s;for(;i.pos<a;){const l=i.uint32();switch(l>>>3){case 1:o.type=n.MessageType.codec().decode(i);break;case 2:o.dial=n.Dial.codec().decode(i,i.uint32());break;case 3:o.dialResponse=n.DialResponse.codec().decode(i,i.uint32());break;default:i.skipType(l&7);break}}return o})),r),n.encode=i=>Re(i,n.codec()),n.decode=i=>ke(i,n.codec())})(Le||(Le={}));const a3=4;var bE;bE=Symbol.toStringTag;class rQ{constructor(e,t){h(this,"components");h(this,"startupDelay");h(this,"refreshInterval");h(this,"protocol");h(this,"timeout");h(this,"maxInboundStreams");h(this,"maxOutboundStreams");h(this,"verifyAddressTimeout");h(this,"started");h(this,"log");h(this,bE,"@libp2p/autonat");this.components=e,this.log=e.logger.forComponent("libp2p:autonat"),this.started=!1,this.protocol=`/${t.protocolPrefix??YY}/${QY}/${XY}`,this.timeout=t.timeout??JY,this.maxInboundStreams=t.maxInboundStreams??tQ,this.maxOutboundStreams=t.maxOutboundStreams??nQ,this.startupDelay=t.startupDelay??ZY,this.refreshInterval=t.refreshInterval??eQ,this._verifyExternalAddresses=this._verifyExternalAddresses.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.startupDelay),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),clearTimeout(this.verifyAddressTimeout),this.started=!1}async handleIncomingAutonatStream(e){const t=AbortSignal.timeout(this.timeout),r=()=>{e.stream.abort(new S("handleIncomingAutonatStream timeout",Nc))};t.addEventListener("abort",r,{once:!0}),ue(1/0,t);try{const i=this;await En(e.stream,s=>Do(s),async function*(s){const o=await qc(s);if(o==null){i.log("no message received"),yield Le.encode({type:Le.MessageType.DIAL_RESPONSE,dialResponse:{status:Le.ResponseStatus.E_BAD_REQUEST,statusText:"No message was sent"}});return}let a;try{a=Le.decode(o)}catch(l){i.log.error("could not decode message",l),yield Le.encode({type:Le.MessageType.DIAL_RESPONSE,dialResponse:{status:Le.ResponseStatus.E_BAD_REQUEST,statusText:"Could not decode message"}});return}yield Le.encode(await i.handleAutonatMessage(a,e.connection,{signal:t}))},s=>No(s),e.stream)}catch(i){this.log.error("error handling incoming autonat stream",i)}finally{t.removeEventListener("abort",r)}}_verifyExternalAddresses(){this.verifyExternalAddresses().catch(e=>{this.log.error("error verifying external address",e)})}async handleAutonatMessage(e,t,r){const i=this.components.addressManager.getAddresses().map(d=>d.toOptions().host),s=e.dial;if(s==null)return this.log.error("dial was missing from message"),{type:Le.MessageType.DIAL_RESPONSE,dialResponse:{status:Le.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let o;const a=s.peer;if((a==null?void 0:a.id)==null)return this.log.error("PeerId missing from message"),{type:Le.MessageType.DIAL_RESPONSE,dialResponse:{status:Le.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{o=di(a.id)}catch(d){return this.log.error("invalid PeerId",d),{type:Le.MessageType.DIAL_RESPONSE,dialResponse:{status:Le.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",o),!t.remotePeer.equals(o))return this.log("target peer %p did not equal sending peer %p",o,t.remotePeer),{type:Le.MessageType.DIAL_RESPONSE,dialResponse:{status:Le.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const l=a.addrs.map(d=>xe(d)).filter(d=>{const f=d.toOptions().host===t.remoteAddr.toOptions().host;return this.log.trace("request to dial %a was sent from %a is same host %s",d,t.remoteAddr,f),f}).filter(d=>{const f=d.toOptions().host,p=!(Bo(f)??!1);return this.log.trace("host %s was public %s",f,p),p}).filter(d=>{const f=d.toOptions().host,p=!i.includes(f);return this.log.trace("host %s was not our host %s",f,p),p}).filter(d=>{const f=!!this.components.transportManager.dialTransportForMultiaddr(d);return this.log.trace("transport for %a is supported %s",d,f),f}).map(d=>(d.getPeerId()==null&&(d=d.encapsulate(`/p2p/${o.toString()}`)),d));if(l.length===0)return this.log("no valid multiaddrs for %p in message",o),{type:Le.MessageType.DIAL_RESPONSE,dialResponse:{status:Le.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",l.map(d=>d.toString()).join(", "),o);let c="",u=l[0];for await(const d of l){let f;u=d;try{if(f=await this.components.connectionManager.openConnection(d,r),!f.remoteAddr.equals(d))throw this.log.error("tried to dial %a but dialed %a",d,f.remoteAddr),new Error("Unexpected remote address");return this.log("Success %p",o),{type:Le.MessageType.DIAL_RESPONSE,dialResponse:{status:Le.ResponseStatus.OK,addr:f.remoteAddr.decapsulateCode(Mt("p2p").code).bytes}}}catch(p){this.log("could not dial %p",o,p),c=p.message}finally{f!=null&&await f.close()}}return{type:Le.MessageType.DIAL_RESPONSE,dialResponse:{status:Le.ResponseStatus.E_DIAL_ERROR,statusText:c,addr:u.bytes}}}async verifyExternalAddresses(){if(clearTimeout(this.verifyAddressTimeout),!this.isStarted())return;const e=this.components.addressManager,t=e.getObservedAddrs().filter(s=>{const o=s.toOptions();return!(Bo(o.host)??!1)});if(t.length===0){this.log("no public addresses found, not requesting verification"),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval);return}const r=AbortSignal.timeout(this.timeout);ue(1/0,r);const i=this;try{this.log("verify multiaddrs %s",t.map(c=>c.toString()).join(", "));const s=Le.encode({type:Le.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toBytes(),addrs:t.map(c=>c.bytes)}}}),o={},a=[],l=async c=>{let u=()=>{};try{this.log("asking %p to verify multiaddr",c.id);const d=await i.components.connectionManager.openConnection(c.id,{signal:r}),f=await d.newStream(this.protocol,{signal:r});u=()=>{f.abort(new S("verifyAddress timeout",Nc))},r.addEventListener("abort",u,{once:!0});const p=await En([s],g=>No(g),f,g=>Do(g),async g=>qc(g));if(p==null){this.log("no response received from %p",d.remotePeer);return}const y=Le.decode(p);if(y.type!==Le.MessageType.DIAL_RESPONSE||y.dialResponse==null){this.log("invalid autonat response from %p",d.remotePeer);return}if(y.dialResponse.status===Le.ResponseStatus.OK){const g=d.remoteAddr.toOptions();let w;if(g.family===4)w=g.host.split(".")[0];else if(g.family===6)w=g.host.split(":")[0];else{this.log('remote address "%s" was not IP4 or IP6?',g.host);return}if(a.includes(w)){this.log("already have response from network segment %d - %s",w,g.host);return}a.push(w)}return y.dialResponse}catch(d){this.log.error("error asking remote to verify multiaddr",d)}finally{r.removeEventListener("abort",u)}};for await(const c of al(Wo(this.components.randomWalk.walk({signal:r}),u=>async()=>l(u)),{concurrency:a3}))try{if(c==null)continue;const u=c.addr==null?t[0]:xe(c.addr);if(this.log("autonat response for %a is %s",u,c.status),c.status===Le.ResponseStatus.E_BAD_REQUEST||c.status===Le.ResponseStatus.E_DIAL_REFUSED||c.addr==null&&t.length>1)continue;if(!t.some(f=>f.equals(u))){this.log("peer reported %a as %s but it was not in our observed address list",u,c.status);continue}const d=u.toString();if(o[d]==null&&(o[d]={success:0,failure:0}),c.status===Le.ResponseStatus.OK?o[d].success++:c.status===Le.ResponseStatus.E_DIAL_ERROR&&o[d].failure++,o[d].success===a3){this.log("%a is externally dialable",u),e.confirmObservedAddr(u);return}if(o[d].failure===a3){this.log("%a is not externally dialable",u),e.removeObservedAddr(u);return}}catch(u){this.log.error("could not verify external address",u)}}finally{this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval)}}}function iQ(n={}){return e=>new rQ(e,n)}const sQ=te("dns4"),oQ=te("dns6"),aQ=te("dnsaddr"),qa=At(te("dns"),aQ,sQ,oQ),Pp=At(te("ip4"),te("ip6")),Xc=At(me(Pp,te("tcp")),me(qa,te("tcp"))),Op=me(Pp,te("udp")),lQ=me(Op,te("utp")),cQ=me(Op,te("quic")),uQ=me(Op,te("quic-v1")),dy=At(me(Xc,te("ws")),me(qa,te("ws"))),kh=At(me(dy,te("p2p")),dy),hy=At(me(Xc,te("wss")),me(qa,te("wss")),me(Xc,te("tls"),te("ws")),me(qa,te("tls"),te("ws"))),Jc=At(me(hy,te("p2p")),hy),fy=At(me(Xc,te("http")),me(Pp,te("http")),me(qa,te("http"))),py=At(me(Xc,te("https")),me(Pp,te("https")),me(qa,te("https"))),D9=me(Op,te("webrtc-direct"),te("certhash")),CC=At(me(D9,te("p2p")),D9),P9=me(uQ,te("webtransport"),te("certhash"),te("certhash")),TC=At(me(P9,te("p2p")),P9),NC=At(me(kh,te("p2p-webrtc-star"),te("p2p")),me(Jc,te("p2p-webrtc-star"),te("p2p")),me(kh,te("p2p-webrtc-star")),me(Jc,te("p2p-webrtc-star")));At(me(kh,te("p2p-websocket-star"),te("p2p")),me(Jc,te("p2p-websocket-star"),te("p2p")),me(kh,te("p2p-websocket-star")),me(Jc,te("p2p-websocket-star")));const DC=At(me(fy,te("p2p-webrtc-direct"),te("p2p")),me(py,te("p2p-webrtc-direct"),te("p2p")),me(fy,te("p2p-webrtc-direct")),me(py,te("p2p-webrtc-direct"))),ja=At(dy,hy,fy,py,NC,DC,Xc,lQ,cQ,qa,CC,TC);At(me(ja,te("p2p-stardust"),te("p2p")),me(ja,te("p2p-stardust")));const po=At(me(ja,te("p2p")),NC,DC,CC,TC,te("p2p")),O9=At(me(po,te("p2p-circuit"),po),me(po,te("p2p-circuit")),me(te("p2p-circuit"),po),me(ja,te("p2p-circuit")),me(te("p2p-circuit"),ja),te("p2p-circuit")),PC=()=>At(me(O9,PC),O9),fs=PC(),dQ=At(me(fs,po,fs),me(po,fs),me(fs,po),fs,po);At(me(fs,te("webrtc"),te("p2p")),me(fs,te("webrtc")),me(ja,te("webrtc"),te("p2p")),me(ja,te("webrtc")),te("webrtc"));function OC(n){function e(t){let r;try{r=xe(t)}catch{return!1}const i=n(r.protoNames());return i===null?!1:i===!0||i===!1?i:i.length===0}return e}function me(...n){function e(t){if(t.length<n.length)return null;let r=t;return n.some(i=>(r=typeof i=="function"?i().partialMatch(t):i.partialMatch(t),Array.isArray(r)&&(t=r),r===null)),r}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:OC(e),partialMatch:e}}function At(...n){function e(r){let i=null;return n.some(s=>{const o=typeof s=="function"?s().partialMatch(r):s.partialMatch(r);return o!=null?(i=o,!0):!1}),i}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:OC(e),partialMatch:e}}function te(n){const e=n;function t(i){let s;try{s=xe(i)}catch{return!1}const o=s.protoNames();return o.length===1&&o[0]===e}function r(i){return i.length===0?null:i[0]===e?i.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:r}}const hQ="bootstrap",fQ=50,pQ=12e4,gQ=1e3;var _E,SE,xE,kE;class LC extends(kE=tn,xE=A0,SE=Symbol.toStringTag,_E=Dn,kE){constructor(t,r={list:[]}){if(r.list==null||r.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super();h(this,"log");h(this,"timer");h(this,"list");h(this,"timeout");h(this,"components");h(this,"_init");h(this,xE,this);h(this,SE,"@libp2p/bootstrap");h(this,_E,["@libp2p/peer-discovery"]);this.components=t,this.log=t.logger.forComponent("libp2p:bootstrap"),this.timeout=r.timeout??gQ,this.list=[];for(const i of r.list){if(!dQ.matches(i)){this.log.error("Invalid multiaddr");continue}const s=xe(i),o=s.getPeerId();if(o==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const a={id:xt(o),multiaddrs:[s]};this.list.push(a)}this._init=r}isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(t=>{this.log.error(t)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const t of this.list){if(await this.components.peerStore.merge(t.id,{tags:{[this._init.tagName??hQ]:{value:this._init.tagValue??fQ,ttl:this._init.tagTTL??pQ}}}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:t})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}h(LC,"tag","bootstrap");function yQ(n){return e=>new LC(e,n)}const mQ={ERR_SIGNATURE_NOT_VALID:"ERR_SIGNATURE_NOT_VALID"};var r2;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(r.uint32(10),r.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(r.uint32(18),r.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(r.uint32(26),r.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(r.uint32(42),r.bytes(t.signature)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.publicKey=t.bytes();break;case 2:i.payloadType=t.bytes();break;case 3:i.payload=t.bytes();break;case 5:i.signature=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(r2||(r2={}));const ro=class ro{constructor(e){h(this,"peerId");h(this,"payloadType");h(this,"payload");h(this,"signature");h(this,"marshaled");const{peerId:t,payloadType:r,payload:i,signature:s}=e;this.peerId=t,this.payloadType=r,this.payload=i,this.signature=s}marshal(){if(this.peerId.publicKey==null)throw new Error("Missing public key");return this.marshaled==null&&(this.marshaled=r2.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return Pe(this.marshal(),e.marshal())}async validate(e){const t=L9(e,this.payloadType,this.payload);if(this.peerId.publicKey==null)throw new Error("Missing public key");return mh(this.peerId.publicKey).verify(t.subarray(),this.signature)}};h(ro,"createFromProtobuf",async e=>{const t=r2.decode(e),r=await qi(t.publicKey);return new ro({peerId:r,payloadType:t.payloadType,payload:t.payload,signature:t.signature})}),h(ro,"seal",async(e,t)=>{if(t.privateKey==null)throw new Error("Missing private key");const r=e.domain,i=e.codec,s=e.marshal(),o=L9(r,i,s),l=await(await zc(t.privateKey)).sign(o.subarray());return new ro({peerId:t,payloadType:i,payload:s,signature:l})}),h(ro,"openAndCertify",async(e,t)=>{const r=await ro.createFromProtobuf(e);if(!await r.validate(t))throw new S("envelope signature is not valid for the given domain",mQ.ERR_SIGNATURE_NOT_VALID);return r});let Mo=ro;const L9=(n,e,t)=>{const r=Y(n),i=ii(r.byteLength),s=ii(e.length),o=ii(t.length);return new Fe(i,r,s,e,o,t)};function wQ(n,e){const t=(r,i)=>r.toString().localeCompare(i.toString());return n.length!==e.length?!1:(e.sort(t),n.sort(t).every((r,i)=>e[i].equals(r)))}const vQ="libp2p-peer-record",EQ=Uint8Array.from([3,1]);var i2;(function(n){(function(t){let r;t.codec=()=>(r==null&&(r=Ae((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.multiaddr!=null&&i.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(i.multiaddr)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{const o={multiaddr:new Uint8Array(0)},a=s==null?i.len:i.pos+s;for(;i.pos<a;){const l=i.uint32();switch(l>>>3){case 1:o.multiaddr=i.bytes();break;default:i.skipType(l&7);break}}return o})),r),t.encode=i=>Re(i,t.codec()),t.decode=i=>ke(i,t.codec())})(n.AddressInfo||(n.AddressInfo={}));let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(r.uint32(10),r.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(r.uint32(16),r.uint64(t.seq)),t.addresses!=null)for(const s of t.addresses)r.uint32(26),n.AddressInfo.codec().encode(s,r);i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={peerId:new Uint8Array(0),seq:0n,addresses:[]},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.peerId=t.bytes();break;case 2:i.seq=t.uint64();break;case 3:i.addresses.push(n.AddressInfo.codec().decode(t,t.uint32()));break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(i2||(i2={}));const as=class as{constructor(e){h(this,"peerId");h(this,"multiaddrs");h(this,"seqNumber");h(this,"domain",as.DOMAIN);h(this,"codec",as.CODEC);h(this,"marshaled");const{peerId:t,multiaddrs:r,seqNumber:i}=e;this.peerId=t,this.multiaddrs=r??[],this.seqNumber=i??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=i2.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof as)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!wQ(this.multiaddrs,e.multiaddrs))}};h(as,"createFromProtobuf",e=>{const t=i2.decode(e),r=di(t.peerId),i=(t.addresses??[]).map(o=>xe(o.multiaddr)),s=t.seq;return new as({peerId:r,multiaddrs:i,seqNumber:s})}),h(as,"DOMAIN",vQ),h(as,"CODEC",EQ);let Ki=as;function Yn(n,e){const t=jc(n,e),r={read:async(i,s)=>{const o=await t.read(s);return i.decode(o)},write:async(i,s,o)=>{await t.write(s.encode(i),o)},writeV:async(i,s,o)=>{await t.writeV(i.map(a=>s.encode(a)),o)},pb:i=>({read:async s=>r.read(i,s),write:async(s,o)=>r.write(s,i,o),writeV:async(s,o)=>r.writeV(s,i,o),unwrap:()=>r}),unwrap:()=>t.unwrap()};return r}const bQ=290,_Q=1,SQ=1e3,xQ=100,kQ="circuit-relay-relay";BigInt(1<<17);const s2="/libp2p/circuit/relay/0.2.0/hop",B9="/libp2p/circuit/relay/0.2.0/stop",M9=300,$9="ERR_RELAYED_DIAL",RQ="ERR_HOP_REQUEST_FAILED",AQ=4096,IQ=.001;var Zc;(function(n){(function(r){r.RESERVE="RESERVE",r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let e;(function(r){r[r.RESERVE=0]="RESERVE",r[r.CONNECT=1]="CONNECT",r[r.STATUS=2]="STATUS"})(e||(e={})),function(r){r.codec=()=>Pn(e)}(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=Ae((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.peer!=null&&(i.uint32(18),eu.codec().encode(r.peer,i)),r.reservation!=null&&(i.uint32(26),o2.codec().encode(r.reservation,i)),r.limit!=null&&(i.uint32(34),tu.codec().encode(r.limit,i)),r.status!=null&&(i.uint32(40),Tn.codec().encode(r.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{var l,c,u;const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const d=r.uint32();switch(d>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=eu.codec().decode(r,r.uint32(),{limits:(l=s.limits)==null?void 0:l.peer});break}case 3:{o.reservation=o2.codec().decode(r,r.uint32(),{limits:(c=s.limits)==null?void 0:c.reservation});break}case 4:{o.limit=tu.codec().decode(r,r.uint32(),{limits:(u=s.limits)==null?void 0:u.limit});break}case 5:{o.status=Tn.codec().decode(r);break}default:{r.skipType(d&7);break}}}return o})),t),n.encode=r=>Re(r,n.codec()),n.decode=(r,i)=>ke(r,n.codec(),i)})(Zc||(Zc={}));var os;(function(n){(function(r){r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let e;(function(r){r[r.CONNECT=0]="CONNECT",r[r.STATUS=1]="STATUS"})(e||(e={})),function(r){r.codec=()=>Pn(e)}(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=Ae((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.peer!=null&&(i.uint32(18),eu.codec().encode(r.peer,i)),r.limit!=null&&(i.uint32(26),tu.codec().encode(r.limit,i)),r.status!=null&&(i.uint32(32),Tn.codec().encode(r.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(r,i,s={})=>{var l,c;const o={},a=i==null?r.len:r.pos+i;for(;r.pos<a;){const u=r.uint32();switch(u>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=eu.codec().decode(r,r.uint32(),{limits:(l=s.limits)==null?void 0:l.peer});break}case 3:{o.limit=tu.codec().decode(r,r.uint32(),{limits:(c=s.limits)==null?void 0:c.limit});break}case 4:{o.status=Tn.codec().decode(r);break}default:{r.skipType(u&7);break}}}return o})),t),n.encode=r=>Re(r,n.codec()),n.decode=(r,i)=>ke(r,n.codec(),i)})(os||(os={}));var eu;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.id!=null&&t.id.byteLength>0&&(r.uint32(10),r.bytes(t.id)),t.addrs!=null)for(const s of t.addrs)r.uint32(18),r.bytes(s);i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a;const s={id:Xe(0),addrs:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{s.id=t.bytes();break}case 2:{if(((a=i.limits)==null?void 0:a.addrs)!=null&&s.addrs.length===i.limits.addrs)throw new Va('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");s.addrs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return s})),e),n.encode=t=>Re(t,n.codec()),n.decode=(t,r)=>ke(t,n.codec(),r)})(eu||(eu={}));var o2;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.expire!=null&&t.expire!==0n&&(r.uint32(8),r.uint64(t.expire)),t.addrs!=null)for(const s of t.addrs)r.uint32(18),r.bytes(s);t.voucher!=null&&(r.uint32(26),r.bytes(t.voucher)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{var a;const s={expire:0n,addrs:[]},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{s.expire=t.uint64();break}case 2:{if(((a=i.limits)==null?void 0:a.addrs)!=null&&s.addrs.length===i.limits.addrs)throw new Va('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");s.addrs.push(t.bytes());break}case 3:{s.voucher=t.bytes();break}default:{t.skipType(l&7);break}}}return s})),e),n.encode=t=>Re(t,n.codec()),n.decode=(t,r)=>ke(t,n.codec(),r)})(o2||(o2={}));var tu;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.duration!=null&&(r.uint32(8),r.uint32(t.duration)),t.data!=null&&(r.uint32(16),r.uint64(t.data)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.duration=t.uint32();break}case 2:{s.data=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>Re(t,n.codec()),n.decode=(t,r)=>ke(t,n.codec(),r)})(tu||(tu={}));var Tn;(function(n){n.UNUSED="UNUSED",n.OK="OK",n.RESERVATION_REFUSED="RESERVATION_REFUSED",n.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",n.PERMISSION_DENIED="PERMISSION_DENIED",n.CONNECTION_FAILED="CONNECTION_FAILED",n.NO_RESERVATION="NO_RESERVATION",n.MALFORMED_MESSAGE="MALFORMED_MESSAGE",n.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Tn||(Tn={}));var gy;(function(n){n[n.UNUSED=0]="UNUSED",n[n.OK=100]="OK",n[n.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",n[n.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",n[n.PERMISSION_DENIED=202]="PERMISSION_DENIED",n[n.CONNECTION_FAILED=203]="CONNECTION_FAILED",n[n.NO_RESERVATION=204]="NO_RESERVATION",n[n.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",n[n.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(gy||(gy={}));(function(n){n.codec=()=>Pn(gy)})(Tn||(Tn={}));var U9;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.relay!=null&&t.relay.byteLength>0&&(r.uint32(10),r.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(r.uint32(18),r.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(r.uint32(24),r.uint64(t.expiration)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={relay:Xe(0),peer:Xe(0),expiration:0n},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.relay=t.bytes();break}case 2:{s.peer=t.bytes();break}case 3:{s.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>Re(t,n.codec()),n.decode=(t,r)=>ke(t,n.codec(),r)})(U9||(U9={}));function F9(n){const e=n*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}function z9(n){const{stream:e,remoteAddr:t,logger:r}=n,i=r.forComponent("libp2p:stream:converter");let s=!1,o=!1;const a=e.close.bind(e);e.close=async f=>{await a(f),d(!0)};const l=e.abort.bind(e);e.abort=f=>{l(f),d(!0)};const c=e.sink.bind(e);e.sink=async f=>{try{await c(f)}catch(p){p.type!=="aborted"&&i.error("%s error in sink",t,p)}finally{o=!0,d()}};const u={log:i,sink:e.sink,source:async function*(){try{for await(const f of e.source)f instanceof Uint8Array?yield f:yield*f}finally{s=!0,d()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function d(f){f===!0&&(s=!0,o=!0),s&&o&&u.timeline.close==null&&(u.timeline.close=Date.now())}return u}class CQ extends tn{constructor(t,r={}){super();h(this,"peerStore");h(this,"registrar");h(this,"connectionManager");h(this,"randomWalk");h(this,"started");h(this,"running");h(this,"topologyId");h(this,"log");h(this,"discoveryController");h(this,"filter");this.log=t.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=t.peerStore,this.registrar=t.registrar,this.connectionManager=t.connectionManager,this.randomWalk=t.randomWalk,this.filter=r.filter,this.discoveryController=new AbortController,ue(1/0,this.discoveryController.signal)}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(s2,{filter:this.filter,onConnect:t=>{this.log("discovered relay %p",t),this.safeDispatchEvent("relay:discover",{detail:t})}}),this.started=!0}stop(){var t;this.topologyId!=null&&this.registrar.unregister(this.topologyId),(t=this.discoveryController)==null||t.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,ue(1/0,this.discoveryController.signal),Promise.resolve().then(async()=>{var i;this.log("searching peer store for relays");const t=await this.peerStore.all({filters:[s=>s.protocols.includes(s2)],orders:[()=>Math.random()<.5?1:-1]});for(const s of t)this.log.trace("found relay peer %p in peer store",s.id),this.safeDispatchEvent("relay:discover",{detail:s.id});this.log("found %d relay peers in peer store",t.length);const r=new mu({concurrency:5});this.log("start random walk");for await(const s of this.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",s.id),r.has(s.id)){this.log.trace("random peer %p was already in queue",s.id);continue}if(((i=this.connectionManager.getConnections(s.id))==null?void 0:i.length)>0){this.log.trace("random peer %p was already connected",s.id);continue}if(!await this.connectionManager.isDialable(s.multiaddrs)){this.log.trace("random peer %p was not dialable",s.id,s.multiaddrs.map(o=>o.toString()));continue}this.log.trace("wait for space in queue for %p",s.id),await Pt(r.onSizeLessThan(10),this.discoveryController.signal),this.log("adding random peer %p to dial queue (length: %d)",s.id,r.size),r.add(async()=>{const o=bt([this.discoveryController.signal,AbortSignal.timeout(5e3)]);ue(1/0,o);try{await this.connectionManager.openConnection(s.id,{signal:o})}finally{o.clear()}},{peerId:s.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to random peer %p",s.id,o)})}await r.onIdle()}).catch(t=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",t)}))}stopDiscovery(){var t;this.log("stop discovery"),this.running=!1,(t=this.discoveryController)==null||t.abort()}}var L2,BC;class TQ extends tn{constructor(t){super();le(this,L2);h(this,"connectionManager");h(this,"relayStore");h(this,"listeningAddrs");h(this,"log");h(this,"_onRemoveRelayPeer",t=>{Q(this,L2,BC).call(this,t.detail)});this.log=t.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=t.connectionManager,this.relayStore=t.relayStore,this.listeningAddrs=new Ls,this.relayStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}async listen(t){this.log("listen on %a",t);const r=t.decapsulate("/p2p-circuit"),i=await this.connectionManager.openConnection(r);if(!this.relayStore.hasReservation(i.remotePeer)){this.log("making reservation on peer %p",i.remotePeer),await this.relayStore.addRelay(i.remotePeer,"configured");return}const s=this.relayStore.getReservation(i.remotePeer);if(s==null)throw new S("Did not have reservation after making reservation","ERR_NO_RESERVATION");if(this.listeningAddrs.has(i.remotePeer)){this.log("already listening on relay %p",i.remotePeer);return}this.listeningAddrs.set(i.remotePeer,s.addrs.map(o=>xe(o).encapsulate("/p2p-circuit"))),this.safeDispatchEvent("listening",{})}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}}L2=new WeakSet,BC=function(t){const r=this.listeningAddrs.has(t);this.log("relay peer removed %p - had reservation",t,r),this.listeningAddrs.delete(t),r&&(this.log.trace("removing relay event listener for peer %p",t),this.relayStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close",{}))};function NQ(n){return new TQ(n)}const DQ=60*1e3*10,PQ=60*1e3*5,OQ=30*1e3;var lu,MC,$C;class LQ extends tn{constructor(t,r){super();le(this,lu);h(this,"peerId");h(this,"connectionManager");h(this,"transportManager");h(this,"peerStore");h(this,"events");h(this,"reserveQueue");h(this,"reservations");h(this,"maxDiscoveredRelays");h(this,"maxReservationQueueLength");h(this,"reservationCompletionTimeout");h(this,"started");h(this,"log");h(this,"relayFilter");this.log=t.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=t.peerId,this.connectionManager=t.connectionManager,this.transportManager=t.transportManager,this.peerStore=t.peerStore,this.events=t.events,this.reservations=new Ls,this.maxDiscoveredRelays=(r==null?void 0:r.discoverRelays)??0,this.maxReservationQueueLength=(r==null?void 0:r.maxReservationQueueLength)??xQ,this.reservationCompletionTimeout=(r==null?void 0:r.reservationCompletionTimeout)??SQ,this.started=!1,this.relayFilter=pV(100),this.reserveQueue=new mu({concurrency:(r==null?void 0:r.reservationConcurrency)??_Q,metricName:"libp2p_relay_reservation_queue",metrics:t.metrics}),this.events.addEventListener("peer:disconnect",i=>{Q(this,lu,$C).call(this,i.detail)})}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{}))}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:t})=>{clearTimeout(t)}),this.reservations.clear(),this.started=!1}async addRelay(t,r){if(this.peerId.equals(t)){this.log("not trying to use self as relay");return}if(this.reserveQueue.size>this.maxReservationQueueLength){this.log("not adding potential relay peer %p as the queue is full",t);return}if(this.reserveQueue.has(t)){this.log("potential relay peer %p is already in the reservation queue",t);return}if(this.relayFilter.has(t.toBytes())){this.log("potential relay peer %p has failed previously, not trying again",t);return}this.log("try to reserve relay slot with %p",t),await this.reserveQueue.add(async()=>{const i=Date.now();try{const s=this.reservations.get(t);if(s!=null){if(F9(s.reservation.expire)>DQ){this.log("already have reservation on relay peer %p and it expires in more than 10 minutes",t);return}clearTimeout(s.timeout),this.reservations.delete(t)}if(r==="discovered"&&[...this.reservations.values()].reduce((f,p)=>(p.type==="discovered"&&f++,f),0)>=this.maxDiscoveredRelays){this.log("already have enough discovered relays");return}const o=AbortSignal.timeout(this.reservationCompletionTimeout);ue(1/0,o);const a=await this.connectionManager.openConnection(t,{signal:o});if(a.remoteAddr.protoNames().includes("p2p-circuit")){this.log("not creating reservation over relayed connection");return}const l=await Q(this,lu,MC).call(this,a,{signal:o});this.log("created reservation on relay peer %p",t);const c=F9(l.expire),u=Math.min(Math.max(c-PQ,OQ),Math.pow(2,31)-1),d=setTimeout(()=>{this.addRelay(t,r).catch(f=>{this.log.error("could not refresh reservation to relay %p",t,f)})},u);this.reservations.set(t,{timeout:d,reservation:l,type:r}),await this.peerStore.merge(t,{tags:{[kQ]:{value:1,ttl:c}}}),await this.transportManager.listen([xe(`/p2p/${t.toString()}/p2p-circuit`)]),this.safeDispatchEvent("relay:created-reservation",{detail:t})}catch(s){this.log.error("could not reserve slot on %p after %dms",t,Date.now()-i,s);const o=this.reservations.get(t);o!=null&&clearTimeout(o.timeout),this.reservations.delete(t),this.relayFilter.add(t.toBytes())}},{peerId:t})}hasReservation(t){return this.reservations.has(t)}getReservation(t){var r;return(r=this.reservations.get(t))==null?void 0:r.reservation}reservationCount(){return this.reservations.size}}lu=new WeakSet,MC=async function(t,r){var c;(c=r.signal)==null||c.throwIfAborted(),this.log("requesting reservation from %p",t.remotePeer);const i=await t.newStream(s2,r),o=Yn(i).pb(Zc);await o.write({type:Zc.Type.RESERVE},r);let a;try{a=await o.read(r)}catch(u){throw i.abort(u),u}finally{i.status!=="closed"&&await i.close(r)}if(a.status===Tn.OK&&a.reservation!=null){let u=!1;const d=t.remoteAddr.bytes;for(const f of a.reservation.addrs)if(Pe(d,f)){u=!0;break}return u||a.reservation.addrs.push(d),a.reservation}const l=`reservation failed with status ${a.status??"undefined"}`;throw this.log.error(l),new Error(l)},$C=function(t){const r=this.reservations.get(t);r!=null&&(this.log("connection to relay %p closed, removing reservation from local store",t),clearTimeout(r.timeout),this.reservations.delete(t),this.safeDispatchEvent("relay:removed",{detail:t}),this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))};const BQ=n=>{if(n.peer==null)return!1;try{n.peer.addrs.forEach(xe)}catch{return!1}return!0},l3={maxInboundStopStreams:M9,maxOutboundStopStreams:M9,stopTimeout:3e4};var RE,AE,IE,CE;class MQ{constructor(e,t){h(this,"discovery");h(this,"registrar");h(this,"peerStore");h(this,"connectionManager");h(this,"transportManager");h(this,"peerId");h(this,"upgrader");h(this,"addressManager");h(this,"connectionGater");h(this,"reservationStore");h(this,"logger");h(this,"maxInboundStopStreams");h(this,"maxOutboundStopStreams");h(this,"stopTimeout");h(this,"started");h(this,"log");h(this,CE,"@libp2p/circuit-relay-v2-transport");h(this,IE,["@libp2p/transport","@libp2p/circuit-relay-v2-transport"]);h(this,RE,!0);this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??l3.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??l3.maxOutboundStopStreams,this.stopTimeout=t.stopTimeout??l3.stopTimeout;const r=t.discoverRelays??0;r>0&&(this.discovery=new CQ(e,{filter:t.discoveryFilter??RV(AQ,IQ)}),this.discovery.addEventListener("relay:discover",i=>{this.reservationStore.addRelay(i.detail,"discovered").catch(s=>{this.log.error("could not add discovered relay %p",i.detail,s)})})),this.reservationStore=new LQ(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{var i;(i=this.discovery)==null||i.startDiscovery()}),this.reservationStore.addEventListener("relay:created-reservation",()=>{var i;this.reservationStore.reservationCount()>=r&&((i=this.discovery)==null||i.stopDiscovery())}),this.started=!1}get[(CE=Symbol.toStringTag,IE=Dn,AE=Dc,RE=Kh,AE)](){return this.discovery!=null?["@libp2p/identify"]:[]}isStarted(){return this.started}async start(){await this.registrar.handle(B9,e=>{this.onStop(e).catch(t=>{this.log.error("error while handling STOP protocol",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),await gu(this.discovery,this.reservationStore),this.started=!0}async stop(){await yu(this.discovery,this.reservationStore),await this.registrar.unhandle(B9),this.started=!1}async dial(e,t){var y,g,w;if(e.protoCodes().filter(m=>m===bQ).length!==1){const m="Invalid circuit relay address";throw this.log.error(m,e),new S(m,$9)}const r=e.toString().split("/p2p-circuit"),i=xe(r[0]),s=xe(r[r.length-1]),o=i.getPeerId(),a=s.getPeerId();if(o==null||a==null){const m=`Circuit relay dial to ${e.toString()} failed as address did not have peer ids`;throw this.log.error(m),new S(m,$9)}const l=xt(o),c=xt(a);let u=!1,f=this.connectionManager.getConnections(l)[0];f==null?(await this.peerStore.merge(l,{multiaddrs:[i]}),(y=t.onProgress)==null||y.call(t,new se("circuit-relay:open-connection")),f=await this.connectionManager.openConnection(l,t),u=!0):(g=t.onProgress)==null||g.call(t,new se("circuit-relay:reuse-connection"));let p;try{return(w=t.onProgress)==null||w.call(t,new se("circuit-relay:open-hop-stream")),p=await f.newStream(s2),await this.connectV2({stream:p,connection:f,destinationPeer:c,destinationAddr:s,relayAddr:i,ma:e,disconnectOnFailure:u,onProgress:t.onProgress})}catch(m){throw this.log.error("circuit relay dial to destination %p via relay %p failed",c,l,m),p!=null&&p.abort(m),u&&await f.close(),m}}async connectV2({stream:e,connection:t,destinationPeer:r,destinationAddr:i,relayAddr:s,ma:o,disconnectOnFailure:a,onProgress:l}){var c;try{const u=Yn(e),d=u.pb(Zc);l==null||l(new se("circuit-relay:write-connect-message")),await d.write({type:Zc.Type.CONNECT,peer:{id:r.toBytes(),addrs:[xe(i).bytes]}}),l==null||l(new se("circuit-relay:read-connect-response"));const f=await d.read();if(f.status!==Tn.OK)throw new S(`failed to connect via relay with status ${((c=f==null?void 0:f.status)==null?void 0:c.toString())??"undefined"}`,RQ);const p=z9({stream:u.unwrap(),remoteAddr:o,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger});return this.log("new outbound relayed connection %a",p.remoteAddr),await this.upgrader.upgradeOutbound(p,{transient:f.limit!=null,onProgress:l})}catch(u){throw this.log.error(`Circuit relay dial to destination ${r.toString()} via relay ${t.remotePeer.toString()} failed`,u),a&&await t.close(),u}}createListener(e){return NQ({connectionManager:this.connectionManager,relayStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>fs.matches(t))}dialFilter(e){return this.listenFilter(e)}async onStop({connection:e,stream:t}){var c,u;if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(d){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",d)}const r=AbortSignal.timeout(this.stopTimeout),i=Yn(t).pb(os),s=await i.read({signal:r});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,s.type),(s==null?void 0:s.type)===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await i.write({type:os.Type.STATUS,status:Tn.MALFORMED_MESSAGE},{signal:r}),await t.close();return}if(s.type!==os.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:os.Type.STATUS,status:Tn.UNEXPECTED_MESSAGE},{signal:r}),await t.close();return}if(!BQ(s)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:os.Type.STATUS,status:Tn.MALFORMED_MESSAGE},{signal:r}),await t.close();return}const o=di(s.peer.id);if(await((u=(c=this.connectionGater).denyInboundRelayedConnection)==null?void 0:u.call(c,e.remotePeer,o))===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await i.write({type:os.Type.STATUS,status:Tn.PERMISSION_DENIED},{signal:r}),await t.close();return}this.log.trace("sending success response to %p",e.remotePeer),await i.write({type:os.Type.STATUS,status:Tn.OK},{signal:r});const a=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`);this.addressManager.getAddresses()[0];const l=z9({stream:i.unwrap().unwrap(),remoteAddr:a,logger:this.logger});this.log("new inbound relayed connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{transient:s.limit!=null}),this.log("%s connection %a upgraded","inbound",l.remoteAddr)}}function $Q(n={}){return e=>new MQ(e,n)}const V9=()=>{const n=new Error("Delay aborted");return n.name="AbortError",n},UQ=new WeakMap;function FQ({clearTimeout:n,setTimeout:e}={}){return(t,{value:r,signal:i}={})=>{if(i!=null&&i.aborted)return Promise.reject(V9());let s,o,a;const l=n??clearTimeout,c=()=>{l(s),a(V9())},u=()=>{i&&i.removeEventListener("abort",c)},d=new Promise((f,p)=>{o=()=>{u(),f(r)},a=p,s=(e??setTimeout)(o,t)});return i&&i.addEventListener("abort",c,{once:!0}),UQ.set(d,()=>{l(s),s=null,o()}),d}}const UC=FQ();var xi;(function(n){(function(r){r.UNUSED="UNUSED",r.CONNECT="CONNECT",r.SYNC="SYNC"})(n.Type||(n.Type={}));let e;(function(r){r[r.UNUSED=0]="UNUSED",r[r.CONNECT=100]="CONNECT",r[r.SYNC=300]="SYNC"})(e||(e={})),function(r){r.codec=()=>Pn(e)}(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=Ae((r,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.observedAddresses!=null)for(const o of r.observedAddresses)i.uint32(18),i.bytes(o);s.lengthDelimited!==!1&&i.ldelim()},(r,i)=>{const s={observedAddresses:[]},o=i==null?r.len:r.pos+i;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:s.type=n.Type.codec().decode(r);break;case 2:s.observedAddresses.push(r.bytes());break;default:r.skipType(a&7);break}}return s})),t),n.encode=r=>Re(r,n.codec()),n.decode=r=>ke(r,n.codec())})(xi||(xi={}));function H9(n,e){return J0.matches(n)||e.dialTransportForMultiaddr(n)==null?!1:II.matches(n)?!0:fG.matches(n)?Bo(n.toOptions().host)===!1:!1}const K9=1024*4,W9=100,n1={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};var TE,NE;NE=Symbol.toStringTag,TE=Dc;class zQ{constructor(e,t){h(this,"started");h(this,"timeout");h(this,"retries");h(this,"maxInboundStreams");h(this,"maxOutboundStreams");h(this,"peerStore");h(this,"registrar");h(this,"connectionManager");h(this,"addressManager");h(this,"transportManager");h(this,"topologyId");h(this,"log");h(this,NE,"@libp2p/dcutr");h(this,TE,["@libp2p/identify"]);this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??n1.timeout,this.retries=t.retries??n1.retries,this.maxInboundStreams=t.maxInboundStreams??n1.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??n1.maxOutboundStreams}isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(r1,{notifyOnTransient:!0,onConnect:(e,t)=>{t.transient&&t.direction==="inbound"&&this.upgradeInbound(t).catch(r=>{this.log.error("error during outgoing DCUtR attempt",r)})}}),await this.registrar.handle(r1,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(r1),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let r=0;r<this.retries;r++){const i={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([r1],{signal:i.signal,runOnTransientConnection:!0});const s=Yn(t,{maxDataLength:K9}).pb(xi);this.log("B sending connect to %p",e.remotePeer);const o=Date.now();await s.write({type:xi.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(d=>d.bytes)},i),this.log("B receiving connect from %p",e.remotePeer);const a=await s.read(i);if(a.type!==xi.Type.CONNECT)throw this.log("A sent wrong message type"),new S("DCUtR message type was incorrect",sa);const l=this.getDialableMultiaddrs(a.observedAddresses);if(l.length===0)throw this.log("A did not have any dialable multiaddrs"),new S("DCUtR connect message had no multiaddrs",sa);const c=Date.now()-o;this.log("A sending sync, rtt %dms",c),await s.write({type:xi.Type.SYNC,observedAddresses:[]},i),this.log("A waiting for half RTT"),await UC(c/2),this.log("B dialing",l);const u=await this.connectionManager.openConnection(l,{signal:i.signal,priority:W9});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(i);break}catch(s){if(this.log.error("error while attempting DCUtR on attempt %d of %d",r+1,this.retries,s),t==null||t.abort(s),r===this.retries)throw s}finally{t!=null&&await t.close(i)}}}async attemptUnilateralConnectionUpgrade(e){const r=(await this.peerStore.get(e.remotePeer)).addresses.map(i=>{const s=i.multiaddr;return s.getPeerId()==null?s.encapsulate(`/p2p/${e.remotePeer}`):s}).filter(i=>H9(i,this.transportManager));if(r.length>0){const i=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",r);const s=await this.connectionManager.openConnection(r,{signal:i,force:!0});if(s.transient)throw new Error("Could not open a new, non-transient, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,s.remoteAddr),await e.close({signal:i}),!0}catch(s){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,r,s)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const r={signal:AbortSignal.timeout(this.timeout)};try{const i=Yn(e,{maxDataLength:K9}).pb(xi);this.log("A receiving connect");const s=await i.read(r);if(s.type!==xi.Type.CONNECT)throw this.log("B sent wrong message type"),new S("DCUtR message type was incorrect",sa);if(s.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new S("DCUtR connect message had no multiaddrs",sa);const o=this.getDialableMultiaddrs(s.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs"),new S("DCUtR connect message had no dialable multiaddrs",sa);if(this.log("A sending connect"),await i.write({type:xi.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(c=>c.bytes)}),this.log("A receiving sync"),(await i.read(r)).type!==xi.Type.SYNC)throw new S("DCUtR message type was incorrect",sa);this.log("A dialing",o);const l=await this.connectionManager.openConnection(o,{signal:r.signal,priority:W9,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,l.remoteAddr),await t.close(r)}catch(i){this.log.error("incoming DCUtR from %p failed",t.remotePeer,i),e.abort(i)}finally{await e.close(r)}}getDialableMultiaddrs(e){const t=[];for(const r of e)if(!(r==null||r.length===0))try{const i=xe(r);if(!H9(i,this.transportManager))continue;t.push(i)}catch{}return t}}const r1="/libp2p/dcutr";function VQ(n={}){return e=>new zQ(e,n)}const HQ="0.1.0",KQ="id",WQ="id/push",GQ="1.0.0",qQ="1.0.0",jQ=1024*8,YQ=32;var nu;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.protocolVersion!=null&&(r.uint32(42),r.string(t.protocolVersion)),t.agentVersion!=null&&(r.uint32(50),r.string(t.agentVersion)),t.publicKey!=null&&(r.uint32(10),r.bytes(t.publicKey)),t.listenAddrs!=null)for(const s of t.listenAddrs)r.uint32(18),r.bytes(s);if(t.observedAddr!=null&&(r.uint32(34),r.bytes(t.observedAddr)),t.protocols!=null)for(const s of t.protocols)r.uint32(26),r.string(s);t.signedPeerRecord!=null&&(r.uint32(66),r.bytes(t.signedPeerRecord)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={listenAddrs:[],protocols:[]},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 5:i.protocolVersion=t.string();break;case 6:i.agentVersion=t.string();break;case 1:i.publicKey=t.bytes();break;case 2:i.listenAddrs.push(t.bytes());break;case 4:i.observedAddr=t.bytes();break;case 3:i.protocols.push(t.string());break;case 8:i.signedPeerRecord=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(nu||(nu={}));function QQ(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}var XQ=QQ;const JQ=ci(XQ),P5=typeof window=="object"&&typeof document=="object"&&document.nodeType===9,Lp=JQ(),FC=P5&&!Lp,ZQ=Lp&&!P5,eX=Lp&&P5,tX=typeof globalThis.process<"u"&&typeof globalThis.process.release<"u"&&globalThis.process.release.name==="node"&&!Lp,zC=typeof importScripts=="function"&&typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope,nX=typeof navigator<"u"&&navigator.product==="ReactNative",kr={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:jQ,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnTransientConnection:!0,concurrency:YQ};function rX(n){if(n!=null&&n.length>0)try{return xe(n)}catch{}}function iX(n,e){return e!=null||(e=`${n.name}/${n.version}`,tX||ZQ?e+=` UserAgent=${globalThis.process.version}`:(FC||zC||eX||nX)&&(e+=` UserAgent=${globalThis.navigator.userAgent}`)),e}async function VC(n,e,t,r,i){if(t("received identify from %p",r.remotePeer),i==null)throw new S("message was null or undefined","ERR_INVALID_MESSAGE");const s={};if(i.listenAddrs.length>0&&(s.addresses=i.listenAddrs.map(l=>({isCertified:!1,multiaddr:xe(l)}))),i.protocols.length>0&&(s.protocols=i.protocols),i.publicKey!=null&&(s.publicKey=i.publicKey,!(await qi(i.publicKey)).equals(r.remotePeer)))throw new S("public key did not match remote PeerId","ERR_INVALID_PUBLIC_KEY");let o;if(i.signedPeerRecord!=null){t("received signedPeerRecord from %p",r.remotePeer);let l=i.signedPeerRecord;const c=await Mo.openAndCertify(l,Ki.DOMAIN);let u=Ki.createFromProtobuf(c.payload);if(!u.peerId.equals(c.peerId))throw new S("signing key does not match PeerId in the PeerRecord","ERR_INVALID_SIGNING_KEY");if(!r.remotePeer.equals(u.peerId))throw new S("signing key does not match remote PeerId","ERR_INVALID_PEER_RECORD_KEY");let d;try{d=await n.get(u.peerId)}catch(f){if(f.code!=="ERR_NOT_FOUND")throw f}if(d!=null&&(s.metadata=d.metadata,d.peerRecordEnvelope!=null)){const f=await Mo.createFromProtobuf(d.peerRecordEnvelope),p=Ki.createFromProtobuf(f.payload);p.seqNumber>=u.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",p.seqNumber,u.seqNumber),u=p,l=d.peerRecordEnvelope)}s.peerRecordEnvelope=l,s.addresses=u.multiaddrs.map(f=>({isCertified:!0,multiaddr:f})),o={seq:u.seqNumber,addresses:u.multiaddrs}}else t("%p did not send a signed peer record",r.remotePeer);if(t("patching %p with",r.remotePeer,s),await n.patch(r.remotePeer,s),i.agentVersion!=null||i.protocolVersion!=null){const l={};i.agentVersion!=null&&(l.AgentVersion=Y(i.agentVersion)),i.protocolVersion!=null&&(l.ProtocolVersion=Y(i.protocolVersion)),t("merging %p metadata",r.remotePeer,l),await n.merge(r.remotePeer,{metadata:l})}const a={peerId:r.remotePeer,protocolVersion:i.protocolVersion,agentVersion:i.agentVersion,publicKey:i.publicKey,listenAddrs:i.listenAddrs.map(l=>xe(l)),observedAddr:i.observedAddr==null?void 0:xe(i.observedAddr),protocols:i.protocols,signedPeerRecord:o,connection:r};return e.safeDispatchEvent("peer:identify",{detail:a}),a}class HC{constructor(e,t){h(this,"host");h(this,"protocol");h(this,"started");h(this,"timeout");h(this,"peerId");h(this,"peerStore");h(this,"registrar");h(this,"addressManager");h(this,"maxInboundStreams");h(this,"maxOutboundStreams");h(this,"maxMessageSize");h(this,"maxObservedAddresses");h(this,"events");h(this,"runOnTransientConnection");h(this,"log");this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??kr.timeout,this.maxInboundStreams=t.maxInboundStreams??kr.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??kr.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??kr.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??kr.maxObservedAddresses,this.runOnTransientConnection=t.runOnTransientConnection??kr.runOnTransientConnection,this.host={protocolVersion:`${t.protocolPrefix??kr.protocolPrefix}/${HQ}`,agentVersion:iX(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:Y(this.host.agentVersion),ProtocolVersion:Y(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}var DE,PE;class sX extends(PE=HC,DE=Dn,PE){constructor(t,r={}){super(t,{...r,protocol:`/${r.protocolPrefix??kr.protocolPrefix}/${WQ}/${qQ}`,log:t.logger.forComponent("libp2p:identify-push")});h(this,"connectionManager");h(this,"concurrency");h(this,DE,["@libp2p/identify-push"]);this.connectionManager=t.connectionManager,this.concurrency=r.concurrency??kr.concurrency,(r.runOnSelfUpdate??kr.runOnSelfUpdate)&&t.events.addEventListener("self:peer:update",i=>{this.push().catch(s=>{this.log.error(s)})})}async push(){if(!this.isStarted())return;const t=this.addressManager.getAddresses().map(d=>d.decapsulateCode(Mt("p2p").code)),r=new Ki({peerId:this.peerId,multiaddrs:t}),i=await Mo.seal(r,this.peerId),s=this.registrar.getProtocols(),o=await this.peerStore.get(this.peerId),a=ne(o.metadata.get("AgentVersion")??Y(this.host.agentVersion)),l=ne(o.metadata.get("ProtocolVersion")??Y(this.host.protocolVersion)),c=this;async function*u(){for(const d of c.connectionManager.getConnections())(await c.peerStore.get(d.remotePeer)).protocols.includes(c.protocol)&&(yield async()=>{let p;const y=AbortSignal.timeout(c.timeout);ue(1/0,y);try{p=await d.newStream(c.protocol,{signal:y,runOnTransientConnection:c.runOnTransientConnection}),await Yn(p,{maxDataLength:c.maxMessageSize}).pb(nu).write({listenAddrs:t.map(w=>w.bytes),signedPeerRecord:i.marshal(),protocols:s,agentVersion:a,protocolVersion:l},{signal:y}),await p.close({signal:y})}catch(g){c.log.error("could not push identify update to peer",g),p==null||p.abort(g)}})}await Fa(al(u(),{concurrency:this.concurrency}))}async handleProtocol(t){const{connection:r,stream:i}=t;try{if(this.peerId.equals(r.remotePeer))throw new Error("received push from ourselves?");const s={signal:AbortSignal.timeout(this.timeout)},a=await Yn(i,{maxDataLength:this.maxMessageSize}).pb(nu).read(s);await i.close(s),await VC(this.peerStore,this.events,this.log,r,a)}catch(s){this.log.error("received invalid message",s),i.abort(s);return}this.log("handled push from %p",r.remotePeer)}}var OE,LE;class oX extends(LE=HC,OE=Dn,LE){constructor(t,r={}){super(t,{...r,protocol:`/${r.protocolPrefix??kr.protocolPrefix}/${KQ}/${GQ}`,log:t.logger.forComponent("libp2p:identify")});h(this,OE,["@libp2p/identify"]);(r.runOnConnectionOpen??kr.runOnConnectionOpen)&&t.events.addEventListener("connection:open",i=>{const s=i.detail;this.identify(s).catch(o=>{this.log.error("error during identify trigged by connection:open",o)})})}async _identify(t,r={}){let i;if(r.signal==null){const s=AbortSignal.timeout(this.timeout);ue(1/0,s),r={...r,signal:s}}try{i=await t.newStream(this.protocol,{...r,runOnTransientConnection:this.runOnTransientConnection});const o=await Yn(i,{maxDataLength:this.maxMessageSize}).pb(nu).read(r);return await i.close(r),o}catch(s){throw this.log.error("error while reading identify message",s),i==null||i.abort(s),s}}async identify(t,r={}){const i=await this._identify(t,r),{publicKey:s,protocols:o,observedAddr:a}=i;if(s==null)throw new S("public key was missing from identify message","ERR_MISSING_PUBLIC_KEY");const l=await qi(s);if(!t.remotePeer.equals(l))throw new S("identified peer does not match the expected peer","ERR_INVALID_PEER");if(this.peerId.equals(l))throw new S("identified peer is our own peer id?","ERR_INVALID_PEER");const c=rX(a);return this.log("identify completed for peer %p and protocols %o",l,o),this.log("our observed address is %a",c),c!=null&&this.addressManager.getObservedAddrs().length<(this.maxObservedAddresses??1/0)&&(this.log("storing our observed address %a",c),this.addressManager.addObservedAddr(c)),VC(this.peerStore,this.events,this.log,t,i)}async handleProtocol(t){const{connection:r,stream:i}=t,s=AbortSignal.timeout(this.timeout);ue(1/0,s);try{const o=this.peerId.publicKey??new Uint8Array(0),a=await this.peerStore.get(this.peerId),l=this.addressManager.getAddresses().map(f=>f.decapsulateCode(Mt("p2p").code));let c=a.peerRecordEnvelope;if(l.length>0&&c==null){const f=new Ki({peerId:this.peerId,multiaddrs:l});c=(await Mo.seal(f,this.peerId)).marshal().subarray()}let u=r.remoteAddr.bytes;hG.matches(r.remoteAddr)||(u=void 0),await Yn(i).pb(nu).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:o,listenAddrs:l.map(f=>f.bytes),signedPeerRecord:c,observedAddr:u,protocols:a.protocols},{signal:s}),await i.close({signal:s})}catch(o){this.log.error("could not respond to identify request",o),i.abort(o)}}}function aX(n={}){return e=>new oX(e,n)}function lX(n={}){return e=>new sX(e,n)}const lf=1e3,O5=60*lf,L5=60*O5,cX=36*L5,uX="/ipfs/kad/1.0.0",dX="/dht/record",KC="/dht/provider",hX=256,fX=24*L5,pX=L5,yy=20,a2=3,gX=5*O5,yX=lf,mX=5*lf,wX=5*O5,vX=30*lf,EX=180*lf;var l2;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.key!=null&&t.key.byteLength>0&&(r.uint32(10),r.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(r.uint32(18),r.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(r.uint32(42),r.string(t.timeReceived)),i.lengthDelimited!==!1&&r.ldelim()},(t,r,i={})=>{const s={key:Xe(0),value:Xe(0),timeReceived:""},o=r==null?t.len:t.pos+r;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>Re(t,n.codec()),n.decode=(t,r)=>ke(t,n.codec(),r)})(l2||(l2={}));function bX(n){const e=n.getUTCFullYear(),t=String(n.getUTCMonth()+1).padStart(2,"0"),r=String(n.getUTCDate()).padStart(2,"0"),i=String(n.getUTCHours()).padStart(2,"0"),s=String(n.getUTCMinutes()).padStart(2,"0"),o=String(n.getUTCSeconds()).padStart(2,"0"),a=n.getUTCMilliseconds(),l=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${r}T${i}:${s}:${o}.${l}Z`}function _X(n){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(n).trim().match(e);if(t==null)throw new Error("Invalid format");const r=parseInt(t[1],10),i=parseInt(t[2],10)-1,s=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),l=parseInt(t[6],10),c=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(r,i,s,o,a,l,c))}class Or{constructor(e,t,r){h(this,"key");h(this,"value");h(this,"timeReceived");if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=r}serialize(){return l2.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:bX(this.timeReceived)}}static deserialize(e){const t=l2.decode(e);return new Or(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=_X(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Or(e.key,e.value,t)}}var G9;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.key!=null&&(r.uint32(10),r.bytes(t.key)),t.value!=null&&(r.uint32(18),r.bytes(t.value)),t.author!=null&&(r.uint32(26),r.bytes(t.author)),t.signature!=null&&(r.uint32(34),r.bytes(t.signature)),t.timeReceived!=null&&(r.uint32(42),r.string(t.timeReceived)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 3:{i.author=t.bytes();break}case 4:{i.signature=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(o&7);break}}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(G9||(G9={}));var et;(function(n){n.PUT_VALUE="PUT_VALUE",n.GET_VALUE="GET_VALUE",n.ADD_PROVIDER="ADD_PROVIDER",n.GET_PROVIDERS="GET_PROVIDERS",n.FIND_NODE="FIND_NODE",n.PING="PING"})(et||(et={}));var c2;(function(n){n[n.PUT_VALUE=0]="PUT_VALUE",n[n.GET_VALUE=1]="GET_VALUE",n[n.ADD_PROVIDER=2]="ADD_PROVIDER",n[n.GET_PROVIDERS=3]="GET_PROVIDERS",n[n.FIND_NODE=4]="FIND_NODE",n[n.PING=5]="PING"})(c2||(c2={}));(function(n){n.codec=()=>Pn(c2)})(et||(et={}));var ru;(function(n){n.NOT_CONNECTED="NOT_CONNECTED",n.CONNECTED="CONNECTED",n.CAN_CONNECT="CAN_CONNECT",n.CANNOT_CONNECT="CANNOT_CONNECT"})(ru||(ru={}));var my;(function(n){n[n.NOT_CONNECTED=0]="NOT_CONNECTED",n[n.CONNECTED=1]="CONNECTED",n[n.CAN_CONNECT=2]="CAN_CONNECT",n[n.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(my||(my={}));(function(n){n.codec=()=>Pn(my)})(ru||(ru={}));var Bl;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.id!=null&&t.id.byteLength>0&&(r.uint32(10),r.bytes(t.id)),t.multiaddrs!=null)for(const s of t.multiaddrs)r.uint32(18),r.bytes(s);t.connection!=null&&(r.uint32(24),ru.codec().encode(t.connection,r)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={id:Xe(0),multiaddrs:[]},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:{i.id=t.bytes();break}case 2:{i.multiaddrs.push(t.bytes());break}case 3:{i.connection=ru.codec().decode(t);break}default:{t.skipType(o&7);break}}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(Bl||(Bl={}));var xs;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.type!=null&&c2[t.type]!==0&&(r.uint32(8),et.codec().encode(t.type,r)),t.clusterLevel!=null&&(r.uint32(80),r.int32(t.clusterLevel)),t.key!=null&&(r.uint32(18),r.bytes(t.key)),t.record!=null&&(r.uint32(26),r.bytes(t.record)),t.closer!=null)for(const s of t.closer)r.uint32(66),Bl.codec().encode(s,r);if(t.providers!=null)for(const s of t.providers)r.uint32(74),Bl.codec().encode(s,r);i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={type:et.PUT_VALUE,closer:[],providers:[]},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:{i.type=et.codec().decode(t);break}case 10:{i.clusterLevel=t.int32();break}case 2:{i.key=t.bytes();break}case 3:{i.record=t.bytes();break}case 8:{i.closer.push(Bl.codec().decode(t,t.uint32()));break}case 9:{i.providers.push(Bl.codec().decode(t,t.uint32()));break}default:{t.skipType(o&7);break}}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(xs||(xs={}));function q9(n,e={}){var r;const t={...n,name:"SEND_QUERY",type:0,messageName:n.type,messageType:n.type};return(r=e.onProgress)==null||r.call(e,new ui("kad-dht:query:send-query",{detail:t})),t}function wy(n,e={}){var r;const t={...n,name:"PEER_RESPONSE",type:1,messageName:n.messageType,closer:n.closer??[],providers:n.providers??[]};return(r=e.onProgress)==null||r.call(e,new ui("kad-dht:query:peer-response",{detail:t})),t}function c3(n,e={}){var r;const t={...n,name:"FINAL_PEER",type:2};return(r=e.onProgress)==null||r.call(e,new ui("kad-dht:query:final-peer",{detail:t})),t}function $o(n,e={}){var r;const t={...n,name:"QUERY_ERROR",type:3};return(r=e.onProgress)==null||r.call(e,new ui("kad-dht:query:query-error",{detail:t})),t}function j9(n,e={}){var r;const t={...n,name:"PROVIDER",type:4};return(r=e.onProgress)==null||r.call(e,new ui("kad-dht:query:provider",{detail:t})),t}function vy(n,e={}){var r;const t={...n,name:"VALUE",type:5};return(r=e.onProgress)==null||r.call(e,new ui("kad-dht:query:value",{detail:t})),t}function Y9(n,e={}){var r;const t={...n,name:"DIAL_PEER",type:7};return(r=e.onProgress)==null||r.call(e,new ui("kad-dht:query:dial-peer",{detail:t})),t}function SX(n,e,t){if(t.length===0){const o="No records given";throw new S(o,"ERR_NO_RECORDS_RECEIVED")}const i=ne(e).split("/");if(i.length<3){const o="Record key does not have a selector function";throw new S(o,"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")}const s=n[i[1].toString()];if(s==null){const o=`No selector function configured for key type "${i[1]}"`;throw new S(o,"ERR_UNRECOGNIZED_KEY_PREFIX")}return t.length===1?0:s(e,t)}function xX(n,e){return 0}const kX={pk:xX};async function B5(n,e){const t=e.key,i=ne(t).split("/");if(i.length<3)return;const s=n[i[1].toString()];if(s==null){const o=`No validator available for key type "${i[1]}"`;throw new S(o,"ERR_INVALID_RECORD_KEY_TYPE")}await s(t,e.value)}const RX=async(n,e)=>{if(!(n instanceof Uint8Array))throw new S('"key" must be a Uint8Array',"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(n.byteLength<5)throw new S("invalid public key record","ERR_INVALID_RECORD_KEY_TOO_SHORT");if(ne(n.subarray(0,4))!=="/pk/")throw new S("key was not prefixed with /pk/","ERR_INVALID_RECORD_KEY_BAD_PREFIX");const r=n.slice(4),i=await nn.digest(e);if(!Pe(r,i.bytes))throw new S("public key does not match passed in key","ERR_INVALID_RECORD_HASH_MISMATCH")},AX={pk:RX},IX=Y("/pk/");function CX(n){return{...n,multiaddrs:n.multiaddrs.filter(e=>{const[[t,r]]=e.stringTuples();if(t===53||t===54||t===55)return r!=="localhost";if(t!==4&&t!==6||r==null)return!1;const i=Bo(r);return i==null?!0:!i})}}async function Rh(n){return(await nn.digest(n)).digest}async function ps(n){return Rh(n.toBytes())}function Ld(n){return new ot(`${dX}/${ne(n,"base32")}`,!1)}function TX(n){return vn([IX,n.toBytes()])}function NX(n){return ne(n.subarray(0,4))==="/pk/"}function DX(n){return di(n.subarray(4))}function Q9(n,e){const t=new Date;return new Or(n,e,t).serialize()}function PX(n,e=100){let t;return()=>{clearTimeout(t),t=setTimeout(()=>{n()},e)}}const OX=290,LX=54,BX=55,MX=56,$X=4,UX=41;function FX(n){const e=n.stringTuples();for(const t of e)if(t[0]===OX)return!1;if(e[0][0]===LX||e[0][0]===BX||e[0][0]===MX)return!0;if(e[0][0]===$X||e[0][0]===UX){const t=Bo(`${e[0][1]}`);return t==null||!t}return!1}class zX{constructor(e,t){h(this,"log");h(this,"components");h(this,"validators");h(this,"selectors");h(this,"peerRouting");h(this,"queryManager");h(this,"network");const{validators:r,selectors:i,peerRouting:s,queryManager:o,network:a,logPrefix:l}=t;this.components=e,this.log=e.logger.forComponent(`${l}:content-fetching`),this.validators=r,this.selectors=i,this.peerRouting=s,this.queryManager=o,this.network=a}async getLocal(e){this.log("getLocal %b",e);const t=Ld(e);this.log("fetching record for key %k",t);const r=await this.components.datastore.get(t);this.log("found %k in local datastore",t);const i=Or.deserialize(r);return await B5(this.validators,i),i}async*sendCorrectionRecord(e,t,r,i={}){this.log("sendCorrection for %b",e);const s=Q9(e,r);for(const{value:o,from:a}of t){if(Pe(o,r)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const u=Ld(e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,s.subarray())}catch(u){this.log.error("Failed error correcting self",u)}continue}let l=!1;const c={type:et.PUT_VALUE,key:e,record:s};for await(const u of this.network.sendRequest(a,c,i))u.name==="PEER_RESPONSE"&&u.record!=null&&Pe(u.record.value,Or.deserialize(s).value)&&(l=!0),yield u;l||(yield $o({from:a,error:new S("value not put correctly","ERR_PUT_VALUE_INVALID")},i)),this.log.error("Failed error correcting entry")}}async*put(e,t,r={}){this.log("put key %b value %b",e,t);const i=Q9(e,t),s=Ld(e);this.log(`storing record for key ${s.toString()}`),await this.components.datastore.put(s,i.subarray()),yield*En(this.peerRouting.getClosestPeers(e,{signal:r.signal}),o=>Wo(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const l=[],c={type:et.PUT_VALUE,key:e,record:i};this.log("send put to %p",a.peer.id);for await(const u of this.network.sendRequest(a.peer.id,c,r))l.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&Pe(u.record.value,Or.deserialize(i).value)||l.push($o({from:a.peer.id,error:new S("value not put correctly","ERR_PUT_VALUE_INVALID")},r)));return l}),o=>al(o,{ordered:!1,concurrency:a2}),async function*(o){for await(const a of o)yield*a})}async*get(e,t={}){this.log("get %b",e);const r=[];for await(const a of this.getMany(e,t))a.name==="VALUE"&&r.push(a),yield a;if(r.length===0)return;const i=r.map(a=>a.value);let s=0;try{s=SX(this.selectors,e,i)}catch(a){if(a.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw a}const o=i[s];if(this.log("GetValue %b %b",e,o),o==null)throw new S("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,r,o,t),yield r[s]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const s=await this.getLocal(e);yield vy({value:s.value,from:this.components.peerId},t)}catch(s){this.log("error getting local value for %b",e,s)}const r=this,i=async function*({peer:s,signal:o}){for await(const a of r.peerRouting.getValueOrPeers(s,e,{signal:o}))yield a,a.name==="PEER_RESPONSE"&&a.record!=null&&(yield vy({from:s,value:a.record.value},t))};yield*this.queryManager.run(e,i,t)}}function VX(n,e){return{id:n.id.toBytes(),multiaddrs:(n.multiaddrs??[]).map(r=>r.bytes),connection:e}}function i1(n){if(n.id==null)throw new Error("Invalid peer in message");return{id:di(n.id),multiaddrs:(n.multiaddrs??[]).map(e=>xe(e))}}class HX{constructor(e,t){h(this,"log");h(this,"components");h(this,"network");h(this,"peerRouting");h(this,"queryManager");h(this,"routingTable");h(this,"providers");const{network:r,peerRouting:i,queryManager:s,routingTable:o,providers:a,logPrefix:l}=t;this.components=e,this.log=e.logger.forComponent(`${l}:content-routing`),this.network=r,this.peerRouting=i,this.queryManager=s,this.routingTable=o,this.providers=a}async*provide(e,t,r={}){this.log("provide %s",e);const i=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId);const s={type:et.ADD_PROVIDER,key:i,providers:[VX({id:this.components.peerId,multiaddrs:t})]};let o=0;const a=l=>async()=>{if(l.name!=="FINAL_PEER")return[l];const c=[];this.log("putProvider %s to %p",e,l.peer.id);try{this.log("sending provider record for %s to %p",e,l.peer.id);for await(const u of this.network.sendMessage(l.peer.id,s,r))u.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,l.peer.id),o++),c.push(u)}catch(u){this.log.error("error sending provide record to peer %p",l.peer.id,u),c.push($o({from:l.peer.id,error:u},r))}return c};yield*En(this.peerRouting.getClosestPeers(i,r),l=>Wo(l,c=>a(c)),l=>al(l,{ordered:!1,concurrency:a2}),async function*(l){for await(const c of l)yield*c}),this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const r=this.routingTable.kBucketSize;let i=0;const s=e.multihash.bytes,o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e);if(a.length>0){const u=[];for(const d of a.slice(0,r))try{const f=await this.components.peerStore.get(d);u.push({id:d,multiaddrs:f.addresses.map(({multiaddr:p})=>p)})}catch(f){if(f.code!=="ERR_NOT_FOUND")throw f;this.log("no peer store entry for %p",d)}if(yield wy({from:this.components.peerId,messageType:et.GET_PROVIDERS,providers:u},t),yield j9({from:this.components.peerId,providers:u},t),i+=u.length,i>=r)return}const l=async function*({peer:u,signal:d}){const f={type:et.GET_PROVIDERS,key:s};yield*o.network.sendRequest(u,f,{...t,signal:d})},c=new si(a);for await(const u of this.queryManager.run(s,l,t))if(yield u,u.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",u.providers.length,e,u.closer.length);const d=[];for(const f of u.providers)c.has(f.id)||(c.add(f.id),d.push(f));if(d.length>0&&(yield j9({from:u.from,providers:d},t),i+=d.length,i>=r))return}}}class u3{constructor(e){h(this,"movingAverage");h(this,"variance");h(this,"deviation");h(this,"forecast");h(this,"timespan");h(this,"previousTime");this.timespan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timespan)}push(e,t=Date.now()){if(this.previousTime!=null){const r=this.alpha(t,this.previousTime),i=e-this.movingAverage,s=r*i;this.movingAverage=r*e+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+i*s),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*i}else this.movingAverage=e;this.previousTime=t}}const KX=1.2,WX=2,GX=2e3;class WC{constructor(e={}){h(this,"success");h(this,"failure");h(this,"next");h(this,"metric");h(this,"timeoutMultiplier");h(this,"failureMultiplier");h(this,"minTimeout");var t;this.success=new u3(e.interval??5e3),this.failure=new u3(e.interval??5e3),this.next=new u3(e.interval??5e3),this.failureMultiplier=e.failureMultiplier??WX,this.timeoutMultiplier=e.timeoutMultiplier??KX,this.minTimeout=e.minTimeout??GX,e.metricName!=null&&(this.metric=(t=e.metrics)==null?void 0:t.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){const t=Math.max(Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),r=AbortSignal.timeout(t),i=bt([e.signal,r]);return ue(1/0,i,r),i.start=Date.now(),i.timeout=t,i}cleanUp(e){var r,i;const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),(r=this.metric)==null||r.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),(i=this.metric)==null||i.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class qX extends tn{constructor(t,r){super();h(this,"log");h(this,"protocol");h(this,"running");h(this,"components");h(this,"timeout");const{protocol:i}=r;this.components=t,this.log=t.logger.forComponent(`${r.logPrefix}:network`),this.running=!1,this.protocol=i,this.timeout=new WC({...r.timeout??{},metrics:t.metrics,metricName:`${r.logPrefix.replaceAll(":","_")}_network_message_send_times_milliseconds`})}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(t,r,i={}){if(!this.running)return;const s=r.type;if(s==null)throw new Va("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",r.type,t),yield Y9({peer:t},i),yield q9({to:t,type:s},i);let o;const a=this.timeout.getTimeoutSignal(i);i={...i,signal:a};try{o=await(await this.components.connectionManager.openConnection(t,i)).newStream(this.protocol,i);const c=await this._writeReadMessage(o,r,i);o.close(i).catch(u=>{this.log.error("error closing stream to %p",t,u),o==null||o.abort(u)}),yield wy({from:t,messageType:c.type,closer:c.closer.map(i1),providers:c.providers.map(i1),record:c.record==null?void 0:Or.deserialize(c.record)},i)}catch(l){o==null||o.abort(l),this.log.error("could not send %s to %p",r.type,t,l),yield $o({from:t,error:l},i)}finally{this.timeout.cleanUp(a)}}async*sendMessage(t,r,i={}){if(!this.running)return;const s=r.type;if(s==null)throw new Va("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",r.type,t),yield Y9({peer:t},i),yield q9({to:t,type:s},i);let o;const a=this.timeout.getTimeoutSignal(i);i={...i,signal:a};try{o=await(await this.components.connectionManager.openConnection(t,i)).newStream(this.protocol,i),await this._writeMessage(o,r,i),o.close(i).catch(c=>{this.log.error("error closing stream to %p",t,c),o==null||o.abort(c)}),yield wy({from:t,messageType:s},i)}catch(l){o==null||o.abort(l),yield $o({from:t,error:l},i)}finally{this.timeout.cleanUp(a)}}async _writeMessage(t,r,i){const s=Yn(t);await s.write(r,xs,i),await s.unwrap().close(i)}async _writeReadMessage(t,r,i){const s=Yn(t);await s.write(r,xs,i);const o=await s.read(xs,i);return await s.unwrap().close(i),o.closer.forEach(a=>{this.safeDispatchEvent("peer",{detail:i1(a)})}),o.providers.forEach(a=>{this.safeDispatchEvent("peer",{detail:i1(a)})}),o}}function u2(n,e){if(n.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return n[t]<e[t]?-1:1;return 0}class GC{constructor(e,t){h(this,"originDhtKey");h(this,"capacity");h(this,"peerDistances");this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peer)}async add(e){const t=await ps(e.id);this.addWitKadId(e,t)}addWitKadId(e,t){if(this.peerDistances.find(i=>i.peer.id.equals(e.id))!=null)return;const r={peer:e,distance:Qc(this.originDhtKey,t)};this.peerDistances.push(r),this.peerDistances.sort((i,s)=>u2(i.distance,s.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e){if(this.length===0)return!0;const t=await ps(e),r=Qc(t,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return u2(r,i)===-1}async anyCloser(e){return e.length===0?!1:Promise.any(e.map(async t=>this.isCloser(t)))}}class jX{constructor(e,t){h(this,"log");h(this,"routingTable");h(this,"network");h(this,"validators");h(this,"queryManager");h(this,"peerStore");h(this,"peerId");const{routingTable:r,network:i,validators:s,queryManager:o,logPrefix:a}=t;this.routingTable=r,this.network=i,this.validators=s,this.queryManager=o,this.peerStore=e.peerStore,this.peerId=e.peerId,this.log=e.logger.forComponent(`${a}:peer-routing`)}async findPeerLocal(e){let t;const r=await this.routingTable.find(e);if(r!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.peerStore.get(r)}catch(i){if(i.code!=="ERR_NOT_FOUND")throw i}}if(t==null)try{t=await this.peerStore.get(e)}catch(i){if(i.code!=="ERR_NOT_FOUND")throw i}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,r={}){const i={type:et.GET_VALUE,key:t};yield*this.network.sendRequest(e,i,r)}async*getPublicKeyFromNode(e,t={}){const r=TX(e);for await(const i of this._getValueSingle(e,r,t))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){const s=await qi(wA({bytes:i.record.value}));if(!s.equals(e))throw new S("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(s.publicKey==null)throw new S("public key missing","ERR_PUBLIC_KEY_MISSING");yield vy({from:e,value:s.publicKey},t)}throw new S(`Node not responding with its public key: ${e.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const i=await this.findPeerLocal(e);if(i!=null){this.log("found local"),yield c3({from:this.peerId,peer:i},t);return}}let r=!1;if(t.useNetwork!==!1){const i=this,s=async function*({peer:o,signal:a}){const l={type:et.FIND_NODE,key:e.toBytes()};for await(const c of i.network.sendRequest(o,l,{...t,signal:a}))if(yield c,c.name==="PEER_RESPONSE"){const u=c.closer.find(d=>d.id.equals(e));u!=null&&(yield c3({from:c.from,peer:u},t))}};for await(const o of this.queryManager.run(e.toBytes(),s,t))o.name==="FINAL_PEER"&&(r=!0),yield o}r||(yield $o({from:this.peerId,error:new S("Not found","ERR_NOT_FOUND")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const r=await Rh(e),i=this.routingTable.closestPeers(r),s=this,o=new GC(r,this.routingTable.kBucketSize);await Promise.all(i.map(async l=>{await o.add({id:l,multiaddrs:[]})}));const a=async function*({peer:l,signal:c}){s.log("closerPeersSingle %s from %p",ne(e,"base32"),l);const u={type:et.FIND_NODE,key:e};yield*s.network.sendRequest(l,u,{...t,signal:c})};for await(const l of this.queryManager.run(e,a,t))l.name==="PEER_RESPONSE"&&await Promise.all(l.closer.map(async c=>{await o.add(c)})),yield l;this.log("found %d peers close to %b",o.length,e);for(const l of o.peers)yield c3({from:this.peerId,peer:l},t)}async*getValueOrPeers(e,t,r={}){for await(const i of this._getValueSingle(e,t,r)){if(i.name==="PEER_RESPONSE"&&i.record!=null)try{await this._verifyRecordOnline(i.record)}catch{const o="invalid record received, discarded";this.log(o),yield $o({from:i.from,error:new S(o,"ERR_INVALID_RECORD")},r);continue}yield i}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw new S("invalid record received","ERR_INVALID_RECORD");await B5(this.validators,new Or(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){const r=await Rh(e),i=this.routingTable.closestPeers(r),s=[];for(const o of i)if(!o.equals(t))try{const a=await this.peerStore.get(o);s.push({id:o,multiaddrs:a.addresses.map(({multiaddr:l})=>l)})}catch(a){if(a.code!=="ERR_NOT_FOUND")throw a}return s.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",s.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p with %d peers in the routing table",e,t,this.routingTable.size),s}}class YX{constructor(e,t={}){h(this,"log");h(this,"datastore");h(this,"cache");h(this,"cleanupInterval");h(this,"provideValidity");h(this,"syncQueue");h(this,"started");h(this,"cleaner");const{cacheSize:r,cleanupInterval:i,provideValidity:s}=t;this.log=e.logger.forComponent("libp2p:kad-dht:providers"),this.datastore=e.datastore,this.cleanupInterval=i??pX,this.provideValidity=s??fX,this.cache=BA(r??hX),this.syncQueue=new l5({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval(()=>{this._cleanup().catch(e=>{this.log.error(e)})},this.cleanupInterval))}async stop(){this.started=!1,this.cleaner!=null&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add(async()=>{const e=Date.now();let t=0,r=0;const i=new Map,s=this.datastore.batch(),o=this.datastore.query({prefix:KC});for await(const a of o)try{const{cid:l,peerId:c}=qC(a.key),u=jC(a.value).getTime(),d=Date.now(),f=d-u,p=f>this.provideValidity;if(this.log("comparing: %d - %d = %d > %d %s",d,u,f,this.provideValidity,p?"(expired)":""),p){r++,s.delete(a.key);const y=i.get(l)??new Set;y.add(c),i.set(l,y)}t++}catch(l){this.log.error(l.message)}i.size>0?(this.log("deleting %d / %d entries",r,t),await s.commit()):this.log("nothing to delete");for(const[a,l]of i){const c=Bd(a),u=this.cache.get(c);if(u!=null){for(const d of l)u.delete(d);u.size===0?this.cache.remove(c):this.cache.set(c,u)}}this.log("Cleanup successful (%dms)",Date.now()-e)})}async _getProvidersMap(e){const t=Bd(e);let r=this.cache.get(t);return r==null&&(r=await XX(this.datastore,e),this.cache.set(t,r)),r}async addProvider(e,t){await this.syncQueue.add(async()=>{this.log("%p provides %s",t,e);const r=await this._getProvidersMap(e);this.log("loaded %s provs",r.size);const i=new Date;r.set(t.toString(),i);const s=Bd(e);this.cache.set(s,r),await QX(this.datastore,e,t,i)})}async getProviders(e){return this.syncQueue.add(async()=>(this.log("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map(r=>xt(r))),{throwOnTimeout:!0})}}function Bd(n){const e=typeof n=="string"?n:ne(n.multihash.bytes,"base32");return`${KC}/${e}`}async function QX(n,e,t,r){const i=[Bd(e),"/",t.toString()].join(""),s=new ot(i),o=ii(r.getTime());await n.put(s,o)}function qC(n){const e=n.toString().split("/");if(e.length!==5)throw new Error(`incorrectly formatted provider entry key in datastore: ${n.toString()}`);return{cid:e[3],peerId:e[4]}}async function XX(n,e){const t=new Map,r=n.query({prefix:Bd(e)});for await(const i of r){const{peerId:s}=qC(i.key);t.set(s,jC(i.value))}return t}function jC(n){return new Date(wu(n))}async function*JX(n){const{key:e,startingPeer:t,ourPeerId:r,signal:i,query:s,alpha:o,pathIndex:a,numPaths:l,queryFuncTimeout:c,log:u,peersSeen:d,connectionManager:f}=n,p=new Oc({concurrency:o,sort:(w,m)=>u2(w.options.distance,m.options.distance)}),y=await Rh(e);function g(w,m){if(w==null)return;d.add(w);const E=Qc(m,y);p.add(async()=>{const v=[i];c!=null&&v.push(AbortSignal.timeout(c));const b=bt(v);ue(1/0,b);try{for await(const k of s({key:e,peer:w,signal:b,pathIndex:a,numPaths:l})){if(b.aborted)return;if(k.name==="PEER_RESPONSE")for(const A of k.closer){if(d.has(A.id)){u("already seen %p in query",A.id);continue}if(r.equals(A.id)){u("not querying ourselves");continue}if(!await f.isDialable(A.multiaddrs)){u("not querying undialable peer");continue}const T=await ps(A.id),P=Qc(T,y);if(u2(P,E)!==-1){u("skipping %p as they are not closer to %b than %p",A.id,e,w);continue}u("querying closer peer %p",A.id),g(A.id,T)}p.safeDispatchEvent("completed",{detail:k})}}catch(k){if(!i.aborted)return $o({from:w,error:k},n)}finally{b.clear()}},{distance:E}).catch(v=>{u.error(v)})}g(t,await ps(t));try{for await(const w of p.toGenerator({signal:i}))w!=null&&(yield w)}catch(w){throw i.aborted?new S("Query aborted","ERR_QUERY_ABORTED"):w}}class ZX{constructor(e,t){h(this,"disjointPaths");h(this,"alpha");h(this,"shutDownController");h(this,"running");h(this,"queries");h(this,"logger");h(this,"peerId");h(this,"connectionManager");h(this,"routingTable");h(this,"initialQuerySelfHasRun");h(this,"logPrefix");h(this,"metrics");const{disjointPaths:r=yy,alpha:i=a2,logPrefix:s}=t;this.logPrefix=s,this.disjointPaths=r??yy,this.running=!1,this.alpha=i??a2,this.queries=0,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,e.metrics!=null&&(this.metrics={runningQueries:e.metrics.registerMetric(`${s.replaceAll(":","_")}_running_queries`),queryTime:e.metrics.registerMetric(`${s.replaceAll(":","_")}_query_time_seconds`)}),this.shutDownController=new AbortController,ue(1/0,this.shutDownController.signal)}isStarted(){return this.running}async start(){this.running=!0,this.shutDownController=new AbortController,ue(1/0,this.shutDownController.signal)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,r={}){var u,d,f;if(!this.running)throw new Error("QueryManager not started");const i=(u=this.metrics)==null?void 0:u.queryTime.timer();if(r.signal==null){const p=AbortSignal.timeout(EX);ue(1/0,p),r={...r,signal:p}}const s=new AbortController,o=bt([this.shutDownController.signal,s.signal,r.signal]);ue(1/0,o,s.signal);const a=this.logger.forComponent(`${this.logPrefix}:query:`+ne(e,"base58btc")),l=Date.now();let c=!1;try{r.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(a("waiting for initial query-self query before continuing"),await Pt(this.initialQuerySelfHasRun.promise,o),this.initialQuerySelfHasRun=void 0),a("query:start"),this.queries++,(d=this.metrics)==null||d.runningQueries.update(this.queries);const p=await Rh(e),y=this.routingTable.closestPeers(p),g=y.slice(0,Math.min(this.disjointPaths,y.length));if(y.length===0){a.error("Running query with no peers");return}const w=new si,m=g.map((E,v)=>JX({key:e,startingPeer:E,ourPeerId:this.peerId,signal:o,query:t,pathIndex:v,numPaths:g.length,alpha:this.alpha,queryFuncTimeout:r.queryFuncTimeout,log:a,peersSeen:w,onProgress:r.onProgress,connectionManager:this.connectionManager}));for await(const E of xo(...m)){if(E.name==="QUERY_ERROR"&&a.error("query error",E.error),E.name==="PEER_RESPONSE")for(const v of[...E.closer,...E.providers])await this.connectionManager.isDialable(v.multiaddrs)&&await this.routingTable.add(v.id);yield E}c=!0}catch(p){if(!(!this.running&&p.code==="ERR_QUERY_ABORTED"))throw p}finally{c||(a("query exited early"),s.abort()),o.clear(),this.queries--,(f=this.metrics)==null||f.runningQueries.update(this.queries),i!=null&&i(),a("query:done in %dms",Date.now()-l)}}}function eJ(n){return n[Symbol.asyncIterator]!=null}function YC(n){if(eJ(n))return(async()=>{let e=0;for await(const t of n)e++;return e})();{let e=0;for(const t of n)e++;return e}}const tJ=n=>{const e=n.addEventListener||n.on||n.addListener,t=n.removeEventListener||n.off||n.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(n),removeListener:t.bind(n)}};function nJ(n,e,t){let r;const i=new Promise((s,o)=>{var p;if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");(p=t.signal)==null||p.throwIfAborted();const a=[e].flat(),l=[],{addListener:c,removeListener:u}=tJ(n),d=(...y)=>{const g=t.multiArgs?y:y[0];t.filter&&!t.filter(g)||(l.push(g),t.count===l.length&&(r(),s(l)))},f=y=>{r(),o(y)};r=()=>{for(const y of a)u(y,d);for(const y of t.rejectionEvents)u(y,f)};for(const y of a)c(y,d);for(const y of t.rejectionEvents)c(y,f);t.signal&&t.signal.addEventListener("abort",()=>{f(t.signal.reason)},{once:!0}),t.resolveImmediately&&s(l)});if(i.cancel=r,typeof t.timeout=="number"){const s=vp(i,{milliseconds:t.timeout});return s.cancel=r,s}return i}function Ey(n,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const r=nJ(n,e,t),i=r.then(s=>s[0]);return i.cancel=r.cancel,i}class rJ{constructor(e,t){h(this,"log");h(this,"peerId");h(this,"peerRouting");h(this,"routingTable");h(this,"count");h(this,"interval");h(this,"initialInterval");h(this,"queryTimeout");h(this,"started");h(this,"timeoutId");h(this,"controller");h(this,"initialQuerySelfHasRun");h(this,"querySelfPromise");const{peerRouting:r,logPrefix:i,count:s,interval:o,queryTimeout:a,routingTable:l}=t;this.peerId=e.peerId,this.log=e.logger.forComponent(`${i}:query-self`),this.started=!1,this.peerRouting=r,this.routingTable=l,this.count=s??yy,this.interval=o??gX,this.initialInterval=t.initialInterval??yX,this.queryTimeout=a??mX,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun}isStarted(){return this.started}start(){this.started||(this.started=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.started=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.started){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=Se(),this.started){this.controller=new AbortController;const e=AbortSignal.timeout(this.queryTimeout),t=bt([this.controller.signal,e]);ue(1/0,t,this.controller.signal,e);try{this.routingTable.size===0&&(this.log("routing table was empty, waiting for some peers before running query"),await Ey(this.routingTable,"peer:add",{signal:t})),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const r=Date.now(),i=await En(this.peerRouting.getClosestPeers(this.peerId.toBytes(),{signal:t,isSelfQuery:!0}),s=>C0(s,this.count),async s=>YC(s));this.log("self-query found %d peers in %dms",i,Date.now()-r)}catch(r){this.log.error("self-query error",r)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.started&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}}function iJ(n,e){if(n===e)return!0;if(n.length!==e.length)return!1;for(let t=0,r=n.length;t<r;++t)if(n[t]!==e[t])return!1;return!0}function X9(n,e){if(!(e instanceof Uint8Array))throw new TypeError(n+" is not a Uint8Array");if(e.byteLength!==32)throw new TypeError(n+" had incorrect length")}function L1(n){return Array.isArray(n==null?void 0:n.peers)}class sJ extends tn{constructor(t){super();h(this,"root");h(this,"localPeer");h(this,"prefixLength");h(this,"splitThreshold");h(this,"kBucketSize");h(this,"numberOfNodesToPing");this.localPeer=t.localPeer,this.prefixLength=t.prefixLength,this.kBucketSize=t.kBucketSize??B1,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfNodesToPing??3,X9("options.localPeer.kadId",t.localPeer.kadId),this.root={prefix:"",depth:0,peers:[]}}add(t){X9("peer.kadId",t==null?void 0:t.kadId);const r=this._determineBucket(t.kadId);if(!(this._indexOf(r,t.kadId)>-1)){if(r.peers.length===this.splitThreshold&&r.depth<this.prefixLength){this._split(r),this.add(t);return}if(r.peers.length<this.kBucketSize){r.peers.push(t),this.safeDispatchEvent("added",{detail:t});return}this.safeDispatchEvent("ping",{detail:{oldContacts:r.peers.slice(0,this.numberOfNodesToPing),newContact:t}})}}*closest(t,r=this.kBucketSize){const i=new GC(t,r);for(const s of this.toIterable())i.addWitKadId({id:s.peerId,multiaddrs:[]},s.kadId);yield*Wo(i.peers,s=>s.id)}count(){function t(r){if(L1(r))return r.peers.length;let i=0;return r.left!=null&&(i+=t(r.left)),r.right!=null&&(i+=t(r.right)),i}return t(this.root)}get(t){const r=this._determineBucket(t),i=this._indexOf(r,t);return r.peers[i]}remove(t){const r=this._determineBucket(t),i=this._indexOf(r,t);if(i>-1){const s=r.peers.splice(i,1)[0];this.safeDispatchEvent("removed",{detail:s})}}*toIterable(){function*t(r){if(L1(r)){yield*r.peers;return}yield*t(r.left),yield*t(r.right)}yield*t(this.root)}distance(t,r){return BigInt("0x"+ne(Qc(t,r),"base16"))}_determineBucket(t){const i=ne(t,"base2").substring(0,this.prefixLength);function s(o,a=0){return L1(o)?o:i[a]==="0"?s(o.left,a+1):s(o.right,a+1)}return s(this.root)}_indexOf(t,r){return t.peers.findIndex(i=>iJ(i.kadId,r))}_split(t){const r=t.depth+1,i={prefix:"0",depth:r,peers:[]},s={prefix:"1",depth:r,peers:[]};for(const o of t.peers)ne(o.kadId,"base2")[r]==="0"?i.peers.push(o):s.peers.push(o);delete t.peers,t.left=i,t.right=s}}const oJ="kad-close",aJ=50,B1=20,lJ=32,cJ=1e4,uJ=10;class dJ extends tn{constructor(t,r){super();h(this,"kBucketSize");h(this,"kb");h(this,"pingQueue");h(this,"log");h(this,"components");h(this,"prefixLength");h(this,"splitThreshold");h(this,"pingTimeout");h(this,"pingConcurrency");h(this,"running");h(this,"protocol");h(this,"tagName");h(this,"tagValue");h(this,"metrics");this.components=t,this.log=t.logger.forComponent(`${r.logPrefix}:routing-table`),this.kBucketSize=r.kBucketSize??B1,this.pingTimeout=r.pingTimeout??cJ,this.pingConcurrency=r.pingConcurrency??uJ,this.running=!1,this.protocol=r.protocol,this.tagName=r.tagName??oJ,this.tagValue=r.tagValue??aJ,this.prefixLength=r.prefixLength??lJ,this.splitThreshold=r.splitThreshold??B1,this.pingQueue=new mu({concurrency:this.pingConcurrency,metricName:`${r.logPrefix.replaceAll(":","_")}_ping_queue`,metrics:this.components.metrics}),this.pingQueue.addEventListener("error",i=>{this.log.error("error pinging peer",i.detail)}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_max_depth`)})}isStarted(){return this.running}async start(){this.running=!0;const t=new sJ({localPeer:{kadId:await ps(this.components.peerId),peerId:this.components.peerId},kBucketSize:this.kBucketSize,prefixLength:this.prefixLength,splitThreshold:this.splitThreshold,numberOfNodesToPing:1});this.kb=t,t.addEventListener("ping",i=>{this._onPing(i).catch(s=>{this.log.error("could not process k-bucket ping event",s)})});let r=0;for(const i of await this.components.peerStore.all())if(i.protocols.includes(this.protocol)){const s=await ps(i.id);this.kb.add({kadId:s,peerId:i.id}),r++}this.log("added %d peer store peers to the routing table",r),this._tagPeers(t)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(t){let r=new si;const i=PX(()=>{const s=new si(t.closest(t.localPeer.kadId,B1)),o=s.difference(r),a=r.difference(s);Promise.resolve().then(async()=>{for(const l of o)await this.components.peerStore.merge(l,{tags:{[this.tagName]:{value:this.tagValue}}});for(const l of a)await this.components.peerStore.merge(l,{tags:{[this.tagName]:void 0}})}).catch(l=>{this.log.error("Could not update peer tags",l)}),r=s});t.addEventListener("added",s=>{i(),this.safeDispatchEvent("peer:add",{detail:s.detail.peerId})}),t.addEventListener("removed",s=>{i(),this.safeDispatchEvent("peer:remove",{detail:s.detail.peerId})})}async _onPing(t){if(!this.running)return;const{oldContacts:r,newContact:i}=t.detail,o=(await Promise.all(r.map(async a=>{const l=this.pingQueue.find(a.peerId);return l!=null?l.join():this.pingQueue.add(async()=>{var u;let c;try{const d={signal:AbortSignal.timeout(this.pingTimeout)};this.log("pinging old contact %p",a.peerId),c=await(await this.components.connectionManager.openConnection(a.peerId,d)).newStream(this.protocol,d);const p=Yn(c);await p.write({type:et.PING},xs,d);const y=await p.read(xs,d);if(await p.unwrap().close(),y.type!==et.PING)throw new S(`Incorrect message type received, expected PING got ${y.type}`,"ERR_BAD_PING_RESPONSE");return!0}catch(d){return this.running&&this.kb!=null&&(this.log.error("could not ping peer %p",a.peerId,d),this.log("evicting old contact after ping failed %p",a.peerId),this.kb.remove(a.kadId)),c==null||c.abort(d),!1}finally{(u=this.metrics)==null||u.routingTableSize.update(this.size)}},{peerId:a.peerId})}))).filter(a=>a).length;this.running&&o<r.length&&this.kb!=null&&(this.log("adding new contact %p",i.peerId),this.kb.add(i))}get size(){return this.kb==null?0:this.kb.count()}async find(t){var i,s;const r=await ps(t);return(s=(i=this.kb)==null?void 0:i.get(r))==null?void 0:s.peerId}closestPeer(t){const r=this.closestPeers(t,1);if(r.length>0)return r[0]}closestPeers(t,r=this.kBucketSize){return this.kb==null?[]:[...this.kb.closest(t,r)]}async add(t){if(this.kb==null)throw new Error("RoutingTable is not started");const r=await ps(t);this.kb.add({kadId:r,peerId:t}),this.log("added %p with kad id %b",t,r),this.updateMetrics()}async remove(t){if(this.kb==null)throw new Error("RoutingTable is not started");const r=await ps(t);this.kb.remove(r),this.updateMetrics()}updateMetrics(){if(this.metrics==null||this.kb==null)return;let t=0,r=0,i=0;function s(o){if(L1(o)){o.depth>i&&(i=o.depth),r++,t+=o.peers.length;return}s(o.left),s(o.right)}s(this.kb.root),this.metrics.routingTableSize.update(t),this.metrics.routingTableKadBucketTotal.update(r),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(t/r)),this.metrics.routingTableKadBucketMaxDepth.update(i)}}const hJ=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],s1=15;class fJ{constructor(e,t){h(this,"log");h(this,"peerRouting");h(this,"routingTable");h(this,"refreshInterval");h(this,"refreshQueryTimeout");h(this,"commonPrefixLengthRefreshedAt");h(this,"refreshTimeoutId");const{peerRouting:r,routingTable:i,refreshInterval:s,refreshQueryTimeout:o,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=r,this.routingTable=i,this.refreshInterval=s??wX,this.refreshQueryTimeout=o??vX,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");const t=this._maxCommonPrefix(),r=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${r.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(r.map(async(i,s)=>{try{if(await this._refreshCommonPrefixLength(s,i,e),this._numPeersForCpl(t)===0){const o=Math.min(2*(s+1),r.length-1);for(let a=s+1;a<o+1;a++)try{await this._refreshCommonPrefixLength(a,i,e)}catch(l){this.log.error(l)}}}catch(o){this.log.error(o)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,r){if(!r&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const i=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);const s=AbortSignal.timeout(this.refreshQueryTimeout);ue(1/0,s);const o=await YC(this.peerRouting.getClosestPeers(i.toBytes(),{signal:s}));this.log(`found ${o} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>s1&&(e=s1);const t=[];for(let r=0;r<=e;r++)t[r]=this.commonPrefixLengthRefreshedAt[r]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");const t=Yi(2),r=(t[1]<<8)+t[0],i=await this._makePeerId(this.routingTable.kb.localPeer.kadId,r,e);return di(i)}async _makePeerId(e,t,r){if(r>s1)throw new Error(`Cannot generate peer ID for common prefix length greater than ${s1}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>r,a=65535<<16-(r+1),l=o&a|t&~a,c=hJ[l],u=new ArrayBuffer(34),d=new DataView(u,0,u.byteLength);return d.setUint8(0,nn.code),d.setUint8(1,32),d.setUint32(2,c,!1),new Uint8Array(d.buffer,d.byteOffset,d.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const r of this._prefixLengths())r===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb!=null)for(const{kadId:e}of this.routingTable.kb.toIterable()){const t=Qc(this.routingTable.kb.localPeer.kadId,e);let r=0;for(const i of t)if(i===0)r++;else break;yield r}}}class pJ{constructor(e,t){h(this,"providers");h(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.providers=t.providers}async handle(e,t){if(this.log("start"),t.key==null||t.key.length===0)throw new S("Missing key","ERR_MISSING_KEY");let r;try{r=nt.decode(t.key)}catch{throw new S("Invalid CID","ERR_INVALID_CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),await Promise.all(t.providers.map(async i=>{if(!e.equals(i.id)){this.log("invalid provider peer %p from %p",i.id,e);return}if(i.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log("received provider %p for %s (addrs %s)",e,r,i.multiaddrs.map(s=>xe(s).toString())),await this.providers.addProvider(r,di(i.id))}))}}class gJ{constructor(e,t){h(this,"peerRouting");h(this,"peerInfoMapper");h(this,"peerId");h(this,"addressManager");h(this,"log");const{peerRouting:r,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=r,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(this.log("incoming request from %p for peers closer to %b",e,t.key),t.key==null)throw new S("Invalid FIND_NODE message received - key was missing","ERR_INVALID_MESSAGE");const r=await this.peerRouting.getCloserPeersOffline(t.key,e);Pe(this.peerId.toBytes(),t.key)&&r.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(s=>s.decapsulateCode(Mt("p2p").code))});const i={type:et.FIND_NODE,clusterLevel:t.clusterLevel,closer:r.map(this.peerInfoMapper).filter(({multiaddrs:s})=>s.length).map(s=>({id:s.id.toBytes(),multiaddrs:s.multiaddrs.map(o=>o.bytes)})),providers:[]};return i.closer.length===0&&this.log("could not find any peers closer to %b than %p",t.key,e),i}}class yJ{constructor(e,t){h(this,"peerRouting");h(this,"providers");h(this,"peerStore");h(this,"peerInfoMapper");h(this,"log");const{peerRouting:r,providers:i,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:get-providers`),this.peerStore=e.peerStore,this.peerRouting=r,this.providers=i,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new S("Invalid GET_PROVIDERS message received - key was missing","ERR_INVALID_MESSAGE");let r;try{r=nt.decode(t.key)}catch{throw new S("Invalid CID","ERR_INVALID_CID")}this.log("%p asking for providers for %s",e,r);const[i,s]=await Promise.all([this.providers.getProviders(r),this.peerRouting.getCloserPeersOffline(t.key,e)]),o=await this._getPeers(i),a=await this._getPeers(s.map(({id:c})=>c)),l={type:et.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:a.map(this.peerInfoMapper).filter(({multiaddrs:c})=>c.length).map(c=>({id:c.id.toBytes(),multiaddrs:c.multiaddrs.map(u=>u.bytes)})),providers:o.map(this.peerInfoMapper).filter(({multiaddrs:c})=>c.length).map(c=>({id:c.id.toBytes(),multiaddrs:c.multiaddrs.map(u=>u.bytes)}))};return this.log("got %s providers %s closerPeers",l.providers.length,l.closer.length),l}async _getAddresses(e){return[]}async _getPeers(e){const t=[];for(const r of e)try{const i=await this.peerStore.get(r),s=this.peerInfoMapper({id:r,multiaddrs:i.addresses.map(({multiaddr:o})=>o)});s.multiaddrs.length>0&&t.push(s)}catch(i){if(i.code!=="ERR_NOT_FOUND")throw i}return t}}class mJ{constructor(e,t){h(this,"peerStore");h(this,"datastore");h(this,"peerRouting");h(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const r=t.key;if(this.log("%p asked for key %b",e,r),r==null||r.length===0)throw new S("Invalid key","ERR_INVALID_KEY");const i={type:et.GET_VALUE,key:r,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(NX(r)){this.log("is public key");const a=DX(r);let l;try{const c=await this.peerStore.get(a);if(c.id.publicKey==null)throw new S("No public key found in key book","ERR_NOT_FOUND");l=c.id.publicKey}catch(c){if(c.code!=="ERR_NOT_FOUND")throw c}if(l!=null)return this.log("returning found public key"),i.record=new Or(r,l,new Date).serialize(),i}const[s,o]=await Promise.all([this._checkLocalDatastore(r),this.peerRouting.getCloserPeersOffline(r,e)]);return s!=null&&(this.log("had record for %b in local datastore",r),i.record=s.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),i.closer=o.map(a=>({id:a.id.toBytes(),multiaddrs:a.multiaddrs.map(l=>l.bytes)}))),i}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=Ld(e);let r;try{r=await this.datastore.get(t)}catch(s){if(s.code==="ERR_NOT_FOUND")return;throw s}const i=Or.deserialize(r);if(i==null)throw new S("Invalid record","ERR_INVALID_RECORD");if(i.timeReceived==null||Date.now()-i.timeReceived.getTime()>cX){await this.datastore.delete(t);return}return i}}class wJ{constructor(e,t){h(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class vJ{constructor(e,t){h(this,"components");h(this,"validators");h(this,"log");const{validators:r}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.validators=r}async handle(e,t){const r=t.key;if(this.log("%p asked us to store value for key %b",e,r),t.record==null){const i=`Empty record from: ${e.toString()}`;throw this.log.error(i),new S(i,"ERR_EMPTY_RECORD")}try{const i=Or.deserialize(t.record);await B5(this.validators,i),i.timeReceived=new Date;const s=Ld(i.key);await this.components.datastore.put(s,i.serialize().subarray()),this.log("put record for %b into datastore under key %k",r,s)}catch(i){this.log("did not put record for key %b into datastore %o",r,i)}return t}}class EJ{constructor(e,t){h(this,"handlers");h(this,"routingTable");h(this,"log");const{providers:r,peerRouting:i,validators:s,logPrefix:o,peerInfoMapper:a}=t;this.log=e.logger.forComponent(`${o}:rpc`),this.routingTable=t.routingTable,this.handlers={[et.GET_VALUE.toString()]:new mJ(e,{peerRouting:i,logPrefix:o}),[et.PUT_VALUE.toString()]:new vJ(e,{validators:s,logPrefix:o}),[et.FIND_NODE.toString()]:new gJ(e,{peerRouting:i,logPrefix:o,peerInfoMapper:a}),[et.ADD_PROVIDER.toString()]:new pJ(e,{providers:r,logPrefix:o}),[et.GET_PROVIDERS.toString()]:new yJ(e,{peerRouting:i,providers:r,logPrefix:o,peerInfoMapper:a}),[et.PING.toString()]:new wJ(e,{logPrefix:o})}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(i){this.log.error("Failed to update the kbucket store",i)}const r=this.handlers[t.type];if(r==null){this.log.error(`no handler found for message type: ${t.type}`);return}return r.handle(e,t)}onIncomingStream(e){Promise.resolve().then(async()=>{const{stream:t,connection:r}=e,i=r.remotePeer;try{await this.routingTable.add(i)}catch(o){this.log.error(o)}const s=this;await En(t,o=>Do(o),async function*(o){for await(const a of o){const l=xs.decode(a);s.log("incoming %s from %p",l.type,i);const c=await s.handleMessage(i,l);c!=null&&(yield xs.encode(c))}},o=>No(o),t)}).catch(t=>{this.log.error(t)})}}class bJ extends tn{constructor(t,r){super();h(this,"log");h(this,"components");h(this,"protocol");h(this,"running");h(this,"registrarId");const{protocol:i,logPrefix:s}=r;this.components=t,this.log=t.logger.forComponent(`${s}:topology-listener`),this.running=!1,this.protocol=i}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:t=>{this.log("observed peer %p with protocol %s",t,this.protocol),this.dispatchEvent(new ui("peer",{detail:t}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class _J{constructor(e){h(this,"dht");this.dht=e}async provide(e,t={}){await Fa(this.dht.provide(e,t))}async*findProviders(e,t={}){for await(const r of this.dht.findProviders(e,t))r.name==="PROVIDER"&&(yield*r.providers)}async put(e,t,r){await Fa(this.dht.put(e,t,r))}async get(e,t){for await(const r of this.dht.get(e,t))if(r.name==="VALUE")return r.value;throw new S("Not found","ERR_NOT_FOUND")}}class SJ{constructor(e){h(this,"dht");this.dht=e}async findPeer(e,t={}){for await(const r of this.dht.findPeer(e,t))if(r.name==="FINAL_PEER")return r.peer;throw new S("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){for await(const r of this.dht.getClosestPeers(e,t))r.name==="FINAL_PEER"&&(yield r.peer)}}const xJ=32,kJ=64;var BE,ME,$E;class RJ extends tn{constructor(t,r={}){super();h(this,"protocol");h(this,"routingTable");h(this,"providers");h(this,"network");h(this,"peerRouting");h(this,"components");h(this,"log");h(this,"running");h(this,"kBucketSize");h(this,"clientMode");h(this,"validators");h(this,"selectors");h(this,"queryManager");h(this,"contentFetching");h(this,"contentRouting");h(this,"routingTableRefresh");h(this,"rpc");h(this,"topologyListener");h(this,"querySelf");h(this,"maxInboundStreams");h(this,"maxOutboundStreams");h(this,"dhtContentRouting");h(this,"dhtPeerRouting");h(this,"peerInfoMapper");h(this,$E,"@libp2p/kad-dht");h(this,ME,["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery"]);h(this,BE,["@libp2p/identify"]);const{kBucketSize:i,clientMode:s,validators:o,selectors:a,querySelfInterval:l,protocol:c,logPrefix:u,pingTimeout:d,pingConcurrency:f,maxInboundStreams:p,maxOutboundStreams:y,providers:g}=r,w=u??"libp2p:kad-dht";this.running=!1,this.components=t,this.log=t.logger.forComponent(w),this.protocol=c??uX,this.kBucketSize=i??20,this.clientMode=s??!0,this.maxInboundStreams=p??xJ,this.maxOutboundStreams=y??kJ,this.peerInfoMapper=r.peerInfoMapper??CX,this.routingTable=new dJ(t,{kBucketSize:i,pingTimeout:d,pingConcurrency:f,protocol:this.protocol,logPrefix:w}),this.providers=new YX(t,g??{}),this.validators={...AX,...o},this.selectors={...kX,...a},this.network=new qX(t,{protocol:this.protocol,logPrefix:w});const m=Se();r.allowQueryWithZeroPeers===!0&&m.resolve(),this.queryManager=new ZX(t,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:w,initialQuerySelfHasRun:m,routingTable:this.routingTable}),this.peerRouting=new jX(t,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:w}),this.contentFetching=new zX(t,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:w}),this.contentRouting=new HX(t,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:w}),this.routingTableRefresh=new fJ(t,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:w}),this.rpc=new EJ(t,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:w,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new bJ(t,{protocol:this.protocol,logPrefix:w}),this.querySelf=new rJ(t,{peerRouting:this.peerRouting,interval:l,initialInterval:r.initialQuerySelfInterval,logPrefix:w,initialQuerySelfHasRun:m,routingTable:this.routingTable}),this.network.addEventListener("peer",E=>{const v=E.detail;this.onPeerConnect(v).catch(b=>{this.log.error("could not add %p to routing table",v.id,b)}),this.dispatchEvent(new ui("peer",{detail:v}))}),this.topologyListener.addEventListener("peer",E=>{const v=E.detail;Promise.resolve().then(async()=>{const b=await this.components.peerStore.get(v),k={id:v,multiaddrs:b.addresses.map(({multiaddr:A})=>A),protocols:b.protocols};await this.onPeerConnect(k)}).catch(b=>{this.log.error("could not add %p to routing table",v,b)})}),this.dhtPeerRouting=new SJ(this),this.dhtContentRouting=new _J(this),r.clientMode==null&&t.events.addEventListener("self:peer:update",E=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const v=E.detail.peer.addresses.some(({multiaddr:k})=>FX(k)),b=this.getMode();v&&b==="client"?await this.setMode("server"):b==="server"&&!v&&await this.setMode("client")}).catch(v=>{this.log.error("error setting dht server mode",v)})})}get[($E=Symbol.toStringTag,ME=Dn,BE=Dc,Cc)](){return this.dhtContentRouting}get[Tc](){return this.dhtPeerRouting}get[A0](){return this}async onPeerConnect(t){if(this.log("peer %p connected",t.id),t=this.peerInfoMapper(t),t.multiaddrs.length===0){this.log("ignoring %p as there were no valid addresses in %s after filtering",t.id,t.multiaddrs.map(r=>r.toString()));return}try{await this.routingTable.add(t.id)}catch(r){this.log.error("could not add %p to routing table",t.id,r)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(t){await this.components.registrar.unhandle(this.protocol),t==="client"?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await gu(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.topologyListener,this.routingTableRefresh)}async stop(){this.running=!1,await yu(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener)}async*put(t,r,i={}){yield*this.contentFetching.put(t,r,i)}async*get(t,r={}){yield*this.contentFetching.get(t,r)}async*provide(t,r={}){yield*this.contentRouting.provide(t,this.components.addressManager.getAddresses(),r)}async*findProviders(t,r={}){yield*this.contentRouting.findProviders(t,r)}async*findPeer(t,r={}){yield*this.peerRouting.findPeer(t,r)}async*getClosestPeers(t,r={}){yield*this.peerRouting.getClosestPeers(t,r)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}}var J9;(function(n){n[n.SEND_QUERY=0]="SEND_QUERY",n[n.PEER_RESPONSE=1]="PEER_RESPONSE",n[n.FINAL_PEER=2]="FINAL_PEER",n[n.QUERY_ERROR=3]="QUERY_ERROR",n[n.PROVIDER=4]="PROVIDER",n[n.VALUE=5]="VALUE",n[n.ADD_PEER=6]="ADD_PEER",n[n.DIAL_PEER=7]="DIAL_PEER"})(J9||(J9={}));function AJ(n={}){return e=>new RJ(e,n)}var IJ=n=>{if(Object.prototype.toString.call(n)!=="[object Object]")return!1;const e=Object.getPrototypeOf(n);return e===null||e===Object.prototype};const d2=IJ,{hasOwnProperty:QC}=Object.prototype,{propertyIsEnumerable:CJ}=Object,iu=(n,e,t)=>Object.defineProperty(n,e,{value:t,writable:!0,enumerable:!0,configurable:!0}),TJ=Aa,Z9={concatArrays:!1,ignoreUndefined:!1},Bp=n=>{const e=[];for(const t in n)QC.call(n,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(n);for(const r of t)CJ.call(n,r)&&e.push(r)}return e};function Iu(n){return Array.isArray(n)?NJ(n):d2(n)?DJ(n):n}function NJ(n){const e=n.slice(0,0);return Bp(n).forEach(t=>{iu(e,t,Iu(n[t]))}),e}function DJ(n){const e=Object.getPrototypeOf(n)===null?Object.create(null):{};return Bp(n).forEach(t=>{iu(e,t,Iu(n[t]))}),e}const XC=(n,e,t,r)=>(t.forEach(i=>{typeof e[i]>"u"&&r.ignoreUndefined||(i in n&&n[i]!==Object.getPrototypeOf(n)?iu(n,i,by(n[i],e[i],r)):iu(n,i,Iu(e[i])))}),n),PJ=(n,e,t)=>{let r=n.slice(0,0),i=0;return[n,e].forEach(s=>{const o=[];for(let a=0;a<s.length;a++)QC.call(s,a)&&(o.push(String(a)),s===n?iu(r,i++,s[a]):iu(r,i++,Iu(s[a])));r=XC(r,s,Bp(s).filter(a=>!o.includes(a)),t)}),r};function by(n,e,t){return t.concatArrays&&Array.isArray(n)&&Array.isArray(e)?PJ(n,e,t):!d2(e)||!d2(n)?Iu(e):XC(n,e,Bp(e),t)}var OJ=function(...n){const e=by(Iu(Z9),this!==TJ&&this||{},Z9);let t={_:{}};for(const r of n)if(r!==void 0){if(!d2(r))throw new TypeError("`"+r+"` is not an Option Object");t=by(t,{_:r},e)}return t._};const M5=ci(OJ);function LJ(n){return n>=55296&&n<=56319}function BJ(n){return n>=56320&&n<=57343}var MJ=function(e,t,r){if(typeof t!="string")throw new Error("Input must be string");for(var i=t.length,s=0,o,a,l=0;l<i;l+=1){if(o=t.charCodeAt(l),a=t[l],LJ(o)&&BJ(t.charCodeAt(l+1))&&(l+=1,a+=t[l]),s+=e(a),s===r)return t.slice(0,l+1);if(s>r)return t.slice(0,l-a.length+1)}return t};function $J(n){return n>=55296&&n<=56319}function UJ(n){return n>=56320&&n<=57343}var FJ=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,r=0,i=null,s=null,o=0;o<t;o++)i=e.charCodeAt(o),UJ(i)?s!=null&&$J(s)?r+=1:r+=3:i<=127?r+=1:i>=128&&i<=2047?r+=2:i>=2048&&i<=65535&&(r+=3),s=i;return r},zJ=MJ,VJ=FJ,HJ=zJ.bind(null,VJ),KJ=HJ,WJ=/[\/\?<>\\:\*\|"]/g,GJ=/[\x00-\x1f\x80-\x9f]/g,qJ=/^\.+$/,jJ=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,YJ=/[\. ]+$/;function ev(n,e){if(typeof n!="string")throw new Error("Input must be string");var t=n.replace(WJ,e).replace(GJ,e).replace(qJ,e).replace(jJ,e).replace(YJ,e);return KJ(t,255)}var QJ=function(n,e){var t=e&&e.replacement||"",r=ev(n,t);return t===""?r:ev(r,"")};const XJ=ci(QJ);var Be;(function(n){n.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",n.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",n.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",n.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",n.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",n.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",n.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",n.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",n.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",n.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",n.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",n.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",n.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",n.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",n.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH"})(Be||(Be={}));const JJ="/pkcs8/",JC="/info/",Zo=new WeakMap,ea={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},d3={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function ts(n){return n==null||typeof n!="string"?!1:n===XJ(n.trim())&&n.length>0}async function Qe(){const t=Math.random()*800+200;await new Promise(r=>setTimeout(r,t))}function vi(n){return new ot(JJ+n)}function Qs(n){return new ot(JC+n)}var UE,FE;FE=Symbol.toStringTag,UE=Dn;class ZJ{constructor(e,t){h(this,"components");h(this,"init");h(this,"log");h(this,FE,"@libp2p/keychain");h(this,UE,["@libp2p/keychain"]);var i,s,o,a,l,c,u,d,f,p;if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=M5(d3,t),this.init.pass!=null&&((i=this.init.pass)==null?void 0:i.length)<20)throw new Error("pass must be least 20 characters");if(((s=this.init.dek)==null?void 0:s.keyLength)!=null&&this.init.dek.keyLength<ea.minKeyLength)throw new Error(`dek.keyLength must be least ${ea.minKeyLength} bytes`);if(((a=(o=this.init.dek)==null?void 0:o.salt)==null?void 0:a.length)!=null&&this.init.dek.salt.length<ea.minSaltLength)throw new Error(`dek.saltLength must be least ${ea.minSaltLength} bytes`);if(((l=this.init.dek)==null?void 0:l.iterationCount)!=null&&this.init.dek.iterationCount<ea.minIterationCount)throw new Error(`dek.iterationCount must be least ${ea.minIterationCount}`);const r=this.init.pass!=null&&((c=this.init.dek)==null?void 0:c.salt)!=null?Nw(this.init.pass,(u=this.init.dek)==null?void 0:u.salt,(d=this.init.dek)==null?void 0:d.iterationCount,(f=this.init.dek)==null?void 0:f.keyLength,(p=this.init.dek)==null?void 0:p.hash):"";Zo.set(this,{dek:r})}static generateOptions(){const e=Object.assign({},d3),t=Math.ceil(ea.minSaltLength/3)*3;return e.dek.salt=ne(Yi(t),"base64"),e}static get options(){return d3}async createKey(e,t,r=2048){if(!ts(e)||e==="self")throw await Qe(),new S("Invalid key name",Be.ERR_INVALID_KEY_NAME);if(typeof t!="string")throw await Qe(),new S("Invalid key type",Be.ERR_INVALID_KEY_TYPE);const i=vi(e);if(await this.components.datastore.has(i))throw await Qe(),new S("Key name already exists",Be.ERR_KEY_ALREADY_EXISTS);switch(t.toLowerCase()){case"rsa":if(!Number.isSafeInteger(r)||r<2048)throw await Qe(),new S("Invalid RSA key size",Be.ERR_INVALID_KEY_SIZE);break}let o;try{const a=await mA(t,r),l=await a.id(),c=Zo.get(this);if(c==null)throw new S("dek missing",Be.ERR_INVALID_PARAMETERS);const u=c.dek,d=await a.export(u);o={name:e,id:l};const f=this.components.datastore.batch();f.put(i,Y(d)),f.put(Qs(e),Y(JSON.stringify(o))),await f.commit()}catch(a){throw await Qe(),a}return o}async listKeys(){const e={prefix:JC},t=[];for await(const r of this.components.datastore.query(e))t.push(JSON.parse(ne(r.value)));return t}async findKeyById(e){try{const r=(await this.listKeys()).find(i=>i.id===e);if(r==null)throw new S(`Key with id '${e}' does not exist.`,Be.ERR_KEY_NOT_FOUND);return r}catch(t){throw await Qe(),t}}async findKeyByName(e){if(!ts(e))throw await Qe(),new S(`Invalid key name '${e}'`,Be.ERR_INVALID_KEY_NAME);const t=Qs(e);try{const r=await this.components.datastore.get(t);return JSON.parse(ne(r))}catch(r){throw await Qe(),this.log.error(r),new S(`Key '${e}' does not exist.`,Be.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!ts(e)||e==="self")throw await Qe(),new S(`Invalid key name '${e}'`,Be.ERR_INVALID_KEY_NAME);const t=vi(e),r=await this.findKeyByName(e),i=this.components.datastore.batch();return i.delete(t),i.delete(Qs(e)),await i.commit(),r}async renameKey(e,t){if(!ts(e)||e==="self")throw await Qe(),new S(`Invalid old key name '${e}'`,Be.ERR_OLD_KEY_NAME_INVALID);if(!ts(t)||t==="self")throw await Qe(),new S(`Invalid new key name '${t}'`,Be.ERR_NEW_KEY_NAME_INVALID);const r=vi(e),i=vi(t),s=Qs(e),o=Qs(t);if(await this.components.datastore.has(i))throw await Qe(),new S(`Key '${t}' already exists`,Be.ERR_KEY_ALREADY_EXISTS);try{const l=await this.components.datastore.get(r),c=await this.components.datastore.get(s),u=JSON.parse(ne(c));u.name=t;const d=this.components.datastore.batch();return d.put(i,l),d.put(o,Y(JSON.stringify(u))),d.delete(r),d.delete(s),await d.commit(),u}catch(l){throw await Qe(),l}}async exportKey(e,t){if(!ts(e))throw await Qe(),new S(`Invalid key name '${e}'`,Be.ERR_INVALID_KEY_NAME);if(t==null)throw await Qe(),new S("Password is required",Be.ERR_PASSWORD_REQUIRED);const r=vi(e);try{const i=await this.components.datastore.get(r),s=ne(i),o=Zo.get(this);if(o==null)throw new S("dek missing",Be.ERR_INVALID_PARAMETERS);const a=o.dek;return await(await qf(s,a)).export(t)}catch(i){throw await Qe(),i}}async exportPeerId(e){const t="temporary-password",r=await this.exportKey(e,t),i=await qf(r,t);return qi(i.public.bytes,i.bytes)}async importKey(e,t,r){if(!ts(e)||e==="self")throw await Qe(),new S(`Invalid key name '${e}'`,Be.ERR_INVALID_KEY_NAME);if(t==null)throw await Qe(),new S("PEM encoded key is required",Be.ERR_PEM_REQUIRED);const i=vi(e);if(await this.components.datastore.has(i))throw await Qe(),new S(`Key '${e}' already exists`,Be.ERR_KEY_ALREADY_EXISTS);let o;try{o=await qf(t,r)}catch{throw await Qe(),new S("Cannot read the key, most likely the password is wrong",Be.ERR_CANNOT_READ_KEY)}let a;try{a=await o.id();const u=Zo.get(this);if(u==null)throw new S("dek missing",Be.ERR_INVALID_PARAMETERS);const d=u.dek;t=await o.export(d)}catch(u){throw await Qe(),u}const l={name:e,id:a},c=this.components.datastore.batch();return c.put(i,Y(t)),c.put(Qs(e),Y(JSON.stringify(l))),await c.commit(),l}async importPeer(e,t){try{if(!ts(e))throw new S(`Invalid key name '${e}'`,Be.ERR_INVALID_KEY_NAME);if(t==null)throw new S("PeerId is required",Be.ERR_MISSING_PRIVATE_KEY);if(t.privateKey==null)throw new S("PeerId.privKey is required",Be.ERR_MISSING_PRIVATE_KEY);const r=await zc(t.privateKey),i=vi(e);if(await this.components.datastore.has(i))throw await Qe(),new S(`Key '${e}' already exists`,Be.ERR_KEY_ALREADY_EXISTS);const o=Zo.get(this);if(o==null)throw new S("dek missing",Be.ERR_INVALID_PARAMETERS);const a=o.dek,l=await r.export(a),c={name:e,id:t.toString()},u=this.components.datastore.batch();return u.put(i,Y(l)),u.put(Qs(e),Y(JSON.stringify(c))),await u.commit(),c}catch(r){throw await Qe(),r}}async getPrivateKey(e){if(!ts(e))throw await Qe(),new S(`Invalid key name '${e}'`,Be.ERR_INVALID_KEY_NAME);try{const t=vi(e),r=await this.components.datastore.get(t);return ne(r)}catch(t){throw await Qe(),this.log.error(t),new S(`Key '${e}' does not exist.`,Be.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){var a,l,c,u;if(typeof e!="string")throw await Qe(),new S(`Invalid old pass type '${typeof e}'`,Be.ERR_INVALID_OLD_PASS_TYPE);if(typeof t!="string")throw await Qe(),new S(`Invalid new pass type '${typeof t}'`,Be.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await Qe(),new S(`Invalid pass length ${t.length}`,Be.ERR_INVALID_PASS_LENGTH);this.log("recreating keychain");const r=Zo.get(this);if(r==null)throw new S("dek missing",Be.ERR_INVALID_PARAMETERS);const i=r.dek;this.init.pass=t;const s=t!=null&&((a=this.init.dek)==null?void 0:a.salt)!=null?Nw(t,this.init.dek.salt,(l=this.init.dek)==null?void 0:l.iterationCount,(c=this.init.dek)==null?void 0:c.keyLength,(u=this.init.dek)==null?void 0:u.hash):"";Zo.set(this,{dek:s});const o=await this.listKeys();for(const d of o){const f=await this.components.datastore.get(vi(d.name)),p=ne(f),y=await qf(p,i),g=s.toString(),w=await y.export(g),m=this.components.datastore.batch(),E={name:d.name,id:d.id};m.put(vi(d.name),Y(w)),m.put(Qs(d.name),Y(JSON.stringify(E))),await m.commit()}this.log("keychain reconstructed")}}function ZC(n={}){return e=>new ZJ(e,n)}class eT{constructor(e={}){h(this,"memoryStorage");h(this,"points");h(this,"duration");h(this,"blockDuration");h(this,"execEvenly");h(this,"execEvenlyMinDelayMs");h(this,"keyPrefix");this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new eZ}async consume(e,t=1,r={}){const i=this.getKey(e),s=this._getKeySecDuration(r);let o=this.memoryStorage.incrby(i,t,s);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(i,o.consumedPoints,this.blockDuration)),new S("Rate limit exceeded","ERR_RATE_LIMIT_EXCEEDED",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await UC(a)}return o}penalty(e,t=1,r={}){const i=this.getKey(e),s=this._getKeySecDuration(r),o=this.memoryStorage.incrby(i,t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,r={}){const i=this.getKey(e),s=this._getKeySecDuration(r),o=this.memoryStorage.incrby(i,-t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const r=t*1e3,i=this.points+1;return this.memoryStorage.set(this.getKey(e),i,t),{remainingPoints:0,msBeforeNext:r===0?-1:r,consumedPoints:i,isFirstInDuration:!1}}set(e,t,r=0){const i=(r>=0?r:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,r),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return(e==null?void 0:e.customDuration)!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class eZ{constructor(){h(this,"storage");this.storage=new Map}incrby(e,t,r){const i=this.storage.get(e);if(i!=null){const s=i.expiresAt!=null?i.expiresAt.getTime()-new Date().getTime():-1;return i.expiresAt==null||s>0?(i.value+=t,{remainingPoints:0,msBeforeNext:s,consumedPoints:i.value,isFirstInDuration:!1}):this.set(e,t,r)}return this.set(e,t,r)}set(e,t,r){const i=r*1e3,s=this.storage.get(e);s!=null&&clearTimeout(s.timeoutId);const o={value:t,expiresAt:i>0?new Date(Date.now()+i):void 0};return this.storage.set(e,o),i>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},i),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}var Ue;(function(n){n[n.NEW_STREAM=0]="NEW_STREAM",n[n.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",n[n.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",n[n.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",n[n.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",n[n.RESET_RECEIVER=5]="RESET_RECEIVER",n[n.RESET_INITIATOR=6]="RESET_INITIATOR"})(Ue||(Ue={}));const $5=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),tv=Object.freeze({NEW_STREAM:Ue.NEW_STREAM,MESSAGE:Ue.MESSAGE_INITIATOR,CLOSE:Ue.CLOSE_INITIATOR,RESET:Ue.RESET_INITIATOR}),tZ=Object.freeze({MESSAGE:Ue.MESSAGE_RECEIVER,CLOSE:Ue.CLOSE_RECEIVER,RESET:Ue.RESET_RECEIVER}),tT=1<<20,nZ=4<<20;let rZ=class{constructor(e=tT,t=nZ){h(this,"_buffer");h(this,"_headerInfo");h(this,"_maxMessageSize");h(this,"_maxUnprocessedMessageQueueSize");this._buffer=new Fe,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(c){if(c.code==="ERR_MSG_TOO_BIG")throw c;break}const{id:r,type:i,length:s,offset:o}=this._headerInfo;if(this._buffer.length-o<s)break;const l={id:r,type:i};(i===Ue.NEW_STREAM||i===Ue.MESSAGE_INITIATOR||i===Ue.MESSAGE_RECEIVER)&&(l.data=this._buffer.sublist(o,o+s)),t.push(l),this._buffer.consume(o+s),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:r}=rv(e),{value:i,offset:s}=rv(e,r),o=t&7;if($5[o]==null)throw new Error(`Invalid type received: ${o}`);if(i>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:o,offset:r+s,length:i}}};const iZ=128,nv=127;function rv(n,e=0){let t=0,r=0,i=e,s;const o=n.length;do{if(i>=o||r>49)throw e=0,new RangeError("Could not decode varint");s=n.get(i++),t+=r<28?(s&nv)<<r:(s&nv)*Math.pow(2,r),r+=7}while(s>=iZ);return e=i-e,{value:t,offset:e}}const h3=10*1024;let sZ=class{constructor(){h(this,"_pool");h(this,"_poolOffset");this._pool=dr(h3),this._poolOffset=0}write(e,t){const r=this._pool;let i=this._poolOffset;ii(e.id<<3|e.type,r,i),i+=ht(e.id<<3|e.type),(e.type===Ue.NEW_STREAM||e.type===Ue.MESSAGE_INITIATOR||e.type===Ue.MESSAGE_RECEIVER)&&e.data!=null?(ii(e.data.length,r,i),i+=ht(e.data.length)):(ii(0,r,i),i+=ht(0));const s=r.subarray(this._poolOffset,i);h3-i<100?(this._pool=dr(h3),this._poolOffset=0):this._poolOffset=i,t.append(s),(e.type===Ue.NEW_STREAM||e.type===Ue.MESSAGE_INITIATOR||e.type===Ue.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}};const oZ=new sZ;async function*aZ(n){for await(const e of n){const t=new Fe;oZ.write(e,t),yield t}}class lZ extends Dp{constructor(t){super(t);h(this,"name");h(this,"streamId");h(this,"send");h(this,"types");h(this,"maxDataSize");this.types=t.direction==="outbound"?tv:tZ,this.send=t.send,this.name=t.name,this.streamId=t.streamId,this.maxDataSize=t.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:tv.NEW_STREAM,data:new Fe(Y(this.name))})}async sendData(t){for(t=t.sublist();t.byteLength>0;){const r=Math.min(t.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:t.sublist(0,r)}),t.consume(r)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}}function cZ(n){const{id:e,name:t,send:r,onEnd:i,type:s="initiator",maxMsgSize:o=tT}=n;return new lZ({id:s==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:s==="initiator"?"outbound":"inbound",maxDataSize:o,onEnd:i,send:r,log:n.logger.forComponent(`libp2p:mplex:stream:${s}:${e}`)})}const uZ=1024,dZ=1024,hZ=1024*1024*4,fZ=5,pZ=500;function iv(n){const e={...n,type:`${$5[n.type]} (${n.type})`};return n.type===Ue.NEW_STREAM&&(e.data=ne(n.data instanceof Uint8Array?n.data:n.data.subarray())),(n.type===Ue.MESSAGE_INITIATOR||n.type===Ue.MESSAGE_RECEIVER)&&(e.data=ne(n.data instanceof Uint8Array?n.data:n.data.subarray(),"base16")),e}class gZ{constructor(e,t){h(this,"protocol","/mplex/6.7.0");h(this,"sink");h(this,"source");h(this,"log");h(this,"_streamId");h(this,"_streams");h(this,"_init");h(this,"_source");h(this,"closeController");h(this,"rateLimiter");h(this,"closeTimeout");h(this,"logger");t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??pZ,this.sink=this._createSink(),this._source=Ko({objectMode:!0,onEnd:()=>{for(const r of this._streams.initiators.values())r.destroy();for(const r of this._streams.receivers.values())r.destroy()}}),this.source=En(this._source,r=>aZ(r)),this.closeController=new AbortController,this.rateLimiter=new eT({points:t.disconnectThreshold??fZ,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const r=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:r})}async close(e){if(this.closeController.signal.aborted)return;const t=(e==null?void 0:e.signal)??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async r=>r.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(r){this.abort(r)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){const{id:t,name:r}=e,i=this._streams.receivers;return this._newStream({id:t,name:r,type:"receiver",registry:i})}_newStream(e){const{id:t,name:r,type:i,registry:s}=e;if(this.log("new %s stream %s",i,t),i==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??dZ))throw new S("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(s.has(t))throw new Error(`${i} stream ${t} already exists!`);const l=cZ({id:t,name:r,send:async c=>{this.log.enabled&&this.log.trace("%s stream %s send",i,t,iv(c)),this._source.push(c)},type:i,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",i,t,l.protocol),s.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(l)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return s.set(t,l),l}_createSink(){return async t=>{const r=()=>{AC(t,this.log)};this.closeController.signal.addEventListener("abort",r);try{const i=new rZ(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const s of t)for(const o of i.write(s))await this._handleIncoming(o);this._source.end()}catch(i){this.log("error in sink",i),this._source.end(i)}finally{this.closeController.signal.removeEventListener("abort",r)}}}async _handleIncoming(e){const{id:t,type:r}=e;if(this.log.enabled&&this.log.trace("incoming message",iv(e)),e.type===Ue.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??uZ)){this.log("too many inbound streams open"),this._source.push({id:t,type:Ue.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:ne(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const s=((r&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(s==null){this.log("missing stream %s for message type %s",t,$5[r]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}const o=this._init.maxStreamBufferSize??hZ;try{switch(r){case Ue.MESSAGE_INITIATOR:case Ue.MESSAGE_RECEIVER:if(s.sourceReadableLength()>o)throw this._source.push({id:e.id,type:r===Ue.MESSAGE_INITIATOR?Ue.RESET_RECEIVER:Ue.RESET_INITIATOR}),new S("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");s.sourcePush(e.data);break;case Ue.CLOSE_INITIATOR:case Ue.CLOSE_RECEIVER:s.remoteCloseWrite();break;case Ue.RESET_INITIATOR:case Ue.RESET_RECEIVER:s.reset();break;default:this.log("unknown message type %s",r)}}catch(a){this.log.error("error while processing message",a),s.abort(a)}}}var zE,VE;VE=Symbol.toStringTag,zE=Dn;class yZ{constructor(e,t={}){h(this,"protocol","/mplex/6.7.0");h(this,"_init");h(this,"components");h(this,VE,"@libp2p/mplex");h(this,zE,["@libp2p/stream-multiplexing"]);this.components=e,this._init=t}createStreamMuxer(e={}){return new gZ(this.components,{...e,...this._init})}}function mZ(n={}){return e=>new yZ(e,n)}const sv=32,wZ="1.0.0",vZ="ping",EZ="ipfs",bZ=1e4,_Z=2,SZ=1,ov="ERR_WRONG_PING_ACK";var HE;HE=Symbol.toStringTag;class xZ{constructor(e,t={}){h(this,"protocol");h(this,"components");h(this,"started");h(this,"timeout");h(this,"maxInboundStreams");h(this,"maxOutboundStreams");h(this,"runOnTransientConnection");h(this,"log");h(this,HE,"@libp2p/ping");this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??EZ}/${vZ}/${wZ}`,this.timeout=t.timeout??bZ,this.maxInboundStreams=t.maxInboundStreams??_Z,this.maxOutboundStreams=t.maxOutboundStreams??SZ,this.runOnTransientConnection=t.runOnTransientConnection??!0,this.handleMessage=this.handleMessage.bind(this)}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);const{stream:t}=e,r=Date.now();AbortSignal.timeout(this.timeout).addEventListener("abort",()=>{t==null||t.abort(new S("ping timeout",Nc))}),En(t,async function*(s){let o=0;for await(const a of s){if(o+=a.byteLength,o>sv){t==null||t.abort(new S("Too much data received",sa));return}yield a}},t).catch(s=>{this.log.error("incoming ping from %p failed with error",e.connection.remotePeer,s),t==null||t.abort(s)}).finally(()=>{const s=Date.now()-r;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,s)})}async ping(e,t={}){var l,c;this.log("pinging %p",e);const r=Date.now(),i=Yi(sv),s=await this.components.connectionManager.openConnection(e,t);let o,a=()=>{};if(t.signal==null){const u=AbortSignal.timeout(this.timeout);t={...t,signal:u}}try{o=await s.newStream(this.protocol,{...t,runOnTransientConnection:this.runOnTransientConnection}),a=()=>{o==null||o.abort(new S("ping timeout",Nc))},(l=t.signal)==null||l.addEventListener("abort",a,{once:!0});const u=await En([i],o,async f=>qc(f)),d=Date.now()-r;if(u==null)throw new S(`Did not receive a ping ack after ${d}ms`,ov);if(!Pe(i,u.subarray()))throw new S(`Received wrong ping ack after ${d}ms`,ov);return this.log("ping %p complete in %dms",s.remotePeer,d),d}catch(u){throw this.log.error("error while pinging %p",s.remotePeer,u),o==null||o.abort(u),u}finally{(c=t.signal)==null||c.removeEventListener("abort",a),o!=null&&await o.close()}}}function kZ(n={}){return e=>new xZ(e,n)}var Dr;(function(n){n.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",n.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",n.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",n.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",n.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",n.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",n.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",n.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",n.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",n.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"})(Dr||(Dr={}));class Cu extends S{constructor(e,t){super(`WebRTC transport error: ${e}`,t??""),this.name="WebRTCTransportError"}}class RZ extends Cu{constructor(e,t){super(`[stream: ${e}] data channel error: ${t}`,Dr.ERR_DATA_CHANNEL),this.name="WebRTC/DataChannelError"}}function av(n,e){return new RZ(n,e)}class AZ extends Cu{constructor(e){super(`There was a problem with the Multiaddr which was passed in: ${e}`,Dr.ERR_INVALID_MULTIADDR),this.name="WebRTC/InappropriateMultiaddrError"}}function nT(n){return new AZ(n)}class IZ extends Cu{constructor(e){super(`There was a problem with a provided argument: ${e}`,Dr.ERR_INVALID_PARAMETERS),this.name="WebRTC/InvalidArgumentError"}}function _y(n){return new IZ(n)}class CZ extends Cu{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`,Dr.ERR_INVALID_FINGERPRINT),this.name="WebRTC/InvalidFingerprintError"}}function rT(n,e){return new CZ(n,e)}class TZ extends Cu{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`,Dr.ERR_NOT_IMPLEMENTED),this.name="WebRTC/UnimplementedError"}}function NZ(n){return new TZ(n)}class DZ extends Cu{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `,Dr.ERR_HASH_NOT_SUPPORTED),this.name="WebRTC/UnsupportedHashAlgorithmError"}}function PZ(n){return new DZ(n)}var lv=function(n,e,t){if(t||arguments.length===2)for(var r=0,i=e.length,s;r<i;r++)(s||!(r in e))&&(s||(s=Array.prototype.slice.call(e,0,r)),s[r]=e[r]);return n.concat(s||Array.prototype.slice.call(e))},OZ=function(){function n(e,t,r){this.name=e,this.version=t,this.os=r,this.type="browser"}return n}(),LZ=function(){function n(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return n}(),BZ=function(){function n(e,t,r,i){this.name=e,this.version=t,this.os=r,this.bot=i,this.type="bot-device"}return n}(),MZ=function(){function n(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return n}(),$Z=function(){function n(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return n}(),UZ=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,FZ=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,cv=3,zZ=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",UZ]],uv=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function VZ(n){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new $Z:typeof navigator<"u"?KZ(navigator.userAgent):GZ()}function HZ(n){return n!==""&&zZ.reduce(function(e,t){var r=t[0],i=t[1];if(e)return e;var s=i.exec(n);return!!s&&[r,s]},!1)}function KZ(n){var e=HZ(n);if(!e)return null;var t=e[0],r=e[1];if(t==="searchbot")return new MZ;var i=r[1]&&r[1].split(".").join("_").split("_").slice(0,3);i?i.length<cv&&(i=lv(lv([],i,!0),qZ(cv-i.length),!0)):i=[];var s=i.join("."),o=WZ(n),a=FZ.exec(n);return a&&a[1]?new BZ(t,s,o,a[1]):new OZ(t,s,o)}function WZ(n){for(var e=0,t=uv.length;e<t;e++){var r=uv[e],i=r[0],s=r[1],o=s.exec(n);if(o)return i}return null}function GZ(){var n=typeof process<"u"&&process.version;return n?new LZ(process.version.slice(1)):null}function qZ(n){for(var e=[],t=0;t<n;t++)e.push("0");return e}const jZ=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],dv=VZ(),U5=dv!=null&&dv.name==="firefox",iT=async function*(){},sT=async n=>{},YZ=30*1e3;function QZ(n,e,t=YZ,r){n.readyState==="open"&&Promise.resolve().then(async()=>{if(n.bufferedAmount>0){r.log("%s drain channel with %d buffered bytes",e,n.bufferedAmount);const i=Se();let s=!1;n.bufferedAmountLowThreshold=0;const o=()=>{s||(r.log("%s drain channel closed before drain",e),i.resolve())};n.addEventListener("close",o,{once:!0}),n.addEventListener("bufferedamountlow",()=>{s=!0,n.removeEventListener("close",o),i.resolve()}),await vp(i.promise,{milliseconds:t})}}).then(async()=>{n.readyState==="open"&&n.close()}).catch(i=>{r.log.error("error closing outbound stream",i)})}async function Sy(n){return n=n??{},typeof n=="function"&&(n=await n()),n.iceServers=n.iceServers??jZ.map(e=>({urls:[e]})),n}class xy{constructor(e,t){h(this,"log");h(this,"peerConnection");h(this,"remoteAddr");h(this,"timeline");h(this,"metrics");h(this,"source",iT());h(this,"sink",sT);this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const r=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",this.peerConnection.connectionState,"initial state",r),(this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed"||this.peerConnection.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){var t;this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),(t=this.metrics)==null||t.increment({close:!0})}abort(e){var t;this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),(t=this.metrics)==null||t.increment({abort:!0})}}var Un;(function(n){(function(r){r.FIN="FIN",r.STOP_SENDING="STOP_SENDING",r.RESET="RESET",r.FIN_ACK="FIN_ACK"})(n.Flag||(n.Flag={}));let e;(function(r){r[r.FIN=0]="FIN",r[r.STOP_SENDING=1]="STOP_SENDING",r[r.RESET=2]="RESET",r[r.FIN_ACK=3]="FIN_ACK"})(e||(e={})),function(r){r.codec=()=>Pn(e)}(n.Flag||(n.Flag={}));let t;n.codec=()=>(t==null&&(t=Ae((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.flag!=null&&(i.uint32(8),n.Flag.codec().encode(r.flag,i)),r.message!=null&&(i.uint32(18),i.bytes(r.message)),s.lengthDelimited!==!1&&i.ldelim()},(r,i)=>{const s={},o=i==null?r.len:r.pos+i;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:s.flag=n.Flag.codec().decode(r);break;case 2:s.message=r.bytes();break;default:r.skipType(a&7);break}}return s})),t),n.encode=r=>Re(r,n.codec()),n.decode=r=>ke(r,n.codec())})(Un||(Un={}));const XZ=2*1024*1024,JZ=30*1e3,F5=16*1024;function ZZ(n=F5){const e=ht(n-ht(n)),t=1+ht(Object.keys(Un.Flag).length-1),r=1,i=n-e-t-r,s=ht(i);return e+t+r+s}const eee=ZZ(),tee=5e3,nee=5e3;class ree extends Dp{constructor(t){const r=t.onEnd;t.onEnd=s=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await vp(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(o){this.log.error("error receiving FIN_ACK",o)}}).then(()=>{this.incomingData.end(),r==null||r(s)}).catch(o=>{this.log.error("error ending stream",o)})};super(t);h(this,"channel");h(this,"incomingData");h(this,"maxBufferedAmount");h(this,"bufferedAmountLowEventTimeout");h(this,"maxMessageSize");h(this,"receiveFinAck");h(this,"finAckTimeout");h(this,"openTimeout");switch(this.channel=t.channel,this.channel.binaryType="arraybuffer",this.incomingData=Ko(),this.bufferedAmountLowEventTimeout=t.bufferedAmountLowEventTimeout??JZ,this.maxBufferedAmount=t.maxBufferedAmount??XZ,this.maxMessageSize=(t.maxMessageSize??F5)-eee,this.receiveFinAck=Se(),this.finAckTimeout=t.closeTimeout??tee,this.openTimeout=t.openTimeout??nee,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new S("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=s=>{this.timeline.open=new Date().getTime()},this.channel.onclose=s=>{this.receiveFinAck.resolve(),this.close().catch(o=>{this.log.error("error closing stream after channel closed",o)})},this.channel.onerror=s=>{const o=s.error;this.abort(o)},this.channel.onmessage=async s=>{const{data:o}=s;o===null||o.byteLength===0||this.incomingData.push(new Uint8Array(o,0,o.byteLength))};const i=this;Promise.resolve().then(async()=>{for await(const s of Do(this.incomingData)){const o=i.processIncomingProtobuf(s);o!=null&&i.sourcePush(new Fe(o))}}).catch(s=>{this.log.error("error processing incoming data channel messages",s)})}sendNewStream(){}async _sendMessage(t,r=!0){if(r&&this.channel.bufferedAmount>this.maxBufferedAmount)try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await Ey(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(i){throw i instanceof a5?new S(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`,"ERR_BUFFER_CLEAR_TIMEOUT"):i}if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new S(`Invalid datachannel state - ${this.channel.readyState}`,"ERR_INVALID_STATE");this.channel.readyState!=="open"&&(this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await Ey(this.channel,"open",{timeout:this.openTimeout}),this.log('channel state is now "%s", sending data',this.channel.readyState)),this.channel.send(t.subarray())}async sendData(t){for(t=t.sublist();t.byteLength>0;){const r=Math.min(t.byteLength,this.maxMessageSize),i=t.subarray(0,r),s=Un.encode({message:i}),o=No.single(s);await this._sendMessage(o),t.consume(r)}}async sendReset(){await this._sendFlag(Un.Flag.RESET)}async sendCloseWrite(t){if(await this._sendFlag(Un.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await Pt(this.receiveFinAck.promise,t==null?void 0:t.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(i){this.log.error("failed to await FIN_ACK",i)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(Un.Flag.STOP_SENDING)}processIncomingProtobuf(t){const r=Un.decode(t);if(r.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',r.flag,this.writeStatus,this.readStatus),r.flag===Un.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(Un.Flag.FIN_ACK).catch(i=>{this.log.error("error sending FIN_ACK immediately",i)})),r.flag===Un.Flag.RESET&&this.reset(),r.flag===Un.Flag.STOP_SENDING&&this.remoteCloseRead(),r.flag===Un.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return r.message}async _sendFlag(t){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',this.channel.readyState,t.toString()),!1;this.log.trace("sending flag %s",t.toString());const r=Un.encode({flag:t}),i=No.single(r);try{return await this._sendMessage(i,!1),!0}catch(s){this.log.error("could not send flag %s",t.toString(),s)}return!1}}function h2(n){const{channel:e,direction:t}=n;return new ree({id:t==="inbound"?`i${e.id}`:`r${e.id}`,log:n.logger.forComponent(`libp2p:webrtc:stream:${t}:${e.id}`),...n})}const oT="/webrtc";class z5{constructor(e,t){h(this,"protocol");h(this,"peerConnection");h(this,"bufferedStreams",[]);h(this,"metrics");h(this,"dataChannelOptions");h(this,"components");h(this,"log");this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??oT,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:datachannelmuxerfactory"),this.peerConnection.ondatachannel=({channel:r})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',r.id),r.label==="init"){this.log.trace("closing early init channel"),r.close();return}const i={},s=h2({channel:r,direction:"inbound",onEnd:o=>{i.onEnd(o)},logger:e.logger,...this.dataChannelOptions});i.stream=s,i.channel=r,i.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(o=>o.stream.id!==s.id)},this.bufferedStreams.push(i)}}createStreamMuxer(e){return new iee(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}var gc,M1;class iee{constructor(e,t){le(this,gc);h(this,"init");h(this,"streams");h(this,"protocol");h(this,"log");h(this,"peerConnection");h(this,"dataChannelOptions");h(this,"metrics");h(this,"logger");h(this,"source",iT());h(this,"sink",sT);this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(r=>r.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??oT,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:r})=>{var s,o;if(this.log.trace("incoming datachannel with channel id %d",r.id),r.label==="init"){this.log.trace("closing init channel"),r.close();return}const i=h2({channel:r,direction:"inbound",onEnd:()=>{this.log("incoming channel %s ended with state %s",r.id,r.readyState),Q(this,gc,M1).call(this,i,r)},logger:this.logger,...this.dataChannelOptions});this.streams.push(i),(s=this.metrics)==null||s.increment({incoming_stream:!0}),(o=t==null?void 0:t.onIncomingStream)==null||o.call(t,i)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(r=>{var i,s,o;r.onEnd=()=>{this.log("incoming early channel %s ended with state %s",r.channel.id,r.channel.readyState),Q(this,gc,M1).call(this,r.stream,r.channel)},(i=this.metrics)==null||i.increment({incoming_stream:!0}),(o=(s=this.init)==null?void 0:s.onIncomingStream)==null||o.call(s,r.stream)})})}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}newStream(){var r;const e=this.peerConnection.createDataChannel("");this.log.trace("opened outgoing datachannel with channel id %s",e.id);const t=h2({channel:e,direction:"outbound",onEnd:()=>{this.log("outgoing channel %s ended with state %s",e.id,e.readyState),Q(this,gc,M1).call(this,t,e)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(t),(r=this.metrics)==null||r.increment({outgoing_stream:!0}),t}}gc=new WeakSet,M1=function(e,t){var r,i,s;this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),QZ(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(o=>o.id!==e.id),(r=this.metrics)==null||r.increment({stream_end:!0}),(s=(i=this.init)==null?void 0:i.onStreamEnd)==null||s.call(i,e)};const f2=globalThis.RTCPeerConnection,aT=globalThis.RTCSessionDescription,see=globalThis.RTCIceCandidate;var ti;(function(n){(function(r){r.SDP_OFFER="SDP_OFFER",r.SDP_ANSWER="SDP_ANSWER",r.ICE_CANDIDATE="ICE_CANDIDATE"})(n.Type||(n.Type={}));let e;(function(r){r[r.SDP_OFFER=0]="SDP_OFFER",r[r.SDP_ANSWER=1]="SDP_ANSWER",r[r.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(e||(e={})),function(r){r.codec=()=>Pn(e)}(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=Ae((r,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),r.type!=null&&(i.uint32(8),n.Type.codec().encode(r.type,i)),r.data!=null&&(i.uint32(18),i.string(r.data)),s.lengthDelimited!==!1&&i.ldelim()},(r,i)=>{const s={},o=i==null?r.len:r.pos+i;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:s.type=n.Type.codec().decode(r);break;case 2:s.data=r.string();break;default:r.skipType(a&7);break}}return s})),t),n.encode=r=>Re(r,n.codec()),n.decode=r=>ke(r,n.codec())})(ti||(ti={}));const lT=async(n,e,t)=>{var r,i,s,o;try{const a=Se();for(aee(n,a);;){const l=await Promise.race([a.promise,e.read({signal:t.signal}).catch(()=>{})]);if(l==null){(r=t.signal)==null||r.throwIfAborted();break}if(l.type!==ti.Type.ICE_CANDIDATE)throw new S("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");const c=JSON.parse(l.data??"null");if(c===""||c===null){(i=t.onProgress)==null||i.call(t,new se("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}const u=new see(c);t.log.trace("%s received new ICE candidate %o",t.direction,c);try{(s=t.onProgress)==null||s.call(t,new se("webrtc:add-ice-candidate",u.candidate)),await n.addIceCandidate(u)}catch(d){t.log.error("%s bad candidate received",t.direction,c,d)}}}catch(a){if(t.log.error("%s error parsing ICE candidate",t.direction,a),((o=t.signal)==null?void 0:o.aborted)===!0)throw a}};function oee(n){return U5?n.iceConnectionState:n.connectionState}function aee(n,e){n[U5?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(oee(n)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new S("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"));break}}}async function lee({rtcConfiguration:n,dataChannel:e,signal:t,metrics:r,multiaddr:i,connectionManager:s,transportManager:o,log:a,logger:l,onProgress:c}){const{baseAddr:u}=gee(i);r==null||r.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",u);const d=u.getPeerId();if(d==null)throw new S("Relay peer was missing","ERR_INVALID_ADDRESS");const f=s.getConnections(xt(d));let p,y=!1;f.length===0?(c==null||c(new se("webrtc:dial-relay")),p=await o.dial(u,{signal:t,onProgress:c}),y=!0):(c==null||c(new se("webrtc:reuse-relay-connection")),p=f[0]);try{c==null||c(new se("webrtc:open-signaling-stream"));const g=await p.newStream(ky,{signal:t,runOnTransientConnection:!0}),w=Yn(g).pb(ti),m=new f2(n),E=new z5({logger:l},{peerConnection:m,dataChannelOptions:e});try{const v=m.createDataChannel("init");m.onicecandidate=({candidate:T})=>{const P=JSON.stringify((T==null?void 0:T.toJSON())??null);a.trace("initiator sending ICE candidate %o",T),w.write({type:ti.Type.ICE_CANDIDATE,data:P},{signal:t}).catch(_=>{a.error("error sending ICE candidate",_)})},m.onicecandidateerror=T=>{a.error("initiator ICE candidate error",T)};const b=await m.createOffer().catch(T=>{throw a.error("could not execute createOffer",T),new S("Failed to set createOffer","ERR_SDP_HANDSHAKE_FAILED")});a.trace("initiator send SDP offer %s",b.sdp),c==null||c(new se("webrtc:send-sdp-offer")),await w.write({type:ti.Type.SDP_OFFER,data:b.sdp},{signal:t}),await m.setLocalDescription(b).catch(T=>{throw a.error("could not execute setLocalDescription",T),new S("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),c==null||c(new se("webrtc:read-sdp-answer"));const k=await w.read({signal:t});if(k.type!==ti.Type.SDP_ANSWER)throw new S("Remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");a.trace("initiator receive SDP answer %s",k.data);const A=new aT({type:"answer",sdp:k.data});return await m.setRemoteDescription(A).catch(T=>{throw a.error("could not execute setRemoteDescription",T),new S("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}),a.trace("initiator read candidates until connected"),c==null||c(new se("webrtc:read-ice-candidates")),await lT(m,w,{direction:"initiator",signal:t,log:a,onProgress:c}),a.trace("initiator connected, closing init channel"),v.close(),c==null||c(new se("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await g.close({signal:t}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i,peerConnection:m,muxerFactory:E}}catch(v){throw a.error("outgoing signaling error",v),m.close(),g.abort(v),v}finally{m.onicecandidate=null,m.onicecandidateerror=null}}finally{if(y)try{await p.close({signal:t})}catch(g){p.abort(g)}}}class cee extends tn{constructor(t,r){super();h(this,"peerId");h(this,"transportManager");h(this,"shutdownController");this.peerId=t.peerId,this.transportManager=t.transportManager,this.shutdownController=r.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter(t=>t!==this).map(t=>t.getAddrs().filter(r=>fs.matches(r)).map(r=>r.encapsulate(`/webrtc/p2p/${this.peerId}`))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}}async function uee({peerConnection:n,stream:e,signal:t,connection:r,log:i}){i.trace("new inbound signaling stream");const s=Yn(e).pb(ti);try{n.onicecandidate=({candidate:u})=>{const d=JSON.stringify((u==null?void 0:u.toJSON())??null);i.trace("recipient sending ICE candidate %s",d),s.write({type:ti.Type.ICE_CANDIDATE,data:d},{signal:t}).catch(f=>{i.error("error sending ICE candidate",f)})};const a=await s.read({signal:t});if(a.type!==ti.Type.SDP_OFFER)throw new S(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `,"ERR_SDP_HANDSHAKE_FAILED");i.trace("recipient receive SDP offer %s",a.data);const l=new aT({type:"offer",sdp:a.data});await n.setRemoteDescription(l).catch(u=>{throw i.error("could not execute setRemoteDescription",u),new S("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")});const c=await n.createAnswer().catch(u=>{throw i.error("could not execute createAnswer",u),new S("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")});i.trace("recipient send SDP answer %s",c.sdp),await s.write({type:ti.Type.SDP_ANSWER,data:c.sdp},{signal:t}),await n.setLocalDescription(c).catch(u=>{throw i.error("could not execute setLocalDescription",u),new S("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),i.trace("recipient read candidates until connected"),await lT(n,s,{direction:"recipient",signal:t,log:i})}catch(a){if(n.connectionState!=="connected")throw i.error("error while handling signaling stream from peer %a",r.remoteAddr,a),n.close(),a;i("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",r.remoteAddr,a)}const o=xe(`/webrtc/p2p/${r.remoteAddr.getPeerId()}`);return i.trace("recipient connected to remote address %s",o),{remoteAddress:o}}const dee="/webrtc",hee="/p2p-circuit",ky="/webrtc-signaling/0.0.1",fee=30*1e3;var KE,WE,GE,qE;qE=Kh,GE=Symbol.toStringTag,WE=Dn,KE=Dc;class pee{constructor(e,t={}){h(this,"components");h(this,"init");h(this,"log");h(this,"_started",!1);h(this,"metrics");h(this,"shutdownController");h(this,qE,!0);h(this,GE,"@libp2p/webrtc");h(this,WE,["@libp2p/transport"]);h(this,KE,["@libp2p/identify","@libp2p/circuit-relay-v2-transport"]);this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,ue(1/0,this.shutdownController.signal),e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle(ky,e=>{this._onProtocol(e).catch(t=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)})},{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(ky),this._started=!1}createListener(e){return new cee(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(wG.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){var l;this.log.trace("dialing address: %a",e);const{remoteAddress:r,peerConnection:i,muxerFactory:s}=await lee({rtcConfiguration:await Sy(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),o=new xy(this.components,{peerConnection:i,timeline:{open:Date.now()},remoteAddr:r,metrics:(l=this.metrics)==null?void 0:l.dialerEvents}),a=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:s,onProgress:t.onProgress});return this._closeOnShutdown(i,o),a}async _onProtocol({connection:e,stream:t}){var o;const r=AbortSignal.timeout(this.init.inboundConnectionTimeout??fee),i=new f2(await Sy(this.init.rtcConfiguration)),s=new z5(this.components,{peerConnection:i,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:a}=await uee({peerConnection:i,connection:e,stream:t,signal:r,log:this.log});await t.close({signal:r});const l=new xy(this.components,{peerConnection:i,timeline:{open:new Date().getTime()},remoteAddr:a,metrics:(o=this.metrics)==null?void 0:o.listenerEvents});await this.components.upgrader.upgradeInbound(l,{skipEncryption:!0,skipProtection:!0,muxerFactory:s}),this._closeOnShutdown(i,l)}catch(a){throw this.log.error("incoming signaling error",a),i.close(),t.abort(a),a}}_closeOnShutdown(e,t){const r=()=>{t.close().catch(i=>{this.log.error("could not close WebRTCMultiaddrConnection",i)})};this.shutdownController.signal.addEventListener("abort",r),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",r)})}}function gee(n){const e=n.toString().split(dee+"/");if(e.length!==2)throw new S("webrtc protocol was not present in multiaddr",Dr.ERR_INVALID_MULTIADDR);if(!e[0].includes(hee))throw new S("p2p-circuit protocol was not present in multiaddr",Dr.ERR_INVALID_MULTIADDR);let t=xe(e[0]);const i=xe("/"+e[1]).getPeerId();if(i==null)throw new S("destination peer id was missing",Dr.ERR_INVALID_MULTIADDR);const s=t.protos().pop();if(s===void 0)throw new S("invalid multiaddr",Dr.ERR_INVALID_MULTIADDR);return s.name!=="p2p"&&(t=t.encapsulate(`/p2p/${i}`)),{baseAddr:t,peerId:xt(i)}}const cT=Object.values(za).map(n=>n.decoder).reduce((n,e)=>n.or(e));function yee(n,e){var i;const t=(i=n.getConfiguration().certificates)==null?void 0:i.at(0);if((t==null?void 0:t.getFingerprints)==null){e.log.trace("fetching fingerprint from local SDP");const s=n.localDescription;return s==null?void 0:wee(s.sdp)}if(e.log.trace("fetching fingerprint from local certificate"),t.getFingerprints().length===0)return;const r=t.getFingerprints()[0].value;if(r==null)throw rT("","no fingerprint on local certificate");return r}const mee=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function wee(n){var t;const e=n.match(mee);return(t=e==null?void 0:e.groups)==null?void 0:t.fingerprint}function vee(n){for(const e of n.protoNames())if(e.startsWith("ip"))return e.toUpperCase();return"IP6"}function Ry(n){const t=n.stringTuples().filter(r=>r[0]===Ree).map(r=>r[1])[0];if(t===void 0||t==="")throw nT(`Couldn't find a certhash component of multiaddr: ${n.toString()}`);return t}function uT(n){return vu(cT.decode(n))}function Eee(n){const e=uT(Ry(n)),t=dT(e.code),r=e.digest.reduce((s,o)=>s+o.toString(16).padStart(2,"0"),""),i=r.match(/.{1,2}/g);if(i==null)throw rT(r,n.toString());return[`${t} ${i.join(":").toUpperCase()}`,r]}function dT(n){switch(n){case 17:return"SHA-1";case 18:return"SHA-256";case 19:return"SHA-512";default:throw PZ(n)}}function bee(n,e){const{host:t,port:r}=n.toOptions(),i=vee(n),[s]=Eee(n);return`v=0
o=- 0 0 IN ${i} ${t}
s=-
c=IN ${i} ${t}
t=0 0
a=ice-lite
m=application ${r} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:passive
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${s}
a=sctp-port:5000
a=max-message-size:${F5}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${r} typ host\r
`}function _ee(n,e){return{type:"answer",sdp:bee(n,e)}}function See(n,e){if(n.sdp===void 0)throw _y("Can't munge a missing SDP");return n.sdp=n.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+`
`).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+`
`),n}const hv=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),xee=n=>[...Array(n)].map(()=>hv.at(Math.floor(Math.random()*hv.length))).join(""),kee=1e4;Mt("webrtc-direct").code;const Ree=Mt("certhash").code;var jE,YE,QE;QE=Kh,YE=Symbol.toStringTag,jE=Dn;class Aee{constructor(e,t={}){h(this,"log");h(this,"metrics");h(this,"components");h(this,"init");h(this,QE,!0);h(this,YE,"@libp2p/webrtc-direct");h(this,jE,["@libp2p/transport"]);this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}async dial(e,t){const r=await this._connect(e,t);return this.log("dialing address: %a",e),r}createListener(e){throw NZ("WebRTCTransport.createListener")}listenFilter(e){return e.filter(gG.exactMatch)}dialFilter(e){return this.listenFilter(e)}async _connect(e,t){var u,d,f;const r=new AbortController,i=r.signal,s=e.getPeerId();if(s===null)throw nT("we need to have the remote's PeerId");const o=xt(s),a=uT(Ry(e)),l=await f2.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:dT(a.code)}),c=new f2({...await Sy(this.init.rtcConfiguration),certificates:[l]});try{const p=new Promise((V,z)=>{const R=c.createDataChannel("",{negotiated:!0,id:0}),C=setTimeout(()=>{var M;const x=`Data channel was never opened: state: ${R.readyState}`;this.log.error(x),(M=this.metrics)==null||M.dialerEvents.increment({open_error:!0}),z(av("data",x))},kee);R.onopen=x=>{clearTimeout(C),V(R)},R.onerror=x=>{var L,O;clearTimeout(C);const K=`Error opening a data channel for handshaking: ${((L=x.target)==null?void 0:L.toString())??"not specified"}`;this.log.error(K),(O=this.metrics)==null||O.dialerEvents.increment({unknown_error:!0}),z(av("data",K))}}),y="libp2p+webrtc+v1/"+xee(32),g=await c.createOffer(),w=See(g,y);await c.setLocalDescription(w);const m=_ee(e,y);await c.setRemoteDescription(m);const E=await p,v=this.components.peerId,b=this.generateNoisePrologue(c,a.code,e),k=N5({prologueBytes:b})(this.components),A=h2({channel:E,direction:"inbound",logger:this.components.logger,...this.init.dataChannel??{}}),T={...A,sink:A.sink.bind(A),source:async function*(){for await(const V of A.source)for(const z of V)yield z}()},P=new xy(this.components,{peerConnection:c,remoteAddr:e,timeline:{open:Date.now()},metrics:(u=this.metrics)==null?void 0:u.dialerEvents}),_=U5?"iceconnectionstatechange":"connectionstatechange";c.addEventListener(_,()=>{switch(c.connectionState){case"failed":case"disconnected":case"closed":P.close().catch(V=>{this.log.error("error closing connection",V)}).finally(()=>{r.abort()});break;default:break}},{signal:i}),(d=this.metrics)==null||d.dialerEvents.increment({peer_connection:!0});const N=new z5(this.components,{peerConnection:c,metrics:(f=this.metrics)==null?void 0:f.dialerEvents,dataChannelOptions:this.init.dataChannel});return await k.secureInbound(v,T,o),await t.upgrader.upgradeOutbound(P,{skipProtection:!0,skipEncryption:!0,muxerFactory:N})}catch(p){throw c.close(),p}}generateNoisePrologue(e,t,r){var u;if(((u=e.getConfiguration().certificates)==null?void 0:u.length)===0)throw _y("no local certificate");const i=yee(e,{log:this.log});if(i==null)throw _y("no local fingerprint found");const s=i.trim().toLowerCase().replaceAll(":",""),o=Y(s,"hex"),a=Lc(t,o),l=cT.decode(Ry(r)),c=Y("libp2p-webrtc-noise:");return vn([c,a.bytes,l])}}function Iee(n){return e=>new Aee(e,n)}function Cee(n){return e=>new pee(e,n)}const Tee=async n=>{if(n.readyState>=2)throw new Error("socket closed");n.readyState!==1&&await new Promise((e,t)=>{function r(){n.removeEventListener("open",i),n.removeEventListener("error",s)}function i(){r(),e()}function s(o){r(),t(o.error??new Error(`connect ECONNREFUSED ${n.url}`))}n.addEventListener("open",i),n.addEventListener("error",s)})},Nee=(n,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async r=>{for await(const i of r){try{await Tee(n)}catch(s){if(s.message==="socket closed")break;throw s}if(n.readyState===n.CLOSING||n.readyState===n.CLOSED)break;n.send(i)}e.closeOnEnd!=null&&n.readyState<=1&&await new Promise((i,s)=>{n.addEventListener("close",o=>{if(o.wasClean||o.code===1006)i();else{const a=Object.assign(new Error("ws error"),{event:o});s(a)}}),setTimeout(()=>{n.close()})})});var Mp={},$p={};Object.defineProperty($p,"__esModule",{value:!0});class Dee{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const r=this.pullQueue.shift();r&&r.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{const t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((r,i)=>{this.pullQueue.push({resolve:r,reject:i})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}let hT=class{constructor(e,{highWaterMark:t=100,lowWaterMark:r=1}={}){const i=new Dee;i.highWaterMark=t,i.lowWaterMark=r,i.removeCallback=e({push:s=>i.push(s),stop:()=>i.stop(),fail:s=>i.fail(s),on:(s,o)=>{i.eventHandlers[s]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>i[Symbol.asyncIterator](),Object.freeze(this)}};$p.EventIterator=hT;$p.default=hT;Object.defineProperty(Mp,"__esModule",{value:!0});const V5=$p;var Pee=Mp.EventIterator=V5.EventIterator;function Oee(n,e,t){return new V5.EventIterator(({push:r})=>(this.addEventListener(n,r,e),()=>this.removeEventListener(n,r,e)),t)}Mp.subscribe=Oee;Mp.default=V5.EventIterator;function fv(n){var e;return n instanceof ArrayBuffer||((e=n==null?void 0:n.constructor)==null?void 0:e.name)==="ArrayBuffer"&&typeof(n==null?void 0:n.byteLength)=="number"}const Lee=n=>{n.binaryType="arraybuffer";const e=async()=>{await new Promise((s,o)=>{if(r){s();return}if(i!=null){o(i);return}const a=u=>{n.removeEventListener("open",l),n.removeEventListener("error",c),u()},l=()=>{a(s)},c=u=>{a(()=>{o(u.error??new Error(`connect ECONNREFUSED ${n.url}`))})};n.addEventListener("open",l),n.addEventListener("error",c)})},t=async function*(){const s=new Pee(({push:o,stop:a,fail:l})=>{const c=d=>{let f=null;typeof d.data=="string"&&(f=Y(d.data)),fv(d.data)&&(f=new Uint8Array(d.data)),d.data instanceof Uint8Array&&(f=d.data),f!=null&&o(f)},u=d=>{l(d.error??new Error("Socket error"))};return n.addEventListener("message",c),n.addEventListener("error",u),n.addEventListener("close",a),()=>{n.removeEventListener("message",c),n.removeEventListener("error",u),n.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of s)yield fv(o)?new Uint8Array(o):o}();let r=n.readyState===1,i;return n.addEventListener("open",()=>{r=!0,i=null}),n.addEventListener("close",()=>{r=!1,i=null}),n.addEventListener("error",s=>{r||(i=s.error??new Error(`connect ECONNREFUSED ${n.url}`))}),Object.assign(t,{connected:e})},Bee=(n,e)=>{e=e??{};const t=Lee(n);let r=e.remoteAddress,i=e.remotePort;if(n.url!=null)try{const o=new URL(n.url);r=o.hostname,i=parseInt(o.port,10)}catch{}if(r==null||i==null)throw new Error("Remote connection did not have address and/or port");return{sink:Nee(n,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(n.readyState===n.CONNECTING||n.readyState===n.OPEN)&&await new Promise(o=>{n.addEventListener("close",()=>{o()}),n.close()})},destroy:()=>{n.terminate!=null?n.terminate():n.close()},remoteAddress:r,remotePort:i,socket:n}},Mee=WebSocket,$ee={"http:":"ws:","https:":"wss:"},pv="ws:",Uee=(n,e)=>{if(n.startsWith("//")&&(n=`${(e==null?void 0:e.protocol)??pv}${n}`),n.startsWith("/")&&e!=null){const r=e.protocol??pv,i=e.host,s=e.port!=null&&(i==null?void 0:i.endsWith(`:${e.port}`))!==!0?`:${e.port}`:"";n=`${r}//${i}${s}${n}`}const t=new URL(n);for(const[r,i]of Object.entries($ee))t.protocol===r&&(t.protocol=i);return t};function Fee(n,e){const t=typeof window>"u"?void 0:window.location;e=e??{};const r=Uee(n,t),i=new Mee(r.toString(),e.websocket);return Bee(i,e)}const fT=421,pT=290,zee=500;function Vee(n){return n.filter(e=>{if(e.protoCodes().includes(pT))return!1;const t=e.decapsulateCode(fT);return kh.matches(t)||Jc.matches(t)})}function Hee(n){return n.filter(e=>{if(e.protoCodes().includes(pT))return!1;const t=e.decapsulateCode(fT);return Jc.matches(t)})}function Kee(){throw new Error("WebSocket Servers can not be created in the browser!")}function Wee(n,e,t){const r=t.logger.forComponent("libp2p:websockets:maconn"),i=t.metrics,s=t.metricPrefix??"",o={log:r,async sink(a){try{await n.sink(async function*(){for await(const l of a)l instanceof Uint8Array?yield l:yield l.subarray()}())}catch(l){l.type!=="aborted"&&r.error(l)}},source:n.source,remoteAddr:e,timeline:{open:Date.now()},async close(a={}){var u,d;const l=Date.now();if(a.signal==null){const f=AbortSignal.timeout(zee);a={...a,signal:f}}const c=()=>{const{host:f,port:p}=o.remoteAddr.toOptions();r("timeout closing stream to %s:%s after %dms, destroying it manually",f,p,Date.now()-l),this.abort(new S("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};(u=a.signal)==null||u.addEventListener("abort",c);try{await n.close()}catch(f){r.error("error closing WebSocket gracefully",f),this.abort(f)}finally{(d=a.signal)==null||d.removeEventListener("abort",c),o.timeline.close=Date.now()}},abort(a){const{host:l,port:c}=o.remoteAddr.toOptions();r("timeout closing stream to %s:%s due to error",l,c,a),n.destroy(),o.timeline.close=Date.now(),i==null||i.increment({[`${s}error`]:!0})}};return n.socket.addEventListener("close",()=>{i==null||i.increment({[`${s}close`]:!0}),o.timeline.close==null&&(o.timeline.close=Date.now())},{once:!0}),o}var XE,JE,ZE;ZE=Kh,JE=Symbol.toStringTag,XE=Dn;class Gee{constructor(e,t){h(this,"log");h(this,"init");h(this,"logger");h(this,"metrics");h(this,"components");h(this,ZE,!0);h(this,JE,"@libp2p/websockets");h(this,XE,["@libp2p/transport"]);this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}async dial(e,t){var o;this.log("dialing %s",e),t=t??{};const r=await this._connect(e,t),i=Wee(r,e,{logger:this.logger,metrics:(o=this.metrics)==null?void 0:o.dialerEvents});this.log("new outbound connection %s",i.remoteAddr);const s=await t.upgrader.upgradeOutbound(i,t);return this.log("outbound connection %s upgraded",i.remoteAddr),s}async _connect(e,t){var o,a,l,c,u;(o=t==null?void 0:t.signal)==null||o.throwIfAborted();const r=e.toOptions();this.log("dialing %s:%s",r.host,r.port);const i=Se(),s=Fee(qI(e),this.init);s.socket.addEventListener("error",()=>{var f;const d=new S(`Could not connect to ${e.toString()}`,"ERR_CONNECTION_FAILED");this.log.error("connection error:",d),(f=this.metrics)==null||f.dialerEvents.increment({error:!0}),i.reject(d)});try{(a=t.onProgress)==null||a.call(t,new se("websockets:open-connection")),await Pt(Promise.race([s.connected(),i.promise]),t.signal)}catch(d){throw((l=t.signal)==null?void 0:l.aborted)===!0&&((c=this.metrics)==null||c.dialerEvents.increment({abort:!0})),s.close().catch(f=>{this.log.error("error closing raw socket",f)}),d}return this.log("connected %s",e),(u=this.metrics)==null||u.dialerEvents.increment({connect:!0}),s}createListener(e){return Kee({logger:this.logger,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){var t,r;return e=Array.isArray(e)?e:[e],((t=this.init)==null?void 0:t.filter)!=null?(r=this.init)==null?void 0:r.filter(e):FC||zC?Hee(e):Vee(e)}dialFilter(e){return this.listenFilter(e)}}function qee(n={}){return e=>new Gee(e,n)}function jee(n){throw new Error("Not implemented")}class Yee extends Dp{constructor(t){super(t);h(this,"writer");h(this,"reader");this.writer=t.bidiStream.writable.getWriter(),this.reader=t.bidiStream.readable.getReader(),Promise.resolve().then(async()=>{for(;;){const r=await this.reader.read();if(r.done){t.log("remote closed write");return}r.value!=null&&this.sourcePush(new Fe(r.value))}}).catch(r=>{t.log.error("error reading from stream",r),this.abort(r)}).finally(()=>{this.remoteCloseWrite()}),this.writer.closed.then(()=>{t.log("writer closed")}).catch(r=>{t.log("writer close promise rejected",r)}).finally(()=>{this.remoteCloseRead()})}sendNewStream(t){}async sendData(t,r){for await(const i of t)this.log("sendData waiting for writer to be ready"),await Pt(this.writer.ready,r==null?void 0:r.signal),this.writer.write(i).catch(s=>{this.log.error("error sending stream data",s)})}async sendReset(t){this.log("sendReset aborting writer"),await Pt(this.writer.abort(),t==null?void 0:t.signal),this.log("sendReset aborted writer")}async sendCloseWrite(t){this.log("sendCloseWrite closing writer"),await Pt(this.writer.close(),t==null?void 0:t.signal),this.log("sendCloseWrite closed writer")}async sendCloseRead(t){this.log("sendCloseRead cancelling reader"),await Pt(this.reader.cancel(),t==null?void 0:t.signal),this.log("sendCloseRead cancelled reader")}}async function gv(n,e,t,r,i,s){const o=s.forComponent(`libp2p:webtransport:stream:${t}:${e}`),a=new Yee({bidiStream:n,id:e,direction:t,log:o,onEnd:()=>{const l=r.findIndex(c=>c===a);l!==-1&&r.splice(l,1),i==null||i(a)}});return a}function gT(){return{source:{[Symbol.asyncIterator](){return{async next(){return new Promise(()=>{})}}}},sink:async n=>new Promise(()=>{})}}function Qee(n,e,t,r){let i=0;const s=t.forComponent("libp2p:webtransport:muxer");return{protocol:"webtransport",createStreamMuxer:o=>{typeof o=="function"&&(o={onIncomingStream:o});const a=[];Promise.resolve().then(async()=>{//! TODO unclear how to add backpressure here?
var c;for(;;){const{done:u,value:d}=await e.read();if(u)break;if(a.length>=r.maxInboundStreams)s(`too many inbound streams open - ${a.length}/${r.maxInboundStreams}, closing new incoming stream`),d.writable.close().catch(f=>{s.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${f.message}`)}),d.readable.cancel().catch(f=>{s.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${f.message}`)});else{const f=await gv(d,String(i++),"inbound",a,o==null?void 0:o.onStreamEnd,t);a.push(f),(c=o==null?void 0:o.onIncomingStream)==null||c.call(o,f)}}}).catch(c=>{s.error("could not create a new stream",c)});const l={protocol:"webtransport",streams:a,newStream:async c=>{s("new outgoing stream",c);const u=await n.createBidirectionalStream(),d=await gv(u,String(i++),(o==null?void 0:o.direction)??"outbound",a,o==null?void 0:o.onStreamEnd,t);return a.push(d),d},close:async()=>{s("closing webtransport muxer gracefully");try{n.close()}catch(c){l.abort(c)}},abort:c=>{s("closing webtransport muxer with err:",c);try{n.close()}catch(u){s.error("webtransport session threw error during close",u)}},...gT()};return l}}}function Xee(n,e){return e.filter(r=>!!n.find(i=>Pe(r,i))).length===e.length}const Jee=Object.values(za).map(n=>n.decoder).reduce((n,e)=>n.or(e));function Zee(n){return vu(Jee.decode(n))}function yv(n){if(!LI.matches(n))throw new S("Invalid multiaddr, was not a WebTransport address","ERR_INVALID_MULTIADDR");const e=n.stringTuples(),t=e.filter(([o,a])=>o===Mt("certhash").code).map(([o,a])=>Zee(a??"")),r=e.filter(([o,a])=>o===Mt("p2p").code).map(([o,a])=>xt(a??""))[0],i=n.toOptions();let s=i.host;return i.family===6&&(s!=null&&s.includes(":"))&&(s=`[${s}]`),{url:`https://${s}:${i.port}`,certhashes:t,remotePeer:r}}const ete=globalThis.WebTransport;var eb,tb,nb;nb=Symbol.toStringTag,tb=Kh,eb=Dn;class tte{constructor(e,t={}){h(this,"log");h(this,"components");h(this,"config");h(this,"metrics");h(this,nb,"@libp2p/webtransport");h(this,tb,!0);h(this,eb,["@libp2p/transport"]);this.log=e.logger.forComponent("libp2p:webtransport"),this.components=e,this.config={...t,maxInboundStreams:t.maxInboundStreams??1e3,certificates:t.certificates??[]},e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webtransport_dialer_events_total",{label:"event",help:"Total count of WebTransport dialer events by type"})})}async dial(e,t){var p,y,g,w,m,E,v;if(((p=t==null?void 0:t.signal)==null?void 0:p.aborted)===!0)throw new up;this.log("dialing %s",e);const r=this.components.peerId;if(r===void 0)throw new S("Need a local peerid","ERR_INVALID_PARAMETERS");t=t??{};const{url:i,certhashes:s,remotePeer:o}=yv(e);let a,l,c=()=>{},u=!1,d=!1,f=!1;try{(y=this.metrics)==null||y.dialerEvents.increment({pending:!0});const b=new ete(`${i}/.well-known/libp2p-webtransport?type=noise`,{serverCertificateHashes:s.map(k=>({algorithm:"sha-256",value:k.digest}))});if(c=k=>{var A;if(!u)try{(A=this.metrics)==null||A.dialerEvents.increment({[k]:!0}),b.close()}catch(T){this.log.error("error closing wt session",T)}finally{l!=null&&(l.timeline.close=Date.now()),u=!0}},a=()=>{c(d?"noise_timeout":"ready_timeout")},(g=t.signal)==null||g.addEventListener("abort",a,{once:!0}),this.log("wait for session to be ready"),(w=t.onProgress)==null||w.call(t,new se("webtransport:wait-for-session")),await Promise.race([b.closed,b.ready]),this.log("session became ready"),d=!0,(m=this.metrics)==null||m.dialerEvents.increment({ready:!0}),b.closed.catch(k=>{this.log.error("error on remote wt session close",k)}).finally(()=>{c("remote_close")}),f=await Pt(this.authenticateWebTransport({wt:b,localPeer:r,remotePeer:o,certhashes:s,...t}),t.signal),!f)throw new S("Failed to authenticate webtransport","ERR_AUTHENTICATION_FAILED");return(E=this.metrics)==null||E.dialerEvents.increment({open:!0}),l={close:async()=>{this.log("closing webtransport"),c("close")},abort:k=>{this.log("aborting webtransport due to passed err",k),c("abort")},remoteAddr:e,timeline:{open:Date.now()},log:this.components.logger.forComponent("libp2p:webtransport:maconn"),...gT()},await t.upgrader.upgradeOutbound(l,{skipEncryption:!0,muxerFactory:Qee(b,b.incomingBidirectionalStreams.getReader(),this.components.logger,this.config),skipProtection:!0,onProgress:t.onProgress})}catch(b){throw this.log.error("caught wt session err",b),c(f?"upgrade_error":d?"noise_error":"ready_error"),b}finally{a!=null&&((v=t.signal)==null||v.removeEventListener("abort",a))}}async authenticateWebTransport({wt:e,localPeer:t,remotePeer:r,certhashes:i,onProgress:s,signal:o}){o==null||o.throwIfAborted(),s==null||s(new se("webtransport:open-authentication-stream"));const a=await e.createBidirectionalStream(),l=a.writable.getWriter(),c=a.readable.getReader(),u={source:async function*(){for(;;){const p=await c.read();if(p.value!=null&&(yield p.value),p.done)break}}(),sink:async p=>{for await(const y of p){await Pt(l.ready,o);const g=y instanceof Uint8Array?y:y.subarray();l.write(g).catch(w=>{this.log.error("could not write chunk during authentication of WebTransport stream",w)})}}},d=N5()(this.components);s==null||s(new se("webtransport:secure-outbound-connection"));const{remoteExtensions:f}=await d.secureOutbound(t,u,r);if(s==null||s(new se("webtransport:close-authentication-stream")),l.close().catch(p=>{this.log.error(`Failed to close authentication stream writer: ${p.message}`)}),c.cancel().catch(p=>{this.log.error(`Failed to close authentication stream reader: ${p.message}`)}),!Xee((f==null?void 0:f.webtransportCerthashes)??[],i.map(p=>p.bytes)))throw new Error("Our certhashes are not a subset of the remote's reported certhashes");return!0}createListener(e){return jee(this.components,{...e,certificates:this.config.certificates,maxInboundStreams:this.config.maxInboundStreams})}listenFilter(){return[]}dialFilter(e){return globalThis.WebTransport==null?[]:e.filter(t=>{if(!LI.exactMatch(t))return!1;const{url:r,certhashes:i}=yv(t);return r!=null&&i.length>0})}}function nte(n={}){return e=>new tte(e,n)}function rte(n,e){const t=e.map((r,i)=>({record:of(r),index:i}));return t.sort((r,i)=>{const s=r.record.sequence,o=i.record.sequence;if(s>o)return-1;if(s<o)return 1;if(r.record.validityType===oi.ValidityType.EOL&&i.record.validityType===oi.ValidityType.EOL){const a=sy.fromString(r.record.validity).toDate(),l=sy.fromString(i.record.validity).toDate();if(a.getTime()>l.getTime())return-1;if(a.getTime()<l.getTime())return 1}return 0}),t[0].index}const yT="1.9.4",mT="libp2p",ite="4.2.6",ste="helia",ote={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function ate(n={}){const e=`${ste}/${ite} ${mT}/${yT} UserAgent=${globalThis.navigator.userAgent}`;return{peerId:n.peerId,dns:n.dns,addresses:{listen:["/webrtc"]},transports:[$Q({discoverRelays:1}),Cee(),Iee(),nte(),qee()],connectionEncryption:[N5()],streamMuxers:[jY(),mZ()],peerDiscovery:[yQ(ote)],services:{autoNAT:iQ(),dcutr:VQ(),delegatedRouting:()=>Zq("https://delegated-ipfs.dev"),dht:AJ({clientMode:!0,validators:{ipns:rC},selectors:{ipns:rte}}),identify:aX({agentVersion:e}),identifyPush:lX({agentVersion:e}),keychain:ZC(n.keychain),ping:kZ()}}}const lte=async()=>{const n=await mA("Ed25519"),e=await cte(n);if(e.type==="Ed25519")return e;throw new Error(`Generated unexpected PeerId type "${e.type}"`)};async function cte(n){return qi(wA(n.public),oV(n))}const tr={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};var p2;(function(n){(function(t){let r;t.codec=()=>(r==null&&(r=Ae((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&i.value.byteLength>0&&(s.uint32(18),s.bytes(i.value)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{const o={key:"",value:new Uint8Array(0)},a=s==null?i.len:i.pos+s;for(;i.pos<a;){const l=i.uint32();switch(l>>>3){case 1:o.key=i.string();break;case 2:o.value=i.bytes();break;default:i.skipType(l&7);break}}return o})),r),t.encode=i=>Re(i,t.codec()),t.decode=i=>ke(i,t.codec())})(n.Peer$metadataEntry||(n.Peer$metadataEntry={})),function(t){let r;t.codec=()=>(r==null&&(r=Ae((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&(s.uint32(18),y2.codec().encode(i.value,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{const o={key:""},a=s==null?i.len:i.pos+s;for(;i.pos<a;){const l=i.uint32();switch(l>>>3){case 1:o.key=i.string();break;case 2:o.value=y2.codec().decode(i,i.uint32());break;default:i.skipType(l&7);break}}return o})),r),t.encode=i=>Re(i,t.codec()),t.decode=i=>ke(i,t.codec())}(n.Peer$tagsEntry||(n.Peer$tagsEntry={}));let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{if(i.lengthDelimited!==!1&&r.fork(),t.addresses!=null)for(const s of t.addresses)r.uint32(10),g2.codec().encode(s,r);if(t.protocols!=null)for(const s of t.protocols)r.uint32(18),r.string(s);if(t.publicKey!=null&&(r.uint32(34),r.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(r.uint32(42),r.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[s,o]of t.metadata.entries())r.uint32(50),n.Peer$metadataEntry.codec().encode({key:s,value:o},r);if(t.tags!=null&&t.tags.size!==0)for(const[s,o]of t.tags.entries())r.uint32(58),n.Peer$tagsEntry.codec().encode({key:s,value:o},r);i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.addresses.push(g2.codec().decode(t,t.uint32()));break;case 2:i.protocols.push(t.string());break;case 4:i.publicKey=t.bytes();break;case 5:i.peerRecordEnvelope=t.bytes();break;case 6:{const a=n.Peer$metadataEntry.codec().decode(t,t.uint32());i.metadata.set(a.key,a.value);break}case 7:{const a=n.Peer$tagsEntry.codec().decode(t,t.uint32());i.tags.set(a.key,a.value);break}default:t.skipType(o&7);break}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(p2||(p2={}));var g2;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(r.uint32(10),r.bytes(t.multiaddr)),t.isCertified!=null&&(r.uint32(16),r.bool(t.isCertified)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={multiaddr:new Uint8Array(0)},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.multiaddr=t.bytes();break;case 2:i.isCertified=t.bool();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(g2||(g2={}));var y2;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.value!=null&&t.value!==0&&(r.uint32(8),r.uint32(t.value)),t.expiry!=null&&(r.uint32(16),r.uint64(t.expiry)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={value:0},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.value=t.uint32();break;case 2:i.expiry=t.uint64();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(y2||(y2={}));function yd(n,e){const t=p2.decode(e);t.publicKey!=null&&n.publicKey==null&&(n=rF({...n,publicKey:n.publicKey}));const r=new Map,i=BigInt(Date.now());for(const[s,o]of t.tags.entries())o.expiry!=null&&o.expiry<i||r.set(s,o);return{...t,id:n,addresses:t.addresses.map(({multiaddr:s,isCertified:o})=>({multiaddr:xe(s),isCertified:o??!1})),metadata:t.metadata,peerRecordEnvelope:t.peerRecordEnvelope??void 0,tags:r}}const wT="/peers/";function ed(n){if(!cp(n)||n.type==null)throw new S("Invalid PeerId",tr.ERR_INVALID_PARAMETERS);const e=n.toCID().toString();return new ot(`${wT}${e}`)}async function ute(n,e,t){const r=new Map;for(const i of t){if(i==null)continue;if(i.multiaddr instanceof Uint8Array&&(i.multiaddr=xe(i.multiaddr)),!Cp(i.multiaddr))throw new S("Multiaddr was invalid",tr.ERR_INVALID_PARAMETERS);if(!await e(n,i.multiaddr))continue;const s=i.isCertified??!1,o=i.multiaddr.toString(),a=r.get(o);a!=null?i.isCertified=a.isCertified||s:r.set(o,{multiaddr:i.multiaddr,isCertified:s})}return[...r.values()].sort((i,s)=>i.multiaddr.toString().localeCompare(s.multiaddr.toString())).map(({isCertified:i,multiaddr:s})=>({isCertified:i,multiaddr:s.bytes}))}async function f3(n,e,t,r){if(e==null)throw new S("Invalid PeerData",tr.ERR_INVALID_PARAMETERS);if(e.publicKey!=null&&n.publicKey!=null&&!Pe(e.publicKey,n.publicKey))throw new S("publicKey bytes do not match peer id publicKey bytes",tr.ERR_INVALID_PARAMETERS);const i=r.existingPeer;if(i!=null&&!n.equals(i.id))throw new S("peer id did not match existing peer id",tr.ERR_INVALID_PARAMETERS);let s=(i==null?void 0:i.addresses)??[],o=new Set((i==null?void 0:i.protocols)??[]),a=(i==null?void 0:i.metadata)??new Map,l=(i==null?void 0:i.tags)??new Map,c=i==null?void 0:i.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(s=[],e.multiaddrs!=null&&s.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&s.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=o1(d,{validate:mv})}if(e.tags!=null){const d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);l=o1(d,{validate:wv,map:vv})}e.peerRecordEnvelope!=null&&(c=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&s.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&s.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[f,p]of d)p==null?a.delete(f):a.set(f,p);a=o1([...a.entries()],{validate:mv})}if(e.tags!=null){const d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),f=new Map(l);for(const[p,y]of d)y==null?f.delete(p):f.set(p,y);l=o1([...f.entries()],{validate:wv,map:vv})}e.peerRecordEnvelope!=null&&(c=e.peerRecordEnvelope)}const u={addresses:await ute(n,r.addressFilter??(async()=>!0),s),protocols:[...o.values()].sort((d,f)=>d.localeCompare(f)),metadata:a,tags:l,publicKey:(i==null?void 0:i.id.publicKey)??e.publicKey??n.publicKey,peerRecordEnvelope:c};return n.type!=="RSA"&&delete u.publicKey,u}function o1(n,e){var r;const t=new Map;for(const[i,s]of n)s!=null&&e.validate(i,s);for(const[i,s]of n.sort(([o],[a])=>o.localeCompare(a)))s!=null&&t.set(i,((r=e.map)==null?void 0:r.call(e,i,s))??s);return t}function mv(n,e){if(typeof n!="string")throw new S("Metadata key must be a string",tr.ERR_INVALID_PARAMETERS);if(!(e instanceof Uint8Array))throw new S("Metadata value must be a Uint8Array",tr.ERR_INVALID_PARAMETERS)}function wv(n,e){if(typeof n!="string")throw new S("Tag name must be a string",tr.ERR_INVALID_PARAMETERS);if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new S("Tag value must be an integer",tr.ERR_INVALID_PARAMETERS);if(e.value<0||e.value>100)throw new S("Tag value must be between 0-100",tr.ERR_INVALID_PARAMETERS)}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new S("Tag ttl must be an integer",tr.ERR_INVALID_PARAMETERS);if(e.ttl<0)throw new S("Tag ttl must be between greater than 0",tr.ERR_INVALID_PARAMETERS)}}function vv(n,e){let t;return e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl))),{value:e.value??0,expiry:t}}function $1(n,e,t){const r=n.toString().split("/")[2],i=Hn.decode(r),s=di(i),o=t.get(s);if(o!=null)return o;const a=yd(s,e);return t.set(s,a),a}function dte(n,e){return n==null?{}:{prefix:wT,filters:(n.filters??[]).map(t=>({key:r,value:i})=>t($1(r,i,e))),orders:(n.orders??[]).map(t=>(r,i)=>t($1(r.key,r.value,e),$1(i.key,i.value,e)))}}var Wi,U1,F1;class hte{constructor(e,t={}){le(this,Wi);h(this,"peerId");h(this,"datastore");h(this,"lock");h(this,"addressFilter");this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=hI({name:"peer-store",singleProcess:!0})}async has(e){return this.datastore.has(ed(e))}async delete(e){if(this.peerId.equals(e))throw new S("Cannot delete self peer",tr.ERR_INVALID_PARAMETERS);await this.datastore.delete(ed(e))}async load(e){const t=await this.datastore.get(ed(e));return yd(e,t)}async save(e,t){const{existingBuf:r,existingPeer:i}=await Q(this,Wi,U1).call(this,e),s=await f3(e,t,"patch",{addressFilter:this.addressFilter});return Q(this,Wi,F1).call(this,e,s,r,i)}async patch(e,t){const{existingBuf:r,existingPeer:i}=await Q(this,Wi,U1).call(this,e),s=await f3(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:i});return Q(this,Wi,F1).call(this,e,s,r,i)}async merge(e,t){const{existingBuf:r,existingPeer:i}=await Q(this,Wi,U1).call(this,e),s=await f3(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:i});return Q(this,Wi,F1).call(this,e,s,r,i)}async*all(e){const t=new Ls;for await(const{key:r,value:i}of this.datastore.query(dte(e??{},t))){const s=$1(r,i,t);s.id.equals(this.peerId)||(yield s)}}}Wi=new WeakSet,U1=async function(e){try{const t=await this.datastore.get(ed(e)),r=yd(e,t);return{existingBuf:t,existingPeer:r}}catch(t){if(t.code!=="ERR_NOT_FOUND")throw t}return{}},F1=async function(e,t,r,i){const s=p2.encode(t);return r!=null&&Pe(s,r)?{peer:yd(e,s),previous:i,updated:!1}:(await this.datastore.put(ed(e),s),{peer:yd(e,s),previous:i,updated:!0})};var rb,yc,z1;rb=Symbol.toStringTag;class fte{constructor(e,t={}){le(this,yc);h(this,"store");h(this,"events");h(this,"peerId");h(this,"log");h(this,rb,"@libp2p/peer-store");this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new hte(e,t)}async forEach(e,t){this.log.trace("forEach await read lock");const r=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const i of this.store.all(t))e(i)}finally{this.log.trace("forEach release read lock"),r()}}async all(e){this.log.trace("all await read lock");const t=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await Z0(this.store.all(e))}finally{this.log.trace("all release read lock"),t()}}async delete(e){this.log.trace("delete await write lock");const t=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(e)}finally{this.log.trace("delete release write lock"),t()}}async has(e){this.log.trace("has await read lock");const t=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(e)}finally{this.log.trace("has release read lock"),t()}}async get(e){this.log.trace("get await read lock");const t=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(e)}finally{this.log.trace("get release read lock"),t()}}async save(e,t){this.log.trace("save await write lock");const r=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const i=await this.store.save(e,t);return Q(this,yc,z1).call(this,e,i),i.peer}finally{this.log.trace("save release write lock"),r()}}async patch(e,t){this.log.trace("patch await write lock");const r=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const i=await this.store.patch(e,t);return Q(this,yc,z1).call(this,e,i),i.peer}finally{this.log.trace("patch release write lock"),r()}}async merge(e,t){this.log.trace("merge await write lock");const r=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const i=await this.store.merge(e,t);return Q(this,yc,z1).call(this,e,i),i.peer}finally{this.log.trace("merge release write lock"),r()}}async consumePeerRecord(e,t){const r=await Mo.openAndCertify(e,Ki.DOMAIN);if((t==null?void 0:t.equals(r.peerId))===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",t,r.peerId),!1;const i=Ki.createFromProtobuf(r.payload);let s;try{s=await this.get(r.peerId)}catch(o){if(o.code!=="ERR_NOT_FOUND")throw o}if((s==null?void 0:s.peerRecordEnvelope)!=null){const o=await Mo.createFromProtobuf(s.peerRecordEnvelope),a=Ki.createFromProtobuf(o.payload);if(a.seqNumber>=i.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",a.seqNumber,i.seqNumber),!1}return await this.patch(i.peerId,{peerRecordEnvelope:e,addresses:i.multiaddrs.map(o=>({isCertified:!0,multiaddr:o}))}),!0}}yc=new WeakSet,z1=function(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))};function pte(n,e){let t;return function(){const r=function(){t=void 0,n()};clearTimeout(t),t=setTimeout(r,e)}}const gte=n=>n;function p3(n,e){const t=n.getPeerId();return t!=null&&xt(t).equals(e)&&(n=n.decapsulate(xe(`/p2p/${e.toString()}`))),n}var ib;ib=Symbol.toStringTag;class yte{constructor(e,t={}){h(this,"log");h(this,"components");h(this,"listen");h(this,"announce");h(this,"observed");h(this,"announceFilter");h(this,ib,"@libp2p/address-manager");const{listen:r=[],announce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=r.map(s=>s.toString()),this.announce=new Set(i.map(s=>s.toString())),this.observed=new Map,this.announceFilter=t.announceFilter??gte,this._updatePeerStoreAddresses=pte(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){const e=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter(([t,r])=>r.confident).map(([t])=>xe(t))).map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>xe(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>xe(e))}getObservedAddrs(){return Array.from(this.observed).map(([e])=>xe(e))}addObservedAddr(e){e=p3(e,this.components.peerId);const t=e.toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}confirmObservedAddr(e){e=p3(e,this.components.peerId);const t=e.toString(),i=(this.observed.get(t)??{confident:!1}).confident;this.observed.set(t,{confident:!0}),i||this._updatePeerStoreAddresses()}removeObservedAddr(e){e=p3(e,this.components.peerId);const t=e.toString();this.observed.delete(t)}getAddresses(){let e=this.getAnnounceAddrs().map(r=>r.toString());e.length===0&&(e=this.components.transportManager.getAddrs().map(r=>r.toString())),e=e.concat(Array.from(this.observed).filter(([r,i])=>i.confident).map(([r])=>r));const t=new Set(e);return this.announceFilter(Array.from(t).map(r=>xe(r))).map(r=>{var i;return((i=r.protos().pop())==null?void 0:i.path)===!0||r.getPeerId()===this.components.peerId.toString()?r:r.encapsulate(`/p2p/${this.components.peerId.toString()}`)})}}class mte{constructor(e={}){h(this,"components",{});h(this,"_started",!1);this.components={};for(const[t,r]of Object.entries(e))this.components[t]=r;this.components.logger==null&&(this.components.logger=wp())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>w6(t)).map(async t=>{var r;await((r=t[e])==null?void 0:r.call(t))}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const wte=["metrics","connectionProtector","dns"],vte=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function Ete(n={}){const e=new mte(n);return new Proxy(e,{get(r,i,s){if(typeof i=="string"&&!vte.includes(i)){const o=e.components[i];if(o==null&&!wte.includes(i))throw new S(`${i} not set`,"ERR_SERVICE_MISSING");return o}return Reflect.get(r,i,s)},set(r,i,s){return typeof i=="string"?e.components[i]=s:Reflect.set(r,i,s),!0}})}function bte(n){const e={};for(const t of Object.values(n.components))for(const r of _te(t))e[r]=!0;for(const t of Object.values(n.components))for(const r of Ste(t))if(e[r]!==!0)throw new S(`Service "${xte(t)}" required capability "${r}" but it was not provided by any component, you may need to add additional configuration when creating your node.`,"ERR_UNMET_SERVICE_DEPENDENCIES")}function _te(n){return Array.isArray(n==null?void 0:n[Dn])?n[Dn]:[]}function Ste(n){return Array.isArray(n==null?void 0:n[Dc])?n[Dc]:[]}function xte(n){return(n==null?void 0:n[Symbol.toStringTag])??(n==null?void 0:n.toString())??"unknown"}function kte(n={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{const t=e.stringTuples();return t[0][0]===4||t[0][0]===41?!!Bo(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...n}}function Ev(n){try{const{address:e}=n.nodeAddress();return!!Bo(e)}catch{return!0}}function Rte(n,e){const t=Ev(n.multiaddr),r=Ev(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function Ate(n,e){return n.isCertified&&!e.isCertified?-1:!n.isCertified&&e.isCertified?1:0}function Ite(n,e){const t=J0.exactMatch(n.multiaddr),r=J0.exactMatch(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function H5(n,e){const t=Rte(n,e);if(t!==0)return t;const r=Ite(n,e);return r!==0?r:Ate(n,e)}const Xn=-1,Ay={},Cte={},Tte=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Xn,"ip6zone"],[43,8,"ipcidr"],[53,Xn,"dns",!0],[54,Xn,"dns4",!0],[55,Xn,"dns6",!0],[56,Xn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Xn,"unix",!1,!0],[421,Xn,"ipfs"],[421,Xn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Xn,"garlic64"],[448,0,"tls"],[449,Xn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Xn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,Xn,"http-path"],[777,Xn,"memory"]];Tte.forEach(n=>{const e=Nte(...n);Cte[e.code]=e,Ay[e.name]=e});function Nte(n,e,t,r,i){return{code:n,size:e,name:t,resolvable:!!r,path:!!i}}function Dte(n){{if(Ay[n]!=null)return Ay[n];throw new Error(`no protocol with name: ${n}`)}}const Pte=32,{code:Ote}=Dte("dnsaddr");class Lte extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}const vT=async function(e,t={}){const r=t.maxRecursiveDepth??Pte;if(r===0)throw new Lte("Max recursive depth reached");const[,i]=e.stringTuples().find(([c])=>c===Ote)??[],o=await((t==null?void 0:t.dns)??MA()).query(`_dnsaddr.${i}`,{signal:t==null?void 0:t.signal,types:[Oo.TXT]}),a=e.getPeerId(),l=[];for(const c of o.Answer){const u=c.data.replace(/["']/g,"").trim().split("=")[1];if(u==null||a!=null&&!u.includes(a))continue;const d=xe(u);if(u.startsWith("/dnsaddr")){const f=await d.resolve({...t,maxRecursiveDepth:r-1});l.push(...f.map(p=>p.toString()))}else l.push(d.toString())}return l};var su;(function(n){n.NOT_STARTED_YET="The libp2p node is not started yet",n.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",n.NOT_FOUND="Not found"})(su||(su={}));var ce;(function(n){n.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",n.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",n.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",n.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",n.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",n.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",n.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",n.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",n.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",n.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",n.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",n.ERR_DIALED_SELF="ERR_DIALED_SELF",n.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",n.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",n.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",n.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",n.ERR_INVALID_KEY="ERR_INVALID_KEY",n.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",n.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",n.ERR_INVALID_PEER="ERR_INVALID_PEER",n.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",n.ERR_NOT_FOUND="ERR_NOT_FOUND",n.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",n.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",n.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",n.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",n.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",n.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",n.ERR_FIND_SELF="ERR_FIND_SELF",n.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",n.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",n.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",n.ERR_INVALID_CMS="ERR_INVALID_CMS",n.ERR_MISSING_KEYS="ERR_MISSING_KEYS",n.ERR_NO_KEY="ERR_NO_KEY",n.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",n.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",n.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",n.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",n.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",n.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",n.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",n.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",n.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",n.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",n.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",n.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",n.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",n.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",n.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",n.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",n.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",n.ERR_INVALID_RECORD="ERR_INVALID_RECORD",n.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",n.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",n.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",n.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",n.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",n.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"})(ce||(ce={}));const Bte={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:n=>n},connectionManager:{resolvers:{dnsaddr:vT},addressSorter:H5},transportManager:{faultTolerance:tc.FATAL_ALL}};async function Mte(n){var t,r;const e=M5(Bte,n);if(e.connectionProtector===null&&((r=(t=globalThis.process)==null?void 0:t.env)==null?void 0:r.LIBP2P_FORCE_PNET)!=null)throw new S(su.ERR_PROTECTOR_REQUIRED,ce.ERR_PROTECTOR_REQUIRED);if(e.privateKey!=null&&!(await qi(e.privateKey.public.bytes,e.privateKey.bytes)).equals(e.peerId))throw new S("Private key doesn't match peer id",ce.ERR_INVALID_KEY);return e}function ET(n){if(cp(n))return{peerId:n,multiaddrs:[]};Array.isArray(n)||(n=[n]);let e;if(n.length>0){const t=n[0].getPeerId();e=t==null?void 0:xt(t),n.forEach(r=>{if(!Cp(r))throw new S("Invalid Multiaddr",ce.ERR_INVALID_MULTIADDR);const i=r.getPeerId();if(i==null){if(e!=null)throw new S("Multiaddrs must all have the same peer id or have no peer id",ce.ERR_INVALID_PARAMETERS)}else{const s=xt(i);if((e==null?void 0:e.equals(s))!==!0)throw new S("Multiaddrs must all have the same peer id or have no peer id",ce.ERR_INVALID_PARAMETERS)}})}return{peerId:e,multiaddrs:n}}const bT=5e3,$te=2e3,_T=25,Ute=5e3,ST=25,xT=0,kT=100,RT=10,Fte=5,zte=10,AT="last-dial-failure",IT=500,CT=5,TT=100,NT=50,DT=1e3*60*7,ta={minConnections:CT,maxQueueLength:kT,autoDialConcurrency:ST,autoDialPriority:xT,autoDialInterval:Ute,autoDialPeerRetryThreshold:DT,autoDialDiscoveredPeersDebounce:RT};class Vte{constructor(e,t){h(this,"connectionManager");h(this,"peerStore");h(this,"queue");h(this,"minConnections");h(this,"autoDialPriority");h(this,"autoDialIntervalMs");h(this,"autoDialMaxQueueLength");h(this,"autoDialPeerRetryThresholdMs");h(this,"autoDialDiscoveredPeersDebounce");h(this,"autoDialInterval");h(this,"started");h(this,"running");h(this,"log");this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.minConnections=t.minConnections??ta.minConnections,this.autoDialPriority=t.autoDialPriority??ta.autoDialPriority,this.autoDialIntervalMs=t.autoDialInterval??ta.autoDialInterval,this.autoDialMaxQueueLength=t.maxQueueLength??ta.maxQueueLength,this.autoDialPeerRetryThresholdMs=t.autoDialPeerRetryThreshold??ta.autoDialPeerRetryThreshold,this.autoDialDiscoveredPeersDebounce=t.autoDialDiscoveredPeersDebounce??ta.autoDialDiscoveredPeersDebounce,this.log=e.logger.forComponent("libp2p:connection-manager:auto-dial"),this.started=!1,this.running=!1,this.queue=new mu({concurrency:t.autoDialConcurrency??ta.autoDialConcurrency,metricName:"libp2p_autodial_queue",metrics:e.metrics}),this.queue.addEventListener("error",i=>{this.log.error("error during auto-dial",i.detail)}),e.events.addEventListener("connection:close",()=>{this.autoDial().catch(i=>{this.log.error(i)})});let r;e.events.addEventListener("peer:discovery",()=>{clearTimeout(r),r=setTimeout(()=>{this.autoDial().catch(i=>{this.log.error(i)})},this.autoDialDiscoveredPeersDebounce)})}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.autoDial().catch(e=>{this.log.error("error while autodialing",e)})}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started||this.running)return;const e=this.connectionManager.getConnectionsMap(),t=e.size;if(t>=this.minConnections){this.minConnections>0&&this.log.trace("have enough connections %d/%d",t,this.minConnections);return}if(this.queue.size>this.autoDialMaxQueueLength){this.log("not enough connections %d/%d but auto dial queue is full",t,this.minConnections),this.sheduleNextAutodial();return}this.running=!0,this.log("not enough connections %d/%d - will dial peers to increase the number of connections",t,this.minConnections);const r=new si(this.connectionManager.getDialQueue().map(c=>c.peerId).filter(Boolean)),i=await this.peerStore.all({filters:[c=>c.addresses.length===0?(this.log.trace("not autodialing %p because they have no addresses",c.id),!1):e.has(c.id)?(this.log.trace("not autodialing %p because they are already connected",c.id),!1):r.has(c.id)?(this.log.trace("not autodialing %p because they are already being dialed",c.id),!1):this.queue.has(c.id)?(this.log.trace("not autodialing %p because they are already being autodialed",c.id),!1):!0]}),s=i.sort(()=>Math.random()>.5?1:-1),o=new Ls;for(const c of s)o.has(c.id)||o.set(c.id,[...c.tags.values()].reduce((u,d)=>u+d.value,0));const l=s.sort((c,u)=>{const d=o.get(c.id)??0,f=o.get(u.id)??0;return d>f?-1:d<f?1:0}).filter(c=>{const u=c.metadata.get(AT);if(u==null)return!0;const d=parseInt(ne(u));return isNaN(d)?!0:Date.now()-d>this.autoDialPeerRetryThresholdMs});this.log("selected %d/%d peers to dial",l.length,i.length);for(const c of l)this.queue.add(async()=>{const u=this.connectionManager.getConnectionsMap().size;if(u>=this.minConnections){this.log("got enough connections now %d/%d",u,this.minConnections),this.queue.clear();return}this.log("connecting to a peerStore stored peer %p",c.id),await this.connectionManager.openConnection(c.id,{priority:this.autoDialPriority})},{peerId:c.id}).catch(u=>{this.log.error("could not connect to peerStore stored peer",u)});this.running=!1,this.sheduleNextAutodial()}sheduleNextAutodial(){this.started&&(this.autoDialInterval=setTimeout(()=>{this.autoDial().catch(e=>{this.log.error("error while autodialing",e)})},this.autoDialIntervalMs))}}const Hte=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function Kte(n,e){var i;const t=((i=n==null?void 0:n.streams)==null?void 0:i.map(s=>s.protocol))??[],r=(e==null?void 0:e.closableProtocols)??Hte;if(!(t.filter(s=>s!=null&&!r.includes(s)).length>0))try{await(n==null?void 0:n.close(e))}catch(s){n==null||n.abort(s)}}const bv={maxConnections:TT,allow:[]};class Wte{constructor(e,t={}){h(this,"maxConnections");h(this,"connectionManager");h(this,"peerStore");h(this,"allow");h(this,"events");h(this,"log");this.maxConnections=t.maxConnections??bv.maxConnections,this.allow=t.allow??bv.allow,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),e.events.addEventListener("connection:open",()=>{this.maybePruneConnections().catch(r=>{this.log.error(r)})})}async maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length;if(this.log("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;const r=new Ls;for(const a of e){const l=a.remotePeer;if(!r.has(l)){r.set(l,0);try{const c=await this.peerStore.get(l);r.set(l,[...c.tags.values()].reduce((u,d)=>u+d.value,0))}catch(c){c.code!=="ERR_NOT_FOUND"&&this.log.error("error loading peer tags",c)}}}const i=this.sortConnections(e,r),s=Math.max(t-this.maxConnections,0),o=[];for(const a of i)if(this.log("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(c=>a.remoteAddr.toString().startsWith(c.toString()))||o.push(a),o.length===s)break;await Promise.all(o.map(async a=>{await Kte(a,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:o})}sortConnections(e,t){return e.sort((r,i)=>{const s=r.timeline.open,o=i.timeline.open;return s<o?1:s>o?-1:0}).sort((r,i)=>r.direction==="outbound"&&i.direction==="inbound"?1:r.direction==="inbound"&&i.direction==="outbound"?-1:0).sort((r,i)=>r.streams.length>i.streams.length?1:r.streams.length<i.streams.length?-1:0).sort((r,i)=>{const s=t.get(r.remotePeer)??0,o=t.get(i.remotePeer)??0;return s>o?1:s<o?-1:0})}}let Gte=class extends Oc{constructor(e={}){super({...e,sort:(t,r)=>t.options.priority>r.options.priority?-1:t.options.priority<r.options.priority?1:0})}};async function qte(n,e){let t=!1;for(const i of T5.keys())if(t=n.protoNames().includes(i),t)break;if(!t)return[n];const r=await n.resolve(e);return e.log("resolved %s to",n,r.map(i=>i.toString())),r}const td={addressSorter:H5,maxParallelDials:NT,maxDialQueueLength:IT,maxPeerAddrsToDial:_T,dialTimeout:bT};class jte{constructor(e,t={}){h(this,"queue");h(this,"components");h(this,"addressSorter");h(this,"maxPeerAddrsToDial");h(this,"maxDialQueueLength");h(this,"dialTimeout");h(this,"shutDownController");h(this,"connections");h(this,"log");this.addressSorter=t.addressSorter??td.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??td.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??td.maxDialQueueLength,this.dialTimeout=t.dialTimeout??td.dialTimeout,this.connections=t.connections??new Ls,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,ue(1/0,this.shutDownController.signal);for(const[r,i]of Object.entries(t.resolvers??{}))T5.set(r,i);this.queue=new Gte({concurrency:t.maxParallelDials??td.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",r=>{this.log.error("error in dial queue",r.detail)})}start(){this.shutDownController=new AbortController,ue(1/0,this.shutDownController.signal)}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){var a,l,c;const{peerId:r,multiaddrs:i}=ET(e),s=Array.from(this.connections.values()).flat().find(u=>t.force===!0?!1:u.remotePeer.equals(r)?!0:i.find(d=>d.equals(u.remoteAddr)));if(s!=null)return this.log("already connected to %a",s.remoteAddr),(a=t.onProgress)==null||a.call(t,new se("dial-queue:already-connected")),s;const o=this.queue.queue.find(u=>{if((r==null?void 0:r.equals(u.options.peerId))===!0)return!0;const d=u.options.multiaddrs;if(d==null)return!1;for(const f of i)if(d.has(f.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",r);for(const u of i)o.options.multiaddrs.add(u.toString());return(l=t.onProgress)==null||l.call(t,new se("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new S("Dial queue is full","ERR_DIAL_QUEUE_FULL");return this.log("creating dial target for %p",r,i.map(u=>u.toString())),(c=t.onProgress)==null||c.call(t,new se("dial-queue:add-to-dial-queue")),this.queue.add(async u=>{var p,y;(p=u==null?void 0:u.onProgress)==null||p.call(u,new se("dial-queue:start-dial"));const d=this.createDialAbortController(u==null?void 0:u.signal);let f;try{f=await this.calculateMultiaddrs(r,u==null?void 0:u.multiaddrs,{...u,signal:d}),(y=u==null?void 0:u.onProgress)==null||y.call(u,new se("dial-queue:calculated-addresses",f)),f.map(({multiaddr:g})=>g.toString()).forEach(g=>{u==null||u.multiaddrs.add(g)})}catch(g){throw d.clear(),g}try{let g=0;const w=[];for(const m of f){if(g===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",g,r),new S("Peer had more than maxPeerAddrsToDial",ce.ERR_TOO_MANY_ADDRESSES);g++;try{const E=await this.components.transportManager.dial(m.multiaddr,{...u,signal:d});return this.log("dial to %a succeeded",m.multiaddr),E}catch(E){if(this.log.error("dial failed to %a",m.multiaddr,E),r!=null)try{await this.components.peerStore.patch(r,{metadata:{[AT]:Y(Date.now().toString())}})}catch(v){this.log.error("could not update last dial failure key for %p",r,v)}if(d.aborted)throw new S(E.message,Nc);w.push(E)}}throw w.length===1?w[0]:new SM(w,"All multiaddr dials failed",ce.ERR_TRANSPORT_DIAL_FAILED)}finally{d.clear()}},{peerId:r,priority:t.priority??PT,multiaddrs:new Set(i.map(u=>u.toString())),signal:t.signal,onProgress:t.onProgress})}createDialAbortController(e){const t=bt([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e]);return ue(1/0,t),t}async calculateMultiaddrs(e,t=new Set,r={}){var d,f;const i=[...t].map(p=>({multiaddr:xe(p),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new S("Tried to dial self",ce.ERR_DIALED_SELF);if(await((f=(d=this.components.connectionGater).denyDialPeer)==null?void 0:f.call(d,e))===!0)throw new S("The dial request is blocked by gater.allowDialPeer",ce.ERR_PEER_DIAL_INTERCEPTED);if(i.length===0){this.log("loading multiaddrs for %p",e);try{const p=await this.components.peerStore.get(e);i.push(...p.addresses),this.log("loaded multiaddrs for %p",e,i.map(({multiaddr:y})=>y.toString()))}catch(p){if(p.code!==ce.ERR_NOT_FOUND)throw p}}if(i.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const p=await this.components.peerRouting.findPeer(e);this.log("found multiaddrs for %p in the peer routing",e,i.map(({multiaddr:y})=>y.toString())),i.push(...p.multiaddrs.map(y=>({multiaddr:y,isCertified:!1})))}catch(p){p.code!==ce.ERR_NO_ROUTERS_AVAILABLE&&this.log.error("looking up multiaddrs for %p in the peer routing failed",e,p)}}}let s=(await Promise.all(i.map(async p=>{const y=await qte(p.multiaddr,{dns:this.components.dns,...r,log:this.log});return y.length===1&&y[0].equals(p.multiaddr)?p:y.map(g=>({multiaddr:g,isCertified:!1}))}))).flat();if(e!=null){const p=`/p2p/${e.toString()}`;s=s.map(y=>{const g=y.multiaddr.protos().pop();return(g==null?void 0:g.path)===!0?y:y.multiaddr.getPeerId()==null?{multiaddr:y.multiaddr.encapsulate(p),isCertified:y.isCertified}:y})}const o=s.filter(p=>{if(this.components.transportManager.dialTransportForMultiaddr(p.multiaddr)==null)return!1;const y=p.multiaddr.getPeerId();return e!=null&&y!=null?e.equals(y):!0}),a=new Map;for(const p of o){const y=p.multiaddr.toString(),g=a.get(y);if(g!=null){g.isCertified=g.isCertified||p.isCertified||!1;continue}a.set(y,p)}const l=[...a.values()];if(l.length===0)throw new S("The dial request has no valid addresses",ce.ERR_NO_VALID_ADDRESSES);const c=[];for(const p of l)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(p.multiaddr)||c.push(p);const u=c.sort(this.addressSorter);if(u.length===0)throw new S("The connection gater denied all addresses in the dial request",ce.ERR_NO_VALID_ADDRESSES);return this.log.trace("addresses for %p before filtering",e??"unknown peer",s.map(({multiaddr:p})=>p.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",u.map(({multiaddr:p})=>p.toString())),u}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const r=await this.calculateMultiaddrs(void 0,new Set(e.map(i=>i.toString())),t);return t.runOnTransientConnection===!1?r.find(i=>!J0.matches(i.multiaddr))!=null:!0}catch(r){this.log.trace("error calculating if multiaddr(s) were dialable",r)}return!1}}const PT=50,ns={minConnections:CT,maxConnections:TT,inboundConnectionThreshold:Fte,maxIncomingPendingConnections:zte,autoDialConcurrency:ST,autoDialPriority:xT,autoDialMaxQueueLength:kT,autoDialPeerRetryThreshold:DT,autoDialDiscoveredPeersDebounce:RT};var sb;sb=Symbol.toStringTag;class Yte{constructor(e,t={}){h(this,"started");h(this,"connections");h(this,"allow");h(this,"deny");h(this,"maxIncomingPendingConnections");h(this,"incomingPendingConnections");h(this,"maxConnections");h(this,"dialQueue");h(this,"autoDial");h(this,"connectionPruner");h(this,"inboundConnectionRateLimiter");h(this,"peerStore");h(this,"metrics");h(this,"events");h(this,"log");h(this,sb,"@libp2p/connection-manager");this.maxConnections=t.maxConnections??ns.maxConnections;const r=t.minConnections??ns.minConnections;if(this.maxConnections<r)throw new S("Connection Manager maxConnections must be greater than minConnections",ce.ERR_INVALID_PARAMETERS);this.connections=new Ls,this.started=!1,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(t.allow??[]).map(i=>xe(i)),this.deny=(t.deny??[]).map(i=>xe(i)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??ns.maxIncomingPendingConnections,this.inboundConnectionRateLimiter=new eT({points:t.inboundConnectionThreshold??ns.inboundConnectionThreshold,duration:1}),this.autoDial=new Vte({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{minConnections:r,autoDialConcurrency:t.autoDialConcurrency??ns.autoDialConcurrency,autoDialPriority:t.autoDialPriority??ns.autoDialPriority,autoDialPeerRetryThreshold:t.autoDialPeerRetryThreshold??ns.autoDialPeerRetryThreshold,autoDialDiscoveredPeersDebounce:t.autoDialDiscoveredPeersDebounce??ns.autoDialDiscoveredPeersDebounce,maxQueueLength:t.autoDialMaxQueueLength??ns.autoDialMaxQueueLength}),this.connectionPruner=new Wte({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new jte(e,{addressSorter:t.addressSorter??H5,maxParallelDials:t.maxParallelDials??NT,maxDialQueueLength:t.maxDialQueueLength??IT,maxPeerAddrsToDial:t.maxPeerAddrsToDial??_T,dialTimeout:t.dialTimeout??bT,resolvers:t.resolvers??{dnsaddr:vT},connections:this.connections})}isStarted(){return this.started}async start(){var e,t,r;(e=this.metrics)==null||e.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const i={inbound:0,outbound:0};for(const s of this.connections.values())for(const o of s)o.direction==="inbound"?i.inbound++:i.outbound++;return i}}),(t=this.metrics)==null||t.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const i={};for(const s of this.connections.values())for(const o of s)for(const a of o.streams){const l=`${a.direction} ${a.protocol??"unnegotiated"}`;i[l]=(i[l]??0)+1}return i}}),(r=this.metrics)==null||r.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const i={};for(const o of this.connections.values())for(const a of o){const l={};for(const c of a.streams){const u=`${c.direction} ${c.protocol??"unnegotiated"}`;l[u]=(l[u]??0)+1}for(const[c,u]of Object.entries(l))i[c]=i[c]??[],i[c].push(u)}const s={};for(let[o,a]of Object.entries(i)){a=a.sort((c,u)=>c-u);const l=Math.floor(a.length*.9);s[o]=a[l]}return s}}),this.dialQueue.start(),this.autoDial.start(),this.started=!0,this.log("started")}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(_M)]});await Promise.all(e.map(async t=>{await this.openConnection(t.id).catch(r=>{this.log.error(r)})}))}).catch(e=>{this.log.error(e)}),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();const e=[];for(const t of this.connections.values())for(const r of t)e.push((async()=>{try{await r.close()}catch(i){this.log.error(i)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}const r=t.remotePeer,i=this.connections.get(r);let s=!1;i!=null?i.push(t):(s=!0,this.connections.set(r,[t])),r.publicKey!=null&&r.type==="RSA"&&await this.peerStore.patch(r,{publicKey:r.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e;if(!this.started)return;const r=t.remotePeer;let i=this.connections.get(r);i!=null&&i.length>1?(i=i.filter(s=>s.id!==t.id),this.connections.set(r,i)):i!=null&&(this.connections.delete(r),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const r of this.connections.values())t=t.concat(r);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){var a,l;if(!this.isStarted())throw new S("Not started",ce.ERR_NODE_NOT_STARTED);(a=t.signal)==null||a.throwIfAborted();const{peerId:r}=ET(e);if(r!=null&&t.force!==!0){this.log("dial %p",r);const c=this.getConnections(r).find(u=>!u.transient);if(c!=null)return this.log("had an existing non-transient connection to %p",r),(l=t.onProgress)==null||l.call(t,new se("dial-queue:already-connected")),c}const i=await this.dialQueue.dial(e,{...t,priority:t.priority??PT});let s=this.connections.get(i.remotePeer);s==null&&(s=[],this.connections.set(i.remotePeer,s));let o=!1;for(const c of s)c.id===i.id&&(o=!0);return o||s.push(i),i}async closeConnections(e,t={}){const r=this.connections.get(e)??[];await Promise.all(r.map(async i=>{try{await i.close(t)}catch(s){i.abort(s)}}))}async acceptIncomingConnection(e){if(this.deny.some(i=>e.remoteAddr.toString().startsWith(i.toString())))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(i=>e.remoteAddr.toString().startsWith(i.toString())))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const i=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(i,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,i),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(r=>xe(r))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}const Qte=1e4,Xte="1.0.0",Jte="ping",Zte="ipfs",_v=32;var ob,ab;ab=Symbol.toStringTag,ob=Dn;class ene{constructor(e,t={}){h(this,"protocol");h(this,"components");h(this,"log");h(this,"heartbeatInterval");h(this,"pingIntervalMs");h(this,"abortController");h(this,"timeout");h(this,ab,"@libp2p/connection-monitor");h(this,ob,["@libp2p/connection-monitor"]);this.components=e,this.protocol=`/${t.protocolPrefix??Zte}/${Jte}/${Xte}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??Qte,this.timeout=new WC({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}start(){this.abortController=new AbortController,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{var r;let t=Date.now();try{const i=this.timeout.getTimeoutSignal({signal:(r=this.abortController)==null?void 0:r.signal}),s=await e.newStream(this.protocol,{signal:i,runOnTransientConnection:!0}),o=aC(s);t=Date.now(),await Promise.all([o.write(Yi(_v),{signal:i}),o.read(_v,{signal:i})]),e.rtt=Date.now()-t,await o.unwrap().close({signal:i})}catch(i){if(i.code!=="ERR_UNSUPPORTED_PROTOCOL")throw i;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat, aborting connection",t),e.abort(t)})})},this.pingIntervalMs)}stop(){var e;(e=this.abortController)==null||e.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}var lb;lb=Symbol.toStringTag;class tne{constructor(e,t){h(this,"routers");h(this,"started");h(this,"components");h(this,lb,"@libp2p/content-routing");this.routers=t.routers??[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new S("No content routers available",ce.ERR_NO_ROUTERS_AVAILABLE);const r=this,i=new si;for await(const s of xo(...r.routers.map(o=>o.findProviders(e,t))))s!=null&&(s.multiaddrs.length>0&&await this.components.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),!i.has(s.id)&&(i.add(s.id),yield s))}async provide(e,t={}){if(this.routers.length===0)throw new S("No content routers available",ce.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map(async r=>{await r.provide(e,t)}))}async put(e,t,r){if(!this.isStarted())throw new S(su.NOT_STARTED_YET,ce.ERR_NODE_NOT_STARTED);await Promise.all(this.routers.map(async i=>{await i.put(e,t,r)}))}async get(e,t){if(!this.isStarted())throw new S(su.NOT_STARTED_YET,ce.ERR_NODE_NOT_STARTED);return Promise.any(this.routers.map(async r=>r.get(e,t)))}}var cb;cb=Symbol.toStringTag;class nne{constructor(e,t={}){h(this,"log");h(this,"peerId");h(this,"peerStore");h(this,"routers");h(this,cb,"@libp2p/peer-routing");this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[]}async findPeer(e,t){if(this.routers.length===0)throw new S("No peer routers available",ce.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.peerId.toString())throw new S("Should not try to find self",ce.ERR_FIND_SELF);const r=this,i=xo(...this.routers.map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(o){r.log.error(o)}}()));for await(const s of i)if(s!=null)return s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),s;throw new S(su.NOT_FOUND,ce.ERR_NOT_FOUND)}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new S("No peer routers available",ce.ERR_NO_ROUTERS_AVAILABLE);const r=this,i=SA(1024);for await(const s of al(async function*(){const o=xo(...r.routers.map(a=>a.getClosestPeers(e,t)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await r.findPeer(a.id,{...t,useCache:!1})}catch(l){r.log.error("could not find peer multiaddrs",l);return}return a}}()))s!=null&&(s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),!i.has(s.id.toBytes())&&(i.add(s.id.toBytes()),yield s))}}var ub,db;class rne extends(db=tn,ub=Symbol.toStringTag,db){constructor(t){super();h(this,"peerRouting");h(this,"log");h(this,"walking");h(this,"walkers");h(this,"shutdownController");h(this,"walkController");h(this,"needNext");h(this,ub,"@libp2p/random-walk");this.log=t.logger.forComponent("libp2p:random-walk"),this.peerRouting=t.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,ue(1/0,this.shutdownController.signal)}start(){this.shutdownController=new AbortController,ue(1/0,this.shutdownController.signal)}stop(){this.shutdownController.abort()}async*walk(t){var i,s;this.walking||this.startWalk(),this.walkers++;const r=bt([this.shutdownController.signal,t==null?void 0:t.signal]);ue(1/0,r);try{for(;;)(i=this.needNext)==null||i.resolve(),this.needNext=Se(),yield(await Nr(this,"walk:peer",r,{errorEvent:"walk:error"})).detail}finally{r.clear(),this.walkers--,this.walkers===0&&((s=this.walkController)==null||s.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,ue(1/0,this.walkController.signal);const t=bt([this.walkController.signal,this.shutdownController.signal]);ue(1/0,t);const r=Date.now();let i=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=Yi(32);let o=Date.now();for await(const a of this.peerRouting.getClosestPeers(s,{signal:t}))t.aborted&&this.log("aborting walk"),t.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",a.id,Date.now()-o,this.walkers),i++,this.safeDispatchEvent("walk:peer",{detail:a}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Pt(this.needNext.promise,t)),o=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,i)}catch(s){this.log.error("randomwalk errored",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("randomwalk errored",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",i,Date.now()-r),this.walking=!1})}}const OT=32,LT=64;var hb;hb=Symbol.toStringTag;class ine{constructor(e){h(this,"log");h(this,"topologies");h(this,"handlers");h(this,"components");h(this,hb,"@libp2p/registrar");this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new S(`No handler registered for protocol ${e}`,ce.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,r){if(this.handlers.has(e))throw new S(`Handler already registered for protocol ${e}`,ce.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const i=M5.bind({ignoreUndefined:!0})({maxInboundStreams:OT,maxOutboundStreams:LT},r);this.handlers.set(e,{handler:t,options:i}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach(r=>{this.handlers.delete(r)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(t==null)throw new S("invalid topology",ce.ERR_INVALID_PARAMETERS);const r=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let i=this.topologies.get(e);return i==null&&(i=new Map,this.topologies.set(e,i)),i.set(r,t),r}unregister(e){for(const[t,r]of this.topologies.entries())r.has(e)&&(r.delete(e),r.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.get(t).then(r=>{var i,s,o;for(const a of r.protocols){const l=this.topologies.get(a);if(l!=null)for(const c of l.values())((i=c.filter)==null?void 0:i.has(t))!==!1&&((s=c.filter)==null||s.remove(t),(o=c.onDisconnect)==null||o.call(c,t))}}).catch(r=>{r.code!==ce.ERR_NOT_FOUND&&this.log.error("could not inform topologies of disconnecting peer %p",t,r)})}_onPeerUpdate(e){var s,o,a;const{peer:t,previous:r}=e.detail,i=((r==null?void 0:r.protocols)??[]).filter(l=>!t.protocols.includes(l));for(const l of i){const c=this.topologies.get(l);if(c!=null)for(const u of c.values())((s=u.filter)==null?void 0:s.has(t.id))!==!1&&((o=u.filter)==null||o.remove(t.id),(a=u.onDisconnect)==null||a.call(u,t.id))}}_onPeerIdentify(e){var s,o,a;const t=e.detail.protocols,r=e.detail.connection,i=e.detail.peerId;for(const l of t){const c=this.topologies.get(l);if(c!=null)for(const u of c.values())r.transient&&u.notifyOnTransient!==!0||((s=u.filter)==null?void 0:s.has(i))!==!0&&((o=u.filter)==null||o.add(i),(a=u.onConnect)==null||a.call(u,i,r))}}}var fb;fb=Symbol.toStringTag;class sne{constructor(e,t={}){h(this,"log");h(this,"components");h(this,"transports");h(this,"listeners");h(this,"faultTolerance");h(this,"started");h(this,fb,"@libp2p/transport-manager");this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=new Map,this.listeners=RI({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??tc.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(t==null)throw new S("Transport must have a valid tag",ce.ERR_INVALID_KEY);if(this.transports.has(t))throw new S(`There is already a transport with the tag ${t}`,ce.ERR_DUPLICATE_TRANSPORT);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,r]of this.listeners)for(this.log("closing listeners for %s",t);r.length>0;){const i=r.pop();i!=null&&e.push(i.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){var i;const r=this.dialTransportForMultiaddr(e);if(r==null)throw new S(`No transport available for address ${String(e)}`,ce.ERR_TRANSPORT_UNAVAILABLE);(i=t==null?void 0:t.onProgress)==null||i.call(t,new se("transport-manager:selected-transport",r[Symbol.toStringTag]));try{return await r.dial(e,{...t,upgrader:this.components.upgrader})}catch(s){throw s.code==null&&(s.code=ce.ERR_TRANSPORT_DIAL_FAILED),s}}getAddrs(){let e=[];for(const t of this.listeners.values())for(const r of t)e=[...e,...r.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new S("Not started",ce.ERR_NODE_NOT_STARTED);if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t=[];for(const[r,i]of this.transports.entries()){const s=i.listenFilter(e),o=[];for(const c of s){this.log("creating listener for %s on %a",r,c);const u=i.createListener({upgrader:this.components.upgrader});let d=this.listeners.get(r)??[];d==null&&(d=[],this.listeners.set(r,d)),d.push(u),u.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:u})}),u.addEventListener("close",()=>{const f=d.findIndex(p=>p===u);d.splice(f,1),this.components.events.safeDispatchEvent("transport:close",{detail:u})}),o.push(u.listen(c))}if(o.length===0){t.push(r);continue}if((await Promise.allSettled(o)).find(c=>c.status==="fulfilled")==null&&this.faultTolerance!==tc.NO_FATAL)throw new S(`Transport (${r}) could not listen on any available address`,ce.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){const r=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===tc.FATAL_ALL)throw new S(r,ce.ERR_NO_VALID_ADDRESSES);this.log(`libp2p in dial mode only: ${r}`)}}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const r=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const i=t.pop();i!=null&&r.push(i.close())}await Promise.all(r),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const zn="/multistream/1.0.0",K5=1024,one=Y(`
`);async function md(n,e,t){await n.write(e,t)}async function ane(n,e,t){await n.writeV(e,t)}async function lne(n,e){const t=await n.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==one[0])throw e.log.error("Invalid mss message - missing newline",t),new S("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return t.sublist(0,-1)}async function sc(n,e){const t=await lne(n,e);return ne(t.subarray())}async function g3(n,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return cne(n,e[0],t);const r=jc(n,{...t,maxDataLength:K5}),i=e.shift();if(i==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',zn,i);const s=Y(`${zn}
`),o=Y(`${i}
`);await ane(r,[s,o],t),t.log.trace("select: reading multistream-select header");let a=await sc(r,t);if(t.log.trace('select: read "%s"',a),a===zn&&(t.log.trace("select: reading protocol response"),a=await sc(r,t),t.log.trace('select: read "%s"',a)),a===i)return{stream:r.unwrap(),protocol:i};for(const l of e){t.log.trace('select: write "%s"',l),await md(r,Y(`${l}
`),t),t.log.trace("select: reading protocol response");const c=await sc(r,t);if(t.log.trace('select: read "%s" for "%s"',c,l),c===l)return{stream:r.unwrap(),protocol:l}}throw new S("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}function cne(n,e,t){const r=n.sink.bind(n),i=n.source;let s=!1,o=!1;const a=Se();let l=!1,c=!1;const u=Se();let d=!1,f=!1;const p=Se(),y=jc({sink:r,source:i},{...t,maxDataLength:K5});n.sink=async E=>{const{sink:v}=y.unwrap();await v(async function*(){let b=!1;for await(const k of E){if(c&&await u.promise,l)yield k;else{c=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',zn,e,k.byteLength);const A=`${e}
`;yield new Fe(Uint8Array.from([19]),Y(`${zn}
`),ii(A.length),Y(A),k).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',zn,e,k.byteLength),l=!0,c=!1,u.resolve(),g().catch(T=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,T)})}b=!0}b||await g()}())};async function g(){if(o){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}o=!0;try{l||(t.log.trace("optimistic: doing send protocol for %s stream",e),await w()),d||(t.log.trace("optimistic: doing read protocol for %s stream",e),await m())}finally{o=!1,s=!0,a.resolve()}}async function w(){if(c){await u.promise;return}c=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',zn,e),await y.writeV([Y(`${zn}
`),Y(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',zn,e)}finally{l=!0,c=!1,u.resolve()}}async function m(){if(f){await p.promise;return}f=!0;try{t.log.trace("optimistic: reading multistream select header");let E=await sc(y,t);if(t.log.trace('optimistic: read multistream select header "%s"',E),E===zn&&(E=await sc(y,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',E,e),E!==e)throw new S("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}finally{d=!0,f=!1,p.resolve()}}if(n.source=async function*(){await g(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*y.unwrap().source}(),n.closeRead!=null){const E=n.closeRead.bind(n);n.closeRead=async v=>{s||await g().catch(b=>{t.log.error("could not negotiate protocol before close read",b)}),await E(v)}}if(n.closeWrite!=null){const E=n.closeWrite.bind(n);n.closeWrite=async v=>{s||await g().catch(b=>{t.log.error("could not negotiate protocol before close write",b)}),await E(v)}}if(n.close!=null){const E=n.close.bind(n);n.close=async v=>{const b=[];c&&b.push(u.promise),f&&b.push(p.promise),b.length>0?await Pt(Promise.all(b),v==null?void 0:v.signal):(s=!0,o=!1,a.resolve()),await E(v)}}return{stream:n,protocol:e}}async function y3(n,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);const r=jc(n,{...t,maxDataLength:K5,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");const i=await sc(r,t);if(t.log.trace('handle: read "%s"',i),i===zn){t.log.trace('handle: respond with "%s" for "%s"',zn,i),await md(r,Y(`${zn}
`),t),t.log.trace('handle: responded with "%s" for "%s"',zn,i);continue}if(e.includes(i))return t.log.trace('handle: respond with "%s" for "%s"',i,i),await md(r,Y(`${i}
`),t),t.log.trace('handle: responded with "%s" for "%s"',i,i),{stream:r.unwrap(),protocol:i};if(i==="ls"){const s=new Fe(...e.map(o=>No.single(Y(`${o}
`))),Y(`
`));t.log.trace('handle: respond with "%s" for %s',e,i),await md(r,s,t),t.log.trace('handle: responded with "%s" for %s',e,i);continue}t.log('handle: respond with "na" for "%s"',i),await md(r,Y(`na
`),t),t.log('handle: responded with "na" for "%s"',i)}}const une=500;var pb,gb;gb=Symbol.toStringTag,pb=bM;class dne{constructor(e){h(this,"id");h(this,"remoteAddr");h(this,"remotePeer");h(this,"direction");h(this,"timeline");h(this,"multiplexer");h(this,"encryption");h(this,"status");h(this,"transient");h(this,"log");h(this,"tags");h(this,"_newStream");h(this,"_close");h(this,"_abort");h(this,"_getStreams");h(this,gb,"Connection");h(this,pb,!0);const{remoteAddr:t,remotePeer:r,newStream:i,close:s,abort:o,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=r,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.transient=e.transient??!1,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=i,this._close=s,this._abort=o,this._getStreams=a,this.tags=[]}get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new S("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if(this.status==="closed")throw new S("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(e)||(e=[e]),this.transient&&(t==null?void 0:t.runOnTransientConnection)!==!0)throw new S("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");const r=await this._newStream(e,t);return r.direction="outbound",r}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){const t=AbortSignal.timeout(une);ue(1/0,t),e={...e,signal:t}}try{this.log.trace("closing all streams"),await Promise.all(this.streams.map(async t=>t.close(e))),this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.streams.forEach(t=>{t.abort(e)}),this.log.error("all streams aborted",this.streams.length),this._abort(e),this.timeline.close=Date.now(),this.status="closed"}}function hne(n){return new dne(n)}const fne=3e4;function pne(n,e){try{const{options:t}=e.getHandler(n);return t.maxInboundStreams}catch(t){if(t.code!==ce.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return OT}function gne(n,e,t={}){try{const{options:r}=e.getHandler(n);if(r.maxOutboundStreams!=null)return r.maxOutboundStreams}catch(r){if(r.code!==ce.ERR_NO_HANDLER_FOR_PROTOCOL)throw r}return t.maxOutboundStreams??LT}function Sv(n,e,t){let r=0;return t.streams.forEach(i=>{i.direction===e&&i.protocol===n&&r++}),r}var yb;yb=Symbol.toStringTag;class yne{constructor(e,t){h(this,"components");h(this,"connectionEncryption");h(this,"muxers");h(this,"inboundUpgradeTimeout");h(this,"events");h(this,yb,"@libp2p/upgrader");this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach(r=>{this.connectionEncryption.set(r.protocol,r)}),this.muxers=new Map,t.muxers.forEach(r=>{this.muxers.set(r.protocol,r)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??$te,this.events=e.events}async shouldBlockConnection(e,t,r){const i=this.components.connectionGater[r];if(i!==void 0&&await i(e,t))throw new S(`The multiaddr connection is blocked by gater.${r}`,ce.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(e,t){var d,f,p,y,g;if(!await this.components.connectionManager.acceptIncomingConnection(e))throw new S("connection denied",ce.ERR_CONNECTION_DENIED);let i,s,o,a,l;const c=AbortSignal.timeout(this.inboundUpgradeTimeout),u=()=>{e.abort(new S("inbound upgrade timeout",Nc))};c.addEventListener("abort",u,{once:!0}),ue(1/0,c);try{if(await((f=(d=this.components.connectionGater).denyInboundConnection)==null?void 0:f.call(d,e))===!0)throw new S("The multiaddr connection is blocked by gater.acceptConnection",ce.ERR_CONNECTION_INTERCEPTED);(p=this.components.metrics)==null||p.trackMultiaddrConnection(e),e.log("starting the inbound connection upgrade");let w=e;if((t==null?void 0:t.skipProtection)!==!0){const m=this.components.connectionProtector;m!=null&&(e.log("protecting the inbound connection"),w=await m.protect(e))}try{if(i=w,(t==null?void 0:t.skipEncryption)!==!0){(y=t==null?void 0:t.onProgress)==null||y.call(t,new se("upgrader:encrypt-inbound-connection")),{conn:i,remotePeer:s,protocol:l}=await this._encryptInbound(w);const m={...w,...i};await this.shouldBlockConnection(s,m,"denyInboundEncryptedConnection")}else{const m=e.remoteAddr.getPeerId();if(m==null)throw new S("inbound connection that skipped encryption must have a peer id",ce.ERR_INVALID_MULTIADDR);const E=xt(m);l="native",s=E}if(o=i,(t==null?void 0:t.muxerFactory)!=null)a=t.muxerFactory;else if(this.muxers.size>0){(g=t==null?void 0:t.onProgress)==null||g.call(t,new se("upgrader:multiplex-inbound-connection"));const m=await this._multiplexInbound({...w,...i},this.muxers);a=m.muxerFactory,o=m.stream}}catch(m){throw e.log.error("failed to upgrade inbound connection",m),m}return await this.shouldBlockConnection(s,e,"denyInboundUpgradedConnection"),e.log("successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:l,direction:"inbound",maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:s,transient:t==null?void 0:t.transient})}finally{c.removeEventListener("abort",u),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){var d;const r=e.remoteAddr.getPeerId();let i;r!=null&&(i=xt(r),await this.shouldBlockConnection(i,e,"denyOutboundConnection"));let s,o,a,l,c;(d=this.components.metrics)==null||d.trackMultiaddrConnection(e),e.log("starting the outbound connection upgrade");let u=e;if((t==null?void 0:t.skipProtection)!==!0){const f=this.components.connectionProtector;f!=null&&(u=await f.protect(e))}try{if(s=u,(t==null?void 0:t.skipEncryption)!==!0){({conn:s,remotePeer:o,protocol:l}=await this._encryptOutbound(u,i));const f={...u,...s};await this.shouldBlockConnection(o,f,"denyOutboundEncryptedConnection")}else{if(i==null)throw new S("Encryption was skipped but no peer id was passed",ce.ERR_INVALID_PEER);l="native",o=i}if(a=s,(t==null?void 0:t.muxerFactory)!=null)c=t.muxerFactory;else if(this.muxers.size>0){const f=await this._multiplexOutbound({...u,...s},this.muxers);c=f.muxerFactory,a=f.stream}}catch(f){throw e.log.error("failed to upgrade outbound connection",f),await e.close(f),f}return await this.shouldBlockConnection(o,e,"denyOutboundUpgradedConnection"),e.log("successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:l,direction:"outbound",maConn:e,upgradedConn:a,muxerFactory:c,remotePeer:o,transient:t==null?void 0:t.transient})}_createConnection(e){const{cryptoProtocol:t,direction:r,maConn:i,upgradedConn:s,remotePeer:o,muxerFactory:a,transient:l}=e;let c,u,d;a!=null&&(c=a.createStreamMuxer({direction:r,onIncomingStream:y=>{d!=null&&Promise.resolve().then(async()=>{var b;const g=this.components.registrar.getProtocols(),{stream:w,protocol:m}=await y3(y,g,{log:y.log,yieldBytes:!1});if(d==null)return;d.log("incoming stream opened on %s",m);const E=pne(m,this.components.registrar);if(Sv(m,"inbound",d)===E){const k=new S(`Too many inbound protocol streams for protocol "${m}" - limit ${E}`,ce.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw y.abort(k),k}y.source=w.source,y.sink=w.sink,y.protocol=m,w.closeWrite!=null&&(y.closeWrite=w.closeWrite),w.closeRead!=null&&(y.closeRead=w.closeRead),w.close!=null&&(y.close=w.close),await this.components.peerStore.merge(o,{protocols:[m]}),(b=this.components.metrics)==null||b.trackProtocolStream(y,d),this._onStream({connection:d,stream:y,protocol:m})}).catch(async g=>{d.log.error("error handling incoming stream id %s",y.id,g.message,g.code,g.stack),y.timeline.close==null&&await y.close()})}}),u=async(y,g={})=>{var m;if(c==null)throw new S("Stream is not multiplexed",ce.ERR_MUXER_UNAVAILABLE);d.log("starting new stream for protocols %s",y);const w=await c.newStream();d.log.trace("started new stream %s for protocols %s",w.id,y);try{if(g.signal==null){w.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",y);const A=AbortSignal.timeout(fne);ue(1/0,A),g={...g,signal:A}}w.log.trace("selecting protocol from protocols %s",y);const{stream:E,protocol:v}=await g3(w,y,{...g,log:w.log,yieldBytes:!0});w.log("selected protocol %s",v);const b=gne(v,this.components.registrar,g),k=Sv(v,"outbound",d);if(k>=b){const A=new S(`Too many outbound protocol streams for protocol "${v}" - ${k}/${b}`,ce.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw w.abort(A),A}return await this.components.peerStore.merge(o,{protocols:[v]}),w.source=E.source,w.sink=E.sink,w.protocol=v,E.closeWrite!=null&&(w.closeWrite=E.closeWrite),E.closeRead!=null&&(w.closeRead=E.closeRead),E.close!=null&&(w.close=E.close),(m=this.components.metrics)==null||m.trackProtocolStream(w,d),w}catch(E){throw d.log.error("could not create new stream for protocols %s",y,E),w.timeline.close==null&&w.abort(E),E.code!=null?E:new S(String(E),ce.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([c.sink(s.source),s.sink(c.source)]).catch(y=>{d.log.error("error piping data through muxer",y)}));const f=i.timeline;i.timeline=new Proxy(f,{set:(...y)=>(d!=null&&y[1]==="close"&&y[2]!=null&&f.close==null&&(async()=>{try{d.status==="open"&&await d.close()}catch(g){d.log.error("error closing connection after timeline close",g)}finally{this.events.safeDispatchEvent("connection:close",{detail:d})}})().catch(g=>{d.log.error("error thrown while dispatching connection:close event",g)}),Reflect.set(...y))}),i.timeline.upgraded=Date.now();const p=()=>{throw new S("connection is not multiplexed",ce.ERR_CONNECTION_NOT_MULTIPLEXED)};return d=hne({remoteAddr:i.remoteAddr,remotePeer:o,status:"open",direction:r,timeline:i.timeline,multiplexer:c==null?void 0:c.protocol,encryption:t,transient:l,logger:this.components.logger,newStream:u??p,getStreams:()=>c!=null?c.streams:[],close:async y=>{c!=null&&(d.log.trace("close muxer"),await c.close(y)),d.log.trace("close maconn"),await i.close(y),d.log.trace("closed maconn")},abort:y=>{i.abort(y),c!=null&&c.abort(y)}}),this.events.safeDispatchEvent("connection:open",{detail:d}),d}_onStream(e){const{connection:t,stream:r,protocol:i}=e,{handler:s,options:o}=this.components.registrar.getHandler(i);if(t.transient&&o.runOnTransientConnection!==!0)throw new S("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");s({connection:t,stream:r})}async _encryptInbound(e){const t=Array.from(this.connectionEncryption.keys());e.log("handling inbound crypto protocol selection",t);try{const{stream:r,protocol:i}=await y3(e,t,{log:e.log}),s=this.connectionEncryption.get(i);if(s==null)throw new Error(`no crypto module found for ${i}`);return e.log("encrypting inbound connection using",i),{...await s.secureInbound(this.components.peerId,r),protocol:i}}catch(r){throw e.log.error("encrypting inbound connection failed",r),new S(r.message,ce.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){const r=Array.from(this.connectionEncryption.keys());e.log("selecting outbound crypto protocol",r);try{e.log.trace("selecting encrypter from %s",r);const{stream:i,protocol:s}=await g3(e,r,{log:e.log,yieldBytes:!0}),o=this.connectionEncryption.get(s);if(o==null)throw new Error(`no crypto module found for ${s}`);return e.log("encrypting outbound connection to %p using %s",t,o),{...await o.secureOutbound(this.components.peerId,i,t),protocol:s}}catch(i){throw e.log.error("encrypting outbound connection to %p failed",t,i),new S(i.message,ce.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){const r=Array.from(t.keys());e.log("outbound selecting muxer %s",r);try{e.log.trace("selecting stream muxer from %s",r);const{stream:i,protocol:s}=await g3(e,r,{log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",s);const o=t.get(s);return{stream:i,muxerFactory:o}}catch(i){throw e.log.error("error multiplexing outbound connection",i),new S(String(i),ce.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){const r=Array.from(t.keys());e.log("inbound handling muxers %s",r);try{const{stream:i,protocol:s}=await y3(e,r,{log:e.log}),o=t.get(s);return{stream:i,muxerFactory:o}}catch(i){throw e.log.error("error multiplexing inbound connection",i),new S(String(i),ce.ERR_MUXER_UNAVAILABLE)}}}var Lh,Iy;class mne extends tn{constructor(t){var l,c,u,d,f;super();le(this,Lh);h(this,"peerId");h(this,"peerStore");h(this,"contentRouting");h(this,"peerRouting");h(this,"metrics");h(this,"services");h(this,"logger");h(this,"status");h(this,"components");h(this,"log");this.status="stopped";const r=new tn,i=r.dispatchEvent.bind(r);r.dispatchEvent=p=>{const y=i(p),g=this.dispatchEvent(new ui(p.type,{detail:p.detail}));return y||g},ue(1/0,r),this.peerId=t.peerId,this.logger=t.logger??wp(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=this.components=Ete({peerId:t.peerId,privateKey:t.privateKey,nodeInfo:t.nodeInfo??{name:mT,version:yT},logger:this.logger,events:r,datastore:t.datastore??new oC,connectionGater:kte(t.connectionGater),dns:t.dns});this.peerStore=this.configureComponent("peerStore",new fte(s,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...t.peerStore})),t.metrics!=null&&(this.metrics=this.configureComponent("metrics",t.metrics(this.components))),s.events.addEventListener("peer:update",p=>{if(p.detail.previous==null){const y={id:p.detail.peer.id,multiaddrs:p.detail.peer.addresses.map(g=>g.multiaddr)};s.events.safeDispatchEvent("peer:discovery",{detail:y})}}),t.connectionProtector!=null&&this.configureComponent("connectionProtector",t.connectionProtector(s)),this.components.upgrader=new yne(this.components,{connectionEncryption:(t.connectionEncryption??[]).map((p,y)=>this.configureComponent(`connection-encryption-${y}`,p(this.components))),muxers:(t.streamMuxers??[]).map((p,y)=>this.configureComponent(`stream-muxers-${y}`,p(this.components))),inboundUpgradeTimeout:(l=t.connectionManager)==null?void 0:l.inboundUpgradeTimeout}),this.configureComponent("transportManager",new sne(this.components,t.transportManager)),this.configureComponent("connectionManager",new Yte(this.components,t.connectionManager)),((c=t.connectionMonitor)==null?void 0:c.enabled)!==!1&&this.configureComponent("connectionMonitor",new ene(this.components,t.connectionMonitor)),this.configureComponent("registrar",new ine(this.components)),this.configureComponent("addressManager",new yte(this.components,t.addresses));const o=(t.peerRouters??[]).map((p,y)=>this.configureComponent(`peer-router-${y}`,p(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new nne(this.components,{routers:o}));const a=(t.contentRouters??[]).map((p,y)=>this.configureComponent(`content-router-${y}`,p(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new tne(this.components,{routers:a})),this.configureComponent("randomWalk",new rne(this.components)),(t.peerDiscovery??[]).forEach((p,y)=>{this.configureComponent(`peer-discovery-${y}`,p(this.components)).addEventListener("peer",w=>{Q(this,Lh,Iy).call(this,w)})}),(u=t.transports)==null||u.forEach((p,y)=>{this.components.transportManager.add(this.configureComponent(`transport-${y}`,p(this.components)))}),t.services!=null)for(const p of Object.keys(t.services)){const y=t.services[p],g=y(this.components);if(g==null){this.log.error("service factory %s returned null or undefined instance",p);continue}this.services[p]=g,this.configureComponent(p,g),g[Cc]!=null&&(this.log("registering service %s for content routing",p),a.push(g[Cc])),g[Tc]!=null&&(this.log("registering service %s for peer routing",p),o.push(g[Tc])),g[A0]!=null&&(this.log("registering service %s for peer discovery",p),(f=(d=g[A0]).addEventListener)==null||f.call(d,"peer",w=>{Q(this,Lh,Iy).call(this,w)}))}bte(s)}configureComponent(t,r){return r==null&&this.log.error("component %s was null or undefined",t),this.components[t]=r,r}async start(){var t,r,i,s;if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await((r=(t=this.components).beforeStart)==null?void 0:r.call(t)),await this.components.start(),await((s=(i=this.components).afterStart)==null?void 0:s.call(i)),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(o){throw this.log.error("An error occurred starting libp2p",o),this.status="started",await this.stop(),o}}}async stop(){var t,r,i,s;this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await((r=(t=this.components).beforeStop)==null?void 0:r.call(t)),await this.components.stop(),await((s=(i=this.components).afterStop)==null?void 0:s.call(i)),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(t){return this.components.connectionManager.getConnections(t)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const t=new si;for(const r of this.components.connectionManager.getConnections())t.add(r.remotePeer);return Array.from(t)}async dial(t,r={}){return this.components.connectionManager.openConnection(t,{priority:75,...r})}async dialProtocol(t,r,i={}){if(r==null)throw new S("no protocols were provided to open a stream",ce.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(r=Array.isArray(r)?r:[r],r.length===0)throw new S("no protocols were provided to open a stream",ce.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(t,i)).newStream(r,i)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(t,r={}){Cp(t)&&(t=xt(t.getPeerId()??"")),await this.components.connectionManager.closeConnections(t,r)}async getPublicKey(t,r={}){if(this.log("getPublicKey %p",t),t.publicKey!=null)return t.publicKey;try{const o=await this.peerStore.get(t);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.code!==ce.ERR_NOT_FOUND)throw o}const i=vn([Y("/pk/"),t.multihash.digest]),s=await this.contentRouting.get(i,r);return mh(s),await this.peerStore.patch(t,{publicKey:s}),s}async handle(t,r,i){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async s=>{await this.components.registrar.handle(s,r,i)}))}async unhandle(t){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async r=>{await this.components.registrar.unhandle(r)}))}async register(t,r){return this.components.registrar.register(t,r)}unregister(t){this.components.registrar.unregister(t)}async isDialable(t,r={}){return this.components.connectionManager.isDialable(t,r)}}Lh=new WeakSet,Iy=function(t){const{detail:r}=t;if(r.id.toString()===this.peerId.toString()){this.log.error(new Error(ce.ERR_DISCOVERED_SELF));return}this.components.peerStore.merge(r.id,{multiaddrs:r.multiaddrs}).catch(i=>{this.log.error(i)})};async function wne(n={}){const e=n.peerId??(n.peerId=await lte());if(e.privateKey==null)throw new S("peer id was missing private key","ERR_MISSING_PRIVATE_KEY");return n.privateKey??(n.privateKey=await zc(e.privateKey)),new mne(await Mte(n))}async function vne(n={}){const e=await wne(n);return n.start!==!1&&await e.start(),e}async function Ene(n){var a;const e=(a=n.libp2p)==null?void 0:a.peerId,t=n.logger??wp(),r=new ot("/pkcs8/self");let i;e==null&&n.datastore!=null&&(i=ZC(n.keychain)({datastore:n.datastore,logger:t}),await n.datastore.has(r)&&(n.libp2p=n.libp2p??{},n.libp2p.peerId=await i.exportPeerId("self")));const s=ate(n);s.datastore=s.datastore??n.datastore,n=n??{};const o=await vne({...s,...n.libp2p,start:!1});return e==null&&i!=null&&!await n.datastore.has(r)&&await i.importPeer("self",o.peerId),o}async function bne(n={}){const e=n.datastore??new oC,t=n.blockstore??new AW;let r;_ne(n.libp2p)?r=n.libp2p:r=await Ene({...n,libp2p:{dns:n.dns,...n.libp2p,start:void 0},datastore:e});const i=new Dj({...n,libp2p:r,datastore:e,blockstore:t,blockBrokers:n.blockBrokers??[Dq(),XW()],routers:[Rj(r),xj()],metrics:r.metrics});return n.start!==!1&&await i.start(),i}function _ne(n){return n==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(t=>typeof n[t]=="function")}function Sne(n){return n[Symbol.asyncIterator]!=null}function BT(n,e=1){return e=Number(e),Sne(n)?async function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for await(const r of n)for(t.push(r);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)}():function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for(const r of n)for(t.push(r);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)}()}async function*MT(n,e=1){for await(const t of BT(n,e)){const r=t.map(async i=>i().then(s=>({ok:!0,value:s}),s=>({ok:!1,err:s})));for(let i=0;i<r.length;i++){const s=await r[i];if(s.ok)yield s.value;else throw s.err}}}const xne=262144,$T=(n={})=>{const e=n.chunkSize??xne;return async function*(r){let i=new Fe,s=0,o=!1;for await(const a of r)for(i.append(a),s+=a.length;s>=e;)if(yield i.slice(0,e),o=!0,e===i.length)i=new Fe,s=0;else{const l=new Fe;l.append(i.sublist(e)),i=l,s-=e}(!o||s>0)&&(yield i.subarray(0,s))}},$l=class $l extends Error{constructor(t="Invalid type"){super(t);h(this,"name",$l.name);h(this,"code",$l.code)}};h($l,"name","InvalidTypeError"),h($l,"code","ERR_INVALID_TYPE");let m2=$l;const Ul=class Ul extends Error{constructor(t="Invalid message"){super(t);h(this,"name",Ul.name);h(this,"code",Ul.code)}};h(Ul,"name","InvalidUnixFSMessageError"),h(Ul,"code","ERR_INVALID_MESSAGE");let Cy=Ul;var ki;(function(n){(function(r){r.Raw="Raw",r.Directory="Directory",r.File="File",r.Metadata="Metadata",r.Symlink="Symlink",r.HAMTShard="HAMTShard"})(n.DataType||(n.DataType={}));let e;(function(r){r[r.Raw=0]="Raw",r[r.Directory=1]="Directory",r[r.File=2]="File",r[r.Metadata=3]="Metadata",r[r.Symlink=4]="Symlink",r[r.HAMTShard=5]="HAMTShard"})(e||(e={})),function(r){r.codec=()=>Pn(e)}(n.DataType||(n.DataType={}));let t;n.codec=()=>(t==null&&(t=Ae((r,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),r.Type!=null&&(i.uint32(8),n.DataType.codec().encode(r.Type,i)),r.Data!=null&&(i.uint32(18),i.bytes(r.Data)),r.filesize!=null&&(i.uint32(24),i.uint64(r.filesize)),r.blocksizes!=null)for(const o of r.blocksizes)i.uint32(32),i.uint64(o);r.hashType!=null&&(i.uint32(40),i.uint64(r.hashType)),r.fanout!=null&&(i.uint32(48),i.uint64(r.fanout)),r.mode!=null&&(i.uint32(56),i.uint32(r.mode)),r.mtime!=null&&(i.uint32(66),w2.codec().encode(r.mtime,i)),s.lengthDelimited!==!1&&i.ldelim()},(r,i)=>{const s={blocksizes:[]},o=i==null?r.len:r.pos+i;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:s.Type=n.DataType.codec().decode(r);break;case 2:s.Data=r.bytes();break;case 3:s.filesize=r.uint64();break;case 4:s.blocksizes.push(r.uint64());break;case 5:s.hashType=r.uint64();break;case 6:s.fanout=r.uint64();break;case 7:s.mode=r.uint32();break;case 8:s.mtime=w2.codec().decode(r,r.uint32());break;default:r.skipType(a&7);break}}return s})),t),n.encode=r=>Re(r,n.codec()),n.decode=r=>ke(r,n.codec())})(ki||(ki={}));var w2;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.Seconds!=null&&(r.uint32(8),r.int64(t.Seconds)),t.FractionalNanoseconds!=null&&(r.uint32(21),r.fixed32(t.FractionalNanoseconds)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.Seconds=t.int64();break;case 2:i.FractionalNanoseconds=t.fixed32();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(w2||(w2={}));var xv;(function(n){let e;n.codec=()=>(e==null&&(e=Ae((t,r,i={})=>{i.lengthDelimited!==!1&&r.fork(),t.MimeType!=null&&(r.uint32(10),r.string(t.MimeType)),i.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const i={},s=r==null?t.len:t.pos+r;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.MimeType=t.string();break;default:t.skipType(o&7);break}}return i})),e),n.encode=t=>Re(t,n.codec()),n.decode=t=>ke(t,n.codec())})(xv||(xv={}));const kv={Raw:"raw",Directory:"directory",File:"file",Metadata:"metadata",Symlink:"symlink",HAMTShard:"hamt-sharded-directory"},kne=["directory","hamt-sharded-directory"],Rv=parseInt("0644",8),Av=parseInt("0755",8),Iv=BigInt(1024);let Oe=class UT{constructor(e={type:"file"}){h(this,"type");h(this,"data");h(this,"blockSizes");h(this,"hashType");h(this,"fanout");h(this,"mtime");h(this,"_mode");h(this,"_originalMode");const{type:t,data:r,blockSizes:i,hashType:s,fanout:o,mtime:a,mode:l}=e;if(t!=null&&!Object.values(kv).includes(t))throw new m2("Type: "+t+" is not valid");this.type=t??"file",this.data=r,this.hashType=s,this.fanout=o,this.blockSizes=i??[],this._originalMode=0,this.mode=l,this.mtime=a}static unmarshal(e){const t=ki.decode(e);if(t.fanout!=null&&t.fanout>Iv)throw new Cy(`Fanout size was too large - ${t.fanout} > ${Iv}`);const r=new UT({type:kv[t.Type!=null?t.Type.toString():"File"],data:t.Data,blockSizes:t.blocksizes,mode:t.mode,mtime:t.mtime!=null?{secs:t.mtime.Seconds??0n,nsecs:t.mtime.FractionalNanoseconds}:void 0,fanout:t.fanout});return r._originalMode=t.mode??0,r}set mode(e){e==null?this._mode=this.isDirectory()?Av:Rv:this._mode=e&4095}get mode(){return this._mode}isDirectory(){return kne.includes(this.type)}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0n;let e=0n;return this.blockSizes.forEach(t=>{e+=t}),this.data!=null&&(e+=BigInt(this.data.length)),e}marshal(){let e;switch(this.type){case"raw":e=ki.DataType.Raw;break;case"directory":e=ki.DataType.Directory;break;case"file":e=ki.DataType.File;break;case"metadata":e=ki.DataType.Metadata;break;case"symlink":e=ki.DataType.Symlink;break;case"hamt-sharded-directory":e=ki.DataType.HAMTShard;break;default:throw new m2(`Type: ${e} is not valid`)}let t=this.data;(this.data==null||this.data.length===0)&&(t=void 0);let r;this.mode!=null&&(r=this._originalMode&4294963200|(this.mode??0),r===Rv&&!this.isDirectory()&&(r=void 0),r===Av&&this.isDirectory()&&(r=void 0));let i;return this.mtime!=null&&(i={Seconds:this.mtime.secs,FractionalNanoseconds:this.mtime.nsecs}),ki.encode({Type:e,Data:t,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:r,mtime:i})}};function Rne(n,e){if(n===e)return!0;if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return!1;return!0}function cf(n){if(n instanceof Uint8Array&&n.constructor.name==="Uint8Array")return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(ArrayBuffer.isView(n))return new Uint8Array(n.buffer,n.byteOffset,n.byteLength);throw new Error("Unknown type, must be binary type")}const Ane="raw",Ds=85;function Ine(n){return cf(n)}function Cne(n){return cf(n)}const Tne=Object.freeze(Object.defineProperty({__proto__:null,code:Ds,decode:Cne,encode:Ine,name:Ane},Symbol.toStringTag,{value:"Module"}));function Nne(n,e){if(n.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var i=0;i<n.length;i++){var s=n.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=n.length,l=n.charAt(0),c=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function d(y){if(y instanceof Uint8Array||(ArrayBuffer.isView(y)?y=new Uint8Array(y.buffer,y.byteOffset,y.byteLength):Array.isArray(y)&&(y=Uint8Array.from(y))),!(y instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(y.length===0)return"";for(var g=0,w=0,m=0,E=y.length;m!==E&&y[m]===0;)m++,g++;for(var v=(E-m)*u+1>>>0,b=new Uint8Array(v);m!==E;){for(var k=y[m],A=0,T=v-1;(k!==0||A<w)&&T!==-1;T--,A++)k+=256*b[T]>>>0,b[T]=k%a>>>0,k=k/a>>>0;if(k!==0)throw new Error("Non-zero carry");w=A,m++}for(var P=v-w;P!==v&&b[P]===0;)P++;for(var _=l.repeat(g);P<v;++P)_+=n.charAt(b[P]);return _}function f(y){if(typeof y!="string")throw new TypeError("Expected String");if(y.length===0)return new Uint8Array;var g=0;if(y[g]!==" "){for(var w=0,m=0;y[g]===l;)w++,g++;for(var E=(y.length-g)*c+1>>>0,v=new Uint8Array(E);y[g];){var b=t[y.charCodeAt(g)];if(b===255)return;for(var k=0,A=E-1;(b!==0||k<m)&&A!==-1;A--,k++)b+=a*v[A]>>>0,v[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");m=k,g++}if(y[g]!==" "){for(var T=E-m;T!==E&&v[T]===0;)T++;for(var P=new Uint8Array(w+(E-T)),_=w;T!==E;)P[_++]=v[T++];return P}}}function p(y){var g=f(y);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:p}}var Dne=Nne,Pne=Dne;class One{constructor(e,t,r){h(this,"name");h(this,"prefix");h(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Lne{constructor(e,t,r){h(this,"name");h(this,"prefix");h(this,"baseDecode");h(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=r}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return FT(this,e)}}class Bne{constructor(e){h(this,"decoders");this.decoders=e}or(e){return FT(this,e)}decode(e){const t=e[0],r=this.decoders[t];if(r!=null)return r.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function FT(n,e){return new Bne({...n.decoders??{[n.prefix]:n},...e.decoders??{[e.prefix]:e}})}class Mne{constructor(e,t,r,i){h(this,"name");h(this,"prefix");h(this,"baseEncode");h(this,"baseDecode");h(this,"encoder");h(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=i,this.encoder=new One(e,t,r),this.decoder=new Lne(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function zT({name:n,prefix:e,encode:t,decode:r}){return new Mne(n,e,t,r)}function Up({name:n,prefix:e,alphabet:t}){const{encode:r,decode:i}=Pne(t,n);return zT({prefix:e,name:n,encode:r,decode:s=>cf(i(s))})}function $ne(n,e,t,r){let i=n.length;for(;n[i-1]==="=";)--i;const s=new Uint8Array(i*t/8|0);let o=0,a=0,l=0;for(let c=0;c<i;++c){const u=e[n[c]];if(u===void 0)throw new SyntaxError(`Non-${r} character`);a=a<<t|u,o+=t,o>=8&&(o-=8,s[l++]=255&a>>o)}if(o>=t||255&a<<8-o)throw new SyntaxError("Unexpected end of data");return s}function Une(n,e,t){const r=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let l=0;l<n.length;++l)for(a=a<<8|n[l],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),r)for(;s.length*t&7;)s+="=";return s}function Fne(n){const e={};for(let t=0;t<n.length;++t)e[n[t]]=t;return e}function Us({name:n,prefix:e,bitsPerChar:t,alphabet:r}){const i=Fne(r);return zT({prefix:e,name:n,encode(s){return Une(s,r,t)},decode(s){return $ne(s,i,t,n)}})}const V1=Us({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Us({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Us({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Us({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Us({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Us({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Us({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Us({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Us({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const m3=Up({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Up({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const no=Up({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Up({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var zne=VT,Cv=128,Vne=-128,Hne=Math.pow(2,31);function VT(n,e,t){e=e||[],t=t||0;for(var r=t;n>=Hne;)e[t++]=n&255|Cv,n/=128;for(;n&Vne;)e[t++]=n&255|Cv,n>>>=7;return e[t]=n|0,VT.bytes=t-r+1,e}var Kne=Ty,Wne=128,Tv=127;function Ty(n,r){var t=0,r=r||0,i=0,s=r,o,a=n.length;do{if(s>=a)throw Ty.bytes=0,new RangeError("Could not decode varint");o=n[s++],t+=i<28?(o&Tv)<<i:(o&Tv)*Math.pow(2,i),i+=7}while(o>=Wne);return Ty.bytes=s-r,t}var Gne=Math.pow(2,7),qne=Math.pow(2,14),jne=Math.pow(2,21),Yne=Math.pow(2,28),Qne=Math.pow(2,35),Xne=Math.pow(2,42),Jne=Math.pow(2,49),Zne=Math.pow(2,56),ere=Math.pow(2,63),tre=function(n){return n<Gne?1:n<qne?2:n<jne?3:n<Yne?4:n<Qne?5:n<Xne?6:n<Jne?7:n<Zne?8:n<ere?9:10},nre={encode:zne,decode:Kne,encodingLength:tre},v2=nre;function Ny(n,e=0){return[v2.decode(n,e),v2.decode.bytes]}function E2(n,e,t=0){return v2.encode(n,e,t),e}function b2(n){return v2.encodingLength(n)}function HT(n,e){const t=e.byteLength,r=b2(n),i=r+b2(t),s=new Uint8Array(i+t);return E2(n,s,0),E2(t,s,r),s.set(e,i),new W5(n,t,e,s)}function KT(n){const e=cf(n),[t,r]=Ny(e),[i,s]=Ny(e.subarray(r)),o=e.subarray(r+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new W5(t,i,o,e)}function rre(n,e){if(n===e)return!0;{const t=e;return n.code===t.code&&n.size===t.size&&t.bytes instanceof Uint8Array&&Rne(n.bytes,t.bytes)}}class W5{constructor(e,t,r,i){h(this,"code");h(this,"size");h(this,"digest");h(this,"bytes");this.code=e,this.size=t,this.digest=r,this.bytes=i}}function Nv(n,e){const{bytes:t,version:r}=n;switch(r){case 0:return sre(t,Dy(n),e??no.encoder);default:return ore(t,Dy(n),e??V1.encoder)}}const Dv=new WeakMap;function Dy(n){const e=Dv.get(n);if(e==null){const t=new Map;return Dv.set(n,t),t}return e}var mb;class Ke{constructor(e,t,r,i){h(this,"code");h(this,"version");h(this,"multihash");h(this,"bytes");h(this,"/");h(this,mb,"CID");this.code=t,this.version=e,this.multihash=r,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==nd)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==are)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Ke.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,r=HT(e,t);return Ke.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Ke.equals(this,e)}static equals(e,t){const r=t;return r!=null&&e.code===r.code&&e.version===r.version&&rre(e.multihash,r.multihash)}toString(e){return Nv(this,e)}toJSON(){return{"/":Nv(this)}}link(){return this}[(mb=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Ke)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:r,code:i,multihash:s,bytes:o}=t;return new Ke(r,i,s,o??Pv(r,i,s.bytes))}else if(t[lre]===!0){const{version:r,multihash:i,code:s}=t,o=KT(i);return Ke.create(r,s,o)}else return null}static create(e,t,r){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(r.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==nd)throw new Error(`Version 0 CID must use dag-pb (code: ${nd}) block encoding`);return new Ke(e,t,r,r.bytes)}case 1:{const i=Pv(e,t,r.bytes);return new Ke(e,t,r,i)}default:throw new Error("Invalid version")}}static createV0(e){return Ke.create(0,nd,e)}static createV1(e,t){return Ke.create(1,e,t)}static decode(e){const[t,r]=Ke.decodeFirst(e);if(r.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Ke.inspectBytes(e),r=t.size-t.multihashSize,i=cf(e.subarray(r,r+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new W5(t.multihashCode,t.digestSize,s,i);return[t.version===0?Ke.createV0(o):Ke.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const r=()=>{const[d,f]=Ny(e.subarray(t));return t+=f,d};let i=r(),s=nd;if(i===18?(i=0,t=0):s=r(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=r(),l=r(),c=t+l,u=c-o;return{version:i,codec:s,multihashCode:a,digestSize:l,multihashSize:u,size:c}}static parse(e,t){const[r,i]=ire(e,t),s=Ke.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Dy(s).set(r,e),s}}function ire(n,e){switch(n[0]){case"Q":{const t=e??no;return[no.prefix,t.decode(`${no.prefix}${n}`)]}case no.prefix:{const t=e??no;return[no.prefix,t.decode(n)]}case V1.prefix:{const t=e??V1;return[V1.prefix,t.decode(n)]}case m3.prefix:{const t=e??m3;return[m3.prefix,t.decode(n)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[n[0],e.decode(n)]}}}function sre(n,e,t){const{prefix:r}=t;if(r!==no.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(r);if(i==null){const s=t.encode(n).slice(1);return e.set(r,s),s}else return i}function ore(n,e,t){const{prefix:r}=t,i=e.get(r);if(i==null){const s=t.encode(n);return e.set(r,s),s}else return i}const nd=112,are=18;function Pv(n,e,t){const r=b2(n),i=r+b2(e),s=new Uint8Array(i+t.byteLength);return E2(n,s,0),E2(e,s,r),s.set(t,i),s}const lre=Symbol.for("@ipld/js-cid/CID"),cre=20;function ure({name:n,code:e,encode:t,minDigestLength:r,maxDigestLength:i}){return new dre(n,e,t,r,i)}class dre{constructor(e,t,r,i,s){h(this,"name");h(this,"code");h(this,"encode");h(this,"minDigestLength");h(this,"maxDigestLength");this.name=e,this.code=t,this.encode=r,this.minDigestLength=i??cre,this.maxDigestLength=s}digest(e,t){if((t==null?void 0:t.truncate)!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const r=this.encode(e);return r instanceof Uint8Array?Ov(r,this.code,t==null?void 0:t.truncate):r.then(i=>Ov(i,this.code,t==null?void 0:t.truncate))}else throw Error("Unknown type, must be binary type")}}function Ov(n,e,t){if(t!=null&&t!==n.byteLength){if(t>n.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${n.byteLength}`);n=n.subarray(0,t)}return HT(e,n)}function hre(n){return async e=>new Uint8Array(await crypto.subtle.digest(n,e))}const Tu=ure({name:"sha2-256",code:18,encode:hre("SHA-256")}),ou=async(n,e,t)=>{t.codec==null&&(t.codec=Sp);const r=await Tu.digest(n),i=Ke.create(t.cidVersion,t.codec.code,r);return await e.put(i,n,t),i};function fre(n){return async function*(t,r){let i=0n;for await(let s of t.content)yield async()=>{var c;let o;const a={codec:Sp,cidVersion:n.cidVersion,onProgress:n.onProgress};n.rawLeaves?(a.codec=Tne,a.cidVersion=1):(o=new Oe({type:n.leafType,data:s}),s=Rt({Data:o.marshal(),Links:[]}));const l=await ou(s,r,a);return i+=BigInt(s.byteLength),(c=n.onProgress)==null||c.call(n,new se("unixfs:importer:progress:file:write",{bytesWritten:i,cid:l,path:t.path})),{cid:l,unixfs:o,size:BigInt(s.length),block:s}}}}var ys;let pre=(ys=class extends Error{constructor(t="Invalid parameters"){super(t);h(this,"name",ys.name);h(this,"code",ys.code)}},h(ys,"name","InvalidParametersError"),h(ys,"code","ERR_INVALID_PARAMS"),ys);const Fl=class Fl extends Error{constructor(t="Invalid content"){super(t);h(this,"name",Fl.name);h(this,"code",Fl.code)}};h(Fl,"name","InvalidContentError"),h(Fl,"code","ERR_INVALID_CONTENT");let au=Fl;const gre=async(n,e,t)=>{const r=new Oe({type:"directory",mtime:n.mtime,mode:n.mode}),i=Rt(hr({Data:r.marshal()})),s=await ou(i,e,t),o=n.path;return{cid:s,path:o,unixfs:r,size:BigInt(i.length),originalPath:n.originalPath,block:i}};async function*yre(n,e,t){let r=-1,i;for await(const s of MT(t.bufferImporter(n,e),t.blockWriteConcurrency)){if(r++,r===0){i={...s,single:!0};continue}else r===1&&i!=null&&(yield{...i,block:void 0,single:void 0},i=void 0);yield{...s,block:void 0}}i!=null&&(yield i)}function Lv(n){return n.single===!0}const mre=(n,e,t)=>async function(i){var u,d;if(i.length===1&&Lv(i[0])&&t.reduceSingleLeafToSelf){const f=i[0];let p=f.block;return Lv(f)&&(n.mtime!==void 0||n.mode!==void 0)&&(f.unixfs=new Oe({type:"file",mtime:n.mtime,mode:n.mode,data:f.block}),p={Data:f.unixfs.marshal(),Links:[]},f.block=Rt(hr(p)),f.cid=await ou(f.block,e,{...t,cidVersion:t.cidVersion}),f.size=BigInt(f.block.length)),(u=t.onProgress)==null||u.call(t,new se("unixfs:importer:progress:file:layout",{cid:f.cid,path:f.originalPath})),{cid:f.cid,path:n.path,unixfs:f.unixfs,size:f.size,originalPath:f.originalPath}}const s=new Oe({type:"file",mtime:n.mtime,mode:n.mode}),o=i.filter(f=>{var p,y;return f.cid.code===Ds&&f.size>0||f.unixfs!=null&&f.unixfs.data==null&&f.unixfs.fileSize()>0n?!0:!!((y=(p=f.unixfs)==null?void 0:p.data)!=null&&y.length)}).map(f=>{var p,y;return f.cid.code===Ds?(s.addBlockSize(f.size),{Name:"",Tsize:Number(f.size),Hash:f.cid}):(((p=f.unixfs)==null?void 0:p.data)==null?s.addBlockSize(((y=f.unixfs)==null?void 0:y.fileSize())??0n):s.addBlockSize(BigInt(f.unixfs.data.length)),{Name:"",Tsize:Number(f.size),Hash:f.cid})}),a={Data:s.marshal(),Links:o},l=Rt(hr(a)),c=await ou(l,e,t);return(d=t.onProgress)==null||d.call(t,new se("unixfs:importer:progress:file:layout",{cid:c,path:n.originalPath})),{cid:c,path:n.path,unixfs:s,size:BigInt(l.length+a.Links.reduce((f,p)=>f+(p.Tsize??0),0)),originalPath:n.originalPath,block:l}},wre=async(n,e,t)=>t.layout(yre(n,e,t),mre(n,e,t));function vre(n){return Symbol.iterator in n}function Ere(n){return Symbol.asyncIterator in n}function bre(n){try{if(n instanceof Uint8Array)return async function*(){yield n}();if(vre(n))return async function*(){yield*n}();if(Ere(n))return n}catch{throw new au("Content was invalid")}throw new au("Content was invalid")}function _re(n){return async function*(t,r){for await(const i of t){let s;if(i.path!=null&&(s=i.path,i.path=i.path.split("/").filter(o=>o!=null&&o!==".").join("/")),Sre(i)){const o={path:i.path,mtime:i.mtime,mode:i.mode,content:async function*(){var c;let l=0n;for await(const u of n.chunker(n.chunkValidator(bre(i.content)))){const d=BigInt(u.byteLength);l+=d,(c=n.onProgress)==null||c.call(n,new se("unixfs:importer:progress:file:read",{bytesRead:l,chunkSize:d,path:i.path})),yield u}}(),originalPath:s},a=n.fileBuilder??wre;yield async()=>a(o,r,n)}else if(i.path!=null){const o={path:i.path,mtime:i.mtime,mode:i.mode,originalPath:s},a=n.dirBuilder??gre;yield async()=>a(o,r,n)}else throw new Error("Import candidate must have content or path or both")}}}function Sre(n){return n.content!=null}const xre=()=>async function*(e){for await(const t of e){if(t.length===void 0)throw new au("Content was invalid");if(typeof t=="string"||t instanceof String)yield Y(t.toString());else if(Array.isArray(t))yield Uint8Array.from(t);else if(t instanceof Uint8Array)yield t;else throw new au("Content was invalid")}},kre=174;function WT(n){const e=(n==null?void 0:n.maxChildrenPerNode)??kre;return async function t(r,i){const s=[];for await(const o of BT(r,e))s.push(await i(o));return s.length>1?t(s,i):s[0]}}let Ah=class{constructor(e,t){h(this,"options");h(this,"root");h(this,"dir");h(this,"path");h(this,"dirty");h(this,"flat");h(this,"parent");h(this,"parentKey");h(this,"unixfs");h(this,"mode");h(this,"mtime");h(this,"cid");h(this,"size");h(this,"nodeSize");this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}};const Py=Ke.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),Oy=Ke.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");class G5 extends Ah{constructor(t,r){super(t,r);h(this,"_children");this._children=new Map}async put(t,r){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,this._children.set(t,r)}async get(t){return Promise.resolve(this._children.get(t))}childCount(){return this._children.size}directChildrenCount(){return this.childCount()}onlyChild(){return this._children.values().next().value}*eachChildSeries(){for(const[t,r]of this._children.entries())yield{key:t,child:r}}estimateNodeSize(){if(this.nodeSize!==void 0)return this.nodeSize;this.nodeSize=0;for(const[t,r]of this._children.entries())r.size!=null&&r.cid!=null&&(this.nodeSize+=t.length+(this.options.cidVersion===1?Oy.bytes.byteLength:Py.bytes.byteLength));return this.nodeSize}async*flush(t){const r=[];for(const[c,u]of this._children.entries()){let d=u;if(u instanceof Ah)for await(const f of u.flush(t))d=f,yield f;d.size!=null&&d.cid!=null&&r.push({Name:c,Tsize:Number(d.size),Hash:d.cid})}const i=new Oe({type:"directory",mtime:this.mtime,mode:this.mode}),s={Data:i.marshal(),Links:r},o=Rt(hr(s)),a=await ou(o,t,this.options),l=o.length+s.Links.reduce((c,u)=>c+(u.Tsize??0),0);this.cid=a,this.size=l,yield{cid:a,unixfs:i,path:this.path,size:BigInt(l)}}}const Fp=C6({name:"murmur3-128",code:34,encode:n=>y$(wh.x64.hash128(n))}),a1=7;var Rre=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(e,t){let r=this._internalPositionFor(e,!1);if(t===void 0)r!==-1&&(this._unsetInternalPos(r),this._unsetBit(e),this._changedLength=!0,this._changedData=!0);else{let i=!1;r===-1?(r=this._data.length,this._setBit(e),this._changedData=!0):i=!0,this._setInternalPos(r,e,t,i),this._changedLength=!0}}unset(e){this.set(e,void 0)}get(e){this._sortData();const t=this._internalPositionFor(e,!0);if(t!==-1)return this._data[t][1]}push(e){return this.set(this.length,e),this.length}get length(){if(this._sortData(),this._changedLength){const e=this._data[this._data.length-1];this._length=e?e[0]+1:0,this._changedLength=!1}return this._length}forEach(e){let t=0;for(;t<this.length;)e(this.get(t),t,this),t++}map(e){let t=0,r=new Array(this.length);for(;t<this.length;)r[t]=e(this.get(t),t,this),t++;return r}reduce(e,t){let r=0,i=t;for(;r<this.length;){const s=this.get(r);i=e(i,s,r),r++}return i}find(e){let t=0,r,i;for(;t<this.length&&!r;)i=this.get(t),r=e(i),t++;return r?i:void 0}_internalPositionFor(e,t){const r=this._bytePosFor(e,t);if(r>=this._bitArrays.length)return-1;const i=this._bitArrays[r],s=e-r*a1;if(!((i&1<<s)>0))return-1;const a=this._bitArrays.slice(0,r).reduce(Are,0),l=~(4294967295<<s+1),c=GT(i&l);return a+c-1}_bytePosFor(e,t){const r=Math.floor(e/a1),i=r+1;for(;!t&&this._bitArrays.length<i;)this._bitArrays.push(0);return r}_setBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]|=1<<e-t*a1}_unsetBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]&=~(1<<e-t*a1)}_setInternalPos(e,t,r,i){const s=this._data,o=[t,r];if(i)this._sortData(),s[e]=o;else{if(s.length)if(s[s.length-1][0]>=t)s.push(o);else if(s[0][0]<=t)s.unshift(o);else{const a=Math.round(s.length/2);this._data=s.slice(0,a).concat(o).concat(s.slice(a))}else this._data.push(o);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(e){this._data.splice(e,1)}_sortData(){this._changedData&&this._data.sort(Ire),this._changedData=!1}bitField(){const e=[];let t=8,r=0,i=0,s;const o=this._bitArrays.slice();for(;o.length||r;){r===0&&(s=o.shift(),r=7);const l=Math.min(r,t),c=~(255<<l),u=s&c;i|=u<<8-t,s=s>>>l,r-=l,t-=l,(!t||!r&&!o.length)&&(e.push(i),i=0,t=8)}for(var a=e.length-1;a>0&&e[a]===0;a--)e.pop();return e}compactArray(){return this._sortData(),this._data.map(Cre)}};function Are(n,e){return n+GT(e)}function GT(n){let e=n;return e=e-(e>>1&1431655765),e=(e&858993459)+(e>>2&858993459),(e+(e>>4)&252645135)*16843009>>24}function Ire(n,e){return n[0]-e[0]}function Cre(n){return n[1]}const _2=ci(Rre);let ll=class Js{constructor(e,t,r=0){h(this,"_options");h(this,"_popCount");h(this,"_parent");h(this,"_posAtParent");h(this,"_children");h(this,"key");this._options=e,this._popCount=0,this._parent=t,this._posAtParent=r,this._children=new _2,this.key=null}async put(e,t){const r=await this._findNewBucketAndPos(e);r.bucket._putAt(r,e,t)}async get(e){const t=await this._findChild(e);if(t!=null)return t.value}async del(e){const t=await this._findPlace(e),r=t.bucket._at(t.pos);r!=null&&r.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce((t,r)=>r instanceof Js?t+r.leafCount():t+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){const e=this._children.compactArray();for(const t of e)t instanceof Js?yield*t.eachLeafSeries():yield t}serialize(e,t){const r=[];return t(this._children.reduce((i,s,o)=>(s!=null&&(s instanceof Js?i.push(s.serialize(e,t)):i.push(e(s,o))),i),r))}async asyncTransform(e,t){return qT(this,e,t)}toJSON(){return this.serialize(Nre,Dre)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){const t=await this._findPlace(e),r=t.bucket._at(t.pos);if(!(r instanceof Js)&&r!=null&&r.key===e)return r}async _findPlace(e){const t=this._options.hash(typeof e=="string"?Y(e):e),r=await t.take(this._options.bits),i=this._children.get(r);return i instanceof Js?i._findPlace(t):{bucket:this,pos:r,hash:t,existingChild:i}}async _findNewBucketAndPos(e){const t=await this._findPlace(e);if(t.existingChild!=null&&t.existingChild.key!==e){const r=new Js(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,r);const i=await r._findPlace(t.existingChild.hash);return i.bucket._putAt(i,t.existingChild.key,t.existingChild.value),r._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,r){this._putObjectAt(e.pos,{key:t,value:r,hash:e.hash})}_putObjectAt(e,t){this._children.get(e)==null&&this._popCount++,this._children.set(e,t)}_delAt(e){if(e===-1)throw new Error("Invalid position");this._children.get(e)!=null&&this._popCount--,this._children.unset(e),this._level()}_level(){if(this._parent!=null&&this._popCount<=1)if(this._popCount===1){const e=this._children.find(Tre);if(e!=null&&!(e instanceof Js)){const t=e.hash;t.untake(this._options.bits);const r={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(r,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}};function Tre(n){return!!n}function Nre(n,e){return n.key}function Dre(n){return n}async function qT(n,e,t){const r=[];for(const i of n._children.compactArray())if(i instanceof ll)await qT(i,e,t);else{const s=await e(i);r.push({bitField:n._children.bitField(),children:s})}return t(r)}const Pre=[255,254,252,248,240,224,192,128],Ore=[1,3,7,15,31,63,127,255];let Lre=class{constructor(e){h(this,"_value");h(this,"_currentBytePos");h(this,"_currentBitPos");this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,r=0;for(;t>0&&this._haveBits();){const i=this._value[this._currentBytePos],s=this._currentBitPos+1,o=Math.min(s,t),a=Bre(i,s-o,o);r=(r<<o)+a,t-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return r}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}};function Bre(n,e,t){const r=Mre(e,t);return(n&r)>>>e}function Mre(n,e){return Pre[n]&Ore[Math.min(e+n-1,7)]}function $re(n){function e(t){return t instanceof Bv?t:new Bv(t,n)}return e}let Bv=class{constructor(e,t){h(this,"_value");h(this,"_hashFn");h(this,"_depth");h(this,"_availableBits");h(this,"_currentBufferIndex");h(this,"_buffers");if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let r=0;for(;t>0;){const i=this._buffers[this._currentBufferIndex],s=Math.min(i.availableBits(),t),o=i.take(s);r=(r<<s)+o,t-=s,this._availableBits-=s,i.availableBits()===0&&this._currentBufferIndex++}return r}untake(e){let t=e;for(;t>0;){const r=this._buffers[this._currentBufferIndex],i=Math.min(r.totalBits()-r.availableBits(),t);r.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&r.totalBits()===r.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?vn([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),r=new Lre(t);this._buffers.push(r),this._availableBits+=r.availableBits()}};function q5(n){if(n==null||n.hashFn==null)throw new Error("please define an options.hashFn");const e={bits:n.bits??8,hash:$re(n.hashFn)};return new ll(e)}async function Ure(n){return(await Fp.encode(n)).slice(0,8).reverse()}const jT=BigInt(34),Fre=8;let zre=class extends Ah{constructor(t,r){super(t,r);h(this,"_bucket");this._bucket=q5({hashFn:Ure,bits:r.shardFanoutBits??Fre})}async put(t,r){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(t,r)}async get(t){return this._bucket.get(t)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}*eachChildSeries(){for(const{key:t,value:r}of this._bucket.eachLeafSeries())yield{key:t,child:r}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=QT(this._bucket,this,this.options),this.nodeSize)}async*flush(t){for await(const r of YT(this._bucket,t,this,this.options))yield{...r,path:this.path}}};async function*YT(n,e,t,r){const i=n._children,s=(n.tableSize()-1).toString(16).length,o=[];let a=0n;for(let y=0;y<i.length;y++){const g=i.get(y);if(g==null)continue;const w=y.toString(16).toUpperCase().padStart(s,"0");if(g instanceof ll){let m;for await(const E of YT(g,e,null,r))m=E;if(m==null)throw new Error("Could not flush sharded directory, no subshard found");o.push({Name:w,Tsize:Number(m.size),Hash:m.cid}),a+=m.size}else if(Vre(g.value)){const m=g.value;let E;for await(const b of m.flush(e))E=b,yield E;if(E==null)throw new Error("Did not flush dir");const v=w+g.key;o.push({Name:v,Tsize:Number(E.size),Hash:E.cid}),a+=E.size}else{const m=g.value;if(m.cid==null)continue;const E=w+g.key,v=m.size;o.push({Name:E,Tsize:Number(v),Hash:m.cid}),a+=BigInt(v??0)}}const l=Uint8Array.from(i.bitField().reverse()),c=new Oe({type:"hamt-sharded-directory",data:l,fanout:BigInt(n.tableSize()),hashType:jT,mtime:t==null?void 0:t.mtime,mode:t==null?void 0:t.mode}),u={Data:c.marshal(),Links:o},d=Rt(hr(u)),f=await ou(d,e,r),p=BigInt(d.byteLength)+a;yield{cid:f,unixfs:c,size:p}}function Vre(n){return typeof n.flush=="function"}function QT(n,e,t){const r=n._children,i=(n.tableSize()-1).toString(16).length,s=[];for(let c=0;c<r.length;c++){const u=r.get(c);if(u==null)continue;const d=c.toString(16).toUpperCase().padStart(i,"0");if(u instanceof ll){const f=QT(u,null,t);s.push({Name:d,Tsize:Number(f),Hash:t.cidVersion===0?Py:Oy})}else if(typeof u.value.flush=="function"){const p=u.value.nodeSize();s.push({Name:d+u.key,Tsize:Number(p),Hash:t.cidVersion===0?Py:Oy})}else{const f=u.value;if(f.cid==null)continue;const p=d+u.key,y=f.size;s.push({Name:p,Tsize:Number(y),Hash:f.cid})}}const o=Uint8Array.from(r.bitField().reverse()),a=new Oe({type:"hamt-sharded-directory",data:o,fanout:BigInt(n.tableSize()),hashType:jT,mtime:e==null?void 0:e.mtime,mode:e==null?void 0:e.mode});return Rt(hr({Data:a.marshal(),Links:s})).length}async function XT(n,e,t,r){let i=e;e instanceof G5&&e.estimateNodeSize()>t&&(i=await Hre(e,r));const s=i.parent;if(s!=null){if(i!==e){if(n!=null&&(n.parent=i),i.parentKey==null)throw new Error("No parent key found");await s.put(i.parentKey,i)}return XT(i,s,t,r)}return i}async function Hre(n,e){const t=new zre({root:n.root,dir:!0,parent:n.parent,parentKey:n.parentKey,path:n.path,dirty:n.dirty,flat:!1,mtime:n.mtime,mode:n.mode},e);for(const{key:r,child:i}of n.eachChildSeries())await t.put(r,i);return t}const Kre=(n="")=>n.split(new RegExp("(?<!\\\\)\\/")).filter(Boolean);async function Wre(n,e,t){var a,l;const r=Kre(n.path??""),i=r.length-1;let s=e,o="";for(let c=0;c<r.length;c++){const u=r[c];o+=`${o!==""?"/":""}${u}`;const d=c===i;if(s.dirty=!0,s.cid=void 0,s.size=void 0,d)await s.put(u,n),e=await XT(null,s,t.shardSplitThresholdBytes,t);else{let f=await s.get(u);(f==null||!(f instanceof Ah))&&(f=new G5({root:!1,dir:!0,parent:s,parentKey:u,path:o,dirty:!0,flat:!0,mtime:(a=f==null?void 0:f.unixfs)==null?void 0:a.mtime,mode:(l=f==null?void 0:f.unixfs)==null?void 0:l.mode},t)),await s.put(u,f),s=f}}return e}async function*Mv(n,e){var t;if(!(n instanceof Ah)){((t=n.unixfs)==null?void 0:t.isDirectory())===!0&&(yield n);return}yield*n.flush(e)}function Gre(n){return async function*(t,r){var a;let i=new G5({root:!0,dir:!0,path:"",dirty:!0,flat:!0},n),s,o=!1;for await(const l of t){if(l==null)continue;const c=`${l.originalPath??""}`.split("/")[0];c!=null&&c!==""&&(s==null?(s=c,o=!0):s!==c&&(o=!1)),i=await Wre(l,i,n),((a=l.unixfs)==null?void 0:a.isDirectory())!==!0&&(yield l)}if(n.wrapWithDirectory||o&&i.childCount()>1)yield*Mv(i,r);else for(const l of i.eachChildSeries())l!=null&&(yield*Mv(l.child,r))}}async function*zp(n,e,t={}){let r;Symbol.asyncIterator in n||Symbol.iterator in n?r=n:r=[n];const i=t.wrapWithDirectory??!1,s=t.shardSplitThresholdBytes??262144,o=t.shardFanoutBits??8,a=t.cidVersion??1,l=t.rawLeaves??!0,c=t.leafType??"file",u=t.fileImportConcurrency??50,d=t.blockWriteConcurrency??10,f=t.reduceSingleLeafToSelf??!0,p=t.chunker??$T(),y=t.chunkValidator??xre(),g=t.dagBuilder??_re({chunker:p,chunkValidator:y,wrapWithDirectory:i,layout:t.layout??WT(),bufferImporter:t.bufferImporter??fre({cidVersion:a,rawLeaves:l,leafType:c,onProgress:t.onProgress}),blockWriteConcurrency:d,reduceSingleLeafToSelf:f,cidVersion:a,onProgress:t.onProgress,dirBuilder:t.dirBuilder,fileBuilder:t.fileBuilder}),w=t.treeBuilder??Gre({wrapWithDirectory:i,shardSplitThresholdBytes:s,shardFanoutBits:o,cidVersion:a,onProgress:t.onProgress});for await(const m of w(MT(g(r,e),u),e))yield{cid:m.cid,path:m.path,unixfs:m.unixfs,size:m.size}}async function JT(n,e,t={}){const r=await qc(zp([n],e,t));if(r==null)throw new pre("Nothing imported");return r}async function qre(n,e,t={}){return JT({content:n},e,t)}async function jre(n,e,t={}){return JT({content:n},e,t)}function Yre(n){return n[Symbol.asyncIterator]!=null}function Nu(n){if(Yre(n))return(async()=>{let t;for await(const r of n)t=r;return t})();let e;for(const t of n)e=t;return e}class Fs extends Error{constructor(t,r,i){super(t);h(this,"name");h(this,"code");this.name=r,this.code=i}}let Vp=class extends Fs{constructor(e="not a Unixfs node"){super(e,"NotUnixFSError","ERR_NOT_UNIXFS")}};class Ya extends Fs{constructor(e="invalid PBNode"){super(e,"InvalidPBNodeError","ERR_INVALID_PB_NODE")}}class j5 extends Fs{constructor(e="unknown error"){super(e,"InvalidPBNodeError","ERR_UNKNOWN_ERROR")}}class ZT extends Fs{constructor(e="path already exists"){super(e,"AlreadyExistsError","ERR_ALREADY_EXISTS")}}class Qre extends Fs{constructor(e="path does not exist"){super(e,"DoesNotExistError","ERR_DOES_NOT_EXIST")}}class Xre extends Fs{constructor(e="no content"){super(e,"NoContentError","ERR_NO_CONTENT")}}class Jre extends Fs{constructor(e="not a file"){super(e,"NotAFileError","ERR_NOT_A_FILE")}}class eN extends Fs{constructor(e="not a directory"){super(e,"NotADirectoryError","ERR_NOT_A_DIRECTORY")}}let ai=class extends Fs{constructor(e="invalid parameters"){super(e,"InvalidParametersError","ERR_INVALID_PARAMETERS")}};const uf={cidVersion:1,rawLeaves:!0,layout:WT({maxChildrenPerNode:1024}),chunker:$T({chunkSize:1048576})};async function*Y5(n,e,t={}){yield*zp(n,e,{...uf,...t})}async function Zre(n,e,t={}){const{cid:r}=await qre(n,e,{...uf,...t});return r}async function eie(n,e,t={}){const{cid:r}=await jre(n,e,{...uf,...t});return r}async function tie(n,e,t={}){if(n.path==null)throw new ai("path is required");if(n.content==null)throw new ai("content is required");const r=await Nu(Y5([n],e,{...uf,...t,wrapWithDirectory:!0}));if(r==null)throw new ai("Nothing imported");return r.cid}async function nie(n,e,t={}){if(n.content!=null)throw new ai("Directories cannot have content, use addFile instead");const i=await(n.path==null?qc:Nu)(Y5([{...n,path:n.path??"-"}],e,{...uf,...t,wrapWithDirectory:n.path!=null}));if(i==null)throw new ai("Nothing imported");return i.cid}const zl=class zl extends Error{constructor(t="Bad path"){super(t);h(this,"name",zl.name);h(this,"code",zl.code)}};h(zl,"name","BadPathError"),h(zl,"code","ERR_BAD_PATH");let S2=zl;const Vl=class Vl extends Error{constructor(t="Not found"){super(t);h(this,"name",Vl.name);h(this,"code",Vl.code)}};h(Vl,"name","NotFoundError"),h(Vl,"code","ERR_NOT_FOUND");let Uo=Vl;const Hl=class Hl extends Error{constructor(t="No resolver"){super(t);h(this,"name",Hl.name);h(this,"code",Hl.code)}};h(Hl,"name","NoResolverError"),h(Hl,"code","ERR_NO_RESOLVER");let x2=Hl;const Kl=class Kl extends Error{constructor(t="Not UnixFS"){super(t);h(this,"name",Kl.name);h(this,"code",Kl.code)}};h(Kl,"name","NotUnixFSError"),h(Kl,"code","ERR_NOT_UNIXFS");let Ut=Kl;const Wl=class Wl extends Error{constructor(t="Over read"){super(t);h(this,"name",Wl.name);h(this,"code",Wl.code)}};h(Wl,"name","OverReadError"),h(Wl,"code","ERR_OVER_READ");let Ly=Wl;const Gl=class Gl extends Error{constructor(t="Under read"){super(t);h(this,"name",Gl.name);h(this,"code",Gl.code)}};h(Gl,"name","UnderReadError"),h(Gl,"code","ERR_UNDER_READ");let By=Gl;const ql=class ql extends Error{constructor(t="Invalid parameters"){super(t);h(this,"name",ql.name);h(this,"code",ql.code)}};h(ql,"name","InvalidParametersError"),h(ql,"code","ERR_INVALID_PARAMS");let wa=ql;const rie=["Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function iie(n){if(n===null)return"null";if(n===void 0)return"undefined";if(n===!0||n===!1)return"boolean";const e=typeof n;if(e==="string"||e==="number"||e==="bigint"||e==="symbol")return e;if(e==="function")return"Function";if(Array.isArray(n))return"Array";if(n instanceof Uint8Array)return"Uint8Array";if(n.constructor===Object)return"Object";const t=sie(n);return t||"Object"}function sie(n){const e=Object.prototype.toString.call(n).slice(8,-1);if(rie.includes(e))return e}class B{constructor(e,t,r){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=r}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}static equals(e,t){return e===t||e.major===t.major&&e.name===t.name}}B.uint=new B(0,"uint",!0);B.negint=new B(1,"negint",!0);B.bytes=new B(2,"bytes",!0);B.string=new B(3,"string",!0);B.array=new B(4,"array",!1);B.map=new B(5,"map",!1);B.tag=new B(6,"tag",!1);B.float=new B(7,"float",!0);B.false=new B(7,"false",!0);B.true=new B(7,"true",!0);B.null=new B(7,"null",!0);B.undefined=new B(7,"undefined",!0);B.break=new B(7,"break",!0);class ee{constructor(e,t,r){this.type=e,this.value=t,this.encodedLength=r,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const tN=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",oie=new TextEncoder;function My(n){return tN&&globalThis.Buffer.isBuffer(n)}function nN(n){return n instanceof Uint8Array?My(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):n:Uint8Array.from(n)}const aie=24,lie=200,rN=tN?n=>n.length>=aie?globalThis.Buffer.from(n):$v(n):n=>n.length>=lie?oie.encode(n):$v(n);function cie(n,e){if(My(n)&&My(e))return n.compare(e);for(let t=0;t<n.length;t++)if(n[t]!==e[t])return n[t]<e[t]?-1:1;return 0}function $v(n){const e=[];let t=0;for(let r=0;r<n.length;r++){let i=n.charCodeAt(r);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&r+1<n.length&&(n.charCodeAt(r+1)&64512)===56320?(i=65536+((i&1023)<<10)+(n.charCodeAt(++r)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(i>=55296&&i<=57343&&(i=65533),e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e}const Uv=4096;function uie(n){const e=n.length;if(e<=Uv)return String.fromCharCode.apply(String,n);let t="",r=0;for(;r<e;)t+=String.fromCharCode.apply(String,n.slice(r,r+=Uv));return t}const fe="CBOR decode error:",k2="CBOR encode error:";function Du(n,e,t){if(n.length-e<t)throw new Error(`${fe} not enough data for type`)}const Xt=[24,256,65536,4294967296,BigInt("18446744073709551616")];function cl(n,e,t){Du(n,e,1);const r=n[e];if(t.strict===!0&&r<Xt[0])throw new Error(`${fe} integer encoded in more bytes than necessary (strict decode)`);return r}function ul(n,e,t){Du(n,e,2);const r=n[e]<<8|n[e+1];if(t.strict===!0&&r<Xt[1])throw new Error(`${fe} integer encoded in more bytes than necessary (strict decode)`);return r}function dl(n,e,t){Du(n,e,4);const r=n[e]*16777216+(n[e+1]<<16)+(n[e+2]<<8)+n[e+3];if(t.strict===!0&&r<Xt[2])throw new Error(`${fe} integer encoded in more bytes than necessary (strict decode)`);return r}function hl(n,e,t){Du(n,e,8);const r=n[e]*16777216+(n[e+1]<<16)+(n[e+2]<<8)+n[e+3],i=n[e+4]*16777216+(n[e+5]<<16)+(n[e+6]<<8)+n[e+7],s=(BigInt(r)<<BigInt(32))+BigInt(i);if(t.strict===!0&&s<Xt[3])throw new Error(`${fe} integer encoded in more bytes than necessary (strict decode)`);if(s<=Number.MAX_SAFE_INTEGER)return Number(s);if(t.allowBigInt===!0)return s;throw new Error(`${fe} integers outside of the safe integer range are not supported`)}function die(n,e,t,r){return new ee(B.uint,cl(n,e+1,r),2)}function hie(n,e,t,r){return new ee(B.uint,ul(n,e+1,r),3)}function fie(n,e,t,r){return new ee(B.uint,dl(n,e+1,r),5)}function pie(n,e,t,r){return new ee(B.uint,hl(n,e+1,r),9)}function fl(n,e){return Fr(n,0,e.value)}function Fr(n,e,t){if(t<Xt[0]){const r=Number(t);n.push([e|r])}else if(t<Xt[1]){const r=Number(t);n.push([e|24,r])}else if(t<Xt[2]){const r=Number(t);n.push([e|25,r>>>8,r&255])}else if(t<Xt[3]){const r=Number(t);n.push([e|26,r>>>24&255,r>>>16&255,r>>>8&255,r&255])}else{const r=BigInt(t);if(r<Xt[4]){const i=[e|27,0,0,0,0,0,0,0];let s=Number(r&BigInt(4294967295)),o=Number(r>>BigInt(32)&BigInt(4294967295));i[8]=s&255,s=s>>8,i[7]=s&255,s=s>>8,i[6]=s&255,s=s>>8,i[5]=s&255,i[4]=o&255,o=o>>8,i[3]=o&255,o=o>>8,i[2]=o&255,o=o>>8,i[1]=o&255,n.push(i)}else throw new Error(`${fe} encountered BigInt larger than allowable range`)}}fl.encodedSize=function(e){return Fr.encodedSize(e.value)};Fr.encodedSize=function(e){return e<Xt[0]?1:e<Xt[1]?2:e<Xt[2]?3:e<Xt[3]?5:9};fl.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function gie(n,e,t,r){return new ee(B.negint,-1-cl(n,e+1,r),2)}function yie(n,e,t,r){return new ee(B.negint,-1-ul(n,e+1,r),3)}function mie(n,e,t,r){return new ee(B.negint,-1-dl(n,e+1,r),5)}const Q5=BigInt(-1),iN=BigInt(1);function wie(n,e,t,r){const i=hl(n,e+1,r);if(typeof i!="bigint"){const s=-1-i;if(s>=Number.MIN_SAFE_INTEGER)return new ee(B.negint,s,9)}if(r.allowBigInt!==!0)throw new Error(`${fe} integers outside of the safe integer range are not supported`);return new ee(B.negint,Q5-BigInt(i),9)}function X5(n,e){const t=e.value,r=typeof t=="bigint"?t*Q5-iN:t*-1-1;Fr(n,e.type.majorEncoded,r)}X5.encodedSize=function(e){const t=e.value,r=typeof t=="bigint"?t*Q5-iN:t*-1-1;return r<Xt[0]?1:r<Xt[1]?2:r<Xt[2]?3:r<Xt[3]?5:9};X5.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function df(n,e,t,r){Du(n,e,t+r);const i=n.slice(e+t,e+t+r);return new ee(B.bytes,i,t+r)}function vie(n,e,t,r){return df(n,e,1,t)}function Eie(n,e,t,r){return df(n,e,2,cl(n,e+1,r))}function bie(n,e,t,r){return df(n,e,3,ul(n,e+1,r))}function _ie(n,e,t,r){return df(n,e,5,dl(n,e+1,r))}function Sie(n,e,t,r){const i=hl(n,e+1,r);if(typeof i=="bigint")throw new Error(`${fe} 64-bit integer bytes lengths not supported`);return df(n,e,9,i)}function R2(n){return n.encodedBytes===void 0&&(n.encodedBytes=B.equals(n.type,B.string)?rN(n.value):n.value),n.encodedBytes}function Hp(n,e){const t=R2(e);Fr(n,e.type.majorEncoded,t.length),n.push(t)}Hp.encodedSize=function(e){const t=R2(e);return Fr.encodedSize(t.length)+t.length};Hp.compareTokens=function(e,t){return xie(R2(e),R2(t))};function xie(n,e){return n.length<e.length?-1:n.length>e.length?1:cie(n,e)}const Fv=new TextDecoder,kie=32;function Rie(n,e,t){if(t-e<kie){let i="";for(let s=e;s<t;s++){const o=n[s];if(o&128)return Fv.decode(n.subarray(e,t));i+=String.fromCharCode(o)}return i}return Fv.decode(n.subarray(e,t))}function hf(n,e,t,r,i){const s=t+r;Du(n,e,s);const o=new ee(B.string,Rie(n,e+t,e+s),s);return i.retainStringBytes===!0&&(o.byteValue=n.slice(e+t,e+s)),o}function Aie(n,e,t,r){return hf(n,e,1,t,r)}function Iie(n,e,t,r){return hf(n,e,2,cl(n,e+1,r),r)}function Cie(n,e,t,r){return hf(n,e,3,ul(n,e+1,r),r)}function Tie(n,e,t,r){return hf(n,e,5,dl(n,e+1,r),r)}function Nie(n,e,t,r){const i=hl(n,e+1,r);if(typeof i=="bigint")throw new Error(`${fe} 64-bit integer string lengths not supported`);return hf(n,e,9,i,r)}const Die=Hp;function Pu(n,e,t,r){return new ee(B.array,r,t)}function Pie(n,e,t,r){return Pu(n,e,1,t)}function Oie(n,e,t,r){return Pu(n,e,2,cl(n,e+1,r))}function Lie(n,e,t,r){return Pu(n,e,3,ul(n,e+1,r))}function Bie(n,e,t,r){return Pu(n,e,5,dl(n,e+1,r))}function Mie(n,e,t,r){const i=hl(n,e+1,r);if(typeof i=="bigint")throw new Error(`${fe} 64-bit integer array lengths not supported`);return Pu(n,e,9,i)}function $ie(n,e,t,r){if(r.allowIndefinite===!1)throw new Error(`${fe} indefinite length items not allowed`);return Pu(n,e,1,1/0)}function J5(n,e){Fr(n,B.array.majorEncoded,e.value)}J5.compareTokens=fl.compareTokens;J5.encodedSize=function(e){return Fr.encodedSize(e.value)};function Ou(n,e,t,r){return new ee(B.map,r,t)}function Uie(n,e,t,r){return Ou(n,e,1,t)}function Fie(n,e,t,r){return Ou(n,e,2,cl(n,e+1,r))}function zie(n,e,t,r){return Ou(n,e,3,ul(n,e+1,r))}function Vie(n,e,t,r){return Ou(n,e,5,dl(n,e+1,r))}function Hie(n,e,t,r){const i=hl(n,e+1,r);if(typeof i=="bigint")throw new Error(`${fe} 64-bit integer map lengths not supported`);return Ou(n,e,9,i)}function Kie(n,e,t,r){if(r.allowIndefinite===!1)throw new Error(`${fe} indefinite length items not allowed`);return Ou(n,e,1,1/0)}function Z5(n,e){Fr(n,B.map.majorEncoded,e.value)}Z5.compareTokens=fl.compareTokens;Z5.encodedSize=function(e){return Fr.encodedSize(e.value)};function Wie(n,e,t,r){return new ee(B.tag,t,1)}function Gie(n,e,t,r){return new ee(B.tag,cl(n,e+1,r),2)}function qie(n,e,t,r){return new ee(B.tag,ul(n,e+1,r),3)}function jie(n,e,t,r){return new ee(B.tag,dl(n,e+1,r),5)}function Yie(n,e,t,r){return new ee(B.tag,hl(n,e+1,r),9)}function e8(n,e){Fr(n,B.tag.majorEncoded,e.value)}e8.compareTokens=fl.compareTokens;e8.encodedSize=function(e){return Fr.encodedSize(e.value)};const sN=20,oN=21,aN=22,lN=23;function Qie(n,e,t,r){if(r.allowUndefined===!1)throw new Error(`${fe} undefined values are not supported`);return r.coerceUndefinedToNull===!0?new ee(B.null,null,1):new ee(B.undefined,void 0,1)}function Xie(n,e,t,r){if(r.allowIndefinite===!1)throw new Error(`${fe} indefinite length items not allowed`);return new ee(B.break,void 0,1)}function t8(n,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(n))throw new Error(`${fe} NaN values are not supported`);if(t.allowInfinity===!1&&(n===1/0||n===-1/0))throw new Error(`${fe} Infinity values are not supported`)}return new ee(B.float,n,e)}function Jie(n,e,t,r){return t8(r8(n,e+1),3,r)}function Zie(n,e,t,r){return t8(i8(n,e+1),5,r)}function ese(n,e,t,r){return t8(hN(n,e+1),9,r)}function n8(n,e,t){const r=e.value;if(r===!1)n.push([B.float.majorEncoded|sN]);else if(r===!0)n.push([B.float.majorEncoded|oN]);else if(r===null)n.push([B.float.majorEncoded|aN]);else if(r===void 0)n.push([B.float.majorEncoded|lN]);else{let i,s=!1;(!t||t.float64!==!0)&&(uN(r),i=r8(Kr,1),r===i||Number.isNaN(r)?(Kr[0]=249,n.push(Kr.slice(0,3)),s=!0):(dN(r),i=i8(Kr,1),r===i&&(Kr[0]=250,n.push(Kr.slice(0,5)),s=!0))),s||(tse(r),i=hN(Kr,1),Kr[0]=251,n.push(Kr.slice(0,9)))}}n8.encodedSize=function(e,t){const r=e.value;if(r===!1||r===!0||r===null||r===void 0)return 1;if(!t||t.float64!==!0){uN(r);let i=r8(Kr,1);if(r===i||Number.isNaN(r))return 3;if(dN(r),i=i8(Kr,1),r===i)return 5}return 9};const cN=new ArrayBuffer(9),vr=new DataView(cN,1),Kr=new Uint8Array(cN,0);function uN(n){if(n===1/0)vr.setUint16(0,31744,!1);else if(n===-1/0)vr.setUint16(0,64512,!1);else if(Number.isNaN(n))vr.setUint16(0,32256,!1);else{vr.setFloat32(0,n);const e=vr.getUint32(0),t=(e&2139095040)>>23,r=e&8388607;if(t===255)vr.setUint16(0,31744,!1);else if(t===0)vr.setUint16(0,(n&2147483648)>>16|r>>13,!1);else{const i=t-127;i<-24?vr.setUint16(0,0):i<-14?vr.setUint16(0,(e&2147483648)>>16|1<<24+i,!1):vr.setUint16(0,(e&2147483648)>>16|i+15<<10|r>>13,!1)}}}function r8(n,e){if(n.length-e<2)throw new Error(`${fe} not enough data for float16`);const t=(n[e]<<8)+n[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;const r=t>>10&31,i=t&1023;let s;return r===0?s=i*2**-24:r!==31?s=(i+1024)*2**(r-25):s=i===0?1/0:NaN,t&32768?-s:s}function dN(n){vr.setFloat32(0,n,!1)}function i8(n,e){if(n.length-e<4)throw new Error(`${fe} not enough data for float32`);const t=(n.byteOffset||0)+e;return new DataView(n.buffer,t,4).getFloat32(0,!1)}function tse(n){vr.setFloat64(0,n,!1)}function hN(n,e){if(n.length-e<8)throw new Error(`${fe} not enough data for float64`);const t=(n.byteOffset||0)+e;return new DataView(n.buffer,t,8).getFloat64(0,!1)}n8.compareTokens=fl.compareTokens;function He(n,e,t){throw new Error(`${fe} encountered invalid minor (${t}) for major ${n[e]>>>5}`)}function Kp(n){return()=>{throw new Error(`${fe} ${n}`)}}const J=[];for(let n=0;n<=23;n++)J[n]=He;J[24]=die;J[25]=hie;J[26]=fie;J[27]=pie;J[28]=He;J[29]=He;J[30]=He;J[31]=He;for(let n=32;n<=55;n++)J[n]=He;J[56]=gie;J[57]=yie;J[58]=mie;J[59]=wie;J[60]=He;J[61]=He;J[62]=He;J[63]=He;for(let n=64;n<=87;n++)J[n]=vie;J[88]=Eie;J[89]=bie;J[90]=_ie;J[91]=Sie;J[92]=He;J[93]=He;J[94]=He;J[95]=Kp("indefinite length bytes/strings are not supported");for(let n=96;n<=119;n++)J[n]=Aie;J[120]=Iie;J[121]=Cie;J[122]=Tie;J[123]=Nie;J[124]=He;J[125]=He;J[126]=He;J[127]=Kp("indefinite length bytes/strings are not supported");for(let n=128;n<=151;n++)J[n]=Pie;J[152]=Oie;J[153]=Lie;J[154]=Bie;J[155]=Mie;J[156]=He;J[157]=He;J[158]=He;J[159]=$ie;for(let n=160;n<=183;n++)J[n]=Uie;J[184]=Fie;J[185]=zie;J[186]=Vie;J[187]=Hie;J[188]=He;J[189]=He;J[190]=He;J[191]=Kie;for(let n=192;n<=215;n++)J[n]=Wie;J[216]=Gie;J[217]=qie;J[218]=jie;J[219]=Yie;J[220]=He;J[221]=He;J[222]=He;J[223]=He;for(let n=224;n<=243;n++)J[n]=Kp("simple values are not supported");J[244]=He;J[245]=He;J[246]=He;J[247]=Qie;J[248]=Kp("simple values are not supported");J[249]=Jie;J[250]=Zie;J[251]=ese;J[252]=He;J[253]=He;J[254]=He;J[255]=Xie;const Xi=[];for(let n=0;n<24;n++)Xi[n]=new ee(B.uint,n,1);for(let n=-1;n>=-24;n--)Xi[31-n]=new ee(B.negint,n,1);Xi[64]=new ee(B.bytes,new Uint8Array(0),1);Xi[96]=new ee(B.string,"",1);Xi[128]=new ee(B.array,0,1);Xi[160]=new ee(B.map,0,1);Xi[244]=new ee(B.false,!1,1);Xi[245]=new ee(B.true,!0,1);Xi[246]=new ee(B.null,null,1);function nse(){const n=[];return n[B.uint.major]=fl,n[B.negint.major]=X5,n[B.bytes.major]=Hp,n[B.string.major]=Die,n[B.array.major]=J5,n[B.map.major]=Z5,n[B.tag.major]=e8,n[B.float.major]=n8,n}nse();class A2{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${k2} object contains circular references`);return new A2(t,e)}}const Xs={null:new ee(B.null,null),undefined:new ee(B.undefined,void 0),true:new ee(B.true,!0),false:new ee(B.false,!1),emptyArray:new ee(B.array,0),emptyMap:new ee(B.map,0)},Fo={number(n,e,t,r){return!Number.isInteger(n)||!Number.isSafeInteger(n)?new ee(B.float,n):n>=0?new ee(B.uint,n):new ee(B.negint,n)},bigint(n,e,t,r){return n>=BigInt(0)?new ee(B.uint,n):new ee(B.negint,n)},Uint8Array(n,e,t,r){return new ee(B.bytes,n)},string(n,e,t,r){return new ee(B.string,n)},boolean(n,e,t,r){return n?Xs.true:Xs.false},null(n,e,t,r){return Xs.null},undefined(n,e,t,r){return Xs.undefined},ArrayBuffer(n,e,t,r){return new ee(B.bytes,new Uint8Array(n))},DataView(n,e,t,r){return new ee(B.bytes,new Uint8Array(n.buffer,n.byteOffset,n.byteLength))},Array(n,e,t,r){if(!n.length)return t.addBreakTokens===!0?[Xs.emptyArray,new ee(B.break)]:Xs.emptyArray;r=A2.createCheck(r,n);const i=[];let s=0;for(const o of n)i[s++]=w3(o,t,r);return t.addBreakTokens?[new ee(B.array,n.length),i,new ee(B.break)]:[new ee(B.array,n.length),i]},Object(n,e,t,r){const i=e!=="Object",s=i?n.keys():Object.keys(n),o=i?n.size:s.length;let a;if(o){a=new Array(o),r=A2.createCheck(r,n);const l=!i&&t.ignoreUndefinedProperties;let c=0;for(const u of s){const d=i?n.get(u):n[u];l&&d===void 0||(a[c++]=[w3(u,t,r),w3(d,t,r)])}c<o&&(a.length=c)}return a!=null&&a.length?(rse(a,t),t.addBreakTokens?[new ee(B.map,a.length),a,new ee(B.break)]:[new ee(B.map,a.length),a]):t.addBreakTokens===!0?[Xs.emptyMap,new ee(B.break)]:Xs.emptyMap}};Fo.Map=Fo.Object;Fo.Buffer=Fo.Uint8Array;for(const n of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Fo[`${n}Array`]=Fo.DataView;function w3(n,e={},t){const r=iie(n),i=e&&e.typeEncoders&&e.typeEncoders[r]||Fo[r];if(typeof i=="function"){const o=i(n,r,e,t);if(o!=null)return o}const s=Fo[r];if(!s)throw new Error(`${k2} unsupported type: ${r}`);return s(n,r,e,t)}function rse(n,e){e.mapSorter&&n.sort(e.mapSorter)}B.uint.majorEncoded;B.negint.majorEncoded;B.bytes.majorEncoded;B.string.majorEncoded;B.array.majorEncoded;B.float.majorEncoded|sN;B.float.majorEncoded|oN;B.float.majorEncoded|aN;B.float.majorEncoded|lN;BigInt(-1);BigInt(1);const ise={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class sse{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){const e=this.data[this._pos];let t=Xi[e];if(t===void 0){const r=J[e];if(!r)throw new Error(`${fe} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);const i=e&31;t=r(this.data,this._pos,i,this.options)}return this._pos+=t.encodedLength,t}}const Ih=Symbol.for("DONE"),Wp=Symbol.for("BREAK");function ose(n,e,t){const r=[];for(let i=0;i<n.value;i++){const s=Ch(e,t);if(s===Wp){if(n.value===1/0)break;throw new Error(`${fe} got unexpected break to lengthed array`)}if(s===Ih)throw new Error(`${fe} found array but not enough entries (got ${i}, expected ${n.value})`);r[i]=s}return r}function ase(n,e,t){const r=t.useMaps===!0,i=t.rejectDuplicateMapKeys===!0,s=r?void 0:{},o=r?new Map:void 0;for(let a=0;a<n.value;a++){const l=Ch(e,t);if(l===Wp){if(n.value===1/0)break;throw new Error(`${fe} got unexpected break to lengthed map`)}if(l===Ih)throw new Error(`${fe} found map but not enough entries (got ${a} [no key], expected ${n.value})`);if(!r&&typeof l!="string")throw new Error(`${fe} non-string keys not supported (got ${typeof l})`);if(i&&(r&&o.has(l)||!r&&Object.hasOwn(s,l)))throw new Error(`${fe} found repeat map key "${l}"`);const c=Ch(e,t);if(c===Ih)throw new Error(`${fe} found map but not enough entries (got ${a} [no value], expected ${n.value})`);r?o.set(l,c):s[l]=c}return r?o:s}function Ch(n,e){if(n.done())return Ih;const t=n.next();if(B.equals(t.type,B.break))return Wp;if(t.type.terminal)return t.value;if(B.equals(t.type,B.array))return ose(t,n,e);if(B.equals(t.type,B.map))return ase(t,n,e);if(B.equals(t.type,B.tag)){if(e.tags&&typeof e.tags[t.value]=="function"){const r=Ch(n,e);return e.tags[t.value](r)}throw new Error(`${fe} tag not supported (${t.value})`)}throw new Error("unsupported")}function lse(n,e){if(!(n instanceof Uint8Array))throw new Error(`${fe} data to decode must be a Uint8Array`);e=Object.assign({},ise,e);const t=nN(n),r=e.tokenizer||new sse(t,e),i=Ch(r,e);if(i===Ih)throw new Error(`${fe} did not find any content to decode`);if(i===Wp)throw new Error(`${fe} got unexpected break`);return[i,n.subarray(r.pos())]}function cse(n,e){const[t,r]=lse(n,e);if(r.length>0)throw new Error(`${fe} too many terminals, data makes no sense`);return t}class Rle extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){const t=this.inRecursive[this.inRecursive.length-1];t&&(B.equals(t.type,B.array)&&(t.elements++,t.elements!==1&&e.push([44])),B.equals(t.type,B.map)&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[B.uint.major](e,t){this.prefix(e);const r=String(t.value),i=[];for(let s=0;s<r.length;s++)i[s]=r.charCodeAt(s);e.push(i)}[B.negint.major](e,t){this[B.uint.major](e,t)}[B.bytes.major](e,t){throw new Error(`${k2} unsupported type: Uint8Array`)}[B.string.major](e,t){this.prefix(e);const r=rN(JSON.stringify(t.value));e.push(r.length>32?nN(r):r)}[B.array.major](e,t){this.prefix(e),this.inRecursive.push({type:B.array,elements:0}),e.push([91])}[B.map.major](e,t){this.prefix(e),this.inRecursive.push({type:B.map,elements:0}),e.push([123])}[B.tag.major](e,t){}[B.float.major](e,t){if(t.type.name==="break"){const o=this.inRecursive.pop();if(o){if(B.equals(o.type,B.array))e.push([93]);else if(B.equals(o.type,B.map))e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${k2} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}const r=String(t.value),i=[];let s=!1;for(let o=0;o<r.length;o++)i[o]=r.charCodeAt(o),!s&&(i[o]===46||i[o]===101||i[o]===69)&&(s=!0);s||(i.push(46),i.push(48)),e.push(i)}}class fN{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${fe} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${fe} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this._pos;let t=!1,r=!1;const i=a=>{for(;!this.done();){const l=this.ch();if(a.includes(l))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,r=!0;else return new ee(B.uint,0,this._pos-e);if(i([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${fe} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(r)throw new Error(`${fe} unexpected token at position ${this._pos}`);r=!0,this._pos++,i([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(r=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,i([48,49,50,51,52,53,54,55,56,57]));const s=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),o=parseFloat(s);return r?new ee(B.float,o,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new ee(o>=0?B.uint:B.negint,o,this._pos-e):new ee(o>=0?B.uint:B.negint,BigInt(s),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${fe} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let s=this._pos,o=0;s<this.data.length&&o<65536;s++,o++){const a=this.data[s];if(a===92||a<32||a>=128)break;if(a===34){const l=String.fromCharCode.apply(null,this.data.subarray(this._pos,s));return this._pos=s+1,new ee(B.string,l,o)}}const e=this._pos,t=[],r=()=>{if(this._pos+4>=this.data.length)throw new Error(`${fe} unexpected end of unicode escape sequence at position ${this._pos}`);let s=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${fe} unexpected unicode escape character at position ${this._pos}`);s=s*16+a,this._pos++}return s},i=()=>{const s=this.ch();let o=null,a=s>239?4:s>223?3:s>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${fe} unexpected unicode sequence at position ${this._pos}`);let l,c,u,d;switch(a){case 1:s<128&&(o=s);break;case 2:l=this.data[this._pos+1],(l&192)===128&&(d=(s&31)<<6|l&63,d>127&&(o=d));break;case 3:l=this.data[this._pos+1],c=this.data[this._pos+2],(l&192)===128&&(c&192)===128&&(d=(s&15)<<12|(l&63)<<6|c&63,d>2047&&(d<55296||d>57343)&&(o=d));break;case 4:l=this.data[this._pos+1],c=this.data[this._pos+2],u=this.data[this._pos+3],(l&192)===128&&(c&192)===128&&(u&192)===128&&(d=(s&15)<<18|(l&63)<<12|(c&63)<<6|u&63,d>65535&&d<1114112&&(o=d))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this._pos+=a};for(;!this.done();){const s=this.ch();let o;switch(s){case 92:if(this._pos++,this.done())throw new Error(`${fe} unexpected string termination at position ${this._pos}`);switch(o=this.ch(),this._pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(r());break;default:throw new Error(`${fe} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new ee(B.string,uie(t),this._pos-e);default:if(s<32)throw new Error(`${fe} invalid control character at position ${this._pos}`);s<128?(t.push(s),this._pos++):i()}}throw new Error(`${fe} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new ee(B.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new ee(B.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new ee(B.null,null,4);case 102:return this.expect([102,97,108,115,101]),new ee(B.false,!1,5);case 116:return this.expect([116,114,117,101]),new ee(B.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${fe} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new ee(B.break,void 0,1);if(this.ch()!==44)throw new Error(`${fe} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new ee(B.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new ee(B.break,void 0,1);if(this.ch()!==44)throw new Error(`${fe} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new ee(B.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${fe} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${fe} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}}function use(n,e){return e=Object.assign({tokenizer:new fN(n,e)},e),cse(n,e)}function dse(n){return n instanceof ArrayBuffer?new Uint8Array(n,0,n.byteLength):n}class hse extends fN{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(B.equals(e.type,B.map)){const t=this._next();if(B.equals(t.type,B.string)&&t.value==="/"){const r=this._next();if(B.equals(r.type,B.string)){const i=this._next();if(!B.equals(i.type,B.break))throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(r),new ee(B.tag,42,0)}if(B.equals(r.type,B.map)){const i=this._next();if(B.equals(i.type,B.string)&&i.value==="bytes"){const s=this._next();if(B.equals(s.type,B.string)){for(let a=0;a<2;a++){const l=this._next();if(!B.equals(l.type,B.break))throw new Error("Invalid encoded Bytes form")}const o=ar.decode(`m${s.value}`);return new ee(B.bytes,o,s.value.length)}this.tokenBuffer.push(s)}this.tokenBuffer.push(i)}this.tokenBuffer.push(r)}this.tokenBuffer.push(t)}return e}}const $y={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};$y.tags[42]=nt.parse;const pN=297,gN=n=>{const e=dse(n),t=Object.assign($y,{tokenizer:new hse(e,$y)});return use(e,t)};new TextDecoder;new TextEncoder;new TextEncoder;const fse=new TextDecoder,yN=512;function mN(n){return JSON.parse(fse.decode(n))}const pse=0,wN={code:pse},vN=81;function gse(n){return n[Symbol.asyncIterator]!=null}function Kt(n){if(gse(n))return(async()=>{let r=new Uint8Array(0);for await(const i of n)r=vn([r,i],r.length+i.length);return r})();const e=[];let t=0;for(const r of n)e.push(r),t+=r.byteLength;return vn(e,t)}function s8(n){return n==null?!1:Ke.asCID(n)===n}function o8(n,e){let t,r=0,i="";for(;r<e.length;){const s=e[r];if(r++,!Object.hasOwnProperty.call(n,s))throw new S2(`Object did not have key "${s}"`);if(i+=`/${s}`,t=n[s],n=t,s8(t))break}return{value:t,rest:e.slice(r),path:i.substring(1)}}async function*zv(n,e,t,r){const i=await Kt(t.get(n,r)),s=pI(i),o=o8(s,e);yield{cid:s8(o.value)?o.value:n,name:o.path,rest:o.rest}}async function*yse(n,e,t,r){const i=await Kt(t.get(n,r)),s=gN(i),o=o8(s,e);yield{cid:s8(o.value)?o.value:n,name:o.path,rest:o.rest}}const mse=async function(n){return(await Fp.encode(n)).slice(0,8).reverse()},wse=async(n,e,t)=>{const r=(e.tableSize()-1).toString(16).length;await Promise.all(n.map(async i=>{if(i.Name==null)throw new Error("Unexpected Link without a Name");if(i.Name.length===r){const s=parseInt(i.Name,16);e._putObjectAt(s,new ll({hash:t._options.hash,bits:t._options.bits},e,s));return}await t.put(i.Name.substring(2),!0)}))},Vv=(n,e)=>n.toString(16).toUpperCase().padStart(e,"0").substring(0,e),vse=n=>{let e=n.bucket;const t=[];for(;e._parent!=null;)t.push(e),e=e._parent;return t.push(e),t.reverse()};async function*EN(n,e,t,r,i,s){if(i==null){if(n.Data==null)throw new Ut("No data in PBNode");let f;try{f=Oe.unmarshal(n.Data)}catch(y){throw new Ut(y.message)}if(f.type!=="hamt-sharded-directory")throw new Ut("Not a HAMT");if(f.fanout==null)throw new Ut("Missing fanout");const p=q5({hashFn:mse,bits:Math.log2(Number(f.fanout))});i={rootBucket:p,hamtDepth:1,lastBucket:p}}const o=(i.lastBucket.tableSize()-1).toString(16).length;await wse(n.Links,i.lastBucket,i.rootBucket);const a=await i.rootBucket._findNewBucketAndPos(e);let l=Vv(a.pos,o);const c=vse(a);c.length>i.hamtDepth&&(i.lastBucket=c[i.hamtDepth],l=Vv(i.lastBucket._posAtParent,o));const u=n.Links.find(f=>{if(f.Name==null)return!1;const p=f.Name.substring(0,o),y=f.Name.substring(o);return!(p!==l||y!==""&&y!==e)});if(u==null)return;if(u.Name!=null&&u.Name.substring(o)===e){yield{cid:u.Hash,name:u.Name.substring(o),rest:t};return}i.hamtDepth++;const d=await Kt(r.get(u.Hash,s));n=yr(d),(s==null?void 0:s.yieldSubShards)===!0&&(yield{cid:u.Hash,name:u.Name??"",rest:[e,...t]}),yield*EN(n,e,t,r,i,s)}async function*Ese(n,e,t,r){const i=await Kt(t.get(n,r));let s;try{s=yr(i)}catch(a){throw new Ut(a.message)}if(s.Data==null)throw new Ut("no data in PBNode");let o;try{o=Oe.unmarshal(s.Data)}catch(a){throw new Ut(a.message)}if(o.type==="directory"||o.type==="hamt-sharded-directory"&&(r==null?void 0:r.translateHamtPath)===!1){const a=s.Links.find(l=>l.Name===e[0]);if(a==null)throw new Uo(`No link "${e[0]}" found under ${n}`);yield{cid:a.Hash,name:e[0],rest:e.slice(1)}}else if(o.type==="hamt-sharded-directory"){let a=!1;for await(const l of EN(s,e[0],e.slice(1),t,void 0,r))l.name===e[0]&&(a=!0),yield l;if(!a)throw new Uo(`No link "${e[0]}" found under ${n}`)}}async function*bse(n,e,t,r){if(e.length!==0)throw new S2(`Cannot load path /${e.join("/")} from identity block`)}async function*_se(n,e,t,r){const i=await Kt(t.get(n,r)),s=mN(i),o=o8(s,e);yield{cid:n,name:o.path,rest:o.rest}}async function*Sse(n,e,t,r){if(e.length!==0)throw new Uo(`Cannot load path /${e.join("/")} from raw block`)}const xse={[fi]:Ese,[Ds]:Sse,[E5]:zv,[vN]:zv,[pN]:yse,[wN.code]:bse,[yN]:_se};async function*bN(n,e,t={}){var l;for(n=n.toString(),n.startsWith("/ipfs/")&&(n=n.substring(6));n.endsWith("/");)n=n.substring(0,n.length-1);let[r,...i]=n.split(new RegExp("(?<!\\\\)\\/","g")).filter(Boolean),s=Ke.parse(r),o=[s],a=`${s}`;for(yield{cid:s,name:a,path:a,roots:o,remainder:i};i.length>0;){const c=xse[s.code];if(c==null)throw new x2(`No resolver for code ${s.code}`);let u=!1;for await(const d of c(s,i,e,t)){if(s=d.cid,u=!o[o.length-1].equals(s),i=d.rest,!u)break;o=[...o,d.cid],a=`${a}/${d.name}`,yield{cid:d.cid,name:d.name,path:a,roots:o,remainder:d.rest}}if(!u)break}if((l=t==null?void 0:t.signal)==null||l.throwIfAborted(),i.length!==0)throw new Uo(`Could not resolve path /${i.join("/")} under ${n}`)}async function Hv(n,e,t,r,i){const s=await Kt(r.get(n,i)),o=pI(s);return{type:"object",cid:n,name:e,path:t,object:o,node:s}}async function kse(n,e,t,r,i){const s=await Kt(r.get(n,i)),o=gN(s);return{type:"object",cid:n,name:e,path:t,object:o,node:s}}function Uy(n,e,t,r){const i=BigInt(n.length),s=BigInt(e+i);return t>=s||r<e?new Uint8Array(0):(r>=e&&r<s&&(n=n.subarray(0,Number(r-e))),t>=e&&t<s&&(n=n.subarray(Number(t-e))),n)}const _N=(n,e=0,t=n)=>{const r=BigInt(n),i=BigInt(e??0);let s=BigInt(t);if(s!==r&&(s=i+s),s>r&&(s=r),i<0n)throw new wa("Offset must be greater than or equal to 0");if(i>r)throw new wa("Offset must be less than the file size");if(s<0n)throw new wa("Length must be greater than or equal to 0");if(s>r)throw new wa("Length must be less than the file size");return{start:i,end:s}};function SN(n,e){async function*t(r={}){var a;const{start:i,end:s}=_N(n.length,r.offset,r.length),o=Uy(n,0n,i,s);(a=r.onProgress)==null||a.call(r,new se(e,{bytesRead:BigInt(o.byteLength),totalBytes:s-i,fileSize:BigInt(n.byteLength)})),yield o}return t}async function Rse(n,e,t,r,i){const s=KT(n.multihash.bytes);return{type:"identity",cid:n,name:e,path:t,content:SN(s.digest,"unixfs:exporter:progress:identity"),size:BigInt(s.bytes.length),node:s.bytes}}async function Ase(n,e,t,r,i){const s=await Kt(r.get(n,i)),o=mN(s);return{type:"object",cid:n,name:e,path:t,object:o,node:s}}async function Ise(n,e,t,r,i){const s=await Kt(r.get(n,i));return{type:"raw",cid:n,name:e,path:t,content:SN(s,"unixfs:exporter:progress:raw"),size:BigInt(s.length),node:s}}function Cse(n,e,t,r){async function*i(s={}){var c;const o=s.offset??0,a=s.length??e.Links.length,l=e.Links.slice(o,a);(c=s.onProgress)==null||c.call(s,new se("unixfs:exporter:walk:directory",{cid:n})),yield*l.map(u=>({cid:u.Hash,name:u.Name??"",path:`${r}/${u.Name??""}`}))}return i}class a8 extends Error{constructor(t,r){var i;super(t,r);h(this,"name","TimeoutError");(i=Error.captureStackTrace)==null||i.call(Error,this,a8)}}const Kv=n=>n.reason??new DOMException("This operation was aborted.","AbortError");function Tse(n,e){const{milliseconds:t,fallback:r,message:i,customTimers:s={setTimeout,clearTimeout},signal:o}=e;let a,l;const u=new Promise((d,f)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(o!=null&&o.aborted){f(Kv(o));return}if(o&&(l=()=>{f(Kv(o))},o.addEventListener("abort",l,{once:!0})),n.then(d,f),t===Number.POSITIVE_INFINITY)return;const p=new a8;a=s.setTimeout(()=>{if(r){try{d(r())}catch(y){f(y)}return}typeof n.cancel=="function"&&n.cancel(),i===!1?d():i instanceof Error?f(i):(p.message=i??`Promise timed out after ${t} milliseconds`,f(p))},t)}).finally(()=>{u.clear(),l&&o&&o.removeEventListener("abort",l)});return u.clear=()=>{s.clearTimeout(a),a=void 0},u}function Nse(n,e,t){let r=0,i=n.length;for(;i>0;){const s=Math.trunc(i/2);let o=r+s;t(n[o],e)<=0?(r=++o,i-=s+1):i=s}return r}var Sr;class Dse{constructor(){le(this,Sr,[])}enqueue(e,t){const{priority:r=0,id:i}=t??{},s={priority:r,id:i,run:e};if(this.size===0||I(this,Sr)[this.size-1].priority>=r){I(this,Sr).push(s);return}const o=Nse(I(this,Sr),s,(a,l)=>l.priority-a.priority);I(this,Sr).splice(o,0,s)}setPriority(e,t){const r=I(this,Sr).findIndex(s=>s.id===e);if(r===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[i]=I(this,Sr).splice(r,1);this.enqueue(i.run,{priority:t,id:e})}dequeue(){const e=I(this,Sr).shift();return e==null?void 0:e.run}filter(e){return I(this,Sr).filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return I(this,Sr).length}}Sr=new WeakMap;var mc,Gr,qr,lo,xa,wc,Ii,Bh,vc,Ci,ds,xr,Fn,Rn,Tt,Mh,qt,ka,hs,B2,Ra,re,H1,xN,kN,K1,RN,AN,IN,CN,TN,W1,G1,Fy,q1,zy,Vy,j1,aa,NN,El,DN,Hy;class Pse extends RA{constructor(t){var r,i;super();le(this,re);le(this,mc);le(this,Gr);le(this,qr,0);le(this,lo);le(this,xa,!1);le(this,wc,!1);le(this,Ii);le(this,Bh,0);le(this,vc,0);le(this,Ci);le(this,ds);le(this,xr);le(this,Fn,[]);le(this,Rn,0);le(this,Tt);le(this,Mh);le(this,qt,0);le(this,ka);le(this,hs);le(this,B2,1n);le(this,Ra,new Map);h(this,"timeout");if(t={carryoverIntervalCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Dse,strict:!1,...t},!(typeof t.intervalCap=="number"&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${((r=t.intervalCap)==null?void 0:r.toString())??""}\` (${typeof t.intervalCap})`);if(t.interval===void 0||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${((i=t.interval)==null?void 0:i.toString())??""}\` (${typeof t.interval})`);if(t.strict&&t.interval===0)throw new TypeError("The `strict` option requires a non-zero `interval`");if(t.strict&&t.intervalCap===Number.POSITIVE_INFINITY)throw new TypeError("The `strict` option requires a finite `intervalCap`");if(ye(this,mc,t.carryoverIntervalCount??t.carryoverConcurrencyCount??!1),ye(this,Gr,t.intervalCap===Number.POSITIVE_INFINITY||t.interval===0),ye(this,lo,t.intervalCap),ye(this,Ii,t.interval),ye(this,xr,t.strict),ye(this,Tt,new t.queueClass),ye(this,Mh,t.queueClass),this.concurrency=t.concurrency,t.timeout!==void 0&&!(Number.isFinite(t.timeout)&&t.timeout>0))throw new TypeError(`Expected \`timeout\` to be a positive finite number, got \`${t.timeout}\` (${typeof t.timeout})`);this.timeout=t.timeout,ye(this,hs,t.autoStart===!1),Q(this,re,NN).call(this)}get concurrency(){return I(this,ka)}set concurrency(t){if(!(typeof t=="number"&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);ye(this,ka,t),Q(this,re,j1).call(this)}setPriority(t,r){if(typeof r!="number"||!Number.isFinite(r))throw new TypeError(`Expected \`priority\` to be a finite number, got \`${r}\` (${typeof r})`);I(this,Tt).setPriority(t,r)}async add(t,r={}){return r={timeout:this.timeout,...r,id:r.id??(sn(this,B2)._++).toString()},new Promise((i,s)=>{const o=Symbol(`task-${r.id}`);I(this,Tt).enqueue(async()=>{var l,c;sn(this,qt)._++,I(this,Ra).set(o,{id:r.id,priority:r.priority??0,startTime:Date.now(),timeout:r.timeout});let a;try{try{(l=r.signal)==null||l.throwIfAborted()}catch(f){throw Q(this,re,DN).call(this),I(this,Ra).delete(o),f}ye(this,vc,Date.now());let u=t({signal:r.signal});if(r.timeout&&(u=Tse(Promise.resolve(u),{milliseconds:r.timeout,message:`Task timed out after ${r.timeout}ms (queue has ${I(this,qt)} running, ${I(this,Tt).size} waiting)`})),r.signal){const{signal:f}=r;u=Promise.race([u,new Promise((p,y)=>{a=()=>{y(f.reason)},f.addEventListener("abort",a,{once:!0})})])}const d=await u;i(d),this.emit("completed",d)}catch(u){s(u),this.emit("error",u)}finally{a&&((c=r.signal)==null||c.removeEventListener("abort",a)),I(this,Ra).delete(o),queueMicrotask(()=>{Q(this,re,IN).call(this)})}},r),this.emit("add"),Q(this,re,q1).call(this)})}async addAll(t,r){return Promise.all(t.map(async i=>this.add(i,r)))}start(){return I(this,hs)?(ye(this,hs,!1),Q(this,re,j1).call(this),this):this}pause(){ye(this,hs,!0)}clear(){ye(this,Tt,new(I(this,Mh))),Q(this,re,G1).call(this),Q(this,re,Hy).call(this),this.emit("empty"),I(this,qt)===0&&(Q(this,re,Fy).call(this),this.emit("idle")),this.emit("next")}async onEmpty(){I(this,Tt).size!==0&&await Q(this,re,aa).call(this,"empty")}async onSizeLessThan(t){I(this,Tt).size<t||await Q(this,re,aa).call(this,"next",()=>I(this,Tt).size<t)}async onIdle(){I(this,qt)===0&&I(this,Tt).size===0||await Q(this,re,aa).call(this,"idle")}async onPendingZero(){I(this,qt)!==0&&await Q(this,re,aa).call(this,"pendingZero")}async onRateLimit(){this.isRateLimited||await Q(this,re,aa).call(this,"rateLimit")}async onRateLimitCleared(){this.isRateLimited&&await Q(this,re,aa).call(this,"rateLimitCleared")}onError(){return new Promise((t,r)=>{const i=s=>{this.off("error",i),r(s)};this.on("error",i)})}get size(){return I(this,Tt).size}sizeBy(t){return I(this,Tt).filter(t).length}get pending(){return I(this,qt)}get isPaused(){return I(this,hs)}get isRateLimited(){return I(this,xa)}get isSaturated(){return I(this,qt)===I(this,ka)&&I(this,Tt).size>0||this.isRateLimited&&I(this,Tt).size>0}get runningTasks(){return[...I(this,Ra).values()].map(t=>({...t}))}}mc=new WeakMap,Gr=new WeakMap,qr=new WeakMap,lo=new WeakMap,xa=new WeakMap,wc=new WeakMap,Ii=new WeakMap,Bh=new WeakMap,vc=new WeakMap,Ci=new WeakMap,ds=new WeakMap,xr=new WeakMap,Fn=new WeakMap,Rn=new WeakMap,Tt=new WeakMap,Mh=new WeakMap,qt=new WeakMap,ka=new WeakMap,hs=new WeakMap,B2=new WeakMap,Ra=new WeakMap,re=new WeakSet,H1=function(t){for(;I(this,Rn)<I(this,Fn).length;){const i=I(this,Fn)[I(this,Rn)];if(i!==void 0&&t-i>=I(this,Ii))sn(this,Rn)._++;else break}(I(this,Rn)>100&&I(this,Rn)>I(this,Fn).length/2||I(this,Rn)===I(this,Fn).length)&&(ye(this,Fn,I(this,Fn).slice(I(this,Rn))),ye(this,Rn,0))},xN=function(t){I(this,xr)?I(this,Fn).push(t):sn(this,qr)._++},kN=function(){I(this,xr)?I(this,Fn).length>I(this,Rn)&&I(this,Fn).pop():I(this,qr)>0&&sn(this,qr)._--},K1=function(){return I(this,Fn).length-I(this,Rn)},RN=function(){return I(this,Gr)?!0:I(this,xr)?Q(this,re,K1).call(this)<I(this,lo):I(this,qr)<I(this,lo)},AN=function(){return I(this,qt)<I(this,ka)},IN=function(){sn(this,qt)._--,I(this,qt)===0&&this.emit("pendingZero"),Q(this,re,q1).call(this),this.emit("next")},CN=function(){ye(this,ds,void 0),Q(this,re,Vy).call(this),Q(this,re,zy).call(this)},TN=function(t){if(I(this,xr)){if(Q(this,re,H1).call(this,t),Q(this,re,K1).call(this)>=I(this,lo)){const i=I(this,Fn)[I(this,Rn)],s=I(this,Ii)-(t-i);return Q(this,re,W1).call(this,s),!0}return!1}if(I(this,Ci)===void 0){const r=I(this,Bh)-t;if(r<0){if(I(this,vc)>0){const i=t-I(this,vc);if(i<I(this,Ii))return Q(this,re,W1).call(this,I(this,Ii)-i),!0}ye(this,qr,I(this,mc)?I(this,qt):0)}else return Q(this,re,W1).call(this,r),!0}return!1},W1=function(t){I(this,ds)===void 0&&ye(this,ds,setTimeout(()=>{Q(this,re,CN).call(this)},t))},G1=function(){I(this,Ci)&&(clearInterval(I(this,Ci)),ye(this,Ci,void 0))},Fy=function(){I(this,ds)&&(clearTimeout(I(this,ds)),ye(this,ds,void 0))},q1=function(){if(I(this,Tt).size===0){if(Q(this,re,G1).call(this),this.emit("empty"),I(this,qt)===0){if(Q(this,re,Fy).call(this),I(this,xr)&&I(this,Rn)>0){const r=Date.now();Q(this,re,H1).call(this,r)}this.emit("idle")}return!1}let t=!1;if(!I(this,hs)){const r=Date.now(),i=!Q(this,re,TN).call(this,r);if(I(this,re,RN)&&I(this,re,AN)){const s=I(this,Tt).dequeue();I(this,Gr)||(Q(this,re,xN).call(this,r),Q(this,re,El).call(this)),this.emit("active"),s(),i&&Q(this,re,zy).call(this),t=!0}}return t},zy=function(){I(this,Gr)||I(this,Ci)!==void 0||I(this,xr)||(ye(this,Ci,setInterval(()=>{Q(this,re,Vy).call(this)},I(this,Ii))),ye(this,Bh,Date.now()+I(this,Ii)))},Vy=function(){I(this,xr)||(I(this,qr)===0&&I(this,qt)===0&&I(this,Ci)&&Q(this,re,G1).call(this),ye(this,qr,I(this,mc)?I(this,qt):0)),Q(this,re,j1).call(this),Q(this,re,El).call(this)},j1=function(){for(;Q(this,re,q1).call(this););},aa=async function(t,r){return new Promise(i=>{const s=()=>{r&&!r()||(this.off(t,s),i())};this.on(t,s)})},NN=function(){I(this,Gr)||(this.on("add",()=>{I(this,Tt).size>0&&Q(this,re,El).call(this)}),this.on("next",()=>{Q(this,re,El).call(this)}))},El=function(){I(this,Gr)||I(this,wc)||(ye(this,wc,!0),queueMicrotask(()=>{ye(this,wc,!1),Q(this,re,Hy).call(this)}))},DN=function(){I(this,Gr)||(Q(this,re,kN).call(this),Q(this,re,El).call(this))},Hy=function(){const t=I(this,xa);if(I(this,Gr)||I(this,Tt).size===0){t&&(ye(this,xa,!1),this.emit("rateLimitCleared"));return}let r;if(I(this,xr)){const s=Date.now();Q(this,re,H1).call(this,s),r=Q(this,re,K1).call(this)}else r=I(this,qr);const i=r>=I(this,lo);i!==t&&(ye(this,xa,i),this.emit(i?"rateLimit":"rateLimitCleared"))};async function PN(n,e,t,r,i,s,o){if(e instanceof Uint8Array){const c=Uy(e,r,i,s);t.push(c);return}if(e.Data==null)throw new Ut("no data in PBNode");let a;try{a=Oe.unmarshal(e.Data)}catch(c){throw new Ut(c.message)}if(a.data!=null){const c=a.data,u=Uy(c,r,i,s);t.push(u),r+=BigInt(u.byteLength)}const l=[];if(e.Links.length!==a.blockSizes.length)throw new Ut("Inconsistent block sizes and dag links");for(let c=0;c<e.Links.length;c++){const u=e.Links[c],d=r,f=d+a.blockSizes[c];if((i>=d&&i<f||s>=d&&s<=f||i<d&&s>f)&&l.push({link:u,blockStart:r}),r=f,r>s)break}await En(l,c=>Wo(c,u=>async()=>{const d=await Kt(n.get(u.link.Hash,o));return{...u,block:d}}),c=>al(c,{ordered:!0,concurrency:o.blockReadConcurrency}),async c=>{for await(const{link:u,block:d,blockStart:f}of c){let p;switch(u.Hash.code){case fi:p=yr(d);break;case Ds:p=d;break;default:t.end(new Ut(`Unsupported codec: ${u.Hash.code}`));return}const y=new Pse({concurrency:1});y.on("error",g=>{t.end(g)}),y.add(async()=>{var g;(g=o.onProgress)==null||g.call(o,new se("unixfs:exporter:walk:file",{cid:u.Hash})),await PN(n,p,t,f,i,s,o)}),await y.onIdle()}}),r>=s&&t.end()}function Wv(n,e,t,r,i){async function*s(o={}){var p,y;const a=t.fileSize();if(a===void 0)throw new Error("File was a directory");const{start:l,end:c}=_N(a,o.offset,o.length);if(c===0n)return;let u=0n;const d=c-l,f=Ko();(p=o.onProgress)==null||p.call(o,new se("unixfs:exporter:walk:file",{cid:n})),PN(i,e,f,0n,l,c,o).catch(g=>{f.end(g)});for await(const g of f)if(g!=null){if(u+=BigInt(g.byteLength),u>d)throw f.end(),new Ly("Read too many bytes - the file size reported by the UnixFS data in the root node may be incorrect");u===d&&f.end(),(y=o.onProgress)==null||y.call(o,new se("unixfs:exporter:progress:unixfs:file",{bytesRead:u,totalBytes:d,fileSize:a})),yield g}if(u<d)throw new By("Traversed entire DAG but did not read enough bytes")}return s}async function*ON(n,e,t,r){const i=n.Links;if(n.Data==null)throw new Ut("no data in PBNode");let s;try{s=Oe.unmarshal(n.Data)}catch(l){throw new Ut(l.message)}if(s.fanout==null)throw new Ut("missing fanout");const o=(s.fanout-1n).toString(16).length,a=En(i,l=>Wo(l,c=>async()=>{var d;const u=c.Name!=null?c.Name.substring(o):null;if(u!=null&&u!=="")return{entries:[{cid:c.Hash,name:u,path:`${e}/${u}`}]};{const f=await Kt(t.get(c.Hash,r));return n=yr(f),(d=r.onProgress)==null||d.call(r,new se("unixfs:exporter:walk:hamt-sharded-directory",{cid:c.Hash})),{entries:ON(n,e,t,r)}}}),l=>al(l,{ordered:!0,concurrency:r.blockReadConcurrency}));for await(const{entries:l}of a)yield*l}function Ose(n,e,t,r,i){function s(o={}){var a;return(a=o.onProgress)==null||a.call(o,new se("unixfs:exporter:walk:hamt-sharded-directory",{cid:n})),ON(e,r,i,o)}return s}const Lse={raw:Wv,file:Wv,directory:Cse,"hamt-sharded-directory":Ose,metadata:(n,e,t,r)=>()=>[],symlink:(n,e,t,r)=>()=>[]};async function Bse(n,e,t,r,i){const s=await Kt(r.get(n,i));let o;try{o=yr(s)}catch(c){throw new Ut(c.message)}if(o.Data==null)throw new Ut("no data in PBNode");let a;try{a=Oe.unmarshal(o.Data)}catch(c){throw new Ut(c.message)}const l=Lse[a.type](n,o,a,t,r);if(l==null)throw new Uo("could not find content exporter");return a.isDirectory()?{type:"directory",cid:n,name:e,path:t,entries:l,unixfs:a,node:o}:{type:"file",cid:n,name:e,path:t,content:l,unixfs:a,node:o,size:a.fileSize()}}const Mse={[fi]:Bse,[Ds]:Ise,[E5]:Hv,[vN]:Hv,[pN]:kse,[wN.code]:Rse,[yN]:Ase};async function $r(n,e,t={}){let r,i;if(n instanceof String||typeof n=="string"){const o=await Nu(bN(n,e,t));if(o==null)throw new Uo(`Could not walk path to ${n}`);r=o.cid,i=o.name,n=o.path}else if(Ke.asCID(n)===n||n instanceof Ke)r=n,i=n=r.toString();else throw new wa("Path must be string or CID");const s=Mse[r.code];if(s==null)throw new x2(`No resolver for code ${r.code}`);return s(r,i,n,e,t)}async function*LN(n,e,t={}){const r=await $r(n,e,t);if(r==null)return;if(yield{cid:r.cid,name:r.name,path:r.path,depth:0},r.type==="directory")for await(const s of i(r,0,`${n}`,t))yield s;async function*i(s,o,a,l){o++;for await(const c of s.entries(l)){const u=`${a}/${c.name}`;yield{...c,depth:o,path:u};const d=await $r(c.cid,e,l);d.type==="directory"&&(yield*i(d,o,u,l))}}}function $se(n){t.debug=t,t.default=t,t.coerce=l,t.disable=s,t.enable=i,t.enabled=o,t.humanize=mp,t.destroy=c,Object.keys(n).forEach(u=>{t[u]=n[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let d=0;for(let f=0;f<u.length;f++)d=(d<<5)-d+u.charCodeAt(f),d|=0;return t.colors[Math.abs(d)%t.colors.length]}t.selectColor=e;function t(u,d){let f,p=null,y,g;function w(...m){if(!w.enabled)return;const E=w,v=Number(new Date),b=v-(f||v);E.diff=b,E.prev=f,E.curr=v,f=v,m[0]=t.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let k=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(T,P)=>{if(T==="%%")return"%";k++;const _=t.formatters[P];if(typeof _=="function"){const N=m[k];T=_.call(E,N),m.splice(k,1),k--}return T}),t.formatArgs.call(E,m),(d==null?void 0:d.onLog)!=null&&d.onLog(...m),(E.log||t.log).apply(E,m)}return w.namespace=u,w.useColors=t.useColors(),w.color=t.selectColor(u),w.extend=r,w.destroy=t.destroy,Object.defineProperty(w,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(y!==t.namespaces&&(y=t.namespaces,g=t.enabled(u)),g),set:m=>{p=m}}),typeof t.init=="function"&&t.init(w),w}function r(u,d){const f=t(this.namespace+(typeof d>"u"?":":d)+u);return f.log=this.log,f}function i(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let d;const f=(typeof u=="string"?u:"").split(/[\s,]+/),p=f.length;for(d=0;d<p;d++)f[d]&&(u=f[d].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.substr(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function s(){const u=[...t.names.map(a),...t.skips.map(a).map(d=>"-"+d)].join(",");return t.enable(""),u}function o(u){if(u[u.length-1]==="*")return!0;let d,f;for(d=0,f=t.skips.length;d<f;d++)if(t.skips[d].test(u))return!1;for(d=0,f=t.names.length;d<f;d++)if(t.names[d].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function l(u){return u instanceof Error?u.stack??u.message:u}function c(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var Use={};const Di=Gse(),Fse=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function zse(){var n,e,t,r,i;return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&((n=navigator.userAgent)==null?void 0:n.toLowerCase().match(/(edge|trident)\/(\d+)/))!=null?!1:typeof document<"u"&&((t=(e=document.documentElement)==null?void 0:e.style)==null?void 0:t.WebkitAppearance)||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&((r=navigator.userAgent)==null?void 0:r.toLowerCase().match(/firefox\/(\d+)/))!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&((i=navigator.userAgent)==null?void 0:i.toLowerCase().match(/applewebkit\/(\d+)/))}function Vse(n){if(n[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+n[0]+(this.useColors?"%c ":" ")+"+"+mp(this.diff),!this.useColors)return;const e="color: "+this.color;n.splice(1,0,e,"color: inherit");let t=0,r=0;n[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(t++,i==="%c"&&(r=t))}),n.splice(r,0,e)}const Hse=console.debug??console.log??(()=>{});function Kse(n){try{n?Di==null||Di.setItem("debug",n):Di==null||Di.removeItem("debug")}catch{}}function Wse(){let n;try{n=Di==null?void 0:Di.getItem("debug")}catch{}return!n&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(n=Use.DEBUG),n}function Gse(){try{return localStorage}catch{}}function qse(n){n.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const nr=$se({formatArgs:Vse,save:Kse,load:Wse,useColors:zse,setupFormatters:qse,colors:Fse,storage:Di,log:Hse});nr.formatters.b=n=>n==null?"undefined":mn.baseEncode(n);nr.formatters.t=n=>n==null?"undefined":Hn.baseEncode(n);nr.formatters.m=n=>n==null?"undefined":ar.baseEncode(n);nr.formatters.p=n=>n==null?"undefined":n.toString();nr.formatters.c=n=>n==null?"undefined":n.toString();nr.formatters.k=n=>n==null?"undefined":n.toString();nr.formatters.a=n=>n==null?"undefined":n.toString();function Gv(n,e=""){const t=qv(n.message),r=qv(n.stack);return t!=null&&r!=null?r.includes(t)?`${r.split(`
`).join(`
${e}`)}`:`${t}
${e}${r.split(`
`).join(`
${e}`)}`:r!=null?`${r.split(`
`).join(`
${e}`)}`:t!=null?`${t}`:`${n.toString()}`}function jse(n){return n instanceof AggregateError||(n==null?void 0:n.name)==="AggregateError"&&Array.isArray(n.errors)}function BN(n,e=""){if(jse(n)){let t=Gv(n,e);return n.errors.length>0?(e=`${e}    `,t+=`
${e}${n.errors.map(r=>`${BN(r,`${e}`)}`).join(`
${e}`)}`):t+=`
${e}[Error list was empty]`,t.trim()}return Gv(n,e)}nr.formatters.e=n=>n==null?"undefined":BN(n);function Yse(n){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=n,e.destroy=()=>!0,e.extend=()=>e,e}function pi(n,e){let t=Yse(`${n}:trace`);return nr.enabled(`${n}:trace`)&&nr.names.map(r=>r.toString()).find(r=>r.includes(":trace"))!=null&&(t=nr(`${n}:trace`,e)),Object.assign(nr(n,e),{error:nr(`${n}:error`,e),trace:t,newScope:r=>pi(`${n}:${r}`,e)})}function qv(n){if(n!=null&&(n=n.trim(),n.length!==0))return n}const MN=1,$N=262144;function UN(n){function e(t){return t instanceof jv?t:new jv(t,n)}return e}class jv{constructor(e,t){h(this,"_value");h(this,"_hashFn");h(this,"_depth");h(this,"_availableBits");h(this,"_currentBufferIndex");h(this,"_buffers");if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let r=0;for(;t>0;){const i=this._buffers[this._currentBufferIndex],s=Math.min(i.availableBits(),t),o=i.take(s);r=(r<<s)+o,t-=s,this._availableBits-=s,i.availableBits()===0&&this._currentBufferIndex++}return r}untake(e){let t=e;for(;t>0;){const r=this._buffers[this._currentBufferIndex],i=Math.min(r.totalBits()-r.availableBits(),t);r.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&r.totalBits()===r.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?vn([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),r=new Jse(t);this._buffers.push(r),this._availableBits+=r.availableBits()}}const Qse=[255,254,252,248,240,224,192,128],Xse=[1,3,7,15,31,63,127,255];class Jse{constructor(e){h(this,"_value");h(this,"_currentBytePos");h(this,"_currentBitPos");this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,r=0;for(;t>0&&this._haveBits();){const i=this._value[this._currentBytePos],s=this._currentBitPos+1,o=Math.min(s,t),a=Zse(i,s-o,o);r=(r<<o)+a,t-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return r}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function Zse(n,e,t){const r=eoe(e,t);return(n&r)>>>e}function eoe(n,e){return Qse[n]&Xse[Math.min(e+n-1,7)]}const l8=BigInt(Fp.code),Md=8;async function c8(n){return(await Fp.encode(n)).subarray(0,8).reverse()}const Lu=async(n,e,t)=>{t.codec==null&&(t.codec=Sp);const r=await Tu.digest(n),i=Ke.create(t.cidVersion??MN,t.codec.code,r);return await e.put(i,n,{...t,signal:t.signal}),i};class toe{constructor(e,t){h(this,"options");h(this,"root");h(this,"dir");h(this,"path");h(this,"dirty");h(this,"flat");h(this,"parent");h(this,"parentKey");h(this,"unixfs");h(this,"mode");h(this,"mtime");h(this,"cid");h(this,"size");h(this,"nodeSize");this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}}class noe extends toe{constructor(t,r){super(t,r);h(this,"_bucket");this._bucket=q5({hashFn:c8,bits:8})}async put(t,r){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(t,r)}async get(t){return this._bucket.get(t)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for(const{key:t,value:r}of this._bucket.eachLeafSeries())yield{key:t,child:r}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=zN(this._bucket,this,this.options),this.nodeSize)}async*flush(t){for await(const r of FN(this._bucket,t,this,this.options))yield{...r,path:this.path}}}async function*FN(n,e,t,r){const i=n._children,s=[];let o=0n;for(let p=0;p<i.length;p++){const y=i.get(p);if(y==null)continue;const g=p.toString(16).toUpperCase().padStart(2,"0");if(y instanceof ll){let w;for await(const m of FN(y,e,null,r))w=m;if(w==null)throw new Error("Could not flush sharded directory, no sub-shard found");s.push({Name:g,Tsize:Number(w.size),Hash:w.cid}),o+=w.size}else if(roe(y.value)){const w=y.value;let m;for await(const v of w.flush(e))m=v,yield m;if(m==null)throw new Error("Did not flush dir");const E=g+y.key;s.push({Name:E,Tsize:Number(m.size),Hash:m.cid}),o+=m.size}else{const w=y.value;if(w.cid==null)continue;const m=g+y.key,E=w.size;s.push({Name:m,Tsize:Number(E),Hash:w.cid}),o+=BigInt(E??0)}}const a=Uint8Array.from(i.bitField().reverse()),l=new Oe({type:"hamt-sharded-directory",data:a,fanout:BigInt(n.tableSize()),hashType:l8,mtime:t==null?void 0:t.mtime,mode:t==null?void 0:t.mode}),c={Data:l.marshal(),Links:s},u=Rt(hr(c)),d=await Lu(u,e,r),f=BigInt(u.byteLength)+o;yield{cid:d,unixfs:l,size:f}}function roe(n){return typeof n.flush=="function"}function zN(n,e,t){const r=n._children,i=[];for(let l=0;l<r.length;l++){const c=r.get(l);if(c==null)continue;const u=l.toString(16).toUpperCase().padStart(2,"0");if(c instanceof ll){const d=zN(c,null,t);i.push({Name:u,Tsize:Number(d),Hash:t.cidVersion===0?Ky:Wy})}else if(typeof c.value.flush=="function"){const f=c.value.nodeSize();i.push({Name:u+c.key,Tsize:Number(f),Hash:t.cidVersion===0?Ky:Wy})}else{const d=c.value;if(d.cid==null)continue;const f=u+c.key,p=d.size;i.push({Name:f,Tsize:Number(p),Hash:d.cid})}}const s=Uint8Array.from(r.bitField().reverse()),o=new Oe({type:"hamt-sharded-directory",data:s,fanout:BigInt(n.tableSize()),hashType:l8,mtime:e==null?void 0:e.mtime,mode:e==null?void 0:e.mode});return Rt(hr({Data:o.marshal(),Links:i})).length}const Ky=Ke.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),Wy=Ke.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi"),Gy=pi("helia:unixfs:commands:utils:hamt-utils"),qy=n=>n.toString(16).toUpperCase().padStart(2,"0").substring(0,2),ioe=async(n,e,t)=>{const r=new noe({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:t.mtime,mode:t.mode},t);for(let s=0;s<e.length;s++)await r._bucket.put(e[s].name,{size:e[s].size,cid:e[s].cid});const i=await Nu(r.flush(n));if(i==null)throw new Error("Flushing shard yielded no result");return i},VN=async(n,e,t)=>{const r=Oe.unmarshal(n[0].node.Data??new Uint8Array(0)),i=BigInt(Math.pow(2,Md));n.reverse();let s,o;for(let a=0;a<n.length;a++){const l=a===n.length-1,c=n[a],u=Uint8Array.from(c.children.bitField().reverse()),d=new Oe({type:"hamt-sharded-directory",data:u,fanout:i,hashType:l8});l&&(d.mtime=r.mtime,d.mode=r.mode),o={Data:d.marshal(),Links:c.node.Links};const f=Rt(hr(o));if(s=await Lu(f,e,t),!l){const p=n[a+1];if(p==null)throw new Error("Was not operating on shard root but also had no parent?");Gy("updating link in parent sub-shard with prefix %s",p.prefix),p.node.Links=p.node.Links.filter(y=>y.Name!==p.prefix),p.node.Links.push({Name:p.prefix,Hash:s,Tsize:c.node.Links.reduce((y,g)=>y+(g.Tsize??0),f.byteLength)})}}if(s==null||o==null)throw new Error("Noting persisted");return{cid:s,node:o}},HN=async(n,e,t,r)=>{const s=UN(c8)(Y(e)),o=[];for(;;){const a=await Kt(t.get(n,r)),l=yr(a),c=new _2,u=await s.take(Md),d=qy(u);o.push({prefix:d,children:c,node:l});let f;for(const y of l.Links){const g=y.Name??"";if(g.length<2)throw new Error("Invalid HAMT - link name was too short");const w=parseInt(g.substring(0,2),16);c.set(w,!0),g.startsWith(d)&&(f=y)}if(f==null){Gy("no link found with prefix %s for %s",d,e);break}const p=f.Name??"";if(p.length<2)throw new Error("Invalid HAMT - link name was too short");if(p.length===2){n=f.Hash,Gy("descend into sub-shard with prefix %s",p);continue}break}return{path:o,hash:s}};async function KN(n,e,t,r){if(n.Data==null)throw new Error("DagPB node had no data");const i=Oe.unmarshal(n.Data);let s;if(i.type==="directory")s=soe(n);else if(i.type==="hamt-sharded-directory")s=await WN(n,0,t,e,r);else throw new Error("Can only estimate the size of directories or shards");return s>t}function soe(n){let e=0;for(const t of n.Links)e+=(t.Name??"").length,e+=t.Hash.version===1?Wy.bytes.byteLength:Ky.bytes.byteLength;return e}async function WN(n,e,t,r,i){if(e>t)return t;if(n.Data==null||!Oe.unmarshal(n.Data).isDirectory())return e;for(const o of n.Links){let a=o.Name??"";if(a=a.substring(2),e+=a.length,e+=o.Hash.bytes.byteLength,o.Hash.code===fi){const l=await Kt(r.get(o.Hash,i)),c=yr(l);e+=await WN(c,e,t,r,i)}}return e}const Pi=pi("helia:unixfs:components:utils:add-link");async function u8(n,e,t,r){if(n.node.Data==null)throw new ai("Invalid parent passed to addLink");if(Oe.unmarshal(n.node.Data).type==="hamt-sharded-directory")return Pi("adding link to sharded directory"),loe(n,e,t,r);Pi(`adding ${e.Name} (${e.Hash}) to regular directory`);const s=await aoe(n,e,t,r);if(await KN(s.node,t,r.shardSplitThresholdBytes??$N,r)){Pi("converting directory to sharded directory");const o=await ooe(s,t);s.cid=o.cid,s.node=yr(await Kt(t.get(o.cid,r)))}return s}const ooe=async(n,e)=>{if(n.node.Data==null)throw new ai("Invalid parent passed to convertToShardedDirectory");const t=Oe.unmarshal(n.node.Data),r=await ioe(e,n.node.Links.map(i=>({name:i.Name??"",size:BigInt(i.Tsize??0),cid:i.Hash})),{mode:t.mode,mtime:t.mtime,cidVersion:n.cid.version});return Pi(`converted directory to sharded directory ${r.cid}`),r},aoe=async(n,e,t,r)=>{const i=n.node.Links.filter(u=>{const d=u.Name===e.Name;if(d&&!r.allowOverwriting)throw new ZT;return!d});if(i.push(e),n.node.Data==null)throw new Ya("Parent node with no data passed to addToDirectory");const s=Oe.unmarshal(n.node.Data);let o;if(s.mtime!=null){const u=Date.now(),d=Math.floor(u/1e3);s.mtime={secs:BigInt(d),nsecs:(u-d*1e3)*1e3},o=s.marshal()}else o=n.node.Data;n.node=hr({Data:o,Links:i});const a=Rt(n.node),l=await Tu.digest(a),c=Ke.create(n.cid.version,fi,l);return await t.put(c,a),{node:n.node,cid:c}},loe=async(n,e,t,r)=>{var d;const{path:i,hash:s}=await HN(n.cid,e.Name,t,r),o=i[i.length-1];if(o==null)throw new Error("Invalid HAMT, could not generate path");const a=o.prefix,l=parseInt(a,16);Pi("next prefix for %s is %s",e.Name,a);const c=`${a}${e.Name}`,u=o.node.Links.find(f=>(f.Name??"").startsWith(a));if(u!=null)if(Pi("link %s was present in shard",c),u.Name===c){if(!r.allowOverwriting)throw new ZT;Pi("overwriting %s in sub-shard",e.Name),o.node.Links=o.node.Links.filter(f=>f.Name!==c),o.node.Links.push({Name:c,Hash:e.Hash,Tsize:e.Tsize})}else{if(((d=u.Name)==null?void 0:d.length)===2)throw new Error("Existing link was sub-shard?!");{Pi("prefix %s already exists, creating new sub-shard",a);const f=o.node.Links.findIndex(m=>{var E;return(E=m.Name)==null?void 0:E.startsWith(a)}),p=o.node.Links.splice(f,1)[0],y=(p.Name??"").substring(2),w=UN(c8)(Y(y));for(let m=0;m<i.length;m++)await w.take(Md);for(;;){const m=await w.take(Md),E=qy(m);p.Name=`${E}${y}`;const v=await s.take(Md),b=qy(v);if(E===b){const A=new _2;A.set(v,!0),i.push({prefix:b,children:A,node:{Links:[]}});continue}const k=new _2;k.set(v,!0),k.set(m,!0),i.push({prefix:a,children:k,node:{Links:[p,{Name:`${b}${e.Name}`,Hash:e.Hash,Tsize:e.Tsize}]}});break}}}else Pi("link %s was not present in sub-shard",c),e.Name=c,o.node.Links.push(e),o.children.set(l,!0),Pi("adding %s to existing sub-shard",c);return VN(i,t,r)};async function Gp(n,e,t={}){const r=await $r(n,e,t);if(r.type!=="directory")throw new eN(`${n.toString()} was not a UnixFS directory`);return{cid:n,node:r.node}}async function d8(n,e,t,r){const i=await $r(n,t,r);if(i.type!=="directory"&&i.type!=="file"&&i.type!=="raw")throw new Vp(`${n.toString()} was not a UnixFS node`);return{Name:e,Tsize:i.node instanceof Uint8Array?i.node.byteLength:coe(i.node),Hash:n}}function coe(n){const e=n.Links.reduce((t,r)=>t+(r.Tsize??0),0);return Rt(n).byteLength+e}const uoe=pi("helia:unixfs:components:utils:resolve");async function ff(n,e,t,r){if(e==null||e==="")return{cid:n};const i=`/ipfs/${n}${e==null?"":`/${e}`}`,s=await Z0(bN(i,t,r));if(s.length===0)throw new Qre("Could not find path in directory");return uoe("resolved %s to %c",e,n),{cid:s[s.length-1].cid,path:e,segments:s}}async function I2(n,e,t,r){if(e.segments==null||e.segments.length===0)return n;let i=e.segments.pop();if(i==null)throw new Error("Insufficient segments");i.cid=n,e.segments.reverse();for(const s of e.segments){const[o,a]=await Promise.all([Gp(s.cid,t,r),d8(i.cid,i.name,t,r)]);n=(await u8(o,a,t,{...r,allowOverwriting:!0,cidVersion:n.version})).cid,s.cid=n,i=s}return n}async function*doe(n,e,t={}){const r=await ff(n,t.path,e,t),i=await $r(r.cid,e,t);if(i.type!=="file"&&i.type!=="raw")throw new Jre;if(i.content==null)throw new Xre;yield*i.content(t)}const hoe=pi("helia:unixfs:chmod");async function foe(n,e,t,r={}){const i=await ff(n,r.path,t,r);if(hoe("chmod %c %d",i.cid,e),r.recursive===!0){const d=await En(async function*(){for await(const f of LN(i.cid,t,r)){let p,y=[];const g=await $r(f.cid,t,r);if(g.type==="raw")p=new Oe({type:"file",data:g.node});else if(g.type==="file"||g.type==="directory")p=g.unixfs,y=g.node.Links;else throw new Vp;p.mode=e;const w={Data:p.marshal(),Links:y};yield{path:f.path,content:w}}},f=>zp(f,t,{...r,dagBuilder:async function*(p,y){for await(const g of p)yield async function(){const w=g.content,m=Rt(w),E=await Lu(m,y,{...r,cidVersion:n.version});if(w.Data==null)throw new Ya(`${E} had no data`);const v=Oe.unmarshal(w.Data);return{cid:E,size:BigInt(m.length),path:g.path,unixfs:v}}}}),async f=>Nu(f));if(d==null)throw new j5(`Could not chmod ${i.cid.toString()}`);return I2(d.cid,i,t,r)}const s=await Kt(t.get(i.cid,r));let o,a=[];if(i.cid.code===Ds)o=new Oe({type:"file",data:s});else{const d=yr(s);if(d.Data==null)throw new Ya(`${i.cid.toString()} had no data`);a=d.Links,o=Oe.unmarshal(d.Data)}o.mode=e;const l=Rt({Data:o.marshal(),Links:a}),c=await Tu.digest(l),u=Ke.create(i.cid.version,fi,c);return await t.put(u,l),I2(u,i,t,r)}const poe=pi("helia:unixfs:cp");async function goe(n,e,t,r,i={}){if(t.includes("/"))throw new ai("Name must not have slashes");const[s,o]=await Promise.all([Gp(e,r,i),d8(n,t,r,i)]);return poe('Adding %c as "%s" to %c',n,t,e),(await u8(s,o,r,{allowOverwriting:i.force,cidVersion:e.version,...i})).cid}async function*yoe(n,e,t={}){const r=await ff(n,t.path,e,t),i=await $r(r.cid,e,t);if(i.type==="directory"){yield*i.entries(t);return}yield i}const Yv=pi("helia:unixfs:mkdir");async function moe(n,e,t,r={}){if(e.includes("/"))throw new ai("Path must not have slashes");if((await $r(n,t,r)).type!=="directory")throw new eN(`${n.toString()} was not a UnixFS directory`);Yv("creating %s",e);const o={Data:new Oe({type:"directory",mode:r.mode,mtime:r.mtime}).marshal(),Links:[]},a=Rt(o),l=await Tu.digest(a),c=Ke.create(r.cidVersion??MN,fi,l);await t.put(c,a);const[u,d]=await Promise.all([Gp(n,t,r),d8(c,e,t,r)]);return Yv("adding empty dir called %s to %c",e,n),(await u8(u,d,t,{...r,allowOverwriting:r.force})).cid}const Y1=pi("helia:unixfs:utils:remove-link");async function woe(n,e,t,r){if(n.node.Data==null)throw new Ya("Parent node had no data");if(Oe.unmarshal(n.node.Data).type==="hamt-sharded-directory"){Y1(`removing ${e} from sharded directory`);const s=await Eoe(n,e,t,r);return await KN(s.node,t,r.shardSplitThresholdBytes??$N,r)?s:(Y1("converting shard to flat directory %c",n.cid),boe(s,t,r))}return Y1(`removing link ${e} regular directory`),voe(n,e,t,r)}const voe=async(n,e,t,r)=>{n.node.Links=n.node.Links.filter(o=>o.Name!==e);const i=Rt(n.node),s=await Lu(i,t,{...r,cidVersion:n.cid.version});return Y1(`Updated regular directory ${s}`),{node:n.node,cid:s}},Eoe=async(n,e,t,r)=>{const{path:i}=await HN(n.cid,e,t,r),s=i[i.length-1];if(s==null)throw new Error("Invalid HAMT, could not generate path");const o=s.node.Links.filter(c=>(c.Name??"").substring(2)===e).map(c=>c.Name).pop();if(o==null)throw new Error("File not found");const a=o.substring(0,2),l=parseInt(a,16);if(s.node.Links=s.node.Links.filter(c=>c.Name!==o),s.children.unset(l),s.node.Links.length===1)for(;i.length!==1;){const c=i[i.length-1];if(c==null||c.node.Links.length>1)break;i.pop();const u=i[i.length-1];if(u==null)break;const d=c.node.Links[0];u.node.Links=u.node.Links.filter(f=>!(f.Name??"").startsWith(u.prefix)),u.node.Links.push({Hash:d.Hash,Name:`${u.prefix}${(d.Name??"").substring(2)}`,Tsize:d.Tsize})}return VN(i,t,r)},boe=async(n,e,t)=>{if(n.node.Data==null)throw new ai("Invalid parent passed to convertToFlatDirectory");const r={Links:[]},i=await $r(n.cid,e,t);if(i.type!=="directory")throw new Error("Unexpected node type");for await(const l of i.entries()){let c=0;const u=await $r(l.cid,e,t);u.node instanceof Uint8Array?c=u.node.byteLength:c=Rt(u.node).length,r.Links.push({Hash:l.cid,Name:l.name,Tsize:c})}const s=Oe.unmarshal(n.node.Data);r.Data=new Oe({type:"directory",mode:s.mode,mtime:s.mtime}).marshal();const o=Rt(hr(r));return{cid:await Lu(o,e,{codec:Sp,cidVersion:n.cid.version,signal:t.signal}),node:r}},_oe=pi("helia:unixfs:rm");async function Soe(n,e,t,r={}){if(e.includes("/"))throw new ai("Name must not have slashes");const i=await Gp(n,t,r);return _oe("Removing %s from %c",e,n),(await woe(i,e,t,{...r,cidVersion:n.version})).cid}const h8={hash:n=>Number(_A(n,{size:32})),hashV:(n,e)=>xoe(h8.hash(n,e))};function xoe(n){let e=n.toString(16);return e.length%2===1&&(e=`0${e}`),Y(e,"base16")}const koe=64;class va{constructor(e,t,r,i=2){h(this,"fp");h(this,"h");h(this,"seed");if(i>koe)throw new TypeError("Invalid Fingerprint Size");const s=t.hashV(e,r),o=Xe(i);for(let a=0;a<o.length;a++)o[a]=s[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=r}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return(e==null?void 0:e.fp)instanceof Uint8Array?Pe(this.fp,e.fp):!1}}function C2(n,e){return Math.floor(Math.random()*(e-n))+n}class l1{constructor(e){h(this,"contents");this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof va))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof va))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof va))throw new TypeError("Invalid Fingerprint");const t=C2(0,this.contents.length-1),r=this.contents[t];return this.contents[t]=e,r}remove(e){if(!(e instanceof va))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(r=>e.equals(r));return t>-1?(this.contents[t]=null,!0):!1}}const Roe=500;class Qv{constructor(e){h(this,"bucketSize");h(this,"filterSize");h(this,"fingerprintSize");h(this,"buckets");h(this,"count");h(this,"hash");h(this,"seed");this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??h8,this.seed=e.seed??C2(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=Y(e));const t=new va(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=(r^t.hash())%this.filterSize;if(this.buckets[r]==null&&(this.buckets[r]=new l1(this.bucketSize)),this.buckets[i]==null&&(this.buckets[i]=new l1(this.bucketSize)),this.buckets[r].add(t)||this.buckets[i].add(t))return this.count++,!0;const s=[r,i];let o=s[C2(0,s.length-1)];this.buckets[o]==null&&(this.buckets[o]=new l1(this.bucketSize));for(let a=0;a<Roe;a++){const l=this.buckets[o].swap(t);if(l!=null&&(o=(o^l.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new l1(this.bucketSize)),this.buckets[o].add(l)))return this.count++,!0}return!1}has(e){var o,a;typeof e=="string"&&(e=Y(e));const t=new va(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=((o=this.buckets[r])==null?void 0:o.has(t))??!1;if(i)return i;const s=(r^t.hash())%this.filterSize;return((a=this.buckets[s])==null?void 0:a.has(t))??!1}remove(e){var a,l;typeof e=="string"&&(e=Y(e));const t=new va(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,i=((a=this.buckets[r])==null?void 0:a.remove(t))??!1;if(i)return this.count--,i;const s=(r^t.hash())%this.filterSize,o=((l=this.buckets[s])==null?void 0:l.remove(t))??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}class Aoe{constructor(e){h(this,"filterSize");h(this,"bucketSize");h(this,"fingerprintSize");h(this,"scale");h(this,"filterSeries");h(this,"hash");h(this,"seed");this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??h8,this.seed=e.seed??C2(0,Math.pow(2,10)),this.filterSeries=[new Qv({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=Y(e)),this.has(e))return!0;let t=this.filterSeries.find(r=>r.reliable);if(t==null){const r=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Qv({filterSize:r,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=Y(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=Y(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}const GN=1877,qp=1604,Ioe=pi("helia:unixfs:stat");async function Coe(n,e,t={}){const r=await ff(n,t.path,e,t);Ioe("stat %c",r.cid);const i=await $r(r.cid,e,t);if(i.type==="raw")return t.extended===!0?Poe(i):Doe(i);if(i.type==="file"||i.type==="directory")return t.extended===!0?Noe(i,e,t.filter??new Aoe({filterSize:1024}),t):Toe(i);throw new Vp}function Toe(n){return{type:n.type,cid:n.cid,unixfs:n.unixfs,mode:n.unixfs.mode??(n.unixfs.isDirectory()?GN:qp),mtime:n.unixfs.mtime,size:n.unixfs.fileSize()}}async function Noe(n,e,t,r){const i=await qN(n.cid,e,!1,t,r);return{type:n.type,cid:n.cid,unixfs:n.unixfs,size:n.unixfs.isDirectory()?i.dirSize:n.unixfs.fileSize(),mode:n.unixfs.mode??(n.unixfs.isDirectory()?GN:qp),mtime:n.unixfs.mtime,localSize:i.localSize,dagSize:i.dagSize,deduplicatedDagSize:i.deduplicatedDagSize,blocks:i.blocks,uniqueBlocks:i.uniqueBlocks}}function Doe(n){return{type:n.type,cid:n.cid,unixfs:void 0,mode:qp,mtime:void 0,size:BigInt(n.node.byteLength)}}function Poe(n){return{type:n.type,cid:n.cid,unixfs:void 0,mode:qp,mtime:void 0,size:BigInt(n.node.byteLength),localSize:BigInt(n.node.byteLength),dagSize:BigInt(n.node.byteLength),deduplicatedDagSize:BigInt(n.node.byteLength),blocks:1n,uniqueBlocks:1n}}async function qN(n,e,t,r,i){const s={dirSize:0n,localSize:0n,dagSize:0n,deduplicatedDagSize:0n,blocks:0n,uniqueBlocks:0n};try{const o=r.has(n.bytes);r.add(n.bytes);const a=await Kt(e.get(n,i));if(s.blocks++,s.dagSize+=BigInt(a.byteLength),o||(s.uniqueBlocks++,s.deduplicatedDagSize+=BigInt(a.byteLength)),n.code===Ds)s.localSize+=BigInt(a.byteLength),t&&(s.dirSize+=BigInt(a.byteLength));else if(n.code===fi){const l=yr(a);let c;if(l.Data!=null&&(c=Oe.unmarshal(l.Data)),l.Links.length>0){for(const u of l.Links){const d=await qN(u.Hash,e,Ooe(u,c),r,i);s.localSize+=d.localSize,s.dagSize+=d.dagSize,s.deduplicatedDagSize+=d.deduplicatedDagSize,s.blocks+=d.blocks,s.uniqueBlocks+=d.uniqueBlocks,s.dirSize+=d.dirSize}t&&c!=null&&(s.dirSize+=c.fileSize())}else{if(c==null)throw new Ya(`PBNode ${n.toString()} had no data`);c.data!=null&&(s.localSize+=BigInt(c.data.byteLength??0)),t&&(s.dirSize+=c.fileSize())}}else throw new j5(`${n.toString()} was neither DAG_PB nor RAW`)}catch(o){if(o.name!=="NotFoundError"&&o.name!=="BlockNotFoundWhileOfflineError"||i.offline!==!0)throw o}return s}function Ooe(n,e){if(e==null)return!1;const t=n.Name;return t==null?!1:e.type==="directory"?!0:e.type==="hamt-sharded-directory"&&t.length>2}const Loe=pi("helia:unixfs:touch");async function Boe(n,e,t={}){const r=await ff(n,t.path,e,t),i=t.mtime??{secs:BigInt(Math.round(Date.now()/1e3)),nsecs:0};if(Loe("touch %c %o",r.cid,i),t.recursive){const d=await En(async function*(){for await(const f of LN(r.cid,e)){let p,y;const g=await $r(f.cid,e,t);if(g.type==="raw")p=new Oe({data:g.node}),y=[];else if(g.type==="file"||g.type==="directory")p=g.unixfs,y=g.node.Links;else throw new Vp;p.mtime=i;const w={Data:p.marshal(),Links:y};yield{path:f.path,content:w}}},f=>zp(f,e,{...t,dagBuilder:async function*(p,y){for await(const g of p)yield async function(){const w=g.content,m=Rt(w),E=await Lu(m,y,{...t,cidVersion:n.version});if(w.Data==null)throw new Ya(`${E} had no data`);const v=Oe.unmarshal(w.Data);return{cid:E,size:BigInt(m.length),path:g.path,unixfs:v}}}}),async f=>Nu(f));if(d==null)throw new j5(`Could not chmod ${r.cid.toString()}`);return I2(d.cid,r,e,t)}const s=await Kt(e.get(r.cid,t));let o,a=[];if(r.cid.code===Ds)o=new Oe({data:s});else{const d=yr(s);if(a=d.Links,d.Data==null)throw new Ya(`${r.cid.toString()} had no data`);o=Oe.unmarshal(d.Data)}o.mtime=i;const l=Rt({Data:o.marshal(),Links:a}),c=await Tu.digest(l),u=Ke.create(r.cid.version,fi,c);return await e.put(u,l),I2(u,r,e,t)}class Moe{constructor(e){h(this,"components");this.components=e}async*addAll(e,t={}){yield*Y5(e,this.components.blockstore,t)}async addBytes(e,t={}){return Zre(e,this.components.blockstore,t)}async addByteStream(e,t={}){return eie(e,this.components.blockstore,t)}async addFile(e,t={}){return tie(e,this.components.blockstore,t)}async addDirectory(e={},t={}){return nie(e,this.components.blockstore,t)}async*cat(e,t={}){yield*doe(e,this.components.blockstore,t)}async chmod(e,t,r={}){return foe(e,t,this.components.blockstore,r)}async cp(e,t,r,i={}){return goe(e,t,r,this.components.blockstore,i)}async*ls(e,t={}){yield*yoe(e,this.components.blockstore,t)}async mkdir(e,t,r={}){return moe(e,t,this.components.blockstore,r)}async rm(e,t,r={}){return Soe(e,t,this.components.blockstore,r)}async stat(e,t={}){return Coe(e,this.components.blockstore,t)}async touch(e,t={}){return Boe(e,this.components.blockstore,t)}}function $oe(n){return new Moe(n)}function jp(n){return new Promise((e,t)=>{n.oncomplete=n.onsuccess=()=>e(n.result),n.onabort=n.onerror=()=>t(n.error)})}function jy(n,e){let t;const r=()=>{if(t)return t;const i=indexedDB.open(n);return i.onupgradeneeded=()=>i.result.createObjectStore(e),t=jp(i),t.then(s=>{s.onclose=()=>t=void 0},()=>{}),t};return(i,s)=>r().then(o=>s(o.transaction(e,i).objectStore(e)))}let v3;function f8(){return v3||(v3=jy("keyval-store","keyval")),v3}function jN(n,e=f8()){return e("readonly",t=>jp(t.get(n)))}function YN(n,e,t=f8()){return t("readwrite",r=>(r.put(e,n),jp(r.transaction)))}function Uoe(n,e=f8()){return e("readwrite",t=>(t.delete(n),jp(t.transaction)))}const Xv="manamesh-asset-cache",Foe="assets",zoe="metadata",Voe=100*1024*1024,QN="cache-metadata";let Th,T2;function Yp(){Th||(Th=jy(Xv,Foe)),T2||(T2=jy(`${Xv}-meta`,zoe))}async function XN(){return Yp(),await jN(QN,T2)||{totalSize:0,entries:[]}}async function Yy(n){Yp(),await YN(QN,n,T2)}async function Hoe(n){Yp();const e=await jN(n,Th);if(!e)return null;const t=await XN(),r=t.entries.find(i=>i.cid===n);return r&&(r.lastAccessed=Date.now(),await Yy(t)),e}async function Koe(n,e){Yp();const t=e.size,r=await XN(),i=r.entries.find(o=>o.cid===n);if(i){i.lastAccessed=Date.now(),await Yy(r);return}let s=r.totalSize;for(;s+t>Voe&&r.entries.length>0;){r.entries.sort((a,l)=>a.lastAccessed-l.lastAccessed);const o=r.entries.shift();o&&(await Uoe(o.cid,Th),s-=o.size)}await YN(n,e,Th),r.entries.push({cid:n,size:t,lastAccessed:Date.now()}),r.totalSize=s+t,await Yy(r)}const Woe="manamesh-ipfs-config",E3=["https://ipfs.io/ipfs/","https://dweb.link/ipfs/","https://cloudflare-ipfs.com/ipfs/"],Goe={gateways:[],useCustomGatewaysFirst:!0,includeDefaultGateways:!0,gatewayTimeout:3e4,heliaInitTimeout:1e4,heliaFetchTimeout:3e4,preferGateway:!1};let c1=null;function qoe(){try{const n=localStorage.getItem(Woe);if(n)return JSON.parse(n)}catch(n){console.warn("Failed to load IPFS config from storage:",n)}return{}}function p8(){if(c1)return c1;const n=qoe();return c1={...Goe,...n},c1}function joe(){const n=p8(),e=[];if(n.useCustomGatewaysFirst){if(e.push(...n.gateways),n.includeDefaultGateways)for(const t of E3)e.includes(t)||e.push(t)}else{n.includeDefaultGateways&&e.push(...E3);for(const t of n.gateways)e.includes(t)||e.push(t)}return e.length===0?[...E3]:e}let u1=null,rd=null,Jv=!1;async function Yoe(){if(Jv)return null;if(u1)return u1;if(rd)return rd;const n=p8();return rd=(async()=>{try{const e=new Promise((r,i)=>{setTimeout(()=>i(new Error("Helia init timeout")),n.heliaInitTimeout)}),t=bne();return u1=await Promise.race([t,e]),u1}catch(e){return console.warn("Failed to initialize helia, falling back to gateway:",e),Jv=!0,rd=null,null}})(),rd}async function Zv(n,e){const t=await Yoe();if(!t)return null;try{const r=$oe(t),i=Ke.parse(n),s=[],o=new Promise((l,c)=>{setTimeout(()=>c(new Error("Helia fetch timeout")),e)}),a=(async()=>{for await(const l of r.cat(i))s.push(l);return new Blob(s)})();return await Promise.race([a,o])}catch(r){return console.warn("Helia fetch failed:",r),null}}async function eE(n,e){const t=joe(),r=new AbortController,i=setTimeout(()=>r.abort(),e);for(const s of t)try{const o=await fetch(`${s}${n}`,{signal:r.signal});if(o.ok)return clearTimeout(i),{blob:await o.blob(),gateway:s}}catch{continue}return clearTimeout(i),null}async function JN(n,e={}){const t=p8(),{useCache:r=!0,preferGateway:i=t.preferGateway,timeout:s=t.gatewayTimeout}=e;if(r){const l=await Hoe(n);if(l)return{blob:l,source:"cache"}}let o=null,a="gateway";if(i){const l=await eE(n,s);l?(o=l.blob,a="gateway"):(o=await Zv(n,s),o&&(a="helia"))}else if(o=await Zv(n,s),o)a="helia";else{const l=await eE(n,s);l&&(o=l.blob,a="gateway")}if(!o)throw new Error(`Failed to load asset: ${n}`);return r&&await Koe(n,o),{blob:o,source:a}}async function Qoe(n,e={}){const t=await JN(n,e);return{url:URL.createObjectURL(t.blob),source:t.source}}async function Xoe(n,e={},t){const r=new Map;let i=0;const s=n.length,o=5;for(let a=0;a<n.length;a+=o){const c=n.slice(a,a+o).map(async u=>{try{t==null||t(i,s,u);const d=await JN(u,e);r.set(u,d)}catch(d){r.set(u,d instanceof Error?d:new Error(String(d)))}finally{i++,t==null||t(i,s,u)}});await Promise.all(c)}return r}const Joe=({cid:n,alt:e,className:t,style:r,width:i,height:s,placeholder:o,errorFallback:a,onLoad:l,onError:c,preferGateway:u=!1,timeout:d})=>{const[f,p]=_e.useState("idle"),[y,g]=_e.useState(null),[w,m]=_e.useState(null),[E,v]=_e.useState(null),[b,k]=_e.useState(0),A=_e.useCallback(async()=>{if(n){p("loading"),m(null);try{y&&URL.revokeObjectURL(y);const N=await Qoe(n,{preferGateway:u,timeout:d});g(N.url),v(N.source),p("loaded"),l==null||l(N.source)}catch(N){const V=N instanceof Error?N:new Error(String(N));m(V),p("error"),c==null||c(V)}}},[n,u,d,l,c]);_e.useEffect(()=>(A(),()=>{y&&URL.revokeObjectURL(y)}),[n,b]);const T=_e.useCallback(()=>{k(N=>N+1)},[]),P=$.jsxs("div",{style:{width:i||100,height:s||100,backgroundColor:"#2a2a4a",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"4px",...r},className:t,children:[$.jsx("div",{style:{width:"30%",height:"30%",border:"2px solid #6a6a8a",borderTopColor:"#4a9eff",borderRadius:"50%",animation:"spin 1s linear infinite"}}),$.jsx("style",{children:`
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
      `})]}),_=$.jsxs("div",{style:{width:i||100,height:s||100,backgroundColor:"#3a2a2a",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",borderRadius:"4px",color:"#ff6b6b",fontSize:"12px",padding:"8px",textAlign:"center",...r},className:t,children:[$.jsx("span",{style:{marginBottom:"4px"},children:""}),$.jsx("span",{style:{marginBottom:"8px"},children:"Failed to load"}),$.jsx("button",{onClick:T,style:{padding:"4px 8px",fontSize:"10px",backgroundColor:"#4a4a6a",color:"#e4e4e4",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Retry"})]});return f==="loading"||f==="idle"?$.jsx($.Fragment,{children:o||P}):f==="error"?$.jsx($.Fragment,{children:a||_}):$.jsx("img",{src:y,alt:e,className:t,style:r,width:i,height:s,"data-cid":n,"data-source":E})};function Zoe(n){const[e,t]=_e.useState(0),[r,i]=_e.useState(0),[s,o]=_e.useState(null),[a,l]=_e.useState(!1),[c,u]=_e.useState(new Map),d=_e.useCallback(async()=>{if(n.length===0){l(!0);return}t(0),i(n.length),l(!1),u(new Map);const f=await Xoe(n,{},(y,g,w)=>{t(y),i(g),o(w)}),p=new Map;f.forEach((y,g)=>{y instanceof Error&&p.set(g,y)}),u(p),l(!0),o(null)},[n]);return _e.useEffect(()=>{d()},[d]),{loaded:e,total:r,currentCid:s,isComplete:a,errors:c,progress:r>0?e/r*100:0,retry:d}}const eae=({cids:n,onComplete:e,showDetails:t=!1})=>{const{loaded:r,total:i,progress:s,isComplete:o,errors:a}=Zoe(n);return _e.useEffect(()=>{o&&(e==null||e())},[o,e]),o&&a.size===0?null:$.jsxs("div",{style:{padding:"16px",backgroundColor:"#16213e",borderRadius:"8px",marginBottom:"16px"},children:[$.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",color:"#e4e4e4"},children:[$.jsx("span",{children:"Loading assets..."}),$.jsxs("span",{children:[r,"/",i]})]}),$.jsx("div",{style:{height:"8px",backgroundColor:"#2a2a4a",borderRadius:"4px",overflow:"hidden"},children:$.jsx("div",{style:{height:"100%",width:`${s}%`,backgroundColor:a.size>0?"#ff9800":"#4CAF50",transition:"width 0.3s ease"}})}),t&&a.size>0&&$.jsxs("div",{style:{marginTop:"8px",fontSize:"12px",color:"#ff6b6b"},children:[a.size," asset(s) failed to load"]})]})},tE=({card:n,onClick:e,selected:t})=>{const r=!!n.imageCid;return $.jsx("div",{onClick:e,style:{border:t?"2px solid #4CAF50":"1px solid #3a3a5c",borderRadius:"8px",padding:r?"4px":"8px 12px",margin:"4px",cursor:e?"pointer":"default",backgroundColor:t?"#1a4a3a":"#16213e",minWidth:r?"100px":"80px",textAlign:"center",boxShadow:"0 2px 4px rgba(0,0,0,0.3)",transition:"all 0.2s ease",color:"#e4e4e4"},children:r?$.jsxs($.Fragment,{children:[$.jsx(Joe,{cid:n.imageCid,alt:n.name,width:92,height:128,style:{borderRadius:"4px",marginBottom:"4px"},preferGateway:!0}),$.jsx("div",{style:{fontWeight:"bold",fontSize:"11px",marginTop:"4px"},children:n.name})]}):$.jsxs($.Fragment,{children:[$.jsx("div",{style:{fontWeight:"bold",fontSize:"14px"},children:n.name}),$.jsx("div",{style:{fontSize:"10px",color:"#a0a0a0"},children:n.id})]})})},nE=({playerID:n,hand:e,field:t,isCurrentPlayer:r,isActivePlayer:i,onCardClick:s,selectedCard:o})=>$.jsxs("div",{style:{border:i?"2px solid #2196F3":"1px solid #3a3a5c",borderRadius:"12px",padding:"16px",margin:"8px 0",backgroundColor:r?"#1e2a45":"#16213e"},children:[$.jsxs("div",{style:{fontWeight:"bold",marginBottom:"12px",display:"flex",justifyContent:"space-between",alignItems:"center",color:"#e4e4e4"},children:[$.jsxs("span",{children:["Player ",n," ",r&&"(You)"," ",i&&""]}),$.jsxs("span",{style:{fontSize:"12px",color:"#a0a0a0"},children:["Hand: ",e.length," | Field: ",t.length]})]}),$.jsxs("div",{style:{marginBottom:"12px"},children:[$.jsx("div",{style:{fontSize:"12px",color:"#a0a0a0",marginBottom:"4px"},children:"Field:"}),$.jsx("div",{style:{display:"flex",flexWrap:"wrap",minHeight:"60px",backgroundColor:"#0f3460",borderRadius:"8px",padding:"8px"},children:t.length===0?$.jsx("span",{style:{color:"#6a6a8a",padding:"8px"},children:"No cards played"}):t.map(a=>$.jsx(tE,{card:a},a.id))})]}),$.jsxs("div",{children:[$.jsxs("div",{style:{fontSize:"12px",color:"#a0a0a0",marginBottom:"4px"},children:["Hand: ",!r&&"(hidden)"]}),$.jsx("div",{style:{display:"flex",flexWrap:"wrap",minHeight:"60px"},children:r?e.length===0?$.jsx("span",{style:{color:"#6a6a8a",padding:"8px"},children:"No cards in hand"}):e.map(a=>$.jsx(tE,{card:a,onClick:()=>s==null?void 0:s(a.id),selected:o===a.id},a.id)):$.jsxs("span",{style:{color:"#6a6a8a",padding:"8px"},children:[e.length," cards (hidden)"]})})]})]});function tae(n){const e=new Set;return n.deck.forEach(t=>{t.imageCid&&e.add(t.imageCid)}),Object.values(n.hands).forEach(t=>{t.forEach(r=>{r.imageCid&&e.add(r.imageCid)})}),Object.values(n.field).forEach(t=>{t.forEach(r=>{r.imageCid&&e.add(r.imageCid)})}),n.discard.forEach(t=>{t.imageCid&&e.add(t.imageCid)}),Array.from(e)}const nae=({G:n,ctx:e,moves:t,playerID:r})=>{const[i,s]=ae.useState(null),[o,a]=ae.useState(!0),l=r||"0",c=e.currentPlayer===l,u=n.hands[l]||[],d=ae.useMemo(()=>tae(n),[]),f=ae.useCallback(()=>{a(!1)},[]),p=m=>{c&&s(E=>E===m?null:m)},y=()=>{c&&t.drawCard()},g=()=>{!c||!i||(t.playCard(i),s(null))},w=()=>{!c||!i||(t.discardCard(i),s(null))};return e.gameover?$.jsxs("div",{style:{padding:"40px",textAlign:"center",fontFamily:"system-ui, sans-serif",color:"#e4e4e4"},children:[$.jsx("h1",{children:"Game Over!"}),e.gameover.winner?$.jsxs("p",{style:{fontSize:"24px"},children:[" Player ",e.gameover.winner," wins! "]}):$.jsx("p",{style:{fontSize:"24px"},children:"It's a draw!"}),$.jsx("button",{onClick:()=>window.location.reload(),style:{padding:"12px 24px",fontSize:"16px",cursor:"pointer",backgroundColor:"#4CAF50",color:"white",border:"none",borderRadius:"8px",marginTop:"20px"},children:"Play Again"})]}):$.jsxs("div",{style:{padding:"20px",maxWidth:"800px",margin:"0 auto",fontFamily:"system-ui, sans-serif",color:"#e4e4e4"},children:[d.length>0&&o&&$.jsx(eae,{cids:d,onComplete:f,showDetails:!0}),$.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px",padding:"12px",backgroundColor:"#16213e",borderRadius:"8px",border:"1px solid #3a3a5c"},children:[$.jsx("h2",{style:{margin:0},children:"ManaMesh - Simple Card Game"}),$.jsxs("div",{style:{color:"#a0a0a0"},children:[$.jsxs("span",{style:{marginRight:"16px"},children:["Deck: ",n.deck.length," cards"]}),$.jsxs("span",{children:["Discard: ",n.discard.length," cards"]})]})]}),$.jsx("div",{style:{padding:"12px",backgroundColor:c?"#1a4a3a":"#3d2a1a",borderRadius:"8px",marginBottom:"20px",textAlign:"center",border:"1px solid #3a3a5c"},children:c?$.jsx("span",{style:{color:"#6fcf6f",fontWeight:"bold"},children:"Your turn! Draw, play, or discard cards."}):$.jsxs("span",{style:{color:"#ff9800"},children:["Waiting for Player ",e.currentPlayer,"..."]})}),Object.keys(n.hands).filter(m=>m!==l).map(m=>$.jsx(nE,{playerID:m,hand:n.hands[m]||[],field:n.field[m]||[],isCurrentPlayer:!1,isActivePlayer:e.currentPlayer===m,selectedCard:null},m)),$.jsx(nE,{playerID:l,hand:u,field:n.field[l]||[],isCurrentPlayer:!0,isActivePlayer:e.currentPlayer===l,onCardClick:p,selectedCard:i}),$.jsxs("div",{style:{display:"flex",gap:"12px",justifyContent:"center",marginTop:"20px"},children:[$.jsx("button",{onClick:y,disabled:!c||n.deck.length===0,style:{padding:"12px 24px",fontSize:"16px",cursor:c&&n.deck.length>0?"pointer":"not-allowed",backgroundColor:c&&n.deck.length>0?"#2196F3":"#3a3a5c",color:c&&n.deck.length>0?"white":"#6a6a8a",border:"none",borderRadius:"8px"},children:"Draw Card"}),$.jsx("button",{onClick:g,disabled:!c||!i,style:{padding:"12px 24px",fontSize:"16px",cursor:c&&i?"pointer":"not-allowed",backgroundColor:c&&i?"#4CAF50":"#3a3a5c",color:c&&i?"white":"#6a6a8a",border:"none",borderRadius:"8px"},children:"Play Selected"}),$.jsx("button",{onClick:w,disabled:!c||!i,style:{padding:"12px 24px",fontSize:"16px",cursor:c&&i?"pointer":"not-allowed",backgroundColor:c&&i?"#ff9800":"#3a3a5c",color:c&&i?"white":"#6a6a8a",border:"none",borderRadius:"8px"},children:"Discard Selected"})]}),$.jsxs("div",{style:{marginTop:"20px",padding:"12px",backgroundColor:"#3d2a1a",borderRadius:"8px",fontSize:"14px",color:"#f0c060",border:"1px solid #3a3a5c"},children:[$.jsx("strong",{children:"Win condition:"})," Play ",n.cardsToWin," cards to the field to win!"]})]})},rae=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}];class iae{constructor(e){this.dataChannel=null,this.iceCandidates=[],this.iceGatheringComplete=!1,this._state="new",this.events=e,this.pc=new RTCPeerConnection({iceServers:rae}),this.setupPeerConnectionHandlers()}get state(){return this._state}setState(e){this._state=e,this.events.onStateChange(e)}setupPeerConnectionHandlers(){this.pc.onicecandidate=e=>{e.candidate&&this.iceCandidates.push(e.candidate.toJSON())},this.pc.onicegatheringstatechange=()=>{this.pc.iceGatheringState==="complete"&&(this.iceGatheringComplete=!0)},this.pc.onconnectionstatechange=()=>{switch(this.pc.connectionState){case"connecting":this.setState("connecting");break;case"connected":this.setState("connected");break;case"disconnected":this.setState("disconnected");break;case"failed":this.setState("failed"),this.events.onError(new Error("Connection failed"));break}},this.pc.ondatachannel=e=>{this.setupDataChannel(e.channel)}}setupDataChannel(e){this.dataChannel=e,e.onopen=()=>{console.log("[WebRTC] Data channel opened"),this.setState("connected")},e.onclose=()=>{console.log("[WebRTC] Data channel closed"),this.setState("disconnected")},e.onerror=t=>{console.error("[WebRTC] Data channel error:",t),this.events.onError(new Error("Data channel error"))},e.onmessage=t=>{this.events.onMessage(t.data)}}async createOffer(){this.setState("connecting");const e=this.pc.createDataChannel("game",{ordered:!0});this.setupDataChannel(e);const t=await this.pc.createOffer();return await this.pc.setLocalDescription(t),await this.waitForIceGathering(),{sdp:this.pc.localDescription.sdp,iceCandidates:this.iceCandidates}}async acceptOffer(e){this.setState("connecting"),await this.pc.setRemoteDescription({type:"offer",sdp:e.sdp});for(const r of e.iceCandidates)await this.pc.addIceCandidate(r);const t=await this.pc.createAnswer();return await this.pc.setLocalDescription(t),await this.waitForIceGathering(),{sdp:this.pc.localDescription.sdp,iceCandidates:this.iceCandidates}}async acceptAnswer(e){await this.pc.setRemoteDescription({type:"answer",sdp:e.sdp});for(const t of e.iceCandidates)await this.pc.addIceCandidate(t)}send(e){if(!this.dataChannel||this.dataChannel.readyState!=="open")throw new Error("Data channel not open");this.dataChannel.send(e)}close(){this.dataChannel&&this.dataChannel.close(),this.pc.close(),this.setState("disconnected")}waitForIceGathering(e=5e3){return new Promise((t,r)=>{if(this.iceGatheringComplete||this.pc.iceGatheringState==="complete"){t();return}const i=setTimeout(()=>{console.log("[WebRTC] ICE gathering timeout, proceeding with available candidates"),t()},e),s=()=>{this.pc.iceGatheringState==="complete"&&(clearTimeout(i),this.pc.removeEventListener("icegatheringstatechange",s),t())};this.pc.addEventListener("icegatheringstatechange",s)})}}async function sae(n){const t=new TextEncoder().encode(n);if(typeof CompressionStream>"u")return t;const r=new CompressionStream("gzip"),i=r.writable.getWriter();i.write(t),i.close();const s=[],o=r.readable.getReader();for(;;){const{done:u,value:d}=await o.read();if(u)break;s.push(d)}const a=s.reduce((u,d)=>u+d.length,0),l=new Uint8Array(a);let c=0;for(const u of s)l.set(u,c),c+=u.length;return l}async function oae(n){const e=new TextDecoder;if(typeof DecompressionStream>"u")return e.decode(n);try{const t=new DecompressionStream("gzip"),r=t.writable.getWriter();r.write(new Uint8Array(n.buffer,n.byteOffset,n.byteLength)),r.close();const i=[],s=t.readable.getReader();for(;;){const{done:c,value:u}=await s.read();if(c)break;i.push(u)}const o=i.reduce((c,u)=>c+u.length,0),a=new Uint8Array(o);let l=0;for(const c of i)a.set(c,l),l+=c.length;return e.decode(a)}catch{return e.decode(n)}}function aae(n){const e=Array.from(n).map(t=>String.fromCharCode(t)).join("");return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function lae(n){const e=n.replace(/-/g,"+").replace(/_/g,"/"),t=e+"===".slice(0,(4-e.length%4)%4),r=atob(t),i=new Uint8Array(r.length);for(let s=0;s<r.length;s++)i[s]=r.charCodeAt(s);return i}function cae(n){return n.split(`\r
`).filter(e=>e.trim()&&!e.startsWith("a=extmap")).join(`
`)}function uae(n){return n.split(`
`).join(`\r
`)+`\r
`}async function rE(n){const e={s:cae(n.sdp),i:n.iceCandidates.map(i=>({c:i.candidate,m:i.sdpMid,l:i.sdpMLineIndex}))},t=JSON.stringify(e),r=await sae(t);return aae(r)}async function iE(n){try{const e=lae(n.trim()),t=await oae(e),r=JSON.parse(t);return{sdp:uae(r.s),iceCandidates:r.i.map(i=>({candidate:i.c,sdpMid:i.m,sdpMLineIndex:i.l}))}}catch(e){throw new Error("Invalid join code: "+(e instanceof Error?e.message:"Unknown error"))}}function sE(n){const e=n.trim();return/^[A-Za-z0-9_-]{50,}$/.test(e)}class dae{constructor(e){this.peerConnection=null,this._state={phase:"idle"},this.events=e}get state(){return this._state}setState(e){this._state=e,this.events.onStateChange(e)}createPeerConnection(){const e={onStateChange:t=>{this.events.onConnectionStateChange(t),t==="connected"?this.setState({phase:"connected"}):(t==="failed"||t==="disconnected")&&this._state.phase!=="error"&&this.setState({phase:"error",error:`Connection ${t}`})},onMessage:t=>{this.events.onMessage(t)},onError:t=>{this.setState({phase:"error",error:t.message})}};return new iae(e)}async createGame(){this.cleanup(),this.setState({phase:"creating-offer",role:"host"});try{this.peerConnection=this.createPeerConnection();const e=await this.peerConnection.createOffer(),t=await rE(e);return this.setState({phase:"waiting-for-answer",role:"host",offerCode:t}),t}catch(e){const t=e instanceof Error?e.message:"Failed to create offer";throw this.setState({phase:"error",error:t}),e}}async joinGame(e){if(!sE(e))throw new Error("Invalid offer code format");this.cleanup(),this.setState({phase:"entering-offer",role:"guest"});try{const t=await iE(e);this.peerConnection=this.createPeerConnection();const r=await this.peerConnection.acceptOffer(t),i=await rE(r);return this.setState({phase:"waiting-for-host",role:"guest",answerCode:i}),i}catch(t){const r=t instanceof Error?t.message:"Failed to join game";throw this.setState({phase:"error",error:r}),t}}async acceptAnswer(e){if(!sE(e))throw new Error("Invalid answer code format");if(!this.peerConnection)throw new Error("No pending connection - create a game first");if(this._state.phase!=="waiting-for-answer")throw new Error("Not waiting for answer");this.setState({phase:"connecting"});try{const t=await iE(e);await this.peerConnection.acceptAnswer(t)}catch(t){const r=t instanceof Error?t.message:"Failed to accept answer";throw this.setState({phase:"error",error:r}),t}}send(e){if(!this.peerConnection)throw new Error("Not connected");this.peerConnection.send(e)}isConnected(){return this._state.phase==="connected"}cleanup(){this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.setState({phase:"idle"})}close(){this.cleanup()}}async function hae(){return console.log("[P2P] P2P layer initialized"),{ok:!0}}const fae=({onConnected:n,onBack:e})=>{const[t,r]=_e.useState("select"),[i,s]=_e.useState({phase:"idle"}),[o,a]=_e.useState("new"),[l,c]=_e.useState(""),[u,d]=_e.useState(""),[f,p]=_e.useState(""),[y,g]=_e.useState(null),[w,m]=_e.useState(!1),E=_e.useRef(null);_e.useEffect(()=>(E.current=new dae({onStateChange:x=>{s(x),x.phase==="error"&&g(x.error)},onMessage:x=>{console.log("[P2PLobby] Received message:",x)},onConnectionStateChange:x=>{a(x),x==="connected"&&E.current&&n(E.current)}}),()=>{var x;(x=E.current)==null||x.close()}),[n]);const v=_e.useCallback(async()=>{if(E.current){g(null),m(!1);try{const x=await E.current.createGame();c(x),r("host")}catch(x){g(x instanceof Error?x.message:"Failed to create game")}}},[]),b=_e.useCallback(async()=>{if(!(!E.current||!f.trim())){g(null),m(!1);try{const x=await E.current.joinGame(f.trim());d(x)}catch(x){g(x instanceof Error?x.message:"Failed to join game")}}},[f]),k=_e.useCallback(async()=>{if(!(!E.current||!f.trim())){g(null);try{await E.current.acceptAnswer(f.trim())}catch(x){g(x instanceof Error?x.message:"Failed to accept answer")}}},[f]),A=_e.useCallback(async x=>{try{await navigator.clipboard.writeText(x),m(!0),setTimeout(()=>m(!1),2e3)}catch(M){console.error("Failed to copy:",M)}},[]),T=_e.useCallback(()=>{var x;(x=E.current)==null||x.cleanup(),t==="select"?e():(r("select"),c(""),d(""),p(""),g(null),s({phase:"idle"}))},[t,e]),P={padding:"40px",maxWidth:"600px",margin:"0 auto",fontFamily:"system-ui, sans-serif"},_={backgroundColor:"#16213e",padding:"24px",borderRadius:"12px",marginBottom:"20px",border:"1px solid #3a3a5c"},N={padding:"12px 24px",fontSize:"16px",cursor:"pointer",backgroundColor:"#4CAF50",color:"white",border:"none",borderRadius:"8px",width:"100%",marginBottom:"12px"},V={...N,backgroundColor:"#3a3a5c"},z={width:"100%",padding:"12px",fontSize:"14px",backgroundColor:"#1a1a2e",color:"#e4e4e4",border:"1px solid #3a3a5c",borderRadius:"8px",marginBottom:"12px",fontFamily:"monospace",boxSizing:"border-box"},R={backgroundColor:"#1a1a2e",padding:"12px",borderRadius:"8px",wordBreak:"break-all",fontSize:"12px",fontFamily:"monospace",color:"#a0a0a0",marginBottom:"12px",maxHeight:"120px",overflow:"auto"},C={padding:"12px",borderRadius:"8px",marginBottom:"12px",textAlign:"center"};if(t==="select")return $.jsxs("div",{style:P,children:[$.jsx("h1",{style:{color:"#e4e4e4",marginBottom:"8px"},children:"P2P Online Game"}),$.jsx("p",{style:{color:"#a0a0a0",marginBottom:"24px"},children:"Connect directly with another player - no server required!"}),$.jsxs("div",{style:_,children:[$.jsx("h2",{style:{color:"#e4e4e4",marginBottom:"16px"},children:"Start a Game"}),$.jsx("button",{style:N,onClick:v,children:"Create Game (Host)"}),$.jsx("button",{style:V,onClick:()=>r("join"),children:"Join Game (Guest)"})]}),$.jsxs("div",{style:{..._,backgroundColor:"#0f3460",color:"#c0d0e0",fontSize:"14px"},children:[$.jsx("strong",{children:"How it works:"}),$.jsxs("ol",{style:{margin:"8px 0 0 0",paddingLeft:"20px"},children:[$.jsx("li",{children:"Host creates a game and shares their code"}),$.jsx("li",{children:"Guest enters the code and shares their response code"}),$.jsx("li",{children:"Host enters the response code to connect"}),$.jsx("li",{children:"Play!"})]})]}),$.jsx("button",{style:{...V,marginTop:"12px"},onClick:e,children:"Back to Lobby"})]});if(t==="host"){const x=i.phase==="waiting-for-answer",M=i.phase==="connecting",K=i.phase==="connected";return $.jsxs("div",{style:P,children:[$.jsx("h1",{style:{color:"#e4e4e4",marginBottom:"8px"},children:"Host Game"}),$.jsxs("div",{style:_,children:[$.jsx("h3",{style:{color:"#e4e4e4",marginBottom:"12px"},children:"Step 1: Share this code with your opponent"}),l?$.jsxs($.Fragment,{children:[$.jsx("div",{style:R,children:l}),$.jsx("button",{style:N,onClick:()=>A(l),children:w?"Copied!":"Copy Code"})]}):$.jsx("div",{style:{...C,backgroundColor:"#3d2a1a",color:"#ff9800"},children:"Generating code..."})]}),x&&$.jsxs("div",{style:_,children:[$.jsx("h3",{style:{color:"#e4e4e4",marginBottom:"12px"},children:"Step 2: Enter your opponent's response code"}),$.jsx("textarea",{style:{...z,minHeight:"80px",resize:"vertical"},placeholder:"Paste the response code here...",value:f,onChange:L=>p(L.target.value)}),$.jsx("button",{style:N,onClick:k,disabled:!f.trim(),children:"Connect"})]}),M&&$.jsx("div",{style:{...C,backgroundColor:"#3d2a1a",color:"#ff9800"},children:"Connecting..."}),K&&$.jsx("div",{style:{...C,backgroundColor:"#1a4a3a",color:"#6fcf6f"},children:"Connected! Starting game..."}),y&&$.jsxs("div",{style:{...C,backgroundColor:"#4a1a1a",color:"#ff6b6b"},children:["Error: ",y]}),$.jsx("button",{style:V,onClick:T,children:"Cancel"})]})}if(t==="join"){const x=i.phase==="waiting-for-host",M=i.phase==="connecting",K=i.phase==="connected";return $.jsxs("div",{style:P,children:[$.jsx("h1",{style:{color:"#e4e4e4",marginBottom:"8px"},children:"Join Game"}),$.jsxs("div",{style:_,children:[$.jsx("h3",{style:{color:"#e4e4e4",marginBottom:"12px"},children:"Step 1: Enter the host's code"}),$.jsx("textarea",{style:{...z,minHeight:"80px",resize:"vertical"},placeholder:"Paste the host's code here...",value:f,onChange:L=>p(L.target.value),disabled:x}),!x&&$.jsx("button",{style:N,onClick:b,disabled:!f.trim(),children:"Generate Response"})]}),x&&$.jsxs("div",{style:_,children:[$.jsx("h3",{style:{color:"#e4e4e4",marginBottom:"12px"},children:"Step 2: Share this response code with the host"}),$.jsx("div",{style:R,children:u}),$.jsx("button",{style:N,onClick:()=>A(u),children:w?"Copied!":"Copy Response Code"}),$.jsx("div",{style:{...C,backgroundColor:"#0f3460",color:"#c0d0e0"},children:"Waiting for host to enter your code..."})]}),M&&$.jsx("div",{style:{...C,backgroundColor:"#3d2a1a",color:"#ff9800"},children:"Connecting..."}),K&&$.jsx("div",{style:{...C,backgroundColor:"#1a4a3a",color:"#6fcf6f"},children:"Connected! Starting game..."}),y&&$.jsxs("div",{style:{...C,backgroundColor:"#4a1a1a",color:"#ff6b6b"},children:["Error: ",y]}),$.jsx("button",{style:V,onClick:T,children:"Cancel"})]})}return null},pae=zx({game:EM,board:nae,multiplayer:Fx()}),gae=({onStartGame:n})=>$.jsxs("div",{style:{padding:"40px",maxWidth:"600px",margin:"0 auto",fontFamily:"system-ui, sans-serif",textAlign:"center"},children:[$.jsx("h1",{style:{marginBottom:"8px",color:"#e4e4e4"},children:"ManaMesh"}),$.jsx("p",{style:{color:"#a0a0a0",marginBottom:"40px"},children:"Decentralized Card Game Platform"}),$.jsxs("div",{style:{backgroundColor:"#16213e",padding:"32px",borderRadius:"12px",marginBottom:"20px",border:"1px solid #3a3a5c"},children:[$.jsx("h2",{style:{marginBottom:"24px",color:"#e4e4e4"},children:"Start a Game"}),$.jsx("button",{onClick:()=>n("local"),style:{padding:"16px 32px",fontSize:"18px",cursor:"pointer",backgroundColor:"#4CAF50",color:"white",border:"none",borderRadius:"8px",width:"100%",marginBottom:"16px"},children:"Local Hotseat (2 Players)"}),$.jsx("button",{onClick:()=>n("online"),style:{padding:"16px 32px",fontSize:"18px",cursor:"pointer",backgroundColor:"#2196F3",color:"white",border:"none",borderRadius:"8px",width:"100%"},children:"P2P Online (No Server!)"})]}),$.jsxs("div",{style:{backgroundColor:"#0f3460",padding:"16px",borderRadius:"8px",fontSize:"14px",textAlign:"left",color:"#c0d0e0",border:"1px solid #3a3a5c"},children:[$.jsx("strong",{children:"How to play:"}),$.jsxs("ul",{style:{margin:"8px 0 0 0",paddingLeft:"20px"},children:[$.jsx("li",{children:"Draw cards from the deck"}),$.jsx("li",{children:"Click a card to select it, then play or discard"}),$.jsx("li",{children:"First player to play 5 cards wins!"})]})]})]}),yae=({onBack:n})=>{const[e,t]=_e.useState("0");return $.jsxs("div",{children:[$.jsxs("div",{style:{padding:"12px 20px",backgroundColor:"#16213e",color:"#e4e4e4",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid #3a3a5c"},children:[$.jsx("button",{onClick:n,style:{padding:"8px 16px",cursor:"pointer",backgroundColor:"#3a3a5c",color:"#e4e4e4",border:"none",borderRadius:"4px"},children:" Back to Lobby"}),$.jsxs("div",{children:[$.jsx("span",{style:{marginRight:"12px"},children:"Viewing as:"}),$.jsx("button",{onClick:()=>t("0"),style:{padding:"8px 16px",cursor:"pointer",backgroundColor:e==="0"?"#4CAF50":"#3a3a5c",color:"#e4e4e4",border:"none",borderRadius:"4px",marginRight:"8px"},children:"Player 0"}),$.jsx("button",{onClick:()=>t("1"),style:{padding:"8px 16px",cursor:"pointer",backgroundColor:e==="1"?"#4CAF50":"#3a3a5c",color:"#e4e4e4",border:"none",borderRadius:"4px"},children:"Player 1"})]})]}),$.jsx(pae,{playerID:e,matchID:"local-match"})]})},mae=({connection:n,onBack:e})=>{const[t,r]=_e.useState([]),[i,s]=_e.useState("");_e.useEffect(()=>{var l;const a=(l=n.events)==null?void 0:l.onMessage;a&&(n.events.onMessage=c=>{r(u=>[...u,`Peer: ${c}`]),a(c)})},[n]);const o=()=>{i.trim()&&(n.send(i),r(a=>[...a,`You: ${i}`]),s(""))};return $.jsxs("div",{style:{padding:"40px",maxWidth:"600px",margin:"0 auto",fontFamily:"system-ui, sans-serif"},children:[$.jsxs("div",{style:{padding:"12px 20px",backgroundColor:"#16213e",color:"#e4e4e4",display:"flex",justifyContent:"space-between",alignItems:"center",borderRadius:"8px",marginBottom:"20px",border:"1px solid #3a3a5c"},children:[$.jsx("button",{onClick:e,style:{padding:"8px 16px",cursor:"pointer",backgroundColor:"#3a3a5c",color:"#e4e4e4",border:"none",borderRadius:"4px"},children:" Disconnect"}),$.jsx("span",{style:{color:"#6fcf6f"},children:"Connected via P2P!"})]}),$.jsxs("div",{style:{backgroundColor:"#16213e",padding:"24px",borderRadius:"12px",border:"1px solid #3a3a5c",marginBottom:"20px"},children:[$.jsx("h2",{style:{color:"#e4e4e4",marginBottom:"16px"},children:"P2P Connection Test"}),$.jsx("p",{style:{color:"#a0a0a0",marginBottom:"16px"},children:"Send messages to test the connection. Game integration coming next!"}),$.jsx("div",{style:{backgroundColor:"#1a1a2e",padding:"12px",borderRadius:"8px",minHeight:"150px",maxHeight:"200px",overflow:"auto",marginBottom:"12px"},children:t.length===0?$.jsx("span",{style:{color:"#6a6a8a"},children:"No messages yet..."}):t.map((a,l)=>$.jsx("div",{style:{color:a.startsWith("You:")?"#6fcf6f":"#e4e4e4",marginBottom:"4px"},children:a},l))}),$.jsxs("div",{style:{display:"flex",gap:"8px"},children:[$.jsx("input",{type:"text",value:i,onChange:a=>s(a.target.value),onKeyDown:a=>a.key==="Enter"&&o(),placeholder:"Type a message...",style:{flex:1,padding:"12px",backgroundColor:"#1a1a2e",color:"#e4e4e4",border:"1px solid #3a3a5c",borderRadius:"8px"}}),$.jsx("button",{onClick:o,style:{padding:"12px 24px",backgroundColor:"#4CAF50",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},children:"Send"})]})]})]})},wae=()=>{const[n,e]=_e.useState("lobby"),[t,r]=_e.useState(null);_e.useEffect(()=>{hae()},[]);const i=_e.useCallback(o=>{r(o),e("p2p-game")},[]),s=_e.useCallback(()=>{t==null||t.close(),r(null),e("lobby")},[t]);return n==="local"?$.jsx(yae,{onBack:()=>e("lobby")}):n==="online"?$.jsx(fae,{onConnected:i,onBack:()=>e("lobby")}):n==="p2p-game"&&t?$.jsx(mae,{connection:t,onBack:s}):$.jsx(gae,{onStartGame:e})};S3.createRoot(document.getElementById("root")).render($.jsx(ae.StrictMode,{children:$.jsx(wae,{})}));
